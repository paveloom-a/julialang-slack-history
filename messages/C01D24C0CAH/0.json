{"cursor": 0, "messages": [{"type":"message","subtype":"channel_join","ts":"1608045704.234500","user":"UNWNSUZPH","text":"<@UNWNSUZPH> has joined the channel","reactions":[{"name":"wave","users":["UMZQBQU67"],"count":1}]},{"client_msg_id":"3f3c5b36-fa9d-4d24-a8e5-5836c8f2baa0","type":"message","text":"Quick Q… Are there any field oceanographers in this group too? Or is it Oceananigans.jl specific? I just wrote a quick script to read SeaBird cnv files to a dataframe,  you see, might be a duplicate effort of someone, no idea?","user":"UNWNSUZPH","ts":"1608045813.235900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"wt0x","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Quick Q… Are there any field oceanographers in this group too? Or is it Oceananigans.jl specific? I just wrote a quick script to read SeaBird cnv files to a dataframe,  you see, might be a duplicate effort of someone, no idea?"}]}]}],"reactions":[{"name":"eyes","users":["UB197FRCL"],"count":1}]},{"client_msg_id":"e425b82d-021e-4a01-8b71-b2788e4c2f0d","type":"message","text":"This chanenl is mostly Oceananigans.jl specific but there may be some knowledgable field oceanographers lurking here and in <#CNK8SLW58|climate>.","user":"UEP056STX","ts":"1608046035.236800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ABqTG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This chanenl is mostly Oceananigans.jl specific but there may be some knowledgable field oceanographers lurking here and in "},{"type":"channel","channel_id":"CNK8SLW58"},{"type":"text","text":"."}]}]}]},{"client_msg_id":"cd97f190-668f-452f-a987-a9a07bb00e6d","type":"message","text":"There's also the <https://github.com/JuliaOcean> organization but it might be more focused on ocean modeling right now.","user":"UEP056STX","ts":"1608046072.237500","team":"T68168MUP","edited":{"user":"UEP056STX","ts":"1608046247.000000"},"blocks":[{"type":"rich_text","block_id":"DOgZG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"There's also the "},{"type":"link","url":"https://github.com/JuliaOcean"},{"type":"text","text":" organization but it might be more focused on ocean modeling right now."}]}]}]},{"client_msg_id":"a0272d72-0e7a-44f8-b2c7-e7d434d208dd","type":"message","text":"Don't know of any packages for working with oceanographic field data but happy to be wrong.","user":"UEP056STX","ts":"1608046203.238000","team":"T68168MUP","edited":{"user":"UEP056STX","ts":"1608046232.000000"},"blocks":[{"type":"rich_text","block_id":"Atl2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Don't know of any packages for working with oceanographic field data but happy to be wrong."}]}]}]},{"client_msg_id":"9fdcf7ec-8921-4193-ab9e-a00b83f3e414","type":"message","text":"Thanks!!","user":"UNWNSUZPH","ts":"1608047744.238500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Fhy","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks!!"}]}]}]},{"client_msg_id":"04ad499a-8360-4213-ac40-7bce8da1a038","type":"message","text":"@Etsy would be super interested to hear about packages for working with field data! I’ve heard of lots of python, less julia","user":"UMZQBQU67","ts":"1608047796.239100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7jEg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"@Etsy would be super interested to hear about packages for working with field data! I’ve heard of lots of python, less julia"}]}]}],"thread_ts":"1608047796.239100","reply_count":26,"reply_users_count":2,"latest_reply":"1608053583.244500","reply_users":["UMZQBQU67","UNWNSUZPH"],"subscribed":false},{"client_msg_id":"74ecce20-f827-44be-ac5f-e1741df20e41","type":"message","text":"Hey, everyone, quick question. I'm setting up an AveragedTimeSchedule to output some averages","user":"U01E0U2RJJ2","ts":"1608128819.245800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=ghZX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hey, everyone, quick question. I'm setting up an AveragedTimeSchedule to output some averages"}]}]}]},{"client_msg_id":"a86e78c4-6798-485c-b181-bbb82ccd9b87","type":"message","text":"But I'm getting the following warnings every time:\n```i:    135,    sim time: 4.067 hours,    wall time: 5.692 seconds,    Δt: 15.518 minutes,    diff CFL: 4.70e-03,    adv CFL: 7.94e-02\n┌ Warning: Returning a WindowedTimeAverage before the collection period is complete.\n└ @ Oceananigans.OutputWriters ~/.julia/packages/Oceananigans/Mt2Rj/src/OutputWriters/windowed_time_average.jl:202\n┌ Warning: Returning a WindowedTimeAverage before the collection period is complete.\n└ @ Oceananigans.OutputWriters ~/.julia/packages/Oceananigans/Mt2Rj/src/OutputWriters/windowed_time_average.jl:202```","user":"U01E0U2RJJ2","ts":"1608128852.246300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fa6A","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But I'm getting the following warnings every time:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"i:    135,    sim time: 4.067 hours,    wall time: 5.692 seconds,    Δt: 15.518 minutes,    diff CFL: 4.70e-03,    adv CFL: 7.94e-02\n┌ Warning: Returning a WindowedTimeAverage before the collection period is complete.\n└ @ Oceananigans.OutputWriters ~/.julia/packages/Oceananigans/Mt2Rj/src/OutputWriters/windowed_time_average.jl:202\n┌ Warning: Returning a WindowedTimeAverage before the collection period is complete.\n└ @ Oceananigans.OutputWriters ~/.julia/packages/Oceananigans/Mt2Rj/src/OutputWriters/windowed_time_average.jl:202"}]}]}]},{"client_msg_id":"742c4d7e-fe8b-426c-8407-8248f3c8b250","type":"message","text":"Here's how I'm setting my writter:\n```simulation.output_writers[:averages] =\n    NetCDFOutputWriter(model, outputs,\n                       filepath = @sprintf(\"<http://avg.%s.nc|avg.%s.nc>\", simname),\n                       schedule = AveragedTimeInterval(2minutes; window=2minutes, stride=2),\n                       mode = \"c\",\n                       global_attributes = global_attributes,\n                      )```","user":"U01E0U2RJJ2","ts":"1608128954.247100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ik1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Here's how I'm setting my writter:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"simulation.output_writers[:averages] =\n    NetCDFOutputWriter(model, outputs,\n                       filepath = @sprintf(\"avg.%s.nc\", simname),\n                       schedule = AveragedTimeInterval(2minutes; window=2minutes, stride=2),\n                       mode = \"c\",\n                       global_attributes = global_attributes,\n                      )"}]}]}]},{"client_msg_id":"48187d67-13ab-45b6-873f-ff2e321fc644","type":"message","text":"Whenever I set a window that's smaller than the time interval I don't get that message, which makes me think this is related to the adaptive time step not exactly matching the time period.\nBut am I missing something? Is there a way to not get those warnings and still use a window that's the same as the interval?","user":"U01E0U2RJJ2","ts":"1608129075.248900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"BTi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Whenever I set a window that's smaller than the time interval I don't get that message, which makes me think this is related to the adaptive time step not exactly matching the time period.\nBut am I missing something? Is there a way to not get those warnings and still use a window that's the same as the interval?"}]}]}]},{"client_msg_id":"a23b8aa6-33ef-4d9b-a97f-e9a067a98eda","type":"message","text":"Ah if I understand your setup it looks like the averaged time interval schedules output writing every 2 minutes of simulation time with a window of 2 minutes, so it's always time averaging.","user":"UEP056STX","ts":"1608130906.250500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"LsX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah if I understand your setup it looks like the averaged time interval schedules output writing every 2 minutes of simulation time with a window of 2 minutes, so it's always time averaging."}]}]}]},{"client_msg_id":"cfa5da62-d75a-4fe8-ba70-d8a487243772","type":"message","text":"But the time step is ~15 minutes so if you're using Oceananigans v0.45.1+ (time steps are aligned with output writing and simulation stop time) then that will cause time steps to always be 2 minutes.","user":"UEP056STX","ts":"1608130926.251000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"iC0=U","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But the time step is ~15 minutes so if you're using Oceananigans v0.45.1+ (time steps are aligned with output writing and simulation stop time) then that will cause time steps to always be 2 minutes."}]}]}],"thread_ts":"1608130926.251000","reply_count":40,"reply_users_count":3,"latest_reply":"1608139447.267700","reply_users":["U01E0U2RJJ2","UEP056STX","UMZQBQU67"],"subscribed":false},{"client_msg_id":"a8e86275-2595-4090-a6a3-1c5e3ac04828","type":"message","text":"So it's always time averaging but each time average only contains one iteration worth of time-averaged data (i.e. no time averaging).","user":"UEP056STX","ts":"1608130961.251700","team":"T68168MUP","edited":{"user":"UEP056STX","ts":"1608130965.000000"},"blocks":[{"type":"rich_text","block_id":"aWCV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So it's always time averaging but each time average only contains one iteration worth of time-averaged data (i.e. no time averaging)."}]}]}]},{"client_msg_id":"872dbe8a-e0cd-4de4-ac46-cd84c1ff1565","type":"message","text":"Time averages have a boolean flag `AveragedTimeInterval.collecting` that is set to `true` when time averaging is started then set to `false` once the time averaging period is over (but this requires a second call).","user":"UEP056STX","ts":"1608131333.254400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"c6cT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Time averages have a boolean flag "},{"type":"text","text":"AveragedTimeInterval.collecting","style":{"code":true}},{"type":"text","text":" that is set to "},{"type":"text","text":"true","style":{"code":true}},{"type":"text","text":" when time averaging is started then set to "},{"type":"text","text":"false","style":{"code":true}},{"type":"text","text":" once the time averaging period is over (but this requires a second call)."}]}]}]},{"client_msg_id":"82127650-4f29-48b8-88c5-9c4812a28a4e","type":"message","text":"I think the warning you're seeing is printed when an output writer is writing time-averaged data to disk but the time-averaged data only contains one iteration's worth of time-averaging, so it never got the chance to set `collecting = false`.","user":"UEP056STX","ts":"1608131350.254900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4RIB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think the warning you're seeing is printed when an output writer is writing time-averaged data to disk but the time-averaged data only contains one iteration's worth of time-averaging, so it never got the chance to set "},{"type":"text","text":"collecting = false","style":{"code":true}},{"type":"text","text":"."}]}]}]},{"client_msg_id":"d42ce988-5030-4282-a259-260ef136a3b1","type":"message","text":"Pretty sure it's a harmless warning (your output should be fine although it's probably not really time averaged since the time step is larger than the averaging window and averaging interval).","user":"UEP056STX","ts":"1608131399.256000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zaaGo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Pretty sure it's a harmless warning (your output should be fine although it's probably not really time averaged since the time step is larger than the averaging window and averaging interval)."}]}]}]},{"client_msg_id":"6aa1b114-9864-4e8b-a699-b58223a75456","type":"message","text":"<@UMZQBQU67> should probably confirm in case I butchered the explanation.","user":"UEP056STX","ts":"1608131422.256500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"suc","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UMZQBQU67"},{"type":"text","text":" should probably confirm in case I butchered the explanation."}]}]}],"thread_ts":"1608131422.256500","reply_count":39,"reply_users_count":2,"latest_reply":"1608141462.278700","reply_users":["UEP056STX","UMZQBQU67"],"subscribed":false},{"client_msg_id":"66b61326-62e8-4352-b36c-bb11c185bfb6","type":"message","text":"Another (possibly very dumb) question: I'm just now noticing that my netcdf outputs all have Float32 precision, which is not what I want. How do I change this?","user":"U01E0U2RJJ2","ts":"1608139348.266600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QMU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Another (possibly very dumb) question: I'm just now noticing that my netcdf outputs all have Float32 precision, which is not what I want. How do I change this?"}]}]}]},{"client_msg_id":"415b5aa1-126f-40c1-8fa6-862f706e6893","type":"message","text":"checkout the `array_type` kwarg here: <https://clima.github.io/OceananigansDocumentation/stable/library/#Oceananigans.OutputWriters.NetCDFOutputWriter-Tuple{Any,Any}>","user":"UMZQBQU67","ts":"1608139991.268800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TJQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"checkout the "},{"type":"text","text":"array_type","style":{"code":true}},{"type":"text","text":" kwarg here: "},{"type":"link","url":"https://clima.github.io/OceananigansDocumentation/stable/library/#Oceananigans.OutputWriters.NetCDFOutputWriter-Tuple{Any,Any}"}]}]}]},{"client_msg_id":"18427621-380e-4f51-b06b-e2938b9ed3dc","type":"message","text":"note you can search the documentation with the search bar at top left, also you should be able to use the help function at the command line by pressing `?` and then typing `NetCDFOutputWriter`","user":"UMZQBQU67","ts":"1608140027.269500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jJM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"note you can search the documentation with the search bar at top left, also you should be able to use the help function at the command line by pressing "},{"type":"text","text":"?","style":{"code":true}},{"type":"text","text":" and then typing "},{"type":"text","text":"NetCDFOutputWriter","style":{"code":true}}]}]}]},{"client_msg_id":"cd72c510-e8c3-42af-bbe5-053841a9069a","type":"message","text":"you probably want `array_type = Array{Float64}`","user":"UMZQBQU67","ts":"1608140049.270200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fT0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you probably want "},{"type":"text","text":"array_type = Array{Float64}","style":{"code":true}}]}]}],"thread_ts":"1608140049.270200","reply_count":6,"reply_users_count":2,"latest_reply":"1608154566.282000","reply_users":["U01E0U2RJJ2","UMZQBQU67"],"subscribed":false},{"client_msg_id":"df50f507-9db7-4ec6-a8fe-7f7600906364","type":"message","text":"Hmmm, I wonder if the default `array_type` should be `Array{eltype(model.grid)}`","user":"UEP056STX","ts":"1608140056.270400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"F0c","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmmm, I wonder if the default "},{"type":"text","text":"array_type","style":{"code":true}},{"type":"text","text":" should be "},{"type":"text","text":"Array{eltype(model.grid)}","style":{"code":true}}]}]}],"thread_ts":"1608140056.270400","reply_count":1,"reply_users_count":1,"latest_reply":"1608142006.278900","reply_users":["U01E0U2RJJ2"],"subscribed":false},{"client_msg_id":"4f4432a3-d2db-41f2-9718-af3a498d772a","type":"message","text":"we can do that in the spirit of “no premature optimization”","user":"UMZQBQU67","ts":"1608140078.271000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zgVE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"we can do that in the spirit of “no premature optimization”"}]}]}],"reactions":[{"name":"+1","users":["UEP056STX"],"count":1}]},{"client_msg_id":"094b48cd-8d27-4cb2-9a76-13cf358b3c09","type":"message","text":"<@U01E0U2RJJ2> might help if you raise an issue about `WindowedTimeAverage` so we can document the problem + conversation + solution","user":"UMZQBQU67","ts":"1608140288.272000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2wlv","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U01E0U2RJJ2"},{"type":"text","text":" might help if you raise an issue about "},{"type":"text","text":"WindowedTimeAverage","style":{"code":true}},{"type":"text","text":" so we can document the problem + conversation + solution"}]}]}]},{"client_msg_id":"9723d364-99c4-4730-b555-03f94a0d4ec8","type":"message","text":"Will do! I just generally assume that it's me who's doing something stupid and don't create issues haha","user":"U01E0U2RJJ2","ts":"1608140463.273600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"BhbaF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Will do! I just generally assume that it's me who's doing something stupid and don't create issues haha"}]}]}],"reactions":[{"name":"stuck_out_tongue_winking_eye","users":["UMZQBQU67"],"count":1}]},{"client_msg_id":"7f1a1d04-a7c4-49fd-b815-768a76c7609d","type":"message","text":"Sorry for bombarding everyone with questions today, but here's another one: is there a reason for the background/molecular viscosity to be found under `model.closure`, but the eddy diffusivity to be found under `model.diffusivities`?","user":"U01E0U2RJJ2","ts":"1608154482.281100","team":"T68168MUP","edited":{"user":"U01E0U2RJJ2","ts":"1608154530.000000"},"blocks":[{"type":"rich_text","block_id":"stQl2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Sorry for bombarding everyone with questions today, but here's another one: is there a reason for the background/molecular viscosity to be found under "},{"type":"text","text":"model.closure","style":{"code":true}},{"type":"text","text":", but the eddy diffusivity to be found under "},{"type":"text","text":"model.diffusivities","style":{"code":true}},{"type":"text","text":"?"}]}]}]},{"client_msg_id":"d84fd4ab-1657-47a7-8155-003df4104748","type":"message","text":"It seems counter intuitive to me. The other way around would make more sense. Or even both being found under `model.closure`","user":"U01E0U2RJJ2","ts":"1608154512.281800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Mp5S5","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It seems counter intuitive to me. The other way around would make more sense. Or even both being found under "},{"type":"text","text":"model.closure","style":{"code":true}}]}]}]},{"client_msg_id":"8e3ec7bf-6523-493d-8ccd-59c9092661bc","type":"message","text":"I think we had an idea to create a new `model.auxiliaries` property that would house \"auxiliary fields\" that users want to be part of the model state, e.g. vorticity, and it could include diffusivities (deprecating `model.diffusivities`).","user":"UEP056STX","ts":"1608157828.284000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"c8u","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think we had an idea to create a new "},{"type":"text","text":"model.auxiliaries","style":{"code":true}},{"type":"text","text":" property that would house \"auxiliary fields\" that users want to be part of the model state, e.g. vorticity, and it could include diffusivities (deprecating "},{"type":"text","text":"model.diffusivities","style":{"code":true}},{"type":"text","text":")."}]}]}]},{"client_msg_id":"58ecbfd1-dbc2-4580-aa37-3dd657a8b3b2","type":"message","text":"Moving diffusivity fields to `model.closure` might also make sense (and be more consistent as you're suggesting).","user":"UEP056STX","ts":"1608157862.284800","team":"T68168MUP","edited":{"user":"UEP056STX","ts":"1608157874.000000"},"blocks":[{"type":"rich_text","block_id":"33hL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Moving diffusivity fields to "},{"type":"text","text":"model.closure","style":{"code":true}},{"type":"text","text":" might also make sense (and be more consistent as you're suggesting)."}]}]}]},{"client_msg_id":"a147c174-a9ea-44c6-975e-d7ca943d41c4","type":"message","text":"I just ask because it seems counter-intuitive to me (mainly because the eddy diffusivity, which is a closure, isn't in the closures), so I thought there might be a reason","user":"U01E0U2RJJ2","ts":"1608158276.285800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zVt0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I just ask because it seems counter-intuitive to me (mainly because the eddy diffusivity, which is a closure, isn't in the closures), so I thought there might be a reason"}]}]}]},{"client_msg_id":"0c7726ff-95b1-4cb5-826a-d1040255573e","type":"message","text":"I think the original motivation for that design choice is moot, and also doesn’t make sense because we understand the logic of `Adapt.adapt_structure` better now. The reason was that `Field`s could not be used directly on the GPU because we didn’t have an appropriate `adapt_structure` , and also because we didn’t realize it was fairly simple to write custom `adapt_structure` methods for `closure` . (Either of these would have solved the problem, we wouldn’t need both).\n\nThe kernel function for the diffusive flux divergence is\n\n```∇_κ_∇c(i, j, k, grid, clock, closure, c, val_tracer_index, diffusivities, tracers, buoyancy)```\nThus if eddy diffusivities were stored as fields inside `closure`, we’d have to unwrap the fields appropriately when `closure` was passed to the GPU.\n\nInstead, we manually unwrapped the data inside each `Field`, including `diffusivities`, and then passed those objects into these kernel functions.\n\n(We no longer “manually” unwrap `Field`; instead we use `adapt_structure` to unwrap it appropriately.)\n\nSo in summary, we found we had to treat all `Field`s / tuples of `Field`s in a special way because of this manual unwrapping, which include velocities, tracers, pressures, and diffusivities.\n\nIt’s worth mentioning another point. Originally we didn’t precompute eddy diffusivities at all. The first closure implementations we tried computed the eddy diffusivities at each point from scratch. However, this lead to slow code (I remember 20x slow down). So we moved to a strategy where eddy diffusivities were computed prior to evaluating the tendencies. It’s possible that better usage of GPU resources (eg using shared memory) would mean we wouldn’t have to precompute eddy diffusivities and could lead to a smaller memory foot print / faster code (also more accurate, since we could then compute the eddy diffusvities at all cell locations they were applied, rather than only computing at cell centers and interpolating).","user":"UMZQBQU67","ts":"1608161639.293700","team":"T68168MUP","edited":{"user":"UMZQBQU67","ts":"1608162195.000000"},"blocks":[{"type":"rich_text","block_id":"xnSN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think the original motivation for that design choice is moot, and also doesn’t make sense because we understand the logic of "},{"type":"text","text":"Adapt.adapt_structure","style":{"code":true}},{"type":"text","text":" better now. The reason was that "},{"type":"text","text":"Field","style":{"code":true}},{"type":"text","text":"s could not be used directly on the GPU because we didn’t have an appropriate "},{"type":"text","text":"adapt_structure","style":{"code":true}},{"type":"text","text":" , and also because we didn’t realize it was fairly simple to write custom "},{"type":"text","text":"adapt_structure","style":{"code":true}},{"type":"text","text":" methods for "},{"type":"text","text":"closure","style":{"code":true}},{"type":"text","text":" . (Either of these would have solved the problem, we wouldn’t need both).\n\nThe kernel function for the diffusive flux divergence is\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"∇_κ_∇c(i, j, k, grid, clock, closure, c, val_tracer_index, diffusivities, tracers, buoyancy)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"\nThus if eddy diffusivities were stored as fields inside "},{"type":"text","text":"closure","style":{"code":true}},{"type":"text","text":", we’d have to unwrap the fields appropriately when "},{"type":"text","text":"closure","style":{"code":true}},{"type":"text","text":" was passed to the GPU.\n\nInstead, we manually unwrapped the data inside each "},{"type":"text","text":"Field","style":{"code":true}},{"type":"text","text":", including "},{"type":"text","text":"diffusivities","style":{"code":true}},{"type":"text","text":", and then passed those objects into these kernel functions.\n\n(We no longer “manually” unwrap "},{"type":"text","text":"Field","style":{"code":true}},{"type":"text","text":"; instead we use "},{"type":"text","text":"adapt_structure","style":{"code":true}},{"type":"text","text":" to unwrap it appropriately.)\n\nSo in summary, we found we had to treat all "},{"type":"text","text":"Field","style":{"code":true}},{"type":"text","text":"s / tuples of "},{"type":"text","text":"Field","style":{"code":true}},{"type":"text","text":"s in a special way because of this manual unwrapping, which include velocities, tracers, pressures, and diffusivities.\n\nIt’s worth mentioning another point. Originally we didn’t precompute eddy diffusivities at all. The first closure implementations we tried computed the eddy diffusivities at each point from scratch. However, this lead to slow code (I remember 20x slow down). So we moved to a strategy where eddy diffusivities were computed prior to evaluating the tendencies. It’s possible that better usage of GPU resources (eg using shared memory) would mean we wouldn’t have to precompute eddy diffusivities and could lead to a smaller memory foot print / faster code (also more accurate, since we could then compute the eddy diffusvities at all cell locations they were applied, rather than only computing at cell centers and interpolating)."}]}]}]},{"client_msg_id":"c78b0a80-2a06-45c3-bb77-f61facb73877","type":"message","text":"As <@UEP056STX> mentions I think a better design will recognize the commonality between turbulent diffusivities, hydrostatic pressure, and also possibly user-provided fields that need to be computed in `update_state!` These are all *derived* quantities that 1) can be computed from the prognostic state of the model (velocities, and tracers) at a given time, 2) cannot be computed within a kernel (because they involve integrals / averages, or are just too expensive) and thus must be *precomputed* and 3) require their own memory allocation.\n\nWith `model.auxiliaries`, users and/or types could _define_ fields that have to be computed during `update_state!` and then used later in forcing functions, etc. For example, a forcing function that relaxes the velocity field to its horizontal average would require precomputation of `AveragedField(u, dims=(1, 2))`.\n\nWe can’t implement the stratification-aware flavor of AMD (at least not in a simple manner) right now because it depends on the horizontal average of buoyancy. So `model.auxiliaries` will allow us to implement the stratification-aware flavor of AMD easily.","user":"UMZQBQU67","ts":"1608162046.298400","team":"T68168MUP","edited":{"user":"UMZQBQU67","ts":"1608162105.000000"},"blocks":[{"type":"rich_text","block_id":"sHRB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"As "},{"type":"user","user_id":"UEP056STX"},{"type":"text","text":" mentions I think a better design will recognize the commonality between turbulent diffusivities, hydrostatic pressure, and also possibly user-provided fields that need to be computed in "},{"type":"text","text":"update_state!","style":{"code":true}},{"type":"text","text":" These are all "},{"type":"text","text":"derived","style":{"bold":true}},{"type":"text","text":" quantities that 1) can be computed from the prognostic state of the model (velocities, and tracers) at a given time, 2) cannot be computed within a kernel (because they involve integrals / averages, or are just too expensive) and thus must be "},{"type":"text","text":"precomputed","style":{"bold":true}},{"type":"text","text":" and 3) require their own memory allocation.\n\nWith "},{"type":"text","text":"model.auxiliaries","style":{"code":true}},{"type":"text","text":", users and/or types could "},{"type":"text","text":"define","style":{"italic":true}},{"type":"text","text":" fields that have to be computed during "},{"type":"text","text":"update_state!","style":{"code":true}},{"type":"text","text":" and then used later in forcing functions, etc. For example, a forcing function that relaxes the velocity field to its horizontal average would require precomputation of "},{"type":"text","text":"AveragedField(u, dims=(1, 2))","style":{"code":true}},{"type":"text","text":".\n\nWe can’t implement the stratification-aware flavor of AMD (at least not in a simple manner) right now because it depends on the horizontal average of buoyancy. So "},{"type":"text","text":"model.auxiliaries","style":{"code":true}},{"type":"text","text":" will allow us to implement the stratification-aware flavor of AMD easily."}]}]}]},{"client_msg_id":"455ef696-3f46-4cff-b4b1-0c7c3f9e2e29","type":"message","text":"Got it. Thanks! Looking forward to the `model.auxiliaries`  functionality and especially the stratification-aware AMD!","user":"U01E0U2RJJ2","ts":"1608162218.299600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yRaQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Got it. Thanks! Looking forward to the "},{"type":"text","text":"model.auxiliaries","style":{"code":true}},{"type":"text","text":"  functionality and especially the stratification-aware AMD!"}]}]}]},{"client_msg_id":"1dc28e36-d0d1-410a-9d6f-af2938d49d8c","type":"message","text":"Yeah I think that will be interesting. Apparently Vreugdenhil and Taylor didn’t find that it mattered noticeably for weak stratification, but it’d be interesting to test at higher stratifications than they ran at.","user":"UMZQBQU67","ts":"1608162284.300700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"f9Qrp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yeah I think that will be interesting. Apparently Vreugdenhil and Taylor didn’t find that it mattered noticeably for weak stratification, but it’d be interesting to test at higher stratifications than they ran at."}]}]}]},{"client_msg_id":"86e0c144-a913-4f6f-8979-d7fe27e4a411","type":"message","text":"I did run a couple of simulations once with AMD and the result was very very weird. I don't remember what the stratification value was, but it wasn't super high. I didn't investigate the issue further though for the lack of time, so it's possible that I made a mistake also","user":"U01E0U2RJJ2","ts":"1608216294.302300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yAh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I did run a couple of simulations once with AMD and the result was very very weird. I don't remember what the stratification value was, but it wasn't super high. I didn't investigate the issue further though for the lack of time, so it's possible that I made a mistake also"}]}]}]},{"client_msg_id":"dd46e9d2-1017-4af8-989a-2a2940d1adaf","type":"message","text":"We’ve used AMD in research (couple publications now) with great results for stratified flows. Or do you mean when using the buoyancy-aware parameter on in Oceanagnians or another code?","user":"UMZQBQU67","ts":"1608216560.302600","team":"T68168MUP","edited":{"user":"UMZQBQU67","ts":"1608216745.000000"},"blocks":[{"type":"rich_text","block_id":"k34g","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"We’ve used AMD in research (couple publications now) with great results for stratified flows. Or do you mean when using the buoyancy-aware parameter on in Oceanagnians or another code?"}]}]}]},{"client_msg_id":"b21503b7-30ed-4cba-93e3-b6519edb898f","type":"message","text":"No, I mean really just using the standard Oceananigans AMD closure. But like I said, it's possible I did something wrong since I didn't really have time to into it :slightly_smiling_face:","user":"U01E0U2RJJ2","ts":"1608235045.306000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"HNa7j","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"No, I mean really just using the standard Oceananigans AMD closure. But like I said, it's possible I did something wrong since I didn't really have time to into it "},{"type":"emoji","name":"slightly_smiling_face"}]}]}]},{"client_msg_id":"450a804b-48eb-48ce-9959-c27d16bdd89e","type":"message","text":"Ah out of curiosity what was the setup and how was it weird? I think I've seen AMD do weird things but that was on super coarse grids (too coarse for LES).","user":"UEP056STX","ts":"1608235784.307400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"JF+2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah out of curiosity what was the setup and how was it weird? I think I've seen AMD do weird things but that was on super coarse grids (too coarse for LES)."}]}]}]},{"client_msg_id":"81107c70-0548-491a-938e-604d25752485","type":"message","text":"The set-up was an internal baroclinic jet, and basically I saw a lot of small scale noise in the background (in pretty much all variables), where the stratification + plus viscosity should have damped them","user":"U01E0U2RJJ2","ts":"1608236104.308800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ssE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The set-up was an internal baroclinic jet, and basically I saw a lot of small scale noise in the background (in pretty much all variables), where the stratification + plus viscosity should have damped them"}]}]}]},{"client_msg_id":"0638e9c1-b2ec-4097-8e32-881caba7c3c9","type":"message","text":"I assume you were using a higher-order advection scheme and the small-scale noise disappeared when you changed to a different closure.","user":"UEP056STX","ts":"1608236212.309800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XZ6NK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I assume you were using a higher-order advection scheme and the small-scale noise disappeared when you changed to a different closure."}]}]}]},{"client_msg_id":"0cc67958-4b5e-4edb-86a8-b3aa7c4c1aba","type":"message","text":"I don't really remember which scheme I was using, but I generally use third order upwind","user":"U01E0U2RJJ2","ts":"1608236496.311700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Uhzl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I don't really remember which scheme I was using, but I generally use third order upwind"}]}]}]},{"client_msg_id":"701e3cc8-1af9-4f0b-98bf-defd0c01b201","type":"message","text":"But yeah, the noise disappeared when I switched to smagorisnky","user":"U01E0U2RJJ2","ts":"1608236518.312100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jeF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But yeah, the noise disappeared when I switched to smagorisnky"}]}]}]},{"client_msg_id":"791b8259-5742-492b-90cf-0e6a362d81fa","type":"message","text":"A few comments:\n\n• AMD is definitely the highest quality LES closure we have; judging from other’s experiences, its better than both NCAR LES’s Deardorff closure (esp for stable boundary layers), and a lot better than Smagorinsky, which tends to over dissipate.\n• However, AMD involves a ratio of terms. When there is no turbulence at all, I think the eddy diffusivity estimate can be unstable. Thus it makes sense to try adding small amounts of noise to all problems when running with AMD. In general, transition to turbulence problems are challenging with any LES scheme…\n• WENO5 is the best advection scheme we have and definitely recommended for all research GPU calculations; we find much better results (much less diffusive) than with either UpwindBiasedThirdOrder or UpwindBiasedFifthOrder (though <@U01FBLBCP7S> may have found a bug in UpwindBiasedFifthOrder).","user":"UMZQBQU67","ts":"1608236695.315000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"tHQ74","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"A few comments:\n\n"}]},{"type":"rich_text_list","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"AMD is definitely the highest quality LES closure we have; judging from other’s experiences, its better than both NCAR LES’s Deardorff closure (esp for stable boundary layers), and a lot better than Smagorinsky, which tends to over dissipate."}]},{"type":"rich_text_section","elements":[{"type":"text","text":"However, AMD involves a ratio of terms. When there is no turbulence at all, I think the eddy diffusivity estimate can be unstable. Thus it makes sense to try adding small amounts of noise to all problems when running with AMD. In general, transition to turbulence problems are challenging with any LES scheme…"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"WENO5 is the best advection scheme we have and definitely recommended for all research GPU calculations; we find much better results (much less diffusive) than with either UpwindBiasedThirdOrder or UpwindBiasedFifthOrder (though "},{"type":"user","user_id":"U01FBLBCP7S"},{"type":"text","text":" may have found a bug in UpwindBiasedFifthOrder)."}]}],"style":"bullet","indent":0}]}]},{"client_msg_id":"75e54777-64b1-4c42-b0a0-2aae29dc800e","type":"message","text":"Good to know. I'm somewhat familiar with WENO schemes, but I've never used them","user":"U01E0U2RJJ2","ts":"1608303104.315900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=JV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Good to know. I'm somewhat familiar with WENO schemes, but I've never used them"}]}]}]},{"client_msg_id":"856eb636-4f53-4bc1-9dd6-0c759cfba99c","type":"message","text":"Are they more costly than regular upwind regimes? I'm assuming there's a trade off to the improvements in dissipation","user":"U01E0U2RJJ2","ts":"1608303140.316800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2AO3N","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Are they more costly than regular upwind regimes? I'm assuming there's a trade off to the improvements in dissipation"}]}]}],"thread_ts":"1608303140.316800","reply_count":28,"reply_users_count":2,"latest_reply":"1608337649.322900","reply_users":["UMZQBQU67","U01E0U2RJJ2"],"subscribed":false},{"client_msg_id":"6ce0546e-23c6-46e1-aa7d-0f36628b9261","type":"message","text":"happy holidays to all: <https://github.com/navidcy/merry_xmas>","user":"UBY3ENVBK","ts":"1608899839.323300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"aRma","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"happy holidays to all: "},{"type":"link","url":"https://github.com/navidcy/merry_xmas"}]}]}]},{"type":"message","text":"Vizinanigans is comin along","files":[{"id":"F01HQEW4GPM","created":1609193405,"timestamp":1609193405,"name":"test.mp4","title":"test.mp4","mimetype":"video/mp4","filetype":"mp4","pretty_type":"MPEG 4 Video","user":"UQUQNNJRL","editable":false,"size":3724993,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01HQEW4GPM/test.mp4","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01HQEW4GPM/download/test.mp4","thumb_video":"https://files.slack.com/files-tmb/T68168MUP-F01HQEW4GPM-7bad35f309/test_thumb_video.jpeg","permalink":"https://julialang.slack.com/files/UQUQNNJRL/F01HQEW4GPM/test.mp4","permalink_public":"https://slack-files.com/T68168MUP-F01HQEW4GPM-c83a6bffcd","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"ykx","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Vizinanigans is comin along"}]}]}],"user":"UQUQNNJRL","display_as_bot":false,"ts":"1609193413.323500"},{"type":"message","text":"<@UBY3ENVBK> How can you not post the animation from <https://github.com/navidcy/merry_xmas> haha :christmas_tree: Happy holidays!","files":[{"id":"F01JFG3L0G0","created":1609265873,"timestamp":1609265873,"name":"xmascard.gif","title":"xmascard.gif","mimetype":"image/gif","filetype":"gif","pretty_type":"GIF","user":"UEP056STX","editable":false,"size":7781852,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01JFG3L0G0/xmascard.gif","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01JFG3L0G0/download/xmascard.gif","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01JFG3L0G0-2c9d2c1bcf/xmascard_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01JFG3L0G0-2c9d2c1bcf/xmascard_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01JFG3L0G0-2c9d2c1bcf/xmascard_360.png","thumb_360_w":360,"thumb_360_h":270,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01JFG3L0G0-2c9d2c1bcf/xmascard_480.png","thumb_480_w":480,"thumb_480_h":360,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01JFG3L0G0-2c9d2c1bcf/xmascard_160.png","thumb_720":"https://files.slack.com/files-tmb/T68168MUP-F01JFG3L0G0-2c9d2c1bcf/xmascard_720.png","thumb_720_w":720,"thumb_720_h":540,"thumb_800":"https://files.slack.com/files-tmb/T68168MUP-F01JFG3L0G0-2c9d2c1bcf/xmascard_800.png","thumb_800_w":800,"thumb_800_h":600,"thumb_360_gif":"https://files.slack.com/files-tmb/T68168MUP-F01JFG3L0G0-2c9d2c1bcf/xmascard_360.gif","thumb_480_gif":"https://files.slack.com/files-tmb/T68168MUP-F01JFG3L0G0-2c9d2c1bcf/xmascard_480.gif","original_w":800,"original_h":600,"deanimate_gif":"https://files.slack.com/files-tmb/T68168MUP-F01JFG3L0G0-2c9d2c1bcf/xmascard_deanimate_gif.png","thumb_tiny":"AwAkADC3c3DQuAoByM81A147DBVcfjS33+tX/dqtQapKxMLlgMbRj6mj7Q2CNowfc1DRQPlROt269FXn61LFdu8qqVXBNU6kt/8Aj4T60CcVYnvX2yL8oPHeq/m/7K/lUt//AK1f92q1OxzOTT3JROO8an8KUzIf+WQ/OoaKLIXPLuSeYn/PP9afA4M6AIBzUFSW3/Hwn1osh88n1NF4o5Dl1BIpv2aH/nmKlopF2RF9mh/55ij7ND/zzFS0UBZEX2aH/nmKVYIlYMqAEVJRQFkf/9k=","permalink":"https://julialang.slack.com/files/UEP056STX/F01JFG3L0G0/xmascard.gif","permalink_public":"https://slack-files.com/T68168MUP-F01JFG3L0G0-433f10c144","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"+CcCo","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UBY3ENVBK"},{"type":"text","text":" How can you not post the animation from "},{"type":"link","url":"https://github.com/navidcy/merry_xmas"},{"type":"text","text":" haha "},{"type":"emoji","name":"christmas_tree"},{"type":"text","text":" Happy holidays!"}]}]}],"user":"UEP056STX","display_as_bot":false,"ts":"1609265894.324700","edited":{"user":"UEP056STX","ts":"1609265907.000000"},"reactions":[{"name":"tada","users":["U01FBLBCP7S","U01DJ59B2SE","UQUQNNJRL","UB197FRCL"],"count":4},{"name":"christmas_tree","users":["UB197FRCL"],"count":1}]},{"type":"message","subtype":"channel_join","ts":"1609333563.328000","user":"U01HYEN2ES0","text":"<@U01HYEN2ES0> has joined the channel","inviter":"UEP056STX"},{"type":"message","subtype":"channel_join","ts":"1609333581.328300","user":"U01BG0NN34J","text":"<@U01BG0NN34J> has joined the channel","inviter":"UEP056STX"},{"client_msg_id":"202025eb-4799-43ff-9d18-d4771d536a79","type":"message","text":"Question for FourierFlows.jl, will it possible to expand it from doubly-periodic domains (for 2D simulations) to bounded (should be Dirichlet) conditions, ie. allowing for walls instead of infinite domain.","user":"UNJ1EG11C","ts":"1609364801.329600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Quq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Question for FourierFlows.jl, will it possible to expand it from doubly-periodic domains (for 2D simulations) to bounded (should be Dirichlet) conditions, ie. allowing for walls instead of infinite domain."}]}]}]},{"client_msg_id":"bfac3948-36ba-4cde-b5fa-a48af1f4d131","type":"message","text":"Asking cos I’m interesting in simulating channel QGPV flow if possible (as a side project, probably, not my main area of research)","user":"UNJ1EG11C","ts":"1609364852.330200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cWx","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Asking cos I’m interesting in simulating channel QGPV flow if possible (as a side project, probably, not my main area of research)"}]}]}]},{"type":"message","text":"Playing around with <@U01DJ59B2SE>’s immersed boundary implementation :triangular_ruler:","files":[{"id":"F01JV9NTHCY","created":1609979170,"timestamp":1609979170,"name":"slanted_plume.gif","title":"slanted_plume.gif","mimetype":"image/gif","filetype":"gif","pretty_type":"GIF","user":"UEP056STX","editable":false,"size":1456294,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01JV9NTHCY/slanted_plume.gif","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01JV9NTHCY/download/slanted_plume.gif","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_360.png","thumb_360_w":360,"thumb_360_h":240,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_480.png","thumb_480_w":480,"thumb_480_h":320,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_160.png","thumb_720":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_720.png","thumb_720_w":720,"thumb_720_h":480,"thumb_800":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_800.png","thumb_800_w":800,"thumb_800_h":533,"thumb_960":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_960.png","thumb_960_w":960,"thumb_960_h":640,"thumb_1024":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_1024.png","thumb_1024_w":1024,"thumb_1024_h":683,"thumb_360_gif":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_360.gif","thumb_480_gif":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_480.gif","original_w":1200,"original_h":800,"deanimate":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_deanimate.png","deanimate_gif":"https://files.slack.com/files-tmb/T68168MUP-F01JV9NTHCY-b92d55b69a/slanted_plume_deanimate_gif.png","thumb_tiny":"AwAgADDTpAc96WkHegA2j0pCi+lOrMvr3fmKI/L/ABMO9AFpbtZJ2jj5VRnd6nNWB0rHsTiR/wDd/qK2B0o6h0FpBjnnNLUFzFLMmxHVAevvQBUvrtmBSIEJ3fHX6Vn1qNaTNbrCXTavfBzUP9mSf89F/KmhMhszh3+g/mK2R0qhFYPGTl1OQO3uD/StAdKGCP/Z","permalink":"https://julialang.slack.com/files/UEP056STX/F01JV9NTHCY/slanted_plume.gif","permalink_public":"https://slack-files.com/T68168MUP-F01JV9NTHCY-107fd10248","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"Chy","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Playing around with "},{"type":"user","user_id":"U01DJ59B2SE"},{"type":"text","text":"’s immersed boundary implementation "},{"type":"emoji","name":"triangular_ruler"}]}]}],"user":"UEP056STX","display_as_bot":false,"ts":"1609979225.336900","reactions":[{"name":"star-struck","users":["UB197FRCL"],"count":1},{"name":"clapping","users":["UB197FRCL"],"count":1}]},{"client_msg_id":"3c4bf006-7ae4-41e9-abcb-778b00454dd1","type":"message","text":"Looks great <@UEP056STX>!  One question I have is how well are energy and mass conserved because of the immersed boundary?  Since we are using Finite Volume I presume that mass is conserved very well in general.  Does an immersed boundary affect that at all?  I wouldn't be suprised if it does, and I don't think that's a major concern, but I'm just interested to see any diagnostics, if they happen to be generated.","user":"U01FBLBCP7S","ts":"1610032346.340000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jE0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Looks great "},{"type":"user","user_id":"UEP056STX"},{"type":"text","text":"!  One question I have is how well are energy and mass conserved because of the immersed boundary?  Since we are using Finite Volume I presume that mass is conserved very well in general.  Does an immersed boundary affect that at all?  I wouldn't be suprised if it does, and I don't think that's a major concern, but I'm just interested to see any diagnostics, if they happen to be generated."}]}]}]},{"client_msg_id":"D28ECEEF-C8CD-4EF0-8CE2-B6E8A02E3ED1","type":"message","text":"There may be some issues wrt to the staggered grid, ie mass allowed to enter a cell at one end but have no outlet on the other due to that boundary being immersed. So you’re right a lot of the ibm options have trouble with that! Not sure if it is the case here. Hard to tell with interpolation among the faces in the analysis already right now. <@U01FBLBCP7S> ","user":"U01DJ59B2SE","ts":"1610035652.342900","team":"T68168MUP","edited":{"user":"U01DJ59B2SE","ts":"1610035670.000000"},"blocks":[{"type":"rich_text","block_id":"alA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"There may be some issues wrt to the staggered grid, ie mass allowed to enter a cell at one end but have no outlet on the other due to that boundary being immersed. So you’re right a lot of the ibm options have trouble with that! Not sure if it is the case here. Hard to tell with interpolation among the faces in the analysis already right now. "},{"type":"user","user_id":"U01FBLBCP7S"},{"type":"text","text":" "}]}]}]},{"client_msg_id":"1eadac08-2701-4156-86fd-52a0aed5e72e","type":"message","text":"Thanks <@U01DJ59B2SE> for the insights.  Every model has errors, and that's okay, it's just good to understand the limits of the model so we know what to expect.  I'm not sure if there is a diagnostics option to compute total energy and total mass, but if there was, it should be easy enough to compute these scalar fields for this example and compare it to one with a vertical wall.  I suspect it would be interesting to see the results.","user":"U01FBLBCP7S","ts":"1610036673.345400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hch07","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks "},{"type":"user","user_id":"U01DJ59B2SE"},{"type":"text","text":" for the insights.  Every model has errors, and that's okay, it's just good to understand the limits of the model so we know what to expect.  I'm not sure if there is a diagnostics option to compute total energy and total mass, but if there was, it should be easy enough to compute these scalar fields for this example and compare it to one with a vertical wall.  I suspect it would be interesting to see the results."}]}]}]},{"type":"message","text":"Not sure if this answers the question but comparing the mean and max kinetic energy (calculated at Cell, Cell, Cell) inside and outside the immersed boundary, it looks like there isn't too much kinetic energy inside the immsersed boundary. Not sure what would be an acceptable amount of leakage but it seems worst when the plume is hitting the boundary. The leakage goes down if we decrease the time step so we could potentially use the `TimeStepWizard` to control the time step if we want less kinetic energy leakage. (Left figure is dt = 5 second, right figure is dt = 2.5 seconds).","files":[{"id":"F01J7764BU5","created":1610124400,"timestamp":1610124400,"name":"slanted_plume_kinetic_energy_dt_5seconds.png","title":"slanted_plume_kinetic_energy_dt_5seconds.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"UEP056STX","editable":false,"size":80023,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01J7764BU5/slanted_plume_kinetic_energy_dt_5seconds.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01J7764BU5/download/slanted_plume_kinetic_energy_dt_5seconds.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01J7764BU5-3dbbad54e4/slanted_plume_kinetic_energy_dt_5seconds_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01J7764BU5-3dbbad54e4/slanted_plume_kinetic_energy_dt_5seconds_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01J7764BU5-3dbbad54e4/slanted_plume_kinetic_energy_dt_5seconds_360.png","thumb_360_w":360,"thumb_360_h":240,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01J7764BU5-3dbbad54e4/slanted_plume_kinetic_energy_dt_5seconds_480.png","thumb_480_w":480,"thumb_480_h":320,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01J7764BU5-3dbbad54e4/slanted_plume_kinetic_energy_dt_5seconds_160.png","thumb_720":"https://files.slack.com/files-tmb/T68168MUP-F01J7764BU5-3dbbad54e4/slanted_plume_kinetic_energy_dt_5seconds_720.png","thumb_720_w":720,"thumb_720_h":480,"thumb_800":"https://files.slack.com/files-tmb/T68168MUP-F01J7764BU5-3dbbad54e4/slanted_plume_kinetic_energy_dt_5seconds_800.png","thumb_800_w":800,"thumb_800_h":533,"thumb_960":"https://files.slack.com/files-tmb/T68168MUP-F01J7764BU5-3dbbad54e4/slanted_plume_kinetic_energy_dt_5seconds_960.png","thumb_960_w":960,"thumb_960_h":640,"thumb_1024":"https://files.slack.com/files-tmb/T68168MUP-F01J7764BU5-3dbbad54e4/slanted_plume_kinetic_energy_dt_5seconds_1024.png","thumb_1024_w":1024,"thumb_1024_h":683,"original_w":1200,"original_h":800,"thumb_tiny":"AwAgADDRbB4PNN2r7fnTuT19adQAzYvp+lJsHpUlFADR8q9OlCvk4pw70YHpQA3GP8adSEc0c+lAC0Um7tjml59KAAUUCigD/9k=","permalink":"https://julialang.slack.com/files/UEP056STX/F01J7764BU5/slanted_plume_kinetic_energy_dt_5seconds.png","permalink_public":"https://slack-files.com/T68168MUP-F01J7764BU5-a3c70cd7de","is_starred":false,"has_rich_preview":false},{"id":"F01J3GAMQA2","created":1610124406,"timestamp":1610124406,"name":"slanted_plume_kinetic_energy_dt_2.5seconds.png","title":"slanted_plume_kinetic_energy_dt_2.5seconds.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"UEP056STX","editable":false,"size":78596,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01J3GAMQA2/slanted_plume_kinetic_energy_dt_2.5seconds.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01J3GAMQA2/download/slanted_plume_kinetic_energy_dt_2.5seconds.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01J3GAMQA2-3ceff239ae/slanted_plume_kinetic_energy_dt_2.5seconds_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01J3GAMQA2-3ceff239ae/slanted_plume_kinetic_energy_dt_2.5seconds_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01J3GAMQA2-3ceff239ae/slanted_plume_kinetic_energy_dt_2.5seconds_360.png","thumb_360_w":360,"thumb_360_h":240,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01J3GAMQA2-3ceff239ae/slanted_plume_kinetic_energy_dt_2.5seconds_480.png","thumb_480_w":480,"thumb_480_h":320,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01J3GAMQA2-3ceff239ae/slanted_plume_kinetic_energy_dt_2.5seconds_160.png","thumb_720":"https://files.slack.com/files-tmb/T68168MUP-F01J3GAMQA2-3ceff239ae/slanted_plume_kinetic_energy_dt_2.5seconds_720.png","thumb_720_w":720,"thumb_720_h":480,"thumb_800":"https://files.slack.com/files-tmb/T68168MUP-F01J3GAMQA2-3ceff239ae/slanted_plume_kinetic_energy_dt_2.5seconds_800.png","thumb_800_w":800,"thumb_800_h":533,"thumb_960":"https://files.slack.com/files-tmb/T68168MUP-F01J3GAMQA2-3ceff239ae/slanted_plume_kinetic_energy_dt_2.5seconds_960.png","thumb_960_w":960,"thumb_960_h":640,"thumb_1024":"https://files.slack.com/files-tmb/T68168MUP-F01J3GAMQA2-3ceff239ae/slanted_plume_kinetic_energy_dt_2.5seconds_1024.png","thumb_1024_w":1024,"thumb_1024_h":683,"original_w":1200,"original_h":800,"thumb_tiny":"AwAgADDRbB4PNJsX0H50vJ6+tO4oAj2r/kUbB6fpUmaKAGj5V6dKFfJxTh3owPSgBuAOKdxSEEmjn0oAWim55xjmnc+lAAKKBRQB/9k=","permalink":"https://julialang.slack.com/files/UEP056STX/F01J3GAMQA2/slanted_plume_kinetic_energy_dt_2.5seconds.png","permalink_public":"https://slack-files.com/T68168MUP-F01J3GAMQA2-a0cb538b6b","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"uDl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Not sure if this answers the question but comparing the mean and max kinetic energy (calculated at Cell, Cell, Cell) inside and outside the immersed boundary, it looks like there isn't too much kinetic energy inside the immsersed boundary. Not sure what would be an acceptable amount of leakage but it seems worst when the plume is hitting the boundary. The leakage goes down if we decrease the time step so we could potentially use the "},{"type":"text","text":"TimeStepWizard","style":{"code":true}},{"type":"text","text":" to control the time step if we want less kinetic energy leakage. (Left figure is dt = 5 second, right figure is dt = 2.5 seconds)."}]}]}],"user":"UEP056STX","ts":"1610124428.350600","edited":{"user":"UEP056STX","ts":"1610124741.000000"}},{"client_msg_id":"20ea05bd-a6fe-4ecf-bb77-91359a7d6279","type":"message","text":"Thanks <@UEP056STX> for sharing these plots.  I imagine that time series plots of the KE would be quite different whether the left wall is straight or slanted, so the fact that those two are different seems reasonable to me.  I guess what I was trying to ask, but not very clearly, is are the quantities that are nearly conserved conserved as well with a slanted wall?  I have not looked at any diagnostics in Oceananigans but without any forcing or sources, total energy and total mass should be conserved.  Do you know if these are computed in any of the examples?  Computing the KE is interesting, but since it's not necessarily conserved it's not as useful a metric as the total energy.  But if we don't compute potential energy, or available potential energy, in any examples, this may not be as easy to check.  Total mass should be easier as it's the volume integral of the buoyancy.  Finite volume methods usually conserve these very well so I imagine Oceananigans does that too in the case of a vertical wall.","user":"U01FBLBCP7S","ts":"1610127822.356400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ML8w","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks "},{"type":"user","user_id":"UEP056STX"},{"type":"text","text":" for sharing these plots.  I imagine that time series plots of the KE would be quite different whether the left wall is straight or slanted, so the fact that those two are different seems reasonable to me.  I guess what I was trying to ask, but not very clearly, is are the quantities that are nearly conserved conserved as well with a slanted wall?  I have not looked at any diagnostics in Oceananigans but without any forcing or sources, total energy and total mass should be conserved.  Do you know if these are computed in any of the examples?  Computing the KE is interesting, but since it's not necessarily conserved it's not as useful a metric as the total energy.  But if we don't compute potential energy, or available potential energy, in any examples, this may not be as easy to check.  Total mass should be easier as it's the volume integral of the buoyancy.  Finite volume methods usually conserve these very well so I imagine Oceananigans does that too in the case of a vertical wall."}]}]}]},{"client_msg_id":"d73d70b5-3c0d-4853-bea4-88a1f853452a","type":"message","text":"Computing the total potential energy is pretty easy, but computing the available potential energy could be more useful.","user":"U01FBLBCP7S","ts":"1610128064.357000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"mzJas","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Computing the total potential energy is pretty easy, but computing the available potential energy could be more useful."}]}]}]},{"client_msg_id":"c02c4748-db7a-46bb-abc8-99ac7f5fa31c","type":"message","text":"Ah I see what you mean. Yeah I agree APE would be useful to diagnose although I'm not totally sure how to calculate it (seems like it wouldn't be a one-liner: <https://doi.org/10.1175/JPO-D-14-0155.1>) but volume-integrated buoyancy should be easy to diagnose so I can try plotting it.","user":"UEP056STX","ts":"1610129917.358400","team":"T68168MUP","edited":{"user":"UEP056STX","ts":"1610130353.000000"},"blocks":[{"type":"rich_text","block_id":"Btn+6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah I see what you mean. Yeah I agree APE would be useful to diagnose although I'm not totally sure how to calculate it (seems like it wouldn't be a one-liner: "},{"type":"link","url":"https://doi.org/10.1175/JPO-D-14-0155.1"},{"type":"text","text":") but volume-integrated buoyancy should be easy to diagnose so I can try plotting it."}]}]}],"thread_ts":"1610129917.358400","reply_count":1,"reply_users_count":1,"latest_reply":"1610133111.360700","reply_users":["U01FBLBCP7S"],"subscribed":false},{"type":"message","text":"<@U01FBLBCP7S> Tried plotting volume-integrated buoyancy and indeed it's not conserved (by ~40 ppm by t = 1 hour). Grows linearly but maybe that's because the plume keeps impinging on the immersed boundary.","files":[{"id":"F01HVUM9RHV","created":1610132638,"timestamp":1610132638,"name":"slanted_plume_mass_dt_5seconds.png","title":"slanted_plume_mass_dt_5seconds.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"UEP056STX","editable":false,"size":65726,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01HVUM9RHV/slanted_plume_mass_dt_5seconds.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01HVUM9RHV/download/slanted_plume_mass_dt_5seconds.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01HVUM9RHV-18129d92a8/slanted_plume_mass_dt_5seconds_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01HVUM9RHV-18129d92a8/slanted_plume_mass_dt_5seconds_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01HVUM9RHV-18129d92a8/slanted_plume_mass_dt_5seconds_360.png","thumb_360_w":360,"thumb_360_h":240,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01HVUM9RHV-18129d92a8/slanted_plume_mass_dt_5seconds_480.png","thumb_480_w":480,"thumb_480_h":320,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01HVUM9RHV-18129d92a8/slanted_plume_mass_dt_5seconds_160.png","thumb_720":"https://files.slack.com/files-tmb/T68168MUP-F01HVUM9RHV-18129d92a8/slanted_plume_mass_dt_5seconds_720.png","thumb_720_w":720,"thumb_720_h":480,"thumb_800":"https://files.slack.com/files-tmb/T68168MUP-F01HVUM9RHV-18129d92a8/slanted_plume_mass_dt_5seconds_800.png","thumb_800_w":800,"thumb_800_h":533,"thumb_960":"https://files.slack.com/files-tmb/T68168MUP-F01HVUM9RHV-18129d92a8/slanted_plume_mass_dt_5seconds_960.png","thumb_960_w":960,"thumb_960_h":640,"thumb_1024":"https://files.slack.com/files-tmb/T68168MUP-F01HVUM9RHV-18129d92a8/slanted_plume_mass_dt_5seconds_1024.png","thumb_1024_w":1024,"thumb_1024_h":683,"original_w":1200,"original_h":800,"thumb_tiny":"AwAgADDSOaQopOSOaBjbnPf+tLkeooATy19KCi9xS7gehBo49aAADH09KA2WxijIzS0ANGQMYp1IQaXn0oACPzpM9jSFsdRS8ntQAvcUUgzkelLQB//Z","permalink":"https://julialang.slack.com/files/UEP056STX/F01HVUM9RHV/slanted_plume_mass_dt_5seconds.png","permalink_public":"https://slack-files.com/T68168MUP-F01HVUM9RHV-646037e6b4","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"emg+P","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U01FBLBCP7S"},{"type":"text","text":" Tried plotting volume-integrated buoyancy and indeed it's not conserved (by ~40 ppm by t = 1 hour). Grows linearly but maybe that's because the plume keeps impinging on the immersed boundary."}]}]}],"user":"UEP056STX","display_as_bot":false,"ts":"1610132838.360000","thread_ts":"1610132838.360000","reply_count":3,"reply_users_count":2,"latest_reply":"1610134200.361600","reply_users":["U01FBLBCP7S","UEP056STX"],"subscribed":false}]}