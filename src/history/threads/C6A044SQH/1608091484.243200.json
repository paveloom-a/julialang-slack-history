[{"client_msg_id":"7a53e948-283e-4064-9775-a18567676023","type":"message","text":"can anyone help me. I'm trying to do a proof of concept and I'm wondering why I keep getting exactly double allocations in the second function than the first\n```using DifferentialEquations, Plots, BenchmarkTools\nfunction f1!(du, u, p, t)\n    k, V = p\n    x, y = u\n\n    r1 = x*k-y*V\n    r2 = x*k+y*V \n\n    du[1] = r1\n    du[2] = r2\nend\n\nparam = [1.05, 1.32]\ntspan = (0.0, 10.0)\nu0 = [1.0, 2.0]\nprob1 = ODEProblem(f1!, u0, tspan, param)\n\nsol1 = @btime solve(prob1)\n&gt;&gt; 31.300 μs (384 allocations: 34.08 KiB)```\nand I have one where I use a mutable struct to store the intermediates like so\n```mutable struct r\n    r1::Float64\n    r2::Float64\nend\n\nfunction f2!(du, u, p, t, mut)\n    k, V = p\n    x, y = u\n\n    mut.r1 = x*k-y*V\n    mut.r2 = x*k+y*V\n\n    du[1] = mut.r1\n    du[2] = mut.r2\n\nend\n\nmut = r(0.0, 0.0)\n\nprob2 = ODEProblem((du,u,p,t) -&gt; f2!(du,u,p,t,mut), u0, tspan, param)\n\nsol2 = @btime solve(prob2)\n&gt;&gt;   35.999 μs (664 allocations: 38.44 KiB)```","user":"U01G3BG7AFR","ts":"1608091484.243200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2Ykk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"can anyone help me. I'm trying to do a proof of concept and I'm wondering why I keep getting exactly double allocations in the second function than the first\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using DifferentialEquations, Plots, BenchmarkTools\nfunction f1!(du, u, p, t)\n    k, V = p\n    x, y = u\n\n    r1 = x*k-y*V\n    r2 = x*k+y*V \n\n    du[1] = r1\n    du[2] = r2\nend\n\nparam = [1.05, 1.32]\ntspan = (0.0, 10.0)\nu0 = [1.0, 2.0]\nprob1 = ODEProblem(f1!, u0, tspan, param)\n\nsol1 = @btime solve(prob1)\n>> 31.300 μs (384 allocations: 34.08 KiB)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"and I have one where I use a mutable struct to store the intermediates like so\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"mutable struct r\n    r1::Float64\n    r2::Float64\nend\n\nfunction f2!(du, u, p, t, mut)\n    k, V = p\n    x, y = u\n\n    mut.r1 = x*k-y*V\n    mut.r2 = x*k+y*V\n\n    du[1] = mut.r1\n    du[2] = mut.r2\n\nend\n\nmut = r(0.0, 0.0)\n\nprob2 = ODEProblem((du,u,p,t) -> f2!(du,u,p,t,mut), u0, tspan, param)\n\nsol2 = @btime solve(prob2)\n>>   35.999 μs (664 allocations: 38.44 KiB)"}]}]}],"thread_ts":"1608091484.243200","reply_count":4,"reply_users_count":2,"latest_reply":"1608092370.243900","reply_users":["U0179G7FG4F","U01G3BG7AFR"],"subscribed":false},{"client_msg_id":"bec3a845-29d9-4597-8ee8-e43b666db519","type":"message","text":"it's because `mut` is a non-const global.","user":"U0179G7FG4F","ts":"1608091752.243300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"q/K0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's because "},{"type":"text","text":"mut","style":{"code":true}},{"type":"text","text":" is a non-const global."}]}]}],"thread_ts":"1608091484.243200","parent_user_id":"U01G3BG7AFR"},{"client_msg_id":"3aab597d-fe6a-4199-9d03-9717913547f2","type":"message","text":"so if I wrapped this all into a function it should improve?","user":"U01G3BG7AFR","ts":"1608091810.243500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"g8hbQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so if I wrapped this all into a function it should improve?"}]}]}],"thread_ts":"1608091484.243200","parent_user_id":"U01G3BG7AFR"},{"client_msg_id":"a75440a7-a1a8-4e3c-a810-3b7fed9db463","type":"message","text":"I think so. I think you could declare `mut` to be `const` without anything breaking","user":"U0179G7FG4F","ts":"1608091907.243700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TsO9Q","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think so. I think you could declare "},{"type":"text","text":"mut","style":{"code":true}},{"type":"text","text":" to be "},{"type":"text","text":"const","style":{"code":true}},{"type":"text","text":" without anything breaking"}]}]}],"thread_ts":"1608091484.243200","parent_user_id":"U01G3BG7AFR"},{"client_msg_id":"f6c4202f-3f65-4cf5-8544-f15be01fcd79","type":"message","text":"It worked, thank you","user":"U01G3BG7AFR","ts":"1608092370.243900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xnoMA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It worked, thank you"}]}]}],"thread_ts":"1608091484.243200","parent_user_id":"U01G3BG7AFR"}]