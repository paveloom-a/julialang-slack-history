[{"client_msg_id":"21ba142e-6d2e-4446-aae1-07ab427f9059","type":"message","text":"So, I'm looking at the Julia  <https://github.com/JuliaLang/julia/issues/29841|#29841>, where I learned that `HTML` and `Text` are errors and would be removed from Julia 2.0.   So, I've been looking to replace them with local code as advised (since <https://github.com/JuliaLang/julia/pull/38892|pull #38892> was denied).   Here is the code in question.\n```mutable struct Text{T}\n    content::T\nend\n\nBase.print(io::IO, t::Text) = print(io, t.content)\nBase.print(io::IO, t::Text{&lt;:Function}) = t.content(io)\nBase.show(io::IO, t::Text) = print(io, t)```\nWhen I do a straight-up replacement, calling this type `Reprint` (let's say), it seems to work.  At first I thought it was slower; but I think that's a sampling error on an imperfect laptop.  I have a question.\n\n1. When I drop \"mutable\" things get slower, almost 40% slower.\n2. If I replace `content::T` with `content::Function` things also get much slower.\nI'm using this in a `Text() do io ... end` style, so I was seeing if it could be improved or simplified.  I guess not?  What are the impacts of using `{T}`?\nSorry for the multiple edits (slack UI is frustrating).","user":"ULTB7E6UW","ts":"1608159461.119200","team":"T68168MUP","edited":{"user":"ULTB7E6UW","ts":"1608160314.000000"},"blocks":[{"type":"rich_text","block_id":"/dQf","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So, I'm looking at the Julia  "},{"type":"link","url":"https://github.com/JuliaLang/julia/issues/29841","text":"#29841"},{"type":"text","text":", where I learned that "},{"type":"text","text":"HTML","style":{"code":true}},{"type":"text","text":" and "},{"type":"text","text":"Text","style":{"code":true}},{"type":"text","text":" are errors and would be removed from Julia 2.0.   So, I've been looking to replace them with local code as advised (since "},{"type":"link","url":"https://github.com/JuliaLang/julia/pull/38892","text":"pull #38892"},{"type":"text","text":" was denied).   Here is the code in question.\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"mutable struct Text{T}\n    content::T\nend\n\nBase.print(io::IO, t::Text) = print(io, t.content)\nBase.print(io::IO, t::Text{<:Function}) = t.content(io)\nBase.show(io::IO, t::Text) = print(io, t)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"When I do a straight-up replacement, calling this type "},{"type":"text","text":"Reprint","style":{"code":true}},{"type":"text","text":" (let's say), it seems to work.  At first I thought it was slower; but I think that's a sampling error on an imperfect laptop.  I have a question.\n\n"}]},{"type":"rich_text_list","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"When I drop \"mutable\" things get slower, almost 40% slower."}]},{"type":"rich_text_section","elements":[{"type":"text","text":"If I replace "},{"type":"text","text":"content::T","style":{"code":true}},{"type":"text","text":" with "},{"type":"text","text":"content::Function","style":{"code":true}},{"type":"text","text":" things also get much slower."}]}],"style":"ordered","indent":0},{"type":"rich_text_section","elements":[{"type":"text","text":"\nI'm using this in a "},{"type":"text","text":"Text() do io ... end","style":{"code":true}},{"type":"text","text":" style, so I was seeing if it could be improved or simplified.  I guess not?  What are the impacts of using "},{"type":"text","text":"{T}","style":{"code":true}},{"type":"text","text":"?\nSorry for the multiple edits (slack UI is frustrating)."}]}]}],"thread_ts":"1608159461.119200","reply_count":70,"reply_users_count":2,"latest_reply":"1608164821.136600","reply_users":["ULTB7E6UW","U0179G7FG4F"],"subscribed":false},{"client_msg_id":"ad3ad65e-33ff-4937-85b9-585b8db1ae63","type":"message","text":"I wasn't done authoring... *sigh*.  Let me delete and retry?","user":"ULTB7E6UW","ts":"1608159676.119800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"okJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I wasn't done authoring... "},{"type":"text","text":"sigh","style":{"bold":true}},{"type":"text","text":".  Let me delete and retry?"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"7aae2e01-9aa5-43e6-806f-5016eeae5965","type":"message","text":"you can just edit it. No need to delete","user":"U0179G7FG4F","ts":"1608159697.120100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gqZ/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you can just edit it. No need to delete"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"4276c7c4-0e98-454f-aad4-de0f4c5a65ba","type":"message","text":"Ok.  Done editing.  Sorry.","user":"ULTB7E6UW","ts":"1608159984.121400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"i6cw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ok.  Done editing.  Sorry."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"05f1930c-9916-437e-8aad-bb35d20d0144","type":"message","text":"no problem!","user":"U0179G7FG4F","ts":"1608160001.121600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0K7Ci","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"no problem!"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"5026e4eb-6e55-4c45-a178-c8e654bccc75","type":"message","text":"Removing `mutable` is devastating...  it's not like the value ever changes, but if you take off the `mutable` it's 40% slower.\n\n```HypertextLiteral: Trial(679.183 μs)HTL (Attributes): Trial(964.308 μs)\nHypertextLiteral: Trial(970.376 μs)HTL (Attributes): Trial(1.248 ms)```","user":"ULTB7E6UW","ts":"1608160032.121800","team":"T68168MUP","edited":{"user":"ULTB7E6UW","ts":"1608160116.000000"},"blocks":[{"type":"rich_text","block_id":"A1Ts","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Removing "},{"type":"text","text":"mutable","style":{"code":true}},{"type":"text","text":" is devastating...  it's not like the value ever changes, but if you take off the "},{"type":"text","text":"mutable","style":{"code":true}},{"type":"text","text":" it's 40% slower.\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"HypertextLiteral: Trial(679.183 μs)HTL (Attributes): Trial(964.308 μs)\nHypertextLiteral: Trial(970.376 μs)HTL (Attributes): Trial(1.248 ms)"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"e7f49523-f7e0-4ef1-9ae2-3b8c440434bd","type":"message","text":"is that including compilation time?","user":"U0179G7FG4F","ts":"1608160359.122200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"52g","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"is that including compilation time?"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"47d57faf-5473-4d52-b872-cd83aa6ab788","type":"message","text":"I don't think so.  But it's a great question.  I should run the function first before trying...","user":"ULTB7E6UW","ts":"1608160393.122400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gfz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I don't think so.  But it's a great question.  I should run the function first before trying..."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"b0d4c898-6b97-4ba1-86b2-45bbeb264bd7","type":"message","text":"this would kind of make sense if it is. The compiler can be way more aggressive with immutable `structs`. `mutable structs` tend to keep the compiler more honest since it's much harder to prove that changes are unobservable.","user":"U0179G7FG4F","ts":"1608160469.122600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zWVvV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"this would kind of make sense if it is. The compiler can be way more aggressive with immutable "},{"type":"text","text":"structs","style":{"code":true}},{"type":"text","text":". "},{"type":"text","text":"mutable structs","style":{"code":true}},{"type":"text","text":" tend to keep the compiler more honest since it's much harder to prove that changes are unobservable."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"856e941f-00bb-405e-9a33-25f65309d4eb","type":"message","text":"I put a call to the test function in before the @benchmark, and then a GC.gc()","user":"ULTB7E6UW","ts":"1608160544.122800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"u9FE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I put a call to the test function in before the @benchmark, and then a GC.gc()"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"40708b60-a4df-42d1-b661-2904d63f9fa7","type":"message","text":"The result is almost the same.","user":"ULTB7E6UW","ts":"1608160551.123000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"wrtMG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The result is almost the same."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"77413dea-2a69-46cd-ac73-6c701875c1c7","type":"message","text":"oh `@benchmark` and (`@btime`) actually do that for you already.","user":"U0179G7FG4F","ts":"1608160584.123200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"C9ui","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh "},{"type":"text","text":"@benchmark","style":{"code":true}},{"type":"text","text":" and ("},{"type":"text","text":"@btime","style":{"code":true}},{"type":"text","text":") actually do that for you already."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"994c7ee1-ebae-4ab3-a9da-a7a189bb4f68","type":"message","text":"ah, ok, yea...","user":"ULTB7E6UW","ts":"1608160608.123400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"x8w","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ah, ok, yea..."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"d47f22b4-7594-4903-8c78-21752ab9f730","type":"message","text":"So, I simplified the code.... to remove `{T}` and the performance does go down a bit...","user":"ULTB7E6UW","ts":"1608160679.123700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3jYC9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So, I simplified the code.... to remove `{T}` and the performance does go down a bit..."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"2c6229e8-1563-4de6-8034-a9e05cad5f42","type":"message","text":"```","user":"ULTB7E6UW","ts":"1608160684.123900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0KnHx","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"```"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"0c6352ce-36f9-4c8a-a267-d42ec0c57eaf","type":"message","text":"```mutable struct Reprint\n    content::Function\nend\n\nBase.print(io::IO, t::Reprint) = t.content(io)```","user":"ULTB7E6UW","ts":"1608160719.124100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"SSu","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"mutable struct Reprint\n    content::Function\nend\n\nBase.print(io::IO, t::Reprint) = t.content(io)"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"3e9ee60a-3df3-4831-880a-d96c6ce0de05","type":"message","text":"It seems to get 1-2% slower, but it's hard to know for sure.  If my content were always random lambdas... did `{T}` buy me anything?","user":"ULTB7E6UW","ts":"1608160759.124400","team":"T68168MUP","edited":{"user":"ULTB7E6UW","ts":"1608160775.000000"},"blocks":[{"type":"rich_text","block_id":"WUdEN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It seems to get 1-2% slower, but it's hard to know for sure.  If my content were always random lambdas... did "},{"type":"text","text":"{T}","style":{"code":true}},{"type":"text","text":" buy me anything?"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"9650d17d-2d95-4292-8b3e-e5e734021973","type":"message","text":"Anyway, that `mutable` is doing something magic :wink:","user":"ULTB7E6UW","ts":"1608160899.124700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nAfo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Anyway, that "},{"type":"text","text":"mutable","style":{"code":true}},{"type":"text","text":" is doing something magic "},{"type":"emoji","name":"wink"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"0b601de5-1035-409c-b5f9-c84729e54efc","type":"message","text":"Note that\n```mutable struct Reprint\n    content::Function\nend```\nisn't type stable. That should be a pretty big perf hit. Something is really weird here","user":"U0179G7FG4F","ts":"1608160994.124900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1rVp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Note that\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"mutable struct Reprint\n    content::Function\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"isn't type stable. That should be a pretty big perf hit. Something is really weird here"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"430ac3dd-95f1-4dd7-b2f9-c92fe97fb17e","type":"message","text":"I could branch and commit this... it's quite repeatable.  I've been unable to isolate the related code though.  I tried... <https://github.com/JuliaLang/julia/issues/38911> but, I haven't able to isolate the difference with mutable.","user":"ULTB7E6UW","ts":"1608161001.125100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"eo=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I could branch and commit this... it's quite repeatable.  I've been unable to isolate the related code though.  I tried... "},{"type":"link","url":"https://github.com/JuliaLang/julia/issues/38911"},{"type":"text","text":" but, I haven't able to isolate the difference with mutable."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"d86238e0-79c6-4e12-b542-c0eb9a537310","type":"message","text":"So, I'd imagine I've got a dynamic dispatch somewhere in here.  I don't think I can avoid it.","user":"ULTB7E6UW","ts":"1608161073.125300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jOK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So, I'd imagine I've got a dynamic dispatch somewhere in here.  I don't think I can avoid it."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"eb73ea74-a26e-4ff1-be1e-d3776c866e4b","type":"message","text":"<https://github.com/clarkevans/HypertextLiteral.jl/blob/master/src/convert.jl#L83>  This is an example of how it's used.","user":"ULTB7E6UW","ts":"1608161083.125500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+mVW","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://github.com/clarkevans/HypertextLiteral.jl/blob/master/src/convert.jl#L83"},{"type":"text","text":"  This is an example of how it's used."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"41ef44f4-f942-4869-bf9f-d1d0c4c24ab0","type":"message","text":"<https://github.com/clarkevans/HypertextLiteral.jl/blob/master/src/convert.jl#L141> is another one","user":"ULTB7E6UW","ts":"1608161108.125700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0af","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://github.com/clarkevans/HypertextLiteral.jl/blob/master/src/convert.jl#L141"},{"type":"text","text":" is another one"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"67686ee1-482f-4be8-a91e-6004f1f2690a","type":"message","text":"The design is to convert each request into a function and execute it.  It seems way faster than object iterations.","user":"ULTB7E6UW","ts":"1608161136.125900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yMM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The design is to convert each request into a function and execute it.  It seems way faster than object iterations."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"45524f2a-3bb2-418d-86f8-c2652797e8ae","type":"message","text":"This design was learned by copying what documenter is doing with `HTML` and `Text` objects work.","user":"ULTB7E6UW","ts":"1608161162.126200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+6hPF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This design was learned by copying what documenter is doing with "},{"type":"text","text":"HTML","style":{"code":true}},{"type":"text","text":" and "},{"type":"text","text":"Text","style":{"code":true}},{"type":"text","text":" objects work."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"637d49cf-ed39-4e56-90f8-db5d5e5f9cec","type":"message","text":"I was just trying to get rid of `Text{Function}` (if you drop the Function part it doesn't seem to mater that much)","user":"ULTB7E6UW","ts":"1608161208.126500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/om","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I was just trying to get rid of "},{"type":"text","text":"Text{Function}","style":{"code":true}},{"type":"text","text":" (if you drop the Function part it doesn't seem to mater that much)"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"4b0388aa-5af6-48c0-a9b9-733f481fae56","type":"message","text":"Anyway; I can just replicate `Text{T}` and be done with it.  But I'm curious why making something mutable slows things down so much.","user":"ULTB7E6UW","ts":"1608161256.126800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4OAc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Anyway; I can just replicate "},{"type":"text","text":"Text{T}","style":{"code":true}},{"type":"text","text":" and be done with it.  But I'm curious why making something mutable slows things down so much."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"25d54f55-fa52-4471-91e6-b55c12497c04","type":"message","text":"<https://github.com/clarkevans/HypertextLiteral.jl/blob/master/test/benchmark.jl> is the benchmark","user":"ULTB7E6UW","ts":"1608161287.127000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"mQK","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://github.com/clarkevans/HypertextLiteral.jl/blob/master/test/benchmark.jl"},{"type":"text","text":" is the benchmark"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"9164e330-5ba3-4209-a916-c39bc2fa8164","type":"message","text":"I compared this approach to many alternatives and its reasonably fast.  It's an odd design, making lambdas everwhere.","user":"ULTB7E6UW","ts":"1608161328.127200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xLAv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I compared this approach to many alternatives and its reasonably fast.  It's an odd design, making lambdas everwhere."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"360abaa7-7cf6-46ec-838a-1ebc5e3709cc","type":"message","text":"Anyway, since `Text` is going way, I could branch and commit `mutable struct Reprint{T}`.","user":"ULTB7E6UW","ts":"1608161412.127400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"tyGt","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Anyway, since "},{"type":"text","text":"Text","style":{"code":true}},{"type":"text","text":" is going way, I could branch and commit "},{"type":"text","text":"mutable struct Reprint{T}","style":{"code":true}},{"type":"text","text":"."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"fa00c6ff-718d-43b9-af9a-f43b9ed1371b","type":"message","text":"I think rewriting like\n```function inside_tag(xs)\n\tf = io::IO-&gt; (for (key, value) in xs\n            name = normalize_attribute_name(key)\n            print(io, attribute_pair(name, value))\n        end)\n    Text{typeof(f)}(f)\nend```\nwould greatly increase runtime performance","user":"U0179G7FG4F","ts":"1608162023.127600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"OPLeH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think rewriting like\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function inside_tag(xs)\n\tf = io::IO-> (for (key, value) in xs\n            name = normalize_attribute_name(key)\n            print(io, attribute_pair(name, value))\n        end)\n    Text{typeof(f)}(f)\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"would greatly increase runtime performance"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"b05f5978-307f-4e11-8164-65b9fe4ddc20","type":"message","text":"that way the `Text` is parametrized on the function type","user":"U0179G7FG4F","ts":"1608162040.127800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5d0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that way the "},{"type":"text","text":"Text","style":{"code":true}},{"type":"text","text":" is parametrized on the function type"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"c539850c-ac8e-4e9a-b3b6-7882c75f3f0c","type":"message","text":"Let me try :wink:","user":"ULTB7E6UW","ts":"1608162304.128000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ic2e","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Let me try "},{"type":"emoji","name":"wink"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"f2dbf67c-ae54-492d-9082-27a76321a760","type":"message","text":"It doesn't seem to make much of a difference in -this- benchmark, but it dosn't slow things down, and it makes much sense.","user":"ULTB7E6UW","ts":"1608162590.128200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"w=bv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It doesn't seem to make much of a difference in -this- benchmark, but it dosn't slow things down, and it makes much sense."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"b0ae4bfe-6f2f-41e9-a60b-3bac9083527c","type":"message","text":"Let me replace all usage....","user":"ULTB7E6UW","ts":"1608162621.128400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ukaU7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Let me replace all usage...."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"4c34acbb-1d85-48bb-8cd9-0946b212c523","type":"message","text":"So, the type of all of these are IO -&gt; nothing","user":"ULTB7E6UW","ts":"1608162809.128600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"02z","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So, the type of all of these are IO -> nothing"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"db747272-0272-4158-9651-6d533b3b1a06","type":"message","text":"Can I just hard code that?","user":"ULTB7E6UW","ts":"1608162812.128800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ipS2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Can I just hard code that?"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"19b6af7e-b967-4a28-ad29-8ec75345a036","type":"message","text":"every function has it's own type","user":"U0179G7FG4F","ts":"1608162829.129000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"M1u","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"every function has it's own type"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"77eb85fd-1d9a-4aef-8632-4c29536b0b88","type":"message","text":"they aren't typed by input/output types","user":"U0179G7FG4F","ts":"1608162842.129200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"J9gq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"they aren't typed by input/output types"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"5231002d-b420-435f-9eb6-72434cc22e94","type":"message","text":"So, with `Text{Function}` I'm basically disabling that and forcing a dispatch?","user":"ULTB7E6UW","ts":"1608162884.129400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0LT5O","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So, with "},{"type":"text","text":"Text{Function}","style":{"code":true}},{"type":"text","text":" I'm basically disabling that and forcing a dispatch?"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"d842fdd2-90b7-473c-9a62-d32a9b08888f","type":"message","text":"This approach is creating an enormous amount of lambdas...","user":"ULTB7E6UW","ts":"1608162900.129600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0wP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This approach is creating an enormous amount of lambdas..."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"15d34e45-872f-4851-93ba-4ed83290b93b","type":"message","text":"`Text{Function}` is for all performance concerns basically the same as `Text{Any}`. You were creating the lambdas before, just not as visibly. The `do` syntax creates a lambda","user":"U0179G7FG4F","ts":"1608162945.129800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ePB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Text{Function}","style":{"code":true}},{"type":"text","text":" is for all performance concerns basically the same as "},{"type":"text","text":"Text{Any}","style":{"code":true}},{"type":"text","text":". You were creating the lambdas before, just not as visibly. The "},{"type":"text","text":"do","style":{"code":true}},{"type":"text","text":" syntax creates a lambda"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"467494d3-f4f6-410d-aa20-a25ef2e3dc99","type":"message","text":"So, these lambdas are called exactly once","user":"ULTB7E6UW","ts":"1608162997.130000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"CxpB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So, these lambdas are called exactly once"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"1812e1ee-b2ce-4466-a2a2-fcf499794c40","type":"message","text":"if I use `Text(f)` isn't that the same as `Text{typeof(f)}(f)`","user":"ULTB7E6UW","ts":"1608163237.130200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3QN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if I use "},{"type":"text","text":"Text(f)","style":{"code":true}},{"type":"text","text":" isn't that the same as "},{"type":"text","text":"Text{typeof(f)}(f)","style":{"code":true}}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"01522efc-f570-4954-a440-eb20ff2ae3ee","type":"message","text":"good point. Forgot that that worked.","user":"U0179G7FG4F","ts":"1608163303.131000","team":"T68168MUP","edited":{"user":"U0179G7FG4F","ts":"1608163309.000000"},"blocks":[{"type":"rich_text","block_id":"z3PGA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"good point. Forgot that that worked."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"0186e6d5-3e65-49e6-bfd4-f72e701f22e4","type":"message","text":"Yea, so I only put in `{Function}` because it was a bit faster...","user":"ULTB7E6UW","ts":"1608163379.131300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nNo/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yea, so I only put in "},{"type":"text","text":"{Function}","style":{"code":true}},{"type":"text","text":" because it was a bit faster..."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"9520ab4e-e6f4-4efd-8ccd-fd3618eefcfa","type":"message","text":"I wasn't convinced it made a difference one way or the other...","user":"ULTB7E6UW","ts":"1608163406.131500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1eL9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I wasn't convinced it made a difference one way or the other..."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"99461d35-68a2-4580-9670-195ca5ca93ec","type":"message","text":"Anyway, by copying that pattern performance got about 30% worse.","user":"ULTB7E6UW","ts":"1608163462.131700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"i89k2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Anyway, by copying that pattern performance got about 30% worse."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"b0e0dc61-7110-4564-bba8-2737ad222c60","type":"message","text":"wait. really? that's very strange.","user":"U0179G7FG4F","ts":"1608163479.131900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"J2N","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"wait. really? that's very strange."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"3a94e785-b3d3-408d-b156-db30d3edeaa7","type":"message","text":"249.299 μs -&gt; 329.110 μs","user":"ULTB7E6UW","ts":"1608163495.132100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QfPYR","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"249.299 μs -> 329.110 μs"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"d18e9526-fffe-4ac1-b48b-696ecfdabe92","type":"message","text":"These lambdas are used once...","user":"ULTB7E6UW","ts":"1608163512.132300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GbSyh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"These lambdas are used once..."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"30ab9d12-bb95-4cb5-b0aa-a0b8f930dffc","type":"message","text":"yea, reverted and I'm back to 250","user":"ULTB7E6UW","ts":"1608163560.132500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TYWD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yea, reverted and I'm back to 250"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"83671658-b27d-426f-af7f-cf553f67ac3d","type":"message","text":"so... when I remove `{Function}` it also gets worse....","user":"ULTB7E6UW","ts":"1608163594.132700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/hRTD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so... when I remove "},{"type":"text","text":"{Function}","style":{"code":true}},{"type":"text","text":" it also gets worse...."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"ab249bec-4bd9-4ab5-8028-db4293bace78","type":"message","text":"Yea, `Text{Function}` improves performance signficiantly","user":"ULTB7E6UW","ts":"1608163607.132900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Jf=L","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yea, "},{"type":"text","text":"Text{Function}","style":{"code":true}},{"type":"text","text":" improves performance signficiantly"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"efd1ef69-db0f-4f9b-b71f-f178a15496da","type":"message","text":"with `Text()` I get 323.558 μs...","user":"ULTB7E6UW","ts":"1608163668.133100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MQRL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"with `Text()` I get 323.558 μs..."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"01cdaba7-d770-4a63-b644-7d6827c39215","type":"message","text":"When I do `Text{Function}` it gets bme back down to `246.228 μs`","user":"ULTB7E6UW","ts":"1608163698.133300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nuH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"When I do "},{"type":"text","text":"Text{Function}","style":{"code":true}},{"type":"text","text":" it gets bme back down to "},{"type":"text","text":"246.228 μs","style":{"code":true}}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"66419e02-0b11-49b1-97af-5131e2dd88c4","type":"message","text":"So, I think the whole `{T}` idea isn't helping in my case.","user":"ULTB7E6UW","ts":"1608163712.133500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"S4o/G","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So, I think the whole "},{"type":"text","text":"{T}","style":{"code":true}},{"type":"text","text":" idea isn't helping in my case."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"d885261f-6508-4b36-bfad-99a2e266e8ec","type":"message","text":"Thanks for helping clarify that for me.","user":"ULTB7E6UW","ts":"1608163721.133700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"R4Bw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks for helping clarify that for me."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"dbef3d3f-bcb8-47c3-9f88-0901ef5002bb","type":"message","text":"So, my struct should just be a `Function` nothing more, I think.  I still don't know why `mutable` keeps it fast...","user":"ULTB7E6UW","ts":"1608163786.133900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"R8V","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So, my struct should just be a "},{"type":"text","text":"Function","style":{"code":true}},{"type":"text","text":" nothing more, I think.  I still don't know why "},{"type":"text","text":"mutable","style":{"code":true}},{"type":"text","text":" keeps it fast..."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"d7ee8845-4afd-4d5a-af38-a14a1c88a419","type":"message","text":"In fact, this is the minimal function that does what's needed in this case...","user":"ULTB7E6UW","ts":"1608163873.134100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xTYe","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"In fact, this is the minimal function that does what's needed in this case..."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"6c463084-6941-4139-b880-512dcd8cb1a2","type":"message","text":"```mutable struct Reprint\n    content::Function\nend\n\nBase.print(io::IO, t::Reprint) = t.content(io)```","user":"ULTB7E6UW","ts":"1608163945.134300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Fpc","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"mutable struct Reprint\n    content::Function\nend\n\nBase.print(io::IO, t::Reprint) = t.content(io)"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"5f8b55fd-683f-4347-b048-cd90f7984dff","type":"message","text":"you might want to try out this PR <https://github.com/JuliaLang/julia/pull/37849>. It adds a new type of closure with some different performance charictaristics that might be helpful.","user":"U0179G7FG4F","ts":"1608163959.134500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"x=r","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you might want to try out this PR "},{"type":"link","url":"https://github.com/JuliaLang/julia/pull/37849"},{"type":"text","text":". It adds a new type of closure with some different performance charictaristics that might be helpful."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"bfdfe1ee-39dd-4124-9ba0-ff9a709bbe79","type":"message","text":"Remove the mutable and performance sucks badly.","user":"ULTB7E6UW","ts":"1608163961.134700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"WVrC3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Remove the mutable and performance sucks badly."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"50d7526b-8426-4a01-97d9-31080495c895","type":"message","text":"Sounds like a great idea.","user":"ULTB7E6UW","ts":"1608164025.134900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FJm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Sounds like a great idea."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"b516dfd5-f502-4e44-86c7-a279d009088a","type":"message","text":"It was designed for an upcoming AD system that will hopefully land in 1.7, but it would be a really useful datapoint to add to the PR if it substantially helps this.","user":"U0179G7FG4F","ts":"1608164140.135100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5cdol","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It was designed for an upcoming AD system that will hopefully land in 1.7, but it would be a really useful datapoint to add to the PR if it substantially helps this."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"0f97fad9-7df2-4627-ad37-f3e408b20b0c","type":"message","text":"So, I download julia, apply that patch, rebuild and then see if it improves things.","user":"ULTB7E6UW","ts":"1608164142.135300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"bwy","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So, I download julia, apply that patch, rebuild and then see if it improves things."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"b744072d-2d18-45fc-832c-369c5b765dc6","type":"message","text":"you also need to change the code to use the `@opaque` macro on the closure","user":"U0179G7FG4F","ts":"1608164341.135500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"G+Rq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you also need to change the code to use the "},{"type":"text","text":"@opaque","style":{"code":true}},{"type":"text","text":" macro on the closure"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"34ca8bc0-467f-4de9-99f2-2b9d7f85c24e","type":"message","text":"but other than that, yes. That said, if you gave me a small thing to benchmark, I'd be happy to run it (I already have Julia cloned from git, so it will be pretty quick for me to try the PR)","user":"U0179G7FG4F","ts":"1608164405.135700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fF/i","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but other than that, yes. That said, if you gave me a small thing to benchmark, I'd be happy to run it (I already have Julia cloned from git, so it will be pretty quick for me to try the PR)"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"5f6c1a28-6e82-4d88-b72d-706bfb47ba84","type":"message","text":"<https://github.com/JuliaLang/julia/issues/38911>","user":"ULTB7E6UW","ts":"1608164458.135900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"x8TJ","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://github.com/JuliaLang/julia/issues/38911"}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"9636cbc0-ba26-4631-9ea6-336e7bbc32f7","type":"message","text":"That ticket, which reports a slow-down for newer Julia has a \"small thing\" that emulates the core of the approach.","user":"ULTB7E6UW","ts":"1608164505.136100","team":"T68168MUP","edited":{"user":"ULTB7E6UW","ts":"1608164688.000000"},"blocks":[{"type":"rich_text","block_id":"4OX9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That ticket, which reports a slow-down for newer Julia has a \"small thing\" that emulates the core of the approach."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"},{"client_msg_id":"ad21db35-0eea-4ad2-b361-6e2b030855ca","type":"message","text":"It also has `mutable` there.... if you remove that, it's slight, but the performance does degrade.","user":"ULTB7E6UW","ts":"1608164821.136600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Qsmho","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It also has "},{"type":"text","text":"mutable","style":{"code":true}},{"type":"text","text":" there.... if you remove that, it's slight, but the performance does degrade."}]}]}],"thread_ts":"1608159461.119200","parent_user_id":"ULTB7E6UW"}]