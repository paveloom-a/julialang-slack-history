[{"client_msg_id":"00850188-741c-447b-9e56-7811370f998f","type":"message","text":"<@U681ELA87> I opened <https://github.com/JuliaData/Arrow.jl/issues/113> regarding unsigned indices in the Arrow.jl-generated DictEncoding types.  If you don't have time to look at this and can point me to the section of code where conversion to signed ints is expected to happen I can take a look.","user":"UBGRZ7FSP","ts":"1611764414.101200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"bkph","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U681ELA87"},{"type":"text","text":" I opened "},{"type":"link","url":"https://github.com/JuliaData/Arrow.jl/issues/113"},{"type":"text","text":" regarding unsigned indices in the Arrow.jl-generated DictEncoding types.  If you don't have time to look at this and can point me to the section of code where conversion to signed ints is expected to happen I can take a look."}]}]}],"thread_ts":"1611764414.101200","reply_count":4,"reply_users_count":2,"latest_reply":"1611766767.103800","reply_users":["U681ELA87","UBGRZ7FSP"],"subscribed":false},{"client_msg_id":"592c1615-065e-4879-89d6-cdc404dc15f5","type":"message","text":"Haha, jinx. I opened <https://github.com/JuliaData/Arrow.jl/issues/112> too.","user":"U681ELA87","ts":"1611764545.101300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"bhKI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Haha, jinx. I opened "},{"type":"link","url":"https://github.com/JuliaData/Arrow.jl/issues/112"},{"type":"text","text":" too."}]}]}],"thread_ts":"1611764414.101200","parent_user_id":"UBGRZ7FSP"},{"client_msg_id":"9c5f4ef9-c9a7-4b42-a26b-085b432dc429","type":"message","text":"I think there's two places I would look:\n• <https://github.com/JuliaData/Arrow.jl/blob/6d76412d7460a5fdb1713e2ce1a41f43f54c783b/src/write.jl#L342>; this is where we actually build the metadata of what type is saved in the arrow metadata\n• The other place is here: <https://github.com/JuliaData/Arrow.jl/blob/main/src/arraytypes/dictencoding.jl#L108>. That's where we'll take a PooledArray/CategoricalArray/anything that implements `DataAPI.refpool`/ and converts it to the arrow version of dictionary encoding. So you can literally take a PooledArray and call `Arrow.toarrowvector(arr)` and get back the arrow version and check out the index types and stuff. From a quick glance, it looks like we may just be \"passing through\" existing dict-encoded array type indices, so we may need to convert instead.","user":"U681ELA87","ts":"1611764943.101500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rr=0e","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think there's two places I would look:\n"}]},{"type":"rich_text_list","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://github.com/JuliaData/Arrow.jl/blob/6d76412d7460a5fdb1713e2ce1a41f43f54c783b/src/write.jl#L342"},{"type":"text","text":"; this is where we actually build the metadata of what type is saved in the arrow metadata"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"The other place is here: "},{"type":"link","url":"https://github.com/JuliaData/Arrow.jl/blob/main/src/arraytypes/dictencoding.jl#L108"},{"type":"text","text":". That's where we'll take a PooledArray/CategoricalArray/anything that implements "},{"type":"text","text":"DataAPI.refpool","style":{"code":true}},{"type":"text","text":"/ and converts it to the arrow version of dictionary encoding. So you can literally take a PooledArray and call "},{"type":"text","text":"Arrow.toarrowvector(arr)","style":{"code":true}},{"type":"text","text":" and get back the arrow version and check out the index types and stuff. From a quick glance, it looks like we may just be \"passing through\" existing dict-encoded array type indices, so we may need to convert instead."}]}],"style":"bullet","indent":0}]}],"thread_ts":"1611764414.101200","parent_user_id":"UBGRZ7FSP"},{"client_msg_id":"2cd64bfb-fc42-4b93-85f6-ea56af029818","type":"message","text":"I believe it is in <https://github.com/JuliaData/Arrow.jl/blob/main/src/arraytypes/dictencoding.jl#L108>.  In particular at line 121 the refarray is copied and I think it should be coerced to a signed type there.  I'll work on a fix but you may have a better way.  I see there are methods defined for `signedtype` but it doesn't seem to be used.","user":"UBGRZ7FSP","ts":"1611765433.101700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2ogf","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I believe it is in "},{"type":"link","url":"https://github.com/JuliaData/Arrow.jl/blob/main/src/arraytypes/dictencoding.jl#L108"},{"type":"text","text":".  In particular at line 121 the refarray is copied and I think it should be coerced to a signed type there.  I'll work on a fix but you may have a better way.  I see there are methods defined for "},{"type":"text","text":"signedtype","style":{"code":true}},{"type":"text","text":" but it doesn't seem to be used."}]}]}],"thread_ts":"1611764414.101200","parent_user_id":"UBGRZ7FSP"},{"client_msg_id":"a3363722-a3fc-4c43-84c8-9ad8fcd3992f","type":"message","text":"Yeah, that sounds right to me. We try to do things as lazily as possible, so I'd probably change that line to:\n```inds = converter(signed(eltype(DataAPI.refarray(x))), copy(DataAPI.refarray(x)))```\n`converter` creates a lazy converting array; it's defined in src/utils.jl","user":"U681ELA87","ts":"1611766767.103800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"t7YO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yeah, that sounds right to me. We try to do things as lazily as possible, so I'd probably change that line to:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"inds = converter(signed(eltype(DataAPI.refarray(x))), copy(DataAPI.refarray(x)))"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"converter","style":{"code":true}},{"type":"text","text":" creates a lazy converting array; it's defined in src/utils.jl"}]}]}],"thread_ts":"1611764414.101200","parent_user_id":"UBGRZ7FSP"}]