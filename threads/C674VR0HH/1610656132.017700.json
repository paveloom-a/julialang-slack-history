[{"client_msg_id":"d8ff4009-e0e8-464d-950d-17d70d12ae79","type":"message","text":"<@U6A936746> Can I pick your brain about a DataDeps thing?","user":"U8JP5B9T2","ts":"1610656132.017700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"d8O","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U6A936746"},{"type":"text","text":" Can I pick your brain about a DataDeps thing?"}]}]}],"thread_ts":"1610656132.017700","reply_count":7,"reply_users_count":2,"latest_reply":"1610656724.019100","reply_users":["U8JP5B9T2","U6A936746"],"subscribed":false},{"client_msg_id":"4f6db6ec-82d2-49a3-86a0-17c7212aed24","type":"message","text":"I'm downloading a file from <http://osf.io|osf.io> , and this works:\n\n```register(DataDep(\n   \"kneaddata_counts\",\n   \"\"\"\n   Diagnostic information about sequence reads after cleaning with KneadData.\n   \"\"\",\n   \"<https://osf.io/ugxjs/download>\"))```","user":"U8JP5B9T2","ts":"1610656199.017800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UN8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm downloading a file from "},{"type":"link","url":"http://osf.io","text":"osf.io"},{"type":"text","text":" , and this works:\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"register(DataDep(\n   \"kneaddata_counts\",\n   \"\"\"\n   Diagnostic information about sequence reads after cleaning with KneadData.\n   \"\"\",\n   \""},{"type":"link","url":"https://osf.io/ugxjs/download"},{"type":"text","text":"\"))"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"f86bd8fd-04b1-48bb-8a57-85b7314153c0","type":"message","text":"What is then put into the `.julia/datadeps/kneaddata_counts` is\n\n```❯ ls kneaddata_counts\n download   kneaddata_read_counts.tar.gz```\n","user":"U8JP5B9T2","ts":"1610656277.018000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"dTC1r","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What is then put into the "},{"type":"text","text":".julia/datadeps/kneaddata_counts","style":{"code":true}},{"type":"text","text":" is\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"❯ ls kneaddata_counts\n download   kneaddata_read_counts.tar.gz"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"3ef1cfb3-28c0-4062-9afe-e8ad1209c2d6","type":"message","text":"the actual files I want (they're tsvs) are all named the same thing and in sub directories with a batch number\n\n```❯ fd read ./\nbiobakery3/batch001/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch002/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch003/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch004/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch005/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch006/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch007/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch008/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch009/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch010/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch011/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch012/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch013/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch014/output/kneaddata/kneaddata_read_counts.txt```","user":"U8JP5B9T2","ts":"1610656343.018200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"d2t","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the actual files I want (they're tsvs) are all named the same thing and in sub directories with a batch number\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"❯ fd read ./\nbiobakery3/batch001/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch002/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch003/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch004/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch005/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch006/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch007/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch008/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch009/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch010/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch011/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch012/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch013/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch014/output/kneaddata/kneaddata_read_counts.txt"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"e8f8c689-c928-47cc-8cfd-b11881db2112","type":"message","text":"So I'm trying to make a post_fetch_method that takes all of those files and writes a new file, deleting the stuff that isn't necessary\n```\nfunction post_fetch_knead(deppath)\n    rm(joinpath(deppath, \"download\"), force=true)\n    tarball = joinpath(deppath, \"kneaddata_read_counts.tar.gz\")\n    run(tar -xzf $tarball)\n    allcounts = DataFrame()\n    for (root, dir, files) in walkdir(deppath)\n        length(files) == 1 || continue\n        counts = first(files)\n        counts == \"kneaddata_read_counts.txt\" || continue\n        batch = match(r\"biobakery3\\/batch(\\d{3})\\/output\", root).captures[1]\n        batch = parse(Int, batch)\n        df = CSV.read(joinpath(root, counts), DataFrame)\n        df[!, :batch] .= batch\n        append!(allcounts, df)\n    end\n    CSV.write(joinpath(deppath, \"allcounts.tsv\"), allcounts)\n    rm(joinpath(deppath, \"biobakery3\"), recursive=true, force=true)\nend```\n","user":"U8JP5B9T2","ts":"1610656422.018400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pnd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So I'm trying to make a post_fetch_method that takes all of those files and writes a new file, deleting the stuff that isn't necessary\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"\nfunction post_fetch_knead(deppath)\n    rm(joinpath(deppath, \"download\"), force=true)\n    tarball = joinpath(deppath, \"kneaddata_read_counts.tar.gz\")\n    run(tar -xzf $tarball)\n    allcounts = DataFrame()\n    for (root, dir, files) in walkdir(deppath)\n        length(files) == 1 || continue\n        counts = first(files)\n        counts == \"kneaddata_read_counts.txt\" || continue\n        batch = match(r\"biobakery3\\/batch(\\d{3})\\/output\", root).captures[1]\n        batch = parse(Int, batch)\n        df = CSV.read(joinpath(root, counts), DataFrame)\n        df[!, :batch] .= batch\n        append!(allcounts, df)\n    end\n    CSV.write(joinpath(deppath, \"allcounts.tsv\"), allcounts)\n    rm(joinpath(deppath, \"biobakery3\"), recursive=true, force=true)\nend"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2","reactions":[{"name":"eyes","users":["U6A936746"],"count":1}]},{"client_msg_id":"adb2e2dc-1a80-4588-ab37-4b53d7520536","type":"message","text":"That function runs when I run it manually with `post_fetch_knead(\"/home/kevin/.julia/datadeps/kneaddata_counts\")`","user":"U8JP5B9T2","ts":"1610656485.018600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"S6Z","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That function runs when I run it manually with "},{"type":"text","text":"post_fetch_knead(\"/home/kevin/.julia/datadeps/kneaddata_counts\")","style":{"code":true}}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"06f19462-b271-4a3d-8b66-9cc736bb644a","type":"message","text":"but when I add `post_fetch_method=post_fetch_knead` and try to register the datadep, I get\n\n``` Info: Downloading\n│   source = \"<https://osf.io/ugxjs/download>\"\n│   dest = \"/home/kevin/.julia/datadeps/kneaddata_counts/kneaddata_read_counts.tar.gz\"\n│   progress = 1.0\n│   time_taken = \"0.05 s\"\n│   time_remaining = \"0.0 s\"\n│   average_speed = \"974.008 KiB/s\"\n│   downloaded = \"50.648 KiB\"\n│   remaining = \"0 bytes\"\n└   total = \"50.648 KiB\"\n┌ Warning: Checksum not provided, add to the Datadep Registration the following hash line\n│   hash = \"ad75c18b4987147c1a282a662195e0b717140ee3aacbab7f412c4c8e15c0a1ad\"\n└ @ DataDeps ~/.julia/packages/DataDeps/jrlAW/src/verification.jl:44\nERROR: IOError: unlink(\"/home/kevin/.julia/datadeps/kneaddata_counts/kneaddata_read_counts.tar.gz/download\"): not a directory (ENOTDIR)\nStacktrace:\n  [1] uv_error\n    @ ./libuv.jl:97 [inlined]\n  [2] unlink(p::String)\n    @ Base.Filesystem ./file.jl:934\n  [3] rm(path::String; force::Bool, recursive::Bool)\n    @ Base.Filesystem ./file.jl:272\n  [4] post_fetch_knead(deppath::String)\n    @ Main ~/Repos/resonance_paper1/src/data.jl:2```","user":"U8JP5B9T2","ts":"1610656574.018900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"93T","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but when I add "},{"type":"text","text":"post_fetch_method=post_fetch_knead","style":{"code":true}},{"type":"text","text":" and try to register the datadep, I get\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":" Info: Downloading\n│   source = \""},{"type":"link","url":"https://osf.io/ugxjs/download"},{"type":"text","text":"\"\n│   dest = \"/home/kevin/.julia/datadeps/kneaddata_counts/kneaddata_read_counts.tar.gz\"\n│   progress = 1.0\n│   time_taken = \"0.05 s\"\n│   time_remaining = \"0.0 s\"\n│   average_speed = \"974.008 KiB/s\"\n│   downloaded = \"50.648 KiB\"\n│   remaining = \"0 bytes\"\n└   total = \"50.648 KiB\"\n┌ Warning: Checksum not provided, add to the Datadep Registration the following hash line\n│   hash = \"ad75c18b4987147c1a282a662195e0b717140ee3aacbab7f412c4c8e15c0a1ad\"\n└ @ DataDeps ~/.julia/packages/DataDeps/jrlAW/src/verification.jl:44\nERROR: IOError: unlink(\"/home/kevin/.julia/datadeps/kneaddata_counts/kneaddata_read_counts.tar.gz/download\"): not a directory (ENOTDIR)\nStacktrace:\n  [1] uv_error\n    @ ./libuv.jl:97 [inlined]\n  [2] unlink(p::String)\n    @ Base.Filesystem ./file.jl:934\n  [3] rm(path::String; force::Bool, recursive::Bool)\n    @ Base.Filesystem ./file.jl:272\n  [4] post_fetch_knead(deppath::String)\n    @ Main ~/Repos/resonance_paper1/src/data.jl:2"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"7ef8a7a4-a6d9-4b1b-9200-a51957bfa5f9","type":"message","text":"I am still looking at your code, and i don’t think this will fix iot, but rather than\n```run(`tar -xzf $tarball`)```\nI suggest `datadeps.unpack(tarball)`","user":"U6A936746","ts":"1610656724.019100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"sIxZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I am still looking at your code, and i don’t think this will fix iot, but rather than\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"run(`tar -xzf $tarball`)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"I suggest "},{"type":"text","text":"datadeps.unpack(tarball)","style":{"code":true}}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"}]