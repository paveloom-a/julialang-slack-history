[{"client_msg_id":"d8ff4009-e0e8-464d-950d-17d70d12ae79","type":"message","text":"<@U6A936746> Can I pick your brain about a DataDeps thing?","user":"U8JP5B9T2","ts":"1610656132.017700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"d8O","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U6A936746"},{"type":"text","text":" Can I pick your brain about a DataDeps thing?"}]}]}],"thread_ts":"1610656132.017700","reply_count":37,"reply_users_count":2,"latest_reply":"1610659356.026100","reply_users":["U8JP5B9T2","U6A936746"],"subscribed":false},{"client_msg_id":"4f6db6ec-82d2-49a3-86a0-17c7212aed24","type":"message","text":"I'm downloading a file from <http://osf.io|osf.io> , and this works:\n\n```register(DataDep(\n   \"kneaddata_counts\",\n   \"\"\"\n   Diagnostic information about sequence reads after cleaning with KneadData.\n   \"\"\",\n   \"<https://osf.io/ugxjs/download>\"))```","user":"U8JP5B9T2","ts":"1610656199.017800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UN8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm downloading a file from "},{"type":"link","url":"http://osf.io","text":"osf.io"},{"type":"text","text":" , and this works:\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"register(DataDep(\n   \"kneaddata_counts\",\n   \"\"\"\n   Diagnostic information about sequence reads after cleaning with KneadData.\n   \"\"\",\n   \""},{"type":"link","url":"https://osf.io/ugxjs/download"},{"type":"text","text":"\"))"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"f86bd8fd-04b1-48bb-8a57-85b7314153c0","type":"message","text":"What is then put into the `.julia/datadeps/kneaddata_counts` is\n\n```❯ ls kneaddata_counts\n download   kneaddata_read_counts.tar.gz```\n","user":"U8JP5B9T2","ts":"1610656277.018000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"dTC1r","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What is then put into the "},{"type":"text","text":".julia/datadeps/kneaddata_counts","style":{"code":true}},{"type":"text","text":" is\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"❯ ls kneaddata_counts\n download   kneaddata_read_counts.tar.gz"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"3ef1cfb3-28c0-4062-9afe-e8ad1209c2d6","type":"message","text":"the actual files I want (they're tsvs) are all named the same thing and in sub directories with a batch number\n\n```❯ fd read ./\nbiobakery3/batch001/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch002/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch003/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch004/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch005/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch006/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch007/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch008/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch009/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch010/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch011/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch012/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch013/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch014/output/kneaddata/kneaddata_read_counts.txt```","user":"U8JP5B9T2","ts":"1610656343.018200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"d2t","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the actual files I want (they're tsvs) are all named the same thing and in sub directories with a batch number\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"❯ fd read ./\nbiobakery3/batch001/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch002/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch003/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch004/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch005/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch006/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch007/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch008/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch009/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch010/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch011/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch012/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch013/output/kneaddata/kneaddata_read_counts.txt\nbiobakery3/batch014/output/kneaddata/kneaddata_read_counts.txt"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"e8f8c689-c928-47cc-8cfd-b11881db2112","type":"message","text":"So I'm trying to make a post_fetch_method that takes all of those files and writes a new file, deleting the stuff that isn't necessary\n```\nfunction post_fetch_knead(deppath)\n    rm(joinpath(deppath, \"download\"), force=true)\n    tarball = joinpath(deppath, \"kneaddata_read_counts.tar.gz\")\n    run(tar -xzf $tarball)\n    allcounts = DataFrame()\n    for (root, dir, files) in walkdir(deppath)\n        length(files) == 1 || continue\n        counts = first(files)\n        counts == \"kneaddata_read_counts.txt\" || continue\n        batch = match(r\"biobakery3\\/batch(\\d{3})\\/output\", root).captures[1]\n        batch = parse(Int, batch)\n        df = CSV.read(joinpath(root, counts), DataFrame)\n        df[!, :batch] .= batch\n        append!(allcounts, df)\n    end\n    CSV.write(joinpath(deppath, \"allcounts.tsv\"), allcounts)\n    rm(joinpath(deppath, \"biobakery3\"), recursive=true, force=true)\nend```\n","user":"U8JP5B9T2","ts":"1610656422.018400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pnd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So I'm trying to make a post_fetch_method that takes all of those files and writes a new file, deleting the stuff that isn't necessary\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"\nfunction post_fetch_knead(deppath)\n    rm(joinpath(deppath, \"download\"), force=true)\n    tarball = joinpath(deppath, \"kneaddata_read_counts.tar.gz\")\n    run(tar -xzf $tarball)\n    allcounts = DataFrame()\n    for (root, dir, files) in walkdir(deppath)\n        length(files) == 1 || continue\n        counts = first(files)\n        counts == \"kneaddata_read_counts.txt\" || continue\n        batch = match(r\"biobakery3\\/batch(\\d{3})\\/output\", root).captures[1]\n        batch = parse(Int, batch)\n        df = CSV.read(joinpath(root, counts), DataFrame)\n        df[!, :batch] .= batch\n        append!(allcounts, df)\n    end\n    CSV.write(joinpath(deppath, \"allcounts.tsv\"), allcounts)\n    rm(joinpath(deppath, \"biobakery3\"), recursive=true, force=true)\nend"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2","reactions":[{"name":"eyes","users":["U6A936746"],"count":1}]},{"client_msg_id":"adb2e2dc-1a80-4588-ab37-4b53d7520536","type":"message","text":"That function runs when I run it manually with `post_fetch_knead(\"/home/kevin/.julia/datadeps/kneaddata_counts\")`","user":"U8JP5B9T2","ts":"1610656485.018600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"S6Z","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That function runs when I run it manually with "},{"type":"text","text":"post_fetch_knead(\"/home/kevin/.julia/datadeps/kneaddata_counts\")","style":{"code":true}}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"06f19462-b271-4a3d-8b66-9cc736bb644a","type":"message","text":"but when I add `post_fetch_method=post_fetch_knead` and try to register the datadep, I get\n\n``` Info: Downloading\n│   source = \"<https://osf.io/ugxjs/download>\"\n│   dest = \"/home/kevin/.julia/datadeps/kneaddata_counts/kneaddata_read_counts.tar.gz\"\n│   progress = 1.0\n│   time_taken = \"0.05 s\"\n│   time_remaining = \"0.0 s\"\n│   average_speed = \"974.008 KiB/s\"\n│   downloaded = \"50.648 KiB\"\n│   remaining = \"0 bytes\"\n└   total = \"50.648 KiB\"\n┌ Warning: Checksum not provided, add to the Datadep Registration the following hash line\n│   hash = \"ad75c18b4987147c1a282a662195e0b717140ee3aacbab7f412c4c8e15c0a1ad\"\n└ @ DataDeps ~/.julia/packages/DataDeps/jrlAW/src/verification.jl:44\nERROR: IOError: unlink(\"/home/kevin/.julia/datadeps/kneaddata_counts/kneaddata_read_counts.tar.gz/download\"): not a directory (ENOTDIR)\nStacktrace:\n  [1] uv_error\n    @ ./libuv.jl:97 [inlined]\n  [2] unlink(p::String)\n    @ Base.Filesystem ./file.jl:934\n  [3] rm(path::String; force::Bool, recursive::Bool)\n    @ Base.Filesystem ./file.jl:272\n  [4] post_fetch_knead(deppath::String)\n    @ Main ~/Repos/resonance_paper1/src/data.jl:2```","user":"U8JP5B9T2","ts":"1610656574.018900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"93T","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but when I add "},{"type":"text","text":"post_fetch_method=post_fetch_knead","style":{"code":true}},{"type":"text","text":" and try to register the datadep, I get\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":" Info: Downloading\n│   source = \""},{"type":"link","url":"https://osf.io/ugxjs/download"},{"type":"text","text":"\"\n│   dest = \"/home/kevin/.julia/datadeps/kneaddata_counts/kneaddata_read_counts.tar.gz\"\n│   progress = 1.0\n│   time_taken = \"0.05 s\"\n│   time_remaining = \"0.0 s\"\n│   average_speed = \"974.008 KiB/s\"\n│   downloaded = \"50.648 KiB\"\n│   remaining = \"0 bytes\"\n└   total = \"50.648 KiB\"\n┌ Warning: Checksum not provided, add to the Datadep Registration the following hash line\n│   hash = \"ad75c18b4987147c1a282a662195e0b717140ee3aacbab7f412c4c8e15c0a1ad\"\n└ @ DataDeps ~/.julia/packages/DataDeps/jrlAW/src/verification.jl:44\nERROR: IOError: unlink(\"/home/kevin/.julia/datadeps/kneaddata_counts/kneaddata_read_counts.tar.gz/download\"): not a directory (ENOTDIR)\nStacktrace:\n  [1] uv_error\n    @ ./libuv.jl:97 [inlined]\n  [2] unlink(p::String)\n    @ Base.Filesystem ./file.jl:934\n  [3] rm(path::String; force::Bool, recursive::Bool)\n    @ Base.Filesystem ./file.jl:272\n  [4] post_fetch_knead(deppath::String)\n    @ Main ~/Repos/resonance_paper1/src/data.jl:2"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"7ef8a7a4-a6d9-4b1b-9200-a51957bfa5f9","type":"message","text":"I am still looking at your code, and i don’t think this will fix iot, but rather than\n```run(`tar -xzf $tarball`)```\nI suggest `datadeps.unpack(tarball)`","user":"U6A936746","ts":"1610656724.019100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"sIxZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I am still looking at your code, and i don’t think this will fix iot, but rather than\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"run(`tar -xzf $tarball`)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"I suggest "},{"type":"text","text":"datadeps.unpack(tarball)","style":{"code":true}}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2","reactions":[{"name":"+1","users":["U8JP5B9T2"],"count":1}]},{"client_msg_id":"a40fde11-7bd3-4154-823d-3476be7bd70f","type":"message","text":"Also note that the post fetch method is run from the directory that the download was downloaded to&gt;\n<https://github.com/oxinabox/DataDeps.jl/blob/85f28c1a3e577c892a2fde6a40bab3f1ab6de451/src/resolution_automatic.jl#L119-L123>","user":"U6A936746","ts":"1610656796.019300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RXR","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Also note that the post fetch method is run from the directory that the download was downloaded to>\n"},{"type":"link","url":"https://github.com/oxinabox/DataDeps.jl/blob/85f28c1a3e577c892a2fde6a40bab3f1ab6de451/src/resolution_automatic.jl#L119-L123"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"d7463511-4248-4c3e-8ba6-a7df229428af","type":"message","text":"oh, so I can remove the `joinpath(deppath...` stuff?","user":"U8JP5B9T2","ts":"1610656858.019600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XmNC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh, so I can remove the "},{"type":"text","text":"joinpath(deppath...","style":{"code":true}},{"type":"text","text":" stuff?"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2","reactions":[{"name":"heavy_check_mark","users":["U6A936746"],"count":1}]},{"client_msg_id":"0a5ba8cd-ae4e-44d9-a47d-4bcbe8c34de8","type":"message","text":"Infact that stuff probably will give you the wrong path befause `post_fetch_method` takes a filename, not a directory path.\nI think that might be what is going wrong","user":"U6A936746","ts":"1610656897.019900","team":"T68168MUP","edited":{"user":"U6A936746","ts":"1610656916.000000"},"blocks":[{"type":"rich_text","block_id":"qeT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Infact that stuff probably will give you the wrong path befause "},{"type":"text","text":"post_fetch_method","style":{"code":true}},{"type":"text","text":" takes a filename, not a directory path.\nI think that might be what is going wrong"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"47fd0a08-2ce2-4d6d-9939-e2a8a27d6f4d","type":"message","text":"Oh. Hmm","user":"U8JP5B9T2","ts":"1610656954.020200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"egxgI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Oh. Hmm"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"6c389d1a-589b-410b-add3-35214df35bf0","type":"message","text":"so `dirname(deppath)`? The link I'm providing downloads 2 (it's following redirects or something)","user":"U8JP5B9T2","ts":"1610657016.020400","team":"T68168MUP","edited":{"user":"U8JP5B9T2","ts":"1610657017.000000"},"blocks":[{"type":"rich_text","block_id":"YEmHE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so "},{"type":"text","text":"dirname(deppath)","style":{"code":true}},{"type":"text","text":"? The link I'm providing downloads 2 (it's following redirects or something)"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"cbdc132f-5e56-4e33-99dc-527cac78618b","type":"message","text":"downloads 2 files? Is that possible?","user":"U6A936746","ts":"1610657039.020700","team":"T68168MUP","edited":{"user":"U6A936746","ts":"1610657063.000000"},"blocks":[{"type":"rich_text","block_id":"jKMgr","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"downloads 2 files? Is that possible?"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"55e70604-950a-4f77-ade6-a7b584a6eb56","type":"message","text":"yeah\n\n```❯ ls -l kneaddata_counts\n.rw-rw-r-- kevin kevin  459 B  Thu Jan 14 15:30:32 2021  download\n.rw-rw-r-- kevin kevin 50.6 KB Thu Jan 14 15:30:33 2021  kneaddata_read_counts.tar.gz```","user":"U8JP5B9T2","ts":"1610657089.021100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VZMna","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"❯ ls -l kneaddata_counts\n.rw-rw-r-- kevin kevin  459 B  Thu Jan 14 15:30:32 2021  download\n.rw-rw-r-- kevin kevin 50.6 KB Thu Jan 14 15:30:33 2021  kneaddata_read_counts.tar.gz"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"637f3ecb-449a-455a-bb87-f7dfaf843741","type":"message","text":"I can't figure out how to get the direct link to the file","user":"U8JP5B9T2","ts":"1610657131.021300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FAJ6h","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I can't figure out how to get the direct link to the file"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"8e82819d-2b25-47a6-8cf9-98c11bf6025d","type":"message","text":"Let me play with this for a bit","user":"U6A936746","ts":"1610657144.021500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6muHA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Let me play with this for a bit"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"0eea129a-c6d9-4a5f-a501-38f1e8cb85d4","type":"message","text":"this might be more useful:<https://api.osf.io/v2/files/60009f13e80d370597a58beb/>","user":"U8JP5B9T2","ts":"1610657301.021700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7j0DJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"this might be more useful:"},{"type":"link","url":"https://api.osf.io/v2/files/60009f13e80d370597a58beb/"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"4b4974b6-8cb1-4c18-9982-8a8d51979df9","type":"message","text":"This is really weird.\nI did not know HTTP allows downloading 2 files from 1 URL.\nBut it clearly and demostratably does","user":"U6A936746","ts":"1610657351.021900","team":"T68168MUP","edited":{"user":"U6A936746","ts":"1610657358.000000"},"blocks":[{"type":"rich_text","block_id":"4TI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This is really weird.\nI did not know HTTP allows downloading 2 files from 1 URL.\nBut it clearly and demostratably does"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"5757558c-7125-4385-811b-5d6a0602f53f","type":"message","text":"from the api documentation:\n\n&gt; Download (files)\n&gt; To download a file, issue a GET request against the download link. The response will have the Content-Disposition header set, which will will trigger a download in a browser.","user":"U8JP5B9T2","ts":"1610657513.022200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+YZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"from the api documentation:\n\n"}]},{"type":"rich_text_quote","elements":[{"type":"text","text":"Download (files)\nTo download a file, issue a GET request against the download link. The response will have the Content-Disposition header set, which will will trigger a download in a browser."}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"6e078df6-070f-498c-96ba-668a070d0d25","type":"message","text":"I am wondering if this is hitting some edge case in HTTP.jl’s download method","user":"U6A936746","ts":"1610657557.022400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DBi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I am wondering if this is hitting some edge case in HTTP.jl’s download method"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"70ea8c3c-0830-477b-9ae2-f2645920b7be","type":"message","text":"It *shouldn’t* download anything during a redirect, but maybe it does","user":"U6A936746","ts":"1610657582.022600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YY+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It "},{"type":"text","text":"shouldn’t ","style":{"bold":true}},{"type":"text","text":"download anything during a redirect, but maybe it does"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"24657889-2982-4683-b37d-b8651c6bcbcf","type":"message","text":"You can swap to the fallback download mechanism by setting:\n```fetch_method=DataDeps.fetch_base```\nIf you do that you will only get one file (tested)\nits name will be kind of nonsense, but it will be your gzipped-tarball  and you can open it with `unpack`\nand then you can walk around `pwd`","user":"U6A936746","ts":"1610657847.022800","team":"T68168MUP","edited":{"user":"U6A936746","ts":"1610657857.000000"},"blocks":[{"type":"rich_text","block_id":"oTJUP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"You can swap to the fallback download mechanism by setting:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"fetch_method=DataDeps.fetch_base"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"If you do that you will only get one file (tested)\nits name will be kind of nonsense, but it will be your gzipped-tarball  and you can open it with "},{"type":"text","text":"unpack","style":{"code":true}},{"type":"text","text":"\nand then you can walk around "},{"type":"text","text":"pwd","style":{"code":true}}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"303aeb21-7a47-4c60-bacf-6a26e13d47c8","type":"message","text":"Hmm no i don’t think that is the problem\nI think `download`  might be inside the tarball?\nNo, idk idk where is that coming from","user":"U6A936746","ts":"1610658258.023100","team":"T68168MUP","edited":{"user":"U6A936746","ts":"1610658318.000000"},"blocks":[{"type":"rich_text","block_id":"Erv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm no i don’t think that is the problem\nI think "},{"type":"text","text":"download","style":{"code":true}},{"type":"text","text":"  might be inside the tarball?\nNo, idk idk where is that coming from"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"81e73d7f-9141-4ba0-bde5-bb4a8fe0554c","type":"message","text":"The following code does what you want\n\n```using DataDeps, DataFrames, CSV\n\n\nfunction post_fetch_knead(tarball)\n    unpack(tarball)\n    allcounts = DataFrame()\n    for (root, dir, files) in walkdir(pwd())\n        length(files) == 1 || continue\n        counts = first(files)\n        counts == \"kneaddata_read_counts.txt\" || continue\n        batch = match(r\"biobakery3\\/batch(\\d{3})\\/output\", root).captures[1]\n        batch = parse(Int, batch)\n        df = CSV.read(joinpath(root, counts), DataFrame)\n        df[!, :batch] .= batch\n        append!(allcounts, df)\n    end\n    CSV.write(\"allcounts.tsv\", allcounts)\n    rm(\"biobakery3\", recursive=true, force=true)\n    rm(\"download\", force=true)  # we don't know where this file comes from but we want it gone\nend\n\n\nregister(DataDep(\n   \"kneaddata_counts4\",\n   \"\"\"\n   Diagnostic information about sequence reads after cleaning with KneadData.\n   \"\"\",\n   \"<https://osf.io/ugxjs/download>\";\n   post_fetch_method = post_fetch_knead,\n))\n\nreaddir(datadep\"kneaddata_counts4\")```","user":"U6A936746","ts":"1610658389.023500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"j3HEg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The following code does what you want\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using DataDeps, DataFrames, CSV\n\n\nfunction post_fetch_knead(tarball)\n    unpack(tarball)\n    allcounts = DataFrame()\n    for (root, dir, files) in walkdir(pwd())\n        length(files) == 1 || continue\n        counts = first(files)\n        counts == \"kneaddata_read_counts.txt\" || continue\n        batch = match(r\"biobakery3\\/batch(\\d{3})\\/output\", root).captures[1]\n        batch = parse(Int, batch)\n        df = CSV.read(joinpath(root, counts), DataFrame)\n        df[!, :batch] .= batch\n        append!(allcounts, df)\n    end\n    CSV.write(\"allcounts.tsv\", allcounts)\n    rm(\"biobakery3\", recursive=true, force=true)\n    rm(\"download\", force=true)  # we don't know where this file comes from but we want it gone\nend\n\n\nregister(DataDep(\n   \"kneaddata_counts4\",\n   \"\"\"\n   Diagnostic information about sequence reads after cleaning with KneadData.\n   \"\"\",\n   \""},{"type":"link","url":"https://osf.io/ugxjs/download"},{"type":"text","text":"\";\n   post_fetch_method = post_fetch_knead,\n))\n\nreaddir(datadep\"kneaddata_counts4\")"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"0ddbe223-5776-47bc-9629-ed7953251f4c","type":"message","text":"I was able to use the first idea too with\n\n```function post_fetch_knead(deppath)\n    DataDeps.unpack(deppath)\n    allcounts = DataFrame()\n    for (root, dir, files) in walkdir(pwd())\n        @info root\n        length(files) == 1 || continue\n        counts = first(files)\n        counts == \"kneaddata_read_counts.txt\" || continue\n        batch = match(r\"biobakery3\\/batch(\\d{3})\\/output\", root).captures[1]\n        batch = parse(Int, batch)\n        df = CSV.read(joinpath(root, counts), DataFrame)\n        df[!, :batch] .= batch\n        append!(allcounts, df)\n    end\n    CSV.write(\"allcounts.tsv\", allcounts)\n    rm(\"biobakery3\", recursive=true, force=true)\nend\n\nregister(DataDep(\n   \"kneaddata_counts\",\n   \"\"\"\n   Diagnostic information about sequence reads after cleaning with KneadData.\n   \"\"\",\n   \"<https://osf.io/ugxjs/download>\",\n   fetch_method=DataDeps.fetch_base,\n   post_fetch_method=post_fetch_knead\n   )\n)```\n","user":"U8JP5B9T2","ts":"1610658463.023700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4Ius","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I was able to use the first idea too with\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function post_fetch_knead(deppath)\n    DataDeps.unpack(deppath)\n    allcounts = DataFrame()\n    for (root, dir, files) in walkdir(pwd())\n        @info root\n        length(files) == 1 || continue\n        counts = first(files)\n        counts == \"kneaddata_read_counts.txt\" || continue\n        batch = match(r\"biobakery3\\/batch(\\d{3})\\/output\", root).captures[1]\n        batch = parse(Int, batch)\n        df = CSV.read(joinpath(root, counts), DataFrame)\n        df[!, :batch] .= batch\n        append!(allcounts, df)\n    end\n    CSV.write(\"allcounts.tsv\", allcounts)\n    rm(\"biobakery3\", recursive=true, force=true)\nend\n\nregister(DataDep(\n   \"kneaddata_counts\",\n   \"\"\"\n   Diagnostic information about sequence reads after cleaning with KneadData.\n   \"\"\",\n   \""},{"type":"link","url":"https://osf.io/ugxjs/download"},{"type":"text","text":"\",\n   fetch_method=DataDeps.fetch_base,\n   post_fetch_method=post_fetch_knead\n   )\n)"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"fdd809f9-b78d-43d3-a414-d14554e3fc37","type":"message","text":"I think that is the same code?","user":"U6A936746","ts":"1610658505.023900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"k49z","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think that is the same code?"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"e3eda0bb-2321-4b03-852b-0fb682ef9c0c","type":"message","text":"wait, no... thetsv file is empty","user":"U8JP5B9T2","ts":"1610658507.024100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"A3oC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"wait, no... thetsv file is empty"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"0a90a88a-5672-4be3-8562-e955c3fc10b3","type":"message","text":"that's some other problem...","user":"U8JP5B9T2","ts":"1610658540.024300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vFBb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that's some other problem..."}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"7f6ac8ff-59e7-453d-918e-c61523a54bdf","type":"message","text":"the TSV i ended up with isn’t empty","user":"U6A936746","ts":"1610658556.024500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"deIPq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the TSV i ended up with isn’t empty"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"96e1e327-74e7-4184-adba-db433c0433b0","type":"message","text":"ok, well I can work with this now I understand the pieces, thanks!","user":"U8JP5B9T2","ts":"1610658557.024700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"w8E6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ok, well I can work with this now I understand the pieces, thanks!"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"0dcc73bb-1558-4367-aeb3-51aafc84e0ff","type":"message","text":"I think being in the right directy makes the code cleaner, right?\nNo joinpath etc.","user":"U6A936746","ts":"1610658581.024900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5gM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think being in the right directy makes the code cleaner, right?\nNo joinpath etc."}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"e1100fa3-346a-417f-811a-f4620a49e109","type":"message","text":"Once I wrap my head around it, yeah","user":"U8JP5B9T2","ts":"1610658711.025100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"bnAg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Once I wrap my head around it, yeah"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"a5818f23-8f35-44b0-8f0d-a476116d2d96","type":"message","text":"Success!\n\n```julia&gt; CSV.read(first(readdir(datadep\"kneaddata_counts\", join=true)), DataFrame)\n1223×1 DataFrame\n  Row │ Sample,raw pair1,raw pair2,trimmed pair1,trimmed pair2,trimmed orphan1,trimmed orphan2,decontaminated Homo_sapiens pair1,decontaminated Homo_sapiens pair2,decontaminated Homo_sapiens orphan1,decontaminated Homo_sapiens orphan2,final pair1,final pair2,final orphan1,final orphan2,batch \n      │ String                                                                                                                                                                                                                                                                                       \n──────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n    1 │ C0043-7F-1A_S14_kneaddata,2251199,2251199,1750080,1750080,113547,44939,1749443,1749443,113773,44897,1749443,1749443,113773,44897,1\n    2 │ C0052-5F-1A_S49_kneaddata,4828079,4828079,3792074,3792074,267291,98178,3791003,3791003,267730,98093,3791003,3791003,267730,98093,1\n    3 │ C0053-6F-1A_S61_kneaddata,4539474,4539474,3555835,3555835,275061,93310,3550776,3550776,275226,93137,3550776,3550776,275226,93137,1```","user":"U8JP5B9T2","ts":"1610658730.025300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qoRr","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Success!\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> CSV.read(first(readdir(datadep\"kneaddata_counts\", join=true)), DataFrame)\n1223×1 DataFrame\n  Row │ Sample,raw pair1,raw pair2,trimmed pair1,trimmed pair2,trimmed orphan1,trimmed orphan2,decontaminated Homo_sapiens pair1,decontaminated Homo_sapiens pair2,decontaminated Homo_sapiens orphan1,decontaminated Homo_sapiens orphan2,final pair1,final pair2,final orphan1,final orphan2,batch \n      │ String                                                                                                                                                                                                                                                                                       \n──────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n    1 │ C0043-7F-1A_S14_kneaddata,2251199,2251199,1750080,1750080,113547,44939,1749443,1749443,113773,44897,1749443,1749443,113773,44897,1\n    2 │ C0052-5F-1A_S49_kneaddata,4828079,4828079,3792074,3792074,267291,98178,3791003,3791003,267730,98093,3791003,3791003,267730,98093,1\n    3 │ C0053-6F-1A_S61_kneaddata,4539474,4539474,3555835,3555835,275061,93310,3550776,3550776,275226,93137,3550776,3550776,275226,93137,1"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"4f252a90-b20b-4597-a466-9fc72bb1619c","type":"message","text":"is there a way to make the registration return `first(readdir(datadep\"kneaddata_counts\", join=true))` (that is, the path to the file that's generated)?","user":"U8JP5B9T2","ts":"1610658833.025500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"HitI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"is there a way to make the registration return "},{"type":"text","text":"first(readdir(datadep\"kneaddata_counts\", join=true))","style":{"code":true}},{"type":"text","text":" (that is, the path to the file that's generated)?"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"7a85c8b9-dd5d-473b-b60f-6c65c918ea47","type":"message","text":"so that `datadep\"kneaddata_counts\"` points straight to the file?","user":"U8JP5B9T2","ts":"1610658863.025700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ykQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so that "},{"type":"text","text":"datadep\"kneaddata_counts\"","style":{"code":true}},{"type":"text","text":" points straight to the file?"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"ba77f4fa-7b25-405d-abe0-9c56a029130b","type":"message","text":"Well, whatever, this is a huge step up","user":"U8JP5B9T2","ts":"1610659010.025900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"mDlG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Well, whatever, this is a huge step up"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"},{"client_msg_id":"a1213f0f-253f-45e1-8784-d05c86012139","type":"message","text":"Thanks for your help!","user":"U8JP5B9T2","ts":"1610659356.026100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"E+GDa","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks for your help!"}]}]}],"thread_ts":"1610656132.017700","parent_user_id":"U8JP5B9T2"}]