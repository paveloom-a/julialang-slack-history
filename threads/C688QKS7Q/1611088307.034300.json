[{"client_msg_id":"3b21c4c5-cfc5-49ab-8c81-25d7802158ad","type":"message","text":"I’m working on embedding Julia in a rust program right now.  Can someone explain why `JULIA_DEFINE_FAST_TLS()` is necessary in Linux?","user":"U69KQT9DL","ts":"1611088307.034300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"afO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I’m working on embedding Julia in a rust program right now.  Can someone explain why "},{"type":"text","text":"JULIA_DEFINE_FAST_TLS()","style":{"code":true}},{"type":"text","text":" is necessary in Linux?"}]}]}],"thread_ts":"1611088307.034300","reply_count":20,"reply_users_count":3,"latest_reply":"1611165010.062700","reply_users":["U66GD0880","U69KQT9DL","U67BXBF99"],"subscribed":false,"reactions":[{"name":"rust","users":["UDB26738Q","U680THK2S","UKG4WF8PJ"],"count":3}]},{"client_msg_id":"7a456fc4-c654-4d85-a8cb-ce3b9e25b6b2","type":"message","text":"what version of Julia are you embedding?","user":"U66GD0880","ts":"1611089181.034600","team":"T68168MUP","edited":{"user":"U66GD0880","ts":"1611089185.000000"},"blocks":[{"type":"rich_text","block_id":"4mfd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"what version of Julia are you embedding?"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"f08d60b0-121b-4a77-960b-64ffb11363a4","type":"message","text":"I don’t think `JULIA_DEFINE_FAST_TLS` actually does anything on v1.6+, <@U67BXBF99> correct me if I’m wrong","user":"U66GD0880","ts":"1611089205.034900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+J3t","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I don’t think "},{"type":"text","text":"JULIA_DEFINE_FAST_TLS","style":{"code":true}},{"type":"text","text":" actually does anything on v1.6+, "},{"type":"user","user_id":"U67BXBF99"},{"type":"text","text":" correct me if I’m wrong"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"96d0deb2-4145-4a4d-8474-e85cd489c749","type":"message","text":"On v1.5 it’s because in order to get the fastest TLS storage/lookups, we need the symbols to actually be defined in the executable itself, not in the `libjulia` library.  I don’t know the deep reasons behind it; I believe it’s a linker limitation.","user":"U66GD0880","ts":"1611089275.035100","team":"T68168MUP","edited":{"user":"U66GD0880","ts":"1611089280.000000"},"blocks":[{"type":"rich_text","block_id":"=JGT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"On v1.5 it’s because in order to get the fastest TLS storage/lookups, we need the symbols to actually be defined in the executable itself, not in the "},{"type":"text","text":"libjulia","style":{"code":true}},{"type":"text","text":" library.  I don’t know the deep reasons behind it; I believe it’s a linker limitation."}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"f90a9776-955a-4140-b933-6c346043b2ad","type":"message","text":"Thanks!  Using 1.5 for now, so we don’t have to link against libjulia-internal, but will probably change to 1.6 soon.","user":"U69KQT9DL","ts":"1611089362.035400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"BRw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks!  Using 1.5 for now, so we don’t have to link against libjulia-internal, but will probably change to 1.6 soon."}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"1b69a87b-4d24-410b-93d3-55e9d9bfb88f","type":"message","text":"for the record, embedding use cases should mostly remain the same, where you just continue to link against `libjulia`.","user":"U66GD0880","ts":"1611089403.035600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5S=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"for the record, embedding use cases should mostly remain the same, where you just continue to link against "},{"type":"text","text":"libjulia","style":{"code":true}},{"type":"text","text":"."}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"a90ef550-559a-43fd-81ef-0e5d7ee0a89d","type":"message","text":"Hmmm, maybe I’m wrong; maybe we did get `JULIA_DEFINE_FAST_TLS()` working on 1.6 again, and it’s the same for v1.5 and v1.6.  I’ll wait for Jameson to weigh in.","user":"U66GD0880","ts":"1611089468.035800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"k5P","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmmm, maybe I’m wrong; maybe we did get "},{"type":"text","text":"JULIA_DEFINE_FAST_TLS()","style":{"code":true}},{"type":"text","text":" working on 1.6 again, and it’s the same for v1.5 and v1.6.  I’ll wait for Jameson to weigh in."}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"2ff51c4d-4206-479d-8559-d96bfe2566e6","type":"message","text":"I thought we removed it, since cli.c couldn’t parse it","user":"U67BXBF99","ts":"1611091843.037300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5+4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I thought we removed it, since cli.c couldn’t parse it"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"632fd595-5386-4eb5-8e1c-980fc64f177a","type":"message","text":"I thought so as well, but it’s still here: <https://github.com/JuliaLang/julia/blob/master/src/julia.h#L2094-L2105>","user":"U66GD0880","ts":"1611098530.038500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Z4CvO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I thought so as well, but it’s still here: "},{"type":"link","url":"https://github.com/JuliaLang/julia/blob/master/src/julia.h#L2094-L2105"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"d83fbbf9-e0ed-4abd-8d7c-fd815b117fe1","type":"message","text":"and it’s still used here: <https://github.com/JuliaLang/julia/blob/master/test/embedding/embedding.c#L7>","user":"U66GD0880","ts":"1611098587.038700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gEbY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and it’s still used here: "},{"type":"link","url":"https://github.com/JuliaLang/julia/blob/master/test/embedding/embedding.c#L7"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"5eae2a69-ebf1-4283-bc57-acd38ec7c2ee","type":"message","text":"okay, `loader_exe.c` just manually copy-pastes it: <https://github.com/JuliaLang/julia/blob/master/cli/loader_exe.c#L16-L22>","user":"U66GD0880","ts":"1611098621.038900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3KcDv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"okay, "},{"type":"text","text":"loader_exe.c","style":{"code":true}},{"type":"text","text":" just manually copy-pastes it: "},{"type":"link","url":"https://github.com/JuliaLang/julia/blob/master/cli/loader_exe.c#L16-L22"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"0f95e5c4-830b-47e8-a033-aa8c9d364158","type":"message","text":"because we can’t `#include &lt;julia.h&gt;` due to lack of libc","user":"U66GD0880","ts":"1611098627.039100","team":"T68168MUP","edited":{"user":"U66GD0880","ts":"1611098644.000000"},"blocks":[{"type":"rich_text","block_id":"pCU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"because we can’t "},{"type":"text","text":"#include <julia.h>","style":{"code":true}},{"type":"text","text":" due to lack of libc"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"c6624ed6-fe43-4726-b78d-115d24213c4a","type":"message","text":"Then `loader_lib.c` dynamically connects the TLS getter in `libjulia-internal` to the TLS storage defined in `loader_exe.c`: <https://github.com/JuliaLang/julia/blob/master/cli/loader_lib.c#L180-L190>","user":"U66GD0880","ts":"1611098730.039400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GAaJ0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Then "},{"type":"text","text":"loader_lib.c","style":{"code":true}},{"type":"text","text":" dynamically connects the TLS getter in "},{"type":"text","text":"libjulia-internal","style":{"code":true}},{"type":"text","text":" to the TLS storage defined in "},{"type":"text","text":"loader_exe.c","style":{"code":true}},{"type":"text","text":": "},{"type":"link","url":"https://github.com/JuliaLang/julia/blob/master/cli/loader_lib.c#L180-L190"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"86f25863-2667-4675-aa59-376fad8b1bba","type":"message","text":"I guess technically we’re connecting it twice if a user uses `JULIA_DEFINE_FAST_TLS()` (once in the main executable, due to the `__attribute__((constructor))` and once due to `loader_lib.c`, linked above)","user":"U66GD0880","ts":"1611098786.039600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fKmK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I guess technically we’re connecting it twice if a user uses "},{"type":"text","text":"JULIA_DEFINE_FAST_TLS()","style":{"code":true}},{"type":"text","text":" (once in the main executable, due to the "},{"type":"text","text":"__attribute__((constructor))","style":{"code":true}},{"type":"text","text":" and once due to "},{"type":"text","text":"loader_lib.c","style":{"code":true}},{"type":"text","text":", linked above)"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"667f3e29-d433-4fd6-8d64-bc9db28db2f6","type":"message","text":"but that’s fine","user":"U66GD0880","ts":"1611098788.039800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"HRu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but that’s fine"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"e2bc26cb-b9ae-4731-a8ae-0d642ada34d5","type":"message","text":"Going back to and clarifying the original question:  is defining this useful/necessary if my app does not directly use any TLS/SSL functionality?\n\nMy first reaction was “no”, but I’m second guessing that reaction because it seems necessary for starting the repl on linux/BSD.  :confused:","user":"U69KQT9DL","ts":"1611103274.040700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ENv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Going back to and clarifying the original question:  is defining this useful/necessary if my app does not directly use any TLS/SSL functionality?\n\nMy first reaction was “no”, but I’m second guessing that reaction because it seems necessary for starting the repl on linux/BSD.  "},{"type":"emoji","name":"confused"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"b4b2f59a-ee40-4a01-a204-8715135682ad","type":"message","text":"this is thread, not sockets","user":"U67BXBF99","ts":"1611119944.048600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Fjf","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"this is thread, not sockets"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"4e9aca70-f158-45f8-a4a1-678212ebaf08","type":"message","text":"and no, you don’t need it","user":"U67BXBF99","ts":"1611119953.048800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jN9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and no, you don’t need it"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"e1f59dd2-f596-4cb4-936d-3aa754900e2f","type":"message","text":"and putting it in a `.so` would actually be slower, so don’t do that","user":"U67BXBF99","ts":"1611119977.049000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"trp=C","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and putting it in a "},{"type":"text","text":".so","style":{"code":true}},{"type":"text","text":" would actually be slower, so don’t do that"}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"D7EF22FB-FFE3-4CBA-9590-9BDB19CB56E7","type":"message","text":"Okay thanks. I wasn’t planning to put it in the `.so`, just wondering if I needed it in the main rust program. ","user":"U69KQT9DL","ts":"1611150610.051300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"lNy","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Okay thanks. I wasn’t planning to put it in the "},{"type":"text","text":".so","style":{"code":true}},{"type":"text","text":", just wondering if I needed it in the main rust program. "}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL"},{"client_msg_id":"9b626747-9608-4e51-8306-86170796f213","type":"message","text":"And from Jameson’s comment, I finally understand that TLS here is “thread-local state” (or storage?)\n and not “Transport Layer Security”.","user":"U69KQT9DL","ts":"1611165010.062700","team":"T68168MUP","edited":{"user":"U69KQT9DL","ts":"1611165073.000000"},"blocks":[{"type":"rich_text","block_id":"MyqIN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"And from Jameson’s comment, I finally understand that TLS here is “thread-local state” (or storage?)\n and not “Transport Layer Security”."}]}]}],"thread_ts":"1611088307.034300","parent_user_id":"U69KQT9DL","reactions":[{"name":"correct_answer","users":["U66GD0880","UKG4WF8PJ"],"count":2}]}]