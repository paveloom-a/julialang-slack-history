[{"client_msg_id":"fa32bb49-12e5-4ea1-adb1-96bd0fda928d","type":"message","text":"Quasi-static implies (/requires) inference.","user":"U69BL50BF","ts":"1616170054.024100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"JeBY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Quasi-static implies (/requires) inference."}]}]}],"thread_ts":"1616170054.024100","reply_count":37,"reply_users_count":2,"latest_reply":"1616178202.031900","reply_users":["U66N673NV","U69BL50BF"],"subscribed":false},{"type":"message","subtype":"thread_broadcast","text":"So yes, the options are to either fall back to a super slow version or error out, correct? What does MTK do?","user":"U66N673NV","ts":"1616170243.024200","thread_ts":"1616170054.024100","root":{"client_msg_id":"fa32bb49-12e5-4ea1-adb1-96bd0fda928d","type":"message","text":"Quasi-static implies (/requires) inference.","user":"U69BL50BF","ts":"1616170054.024100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"JeBY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Quasi-static implies (/requires) inference."}]}]}],"thread_ts":"1616170054.024100","reply_count":37,"reply_users_count":2,"latest_reply":"1616178202.031900","reply_users":["U66N673NV","U69BL50BF"],"subscribed":false},"blocks":[{"type":"rich_text","block_id":"Eds","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So yes, the options are to either fall back to a super slow version or error out, correct? What does MTK do?"}]}]}],"client_msg_id":"b1ba2b9f-92d6-4039-9143-b6fd8890866f"},{"client_msg_id":"51f15a4e-3952-4aee-8a75-3bfc83d8e87d","type":"message","text":"Somewhat \"error out\", but that misses the fact that you don't need inference to do abstract tracing, and the code it generates will be inferred.","user":"U69BL50BF","ts":"1616170298.024500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0+ep=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Somewhat \"error out\", but that misses the fact that you don't need inference to do abstract tracing, and the code it generates will be inferred."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"bce8739d-885c-481b-bd4d-6e125f2dbd5b","type":"message","text":"I guess linear algebra is a nice counter example of where inference can fail (because of `\\` returns) but where MTK can trace and do codegen to generate an inferable program.","user":"U69BL50BF","ts":"1616170333.024700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"eOP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I guess linear algebra is a nice counter example of where inference can fail (because of "},{"type":"text","text":"\\","style":{"code":true}},{"type":"text","text":" returns) but where MTK can trace and do codegen to generate an inferable program."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"aaed526f-e007-47e4-8c74-0424fd658207","type":"message","text":"But generating code that does a fast path for linear and quadratic expressions needs inference, abstract tracing isn't sufficient","user":"U66N673NV","ts":"1616170435.024900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"a4q=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But generating code that does a fast path for linear and quadratic expressions needs inference, abstract tracing isn't sufficient"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"f0b9f9cb-5288-4616-b620-dbd24694b1fe","type":"message","text":"If you symbolically know exactly the linear and quadratic expressions, what is a code you cannot create for it?","user":"U69BL50BF","ts":"1616170473.025100","team":"T68168MUP","edited":{"user":"U69BL50BF","ts":"1616170476.000000"},"blocks":[{"type":"rich_text","block_id":"byIi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If you symbolically know exactly the linear and quadratic expressions, what is a code you cannot create for it?"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"1a7dd792-1b08-40e0-bafd-c66ce62d5866","type":"message","text":"sum(a[i] * b[i] * c[i] for i in 1:10000000)","user":"U66N673NV","ts":"1616170613.025400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DQlN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"sum(a[i] * b[i] * c[i] for i in 1:10000000)"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"af67e52f-7c4d-44fd-bc2d-9951305f7be0","type":"message","text":"That's linear or quadratic if one of the terms is a number.","user":"U66N673NV","ts":"1616170637.025600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"c0u4m","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That's linear or quadratic if one of the terms is a number."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"4422a749-0a50-4f12-9339-15236f81c5ca","type":"message","text":"how is that a counter example? That's precisely one of the cases it handles, current via scalarization but Shashi is working on the array symbolics to not expand it?","user":"U69BL50BF","ts":"1616170697.025800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"s7yNU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"how is that a counter example? That's precisely one of the cases it handles, current via scalarization but Shashi is working on the array symbolics to not expand it?"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"07efd0ba-8684-4eb5-83fc-c4204ed69e72","type":"message","text":"What do you do if you can't infer the element types of the arrays?","user":"U66N673NV","ts":"1616170738.026000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TUJUt","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What do you do if you can't infer the element types of the arrays?"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"82c6090a-7c64-4367-89ee-c767e5472b25","type":"message","text":"if that's your function then you infer it","user":"U69BL50BF","ts":"1616170788.026200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/TA//","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if that's your function then you infer it"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"ea2b0bb0-3eb4-4f0e-b014-95274b68258b","type":"message","text":"can you give a full example?","user":"U69BL50BF","ts":"1616170799.026400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7No3c","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"can you give a full example?"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"d01317c4-5afb-42dd-be5a-996973f5c942","type":"message","text":"MTK generates code that's dependent on the inputs.","user":"U69BL50BF","ts":"1616170837.026600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Or8vo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"MTK generates code that's dependent on the inputs."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"04b12827-7ec9-4908-bda5-969cec999fc3","type":"message","text":"`a = [type_unstable_function(i) for i in 1:10000000];@variable(m, b[1:10000000]); @variable(m, c[1:10000000]); @constraint(m, sum(a[i] * b[i] * c[i] for i in 1:10000000) &lt;= 1)`","user":"U66N673NV","ts":"1616171304.026800","team":"T68168MUP","edited":{"user":"U66N673NV","ts":"1616171317.000000"},"blocks":[{"type":"rich_text","block_id":"Oqa","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"a = [type_unstable_function(i) for i in 1:10000000];@variable(m, b[1:10000000]); @variable(m, c[1:10000000]); @constraint(m, sum(a[i] * b[i] * c[i] for i in 1:10000000) <= 1)","style":{"code":true}}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"9ce152f2-5a11-4144-892b-b51d8aa497e0","type":"message","text":"the only issue there is that scalar tracing runs out of memory in that case.","user":"U69BL50BF","ts":"1616171795.027100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0d9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the only issue there is that scalar tracing runs out of memory in that case."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"40dcbe30-746f-438e-be96-e70e71fa4ea0","type":"message","text":"And so yes, you'd need array symbolics and an abstract interpreter to run inference.","user":"U69BL50BF","ts":"1616171808.027300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MRFc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"And so yes, you'd need array symbolics and an abstract interpreter to run inference."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"6284dde8-90ac-4139-b21e-4f0fbe2faed8","type":"message","text":"So what's the best we can do for that code example?","user":"U66N673NV","ts":"1616175698.027500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FXgxV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So what's the best we can do for that code example?"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"e2896424-2457-440b-999e-12a85cb68d6d","type":"message","text":"oh that's much less memory than I thought. Yeah, you can just trace through it","user":"U69BL50BF","ts":"1616176110.027700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oFyUW","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh that's much less memory than I thought. Yeah, you can just trace through it"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"f2737ba2-a5a5-4a25-8e4f-76f85d57e89b","type":"message","text":"```using ModelingToolkit\n@variables a[1:10000000] b[1:1000000]\ntype_unstable_function(i) = rand()&lt;0.5 ? 1 : 1.0\nc = [type_unstable_function(i) for i in 1:10000000]\nobj = sum(a[i] * b[i] * c[i] for i in 1:10000000)```","user":"U69BL50BF","ts":"1616176116.027900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"h94","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using ModelingToolkit\n@variables a[1:10000000] b[1:1000000]\ntype_unstable_function(i) = rand()<0.5 ? 1 : 1.0\nc = [type_unstable_function(i) for i in 1:10000000]\nobj = sum(a[i] * b[i] * c[i] for i in 1:10000000)"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"b8bfd1c4-8c80-4760-8d48-e63e0d0a8da4","type":"message","text":"It would be better handled by array symbolics in terms of generation time, but SoA will work on it.","user":"U69BL50BF","ts":"1616176148.028100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4tk4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It would be better handled by array symbolics in terms of generation time, but SoA will work on it."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"f7159ad4-0e49-4f17-b20c-40a0173b033b","type":"message","text":"I'm guessing that tracing through it would be much slower than what jump does now, but would be curious to see a comparison","user":"U66N673NV","ts":"1616176753.028300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1zNk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm guessing that tracing through it would be much slower than what jump does now, but would be curious to see a comparison"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"f9674bb0-f66c-431c-b1ec-403c3a5a0b8b","type":"message","text":"does tracing through it mean a GC-tracked object for every scalar operation?","user":"U66N673NV","ts":"1616176787.028500","team":"T68168MUP","edited":{"user":"U66N673NV","ts":"1616176799.000000"},"blocks":[{"type":"rich_text","block_id":"H8O","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"does tracing through it mean a GC-tracked object for every scalar operation?"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"c18d5102-d1ad-4ae2-aa80-ccdbc2204b20","type":"message","text":"It's much much slower with the type instability. For this kind of problem I would just say to wait for array symbolics.\n\n&gt; does tracing through it mean a GC-tracked object for every scalar expression?\nFor every expression, yes. Not for every symbol though. And only in the codegen phase: compilers are always dynamic though.","user":"U69BL50BF","ts":"1616176823.028800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6rTM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It's much much slower with the type instability. For this kind of problem I would just say to wait for array symbolics.\n\n"}]},{"type":"rich_text_quote","elements":[{"type":"text","text":"does tracing through it mean a GC-tracked object for every scalar expression?"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"For every expression, yes. Not for every symbol though. And only in the codegen phase: compilers are always dynamic though."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"11f18ee8-ade7-4ddc-9ae4-b7bbe5088701","type":"message","text":"Indeed most of this is optimized for big nonlinear expressions right now, except for what Shashi's working on","user":"U69BL50BF","ts":"1616176841.029000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"h/m9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Indeed most of this is optimized for big nonlinear expressions right now, except for what Shashi's working on"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"f6b126b0-e400-4ea2-8d4d-0a23d0964add","type":"message","text":"I mean, are there 10,000,000 GC-tracked objects due to the loop?","user":"U66N673NV","ts":"1616176916.029200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"CDnFi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I mean, are there 10,000,000 GC-tracked objects due to the loop?"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"8c9dacb3-0b9a-49a8-a926-503bed84845a","type":"message","text":"In the current form, yes.","user":"U69BL50BF","ts":"1616176933.029400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PPtVs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"In the current form, yes."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"5958bc5d-32a0-43cb-a67b-919a2bc8b65f","type":"message","text":"Because of the type-instability","user":"U69BL50BF","ts":"1616176941.029600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qK5C","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Because of the type-instability"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"c7cd2031-43b4-45a6-9a46-8dd4cd87fee6","type":"message","text":"How does array symbolics address this?","user":"U66N673NV","ts":"1616176981.029800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6Du33","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"How does array symbolics address this?"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"98a79d54-3d1a-4f91-a077-0bea230fe39e","type":"message","text":"we need <https://github.com/MasonProtter/SymbolicTracing.jl> + <https://github.com/JuliaSymbolics/SymbolicUtils.jl/pull/123> to fix it","user":"U69BL50BF","ts":"1616176995.030000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"tuii9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"we need "},{"type":"link","url":"https://github.com/MasonProtter/SymbolicTracing.jl"},{"type":"text","text":" + "},{"type":"link","url":"https://github.com/JuliaSymbolics/SymbolicUtils.jl/pull/123"},{"type":"text","text":" to fix it"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"6e3416eb-d0f8-4185-9115-35866a418607","type":"message","text":"Because then the `sum` doesn't need to be expanded.","user":"U69BL50BF","ts":"1616177001.030200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7zab","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Because then the "},{"type":"text","text":"sum","style":{"code":true}},{"type":"text","text":" doesn't need to be expanded."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"bedd261c-9deb-4673-8f22-855312ffc0c1","type":"message","text":"or we can `@register` the sum.","user":"U69BL50BF","ts":"1616177058.030400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"wfyH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"or we can "},{"type":"text","text":"@register","style":{"code":true}},{"type":"text","text":" the sum."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"d84b96cf-1a73-4b77-b4d3-c4c0b01af997","type":"message","text":"How does that work if `a` is `Vector{Any}`?","user":"U66N673NV","ts":"1616177082.030600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"eNOBV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"How does that work if "},{"type":"text","text":"a","style":{"code":true}},{"type":"text","text":" is "},{"type":"text","text":"Vector{Any}","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"731f2a80-e925-41ab-9d84-952c095d55f4","type":"message","text":"it can just capture the Term","user":"U69BL50BF","ts":"1616177955.030800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"58fR","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it can just capture the Term"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"7d66bd33-11d4-48e1-b2d1-b6e36e28ff20","type":"message","text":"```using ModelingToolkit\n@variables a[1:10000000] b[1:1000000]\ntype_unstable_function(i) = rand()&lt;0.5 ? 1 : 1.0\nc = [type_unstable_function(i) for i in 1:10000000]\n\nusing SymbolicUtils\nBase.sum(x::Base.Generator) = Term(sum,[x])\n\n@time obj = sum((a[i] * b[i] * c[i] for i in 1:100000))```","user":"U69BL50BF","ts":"1616177957.031000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"g1Ahl","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using ModelingToolkit\n@variables a[1:10000000] b[1:1000000]\ntype_unstable_function(i) = rand()<0.5 ? 1 : 1.0\nc = [type_unstable_function(i) for i in 1:10000000]\n\nusing SymbolicUtils\nBase.sum(x::Base.Generator) = Term(sum,[x])\n\n@time obj = sum((a[i] * b[i] * c[i] for i in 1:100000))"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"ed4e8d8f-a61a-4da8-9793-fb837426d2a6","type":"message","text":"though we would want to make the Generator a RuntimeGeneratedFunction in order for it to serialize better.","user":"U69BL50BF","ts":"1616177978.031200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VNND","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"though we would want to make the Generator a RuntimeGeneratedFunction in order for it to serialize better."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"79bf361d-6b75-4df7-91e0-cabf6c2c7b25","type":"message","text":"Does \"capture the Term\" mean that it keeps a reference to the `a, b, c`, and if their contents change, it could change `obj`?","user":"U66N673NV","ts":"1616178144.031400","team":"T68168MUP","edited":{"user":"U66N673NV","ts":"1616178155.000000"},"blocks":[{"type":"rich_text","block_id":"/In","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Does \"capture the Term\" mean that it keeps a reference to the "},{"type":"text","text":"a, b, c","style":{"code":true}},{"type":"text","text":", and if their contents change, it could change "},{"type":"text","text":"obj","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"4f3e0a88-64f1-4c8e-9f1f-8cd9a49e03e7","type":"message","text":"`a,b,c` are symbolic, so they can't change? That statement doesn't make much sense","user":"U69BL50BF","ts":"1616178196.031700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ERFsu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"a,b,c","style":{"code":true}},{"type":"text","text":" are symbolic, so they can't change? That statement doesn't make much sense"}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"},{"client_msg_id":"b580cc85-0e7d-4c51-be8d-4b8058d57bb9","type":"message","text":"it's a symbolic representation of the Julia code.","user":"U69BL50BF","ts":"1616178202.031900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ZoTR8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's a symbolic representation of the Julia code."}]}]}],"thread_ts":"1616170054.024100","parent_user_id":"U69BL50BF"}]