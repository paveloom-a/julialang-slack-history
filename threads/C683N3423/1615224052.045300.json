[{"client_msg_id":"abdbc4fa-1cfd-4dbe-92f8-fab3a8343258","type":"message","text":"I am trying to make an HTTP request to AWS API Gateway using HTTP.jl, but I am getting a `403 Forbidden` response due to `InvalidSignatureException`. This is how I am calling `request`:\n```HTTP.request(\"GET\", \"<https://my-id.execute-api.us-east-2.amazonaws.com/my-stage/my-route>\", [\"x-api-key\" =&gt; api_key]; aws_authorization=true, aws_service=\"execute-api\", aws_region=\"us-east-2\", aws_access_key_id=aws_config.credentials.access_key_id, aws_secret_access_key=aws_config.credentials.secret_key, verbose=2)```\nAm I missing something in the request?","user":"U01537M2E9W","ts":"1615224052.045300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UXAp+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I am trying to make an HTTP request to AWS API Gateway using HTTP.jl, but I am getting a "},{"type":"text","text":"403 Forbidden","style":{"code":true}},{"type":"text","text":" response due to "},{"type":"text","text":"InvalidSignatureException","style":{"code":true}},{"type":"text","text":". This is how I am calling "},{"type":"text","text":"request","style":{"code":true}},{"type":"text","text":":\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"HTTP.request(\"GET\", \""},{"type":"link","url":"https://my-id.execute-api.us-east-2.amazonaws.com/my-stage/my-route"},{"type":"text","text":"\", [\"x-api-key\" => api_key]; aws_authorization=true, aws_service=\"execute-api\", aws_region=\"us-east-2\", aws_access_key_id=aws_config.credentials.access_key_id, aws_secret_access_key=aws_config.credentials.secret_key, verbose=2)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Am I missing something in the request?"}]}]}],"thread_ts":"1615224052.045300","reply_count":17,"reply_users_count":3,"latest_reply":"1615229412.048900","reply_users":["ULDQSHD41","U01537M2E9W","U681ELA87"],"subscribed":false},{"client_msg_id":"21931ef4-3dcd-4915-9bc3-fc891e31b4e0","type":"message","text":"<https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html>\n\nI assume this is your issue","user":"ULDQSHD41","ts":"1615224626.045400","team":"T68168MUP","attachments":[{"title":"Signature Version 4 signing process - AWS General Reference","title_link":"https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html","text":"Add authentication information to AWS API requests with Signature Version 4 protocol.","fallback":"Signature Version 4 signing process - AWS General Reference","from_url":"https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html","service_icon":"https://docs.aws.amazon.com/assets/images/favicon.ico","service_name":"docs.aws.amazon.com","id":1,"original_url":"https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html"}],"blocks":[{"type":"rich_text","block_id":"9uP0","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html"},{"type":"text","text":"\n\nI assume this is your issue"}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"26d385c6-0445-416e-b3ec-96ed2dc2d944","type":"message","text":"HTTP.jl has code to sign the canonical request. I can see it send the signature and other authorization information in the request. My issue is that the signature doesn't match what AWS expected (`{\"message\":\"The request signature we calculated does not match the signature you provided. ...`) so I am wondering if I have misconfigured HTTP.jl. I haven't had signing trouble before, but I also have never used HTTP.jl directly before.","user":"U01537M2E9W","ts":"1615224792.045700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"uI4Q4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"HTTP.jl has code to sign the canonical request. I can see it send the signature and other authorization information in the request. My issue is that the signature doesn't match what AWS expected ("},{"type":"text","text":"{\"message\":\"The request signature we calculated does not match the signature you provided. ...","style":{"code":true}},{"type":"text","text":") so I am wondering if I have misconfigured HTTP.jl. I haven't had signing trouble before, but I also have never used HTTP.jl directly before."}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"b4b15428-ffaa-48bc-943b-3d885592bbda","type":"message","text":"I’d recommend using the AWSSDK.jl or <https://github.com/JuliaCloud/AWSAuth.jl> packages; the HTTP.jl aws code is essentially deprecated. I think it should work in most cases, but I know there are cases where it fails that have been corrected in the AWS packages","user":"U681ELA87","ts":"1615225050.045900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ZQR","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I’d recommend using the AWSSDK.jl or "},{"type":"link","url":"https://github.com/JuliaCloud/AWSAuth.jl"},{"type":"text","text":" packages; the HTTP.jl aws code is essentially deprecated. I think it should work in most cases, but I know there are cases where it fails that have been corrected in the AWS packages"}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"cf2423a3-9d36-4e96-a404-5da62b8305f6","type":"message","text":"Could you try passing in `aws_service=\"apigateway\"`?","user":"ULDQSHD41","ts":"1615225460.046100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8zv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Could you try passing in "},{"type":"text","text":"aws_service=\"apigateway\"","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"101f05b7-374c-418a-b4a0-dbd503f0a599","type":"message","text":"The `ExecuteAPI` links to these endpoints which I don’t think is what you’re trying to do.\n\n- <https://github.com/JuliaCloud/AWS.jl/blob/master/src/services/apigatewaymanagementapi.jl>","user":"ULDQSHD41","ts":"1615225535.046300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=F3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The "},{"type":"text","text":"ExecuteAPI","style":{"code":true}},{"type":"text","text":" links to these endpoints which I don’t think is what you’re trying to do.\n\n- "},{"type":"link","url":"https://github.com/JuliaCloud/AWS.jl/blob/master/src/services/apigatewaymanagementapi.jl"}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"cba89afb-bc57-48d1-aad2-760844742906","type":"message","text":"With `apigateway` I get this error `{\"message\":\"Credential should be scoped to correct service: 'execute-api'. \"}`","user":"U01537M2E9W","ts":"1615225841.046500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"M33","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"With "},{"type":"text","text":"apigateway","style":{"code":true}},{"type":"text","text":" I get this error "},{"type":"text","text":"{\"message\":\"Credential should be scoped to correct service: 'execute-api'. \"}","style":{"code":true}}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"f11aeb2d-270c-463e-82a3-80589fab2878","type":"message","text":"The API works when I call it from Postman, so I guess the problem is with HTTP.jl's signing method. I will try to use a different method","user":"U01537M2E9W","ts":"1615226346.046700","team":"T68168MUP","edited":{"user":"U01537M2E9W","ts":"1615226351.000000"},"blocks":[{"type":"rich_text","block_id":"gSo4W","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The API works when I call it from Postman, so I guess the problem is with HTTP.jl's signing method. I will try to use a different method"}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"a541dbfe-bbce-4021-a483-3ec23aee0812","type":"message","text":"Could you try? Note: This assumes that your default credentials are set for `us-east-2`.\n\nThe signing between AWS.jl and what HTTP.jl has is relatively the same, but might give some insight into the HTTP stack and if that is causing issues.\n\n```julia\nusing AWS.AWSServices: apigatewaymanagementapi\n\napigatewaymanagementapi(\"GET\", \"<https://my-id.execute-api.us-east-2.amazonaws.com/my-stage/my-route>\", Dict(\"x-api-key\" =&gt; api_key))```","user":"ULDQSHD41","ts":"1615228231.047000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"SIY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Could you try? Note: This assumes that your default credentials are set for "},{"type":"text","text":"us-east-2","style":{"code":true}},{"type":"text","text":".\n\nThe signing between AWS.jl and what HTTP.jl has is relatively the same, but might give some insight into the HTTP stack and if that is causing issues.\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia\nusing AWS.AWSServices: apigatewaymanagementapi\n\napigatewaymanagementapi(\"GET\", \""},{"type":"link","url":"https://my-id.execute-api.us-east-2.amazonaws.com/my-stage/my-route"},{"type":"text","text":"\", Dict(\"x-api-key\" => api_key))"}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"6ef2abc5-3670-470f-85ad-96da34dbd955","type":"message","text":"`ERROR: DNSError: execute-api.us-east-2.amazonaws.comhttps, unknown node or service (EAI_NONAME)`","user":"U01537M2E9W","ts":"1615228425.047200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"WOBJH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ERROR: DNSError: execute-api.us-east-2.amazonaws.comhttps, unknown node or service (EAI_NONAME)","style":{"code":true}}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"902b4b5c-1e1a-4660-8cb2-9dcedbcff516","type":"message","text":"I feel like I should be able to leverage AWS.jl here to configure my own RestJSONService, though I would need a way to separate `my-id` from the service scope. Not sure if AWS.jl is built to have a service scope and a \"sub-scope\" of that service.","user":"U01537M2E9W","ts":"1615228489.047400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"huK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I feel like I should be able to leverage AWS.jl here to configure my own RestJSONService, though I would need a way to separate "},{"type":"text","text":"my-id","style":{"code":true}},{"type":"text","text":" from the service scope. Not sure if AWS.jl is built to have a service scope and a \"sub-scope\" of that service."}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"919c2d46-ad6f-4d27-b7d5-7155ed679bc1","type":"message","text":"Oh whoops, do `..(\"GET\", \"/my-stage/my-route\")...`","user":"ULDQSHD41","ts":"1615229047.047600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Wiav","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Oh whoops, do "},{"type":"text","text":"..(\"GET\", \"/my-stage/my-route\")...","style":{"code":true}}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"c2335165-5c5b-480b-87e8-6416c69d8bca","type":"message","text":"`ERROR: DNSError: <http://execute-api.us-east-2.amazonaws.com|execute-api.us-east-2.amazonaws.com>, unknown node or service (EAI_NONAME)`","user":"U01537M2E9W","ts":"1615229149.047800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"IGLR","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ERROR: DNSError: ","style":{"code":true}},{"type":"link","url":"http://execute-api.us-east-2.amazonaws.com","text":"execute-api.us-east-2.amazonaws.com","style":{"code":true}},{"type":"text","text":", unknown node or service (EAI_NONAME)","style":{"code":true}}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"27dd95be-bb35-4419-b51b-c8c90d4890f6","type":"message","text":"`execute-api` is the service, but the requests need to be against the `my-id` prefix","user":"U01537M2E9W","ts":"1615229180.048000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ZLkY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"execute-api","style":{"code":true}},{"type":"text","text":" is the service, but the requests need to be against the "},{"type":"text","text":"my-id","style":{"code":true}},{"type":"text","text":" prefix"}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"83c7faf9-c0a7-40f3-adb9-db178fa44b25","type":"message","text":"E.g. in Postman I send a GET request to `<https://my-id.execute-api.us-east-2.amazonaws.com/my-stage/my-route>` but Postman knows to include `Credential=MY_AWS_ID/20210308/us-east-2/execute-api/aws4_request` in the Authorization header","user":"U01537M2E9W","ts":"1615229274.048200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xEq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"E.g. in Postman I send a GET request to "},{"type":"link","url":"https://my-id.execute-api.us-east-2.amazonaws.com/my-stage/my-route","style":{"code":true}},{"type":"text","text":" but Postman knows to include "},{"type":"text","text":"Credential=MY_AWS_ID/20210308/us-east-2/execute-api/aws4_request","style":{"code":true}},{"type":"text","text":" in the Authorization header"}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"e74e2b74-6c66-4686-8cdc-49452127fdf1","type":"message","text":"Ah I see, I haven’t used API Gateway before. You could instead do:\n\n```your_service = RestJSONService(\"my-id.execute-api\", \"foobar\")\nyour_service(\"GET\", \"/my-stage/my-route\")```\nThat *should* work. The `foobar` doesn’t matter in this case","user":"ULDQSHD41","ts":"1615229306.048400","team":"T68168MUP","edited":{"user":"ULDQSHD41","ts":"1615229333.000000"},"blocks":[{"type":"rich_text","block_id":"FkLu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah I see, I haven’t used API Gateway before. You could instead do:\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"your_service = RestJSONService(\"my-id.execute-api\", \"foobar\")\nyour_service(\"GET\", \"/my-stage/my-route\")"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"\nThat "},{"type":"text","text":"should","style":{"bold":true}},{"type":"text","text":" work. The "},{"type":"text","text":"foobar","style":{"code":true}},{"type":"text","text":" doesn’t matter in this case"}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"c52a8b66-fd1a-4e8d-8225-c181ebf9dcb8","type":"message","text":"That doesn't work because it uses `my-id.execute-api` as the service scope.\n`{\"message\":\"Credential should be scoped to correct service: 'execute-api'. \"}`","user":"U01537M2E9W","ts":"1615229398.048700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ad8+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That doesn't work because it uses "},{"type":"text","text":"my-id.execute-api","style":{"code":true}},{"type":"text","text":" as the service scope.\n"},{"type":"text","text":"{\"message\":\"Credential should be scoped to correct service: 'execute-api'. \"}","style":{"code":true}}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"},{"client_msg_id":"aee546e2-14ac-4d70-9eeb-068b94b61369","type":"message","text":"This is what I was referring to about separating the `my-id` \"sub-scope\" from the service scope. This is also why, with HTTP.jl, I have to make the request against `my-id.execute-api` but manually set `aws_service=\"execute-api\"` .","user":"U01537M2E9W","ts":"1615229412.048900","team":"T68168MUP","edited":{"user":"U01537M2E9W","ts":"1615229536.000000"},"blocks":[{"type":"rich_text","block_id":"lXh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This is what I was referring to about separating the "},{"type":"text","text":"my-id","style":{"code":true}},{"type":"text","text":" \"sub-scope\" from the service scope. This is also why, with HTTP.jl, I have to make the request against "},{"type":"text","text":"my-id.execute-api","style":{"code":true}},{"type":"text","text":" but manually set "},{"type":"text","text":"aws_service=\"execute-api\"","style":{"code":true}},{"type":"text","text":" ."}]}]}],"thread_ts":"1615224052.045300","parent_user_id":"U01537M2E9W"}]