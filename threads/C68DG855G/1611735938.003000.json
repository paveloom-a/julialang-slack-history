[{"client_msg_id":"defb3c38-1aff-402a-ab6e-0745b8291731","type":"message","text":"Do I just save it to the deps/patches folder? Does the patch filename matter? How do I tell the build system to apply it to OpenBLAS?","user":"U6G4M02N4","ts":"1611735938.003000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Hl2A","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Do I just save it to the deps/patches folder? Does the patch filename matter? How do I tell the build system to apply it to OpenBLAS?"}]}]}],"thread_ts":"1611735938.003000","reply_count":30,"reply_users_count":2,"latest_reply":"1611749471.009300","reply_users":["U67SCG4HG","U6G4M02N4"],"subscribed":false},{"client_msg_id":"0592b9ad-a3df-41c8-a3bb-edd26760f03e","type":"message","text":"There are some patches applied to openblas in `deps/blas.mk` (around L96-L112).","user":"U67SCG4HG","ts":"1611736100.003100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/gZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"There are some patches applied to openblas in "},{"type":"text","text":"deps/blas.mk","style":{"code":true}},{"type":"text","text":" (around L96-L112)."}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"559cfe0f-0e83-4305-b1fd-54dcfc2272ac","type":"message","text":"Oh, so I can just save it however and add something like\n```$(BUILDDIR)/$(OPENBLAS_SRC_DIR)/openblas-mypatch.patch-applied: $(BUILDDIR)/$(OPENBLAS_SRC_DIR)/source-extracted\n\tcd $(BUILDDIR)/$(OPENBLAS_SRC_DIR) &amp;&amp; \\\n\t\tpatch -p1 -f &lt; $(SRCDIR)/patches/openblas-mypatch.patch\n\techo 1 &gt; $@```\nto deps/blas.mk?","user":"U6G4M02N4","ts":"1611736237.003300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RcH7O","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Oh, so I can just save it however and add something like\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"$(BUILDDIR)/$(OPENBLAS_SRC_DIR)/openblas-mypatch.patch-applied: $(BUILDDIR)/$(OPENBLAS_SRC_DIR)/source-extracted\n\tcd $(BUILDDIR)/$(OPENBLAS_SRC_DIR) && \\\n\t\tpatch -p1 -f < $(SRCDIR)/patches/openblas-mypatch.patch\n\techo 1 > $@"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"to deps/blas.mk?"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"c65d7557-b0bc-4e19-a839-ec035720a050","type":"message","text":"I'm going to try that, thanks!","user":"U6G4M02N4","ts":"1611736380.003500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5wJ1s","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm going to try that, thanks!"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"1c7e77bf-4c8c-43e0-b9f8-f71c43a6f27e","type":"message","text":"Yea and adjust the other one, you can see that they all depend on each other","user":"U67SCG4HG","ts":"1611736496.003700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"dBvPj","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yea and adjust the other one, you can see that they all depend on each other"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"e3a88d8f-52cf-4f5b-af4f-d4de79d0acb5","type":"message","text":"What do you mean? The different patches seem to be simply \"applied\" one after the other in <http://blas.mk|blas.mk>... Do you mean I have to tweak the other openblas .patch files?","user":"U6G4M02N4","ts":"1611736582.003900","team":"T68168MUP","edited":{"user":"U6G4M02N4","ts":"1611736598.000000"},"blocks":[{"type":"rich_text","block_id":"T6Qv0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What do you mean? The different patches seem to be simply \"applied\" one after the other in "},{"type":"link","url":"http://blas.mk","text":"blas.mk"},{"type":"text","text":"... Do you mean I have to tweak the other openblas .patch files?"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"c3cbc999-2bc1-4d24-8cd7-b20257e37beb","type":"message","text":"`openblas-winexit.patch-applied` depends on `source-extracted`, then `openblas-ofast-power.patch-applied` depends on `openblas-winexit.patch-applied` and then finally `build-configured` depends on `openblas-ofast-power.patch-applied`","user":"U67SCG4HG","ts":"1611736652.004200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QCU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"openblas-winexit.patch-applied","style":{"code":true}},{"type":"text","text":" depends on "},{"type":"text","text":"source-extracted","style":{"code":true}},{"type":"text","text":", then "},{"type":"text","text":"openblas-ofast-power.patch-applied","style":{"code":true}},{"type":"text","text":" depends on "},{"type":"text","text":"openblas-winexit.patch-applied","style":{"code":true}},{"type":"text","text":" and then finally "},{"type":"text","text":"build-configured","style":{"code":true}},{"type":"text","text":" depends on "},{"type":"text","text":"openblas-ofast-power.patch-applied","style":{"code":true}}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"063c2105-425d-4ba8-88b5-5388651215c6","type":"message","text":"Aaah, gotit!","user":"U6G4M02N4","ts":"1611736700.004500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ZUT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Aaah, gotit!"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"3f158027-56dc-4ee7-b3d4-ccffcc0db0bd","type":"message","text":"Thanks for your patience","user":"U6G4M02N4","ts":"1611736712.004700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6SM0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks for your patience"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"cf35b41a-d1a7-4ca5-8063-708867ed460e","type":"message","text":"Also remember to set `USE_BINARYBUILDER_OPENBLAS=0` otherwise the build will just download prebuilt binaries","user":"U67SCG4HG","ts":"1611736990.004900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"JwDg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Also remember to set "},{"type":"text","text":"USE_BINARYBUILDER_OPENBLAS=0","style":{"code":true}},{"type":"text","text":" otherwise the build will just download prebuilt binaries"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"adb09477-6a91-40d2-88a9-aefc5adef706","type":"message","text":"Ah, ok","user":"U6G4M02N4","ts":"1611737002.005100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"z6g","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah, ok"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"7a0fa2b9-32d4-4935-bbf1-e2fac2ab68e6","type":"message","text":"didn't know that","user":"U6G4M02N4","ts":"1611737015.005300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rT9P","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"didn't know that"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"286ef89f-9066-46c1-8717-33f959e13cee","type":"message","text":"I'm encountering a problem when using USE_BINARYBUILDER_OPENBLAS=0 on a clean master, without any modification\n```make[1]: *** No rule to make target `scratch/objconv/build-compiled', needed by `scratch/openblas-63b03efc2af332c88b86d4fd8079d00f4b439adf/build-compiled'.  Stop.```","user":"U6G4M02N4","ts":"1611741021.005500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2qO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm encountering a problem when using USE_BINARYBUILDER_OPENBLAS=0 on a clean master, without any modification\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"make[1]: *** No rule to make target `scratch/objconv/build-compiled', needed by `scratch/openblas-63b03efc2af332c88b86d4fd8079d00f4b439adf/build-compiled'.  Stop."}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"afd9e690-dadc-4d46-b164-f258b9ccf2a3","type":"message","text":"Could there be something wrong in the unmodified <http://blas.mk|blas.mk>?","user":"U6G4M02N4","ts":"1611741056.005700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gB5","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Could there be something wrong in the unmodified "},{"type":"link","url":"http://blas.mk","text":"blas.mk"},{"type":"text","text":"?"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"5ab85dd9-aad0-484c-8ffe-6f3835d4e503","type":"message","text":"Ah, I think there is an error in line 46.\n```$(BUILDDIR)/$(OPENBLAS_SRC_DIR)/build-compiled: $(BUILDDIR)/objconv/build-compiled```\nshould be\n```$(BUILDDIR)/objconv/build-compiled: $(BUILDDIR)/$(OPENBLAS_SRC_DIR)/build-compiled```","user":"U6G4M02N4","ts":"1611742864.005900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1nN=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah, I think there is an error in line 46.\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"$(BUILDDIR)/$(OPENBLAS_SRC_DIR)/build-compiled: $(BUILDDIR)/objconv/build-compiled"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"should be\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"$(BUILDDIR)/objconv/build-compiled: $(BUILDDIR)/$(OPENBLAS_SRC_DIR)/build-compiled"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"2bfe2660-5b05-4290-a119-5b32ff1da84b","type":"message","text":"<https://github.com/JuliaLang/julia/pull/39418>","user":"U6G4M02N4","ts":"1611743824.006100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"b+iAt","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://github.com/JuliaLang/julia/pull/39418"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"d335bb40-2bd4-4668-b65b-fa8f7e068598","type":"message","text":"I am not a makefile wizard, but it seems wrong to declare a target for objconv in the blas makefile?","user":"U67SCG4HG","ts":"1611744400.006300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"h55Qe","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I am not a makefile wizard, but it seems wrong to declare a target for objconv in the blas makefile?"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"e594ab7a-cedb-4bd1-9718-3c4abda20915","type":"message","text":"What if you also use `USE_BINARYBUILDER_OBJCONV=0`?","user":"U67SCG4HG","ts":"1611744481.006500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"s3dBQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What if you also use "},{"type":"text","text":"USE_BINARYBUILDER_OBJCONV=0","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"e438a91a-47a8-4e1f-9035-8ccbd1e537ce","type":"message","text":"I am honestly not sure, I am just doing this a bit desperately to be able to test some OpenBLAS patches. I just realized that USE_BINARYBUILDER_OPENBLAS=0 is broken under macos, and this PR fixes that...","user":"U6G4M02N4","ts":"1611744489.006700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"p+cA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I am honestly not sure, I am just doing this a bit desperately to be able to test some OpenBLAS patches. I just realized that USE_BINARYBUILDER_OPENBLAS=0 is broken under macos, and this PR fixes that..."}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"cffc41cb-bb8a-45a4-a197-7077f20e3f7c","type":"message","text":"I would love to have somebody who knows their way around make files to have a look","user":"U6G4M02N4","ts":"1611744516.006900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UYC1a","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I would love to have somebody who knows their way around make files to have a look"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"c72a21f2-77ff-47dd-901d-b0450f1e9596","type":"message","text":"Is there anybody in particular I could ping?","user":"U6G4M02N4","ts":"1611744530.007100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"c3Im","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is there anybody in particular I could ping?"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"0dff8563-e36d-4f7c-8194-b9b0d714ba45","type":"message","text":"Oh, didn't try USE_BINARYBUILDER_OBJCONV=0","user":"U6G4M02N4","ts":"1611744584.007300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"D9Cn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Oh, didn't try USE_BINARYBUILDER_OBJCONV=0"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"7ac06cd8-a3b3-48ef-ae12-32acf27021c3","type":"message","text":"I think there is just an error in the binary builder makefile and with `USE_BINARYBUILDER_OBJCONV=0` it should work","user":"U67SCG4HG","ts":"1611744721.007500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"C49g","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think there is just an error in the binary builder makefile and with "},{"type":"text","text":"USE_BINARYBUILDER_OBJCONV=0","style":{"code":true}},{"type":"text","text":" it should work"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"534d2ffd-c241-424c-957a-a0c6bdb7ebca","type":"message","text":"Should I close my blind PR then?","user":"U6G4M02N4","ts":"1611744741.007700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Pcu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Should I close my blind PR then?"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"a33036f1-c79e-470b-acbc-9506c17e4b8b","type":"message","text":"I think so, yea. The missing target is here: <https://github.com/JuliaLang/julia/blob/1eaa1acfd130b636f1591a70515e59ec682f847e/deps/objconv.mk#L15>","user":"U67SCG4HG","ts":"1611744759.007900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XLwT+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think so, yea. The missing target is here: "},{"type":"link","url":"https://github.com/JuliaLang/julia/blob/1eaa1acfd130b636f1591a70515e59ec682f847e/deps/objconv.mk#L15"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"b1a2904c-e1e1-4400-ab68-f25afb370eef","type":"message","text":"but you only end up there with `USE_BINARYBUILDER_OBJCONV=0`.","user":"U67SCG4HG","ts":"1611744774.008100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7IWi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but you only end up there with "},{"type":"text","text":"USE_BINARYBUILDER_OBJCONV=0","style":{"code":true}},{"type":"text","text":"."}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"6844b269-1197-4cc6-9c9d-72f44c23dab6","type":"message","text":"ok, will close, thanks","user":"U6G4M02N4","ts":"1611744791.008300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VwO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ok, will close, thanks"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"8279a31e-7965-4e2d-9198-486766ed7d9b","type":"message","text":"I think perhaps the `<http://bb-install.mk|bb-install.mk>` file should define (empty) `build-compiled` targets? Or perhaps it is not expected to work to build openblas from source with objconv from binary builder. <@U66GD0880> will now.","user":"U67SCG4HG","ts":"1611744980.008500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vii4g","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think perhaps the "},{"type":"link","url":"http://bb-install.mk","text":"bb-install.mk","style":{"code":true}},{"type":"text","text":" file should define (empty) "},{"type":"text","text":"build-compiled","style":{"code":true}},{"type":"text","text":" targets? Or perhaps it is not expected to work to build openblas from source with objconv from binary builder. "},{"type":"user","user_id":"U66GD0880"},{"type":"text","text":" will now."}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"bd7c23d3-556c-4468-8115-84e4f9898c50","type":"message","text":"(I can confirm that USE_BINARYBUILDER_OBJCONV=0 seems to work. Still compiling though)","user":"U6G4M02N4","ts":"1611745502.008700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/3JV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"(I can confirm that USE_BINARYBUILDER_OBJCONV=0 seems to work. Still compiling though)"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"a791c512-4c52-4253-bb87-70b908a25404","type":"message","text":"And yes, without USE_BINARYBUILDER_OBJCONV=0 and using the monkey fix I mentioned above, the build eventually failed, so you're probably right","user":"U6G4M02N4","ts":"1611745573.008900","team":"T68168MUP","edited":{"user":"U6G4M02N4","ts":"1611745595.000000"},"blocks":[{"type":"rich_text","block_id":"zhmg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"And yes, without USE_BINARYBUILDER_OBJCONV=0 and using the monkey fix I mentioned above, the build eventually failed, so you're probably right"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"},{"client_msg_id":"ab2f95d3-94a3-45ca-bb66-fefc404644bf","type":"message","text":"Ouch, after a looong compilation `make USE_BINARYBUILDER_OBJCONV=0 USE_BINARYBUILDER_OPENBLAS=0` still fails with\n```...\n../include/lapacke_mangling.h:12:39: note: expanded from macro 'LAPACK_GLOBAL'\n#define LAPACK_GLOBAL(lcname,UCNAME)  lcname##_\n                                      ^\n&lt;scratch space&gt;:242:1: note: expanded from here\ncggsvp_\n^\n2 errors generated.\nmake[5]: *** [lapacke_cggsvp_work.o] Error 1\nmake[4]: *** [lapacke] Error 2\nmake[3]: *** [lapackelib] Error 2\nmake[2]: *** [netlib] Error 2\n*** Clean the OpenBLAS build with 'make -C deps clean-openblas'. Rebuild with 'make OPENBLAS_USE_THREAD=0' if OpenBLAS had trouble linking libpthread.so, and with 'make OPENBLAS_TARGET_ARCH=NEHALEM' if there were errors building SandyBridge support. Both these options can also be used simultaneously. ***\nmake[1]: *** [scratch/openblas-63b03efc2af332c88b86d4fd8079d00f4b439adf/build-compiled] Error 1\nmake: *** [julia-deps] Error 2```","user":"U6G4M02N4","ts":"1611749471.009300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5pX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ouch, after a looong compilation "},{"type":"text","text":"make USE_BINARYBUILDER_OBJCONV=0 USE_BINARYBUILDER_OPENBLAS=0","style":{"code":true}},{"type":"text","text":" still fails with\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"...\n../include/lapacke_mangling.h:12:39: note: expanded from macro 'LAPACK_GLOBAL'\n#define LAPACK_GLOBAL(lcname,UCNAME)  lcname##_\n                                      ^\n<scratch space>:242:1: note: expanded from here\ncggsvp_\n^\n2 errors generated.\nmake[5]: *** [lapacke_cggsvp_work.o] Error 1\nmake[4]: *** [lapacke] Error 2\nmake[3]: *** [lapackelib] Error 2\nmake[2]: *** [netlib] Error 2\n*** Clean the OpenBLAS build with 'make -C deps clean-openblas'. Rebuild with 'make OPENBLAS_USE_THREAD=0' if OpenBLAS had trouble linking libpthread.so, and with 'make OPENBLAS_TARGET_ARCH=NEHALEM' if there were errors building SandyBridge support. Both these options can also be used simultaneously. ***\nmake[1]: *** [scratch/openblas-63b03efc2af332c88b86d4fd8079d00f4b439adf/build-compiled] Error 1\nmake: *** [julia-deps] Error 2"}]}]}],"thread_ts":"1611735938.003000","parent_user_id":"U6G4M02N4"}]