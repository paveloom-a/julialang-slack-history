[{"client_msg_id":"7D5BE7A3-D37D-46FE-9755-72D597AD75A7","type":"message","text":"What is the idea behind StaticCompiler? Does it emit bitcode and compile with llc ?","user":"UKA81L34J","ts":"1618080588.036600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Lr2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What is the idea behind StaticCompiler? Does it emit bitcode and compile with llc ?"}]}]}],"thread_ts":"1618080588.036600","reply_count":22,"reply_users_count":4,"latest_reply":"1618234036.041300","reply_users":["UDGT4PM41","U69BK8S74","UKA81L34J","U6A0PD8CR"],"is_locked":false,"subscribed":false},{"type":"message","subtype":"thread_broadcast","text":"<@U69BK8S74> would know best, but I think it's a wrapper around GPUCompiler mostly now?","user":"UDGT4PM41","ts":"1618101443.036700","thread_ts":"1618080588.036600","root":{"client_msg_id":"7D5BE7A3-D37D-46FE-9755-72D597AD75A7","type":"message","text":"What is the idea behind StaticCompiler? Does it emit bitcode and compile with llc ?","user":"UKA81L34J","ts":"1618080588.036600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Lr2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What is the idea behind StaticCompiler? Does it emit bitcode and compile with llc ?"}]}]}],"thread_ts":"1618080588.036600","reply_count":22,"reply_users_count":4,"latest_reply":"1618234036.041300","reply_users":["UDGT4PM41","U69BK8S74","UKA81L34J","U6A0PD8CR"],"is_locked":false,"subscribed":false},"blocks":[{"type":"rich_text","block_id":"8NM","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U69BK8S74"},{"type":"text","text":" would know best, but I think it's a wrapper around GPUCompiler mostly now?"}]}]}],"client_msg_id":"33f3a38c-c438-4271-83f5-58f76a8c75fb"},{"client_msg_id":"57d57e56-b715-4294-95e3-3d1894a14118","type":"message","text":"Yes, it emits bitcode and uses LLVM's linker. See <https://github.com/tshort/StaticCompiler.jl/pull/46|https://github.com/tshort/StaticCompiler.jl/pull/46>. <@U6A0PD8CR>'s work is the basis for the latest WIP updates.  There might be good synergy with Mixtape. Older versions of StaticCompiler used Cassette for some manipulations, but that never worked great.","user":"U69BK8S74","ts":"1618107217.037300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gjWPI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes, it emits bitcode and uses LLVM's linker. See "},{"type":"link","url":"https://github.com/tshort/StaticCompiler.jl/pull/46","text":"https://github.com/tshort/StaticCompiler.jl/pull/46"},{"type":"text","text":". "},{"type":"user","user_id":"U6A0PD8CR"},{"type":"text","text":"'s work is the basis for the latest WIP updates.  There might be good synergy with Mixtape. Older versions of StaticCompiler used Cassette for some manipulations, but that never worked great."}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"65ad035a-e6b3-4b7c-aef7-c393826f2397","type":"message","text":"<@U6A0PD8CR> can we chat sometime about this?","user":"UKA81L34J","ts":"1618168459.037500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fVLO","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U6A0PD8CR"},{"type":"text","text":" can we chat sometime about this?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"4da69a69-dfe9-4270-8ebc-035b6a56cbbc","type":"message","text":"I did a few experiments with a version of `generate_shlib` — but I’m not sure I set it up correctly. It seems that the emitted code is not compatible with the ELF format (e.g. `lld` complains)\n```ld.lld: error: lto.tmp: not an ELF file\nERROR: LoadError: failed process: Process(`/Users/mccoybecker/.julia/artifacts/fc1c98713634afbdcb341a882d7e9b34d04fb4a3/tools/ld.lld -shared -o libf.dylib libf`, ProcessExited(1)) [1]```","user":"UKA81L34J","ts":"1618168507.037700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xfY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I did a few experiments with a version of "},{"type":"text","text":"generate_shlib","style":{"code":true}},{"type":"text","text":" — but I’m not sure I set it up correctly. It seems that the emitted code is not compatible with the ELF format (e.g. "},{"type":"text","text":"lld","style":{"code":true}},{"type":"text","text":" complains)\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"ld.lld: error: lto.tmp: not an ELF file\nERROR: LoadError: failed process: Process(`/Users/mccoybecker/.julia/artifacts/fc1c98713634afbdcb341a882d7e9b34d04fb4a3/tools/ld.lld -shared -o libf.dylib libf`, ProcessExited(1)) [1]"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"4c5731d6-e956-4f71-93e7-fb20a10cf2eb","type":"message","text":"<@UKA81L34J> see also: <https://docs.google.com/document/d/1rLpZf-HK6b9uYPDT_piUza4LUhtIrLbUftGa_YaXGKQ/edit?usp=sharing>","user":"UDGT4PM41","ts":"1618169121.037900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ALhGu","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UKA81L34J"},{"type":"text","text":" see also: "},{"type":"link","url":"https://docs.google.com/document/d/1rLpZf-HK6b9uYPDT_piUza4LUhtIrLbUftGa_YaXGKQ/edit?usp=sharing"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"d4170637-7ce6-4d20-bef5-579356b4f9ac","type":"message","text":"<@UM30MT6RF> if you're looking for more compiler stuff to tinker with, there are some pointers in the above doc related to static compilation","user":"UDGT4PM41","ts":"1618169193.038100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xDy","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UM30MT6RF"},{"type":"text","text":" if you're looking for more compiler stuff to tinker with, there are some pointers in the above doc related to static compilation"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"a74a402c-1927-4304-9a27-af1d77a8c04b","type":"message","text":"<@UKA81L34J> for sure!","user":"U6A0PD8CR","ts":"1618233516.038300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9Nb+j","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UKA81L34J"},{"type":"text","text":" for sure!"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"16b0d0f3-0283-40ab-9ab2-5fcff3286283","type":"message","text":"Also, that's odd that ld.lld is looking for ELF; you seem to be on a Mac, so I would expect it to be Mach-O (or whatever the exec format is there).","user":"U6A0PD8CR","ts":"1618233570.038500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XQUUz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Also, that's odd that ld.lld is looking for ELF; you seem to be on a Mac, so I would expect it to be Mach-O (or whatever the exec format is there)."}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"83907f48-8c43-4066-bf69-69b143bf5260","type":"message","text":"<@U6A0PD8CR> I read your Google docs, and I’ve taken a look at a few of your open PRs (specifically, the splitting of codegen and runtime).\n\nI realized that anything you produce I could use (e.g. if StaticCompiler becomes a “core” dependency which uses GPUCompiler — I could just use StaticCompiler and plug in my own jobs (hopefully))","user":"UKA81L34J","ts":"1618233619.038700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2xZz","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U6A0PD8CR"},{"type":"text","text":" I read your Google docs, and I’ve taken a look at a few of your open PRs (specifically, the splitting of codegen and runtime).\n\nI realized that anything you produce I could use (e.g. if StaticCompiler becomes a “core” dependency which uses GPUCompiler — I could just use StaticCompiler and plug in my own jobs (hopefully))"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"1757256f-1c05-42df-b846-49d97cae5b89","type":"message","text":"Re — here’s my version of `generate_shlib`:\n```function aot(ctx::CompilationContext, f::F, tt::TT=Tuple{}; \n        path = tempname()) where {F, TT &lt;: Type}\n    open(path, \"w\") do io\n        job = mixtape_job(ctx, f, tt)\n        rt, _, _, mod = codegen(job.params.ctx, job.source.f, <http://job.source.tt|job.source.tt>)\n        GPUCompiler.finish_module!(job, mod)\n        tm = GPUCompiler.llvm_machine(job.target)\n        LLVM.emit(tm, mod, LLVM.API.LLVMObjectFile, path)\n    end\n    return (path, name)\nend```\nthis works to generate a static object file. I haven’t been able to create a dylib yet","user":"UKA81L34J","ts":"1618233681.038900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"JxE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Re — here’s my version of "},{"type":"text","text":"generate_shlib","style":{"code":true}},{"type":"text","text":":\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function aot(ctx::CompilationContext, f::F, tt::TT=Tuple{}; \n        path = tempname()) where {F, TT <: Type}\n    open(path, \"w\") do io\n        job = mixtape_job(ctx, f, tt)\n        rt, _, _, mod = codegen(job.params.ctx, job.source.f, job.source.tt)\n        GPUCompiler.finish_module!(job, mod)\n        tm = GPUCompiler.llvm_machine(job.target)\n        LLVM.emit(tm, mod, LLVM.API.LLVMObjectFile, path)\n    end\n    return (path, name)\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"this works to generate a static object file. I haven’t been able to create a dylib yet"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"4971642f-0471-4c5e-8957-c735a02fcfc4","type":"message","text":"Is the emitted .o ELF, or something else?","user":"U6A0PD8CR","ts":"1618233756.039100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Zz3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is the emitted .o ELF, or something else?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"4adbb1c6-043d-4f10-8ba7-4cc5c526ff40","type":"message","text":"One more note: I example `codegen`  in your branch of  `GPUCompiler` and it seemed like `codegen` didn’t require any specific modifications. When I compile to OrcJIT — I just use `cached_compilation`.","user":"UKA81L34J","ts":"1618233760.039300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fRX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"One more note: I example "},{"type":"text","text":"codegen","style":{"code":true}},{"type":"text","text":"  in your branch of  "},{"type":"text","text":"GPUCompiler","style":{"code":true}},{"type":"text","text":" and it seemed like "},{"type":"text","text":"codegen","style":{"code":true}},{"type":"text","text":" didn’t require any specific modifications. When I compile to OrcJIT — I just use "},{"type":"text","text":"cached_compilation","style":{"code":true}},{"type":"text","text":"."}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"9115f50c-d1ca-4b09-83a6-1d5af4b09ec8","type":"message","text":"Emitted .o is MachO, like expected","user":"UKA81L34J","ts":"1618233768.039500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"NZVM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Emitted .o is MachO, like expected"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"fe922113-870c-4917-9226-edc470f5cf52","type":"message","text":"Yeah `cached_compilation` is the right thing to use, you just have to maintain a cache for it","user":"U6A0PD8CR","ts":"1618233799.039700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TD3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yeah "},{"type":"text","text":"cached_compilation","style":{"code":true}},{"type":"text","text":" is the right thing to use, you just have to maintain a cache for it"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"e6a829b8-0c3c-4a8e-a523-11fff7320a62","type":"message","text":"Can you manually link it to something and call the functions in it?","user":"U6A0PD8CR","ts":"1618233816.039900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Vy1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Can you manually link it to something and call the functions in it?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"5f4629f6-7890-426d-9aa2-f7e3b2fc2014","type":"message","text":"Should I use `cached_compilation` even for static compilation?","user":"UKA81L34J","ts":"1618233818.040100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0rJ8w","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Should I use "},{"type":"text","text":"cached_compilation","style":{"code":true}},{"type":"text","text":" even for static compilation?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"dc9b4a7b-fcac-4069-9112-9e70b71d1dab","type":"message","text":"Yes! I tried yesterday — but I think I forgot to link in `libjulia`","user":"UKA81L34J","ts":"1618233829.040300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zfl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes! I tried yesterday — but I think I forgot to link in "},{"type":"text","text":"libjulia","style":{"code":true}}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"e43fae5e-054a-45b8-bd85-f8de667a8b2f","type":"message","text":"Give me a moment, will report back","user":"UKA81L34J","ts":"1618233837.040500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"A=vS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Give me a moment, will report back"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"84b14db8-b6c7-4a26-b4e8-151bab08d232","type":"message","text":"I think so; the difference is that it adds a caching layer in front of `codegen`, but everything else should stay the same, IIRC","user":"U6A0PD8CR","ts":"1618233851.040700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qgGTF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think so; the difference is that it adds a caching layer in front of "},{"type":"text","text":"codegen","style":{"code":true}},{"type":"text","text":", but everything else should stay the same, IIRC"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"2ee70528-59cb-4c91-898f-6f0c3b1c7cc1","type":"message","text":"and just to be sure, this error means “link in libjulia” right?\n```Undefined symbols for architecture x86_64:\n  \"_factorial\", referenced from:\n      _main in main-3a2a8f.o\n  \"_jl_box_int64\", referenced from:\n      _jfptr_f_834 in libf.o\n  \"_julia.ptls_states\", referenced from:\n      _julia_f_833 in libf.o\n      _jfptr_f_834 in libf.o\nld: symbol(s) not found for architecture x86_64\nclang: error: linker command failed with exit code 1 (use -v to see invocation)```","user":"UKA81L34J","ts":"1618234019.040900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qPKH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and just to be sure, this error means “link in libjulia” right?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"Undefined symbols for architecture x86_64:\n  \"_factorial\", referenced from:\n      _main in main-3a2a8f.o\n  \"_jl_box_int64\", referenced from:\n      _jfptr_f_834 in libf.o\n  \"_julia.ptls_states\", referenced from:\n      _julia_f_833 in libf.o\n      _jfptr_f_834 in libf.o\nld: symbol(s) not found for architecture x86_64\nclang: error: linker command failed with exit code 1 (use -v to see invocation)"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"693c0500-f64b-43d8-a591-76f9b464cee3","type":"message","text":"I assume these julia specific references are in `libjulia`","user":"UKA81L34J","ts":"1618234032.041100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=DB8p","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I assume these julia specific references are in "},{"type":"text","text":"libjulia","style":{"code":true}}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"72bddcc7-c0e4-442a-87f5-1d5a7f504348","type":"message","text":"Yep","user":"U6A0PD8CR","ts":"1618234036.041300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8h+J","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yep"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"}]