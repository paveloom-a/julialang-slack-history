[{"client_msg_id":"7D5BE7A3-D37D-46FE-9755-72D597AD75A7","type":"message","text":"What is the idea behind StaticCompiler? Does it emit bitcode and compile with llc ?","user":"UKA81L34J","ts":"1618080588.036600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Lr2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What is the idea behind StaticCompiler? Does it emit bitcode and compile with llc ?"}]}]}],"thread_ts":"1618080588.036600","reply_count":46,"reply_users_count":4,"latest_reply":"1618240644.047000","reply_users":["UDGT4PM41","U69BK8S74","UKA81L34J","U6A0PD8CR"],"is_locked":false,"subscribed":false},{"type":"message","subtype":"thread_broadcast","text":"<@U69BK8S74> would know best, but I think it's a wrapper around GPUCompiler mostly now?","user":"UDGT4PM41","ts":"1618101443.036700","thread_ts":"1618080588.036600","root":{"client_msg_id":"7D5BE7A3-D37D-46FE-9755-72D597AD75A7","type":"message","text":"What is the idea behind StaticCompiler? Does it emit bitcode and compile with llc ?","user":"UKA81L34J","ts":"1618080588.036600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Lr2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What is the idea behind StaticCompiler? Does it emit bitcode and compile with llc ?"}]}]}],"thread_ts":"1618080588.036600","reply_count":46,"reply_users_count":4,"latest_reply":"1618240644.047000","reply_users":["UDGT4PM41","U69BK8S74","UKA81L34J","U6A0PD8CR"],"is_locked":false,"subscribed":false},"blocks":[{"type":"rich_text","block_id":"8NM","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U69BK8S74"},{"type":"text","text":" would know best, but I think it's a wrapper around GPUCompiler mostly now?"}]}]}],"client_msg_id":"33f3a38c-c438-4271-83f5-58f76a8c75fb"},{"client_msg_id":"57d57e56-b715-4294-95e3-3d1894a14118","type":"message","text":"Yes, it emits bitcode and uses LLVM's linker. See <https://github.com/tshort/StaticCompiler.jl/pull/46|https://github.com/tshort/StaticCompiler.jl/pull/46>. <@U6A0PD8CR>'s work is the basis for the latest WIP updates.  There might be good synergy with Mixtape. Older versions of StaticCompiler used Cassette for some manipulations, but that never worked great.","user":"U69BK8S74","ts":"1618107217.037300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gjWPI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes, it emits bitcode and uses LLVM's linker. See "},{"type":"link","url":"https://github.com/tshort/StaticCompiler.jl/pull/46","text":"https://github.com/tshort/StaticCompiler.jl/pull/46"},{"type":"text","text":". "},{"type":"user","user_id":"U6A0PD8CR"},{"type":"text","text":"'s work is the basis for the latest WIP updates.  There might be good synergy with Mixtape. Older versions of StaticCompiler used Cassette for some manipulations, but that never worked great."}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"65ad035a-e6b3-4b7c-aef7-c393826f2397","type":"message","text":"<@U6A0PD8CR> can we chat sometime about this?","user":"UKA81L34J","ts":"1618168459.037500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fVLO","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U6A0PD8CR"},{"type":"text","text":" can we chat sometime about this?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"4da69a69-dfe9-4270-8ebc-035b6a56cbbc","type":"message","text":"I did a few experiments with a version of `generate_shlib` — but I’m not sure I set it up correctly. It seems that the emitted code is not compatible with the ELF format (e.g. `lld` complains)\n```ld.lld: error: lto.tmp: not an ELF file\nERROR: LoadError: failed process: Process(`/Users/mccoybecker/.julia/artifacts/fc1c98713634afbdcb341a882d7e9b34d04fb4a3/tools/ld.lld -shared -o libf.dylib libf`, ProcessExited(1)) [1]```","user":"UKA81L34J","ts":"1618168507.037700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xfY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I did a few experiments with a version of "},{"type":"text","text":"generate_shlib","style":{"code":true}},{"type":"text","text":" — but I’m not sure I set it up correctly. It seems that the emitted code is not compatible with the ELF format (e.g. "},{"type":"text","text":"lld","style":{"code":true}},{"type":"text","text":" complains)\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"ld.lld: error: lto.tmp: not an ELF file\nERROR: LoadError: failed process: Process(`/Users/mccoybecker/.julia/artifacts/fc1c98713634afbdcb341a882d7e9b34d04fb4a3/tools/ld.lld -shared -o libf.dylib libf`, ProcessExited(1)) [1]"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"4c5731d6-e956-4f71-93e7-fb20a10cf2eb","type":"message","text":"<@UKA81L34J> see also: <https://docs.google.com/document/d/1rLpZf-HK6b9uYPDT_piUza4LUhtIrLbUftGa_YaXGKQ/edit?usp=sharing>","user":"UDGT4PM41","ts":"1618169121.037900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ALhGu","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UKA81L34J"},{"type":"text","text":" see also: "},{"type":"link","url":"https://docs.google.com/document/d/1rLpZf-HK6b9uYPDT_piUza4LUhtIrLbUftGa_YaXGKQ/edit?usp=sharing"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"d4170637-7ce6-4d20-bef5-579356b4f9ac","type":"message","text":"<@UM30MT6RF> if you're looking for more compiler stuff to tinker with, there are some pointers in the above doc related to static compilation","user":"UDGT4PM41","ts":"1618169193.038100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xDy","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UM30MT6RF"},{"type":"text","text":" if you're looking for more compiler stuff to tinker with, there are some pointers in the above doc related to static compilation"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"a74a402c-1927-4304-9a27-af1d77a8c04b","type":"message","text":"<@UKA81L34J> for sure!","user":"U6A0PD8CR","ts":"1618233516.038300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9Nb+j","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UKA81L34J"},{"type":"text","text":" for sure!"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"16b0d0f3-0283-40ab-9ab2-5fcff3286283","type":"message","text":"Also, that's odd that ld.lld is looking for ELF; you seem to be on a Mac, so I would expect it to be Mach-O (or whatever the exec format is there).","user":"U6A0PD8CR","ts":"1618233570.038500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XQUUz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Also, that's odd that ld.lld is looking for ELF; you seem to be on a Mac, so I would expect it to be Mach-O (or whatever the exec format is there)."}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"83907f48-8c43-4066-bf69-69b143bf5260","type":"message","text":"<@U6A0PD8CR> I read your Google docs, and I’ve taken a look at a few of your open PRs (specifically, the splitting of codegen and runtime).\n\nI realized that anything you produce I could use (e.g. if StaticCompiler becomes a “core” dependency which uses GPUCompiler — I could just use StaticCompiler and plug in my own jobs (hopefully))","user":"UKA81L34J","ts":"1618233619.038700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2xZz","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U6A0PD8CR"},{"type":"text","text":" I read your Google docs, and I’ve taken a look at a few of your open PRs (specifically, the splitting of codegen and runtime).\n\nI realized that anything you produce I could use (e.g. if StaticCompiler becomes a “core” dependency which uses GPUCompiler — I could just use StaticCompiler and plug in my own jobs (hopefully))"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"1757256f-1c05-42df-b846-49d97cae5b89","type":"message","text":"Re — here’s my version of `generate_shlib`:\n```function aot(ctx::CompilationContext, f::F, tt::TT=Tuple{}; \n        path = tempname()) where {F, TT &lt;: Type}\n    open(path, \"w\") do io\n        job = mixtape_job(ctx, f, tt)\n        rt, _, _, mod = codegen(job.params.ctx, job.source.f, <http://job.source.tt|job.source.tt>)\n        GPUCompiler.finish_module!(job, mod)\n        tm = GPUCompiler.llvm_machine(job.target)\n        LLVM.emit(tm, mod, LLVM.API.LLVMObjectFile, path)\n    end\n    return (path, name)\nend```\nthis works to generate a static object file. I haven’t been able to create a dylib yet","user":"UKA81L34J","ts":"1618233681.038900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"JxE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Re — here’s my version of "},{"type":"text","text":"generate_shlib","style":{"code":true}},{"type":"text","text":":\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function aot(ctx::CompilationContext, f::F, tt::TT=Tuple{}; \n        path = tempname()) where {F, TT <: Type}\n    open(path, \"w\") do io\n        job = mixtape_job(ctx, f, tt)\n        rt, _, _, mod = codegen(job.params.ctx, job.source.f, job.source.tt)\n        GPUCompiler.finish_module!(job, mod)\n        tm = GPUCompiler.llvm_machine(job.target)\n        LLVM.emit(tm, mod, LLVM.API.LLVMObjectFile, path)\n    end\n    return (path, name)\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"this works to generate a static object file. I haven’t been able to create a dylib yet"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"4971642f-0471-4c5e-8957-c735a02fcfc4","type":"message","text":"Is the emitted .o ELF, or something else?","user":"U6A0PD8CR","ts":"1618233756.039100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Zz3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is the emitted .o ELF, or something else?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"4adbb1c6-043d-4f10-8ba7-4cc5c526ff40","type":"message","text":"One more note: I example `codegen`  in your branch of  `GPUCompiler` and it seemed like `codegen` didn’t require any specific modifications. When I compile to OrcJIT — I just use `cached_compilation`.","user":"UKA81L34J","ts":"1618233760.039300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fRX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"One more note: I example "},{"type":"text","text":"codegen","style":{"code":true}},{"type":"text","text":"  in your branch of  "},{"type":"text","text":"GPUCompiler","style":{"code":true}},{"type":"text","text":" and it seemed like "},{"type":"text","text":"codegen","style":{"code":true}},{"type":"text","text":" didn’t require any specific modifications. When I compile to OrcJIT — I just use "},{"type":"text","text":"cached_compilation","style":{"code":true}},{"type":"text","text":"."}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"9115f50c-d1ca-4b09-83a6-1d5af4b09ec8","type":"message","text":"Emitted .o is MachO, like expected","user":"UKA81L34J","ts":"1618233768.039500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"NZVM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Emitted .o is MachO, like expected"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"fe922113-870c-4917-9226-edc470f5cf52","type":"message","text":"Yeah `cached_compilation` is the right thing to use, you just have to maintain a cache for it","user":"U6A0PD8CR","ts":"1618233799.039700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TD3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yeah "},{"type":"text","text":"cached_compilation","style":{"code":true}},{"type":"text","text":" is the right thing to use, you just have to maintain a cache for it"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"e6a829b8-0c3c-4a8e-a523-11fff7320a62","type":"message","text":"Can you manually link it to something and call the functions in it?","user":"U6A0PD8CR","ts":"1618233816.039900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Vy1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Can you manually link it to something and call the functions in it?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"5f4629f6-7890-426d-9aa2-f7e3b2fc2014","type":"message","text":"Should I use `cached_compilation` even for static compilation?","user":"UKA81L34J","ts":"1618233818.040100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0rJ8w","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Should I use "},{"type":"text","text":"cached_compilation","style":{"code":true}},{"type":"text","text":" even for static compilation?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"dc9b4a7b-fcac-4069-9112-9e70b71d1dab","type":"message","text":"Yes! I tried yesterday — but I think I forgot to link in `libjulia`","user":"UKA81L34J","ts":"1618233829.040300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zfl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes! I tried yesterday — but I think I forgot to link in "},{"type":"text","text":"libjulia","style":{"code":true}}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"e43fae5e-054a-45b8-bd85-f8de667a8b2f","type":"message","text":"Give me a moment, will report back","user":"UKA81L34J","ts":"1618233837.040500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"A=vS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Give me a moment, will report back"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"84b14db8-b6c7-4a26-b4e8-151bab08d232","type":"message","text":"I think so; the difference is that it adds a caching layer in front of `codegen`, but everything else should stay the same, IIRC","user":"U6A0PD8CR","ts":"1618233851.040700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qgGTF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think so; the difference is that it adds a caching layer in front of "},{"type":"text","text":"codegen","style":{"code":true}},{"type":"text","text":", but everything else should stay the same, IIRC"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"2ee70528-59cb-4c91-898f-6f0c3b1c7cc1","type":"message","text":"and just to be sure, this error means “link in libjulia” right?\n```Undefined symbols for architecture x86_64:\n  \"_factorial\", referenced from:\n      _main in main-3a2a8f.o\n  \"_jl_box_int64\", referenced from:\n      _jfptr_f_834 in libf.o\n  \"_julia.ptls_states\", referenced from:\n      _julia_f_833 in libf.o\n      _jfptr_f_834 in libf.o\nld: symbol(s) not found for architecture x86_64\nclang: error: linker command failed with exit code 1 (use -v to see invocation)```","user":"UKA81L34J","ts":"1618234019.040900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qPKH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and just to be sure, this error means “link in libjulia” right?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"Undefined symbols for architecture x86_64:\n  \"_factorial\", referenced from:\n      _main in main-3a2a8f.o\n  \"_jl_box_int64\", referenced from:\n      _jfptr_f_834 in libf.o\n  \"_julia.ptls_states\", referenced from:\n      _julia_f_833 in libf.o\n      _jfptr_f_834 in libf.o\nld: symbol(s) not found for architecture x86_64\nclang: error: linker command failed with exit code 1 (use -v to see invocation)"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"693c0500-f64b-43d8-a591-76f9b464cee3","type":"message","text":"I assume these julia specific references are in `libjulia`","user":"UKA81L34J","ts":"1618234032.041100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=DB8p","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I assume these julia specific references are in "},{"type":"text","text":"libjulia","style":{"code":true}}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"72bddcc7-c0e4-442a-87f5-1d5a7f504348","type":"message","text":"Yep","user":"U6A0PD8CR","ts":"1618234036.041300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8h+J","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yep"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"b89866a8-ee80-4efa-bcd3-c5bc3c45e077","type":"message","text":"Hmm, GPUCompiler should be emitting `jl_box_int64` for you though. And GPUCompiler doesn't support PTLS. What kind of kernel are you compiling?","user":"U6A0PD8CR","ts":"1618234090.041500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"L5kg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm, GPUCompiler should be emitting "},{"type":"text","text":"jl_box_int64","style":{"code":true}},{"type":"text","text":" for you though. And GPUCompiler doesn't support PTLS. What kind of kernel are you compiling?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"c641bd7f-b05c-4f7f-82c0-199c4b1b7b26","type":"message","text":"Specifically, can you show the LLVM IR for it?","user":"U6A0PD8CR","ts":"1618234119.041700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cp2A1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Specifically, can you show the LLVM IR for it?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"f979a706-6481-479f-a32a-748db6597ff8","type":"message","text":"sure, one moment — I’ll emit an assembly file","user":"UKA81L34J","ts":"1618234217.041900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"AvW","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"sure, one moment — I’ll emit an assembly file"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"3705f581-8d99-4ddc-a9fe-5a101e1769c2","type":"message","text":"You can study and reproduce here: <https://github.com/femtomc/Mixtape.jl/tree/master/scratch> if useful","user":"UKA81L34J","ts":"1618234442.042100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FmT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"You can study and reproduce here: "},{"type":"link","url":"https://github.com/femtomc/Mixtape.jl/tree/master/scratch"},{"type":"text","text":" if useful"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"31a19d5b-be0a-4d16-903b-2936f5abfe22","type":"message","text":"Here’s LLVM IR","user":"UKA81L34J","ts":"1618234531.042300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+FM1X","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Here’s LLVM IR"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"36431c12-367e-4670-bd2e-e8c74f39d812","type":"message","text":"```; ModuleID = 'text'\nsource_filename = \"text\"\ntarget datalayout = \"e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128-ni:10:11:12:13\"\ntarget triple = \"x86_64-apple-darwin20.2.0\"\n\ndefine i64 @julia_f_796(i64 signext %0) !dbg !5 {\ntop:\n  %1 = call {}*** @julia.ptls_states()\n  %2 = bitcast {}*** %1 to {} addrspace(10)**\n  %3 = getelementptr inbounds {} addrspace(10)*, {} addrspace(10)** %2, i64 4\n  %4 = bitcast {} addrspace(10)** %3 to i64**\n  %5 = load i64*, i64** %4, align 8, !tbaa !7, !invariant.load !4\n  %6 = icmp sle i64 %0, 1, !dbg !11\n  %7 = zext i1 %6 to i8, !dbg !11\n  %8 = trunc i8 %7 to i1, !dbg !11\n  %9 = xor i1 %8, true, !dbg !11\n  br i1 %9, label %L4, label %L3, !dbg !11\n\nL3:                                               ; preds = %top\n  ret i64 1, !dbg !11\n\nL4:                                               ; preds = %top\n  %10 = sub i64 %0, 1, !dbg !15\n  %11 = call i64 @julia_f_796(i64 signext %10), !dbg !15\n  %12 = add i64 %0, %11, !dbg !17\n  ret i64 %12, !dbg !17\n}\n\ndefine nonnull {} addrspace(10)* @jfptr_f_797({} addrspace(10)* %0, {} addrspace(10)** %1, i32 %2) #0 {\ntop:\n  %3 = call {}*** @julia.ptls_states()\n  %4 = bitcast {}*** %3 to {} addrspace(10)**\n  %5 = getelementptr inbounds {} addrspace(10)*, {} addrspace(10)** %4, i64 4\n  %6 = bitcast {} addrspace(10)** %5 to i64**\n  %7 = load i64*, i64** %6, align 8, !tbaa !7, !invariant.load !4\n  %8 = getelementptr inbounds {} addrspace(10)*, {} addrspace(10)** %1, i32 0\n  %9 = load {} addrspace(10)*, {} addrspace(10)** %8, align 8, !nonnull !4, !dereferenceable !19, !align !19\n  %10 = bitcast {} addrspace(10)* %9 to i64 addrspace(10)*\n  %11 = addrspacecast i64 addrspace(10)* %10 to i64 addrspace(11)*\n  %12 = load i64, i64 addrspace(11)* %11, align 8\n  %13 = call i64 @julia_f_796(i64 signext %12)\n  %14 = call nonnull {} addrspace(10)* @jl_box_int64(i64 signext %13)\n  ret {} addrspace(10)* %14\n}\n\ndeclare {}*** @julia.ptls_states()\n\ndeclare nonnull {} addrspace(10)* @jl_box_int64(i64 signext)\n\nattributes #0 = { \"thunk\" }\n\n!llvm.module.flags = !{!0, !1}\n!<http://llvm.dbg.cu|llvm.dbg.cu> = !{!2}\n\n!0 = !{i32 2, !\"Dwarf Version\", i32 4}\n!1 = !{i32 1, !\"Debug Info Version\", i32 3}\n!2 = distinct !DICompileUnit(language: DW_LANG_Julia, file: !3, producer: \"julia\", isOptimized: true, runtimeVersion: 0, emissionKind: FullDebug, enums: !4, nameTableKind: GNU)\n!3 = !DIFile(filename: \"/Users/mccoybecker/dev/Mixtape.jl/scratch/static_compile.jl\", directory: \".\")\n!4 = !{}\n!5 = distinct !DISubprogram(name: \"f\", linkageName: \"julia_f_796\", scope: null, file: !3, line: 8, type: !6, scopeLine: 8, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !2, retainedNodes: !4)\n!6 = !DISubroutineType(types: !4)\n!7 = !{!8, !8, i64 0, i64 1}\n!8 = !{!\"jtbaa_const\", !9, i64 0}\n!9 = !{!\"jtbaa\", !10, i64 0}\n!10 = !{!\"jtbaa\"}\n!11 = !DILocation(line: 442, scope: !12, inlinedAt: !14)\n!12 = distinct !DISubprogram(name: \"&lt;=;\", linkageName: \"&lt;=\", scope: !13, file: !13, type: !6, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !2, retainedNodes: !4)\n!13 = !DIFile(filename: \"int.jl\", directory: \".\")\n!14 = !DILocation(line: 0, scope: !5)\n!15 = !DILocation(line: 86, scope: !16, inlinedAt: !14)\n!16 = distinct !DISubprogram(name: \"-;\", linkageName: \"-\", scope: !13, file: !13, type: !6, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !2, retainedNodes: !4)\n!17 = !DILocation(line: 87, scope: !18, inlinedAt: !14)\n!18 = distinct !DISubprogram(name: \"+;\", linkageName: \"+\", scope: !13, file: !13, type: !6, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !2, retainedNodes: !4)\n!19 = !{i64 8}```","user":"UKA81L34J","ts":"1618234533.042500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ztp","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"; ModuleID = 'text'\nsource_filename = \"text\"\ntarget datalayout = \"e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128-ni:10:11:12:13\"\ntarget triple = \"x86_64-apple-darwin20.2.0\"\n\ndefine i64 @julia_f_796(i64 signext %0) !dbg !5 {\ntop:\n  %1 = call {}*** @julia.ptls_states()\n  %2 = bitcast {}*** %1 to {} addrspace(10)**\n  %3 = getelementptr inbounds {} addrspace(10)*, {} addrspace(10)** %2, i64 4\n  %4 = bitcast {} addrspace(10)** %3 to i64**\n  %5 = load i64*, i64** %4, align 8, !tbaa !7, !invariant.load !4\n  %6 = icmp sle i64 %0, 1, !dbg !11\n  %7 = zext i1 %6 to i8, !dbg !11\n  %8 = trunc i8 %7 to i1, !dbg !11\n  %9 = xor i1 %8, true, !dbg !11\n  br i1 %9, label %L4, label %L3, !dbg !11\n\nL3:                                               ; preds = %top\n  ret i64 1, !dbg !11\n\nL4:                                               ; preds = %top\n  %10 = sub i64 %0, 1, !dbg !15\n  %11 = call i64 @julia_f_796(i64 signext %10), !dbg !15\n  %12 = add i64 %0, %11, !dbg !17\n  ret i64 %12, !dbg !17\n}\n\ndefine nonnull {} addrspace(10)* @jfptr_f_797({} addrspace(10)* %0, {} addrspace(10)** %1, i32 %2) #0 {\ntop:\n  %3 = call {}*** @julia.ptls_states()\n  %4 = bitcast {}*** %3 to {} addrspace(10)**\n  %5 = getelementptr inbounds {} addrspace(10)*, {} addrspace(10)** %4, i64 4\n  %6 = bitcast {} addrspace(10)** %5 to i64**\n  %7 = load i64*, i64** %6, align 8, !tbaa !7, !invariant.load !4\n  %8 = getelementptr inbounds {} addrspace(10)*, {} addrspace(10)** %1, i32 0\n  %9 = load {} addrspace(10)*, {} addrspace(10)** %8, align 8, !nonnull !4, !dereferenceable !19, !align !19\n  %10 = bitcast {} addrspace(10)* %9 to i64 addrspace(10)*\n  %11 = addrspacecast i64 addrspace(10)* %10 to i64 addrspace(11)*\n  %12 = load i64, i64 addrspace(11)* %11, align 8\n  %13 = call i64 @julia_f_796(i64 signext %12)\n  %14 = call nonnull {} addrspace(10)* @jl_box_int64(i64 signext %13)\n  ret {} addrspace(10)* %14\n}\n\ndeclare {}*** @julia.ptls_states()\n\ndeclare nonnull {} addrspace(10)* @jl_box_int64(i64 signext)\n\nattributes #0 = { \"thunk\" }\n\n!llvm.module.flags = !{!0, !1}\n!llvm.dbg.cu = !{!2}\n\n!0 = !{i32 2, !\"Dwarf Version\", i32 4}\n!1 = !{i32 1, !\"Debug Info Version\", i32 3}\n!2 = distinct !DICompileUnit(language: DW_LANG_Julia, file: !3, producer: \"julia\", isOptimized: true, runtimeVersion: 0, emissionKind: FullDebug, enums: !4, nameTableKind: GNU)\n!3 = !DIFile(filename: \"/Users/mccoybecker/dev/Mixtape.jl/scratch/static_compile.jl\", directory: \".\")\n!4 = !{}\n!5 = distinct !DISubprogram(name: \"f\", linkageName: \"julia_f_796\", scope: null, file: !3, line: 8, type: !6, scopeLine: 8, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !2, retainedNodes: !4)\n!6 = !DISubroutineType(types: !4)\n!7 = !{!8, !8, i64 0, i64 1}\n!8 = !{!\"jtbaa_const\", !9, i64 0}\n!9 = !{!\"jtbaa\", !10, i64 0}\n!10 = !{!\"jtbaa\"}\n!11 = !DILocation(line: 442, scope: !12, inlinedAt: !14)\n!12 = distinct !DISubprogram(name: \"<=;\", linkageName: \"<=\", scope: !13, file: !13, type: !6, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !2, retainedNodes: !4)\n!13 = !DIFile(filename: \"int.jl\", directory: \".\")\n!14 = !DILocation(line: 0, scope: !5)\n!15 = !DILocation(line: 86, scope: !16, inlinedAt: !14)\n!16 = distinct !DISubprogram(name: \"-;\", linkageName: \"-\", scope: !13, file: !13, type: !6, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !2, retainedNodes: !4)\n!17 = !DILocation(line: 87, scope: !18, inlinedAt: !14)\n!18 = distinct !DISubprogram(name: \"+;\", linkageName: \"+\", scope: !13, file: !13, type: !6, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !2, retainedNodes: !4)\n!19 = !{i64 8}"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"8d6f9382-daa9-4ce1-b409-cf8a5fbd8f1a","type":"message","text":"Ohhh you're forgetting to call the pass which lowers (removes) dead uses of PTLS; one sec","user":"U6A0PD8CR","ts":"1618234806.042700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jmh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ohhh you're forgetting to call the pass which lowers (removes) dead uses of PTLS; one sec"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"53ce9134-4b50-454d-aec6-26c7173d3c8c","type":"message","text":"Are you calling `GPUCompiler.optimize!`?","user":"U6A0PD8CR","ts":"1618234840.042900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QDc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Are you calling "},{"type":"text","text":"GPUCompiler.optimize!","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"8c453d24-9da8-445a-8bd6-ae4bae69af8b","type":"message","text":"No wait, this is something else","user":"U6A0PD8CR","ts":"1618234887.043100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8+Xt","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"No wait, this is something else"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"2cd02ebd-fb2b-45f4-b615-cd89633c49dc","type":"message","text":"This also might narrow it d own","user":"UKA81L34J","ts":"1618234953.043300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"z0eL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This also might narrow it d own"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"52a986ad-b1d3-4c0f-ae33-1865046f652e","type":"message","text":"when I load `libjulia.dylib` as part of build","user":"UKA81L34J","ts":"1618234959.043500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MSP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"when I load "},{"type":"text","text":"libjulia.dylib","style":{"code":true}},{"type":"text","text":" as part of build"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"ab7ef222-02e4-49ac-8b19-a9cc04fb60af","type":"message","text":"```❯ clang -Xclang -load -Xclang $JULIA_DYLIB_PATH/libjulia.1.6.dylib libf.o main.cpp -o main\nUndefined symbols for architecture x86_64:\n  \"std::__1::locale::use_facet(std::__1::locale::id&amp;) const\", referenced from:\n      std::__1::ctype&lt;char&gt; const&amp; std::__1::use_facet&lt;std::__1::ctype&lt;char&gt; &gt;(std::__1::locale const&amp;) in main-ff5817.o\n  \"std::__1::ios_base::getloc() const\", referenced from:\n      std::__1::basic_ios&lt;char, std::__1::char_traits&lt;char&gt; &gt;::widen(char) const in main-ff5817.o\n  \"std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;::put(char)\", referenced from:\n      std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp; std::__1::endl&lt;char, std::__1::char_traits&lt;char&gt; &gt;(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp;) in main-ff5817.o\n  \"std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;::flush()\", referenced from:\n      std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp; std::__1::endl&lt;char, std::__1::char_traits&lt;char&gt; &gt;(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp;) in main-ff5817.o\n  \"std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;::operator&lt;&lt;(int)\", referenced from:\n      _main in main-ff5817.o\n  \"std::__1::cout\", referenced from:\n      _main in main-ff5817.o\n  \"std::__1::ctype&lt;char&gt;::id\", referenced from:\n      std::__1::ctype&lt;char&gt; const&amp; std::__1::use_facet&lt;std::__1::ctype&lt;char&gt; &gt;(std::__1::locale const&amp;) in main-ff5817.o\n  \"std::__1::locale::~locale()\", referenced from:\n      std::__1::basic_ios&lt;char, std::__1::char_traits&lt;char&gt; &gt;::widen(char) const in main-ff5817.o\n  \"___gxx_personality_v0\", referenced from:\n      std::__1::basic_ios&lt;char, std::__1::char_traits&lt;char&gt; &gt;::widen(char) const in main-ff5817.o\n      Dwarf Exception Unwind Info (__eh_frame) in main-ff5817.o\n  \"_factorial\", referenced from:\n      _main in main-ff5817.o\n  \"_jl_box_int64\", referenced from:\n      _jfptr_f_797 in libf.o\n  \"_julia.ptls_states\", referenced from:\n      _julia_f_796 in libf.o\n      _jfptr_f_797 in libf.o\nld: symbol(s) not found for architecture x86_64```","user":"UKA81L34J","ts":"1618234981.043700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"o4d","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"❯ clang -Xclang -load -Xclang $JULIA_DYLIB_PATH/libjulia.1.6.dylib libf.o main.cpp -o main\nUndefined symbols for architecture x86_64:\n  \"std::__1::locale::use_facet(std::__1::locale::id&) const\", referenced from:\n      std::__1::ctype<char> const& std::__1::use_facet<std::__1::ctype<char> >(std::__1::locale const&) in main-ff5817.o\n  \"std::__1::ios_base::getloc() const\", referenced from:\n      std::__1::basic_ios<char, std::__1::char_traits<char> >::widen(char) const in main-ff5817.o\n  \"std::__1::basic_ostream<char, std::__1::char_traits<char> >::put(char)\", referenced from:\n      std::__1::basic_ostream<char, std::__1::char_traits<char> >& std::__1::endl<char, std::__1::char_traits<char> >(std::__1::basic_ostream<char, std::__1::char_traits<char> >&) in main-ff5817.o\n  \"std::__1::basic_ostream<char, std::__1::char_traits<char> >::flush()\", referenced from:\n      std::__1::basic_ostream<char, std::__1::char_traits<char> >& std::__1::endl<char, std::__1::char_traits<char> >(std::__1::basic_ostream<char, std::__1::char_traits<char> >&) in main-ff5817.o\n  \"std::__1::basic_ostream<char, std::__1::char_traits<char> >::operator<<(int)\", referenced from:\n      _main in main-ff5817.o\n  \"std::__1::cout\", referenced from:\n      _main in main-ff5817.o\n  \"std::__1::ctype<char>::id\", referenced from:\n      std::__1::ctype<char> const& std::__1::use_facet<std::__1::ctype<char> >(std::__1::locale const&) in main-ff5817.o\n  \"std::__1::locale::~locale()\", referenced from:\n      std::__1::basic_ios<char, std::__1::char_traits<char> >::widen(char) const in main-ff5817.o\n  \"___gxx_personality_v0\", referenced from:\n      std::__1::basic_ios<char, std::__1::char_traits<char> >::widen(char) const in main-ff5817.o\n      Dwarf Exception Unwind Info (__eh_frame) in main-ff5817.o\n  \"_factorial\", referenced from:\n      _main in main-ff5817.o\n  \"_jl_box_int64\", referenced from:\n      _jfptr_f_797 in libf.o\n  \"_julia.ptls_states\", referenced from:\n      _julia_f_796 in libf.o\n      _jfptr_f_797 in libf.o\nld: symbol(s) not found for architecture x86_64"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"ff8e3b10-793c-41a8-932b-ec8d60f79ead","type":"message","text":"Let me try this on my Linux box in a bit","user":"UKA81L34J","ts":"1618235024.043900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2pvM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Let me try this on my Linux box in a bit"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"6644d773-ac39-4854-b3e7-887d14fc7725","type":"message","text":"The architecture here is totally wrong, I’m working on an M1 — so I wouldn’t expect this to work easily anyways.","user":"UKA81L34J","ts":"1618235059.044100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qdcMb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The architecture here is totally wrong, I’m working on an M1 — so I wouldn’t expect this to work easily anyways."}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"4dbea7b7-0dc7-4ac5-bf40-aad2efe0282f","type":"message","text":"The real issue here is that you're emitting the function `jfptr_f_797`, which uses the jfptr \"calling convention\". What you want is *only* `julia_f_796`.","user":"U6A0PD8CR","ts":"1618235118.044300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"WM3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The real issue here is that you're emitting the function "},{"type":"text","text":"jfptr_f_797","style":{"code":true}},{"type":"text","text":", which uses the jfptr \"calling convention\". What you want is "},{"type":"text","text":"only","style":{"bold":true}},{"type":"text","text":" "},{"type":"text","text":"julia_f_796","style":{"code":true}},{"type":"text","text":"."}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"0721f424-39c6-4b08-ad50-270f389ba379","type":"message","text":"How you got to this point, I don't know :slightly_smiling_face: <@U67BJLYCS> would probably have some ideas.","user":"U6A0PD8CR","ts":"1618235132.044500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2Su","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"How you got to this point, I don't know "},{"type":"emoji","name":"slightly_smiling_face"},{"type":"text","text":" "},{"type":"user","user_id":"U67BJLYCS"},{"type":"text","text":" would probably have some ideas."}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"C66473E8-0220-4E53-9983-EF16E4864DE8","type":"message","text":"I’ll continue experimenting — I’ve copied a lot of the infra I’ve seen elsewhere so I suspect it’s something which should seem obvious","user":"UKA81L34J","ts":"1618236356.045600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Y9kBe","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I’ll continue experimenting — I’ve copied a lot of the infra I’ve seen elsewhere so I suspect it’s something which should seem obvious"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"851da532-07a9-4d99-9673-1e7cb8cdf701","type":"message","text":"if I see `julia.ptls_states` — I suspect that’s an issue","user":"UKA81L34J","ts":"1618237773.045800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jrD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if I see "},{"type":"text","text":"julia.ptls_states","style":{"code":true}},{"type":"text","text":" — I suspect that’s an issue"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"0bad705c-89a2-4748-91a5-c0334f8807a7","type":"message","text":"Yeah, mostly because on GPUs it doesn't make sense (PTLS is a CPU concept)","user":"U6A0PD8CR","ts":"1618238335.046000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TdH2j","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yeah, mostly because on GPUs it doesn't make sense (PTLS is a CPU concept)"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"259b02ad-e55c-41a9-9c02-6bd5093950e5","type":"message","text":"<@U6A0PD8CR> what pass strips dead usage of PTLS?","user":"UKA81L34J","ts":"1618239241.046200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ZUT","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U6A0PD8CR"},{"type":"text","text":" what pass strips dead usage of PTLS?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"63b7edb3-d003-4748-be47-71d85d38eb33","type":"message","text":"```        add!(pm, ModulePass(\"LowerPTLS\", lower_ptls!))```","user":"UKA81L34J","ts":"1618239272.046400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"uFq","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"        add!(pm, ModulePass(\"LowerPTLS\", lower_ptls!))"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"56ce202b-d598-470e-8b6e-7bcfe58184f8","type":"message","text":"?","user":"UKA81L34J","ts":"1618239273.046600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UdT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"?"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"52d430c4-7751-472e-a96b-21a84a00bc48","type":"message","text":"Yep, that's it","user":"U6A0PD8CR","ts":"1618240554.046800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Xu8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yep, that's it"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"},{"client_msg_id":"94f9fd78-bdda-4443-9400-b7633c7af10f","type":"message","text":"I fixed a number of issues — turned out I was running my LLVM passes","user":"UKA81L34J","ts":"1618240644.047000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fw5AG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I fixed a number of issues — turned out I was running my LLVM passes"}]}]}],"thread_ts":"1618080588.036600","parent_user_id":"UKA81L34J"}]