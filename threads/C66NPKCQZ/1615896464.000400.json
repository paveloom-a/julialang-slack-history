[{"client_msg_id":"f5ab8f2a-16e6-4100-9f51-a750ff071618","type":"message","text":"Hi All. How can I use ReverseDiff / Zygote / ForwardDiff / DiffEqSensivity (?) combined with IterativeSolvers or LinearAlgebra to get the derivative of e.g. an eigenvalue with respect to the grid size that is used to the associated linear operator? Here is a minimum failing example:\n```using ForwardDiff, LinearAlgebra, Test\n\nfunction shift_inverse(A, α=0.0; maxiters=10000) # better to use eigen.\n  x = eltype(A).(rand(size(A, 2)))\n  x ./= norm(x)\n  for _ in 1:maxiters\n    x .= (A - α * I) \\ x\n    x ./= norm(x)\n  end\n  return x\nend\n\nfunction Laplacian(dx)\n  n = Int64(round(ForwardDiff.value(1/dx))) # this isn't great\n  return -SymTridiagonal(-ones(n) * 2 / dx^2, ones(n-1) / dx^2)\nend\n\nfunction eigenpair(dx)\n  A = Laplacian(dx)\n  v = shift_inverse(A, 10.0)\n  return v \\ A * v, v\nend\n\nexpected_eigenvalue(dx) = (2 - 2cos(pi/(1/dx+1))) / dx^2\nexpected_eigenvector(i, dx) = cos(pi * i * dx) * sqrt(2dx)\n\nconst dx = 1e-1\n\n@testset \"Test\" begin\n  @show expected_value = expected_eigenvalue(dx)\n  @show expected_deriv = ForwardDiff.derivative(expected_eigenvalue, dx)\n  @show result_value = eigenpair(dx)[1]\n  @show result_deriv = ForwardDiff.derivative(x-&gt;eigenpair(x)[1], dx)\n  @test result_value ≈ expected_value rtol=10eps()\n  @test result_deriv ≈ expected_deriv rtol=10eps()\n  @show -2/dx * result_value / result_deriv\nend```\nAny thoughts?","user":"UDSG73JTH","ts":"1615896464.000400","team":"T68168MUP","edited":{"user":"UDSG73JTH","ts":"1615897050.000000"},"blocks":[{"type":"rich_text","block_id":"=9If","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hi All. How can I use ReverseDiff / Zygote / ForwardDiff / DiffEqSensivity (?) combined with IterativeSolvers or LinearAlgebra to get the derivative of e.g. an eigenvalue with respect to the grid size that is used to the associated linear operator? Here is a minimum failing example:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using ForwardDiff, LinearAlgebra, Test\n\nfunction shift_inverse(A, α=0.0; maxiters=10000) # better to use eigen.\n  x = eltype(A).(rand(size(A, 2)))\n  x ./= norm(x)\n  for _ in 1:maxiters\n    x .= (A - α * I) \\ x\n    x ./= norm(x)\n  end\n  return x\nend\n\nfunction Laplacian(dx)\n  n = Int64(round(ForwardDiff.value(1/dx))) # this isn't great\n  return -SymTridiagonal(-ones(n) * 2 / dx^2, ones(n-1) / dx^2)\nend\n\nfunction eigenpair(dx)\n  A = Laplacian(dx)\n  v = shift_inverse(A, 10.0)\n  return v \\ A * v, v\nend\n\nexpected_eigenvalue(dx) = (2 - 2cos(pi/(1/dx+1))) / dx^2\nexpected_eigenvector(i, dx) = cos(pi * i * dx) * sqrt(2dx)\n\nconst dx = 1e-1\n\n@testset \"Test\" begin\n  @show expected_value = expected_eigenvalue(dx)\n  @show expected_deriv = ForwardDiff.derivative(expected_eigenvalue, dx)\n  @show result_value = eigenpair(dx)[1]\n  @show result_deriv = ForwardDiff.derivative(x->eigenpair(x)[1], dx)\n  @test result_value ≈ expected_value rtol=10eps()\n  @test result_deriv ≈ expected_deriv rtol=10eps()\n  @show -2/dx * result_value / result_deriv\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Any thoughts?"}]}]}],"thread_ts":"1615896464.000400","reply_count":9,"reply_users_count":2,"latest_reply":"1615899599.002500","reply_users":["UMDEUKM29","UDSG73JTH"],"is_locked":false,"subscribed":false},{"client_msg_id":"c53960e9-9f4f-49fd-bfbd-15cc10a9c5d9","type":"message","text":"that's a weird use case but why not","user":"UMDEUKM29","ts":"1615897203.000800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RHfE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that's a weird use case but why not"}]}]}],"thread_ts":"1615896464.000400","parent_user_id":"UDSG73JTH"},{"client_msg_id":"207155d2-e8ed-41ff-b8d7-13566c5b38d9","type":"message","text":"you have to write down the perturbation equation yourself","user":"UMDEUKM29","ts":"1615897215.001000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"T33p","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you have to write down the perturbation equation yourself"}]}]}],"thread_ts":"1615896464.000400","parent_user_id":"UDSG73JTH"},{"client_msg_id":"099fb1fd-c3b2-4b15-b1f6-12c3d08cb10d","type":"message","text":"for the change to the eigenvector wrt the change in the matrix","user":"UMDEUKM29","ts":"1615897295.001200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=Aco","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"for the change to the eigenvector wrt the change in the matrix"}]}]}],"thread_ts":"1615896464.000400","parent_user_id":"UDSG73JTH"},{"client_msg_id":"2310b357-447b-47b1-b030-26a060d34268","type":"message","text":"well if you just want the derivative of the eigenvalue it's even simpler, it's just &lt;x, dA/ddx x&gt;","user":"UMDEUKM29","ts":"1615897323.001400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"j7a","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"well if you just want the derivative of the eigenvalue it's even simpler, it's just <x, dA/ddx x>"}]}]}],"thread_ts":"1615896464.000400","parent_user_id":"UDSG73JTH"},{"client_msg_id":"7cf31677-01a0-40fc-8ab4-b423bd660a17","type":"message","text":"in quantum mechanics it's called <https://en.wikipedia.org/wiki/Hellmann%E2%80%93Feynman_theorem>","user":"UMDEUKM29","ts":"1615897341.001600","team":"T68168MUP","attachments":[{"title":"Hellmann–Feynman theorem","title_link":"https://en.wikipedia.org/wiki/Hellmann%E2%80%93Feynman_theorem","from_url":"https://en.wikipedia.org/wiki/Hellmann%E2%80%93Feynman_theorem","author_name":"Wikipedia","author_link":"https://en.wikipedia.org/","text":"In quantum mechanics, the Hellmann–Feynman theorem relates the derivative of the total energy with respect to a parameter, to the expectation value of the derivative of the Hamiltonian with respect to that same parameter. According to the theorem, once the spatial distribution of the electrons has been determined by solving the Schrödinger equation, all the forces in the system can be calculated using classical electrostatics.\nThe theorem has been proven independently by many authors, including Paul Güttinger (1932), Wolfgang Pauli (1933), Hans Hellmann (1937) and Richard Feynman (1939).The theorem states\n\nwhere\n\n  \n    \n      \n        \n          \n            \n              \n                H\n                ^\n              \n            \n          \n          \n            λ\n          \n        \n      \n    \n    {\\displaystyle {\\hat {H}}_{\\lambda }}\n   is a Hamiltonian operator depending upon a continuous parameter \n  \n    \n      \n        λ\n        \n      \n    \n    {\\displaystyle \\lambda \\,}\n  ,\n\n  \n    \n      \n        \n          |\n        \n        \n          ψ\n          \n            λ\n          \n        \n        ⟩\n      \n    \n    {\\displaystyle |\\psi _{\\lambda }\\rangle }\n  , is an eigen-state (eigenfunction) of the Hamiltonian, depending implicitly upon \n  \n    \n      \n        λ\n      \n    \n    {\\displaystyle \\lambda }\n  ,\n\n  \n    \n      \n        \n          E\n          \n            λ\n          \n        \n        \n      \n    \n    {\\displaystyle E_{\\lambda }\\,}\n   is the energy (eigenvalue) of the state \n  \n    \n      \n        \n          |\n        \n        \n          ψ\n          \n            λ\n          \n        \n        ⟩\n      \n    \n    {\\displaystyle |\\psi _{\\lambda }\\rangle }\n  , i.e. \n  \n    \n      \n        \n          \n            \n              \n                H\n                ^\n              \n            \n          \n          \n            λ\n          \n        \n        \n          |\n        \n        \n          ψ\n          \n            λ\n          \n        \n        ⟩\n        =\n        \n          E\n          \n            λ\n          \n        \n        \n          |\n        \n        \n          ψ\n          \n            λ\n          \n        \n        ⟩\n      \n    \n    {\\displaystyle {\\hat {H}}_{\\lambda }|\\psi _{\\lambda }\\rangle =E_{\\lambda }|\\psi _{\\lambda }\\rangle }\n  .","fallback":"wikipedia: Hellmann–Feynman theorem","service_icon":"https://a.slack-edge.com/80588/img/unfurl_icons/wikipedia.png","id":1,"original_url":"https://en.wikipedia.org/wiki/Hellmann%E2%80%93Feynman_theorem"}],"blocks":[{"type":"rich_text","block_id":"Fqi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"in quantum mechanics it's called "},{"type":"link","url":"https://en.wikipedia.org/wiki/Hellmann%E2%80%93Feynman_theorem"}]}]}],"thread_ts":"1615896464.000400","parent_user_id":"UDSG73JTH"},{"client_msg_id":"5947f483-c3bf-4fe0-a99b-b931ab5d1325","type":"message","text":"I don’t know if that’s right. I want to know the derivative with respect to the discretisation length.","user":"UDSG73JTH","ts":"1615899381.001900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2zmC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I don’t know if that’s right. I want to know the derivative with respect to the discretisation length."}]}]}],"thread_ts":"1615896464.000400","parent_user_id":"UDSG73JTH"},{"client_msg_id":"dd966a59-4708-45b0-9ef7-48880d89fbd8","type":"message","text":"that's nonsensical since the discretization length is not a real number but L/N","user":"UMDEUKM29","ts":"1615899482.002100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ZBdq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that's nonsensical since the discretization length is not a real number but L/N"}]}]}],"thread_ts":"1615896464.000400","parent_user_id":"UDSG73JTH"},{"client_msg_id":"882826e7-7ab7-4476-91c7-cc4293e27540","type":"message","text":"you can uncouple dx and N and you will get an answer (which will basically be the derivative wrt L)","user":"UMDEUKM29","ts":"1615899512.002300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UUy","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you can uncouple dx and N and you will get an answer (which will basically be the derivative wrt L)"}]}]}],"thread_ts":"1615896464.000400","parent_user_id":"UDSG73JTH"},{"client_msg_id":"59bc45b4-c27c-4652-9c15-8ef8bf5a92d5","type":"message","text":"yeah it may not be possible","user":"UDSG73JTH","ts":"1615899599.002500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3HCJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah it may not be possible"}]}]}],"thread_ts":"1615896464.000400","parent_user_id":"UDSG73JTH"}]