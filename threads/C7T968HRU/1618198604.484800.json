[{"client_msg_id":"ef1bdca4-1079-4eeb-a8b7-200963f1c899","type":"message","text":"If I can find a student who really knows Julia, that’d be really useful for me too! \n\nI was interested in customizing broadcast to play nicer with @avx and multithreading, but since I’ve never even written a macro before, I figure I have some things to learn before writing anything fast and useful.","user":"U011LUQ182G","ts":"1618198604.484800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"grh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If I can find a student who really knows Julia, that’d be really useful for me too! \n\nI was interested in customizing broadcast to play nicer with @avx and multithreading, but since I’ve never even written a macro before, I figure I have some things to learn before writing anything fast and useful."}]}]}],"thread_ts":"1618198604.484800","reply_count":30,"reply_users_count":3,"latest_reply":"1618234854.051600","reply_users":["UM8JUNJG7","U011LUQ182G","U69BL50BF"],"is_locked":false,"subscribed":false},{"client_msg_id":"aafe44c8-d1d4-4c5b-8be8-4b7018e4301d","type":"message","text":"as in, broadcasting automatically tmaps?","user":"UM8JUNJG7","ts":"1618198632.485300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"X/z0x","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"as in, broadcasting automatically tmaps?"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"795a36d0-0364-41ee-a586-2a4569967e5d","type":"message","text":"huh, interesting - I haven’t seen tmap before","user":"U011LUQ182G","ts":"1618198669.485600","team":"T68168MUP","edited":{"user":"U011LUQ182G","ts":"1618198692.000000"},"blocks":[{"type":"rich_text","block_id":"MmO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"huh, interesting - I haven’t seen tmap before"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"59a91f8e-2540-40c7-92f6-46e886e2fc9a","type":"message","text":"its in scimlbase","user":"UM8JUNJG7","ts":"1618198680.485800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"KNH=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"its in scimlbase"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"b44a8cc6-2a2a-47c0-895c-649c984e65d8","type":"message","text":"Gotcha, so not tmap in <https://github.com/jw3126/ThreadingTools.jl>?","user":"U011LUQ182G","ts":"1618198699.486100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"30N","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Gotcha, so not tmap in "},{"type":"link","url":"https://github.com/jw3126/ThreadingTools.jl"},{"type":"text","text":"?"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"2b866ac1-8cba-4d18-9e20-095cb90525f3","type":"message","text":"probably almost identical","user":"UM8JUNJG7","ts":"1618198710.486300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9p5","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"probably almost identical"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G","reactions":[{"name":"+1","users":["U011LUQ182G"],"count":1}]},{"client_msg_id":"49cb71d8-43f0-487b-8be2-4b36922921a1","type":"message","text":"It seems really slow","user":"U011LUQ182G","ts":"1618199267.488600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Buk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It seems really slow"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G","reactions":[{"name":"sweat_smile","users":["UM8JUNJG7"],"count":1}]},{"client_msg_id":"296017c0-2011-4cc0-ac9e-ca047ffb4538","type":"message","text":"```import SciMLBase:tmap\nu,v = ntuple(x-&gt;randn(1000),2)\nU = StructArray((u=u,v=v))\nf(U) = exp(U.u)*sin(U.v)\n\n@btime f.($U); #   12.092 μs (2 allocations: 7.97 KiB)\n@btime tmap($f,$U); # 438.346 μs (1055 allocations: 3.97 MiB)```","user":"U011LUQ182G","ts":"1618199378.488900","team":"T68168MUP","edited":{"user":"U011LUQ182G","ts":"1618199409.000000"},"blocks":[{"type":"rich_text","block_id":"vm8u","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"import SciMLBase:tmap\nu,v = ntuple(x->randn(1000),2)\nU = StructArray((u=u,v=v))\nf(U) = exp(U.u)*sin(U.v)\n\n@btime f.($U); #   12.092 μs (2 allocations: 7.97 KiB)\n@btime tmap($f,$U); # 438.346 μs (1055 allocations: 3.97 MiB)"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"1567fa36-c1e7-41b6-81c1-7cc48f907d07","type":"message","text":"oh wow that doesn't look great. im not sure where tmap actually gets used","user":"UM8JUNJG7","ts":"1618199421.489200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"LRI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh wow that doesn't look great. im not sure where tmap actually gets used"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"0b3e714d-bd1e-47cb-b356-e050fed44467","type":"message","text":"maybe open an issue? it could just be the overhead for spawn, right?","user":"UM8JUNJG7","ts":"1618199462.489600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1XAPV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"maybe open an issue? it could just be the overhead for spawn, right?"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G","reactions":[{"name":"+1","users":["U011LUQ182G"],"count":1}]},{"client_msg_id":"338946ad-d18b-42f9-a666-773c060ee54a","type":"message","text":"does it get better if you make the problem much bigger?","user":"UM8JUNJG7","ts":"1618199488.489900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"20v7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"does it get better if you make the problem much bigger?"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"0363d93f-e412-40f0-b23c-3f5f2e89faf4","type":"message","text":"let me check…","user":"U011LUQ182G","ts":"1618199570.490500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"080lO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"let me check…"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"e46660f0-69f9-48a3-9c89-b0a5bce0d8c1","type":"message","text":"for a 100k length vector,\n```  1.408 ms (3 allocations: 781.36 KiB) # broadcast f.(U)\n  97.911 ms (100118 allocations: 318.53 MiB) # tmap(f,U)```\nso I guess it got worse?","user":"U011LUQ182G","ts":"1618199707.491400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oLS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"for a 100k length vector,\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"  1.408 ms (3 allocations: 781.36 KiB) # broadcast f.(U)\n  97.911 ms (100118 allocations: 318.53 MiB) # tmap(f,U)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"so I guess it got worse?"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G","reactions":[{"name":"scream","users":["UM8JUNJG7"],"count":1}]},{"client_msg_id":"4097176d-ceab-4e91-bf4c-6142dc15fa5e","type":"message","text":"testing this version of tmap now <https://discourse.julialang.org/t/type-stable-threaded-map/24498/10?u=jlchan>","user":"U011LUQ182G","ts":"1618199713.491600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hBZ9Q","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"testing this version of tmap now "},{"type":"link","url":"https://discourse.julialang.org/t/type-stable-threaded-map/24498/10?u=jlchan"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G","reactions":[{"name":"+1","users":["UM8JUNJG7"],"count":1}]},{"client_msg_id":"b0e37f03-b987-4cac-800a-c672a8ff9dd0","type":"message","text":"yeah, it’s slower than broadcast too.\n```  1.463 ms (3 allocations: 781.36 KiB) # f.(U)\n  2.375 ms (527 allocations: 5.04 MiB) # SciMLBase.tmap\n  3.673 ms (559 allocations: 5.04 MiB) # ktf Transducers tmap```","user":"U011LUQ182G","ts":"1618199845.493000","team":"T68168MUP","edited":{"user":"U011LUQ182G","ts":"1618199885.000000"},"blocks":[{"type":"rich_text","block_id":"YO3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah, it’s slower than broadcast too.\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"  1.463 ms (3 allocations: 781.36 KiB) # f.(U)\n  2.375 ms (527 allocations: 5.04 MiB) # SciMLBase.tmap\n  3.673 ms (559 allocations: 5.04 MiB) # ktf Transducers tmap"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"86dd0c5c-0805-4c68-ba47-a3e0498c5a47","type":"message","text":"it could be all those individual allocations, i thought i saw an inplace tmap somewhere, if that isn't faster asymptotically then its definitely an issue","user":"UM8JUNJG7","ts":"1618199991.496300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jadX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it could be all those individual allocations, i thought i saw an inplace tmap somewhere, if that isn't faster asymptotically then its definitely an issue"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G","reactions":[{"name":"+1","users":["U011LUQ182G"],"count":1}]},{"client_msg_id":"b2b3e3bd-7e35-4632-beab-3c1192376cf3","type":"message","text":"yeah, I wondered about that too. Couldn’t find `tmap!` in SciMLBase, but will look around online for it later","user":"U011LUQ182G","ts":"1618200244.000400","team":"T68168MUP","edited":{"user":"U011LUQ182G","ts":"1618200265.000000"},"blocks":[{"type":"rich_text","block_id":"cRIS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah, I wondered about that too. Couldn’t find "},{"type":"text","text":"tmap!","style":{"code":true}},{"type":"text","text":" in SciMLBase, but will look around online for it later"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G","reactions":[{"name":"+1","users":["UM8JUNJG7"],"count":1}]},{"client_msg_id":"37f6b056-899c-4824-91f4-8d7be75e9a26","type":"message","text":"Threading would be bad on broadcast in the majority of cases.","user":"U69BL50BF","ts":"1618226368.036000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"K=f","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Threading would be bad on broadcast in the majority of cases."}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"23bea373-a2b2-4e3d-b421-4a73a8eb601d","type":"message","text":"I think your idea of threading overhead is off. This is very much expected.","user":"U69BL50BF","ts":"1618226387.036200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ACto9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think your idea of threading overhead is off. This is very much expected."}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"fd097a58-1548-4be3-998f-22e3e27349c0","type":"message","text":"If it was threading overhead, shouldn’t that get amortized for larger array sizes? Instead `tmap` goes from ~40x slower for a length 1000 array to ~100x slower for a length 100000 array.\n\nMoreover, just `@threads` + for loop gives me 4x speedup compared with broadcast.","user":"U011LUQ182G","ts":"1618228737.045900","team":"T68168MUP","edited":{"user":"U011LUQ182G","ts":"1618228830.000000"},"blocks":[{"type":"rich_text","block_id":"/Wg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If it was threading overhead, shouldn’t that get amortized for larger array sizes? Instead "},{"type":"text","text":"tmap","style":{"code":true}},{"type":"text","text":" goes from ~40x slower for a length 1000 array to ~100x slower for a length 100000 array.\n\nMoreover, just "},{"type":"text","text":"@threads","style":{"code":true}},{"type":"text","text":" + for loop gives me 4x speedup compared with broadcast."}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"8ded4f89-abc3-4825-b2ac-842cf038f081","type":"message","text":"`tmap` is just `@threads`?","user":"U69BL50BF","ts":"1618228832.046200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UA=c","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"tmap","style":{"code":true}},{"type":"text","text":" is just "},{"type":"text","text":"@threads","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G","reactions":[{"name":"today-i-learned","users":["U011LUQ182G"],"count":1}]},{"client_msg_id":"fb31e813-affc-4895-8178-20b1961fb0f5","type":"message","text":"OK, just tried starting from `SciMLBase: tmap` - it’s the `reduce(vcat,batch_data)` line that eats up all the time. Replacing that with `return batch_data` fixes things.\n\nMy use case just needs `return batch_data`. What is `reduce(vcat,batch_data)` for?","user":"U011LUQ182G","ts":"1618229367.046500","team":"T68168MUP","edited":{"user":"U011LUQ182G","ts":"1618229390.000000"},"blocks":[{"type":"rich_text","block_id":"gDPU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"OK, just tried starting from "},{"type":"text","text":"SciMLBase: tmap","style":{"code":true}},{"type":"text","text":" - it’s the "},{"type":"text","text":"reduce(vcat,batch_data)","style":{"code":true}},{"type":"text","text":" line that eats up all the time. Replacing that with "},{"type":"text","text":"return batch_data","style":{"code":true}},{"type":"text","text":" fixes things.\n\nMy use case just needs "},{"type":"text","text":"return batch_data","style":{"code":true}},{"type":"text","text":". What is "},{"type":"text","text":"reduce(vcat,batch_data)","style":{"code":true}},{"type":"text","text":" for?"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"967aefaa-61fc-4240-b6ae-54c4ded970e9","type":"message","text":"paste a link?","user":"U69BL50BF","ts":"1618229688.046800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MDJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"paste a link?"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"3dd1cd5e-1338-4fc7-9043-149196363bf2","type":"message","text":"oops - that would’ve been easier for you to find, my bad.\n\n<https://github.com/SciML/SciMLBase.jl/blob/03f3c62e4e6539ea57f0f51c77b85d6d44152dc0/src/ensemble/basic_ensemble_solve.jl#L232>","user":"U011LUQ182G","ts":"1618229956.047000","team":"T68168MUP","edited":{"user":"U011LUQ182G","ts":"1618229973.000000"},"blocks":[{"type":"rich_text","block_id":"jWL6T","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oops - that would’ve been easier for you to find, my bad.\n\n"},{"type":"link","url":"https://github.com/SciML/SciMLBase.jl/blob/03f3c62e4e6539ea57f0f51c77b85d6d44152dc0/src/ensemble/basic_ensemble_solve.jl#L232"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"3cd6bc0b-ef7a-470d-84b3-41372f0cf387","type":"message","text":"oh, that should be `tighten_container_eltype`","user":"U69BL50BF","ts":"1618230063.047300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Rsgr","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh, that should be "},{"type":"text","text":"tighten_container_eltype","style":{"code":true}}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"cc890a5a-89f4-4f9b-8c96-27e606359168","type":"message","text":"actually","user":"U69BL50BF","ts":"1618230073.047500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pa5nZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"actually"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"e6c692ed-f7dd-4f66-8bfe-862eb55bc2c0","type":"message","text":"it's just not needed at all because of the Core.return_type handling.","user":"U69BL50BF","ts":"1618230081.047700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"sgM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's just not needed at all because of the Core.return_type handling."}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"618d6e69-124f-49a3-af27-210abd680520","type":"message","text":"let's spawn the test suite and see what it says, but I don't think it's necessary.","user":"U69BL50BF","ts":"1618230136.047900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DP8E","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"let's spawn the test suite and see what it says, but I don't think it's necessary."}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"},{"client_msg_id":"42514390-e1fc-4461-b1ca-53498828fba6","type":"message","text":"<https://github.com/SciML/SciMLBase.jl/pull/50>","user":"U69BL50BF","ts":"1618230140.048100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"L1v","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://github.com/SciML/SciMLBase.jl/pull/50"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G","reactions":[{"name":"+1","users":["U011LUQ182G"],"count":1}]},{"client_msg_id":"c263110e-6d43-43d2-919f-4646ce1cbd20","type":"message","text":"Indeed our regression tests said it could be removed. Thanks.","user":"U69BL50BF","ts":"1618234635.051300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7QME","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Indeed our regression tests said it could be removed. Thanks."}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G","reactions":[{"name":"+1","users":["U011LUQ182G"],"count":1}]},{"client_msg_id":"936650fb-3256-48df-b3c6-c74e1d020ffb","type":"message","text":"Sweet, glad it was useful. Thanks for explaining","user":"U011LUQ182G","ts":"1618234854.051600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9chG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Sweet, glad it was useful. Thanks for explaining"}]}]}],"thread_ts":"1618198604.484800","parent_user_id":"U011LUQ182G"}]