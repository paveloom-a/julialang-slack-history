[{"client_msg_id":"31039e85-cb24-48de-95b3-3614c73b8c43","type":"message","text":"I also hope to clean up a lot of the type instability and make it more general wrt types, but am hitting a lot of box issues w/ captured variables in the integrand. Any general advice?","user":"UP95S4864","ts":"1616423388.117600","team":"T68168MUP","edited":{"user":"UP95S4864","ts":"1616423412.000000"},"blocks":[{"type":"rich_text","block_id":"6NH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I also hope to clean up a lot of the type instability and make it more general wrt types, but am hitting a lot of box issues w/ captured variables in the integrand. Any general advice?"}]}]}],"thread_ts":"1616423388.117600","reply_count":12,"reply_users_count":2,"latest_reply":"1616426024.131700","reply_users":["UM30MT6RF","UP95S4864"],"is_locked":false,"subscribed":false},{"client_msg_id":"6269f20a-302c-4cb9-af60-7323a24d57cf","type":"message","text":"If you have closures make sure all variables that closure captures are only assigned to once or wrap the closure in smthg like `let x=x; ... end`","user":"UM30MT6RF","ts":"1616424217.123100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2R2++","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If you have closures make sure all variables that closure captures are only assigned to once or wrap the closure in smthg like "},{"type":"text","text":"let x=x; ... end","style":{"code":true}}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"},{"client_msg_id":"4990f899-3341-4689-832b-bae07f48e54d","type":"message","text":"But what if you want to write to the variable?","user":"UP95S4864","ts":"1616424976.126600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kCU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But what if you want to write to the variable?"}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"},{"client_msg_id":"b686da57-1727-436f-b680-ba87372462e8","type":"message","text":"```function outer(x::AbstractArray{T}) where T\n    f = sin # in practice this would be solve()\n    A = Core.Compiler.return_type(f, (T,))[] \n    inner = function(y)\n        res = f(y)\n        push!(A, res)\n        return res\n    end\n    map(inner, x), A  # in practice map is a highel level funtion picking values of x, like hquadrature\nend```","user":"UP95S4864","ts":"1616424989.126900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"dh6py","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function outer(x::AbstractArray{T}) where T\n    f = sin # in practice this would be solve()\n    A = Core.Compiler.return_type(f, (T,))[] \n    inner = function(y)\n        res = f(y)\n        push!(A, res)\n        return res\n    end\n    map(inner, x), A  # in practice map is a highel level funtion picking values of x, like hquadrature\nend"}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"},{"client_msg_id":"3403ce0c-1650-463f-b63c-19af6da2c7b1","type":"message","text":"That should be fine, is there still boxing in this example?","user":"UM30MT6RF","ts":"1616425106.128800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"uqDm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That should be fine, is there still boxing in this example?"}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"},{"client_msg_id":"440724b5-103e-4545-92d3-ed6fdef1245d","type":"message","text":"Is this Ok b/c A is already heap allocated? There is no boxing here. I missed a part in my MWE. Highlighted below.","user":"UP95S4864","ts":"1616425261.130000","team":"T68168MUP","edited":{"user":"UP95S4864","ts":"1616425403.000000"},"blocks":[{"type":"rich_text","block_id":"EdYhJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is this Ok b/c A is already heap allocated? There is no boxing here. I missed a part in my MWE. Highlighted below."}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"},{"client_msg_id":"5a2c267f-23c4-439b-a1ac-382acd3e4f76","type":"message","text":"What about\n```function outer(x::AbstractArray{T}) where T\n    counter = 0\n    inner = function(y)\n        counter += 1\n        return y\n    end\n    map(inner, x), counter\nend```","user":"UP95S4864","ts":"1616425347.130200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ZDSg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What about\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function outer(x::AbstractArray{T}) where T\n    counter = 0\n    inner = function(y)\n        counter += 1\n        return y\n    end\n    map(inner, x), counter\nend"}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"},{"client_msg_id":"3a43f66b-c15a-4719-ac4f-3403ff5394b1","type":"message","text":"Here, counter is boxed, but if you use a `let`  block the counter returned by `outer`  will always be zero","user":"UP95S4864","ts":"1616425460.130500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kfde","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Here, counter is boxed, but if you use a "},{"type":"text","text":"let","style":{"code":true}},{"type":"text","text":"  block the counter returned by "},{"type":"text","text":"outer","style":{"code":true}},{"type":"text","text":"  will always be zero"}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"},{"client_msg_id":"9f790f0e-3299-419f-9c16-c4d133a9edb0","type":"message","text":"Yes, that's bad since you are reassigning `counter`. See <https://github.com/JuliaLang/julia/issues/15276|https://github.com/JuliaLang/julia/issues/15276>","user":"UM30MT6RF","ts":"1616425496.130700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"T5g","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes, that's bad since you are reassigning "},{"type":"text","text":"counter","style":{"code":true}},{"type":"text","text":". See "},{"type":"link","url":"https://github.com/JuliaLang/julia/issues/15276","text":"https://github.com/JuliaLang/julia/issues/15276"}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"},{"client_msg_id":"63dfb682-42db-4533-9fe5-a86d9512aca8","type":"message","text":"got it!","user":"UP95S4864","ts":"1616425590.130900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Za2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"got it!"}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"},{"client_msg_id":"05f60501-762f-4cf4-a96b-d096b4c186f8","type":"message","text":"For the first MWE above I'm also surprised by `@code_warntype` that `A`  is not inferred.","user":"UP95S4864","ts":"1616425656.131100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8=Bn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"For the first MWE above I'm also surprised by "},{"type":"text","text":"@code_warntype","style":{"code":true}},{"type":"text","text":" that "},{"type":"text","text":"A","style":{"code":true}},{"type":"text","text":"  is not inferred."}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"},{"client_msg_id":"1594f10f-24d0-4940-b3d5-a49e3ceaab53","type":"message","text":"Use `Core.Compiler.return_type(f, Tuple{T})` instead of `Core.Compiler.return_type(f, (T,))`. The tfunc is only specialized for the former case.","user":"UM30MT6RF","ts":"1616425921.131500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cvqX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Use "},{"type":"text","text":"Core.Compiler.return_type(f, Tuple{T})","style":{"code":true}},{"type":"text","text":" instead of "},{"type":"text","text":"Core.Compiler.return_type(f, (T,))","style":{"code":true}},{"type":"text","text":". The tfunc is only specialized for the former case."}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"},{"client_msg_id":"6f8dfa14-35df-4f7b-957a-322ea59b1221","type":"message","text":"This has been extremely helpful. Thank you!","user":"UP95S4864","ts":"1616426024.131700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FSoz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This has been extremely helpful. Thank you!"}]}]}],"thread_ts":"1616423388.117600","parent_user_id":"UP95S4864"}]