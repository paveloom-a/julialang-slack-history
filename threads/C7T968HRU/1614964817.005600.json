[{"client_msg_id":"2566e209-dfb8-4a05-a83f-a258e4d7d13f","type":"message","text":"I'm getting this error when trying to use a stiff solver (with autodiff) and `ForwardDiffSensitivity` :\n```Cannot determine ordering of Dual tags ForwardDiff.Tag{SciMLBase.TimeGradientWrapper{ODEFunction{true,LotkaVolterra{DiffEqBase.DiffCache{Array{Float64,1},Array{ForwardDiff.Dual{nothing,Float64,6},1}}},LinearAlgebra.UniformScaling{Bool},Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,typeof(SciMLBase.DEFAULT_OBSERVED),Nothing},Array{ForwardDiff.Dual{ODEFunction{true,LotkaVolterra{DiffEqBase.DiffCache{Array{Float64,1},Array{ForwardDiff.Dual{nothing,Float64,6},1}}},LinearAlgebra.UniformScaling{Bool},Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,typeof(SciMLBase.DEFAULT_OBSERVED),Nothing},Float64,6},1},Array{ForwardDiff.Dual{ODEFunction{true,LotkaVolterra{DiffEqBase.DiffCache{Array{Float64,1},Array{ForwardDiff.Dual{nothing,Float64,6},1}}},LinearAlgebra.UniformScaling{Bool},Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,typeof(SciMLBase.DEFAULT_OBSERVED),Nothing},Float64,6},1}},Float64} and ODEFunction{true,LotkaVolterra{DiffEqBase.DiffCache{Array{Float64,1},Array{ForwardDiff.Dual{nothing,Float64,6},1}}},LinearAlgebra.UniformScaling{Bool},Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,typeof(SciMLBase.DEFAULT_OBSERVED),Nothing}\n≺(::Type{T} where T, ::Type{T} where T) at dual.jl:49\n...```\nWhat does this mean?","user":"U01H36BUDJB","ts":"1614964817.005600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GcIh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm getting this error when trying to use a stiff solver (with autodiff) and "},{"type":"text","text":"ForwardDiffSensitivity","style":{"code":true}},{"type":"text","text":" :\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"Cannot determine ordering of Dual tags ForwardDiff.Tag{SciMLBase.TimeGradientWrapper{ODEFunction{true,LotkaVolterra{DiffEqBase.DiffCache{Array{Float64,1},Array{ForwardDiff.Dual{nothing,Float64,6},1}}},LinearAlgebra.UniformScaling{Bool},Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,typeof(SciMLBase.DEFAULT_OBSERVED),Nothing},Array{ForwardDiff.Dual{ODEFunction{true,LotkaVolterra{DiffEqBase.DiffCache{Array{Float64,1},Array{ForwardDiff.Dual{nothing,Float64,6},1}}},LinearAlgebra.UniformScaling{Bool},Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,typeof(SciMLBase.DEFAULT_OBSERVED),Nothing},Float64,6},1},Array{ForwardDiff.Dual{ODEFunction{true,LotkaVolterra{DiffEqBase.DiffCache{Array{Float64,1},Array{ForwardDiff.Dual{nothing,Float64,6},1}}},LinearAlgebra.UniformScaling{Bool},Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,typeof(SciMLBase.DEFAULT_OBSERVED),Nothing},Float64,6},1}},Float64} and ODEFunction{true,LotkaVolterra{DiffEqBase.DiffCache{Array{Float64,1},Array{ForwardDiff.Dual{nothing,Float64,6},1}}},LinearAlgebra.UniformScaling{Bool},Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,Nothing,typeof(SciMLBase.DEFAULT_OBSERVED),Nothing}\n≺(::Type{T} where T, ::Type{T} where T) at dual.jl:49\n..."}]},{"type":"rich_text_section","elements":[{"type":"text","text":"What does this mean?"}]}]}],"thread_ts":"1614964817.005600","reply_count":6,"reply_users_count":2,"latest_reply":"1614973367.015100","reply_users":["U69BL50BF","U01H36BUDJB"],"subscribed":false},{"client_msg_id":"03146bcf-3f18-422f-8d6e-afb734469201","type":"message","text":"Make an MWE. This is generally not hard to fix, but it's hard to narrow down.","user":"U69BL50BF","ts":"1614966692.011000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Zty=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Make an MWE. This is generally not hard to fix, but it's hard to narrow down."}]}]}],"thread_ts":"1614964817.005600","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"960af4c7-e0c2-4646-b86f-3990297a96d6","type":"message","text":"I have an MWE, but first just a sanity check, is it supported to use a solver with autodiff simultaneously with `ForwardDiffSensitivity` ?","user":"U01H36BUDJB","ts":"1614971179.013600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zR+Ua","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I have an MWE, but first just a sanity check, is it supported to use a solver with autodiff simultaneously with "},{"type":"text","text":"ForwardDiffSensitivity","style":{"code":true}},{"type":"text","text":" ?"}]}]}],"thread_ts":"1614964817.005600","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"1b664318-e318-4b14-a1cc-c46db242e339","type":"message","text":"and similarly, is it permissible to use a solver with autodiff (I guess it always uses ForwardDiff?) with `InterpolatingAdjoint` or `QuadratureAdjoint` ?","user":"U01H36BUDJB","ts":"1614971299.013800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zLXz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and similarly, is it permissible to use a solver with autodiff (I guess it always uses ForwardDiff?) with "},{"type":"text","text":"InterpolatingAdjoint","style":{"code":true}},{"type":"text","text":" or "},{"type":"text","text":"QuadratureAdjoint","style":{"code":true}},{"type":"text","text":" ?"}]}]}],"thread_ts":"1614964817.005600","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"13b8d7e7-d65a-4042-acdd-0b8e78efc3d7","type":"message","text":"it should, tha'ts just a tag error","user":"U69BL50BF","ts":"1614971307.014000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ZB1bx","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it should, tha'ts just a tag error"}]}]}],"thread_ts":"1614964817.005600","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"88881435-861c-41ac-a1be-dbb8309c510d","type":"message","text":"```using DiffEqFlux, DiffEqSensitivity, Flux, OrdinaryDiffEq, Zygote, Test #using Plots\nusing DiffEqBase: get_tmp, dualcache\nusing ComponentArrays\nusing Parameters\nusing ForwardDiff\nusing ReverseDiff\n\np = ComponentArray(lvpara=ComponentArray(α=2.2,β=1.0,δ=2.0,γ=0.4),a=1.0,b=1.0)\nu0 = ComponentArray(state=ComponentArray(x=1.0,y=1.0))\nax_p = getaxes(p)\nax_u = getaxes(u0)\n\nchunk_size(dual::Type{ForwardDiff.Dual{T,V,N}}) where {T,V,N} = N\nselect(a::AbstractArray, u::AbstractArray) = a\nselect(dc::DiffEqBase.DiffCache, u) = get_tmp(dc,u)\n\nstruct LotkaVolterra{T}\n  d::T\nend\n\nfunction (lv::LotkaVolterra)(du,u_,p,t)\n  #@assert chunk_size(eltype(u)) == 2 \"found chunk size of $(chunk_size(eltype(u))) for $(typeof(u))\"\n  #d = get_tmp(d_cache, u)\n  u = ComponentArray(u_,ax_u)\n  p = ComponentArray(p,ax_p)\n  @unpack x,y = u.state\n  @unpack lvpara, a, b = p\n  @unpack α, β, δ, γ = lvpara\n  d = select(lv.d,u)\n  d[1] = a^2+b^2\n  d[2] = b^2-a^2\n  du[1] = dx = (α - β*y)x + d[1]\n  du[2] = dy = (δ*x - γ)y + d[2]\nend\nu0 = Array(u0)\np = Array(p)\nlv = LotkaVolterra(dualcache(zeros(2),Val{6}))\nprob = ODEProblem(lv,u0,(0.0,1.0),p)\nfunction predict_rd(p)\n  Array(solve(prob,Rosenbrock23(chunk_size=6),dt=0.01,p=p,saveat=0.1,reltol=1e-4,sensealg=ForwardDiffSensitivity()))\nend\nloss_rd(p) = sum(abs2,x-1 for x in predict_rd(p))\n\nopt = ADAM(0.1)\ncb = function (p,l,pred)\n  display(loss_rd(p))\n  #display(plot(solve(remake(prob,p=p),Tsit5(),saveat=0.1),ylim=(0,6)))\nend\n\n@time res = DiffEqFlux.sciml_train(loss_rd, p, opt, maxiters=100)```","user":"U01H36BUDJB","ts":"1614973331.014900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"WjGXQ","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using DiffEqFlux, DiffEqSensitivity, Flux, OrdinaryDiffEq, Zygote, Test #using Plots\nusing DiffEqBase: get_tmp, dualcache\nusing ComponentArrays\nusing Parameters\nusing ForwardDiff\nusing ReverseDiff\n\np = ComponentArray(lvpara=ComponentArray(α=2.2,β=1.0,δ=2.0,γ=0.4),a=1.0,b=1.0)\nu0 = ComponentArray(state=ComponentArray(x=1.0,y=1.0))\nax_p = getaxes(p)\nax_u = getaxes(u0)\n\nchunk_size(dual::Type{ForwardDiff.Dual{T,V,N}}) where {T,V,N} = N\nselect(a::AbstractArray, u::AbstractArray) = a\nselect(dc::DiffEqBase.DiffCache, u) = get_tmp(dc,u)\n\nstruct LotkaVolterra{T}\n  d::T\nend\n\nfunction (lv::LotkaVolterra)(du,u_,p,t)\n  #@assert chunk_size(eltype(u)) == 2 \"found chunk size of $(chunk_size(eltype(u))) for $(typeof(u))\"\n  #d = get_tmp(d_cache, u)\n  u = ComponentArray(u_,ax_u)\n  p = ComponentArray(p,ax_p)\n  @unpack x,y = u.state\n  @unpack lvpara, a, b = p\n  @unpack α, β, δ, γ = lvpara\n  d = select(lv.d,u)\n  d[1] = a^2+b^2\n  d[2] = b^2-a^2\n  du[1] = dx = (α - β*y)x + d[1]\n  du[2] = dy = (δ*x - γ)y + d[2]\nend\nu0 = Array(u0)\np = Array(p)\nlv = LotkaVolterra(dualcache(zeros(2),Val{6}))\nprob = ODEProblem(lv,u0,(0.0,1.0),p)\nfunction predict_rd(p)\n  Array(solve(prob,Rosenbrock23(chunk_size=6),dt=0.01,p=p,saveat=0.1,reltol=1e-4,sensealg=ForwardDiffSensitivity()))\nend\nloss_rd(p) = sum(abs2,x-1 for x in predict_rd(p))\n\nopt = ADAM(0.1)\ncb = function (p,l,pred)\n  display(loss_rd(p))\n  #display(plot(solve(remake(prob,p=p),Tsit5(),saveat=0.1),ylim=(0,6)))\nend\n\n@time res = DiffEqFlux.sciml_train(loss_rd, p, opt, maxiters=100)"}]}]}],"thread_ts":"1614964817.005600","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"7099ab14-f758-4fce-a625-7c0a0b38f306","type":"message","text":"weirdly, with `ImplicitEuler`  it fails with a chunk size (reinterpret) error, implying that `ImplicitEuler` ignores the `chunk_size` argument.","user":"U01H36BUDJB","ts":"1614973367.015100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YfX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"weirdly, with "},{"type":"text","text":"ImplicitEuler","style":{"code":true}},{"type":"text","text":"  it fails with a chunk size (reinterpret) error, implying that "},{"type":"text","text":"ImplicitEuler","style":{"code":true}},{"type":"text","text":" ignores the "},{"type":"text","text":"chunk_size","style":{"code":true}},{"type":"text","text":" argument."}]}]}],"thread_ts":"1614964817.005600","parent_user_id":"U01H36BUDJB"}]