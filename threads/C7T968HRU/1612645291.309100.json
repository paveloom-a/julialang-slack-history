[{"client_msg_id":"654c55a7-d953-458c-a9f0-2bf45084b50a","type":"message","text":"Two questions: (1) I'm seeing a performance drop of almost 50x when using ArrayPartition as the state variable, even with no problems from @code_warntype. Is this normal/expected? And (2) Is there a standard, performant way to couple PDEs together when the discretized grid sizes are different?","user":"U01H36BUDJB","ts":"1612645291.309100","team":"T68168MUP","edited":{"user":"U01H36BUDJB","ts":"1612645364.000000"},"blocks":[{"type":"rich_text","block_id":"+=8F0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Two questions: (1) I'm seeing a performance drop of almost 50x when using ArrayPartition as the state variable, even with no problems from @code_warntype. Is this normal/expected? And (2) Is there a standard, performant way to couple PDEs together when the discretized grid sizes are different?"}]}]}],"thread_ts":"1612645291.309100","reply_count":84,"reply_users_count":2,"latest_reply":"1612719335.336500","reply_users":["U69BL50BF","U01H36BUDJB"],"subscribed":false},{"client_msg_id":"9b4b33a9-e925-489d-ae13-4eda7bc05092","type":"message","text":"interesting. I know it's not going to be as efficient as just using views on a single array, but that is much larger than I expected, like 2x to 4x would be in the range I recall.","user":"U69BL50BF","ts":"1612652560.311800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"i=x","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"interesting. I know it's not going to be as efficient as just using views on a single array, but that is much larger than I expected, like 2x to 4x would be in the range I recall."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"cab6de39-3206-4a6a-b75f-07205a1e5b82","type":"message","text":"Do you have an MWE for this?","user":"U69BL50BF","ts":"1612652566.312000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"IClX1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Do you have an MWE for this?"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"ccd4fcb5-d0f1-4a5f-a10e-0c7885470f30","type":"message","text":"I would try ComponentArrays.jl here.","user":"U69BL50BF","ts":"1612652572.312200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"88yo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I would try ComponentArrays.jl here."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"40c039f9-e8e3-4f06-b017-ef21bf8fa5df","type":"message","text":"I'll have to clean up the code a bit, but yes I have a MWE with the heat equation.","user":"U01H36BUDJB","ts":"1612655445.313200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xSod","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'll have to clean up the code a bit, but yes I have a MWE with the heat equation."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"e2cf6179-5803-4f40-b811-11325d5264d5","type":"message","text":"Funny, I just implemented a much less fully featured version of ComponentArrays for myself to deal with flattening parameters. I didn't know that package existed!","user":"U01H36BUDJB","ts":"1612655489.313400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ORQi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Funny, I just implemented a much less fully featured version of ComponentArrays for myself to deal with flattening parameters. I didn't know that package existed!"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"098a46ed-3143-452d-ae4b-c8789a528007","type":"message","text":"it's a great package.","user":"U69BL50BF","ts":"1612655519.313600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"y5C04","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's a great package."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"936dd6ff-6ca1-43c6-9eb2-a22e051842a7","type":"message","text":"We need to use it in tutorials more","user":"U69BL50BF","ts":"1612655523.313800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nEhG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"We need to use it in tutorials more"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"aeabc273-9f6f-4022-ba91-f6e8c3ce861f","type":"message","text":"it kind of supersceded MultiScaleArrays and ArrayPartition for this purpose when it came out.","user":"U69BL50BF","ts":"1612655538.314000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0y0W","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it kind of supersceded MultiScaleArrays and ArrayPartition for this purpose when it came out."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"e6fff61c-5e48-4e47-8789-fb0dcc63f2e0","type":"message","text":"does it have a smaller footprint?","user":"U01H36BUDJB","ts":"1612655559.314200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"uV3Er","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"does it have a smaller footprint?"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"102728f6-663e-49d9-b7dc-54cf532743f2","type":"message","text":"I mean I'm surprised ArrayPartition has such a huge effect considering that it's type stable...","user":"U01H36BUDJB","ts":"1612655586.314400","team":"T68168MUP","edited":{"user":"U01H36BUDJB","ts":"1612655598.000000"},"blocks":[{"type":"rich_text","block_id":"u4m","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I mean I'm surprised ArrayPartition has such a huge effect considering that it's type stable..."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"5bf473cd-da91-422c-a340-c994326bcdb3","type":"message","text":"I'm kind of surprised by the cost","user":"U69BL50BF","ts":"1612655634.314700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"H0JZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm kind of surprised by the cost"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"fd75232c-bca2-4b74-8bda-2ec92ed3ba38","type":"message","text":"that's why I'd like to take a look","user":"U69BL50BF","ts":"1612655639.314900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"WrkX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that's why I'd like to take a look"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"26cf9e07-733a-4b38-8bf0-b3e7e7cb72f1","type":"message","text":"It might be because of the broadcast overload not constant proping, it might because of the linear algebra having to transform","user":"U69BL50BF","ts":"1612655661.315100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=cgmq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It might be because of the broadcast overload not constant proping, it might because of the linear algebra having to transform"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"b30b8958-70fd-4f09-a2d9-e61005a3f033","type":"message","text":"it's hard to tell","user":"U69BL50BF","ts":"1612655664.315300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xunf","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's hard to tell"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"54a96479-8183-4726-b7bf-513349072ae3","type":"message","text":"if you can generate a quick profile that would be great.","user":"U69BL50BF","ts":"1612655676.315500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"k5=3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if you can generate a quick profile that would be great."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"6c3ba906-1319-4852-a173-10c574e92df3","type":"message","text":"I was also testing Unitful alongside it, so I'll make sure to remove that as well. That also seems to have a significant cost with ArrayPartition but has low overhead on a normal Array with everything typed as the same unit.","user":"U01H36BUDJB","ts":"1612655842.315700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"r/HM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I was also testing Unitful alongside it, so I'll make sure to remove that as well. That also seems to have a significant cost with ArrayPartition but has low overhead on a normal Array with everything typed as the same unit."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"73346444-7aa0-4f38-b76f-ee7567db09b5","type":"message","text":"But that makes sense, I guess, because it would potentially make ArrayPartition type unstable to mix units, depending on how you access it.","user":"U01H36BUDJB","ts":"1612655883.315900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5gNG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But that makes sense, I guess, because it would potentially make ArrayPartition type unstable to mix units, depending on how you access it."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"d38e3c0e-fdc7-4bc5-aed0-07ed52147d3e","type":"message","text":"yes, it will be badly type unstable, which is why I don't suggest it anymore. I think we need an entirely new units package, so I don't recommend it at all.","user":"U69BL50BF","ts":"1612656093.316100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"HKX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yes, it will be badly type unstable, which is why I don't suggest it anymore. I think we need an entirely new units package, so I don't recommend it at all."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"0642b697-fd81-48c0-97d0-3edc4a97872c","type":"message","text":"```using DifferentialEquations, OrdinaryDiffEq, DiffEqOperators\nusing BenchmarkTools\nusing RecursiveArrayTools\nusing FastClosures\n\nconst nknots = 100\nconst h = 1.0/(nknots+1)\nt0 = 0.0\nt1 = 1.0\n\nfunction _f(du,u,p,t)\n  du .= zero(eltype(u))\n  u₃ = @view u[3:end]\n  u₂ = @view u[2:end-1]\n  u₁ = @view u[1:end-2]\n  @. du[2:end-1] = ((u₃ - 2*u₂ + u₁)/h^2.0)\n  nothing\nend\n\nfunction f(du,u,p,t)\n  _f(du.x[1],u.x[1],p,t)\n  _f(du.x[2],u.x[2],p,t)\nend\n\nA = randn(200)\nu0 = ArrayPartition(A[1:100],A[101:200])\nprob = ODEProblem(f, u0, (t0, t1))\nsol = @btime solve(prob, Tsit5(), saveat=0.2)\n\nfunction f(du,u,p,t)\n  _f(du[1:100],u[1:100],p,t)\n  _f(du[101:200],u[101:200],p,t)\nend\n\nu0 = A\nprob = ODEProblem(f, u0, (t0, t1))\nsol = @btime solve(prob, Tsit5(), saveat=0.2)```\nHere's the MWE. If you use the second version of `f` with the linear indices hard-coded, then the overhead is just 2-4x like you said. The issue seems to be with accessing the nested arrays via `.x` , but maybe this is expected?","user":"U01H36BUDJB","ts":"1612656540.316300","team":"T68168MUP","edited":{"user":"U01H36BUDJB","ts":"1612657261.000000"},"blocks":[{"type":"rich_text","block_id":"DH0","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using DifferentialEquations, OrdinaryDiffEq, DiffEqOperators\nusing BenchmarkTools\nusing RecursiveArrayTools\nusing FastClosures\n\nconst nknots = 100\nconst h = 1.0/(nknots+1)\nt0 = 0.0\nt1 = 1.0\n\nfunction _f(du,u,p,t)\n  du .= zero(eltype(u))\n  u₃ = @view u[3:end]\n  u₂ = @view u[2:end-1]\n  u₁ = @view u[1:end-2]\n  @. du[2:end-1] = ((u₃ - 2*u₂ + u₁)/h^2.0)\n  nothing\nend\n\nfunction f(du,u,p,t)\n  _f(du.x[1],u.x[1],p,t)\n  _f(du.x[2],u.x[2],p,t)\nend\n\nA = randn(200)\nu0 = ArrayPartition(A[1:100],A[101:200])\nprob = ODEProblem(f, u0, (t0, t1))\nsol = @btime solve(prob, Tsit5(), saveat=0.2)\n\nfunction f(du,u,p,t)\n  _f(du[1:100],u[1:100],p,t)\n  _f(du[101:200],u[101:200],p,t)\nend\n\nu0 = A\nprob = ODEProblem(f, u0, (t0, t1))\nsol = @btime solve(prob, Tsit5(), saveat=0.2)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Here's the MWE. If you use the second version of "},{"type":"text","text":"f","style":{"code":true}},{"type":"text","text":" with the linear indices hard-coded, then the overhead is just 2-4x like you said. The issue seems to be with accessing the nested arrays via "},{"type":"text","text":".x","style":{"code":true}},{"type":"text","text":" , but maybe this is expected?"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"c14e9d28-2e77-4935-b366-09a19ac4da1d","type":"message","text":"```# with ArrayPartition, first f\n86.704 ms (23382 allocations: 3.24 MiB)\n# plain array, second f\n31.650 μs (184 allocations: 159.30 KiB)\n# ArrayPartition second f\n70.867 μs (226 allocations: 160.95 KiB)```","user":"U01H36BUDJB","ts":"1612656630.316600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"O/C","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"# with ArrayPartition, first f\n86.704 ms (23382 allocations: 3.24 MiB)\n# plain array, second f\n31.650 μs (184 allocations: 159.30 KiB)\n# ArrayPartition second f\n70.867 μs (226 allocations: 160.95 KiB)"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"2faca9fe-9034-4848-ad7d-f0213993735f","type":"message","text":"yeah the linear indices are slow.","user":"U69BL50BF","ts":"1612656653.316800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nbm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah the linear indices are slow."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"23b327f9-d37a-4b44-88ca-f1f577fc05e5","type":"message","text":"It's made to only use them as a fallback","user":"U69BL50BF","ts":"1612656660.317000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"g2O","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It's made to only use them as a fallback"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"a509c9d2-1d2b-4e8a-a0ae-58f09a42f032","type":"message","text":"broadcast doesn't use them, and it's assumed user code won't (otherwise, use an array)","user":"U69BL50BF","ts":"1612656679.317200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"h8cO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"broadcast doesn't use them, and it's assumed user code won't (otherwise, use an array)"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"1cc9ea67-705f-4828-95fb-96727f7b8517","type":"message","text":"but then to make linear algebra faster, it converts to an array before doing linalg, which is where the 2x-4x can come from.","user":"U69BL50BF","ts":"1612656701.317400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"LXnsi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but then to make linear algebra faster, it converts to an array before doing linalg, which is where the 2x-4x can come from."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"9bfebd30-a256-49e5-8114-2bc1ec41ed31","type":"message","text":"yeah then I think ComponentArrays is more what I need","user":"U01H36BUDJB","ts":"1612656704.317600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"mAT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah then I think ComponentArrays is more what I need"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"952b2ddb-188c-4023-b5c1-b5e8fd8ac3f5","type":"message","text":"Yeah, ComponentArrays have an actual array underneath, so that fixes the linalg in a nice way.","user":"U69BL50BF","ts":"1612656720.317800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ta4S","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yeah, ComponentArrays have an actual array underneath, so that fixes the linalg in a nice way."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"6b9836bd-6d64-412e-9542-cd7e2ee4b6d8","type":"message","text":"MultiScaleArrays seemed like a good fit too at first","user":"U01H36BUDJB","ts":"1612656770.318000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ryo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"MultiScaleArrays seemed like a good fit too at first"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"efe02a97-59d6-4c62-ba02-15f6d09f608f","type":"message","text":"but it had pretty huge overhead as well, worse than ArrayPartition","user":"U01H36BUDJB","ts":"1612656784.318200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"p3u","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but it had pretty huge overhead as well, worse than ArrayPartition"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"66e4ba2d-4330-470f-8dfa-e75bee6f6b3c","type":"message","text":"and also the structure doesn't quite fit nicely with what I'm trying to do","user":"U01H36BUDJB","ts":"1612656801.318400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cbN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and also the structure doesn't quite fit nicely with what I'm trying to do"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"54e725bd-d642-4c7c-97a1-9b942a54e591","type":"message","text":"that's why the 2021 approach I'm doing is ModelingToolkit","user":"U69BL50BF","ts":"1612656822.318600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Rwt23","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that's why the 2021 approach I'm doing is ModelingToolkit"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"ac905701-72dc-4f12-9c28-c8ea94dacf0f","type":"message","text":"build the system symbolically, but compile it down to something on arrays.","user":"U69BL50BF","ts":"1612656830.318800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"KLp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"build the system symbolically, but compile it down to something on arrays."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"ed2ccc5b-a882-41d7-a587-e5b3b9770d6c","type":"message","text":"mixing abstraction with computational details (i.e. splitting into different arrays to match user structure) doesn't lead to great performance","user":"U69BL50BF","ts":"1612656858.319000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=IF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"mixing abstraction with computational details (i.e. splitting into different arrays to match user structure) doesn't lead to great performance"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"ab70c9a0-45e3-4061-b62e-b4901c31f1dd","type":"message","text":"except in weird cases","user":"U69BL50BF","ts":"1612656862.319200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"74zlH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"except in weird cases"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"ae3b6590-baff-4613-8f65-d62db9dd16f9","type":"message","text":"that would certainly be nice, but I have trouble believing it will work for complicated, multi-scale models...?","user":"U01H36BUDJB","ts":"1612656870.319400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"sZY85","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that would certainly be nice, but I have trouble believing it will work for complicated, multi-scale models...?"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"7f28cf1c-c2b1-47d7-923d-183dda589ad0","type":"message","text":"MultiScaleArrays are the best way to have models that change size all of the time.","user":"U69BL50BF","ts":"1612656873.319600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ND2+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"MultiScaleArrays are the best way to have models that change size all of the time."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"933b3cd3-c529-4e34-a167-7ac9e0ec804d","type":"message","text":"&gt; that would certainly be nice, but I have trouble believing it will work for complicated, multi-scale models...?\nDefinitely not the case. Building an 8000 equation model is relatively straightforward from our tests :wink:","user":"U69BL50BF","ts":"1612656903.319800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1og","elements":[{"type":"rich_text_quote","elements":[{"type":"text","text":"that would certainly be nice, but I have trouble believing it will work for complicated, multi-scale models...?"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Definitely not the case. Building an 8000 equation model is relatively straightforward from our tests "},{"type":"emoji","name":"wink"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"384348e2-7c60-44fe-ae3b-eb09b9018442","type":"message","text":"Also it lets you symbolically simplify it down, so you can do a bunch of tricks to reduce it down to like 100 equations, solve those, and lazily reconstruct the others.","user":"U69BL50BF","ts":"1612656930.320000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1hcDY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Also it lets you symbolically simplify it down, so you can do a bunch of tricks to reduce it down to like 100 equations, solve those, and lazily reconstruct the others."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"dffb2f90-9e2d-4e1a-9db0-d00a42c0dbf3","type":"message","text":"well, what I mean is a system where you have different layers/scales and each layer might have different dynamics, etc.","user":"U01H36BUDJB","ts":"1612656934.320200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qZZa","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"well, what I mean is a system where you have different layers/scales and each layer might have different dynamics, etc."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"4b59982c-4d7c-48c5-af3e-4309c164208c","type":"message","text":"That's my problem","user":"U01H36BUDJB","ts":"1612656942.320400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0LkT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That's my problem"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"3a78ce3f-ae13-4ad5-a73e-eb74d24a2fb3","type":"message","text":"I think the component-based system is one of the quickest ways to build it out.","user":"U69BL50BF","ts":"1612656973.320800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YaVY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think the component-based system is one of the quickest ways to build it out."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"fb902c97-88a2-4f9a-b64b-ee1ecac7d829","type":"message","text":"yeah I'd like to give ModelingToolkit another try","user":"U01H36BUDJB","ts":"1612657019.321200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fUg1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah I'd like to give ModelingToolkit another try"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"5aa74aae-c810-40fe-8f4b-98103f3964dd","type":"message","text":"what I'm mentioning though isn't documented right now","user":"U69BL50BF","ts":"1612657037.321400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7rCn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"what I'm mentioning though isn't documented right now"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"aa6591d7-dfbb-4cd7-9d38-d1b00993f87d","type":"message","text":"we should release this portion of it in about a month.","user":"U69BL50BF","ts":"1612657047.321600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"c5o","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"we should release this portion of it in about a month."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"945bcd24-df4b-4304-8053-e86f36a264cc","type":"message","text":"but I had to give up on it for now, partially due the MOL bug and partially because it didn't seem to be possible to do what I wanted at present time","user":"U01H36BUDJB","ts":"1612657053.321800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QvS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but I had to give up on it for now, partially due the MOL bug and partially because it didn't seem to be possible to do what I wanted at present time"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"b1013361-ce00-41bf-87f7-06be9ce3b59d","type":"message","text":"oh I don't mean the MOL stuff","user":"U69BL50BF","ts":"1612657070.322000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3C7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh I don't mean the MOL stuff"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"603b15eb-fb1c-48e2-a8a7-f69b32d77602","type":"message","text":"I mean the direct ODE component-based stuff.","user":"U69BL50BF","ts":"1612657076.322200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"A+U","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I mean the direct ODE component-based stuff."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"3e289a32-9c70-4819-9ffd-9f4a76fa35a4","type":"message","text":"yeah I know","user":"U01H36BUDJB","ts":"1612657078.322400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1HS/x","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah I know"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"5c8cd7ec-7570-4e95-ad8d-4b8073e91802","type":"message","text":"that's separate","user":"U01H36BUDJB","ts":"1612657081.322600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"18av5","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that's separate"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"43ae92e6-6418-43e1-989b-72e63a5cc000","type":"message","text":"oh also I would need the ability to express non-linear diffusion","user":"U01H36BUDJB","ts":"1612657200.322800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Nt9a","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh also I would need the ability to express non-linear diffusion"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"f1852e55-d3ba-445a-9aa4-1e76da5b208f","type":"message","text":"can't remember if that's possible or not","user":"U01H36BUDJB","ts":"1612657206.323000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"whth","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"can't remember if that's possible or not"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"b495c5f6-df98-4c13-aa75-503759b427f2","type":"message","text":"on the ODE component-based stuff? Yeah you'd do it manually.","user":"U69BL50BF","ts":"1612657688.323400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MudVd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"on the ODE component-based stuff? Yeah you'd do it manually."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"f8798d6f-3a5b-48f7-aac0-05d7ce46b412","type":"message","text":"Looks like ComponentArrays is just as slow as ArrayPartition on the same example... almost 70 ms on the same example as above. If you have to use the linear indices (i.e. `u[1:100]` ) in order for it to be fast, what's the point of using it in the first place? I thought the point was so you could access the array by component.","user":"U01H36BUDJB","ts":"1612700590.324200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"AVJG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Looks like ComponentArrays is just as slow as ArrayPartition on the same example... almost 70 ms on the same example as above. If you have to use the linear indices (i.e. "},{"type":"text","text":"u[1:100]","style":{"code":true}},{"type":"text","text":" ) in order for it to be fast, what's the point of using it in the first place? I thought the point was so you could access the array by component."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"6feb5b42-2c70-469b-a8ae-1628efd2515d","type":"message","text":"I would be ok with the performance hit being 2-3x, but going from microseconds to milliseconds on a simple example is unacceptable.","user":"U01H36BUDJB","ts":"1612700637.324400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"o6M","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I would be ok with the performance hit being 2-3x, but going from microseconds to milliseconds on a simple example is unacceptable."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"35dfd996-a480-4c24-a400-4fd8f59e5ddc","type":"message","text":"Is the problem maybe taking views of views? I remember when I was testing with the plain array, there was a similar performance hit when using views at the top level (i.e. taking a view of a view in `_f` ) vs. just using slices at the top level.","user":"U01H36BUDJB","ts":"1612700864.324600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3o7kV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is the problem maybe taking views of views? I remember when I was testing with the plain array, there was a similar performance hit when using views at the top level (i.e. taking a view of a view in "},{"type":"text","text":"_f","style":{"code":true}},{"type":"text","text":" ) vs. just using slices at the top level."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"ab08c4e0-c6a1-4c2e-8dc0-24044b1e65b4","type":"message","text":"i.e. in this example:\n```function f_comp(du,u,p,t)\n    @unpack a,b,c = u\n    _f(du.a,a,p,t)\n    _f(du.b,b,p,t)\n    _f(du.c,c,p,t)\nend\n\nfunction f_linear(du,u,p,t)\n    du1, u1 = du[1:100], u[1:100]\n    du2, u2 = du[101:200], u[101:200]\n    du3, u3 = du[201:300], u[201:300]\n    _f(du1,u1,p,t)\n    _f(du2,u2,p,t)\n    _f(du3,u3,p,t)\nend```\nthe second function `f_linear`  is several orders of magnitude faster (&gt;800x) and makes far fewer allocations.","user":"U01H36BUDJB","ts":"1612701979.324800","team":"T68168MUP","edited":{"user":"U01H36BUDJB","ts":"1612702044.000000"},"blocks":[{"type":"rich_text","block_id":"I/30","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"i.e. in this example:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function f_comp(du,u,p,t)\n    @unpack a,b,c = u\n    _f(du.a,a,p,t)\n    _f(du.b,b,p,t)\n    _f(du.c,c,p,t)\nend\n\nfunction f_linear(du,u,p,t)\n    du1, u1 = du[1:100], u[1:100]\n    du2, u2 = du[101:200], u[101:200]\n    du3, u3 = du[201:300], u[201:300]\n    _f(du1,u1,p,t)\n    _f(du2,u2,p,t)\n    _f(du3,u3,p,t)\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"the second function "},{"type":"text","text":"f_linear","style":{"code":true}},{"type":"text","text":"  is several orders of magnitude faster (>800x) and makes far fewer allocations."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"8ad8d416-ce41-4755-83a2-42fcfb21342a","type":"message","text":"```function f(du,u,p,t)\n    du1, u1 = (@view du[1:100]),@view u[1:100]\n    du2, u2 = (@view du[101:200]),@view u[101:200]\n    du3, u3 = (@view du[201:300]),@view u[201:300]\n    _f(du1,u1,p,t)\n    _f(du2,u2,p,t)\n    _f(du3,u3,p,t)\nend```\nDefinitely has something to do with views-of-views. This is just as slow. I am not able to reproduce this, though, independent of `OrdinaryDiffEq` . Views of views seem to be faster in other contexts.","user":"U01H36BUDJB","ts":"1612704510.325100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"b/u64","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function f(du,u,p,t)\n    du1, u1 = (@view du[1:100]),@view u[1:100]\n    du2, u2 = (@view du[101:200]),@view u[101:200]\n    du3, u3 = (@view du[201:300]),@view u[201:300]\n    _f(du1,u1,p,t)\n    _f(du2,u2,p,t)\n    _f(du3,u3,p,t)\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Definitely has something to do with views-of-views. This is just as slow. I am not able to reproduce this, though, independent of "},{"type":"text","text":"OrdinaryDiffEq","style":{"code":true}},{"type":"text","text":" . Views of views seem to be faster in other contexts."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"78677025-c7b1-4366-8e81-0b5fed1758c6","type":"message","text":"Interesting, never done that before I think","user":"U69BL50BF","ts":"1612709236.326300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"I12","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Interesting, never done that before I think"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"41f1b7f2-dc16-4cad-97df-49be06a924e5","type":"message","text":"Do you have any ideas as to why using views causes this problem with `DifferentialEquations.jl`? Or how to get around it? It's kind of a significant roadblock for me at the moment.","user":"U01H36BUDJB","ts":"1612710650.326500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cKe","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Do you have any ideas as to why using views causes this problem with `DifferentialEquations.jl`? Or how to get around it? It's kind of a significant roadblock for me at the moment."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"a1b2d06a-5e1a-4d61-8333-c75426e7a9d7","type":"message","text":"this function itself is fine?","user":"U69BL50BF","ts":"1612710704.326700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"bxPtm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"this function itself is fine?"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"47b6536a-ed73-4411-98fa-cf73d8715acd","type":"message","text":"I would think the issue is the two functions","user":"U69BL50BF","ts":"1612710710.326900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"J1t6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I would think the issue is the two functions"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"a5611b89-10cc-46d6-b2b4-7a5817410c83","type":"message","text":"if it doesn't inline then it'll allocate","user":"U69BL50BF","ts":"1612710715.327100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yPX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if it doesn't inline then it'll allocate"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"1c9646e2-5c90-419c-8c7e-500d1cb7f0e1","type":"message","text":"Try `@inline _f(...) =` ","user":"U69BL50BF","ts":"1612710728.327300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Z8uwP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Try "},{"type":"text","text":"@inline _f(...) = ","style":{"code":true}}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"5d745539-1769-4dce-b700-8bdd79163457","type":"message","text":"Oh interesting. Why does it allocate?","user":"U01H36BUDJB","ts":"1612710754.327500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oiE6u","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Oh interesting. Why does it allocate?"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"df2dff0e-6862-43e2-9fff-af88c01ce0e8","type":"message","text":"because it might break the escape analysis","user":"U69BL50BF","ts":"1612710881.327700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"IGnyr","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"because it might break the escape analysis"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"19c1059c-1ee7-49c1-aefd-aa2cc3c8ad74","type":"message","text":"No luck with `@inline` , still slow. Here's the inner function for reference. Maybe I made a mistake..?\n```@inline function _f(du,u,p,t)\n  du .= zero(eltype(u))\n  u₃ = @view u[3:end]\n  u₂ = @view u[2:end-1]\n  u₁ = @view u[1:end-2]\n  @. du[2:end-1] = ((u₃ - 2*u₂ + u₁)/h^2.0)\n  nothing\nend```\nbut if I `@benchmark` the outer function standalone there's no allocation.","user":"U01H36BUDJB","ts":"1612711118.327900","team":"T68168MUP","edited":{"user":"U01H36BUDJB","ts":"1612711155.000000"},"blocks":[{"type":"rich_text","block_id":"puTU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"No luck with "},{"type":"text","text":"@inline","style":{"code":true}},{"type":"text","text":" , still slow. Here's the inner function for reference. Maybe I made a mistake..?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"@inline function _f(du,u,p,t)\n  du .= zero(eltype(u))\n  u₃ = @view u[3:end]\n  u₂ = @view u[2:end-1]\n  u₁ = @view u[1:end-2]\n  @. du[2:end-1] = ((u₃ - 2*u₂ + u₁)/h^2.0)\n  nothing\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"but if I "},{"type":"text","text":"@benchmark","style":{"code":true}},{"type":"text","text":" the outer function standalone there's no allocation."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"e415163c-2435-4e30-9f8b-be8f3a62ce7a","type":"message","text":"that looks fine","user":"U69BL50BF","ts":"1612711134.328100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fALF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that looks fine"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"d8624fce-1163-4515-b3ac-e1f2d25f77a2","type":"message","text":"odd.","user":"U69BL50BF","ts":"1612711135.328300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"30kaB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"odd."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"99f13750-e872-4bf3-b1fc-79bcc227f116","type":"message","text":"oh ignore the reinterpret","user":"U01H36BUDJB","ts":"1612711146.328500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Gm5UB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh ignore the reinterpret"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"0083c860-c284-4dab-9ad6-a5a587f74315","type":"message","text":"Worth asking on Discourse or something. This might be an odd compiler thing.","user":"U69BL50BF","ts":"1612711154.328700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"LM8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Worth asking on Discourse or something. This might be an odd compiler thing."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"20af5212-d5cf-4a27-a542-1c24d6932cdf","type":"message","text":"aren't they just going to tell me to ask you? since it doesn't seem to be reproducible outside of `DifferentialEquations.jl` ?","user":"U01H36BUDJB","ts":"1612711197.329000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QrM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"aren't they just going to tell me to ask you? since it doesn't seem to be reproducible outside of "},{"type":"text","text":"DifferentialEquations.jl","style":{"code":true}},{"type":"text","text":" ?"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"0085e79e-0d20-4c4d-a3c6-189ec6661f1e","type":"message","text":"even benchmarking these exact functions standalone, the one with all views is faster. It's just slower with `ODEProblem` /`solve`","user":"U01H36BUDJB","ts":"1612711250.329200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"npk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"even benchmarking these exact functions standalone, the one with all views is faster. It's just slower with "},{"type":"text","text":"ODEProblem","style":{"code":true}},{"type":"text","text":" /"},{"type":"text","text":"solve","style":{"code":true}}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"85b1b7cd-8bc9-4c08-8ec5-6d7dece7892b","type":"message","text":"sounds like someone will need to dig in. But a compiler person may have an explanation, and it might just be the analysis heuristics","user":"U69BL50BF","ts":"1612711314.329400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=jv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"sounds like someone will need to dig in. But a compiler person may have an explanation, and it might just be the analysis heuristics"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"c695da2d-fb62-495b-b049-0c797664a0df","type":"message","text":"ok, I'll make a post on Discourse. Hopefully someone can figure it out. Not sure what to do in the meantime. Maybe there's a workaround possible with generated functions and the axis information provided by `ComponentArray` .","user":"U01H36BUDJB","ts":"1612711754.329600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zmM+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ok, I'll make a post on Discourse. Hopefully someone can figure it out. Not sure what to do in the meantime. Maybe there's a workaround possible with generated functions and the axis information provided by "},{"type":"text","text":"ComponentArray","style":{"code":true}},{"type":"text","text":" ."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"5a383360-2c66-4d88-9acb-c4b49a4c68a6","type":"message","text":"i.e. generate a function that inserts the appropriate indices.","user":"U01H36BUDJB","ts":"1612711769.329800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vuC7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"i.e. generate a function that inserts the appropriate indices."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"c45eff74-de14-453e-89fd-57f6381388e4","type":"message","text":"<https://discourse.julialang.org/t/using-views-causes-significant-slowdown-in-simple-pde/54803>","user":"U01H36BUDJB","ts":"1612714409.334500","team":"T68168MUP","attachments":[{"service_name":"JuliaLang","title":"Using views causes significant slowdown in simple PDE","title_link":"https://discourse.julialang.org/t/using-views-causes-significant-slowdown-in-simple-pde/54803","text":"I have stumbled upon a frustrating performance issue with either DifferentialEquations.jl or the Julia compiler (or maybe my code?). The motivating use-case is the application of the 1-dimensional heat equation (and possibly additional dynamics) to a heterogeneous surface that must be broken up into (somewhat) homogeneous pieces for discretization. Thus, we have a large vector representing the energy state of the entire surface, but we need to call different forms of the heat equation for differ...","fallback":"JuliaLang: Using views causes significant slowdown in simple PDE","thumb_url":"https://aws1.discourse-cdn.com/business5/uploads/julialang/original/2X/1/12829a7ba92b924d4ce81099cbf99785bee9b405.png","ts":1612714200,"from_url":"https://discourse.julialang.org/t/using-views-causes-significant-slowdown-in-simple-pde/54803","thumb_width":408,"thumb_height":263,"service_icon":"https://aws1.discourse-cdn.com/business5/uploads/julialang/optimized/2X/6/6ca888e296f59ca2a599807f7d5edd489e3d1829_2_180x180.png","id":1,"original_url":"https://discourse.julialang.org/t/using-views-causes-significant-slowdown-in-simple-pde/54803"}],"blocks":[{"type":"rich_text","block_id":"K8UKz","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://discourse.julialang.org/t/using-views-causes-significant-slowdown-in-simple-pde/54803"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"a49adbf9-2f50-47b0-9eb1-fe4829a66798","type":"message","text":"<@U69BL50BF> As someone on Discourse pointed out, the version that uses slices therefore doesn't actually modify `du` so the ODE solver just doesn't do anything. :man-facepalming:","user":"U01H36BUDJB","ts":"1612715902.334800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gvqw+","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U69BL50BF"},{"type":"text","text":" As someone on Discourse pointed out, the version that uses slices therefore doesn't actually modify "},{"type":"text","text":"du","style":{"code":true}},{"type":"text","text":" so the ODE solver just doesn't do anything. "},{"type":"emoji","name":"man-facepalming"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"914b0faf-d6cf-4033-bdd0-ec7e967ed3dc","type":"message","text":"Can't believe I didn't think of that...","user":"U01H36BUDJB","ts":"1612715928.335000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+ev4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Can't believe I didn't think of that..."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"d4643731-881c-4e0f-a0d3-0a682bd3b5df","type":"message","text":"hahaha","user":"U69BL50BF","ts":"1612715995.335200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0YJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hahaha"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"f47a7aae-8bed-45c4-8812-44511a78d5e8","type":"message","text":"In hindsight, I should have been more suspicious of a solver integrating the heat equation in just a few microseconds haha.","user":"U01H36BUDJB","ts":"1612716066.335400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oxD1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"In hindsight, I should have been more suspicious of a solver integrating the heat equation in just a few microseconds haha."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"75d07695-2f54-4365-a28e-e808b5b3a3dd","type":"message","text":"at least, with an explicit method","user":"U69BL50BF","ts":"1612716362.335600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"H0ip","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"at least, with an explicit method"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"51430a6d-c1c7-4479-bfc3-f465f304bf54","type":"message","text":"do sparsity detection and an IMEX","user":"U69BL50BF","ts":"1612716376.335800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RR2kB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"do sparsity detection and an IMEX"}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"636610ad-f9f4-4101-b614-3f0979eef575","type":"message","text":"oh I was actually meaning to ask about that... when you refer to IMEX and \"implicit\" methods, are you referring to this?\n<https://en.wikipedia.org/wiki/Explicit_and_implicit_methods>\n\nor something else that I'm not familiar with?\n\nThere exists a (simplified) implicit version of the model I'm trying to build and I would be quite interested in implementing it with `DifferentialEquations.jl` if that would be possible.","user":"U01H36BUDJB","ts":"1612716634.336000","team":"T68168MUP","attachments":[{"image_url":"https://upload.wikimedia.org/wikipedia/commons/5/53/Comparison_between_Foward-Backward-Euler_and_Foward-Euler.png","image_width":681,"image_height":397,"image_bytes":6759,"title":"Explicit and implicit methods","title_link":"https://en.wikipedia.org/wiki/Explicit_and_implicit_methods","from_url":"https://en.wikipedia.org/wiki/Explicit_and_implicit_methods","author_name":"Wikipedia","author_link":"https://en.wikipedia.org/","text":"Explicit and implicit methods are approaches used in numerical analysis for obtaining numerical approximations to the solutions of time-dependent ordinary and partial differential equations, as is required in computer simulations of physical processes. Explicit methods calculate the state of a system at a later time from the state of the system at the current time, while implicit methods find a solution by solving an equation involving both the current state of the system and the later one. Mathematically, if \n  \n    \n      \n        Y\n        (\n        t\n        )\n      \n    \n    {\\displaystyle Y(t)}\n   is the current system state and \n  \n    \n      \n        Y\n        (\n        t\n        +\n        Δ\n        t\n        )\n      \n    \n    {\\displaystyle Y(t+\\Delta t)}\n   is the state at the later time (\n  \n    \n      \n        Δ\n        t\n      \n    \n    {\\displaystyle \\Delta t}\n   is a small time step), then, for an explicit method \n\n  \n    \n      \n        Y\n        (\n        t\n        +\n        Δ\n        t\n        )\n        =\n        F\n        (\n        Y\n        (\n        t\n        )\n        )\n        \n      \n    \n    {\\displaystyle Y(t+\\Delta t)=F(Y(t))\\,}\n  while for an implicit method one solves an equation\n\n  \n    \n      \n        G\n        \n          \n            (\n          \n        \n        Y\n        (\n        t\n        )\n        ,\n        Y\n        (\n        t\n        +\n        Δ\n        t\n        )\n        \n          \n            )\n          \n        \n        =\n        0\n        \n        (\n        1\n        )\n        \n      \n    \n    {\\displaystyle G{\\Big (}Y(t),Y(t+\\Delta t){\\Big )}=0\\qquad (1)\\,}\n  to find \n  \n    \n      \n        Y\n        (\n        t\n        +\n        Δ\n        t\n        )\n        .\n      \n    \n    {\\displaystyle Y(t+\\Delta t).}\n  \nImplicit methods require an extra computation (solving the above equation), and they can be much harder to implement. Implicit methods are used because many problems arising in practice are stiff, for which the use of an explicit method requires impractically small time steps \n  \n    \n      \n        Δ\n        t\n      \n    \n    {\\displaystyle \\Delta t}\n   to keep the error in the result bounded (see numerical stability).  For such problems, to achieve given accuracy, it takes much less computational time to use an implicit method with larger time steps, even taking into account that one needs to solve an equation of the form (1) at each time step. That said, whether one should use an explicit or implicit method depends upon the problem to be solved.\nSince the implicit method cannot be carried out for each kind of differential operator, it is sometimes advisable to make use of the so called operator splitting method, which means that the differential operator is rewritten as the sum of two complementary operators\n\n  \n    \n      \n        Y\n        (\n        t\n        +\n        Δ\n        t\n        )\n        =\n        F\n        (\n        Y\n        (\n        t\n        +\n        Δ\n        t\n        )\n        )\n        +\n        G\n        (\n        Y\n        (\n        t\n        )\n        )\n        ,\n        \n      \n    \n    {\\displaystyle Y(t+\\Delta t)=F(Y(t+\\Delta t))+G(Y(t)),\\,}\n  while one is treated explicitly and the other implicitly.\nFor usual applications the implicit term is chosen to be linear while the explicit term can be nonlinear. This combination of the former method is called Implicit-Explicit Method (short IMEX,).","fallback":"wikipedia: Explicit and implicit methods","service_icon":"https://a.slack-edge.com/80588/img/unfurl_icons/wikipedia.png","id":1,"original_url":"https://en.wikipedia.org/wiki/Explicit_and_implicit_methods"}],"blocks":[{"type":"rich_text","block_id":"poB8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh I was actually meaning to ask about that... when you refer to IMEX and \"implicit\" methods, are you referring to this?\n"},{"type":"link","url":"https://en.wikipedia.org/wiki/Explicit_and_implicit_methods"},{"type":"text","text":"\n\nor something else that I'm not familiar with?\n\nThere exists a (simplified) implicit version of the model I'm trying to build and I would be quite interested in implementing it with "},{"type":"text","text":"DifferentialEquations.jl","style":{"code":true}},{"type":"text","text":" if that would be possible."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"4f3cbe42-7682-4c8b-afed-abf7633337e6","type":"message","text":"models are neither implicit or explicit. It's the solver.","user":"U69BL50BF","ts":"1612717838.336300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"q2g0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"models are neither implicit or explicit. It's the solver."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"},{"client_msg_id":"bca0861f-4276-4a4a-a91b-d2641c1eeae7","type":"message","text":"of course... that's what I meant. I was just referring to the whole implementation as \"the model\".","user":"U01H36BUDJB","ts":"1612719335.336500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"dyrJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"of course... that's what I meant. I was just referring to the whole implementation as \"the model\"."}]}]}],"thread_ts":"1612645291.309100","parent_user_id":"U01H36BUDJB"}]