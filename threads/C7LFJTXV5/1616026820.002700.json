[{"client_msg_id":"2a58fd46-024a-42be-b599-0fa3f9292998","type":"message","text":"Looking at the Zygote docs I got the impression that `pullback` merely runs a forward pass and constructs the pullback function (which once generated should be cached right?). Why does `pullback(f, x)` need more time than `f(x)` even after repeated runs?","user":"UBGQUAG8K","ts":"1616026820.002700","team":"T68168MUP","edited":{"user":"UBGQUAG8K","ts":"1616027470.000000"},"blocks":[{"type":"rich_text","block_id":"EFC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Looking at the Zygote docs I got the impression that "},{"type":"text","text":"pullback","style":{"code":true}},{"type":"text","text":" merely runs a forward pass and constructs the pullback function (which once generated should be cached right?). Why does "},{"type":"text","text":"pullback(f, x)","style":{"code":true}},{"type":"text","text":" need more time than "},{"type":"text","text":"f(x)","style":{"code":true}},{"type":"text","text":" even after repeated runs?"}]}]}],"thread_ts":"1616026820.002700","reply_count":5,"reply_users_count":2,"latest_reply":"1616068822.004000","reply_users":["UD0NS8PDF","UBGQUAG8K"],"subscribed":false},{"client_msg_id":"6a78fefa-4de7-4bc0-ac15-5225c2f5a383","type":"message","text":"It should be compiled once, but forward pass must be re-computed for each new `x`, and the backward pass (usually) depends on that too, so must also be re-computed:\n```julia&gt; Zygote.pullback(x -&gt; x^2, 2)\n(4, Zygote.var\"#43#44\"{typeof(∂(#5))}(∂(#5)))\n\njulia&gt; ans[2](1)\n(4,)\n\njulia&gt; Zygote.pullback(x -&gt; x^2, 3)\n(9, Zygote.var\"#43#44\"{typeof(∂(#7))}(∂(#7)))\n\njulia&gt; ans[2](1)\n(6,)```","user":"UD0NS8PDF","ts":"1616044886.003000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6t+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It should be compiled once, but forward pass must be re-computed for each new "},{"type":"text","text":"x","style":{"code":true}},{"type":"text","text":", and the backward pass (usually) depends on that too, so must also be re-computed:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> Zygote.pullback(x -> x^2, 2)\n(4, Zygote.var\"#43#44\"{typeof(∂(#5))}(∂(#5)))\n\njulia> ans[2](1)\n(4,)\n\njulia> Zygote.pullback(x -> x^2, 3)\n(9, Zygote.var\"#43#44\"{typeof(∂(#7))}(∂(#7)))\n\njulia> ans[2](1)\n(6,)"}]}]}],"thread_ts":"1616026820.002700","parent_user_id":"UBGQUAG8K"},{"client_msg_id":"e5e9f264-68aa-4dd2-80a6-2a8986a35f4e","type":"message","text":"right, but when I don't call the backwardpass (your `ans[2](1)` ) I would expect it to be as fast as the regular forward call, which I could not confirm measuring.","user":"UBGQUAG8K","ts":"1616057281.003200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fdc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"right, but when I don't call the backwardpass (your "},{"type":"text","text":"ans[2](1)","style":{"code":true}},{"type":"text","text":" ) I would expect it to be as fast as the regular forward call, which I could not confirm measuring."}]}]}],"thread_ts":"1616026820.002700","parent_user_id":"UBGQUAG8K"},{"client_msg_id":"495c8930-9619-43b2-8b2e-323858cb6632","type":"message","text":"```using Flux: Chain, Dense, pullback\nnn = Chain(Dense(10,10), Dense(10,10))\nx = rand(10,10000)\n@time for i=1:100 nn(x); end\n@time for i=1:100 y, pb = pullback(nn, x); end\n@time for i=1:100 pb(y); end```","user":"UBGQUAG8K","ts":"1616057840.003400","team":"T68168MUP","edited":{"user":"UBGQUAG8K","ts":"1616057962.000000"},"blocks":[{"type":"rich_text","block_id":"RBD","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using Flux: Chain, Dense, pullback\nnn = Chain(Dense(10,10), Dense(10,10))\nx = rand(10,10000)\n@time for i=1:100 nn(x); end\n@time for i=1:100 y, pb = pullback(nn, x); end\n@time for i=1:100 pb(y); end"}]}]}],"thread_ts":"1616026820.002700","parent_user_id":"UBGQUAG8K"},{"client_msg_id":"368ecc17-2ecb-44fe-ab75-9c8d22571f45","type":"message","text":"```julia&gt; @time for i=1:100 nn(x); end\n  0.085438 seconds (1000 allocations: 190.773 MiB, 6.43% gc time)\n\njulia&gt; @time for i=1:100 y, pb = pullback(nn, x); end\n\n  1.128572 seconds (20.02 M allocations: 535.010 MiB, 3.06% gc time)\n\njulia&gt; @time for i=1:100 pb(y); end\n  0.679109 seconds (30.01 M allocations: 610.724 MiB, 12.20% gc time)```","user":"UBGQUAG8K","ts":"1616057974.003700","team":"T68168MUP","edited":{"user":"UBGQUAG8K","ts":"1616057993.000000"},"blocks":[{"type":"rich_text","block_id":"Ms1","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @time for i=1:100 nn(x); end\n  0.085438 seconds (1000 allocations: 190.773 MiB, 6.43% gc time)\n\njulia> @time for i=1:100 y, pb = pullback(nn, x); end\n\n  1.128572 seconds (20.02 M allocations: 535.010 MiB, 3.06% gc time)\n\njulia> @time for i=1:100 pb(y); end\n  0.679109 seconds (30.01 M allocations: 610.724 MiB, 12.20% gc time)"}]}]}],"thread_ts":"1616026820.002700","parent_user_id":"UBGQUAG8K"},{"client_msg_id":"bac7e219-b006-4fb2-9ea6-77e5736d8c89","type":"message","text":"```julia&gt; @btime nn($x);\n  295.209 μs (10 allocations: 3.05 MiB)\n\njulia&gt; @btime pullback($nn, $x);\n  300.166 μs (134 allocations: 3.06 MiB)```","user":"UD0NS8PDF","ts":"1616068822.004000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fXlv","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @btime nn($x);\n  295.209 μs (10 allocations: 3.05 MiB)\n\njulia> @btime pullback($nn, $x);\n  300.166 μs (134 allocations: 3.06 MiB)"}]}]}],"thread_ts":"1616026820.002700","parent_user_id":"UBGQUAG8K"}]