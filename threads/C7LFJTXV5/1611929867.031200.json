[{"client_msg_id":"6124ec5c-9cab-49b9-8c84-f427828fbeb1","type":"message","text":"I’m trying to extend Flux’s `Recur` to return both the cell and hidden state. When I do that, training on the GPU breaks, whereas it works fine on the CPU.  Does anyone have an idea why?\nMWE is the following, and stacktrace is in the thread:\n```using Flux\n\nmutable struct FullRecur{T}\n    cell::T\n    init\n    state\nend\nFullRecur(m, h = Flux.hidden(m)) = FullRecur(m, h, h)\n\nfunction (m::FullRecur)(xs...)\n    h, y = m.cell(m.state, xs...)\n    m.state = h\n    return h   # &lt;--- return value changed from `Recur`\nend\n\nFlux.@functor FullRecur cell, init\n\nlstm = FullRecur(Flux.LSTMCell(10,5)) |&gt; gpu\n\nx = rand(Float32, 10,30) |&gt; gpu\ny = rand(Float32, 10,30) |&gt; gpu\n\nm = (x) -&gt; cat(lstm(x)..., dims=1) |&gt; gpu\nloss(x,y) = Flux.mse(m(x),y)\n\nFlux.train!(loss, Flux.params(lstm), [(x,y)], ADAM())\n# ERROR: MethodError: no method matching size(::Nothing, ::Int64)```\n","user":"UNZKG0909","ts":"1611929867.031200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"np9Qm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I’m trying to extend Flux’s "},{"type":"text","text":"Recur","style":{"code":true}},{"type":"text","text":" to return both the cell and hidden state. When I do that, training on the GPU breaks, whereas it works fine on the CPU.  Does anyone have an idea why?\nMWE is the following, and stacktrace is in the thread:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using Flux\n\nmutable struct FullRecur{T}\n    cell::T\n    init\n    state\nend\nFullRecur(m, h = Flux.hidden(m)) = FullRecur(m, h, h)\n\nfunction (m::FullRecur)(xs...)\n    h, y = m.cell(m.state, xs...)\n    m.state = h\n    return h   # <--- return value changed from `Recur`\nend\n\nFlux.@functor FullRecur cell, init\n\nlstm = FullRecur(Flux.LSTMCell(10,5)) |> gpu\n\nx = rand(Float32, 10,30) |> gpu\ny = rand(Float32, 10,30) |> gpu\n\nm = (x) -> cat(lstm(x)..., dims=1) |> gpu\nloss(x,y) = Flux.mse(m(x),y)\n\nFlux.train!(loss, Flux.params(lstm), [(x,y)], ADAM())\n# ERROR: MethodError: no method matching size(::Nothing, ::Int64)"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1611929867.031200","reply_count":5,"reply_users_count":2,"latest_reply":"1611947066.032400","reply_users":["UNZKG0909","UC4QQPG4A"],"subscribed":false},{"client_msg_id":"afaadd9e-ab06-4084-893d-c5e7d9cfa054","type":"message","text":"Stacktrace:\n```Stacktrace:\n [1] backwardData(::CUDA.CUDNN.RNNDesc{Float32}, ::CUDA.CuArray{Float32,2}, ::Nothing, ::CUDA.CuArray{Float32,2}, ::CUDA.CuArray{Float32,2}, ::CUDA.CuArray{Float32,2}, ::CUDA.CuArray{Float32,2}, ::CUDA.CuArray{UInt8,1}) at /home/sdobber/.julia/packages/CUDA/wTQsK/lib/cudnn/rnn.jl:154\n [2] (::CUDA.CUDNN.var\"#567#568\"{CUDA.CUDNN.RNNDesc{Float32},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{UInt8,1},CUDA.CuArray{Float32,2}})(::Nothing, ::CUDA.CuArray{Float32,2}, ::CUDA.CuArray{Float32,2}) at /home/sdobber/.julia/packages/CUDA/wTQsK/lib/cudnn/rnn.jl:200\n [3] (::Flux.CUDAint.var\"#13#14\"{Zygote.Context,Flux.LSTMCell{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,1}},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CUDNN.var\"#567#568\"{CUDA.CUDNN.RNNDesc{Float32},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{UInt8,1},CUDA.CuArray{Float32,2}}})(::Tuple{Tuple{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2}},Nothing}) at /home/sdobber/.julia/packages/Flux/mVj29/src/cuda/curnn.jl:85\n [4] #432#back at /home/sdobber/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [5] #150 at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/lib/lib.jl:191 [inlined]\n [6] (::Zygote.var\"#1693#back#152\"{Zygote.var\"#150#151\"{Flux.CUDAint.var\"#432#back#15\"{Flux.CUDAint.var\"#13#14\"{Zygote.Context,Flux.LSTMCell{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,1}},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CUDNN.var\"#567#568\"{CUDA.CUDNN.RNNDesc{Float32},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{UInt8,1},CUDA.CuArray{Float32,2}}}},Tuple{Tuple{Nothing},Tuple{Nothing}}}})(::Tuple{Tuple{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2}},Nothing}) at /home/sdobber/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59\n [7] FullRecur at ./REPL[5]:2 [inlined]\n [8] (::typeof(∂(λ)))(::Tuple{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2}}) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface2.jl:0\n [9] #7 at ./REPL[10]:1 [inlined]\n [10] (::typeof(∂(#7)))(::CUDA.CuArray{Float32,2}) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface2.jl:0\n [11] loss at ./REPL[12]:1 [inlined]\n [12] (::typeof(∂(loss)))(::Float32) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface2.jl:0\n [13] #150 at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/lib/lib.jl:191 [inlined]\n [14] #1693#back at /home/sdobber/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [15] #15 at /home/sdobber/.julia/packages/Flux/mVj29/src/optimise/train.jl:103 [inlined]\n [16] (::typeof(∂(λ)))(::Float32) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface2.jl:0\n [17] (::Zygote.var\"#54#55\"{Zygote.Params,Zygote.Context,typeof(∂(λ))})(::Float32) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface.jl:172\n [18] gradient(::Function, ::Zygote.Params) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface.jl:49\n [19] macro expansion at /home/sdobber/.julia/packages/Flux/mVj29/src/optimise/train.jl:102 [inlined]\n [20] macro expansion at /home/sdobber/.julia/packages/Juno/n6wyj/src/progress.jl:134 [inlined]\n [21] train!(::Function, ::Zygote.Params, ::Array{Tuple{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2}},1}, ::ADAM; cb::Flux.Optimise.var\"#16#22\") at /home/sdobber/.julia/packages/Flux/mVj29/src/optimise/train.jl:100\n [22] train!(::Function, ::Zygote.Params, ::Array{Tuple{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2}},1}, ::ADAM) at /home/sdobber/.julia/packages/Flux/mVj29/src/optimise/train.jl:98\n [23] top-level scope at REPL[13]:1```","user":"UNZKG0909","ts":"1611929902.031300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"uoifC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Stacktrace:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"Stacktrace:\n [1] backwardData(::CUDA.CUDNN.RNNDesc{Float32}, ::CUDA.CuArray{Float32,2}, ::Nothing, ::CUDA.CuArray{Float32,2}, ::CUDA.CuArray{Float32,2}, ::CUDA.CuArray{Float32,2}, ::CUDA.CuArray{Float32,2}, ::CUDA.CuArray{UInt8,1}) at /home/sdobber/.julia/packages/CUDA/wTQsK/lib/cudnn/rnn.jl:154\n [2] (::CUDA.CUDNN.var\"#567#568\"{CUDA.CUDNN.RNNDesc{Float32},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{UInt8,1},CUDA.CuArray{Float32,2}})(::Nothing, ::CUDA.CuArray{Float32,2}, ::CUDA.CuArray{Float32,2}) at /home/sdobber/.julia/packages/CUDA/wTQsK/lib/cudnn/rnn.jl:200\n [3] (::Flux.CUDAint.var\"#13#14\"{Zygote.Context,Flux.LSTMCell{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,1}},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CUDNN.var\"#567#568\"{CUDA.CUDNN.RNNDesc{Float32},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{UInt8,1},CUDA.CuArray{Float32,2}}})(::Tuple{Tuple{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2}},Nothing}) at /home/sdobber/.julia/packages/Flux/mVj29/src/cuda/curnn.jl:85\n [4] #432#back at /home/sdobber/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [5] #150 at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/lib/lib.jl:191 [inlined]\n [6] (::Zygote.var\"#1693#back#152\"{Zygote.var\"#150#151\"{Flux.CUDAint.var\"#432#back#15\"{Flux.CUDAint.var\"#13#14\"{Zygote.Context,Flux.LSTMCell{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,1}},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CUDNN.var\"#567#568\"{CUDA.CUDNN.RNNDesc{Float32},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2},CUDA.CuArray{UInt8,1},CUDA.CuArray{Float32,2}}}},Tuple{Tuple{Nothing},Tuple{Nothing}}}})(::Tuple{Tuple{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2}},Nothing}) at /home/sdobber/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59\n [7] FullRecur at ./REPL[5]:2 [inlined]\n [8] (::typeof(∂(λ)))(::Tuple{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2}}) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface2.jl:0\n [9] #7 at ./REPL[10]:1 [inlined]\n [10] (::typeof(∂(#7)))(::CUDA.CuArray{Float32,2}) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface2.jl:0\n [11] loss at ./REPL[12]:1 [inlined]\n [12] (::typeof(∂(loss)))(::Float32) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface2.jl:0\n [13] #150 at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/lib/lib.jl:191 [inlined]\n [14] #1693#back at /home/sdobber/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [15] #15 at /home/sdobber/.julia/packages/Flux/mVj29/src/optimise/train.jl:103 [inlined]\n [16] (::typeof(∂(λ)))(::Float32) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface2.jl:0\n [17] (::Zygote.var\"#54#55\"{Zygote.Params,Zygote.Context,typeof(∂(λ))})(::Float32) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface.jl:172\n [18] gradient(::Function, ::Zygote.Params) at /home/sdobber/.julia/packages/Zygote/Iz3wR/src/compiler/interface.jl:49\n [19] macro expansion at /home/sdobber/.julia/packages/Flux/mVj29/src/optimise/train.jl:102 [inlined]\n [20] macro expansion at /home/sdobber/.julia/packages/Juno/n6wyj/src/progress.jl:134 [inlined]\n [21] train!(::Function, ::Zygote.Params, ::Array{Tuple{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2}},1}, ::ADAM; cb::Flux.Optimise.var\"#16#22\") at /home/sdobber/.julia/packages/Flux/mVj29/src/optimise/train.jl:100\n [22] train!(::Function, ::Zygote.Params, ::Array{Tuple{CUDA.CuArray{Float32,2},CUDA.CuArray{Float32,2}},1}, ::ADAM) at /home/sdobber/.julia/packages/Flux/mVj29/src/optimise/train.jl:98\n [23] top-level scope at REPL[13]:1"}]}]}],"thread_ts":"1611929867.031200","parent_user_id":"UNZKG0909"},{"client_msg_id":"6fade6f4-0be1-4dd6-a14e-33cfe3323e97","type":"message","text":"Hmm interesting, I'm guessing the error is the same even if you don't provide the arguments to the functor callm","user":"UC4QQPG4A","ts":"1611946041.031800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0w1Dk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm interesting, I'm guessing the error is the same even if you don't provide the arguments to the functor callm"}]}]}],"thread_ts":"1611929867.031200","parent_user_id":"UNZKG0909"},{"client_msg_id":"721c60a4-326b-4e79-ae67-dc0e5645cff2","type":"message","text":"Yes indeed","user":"UNZKG0909","ts":"1611946109.032000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GESZn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes indeed"}]}]}],"thread_ts":"1611929867.031200","parent_user_id":"UNZKG0909"},{"client_msg_id":"a311a64f-1d3d-4918-b9ce-48333879a26e","type":"message","text":"You might want to wrap the `m.state ...` In `Zygote.ignore`","user":"UC4QQPG4A","ts":"1611946168.032200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"N8eu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"You might want to wrap the "},{"type":"text","text":"m.state ...","style":{"code":true}},{"type":"text","text":" In "},{"type":"text","text":"Zygote.ignore","style":{"code":true}}]}]}],"thread_ts":"1611929867.031200","parent_user_id":"UNZKG0909"},{"client_msg_id":"a897e9bb-9764-47cd-a235-ab898c468abb","type":"message","text":"This still gives the same error…","user":"UNZKG0909","ts":"1611947066.032400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"py3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This still gives the same error…"}]}]}],"thread_ts":"1611929867.031200","parent_user_id":"UNZKG0909"}]