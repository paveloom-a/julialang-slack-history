[{"client_msg_id":"38c3ed9c-9a6e-41ec-ad19-7694bf605aea","type":"message","text":"Hi I'm trying to save my model to bson file with `@save` command after each iteration of train, everything is okay in CPU. When I did that on GPU, seems the `@save` command could only save the final model which means the model saved after first  and second train would finally be the same as the model saved after all trainings. From manual, it suggests transfer weights to CPU but seems it's different thing for my model is saved but it's not the one I want. Am I missing some key points here?","user":"U01977X150R","ts":"1613583846.139900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5u/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hi I'm trying to save my model to bson file with"},{"type":"text","text":" @save","style":{"code":true}},{"type":"text","text":" command after each iteration of train, everything is okay in CPU. When I did that on GPU, seems the "},{"type":"text","text":"@save","style":{"code":true}},{"type":"text","text":" command could only save the final model which means the model saved after first  and second train would finally be the same as the model saved after all trainings. From manual, it suggests transfer weights to CPU but seems it's different thing for my model is saved but it's not the one I want. Am I missing some key points here?"}]}]}],"thread_ts":"1613583846.139900","reply_count":11,"reply_users_count":3,"latest_reply":"1613621891.153800","reply_users":["UH9KWTTD3","U01977X150R","ULG5V164A"],"subscribed":false},{"client_msg_id":"a9bec776-2d6b-46ac-84d7-8feb915eb98b","type":"message","text":"Seems like there might be another confounding issue here masking what’s the real problem. Do you mind pasting a snippet of your `@save` and `@load` code?","user":"UH9KWTTD3","ts":"1613584794.141200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"eP4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Seems like there might be another confounding issue here masking what’s the real problem. Do you mind pasting a snippet of your "},{"type":"text","text":"@save","style":{"code":true}},{"type":"text","text":" and "},{"type":"text","text":"@load","style":{"code":true}},{"type":"text","text":" code?"}]}]}],"thread_ts":"1613583846.139900","parent_user_id":"U01977X150R"},{"type":"message","text":"Sure, here's my code, and between the train and save is a loss function to make sure my model is being trained.","files":[{"id":"F01N05B0AT1","created":1613585250,"timestamp":1613585250,"name":"image.png","title":"image.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"U01977X150R","editable":false,"size":41707,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01N05B0AT1/image.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01N05B0AT1/download/image.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01N05B0AT1-a2782afb77/image_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01N05B0AT1-a2782afb77/image_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01N05B0AT1-a2782afb77/image_360.png","thumb_360_w":360,"thumb_360_h":186,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01N05B0AT1-a2782afb77/image_480.png","thumb_480_w":480,"thumb_480_h":248,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01N05B0AT1-a2782afb77/image_160.png","original_w":483,"original_h":250,"thumb_tiny":"AwAYADDR555pMkUvrSdee1ABlval+b1FIADS4oAOaWkxiloAZ/H+NSYqP+M/WpKADFGKKKADFGKKKAP/2Q==","permalink":"https://julialang.slack.com/files/U01977X150R/F01N05B0AT1/image.png","permalink_public":"https://slack-files.com/T68168MUP-F01N05B0AT1-73df55a2ce","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"V5Z","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Sure, here's my code, and between the train and save is a loss function to make sure my model is being trained."}]}]}],"user":"U01977X150R","display_as_bot":false,"ts":"1613585335.141800","thread_ts":"1613583846.139900","parent_user_id":"U01977X150R"},{"client_msg_id":"40520ca1-7169-4faf-988a-7bece392931f","type":"message","text":"Looks like this issue -- try moving to cpu before saving. <https://github.com/FluxML/Flux.jl/issues/1318>","user":"ULG5V164A","ts":"1613587624.142900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2hVgl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Looks like this issue -- try moving to cpu before saving. "},{"type":"link","url":"https://github.com/FluxML/Flux.jl/issues/1318"}]}]}],"thread_ts":"1613583846.139900","parent_user_id":"U01977X150R"},{"client_msg_id":"30c183f0-9cf1-4c8e-b9ae-8fc576a70e29","type":"message","text":"Yeah I think the easiest thing is to transfer the weights to the CPU before saving","user":"UH9KWTTD3","ts":"1613590372.143100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"l8c/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yeah I think the easiest thing is to transfer the weights to the CPU before saving"}]}]}],"thread_ts":"1613583846.139900","parent_user_id":"U01977X150R"},{"client_msg_id":"61ed3391-f31a-45d7-a917-3e4aabe898bf","type":"message","text":"I misunderstood and thought you were already doing this but some other error was occurring. But without this step, it is known that there will be issues.","user":"UH9KWTTD3","ts":"1613590433.143300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qRJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I misunderstood and thought you were already doing this but some other error was occurring. But without this step, it is known that there will be issues."}]}]}],"thread_ts":"1613583846.139900","parent_user_id":"U01977X150R"},{"type":"message","text":"Appreciate it a lot for your advices. I've tried transferring the weights to CPU before saving, and got a similar results.  For my model is a indeed a mixture of several networks. I'm not sure whether that would introduce any disturbance.","files":[{"id":"F01N8TS8NES","created":1613595085,"timestamp":1613595085,"name":"image.png","title":"image.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"U01977X150R","editable":false,"size":105670,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01N8TS8NES/image.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01N8TS8NES/download/image.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01N8TS8NES-84c648e362/image_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01N8TS8NES-84c648e362/image_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01N8TS8NES-84c648e362/image_360.png","thumb_360_w":281,"thumb_360_h":360,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01N8TS8NES-84c648e362/image_480.png","thumb_480_w":375,"thumb_480_h":480,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01N8TS8NES-84c648e362/image_160.png","original_w":435,"original_h":557,"thumb_tiny":"AwAwACXSNNyPU0403P1oAXj+8fzox7mk3c9DS0ALRRRQAN0puQOOlObpSAZ5NABkCjcKNopcUAHFFGKMUAB5HFNx/kUv8ApuPwoAcAKWmhe+adigAooxRigD/9k=","permalink":"https://julialang.slack.com/files/U01977X150R/F01N8TS8NES/image.png","permalink_public":"https://slack-files.com/T68168MUP-F01N8TS8NES-ae4110cb6d","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"6u8B","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Appreciate it a lot for your advices. I've tried transferring the weights to CPU before saving, and got a similar results.  For my model is a indeed a mixture of several networks. I'm not sure whether that would introduce any disturbance."}]}]}],"user":"U01977X150R","display_as_bot":false,"ts":"1613595138.143500","thread_ts":"1613583846.139900","parent_user_id":"U01977X150R"},{"client_msg_id":"EF169E95-B4EC-4134-AD01-94475A90B8F0","type":"message","text":"I see that’s pretty weird. Can you keep the model on the CPU and do `Flux.loadparams!(m, tps); m = gpu(m)`?","user":"UH9KWTTD3","ts":"1613602392.147200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MjH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I see that’s pretty weird. Can you keep the model on the CPU and do "},{"type":"text","text":"Flux.loadparams!(m, tps); m = gpu(m)","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1613583846.139900","parent_user_id":"U01977X150R"},{"client_msg_id":"CCB9E965-833E-4661-BFDF-03E3597BFCA2","type":"message","text":"If that fixes it, maybe file an issue on Flux.jl. Don’t know how to fix it, but at the very least we should be more explicit in the docs about what works.","user":"UH9KWTTD3","ts":"1613602446.148600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"l88TB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If that fixes it, maybe file an issue on Flux.jl. Don’t know how to fix it, but at the very least we should be more explicit in the docs about what works."}]}]}],"thread_ts":"1613583846.139900","parent_user_id":"U01977X150R"},{"client_msg_id":"c4faa58b-6514-4904-bd8a-dfb6a217ff1c","type":"message","text":"Many thanks, Kyle! I think it might lied in the `loadparams` which failed to load the saved `params` no mater in CPU or GPU. Btw, when change to `cpu.(ps)`  , all  `params` could be saved to BSON file sucessfully. So I think I should try to figure out why `loadparams` failed here.","user":"U01977X150R","ts":"1613620023.153000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RFYX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Many thanks, Kyle! I think it might lied in the "},{"type":"text","text":"loadparams ","style":{"code":true}},{"type":"text","text":"which failed to load the saved "},{"type":"text","text":"params ","style":{"code":true}},{"type":"text","text":"no mater in CPU or GPU. Btw, when change to"},{"type":"text","text":" cpu.(ps) ","style":{"code":true}},{"type":"text","text":" , all  "},{"type":"text","text":"params ","style":{"code":true}},{"type":"text","text":"could be saved to BSON file sucessfully. So I think I should try to figure out why "},{"type":"text","text":"loadparams","style":{"code":true}},{"type":"text","text":" failed here."}]}]}],"thread_ts":"1613583846.139900","parent_user_id":"U01977X150R"},{"client_msg_id":"fc3b57d3-49fc-4057-ade0-e3755477883c","type":"message","text":"Finally, I found I made a silly mistake. For my model is a mixture of several neural networks. To restore all `params` of each network, I shouldn't directly apply the `loadparmas` to my model as whole but to each network separately. Sorry for any confusion and many thanks for your help.","user":"U01977X150R","ts":"1613621676.153200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Xn4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Finally, I found I made a silly mistake. For my model is a mixture of several neural networks. To restore all "},{"type":"text","text":"params ","style":{"code":true}},{"type":"text","text":"of each network, I shouldn't directly apply the "},{"type":"text","text":"loadparmas ","style":{"code":true}},{"type":"text","text":"to my model as whole but to each network separately. Sorry for any confusion and many thanks for your help."}]}]}],"thread_ts":"1613583846.139900","parent_user_id":"U01977X150R"},{"client_msg_id":"B4EEC6CD-4FA2-4B15-8C1C-349D8BDE7C81","type":"message","text":"No problem glad you figured it out!","user":"UH9KWTTD3","ts":"1613621891.153800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"mmP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"No problem glad you figured it out!"}]}]}],"thread_ts":"1613583846.139900","parent_user_id":"U01977X150R"}]