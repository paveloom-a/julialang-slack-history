[{"client_msg_id":"7ad3d8a6-af2f-46bf-b4b2-3e3766921f67","type":"message","text":"Hi I'm still training some LSTM models. And I just find the LSTM of Flux might failed to calculate the gradient when I vectorize my data. Here's a toy with 5 series of 5 labels to predict 2 corresponding responses.\n```trainX = [rand(5,5)[i,:] for i=1:5]|&gt;gpu\ntrainY = [rand(5,2)[i,:] for i=1:5]|&gt;gpu\nmyModel  = Flux.LSTM(5,2) |&gt;gpu\nparams = Flux.params(myModel)    \nopt =  ADAM()\nloss(x,y) =sum(mse.(trainY[y],myModel.(trainX[x])))\nx1 = y1 = [i for i=1:5]\ntrainData = Flux.Data.DataLoader(x1,y1,shuffle=true,batchsize=5)  \n\nFlux.train!(loss,params,trainData,ADAM())```\nThen I would got following error.\n\n```ArgumentError: NamedTuple{(:σ, :Wi, :Wh, :b, :h, :c),Tuple{Nothing,LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},CuArray{Float32,1},Nothing,Nothing}} keys must be a subset of NamedTuple{(:Wi, :Wh, :b, :h, :c),NTuple{5,Nothing}} keys```\nThe model works fine if I replace the LSTM with RNN cell and I must miss something. Many thanks.","user":"U01977X150R","ts":"1616991525.063200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2fw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hi I'm still training some LSTM models. And I just find the LSTM of Flux might failed to calculate the gradient when I vectorize my data. Here's a toy with 5 series of 5 labels to predict 2 corresponding responses.\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"trainX = [rand(5,5)[i,:] for i=1:5]|>gpu\ntrainY = [rand(5,2)[i,:] for i=1:5]|>gpu\nmyModel  = Flux.LSTM(5,2) |>gpu\nparams = Flux.params(myModel)    \nopt =  ADAM()\nloss(x,y) =sum(mse.(trainY[y],myModel.(trainX[x])))\nx1 = y1 = [i for i=1:5]\ntrainData = Flux.Data.DataLoader(x1,y1,shuffle=true,batchsize=5)  \n\nFlux.train!(loss,params,trainData,ADAM())"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Then I would got following error.\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"ArgumentError: NamedTuple{(:σ, :Wi, :Wh, :b, :h, :c),Tuple{Nothing,LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},CuArray{Float32,1},Nothing,Nothing}} keys must be a subset of NamedTuple{(:Wi, :Wh, :b, :h, :c),NTuple{5,Nothing}} keys"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"The model works fine if I replace the LSTM with RNN cell and I must miss something. Many thanks."}]}]}],"thread_ts":"1616991525.063200","reply_count":3,"reply_users_count":2,"latest_reply":"1616995295.063800","reply_users":["U01977X150R","UC4QQPG4A"],"is_locked":false,"subscribed":false},{"client_msg_id":"93c7ff25-e222-4783-bcfe-c7729fe1d1ae","type":"message","text":"I also attached the full stack trace here.\n\n```ArgumentError: NamedTuple{(:σ, :Wi, :Wh, :b, :h, :c),Tuple{Nothing,LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},CuArray{Float32,1},Nothing,Nothing}} keys must be a subset of NamedTuple{(:Wi, :Wh, :b, :h, :c),NTuple{5,Nothing}} keys\n\nStacktrace:\n [1] #s77#84 at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/lib.jl:20 [inlined]\n [2] #s77#84(::Any, ::Any, ::Any) at ./none:0\n [3] (::Core.GeneratedFunctionStub)(::Any, ::Vararg{Any,N} where N) at ./boot.jl:527\n [4] struct_grad!(::Zygote.Context, ::Flux.LSTMCell{CuArray{Float32,2},CuArray{Float32,1}}, ::NamedTuple{(:σ, :Wi, :Wh, :b, :h, :c),Tuple{Nothing,LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},CuArray{Float32,1},Nothing,Nothing}}) at /home/zq/.julia/packages/Flux/goUGu/src/cuda/curnn.jl:64\n [5] #13 at /home/zq/.julia/packages/Flux/goUGu/src/cuda/curnn.jl:86 [inlined]\n [6] #432#back at /home/zq/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [7] #178 at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/lib.jl:194 [inlined]\n [8] (::Zygote.var\"#1698#back#180\"{Zygote.var\"#178#179\"{Flux.CUDAint.var\"#432#back#15\"{Flux.CUDAint.var\"#13#14\"{Zygote.Context,Flux.LSTMCell{CuArray{Float32,2},CuArray{Float32,1}},CuArray{Float32,1},CuArray{Float32,1},CUDA.CUDNN.var\"#567#568\"{CUDA.CUDNN.RNNDesc{Float32},CuArray{Float32,1},CuArray{Float32,1},CuArray{Float32,1},CuArray{UInt8,1},CuArray{Float32,1}}}},Tuple{Tuple{Nothing},Tuple{Nothing}}}})(::Tuple{Nothing,CuArray{Float32,1}}) at /home/zq/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59\n [9] Recur at /home/zq/.julia/packages/Flux/goUGu/src/layers/recurrent.jl:36 [inlined]\n [10] (::typeof(∂(λ)))(::CuArray{Float32,1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [11] applychain at /home/zq/.julia/packages/Flux/goUGu/src/layers/basic.jl:36 [inlined]\n [12] (::typeof(∂(applychain)))(::CuArray{Float32,1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [13] Chain at /home/zq/.julia/packages/Flux/goUGu/src/layers/basic.jl:38 [inlined]\n [14] (::typeof(∂(λ)))(::CuArray{Float32,1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [15] #1059 at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/broadcast.jl:164 [inlined]\n [16] #3 at ./generator.jl:36 [inlined]\n [17] iterate at ./generator.jl:47 [inlined]\n [18] collect(::Base.Generator{Base.Iterators.Zip{Tuple{Array{typeof(∂(λ)),1},Array{CuArray{Float32,1},1}}},Base.var\"#3#4\"{Zygote.var\"#1059#1066\"}}) at ./array.jl:686\n [19] map at ./abstractarray.jl:2248 [inlined]\n [20] (::Zygote.var\"#1058#1065\"{Tuple{Array{CuArray{Float32,1},1}},Val{2},Array{typeof(∂(λ)),1}})(::Array{CuArray{Float32,1},1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/broadcast.jl:164\n [21] #3871#back at /home/zq/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [22] (::Zygote.var\"#178#179\"{Zygote.var\"#3871#back#1069\"{Zygote.var\"#1058#1065\"{Tuple{Array{CuArray{Float32,1},1}},Val{2},Array{typeof(∂(λ)),1}}},Tuple{Tuple{Nothing,Nothing,Nothing},Tuple{}}})(::Array{CuArray{Float32,1},1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/lib.jl:194\n [23] #1698#back at /home/zq/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [24] broadcasted at ./broadcast.jl:1257 [inlined]\n [25] (::typeof(∂(broadcasted)))(::Array{CuArray{Float32,1},1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [26] loss at ./In[339]:6 [inlined]\n [27] (::typeof(∂(loss)))(::Float32) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [28] #178 at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/lib.jl:194 [inlined]\n [29] #1698#back at /home/zq/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [30] #15 at /home/zq/.julia/packages/Flux/goUGu/src/optimise/train.jl:103 [inlined]\n [31] (::typeof(∂(λ)))(::Float32) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [32] (::Zygote.var\"#69#70\"{Params,Zygote.Context,typeof(∂(λ))})(::Float32) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface.jl:252\n [33] gradient(::Function, ::Params) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface.jl:59\n [34] macro expansion at /home/zq/.julia/packages/Flux/goUGu/src/optimise/train.jl:102 [inlined]\n [35] macro expansion at /home/zq/.julia/packages/Juno/n6wyj/src/progress.jl:134 [inlined]\n [36] train!(::Function, ::Params, ::DataLoader{Tuple{Array{Int64,1},Array{Int64,1}}}, ::ADAM; cb::Flux.Optimise.var\"#16#22\") at /home/zq/.julia/packages/Flux/goUGu/src/optimise/train.jl:100\n [37] train!(::Function, ::Params, ::DataLoader{Tuple{Array{Int64,1},Array{Int64,1}}}, ::ADAM) at /home/zq/.julia/packages/Flux/goUGu/src/optimise/train.jl:98\n [38] top-level scope at In[339]:10\n [39] include_string(::Function, ::Module, ::String, ::String) at ./loading.jl:1091```\n","user":"U01977X150R","ts":"1616991564.063300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DA5WF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I also attached the full stack trace here.\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"ArgumentError: NamedTuple{(:σ, :Wi, :Wh, :b, :h, :c),Tuple{Nothing,LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},CuArray{Float32,1},Nothing,Nothing}} keys must be a subset of NamedTuple{(:Wi, :Wh, :b, :h, :c),NTuple{5,Nothing}} keys\n\nStacktrace:\n [1] #s77#84 at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/lib.jl:20 [inlined]\n [2] #s77#84(::Any, ::Any, ::Any) at ./none:0\n [3] (::Core.GeneratedFunctionStub)(::Any, ::Vararg{Any,N} where N) at ./boot.jl:527\n [4] struct_grad!(::Zygote.Context, ::Flux.LSTMCell{CuArray{Float32,2},CuArray{Float32,1}}, ::NamedTuple{(:σ, :Wi, :Wh, :b, :h, :c),Tuple{Nothing,LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},LinearAlgebra.Transpose{Float32,CuArray{Float32,2}},CuArray{Float32,1},Nothing,Nothing}}) at /home/zq/.julia/packages/Flux/goUGu/src/cuda/curnn.jl:64\n [5] #13 at /home/zq/.julia/packages/Flux/goUGu/src/cuda/curnn.jl:86 [inlined]\n [6] #432#back at /home/zq/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [7] #178 at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/lib.jl:194 [inlined]\n [8] (::Zygote.var\"#1698#back#180\"{Zygote.var\"#178#179\"{Flux.CUDAint.var\"#432#back#15\"{Flux.CUDAint.var\"#13#14\"{Zygote.Context,Flux.LSTMCell{CuArray{Float32,2},CuArray{Float32,1}},CuArray{Float32,1},CuArray{Float32,1},CUDA.CUDNN.var\"#567#568\"{CUDA.CUDNN.RNNDesc{Float32},CuArray{Float32,1},CuArray{Float32,1},CuArray{Float32,1},CuArray{UInt8,1},CuArray{Float32,1}}}},Tuple{Tuple{Nothing},Tuple{Nothing}}}})(::Tuple{Nothing,CuArray{Float32,1}}) at /home/zq/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59\n [9] Recur at /home/zq/.julia/packages/Flux/goUGu/src/layers/recurrent.jl:36 [inlined]\n [10] (::typeof(∂(λ)))(::CuArray{Float32,1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [11] applychain at /home/zq/.julia/packages/Flux/goUGu/src/layers/basic.jl:36 [inlined]\n [12] (::typeof(∂(applychain)))(::CuArray{Float32,1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [13] Chain at /home/zq/.julia/packages/Flux/goUGu/src/layers/basic.jl:38 [inlined]\n [14] (::typeof(∂(λ)))(::CuArray{Float32,1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [15] #1059 at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/broadcast.jl:164 [inlined]\n [16] #3 at ./generator.jl:36 [inlined]\n [17] iterate at ./generator.jl:47 [inlined]\n [18] collect(::Base.Generator{Base.Iterators.Zip{Tuple{Array{typeof(∂(λ)),1},Array{CuArray{Float32,1},1}}},Base.var\"#3#4\"{Zygote.var\"#1059#1066\"}}) at ./array.jl:686\n [19] map at ./abstractarray.jl:2248 [inlined]\n [20] (::Zygote.var\"#1058#1065\"{Tuple{Array{CuArray{Float32,1},1}},Val{2},Array{typeof(∂(λ)),1}})(::Array{CuArray{Float32,1},1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/broadcast.jl:164\n [21] #3871#back at /home/zq/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [22] (::Zygote.var\"#178#179\"{Zygote.var\"#3871#back#1069\"{Zygote.var\"#1058#1065\"{Tuple{Array{CuArray{Float32,1},1}},Val{2},Array{typeof(∂(λ)),1}}},Tuple{Tuple{Nothing,Nothing,Nothing},Tuple{}}})(::Array{CuArray{Float32,1},1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/lib.jl:194\n [23] #1698#back at /home/zq/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [24] broadcasted at ./broadcast.jl:1257 [inlined]\n [25] (::typeof(∂(broadcasted)))(::Array{CuArray{Float32,1},1}) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [26] loss at ./In[339]:6 [inlined]\n [27] (::typeof(∂(loss)))(::Float32) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [28] #178 at /home/zq/.julia/packages/Zygote/9X8lu/src/lib/lib.jl:194 [inlined]\n [29] #1698#back at /home/zq/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [30] #15 at /home/zq/.julia/packages/Flux/goUGu/src/optimise/train.jl:103 [inlined]\n [31] (::typeof(∂(λ)))(::Float32) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface2.jl:0\n [32] (::Zygote.var\"#69#70\"{Params,Zygote.Context,typeof(∂(λ))})(::Float32) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface.jl:252\n [33] gradient(::Function, ::Params) at /home/zq/.julia/packages/Zygote/9X8lu/src/compiler/interface.jl:59\n [34] macro expansion at /home/zq/.julia/packages/Flux/goUGu/src/optimise/train.jl:102 [inlined]\n [35] macro expansion at /home/zq/.julia/packages/Juno/n6wyj/src/progress.jl:134 [inlined]\n [36] train!(::Function, ::Params, ::DataLoader{Tuple{Array{Int64,1},Array{Int64,1}}}, ::ADAM; cb::Flux.Optimise.var\"#16#22\") at /home/zq/.julia/packages/Flux/goUGu/src/optimise/train.jl:100\n [37] train!(::Function, ::Params, ::DataLoader{Tuple{Array{Int64,1},Array{Int64,1}}}, ::ADAM) at /home/zq/.julia/packages/Flux/goUGu/src/optimise/train.jl:98\n [38] top-level scope at In[339]:10\n [39] include_string(::Function, ::Module, ::String, ::String) at ./loading.jl:1091"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1616991525.063200","parent_user_id":"U01977X150R"},{"client_msg_id":"ef765f1e-8fe2-4d2d-819e-9f6b53f3dee8","type":"message","text":"Please open an issue on Flux","user":"UC4QQPG4A","ts":"1616994947.063500","team":"T68168MUP","edited":{"user":"UC4QQPG4A","ts":"1616994971.000000"},"blocks":[{"type":"rich_text","block_id":"r/WRl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Please open an issue on Flux"}]}]}],"thread_ts":"1616991525.063200","parent_user_id":"U01977X150R"},{"client_msg_id":"951d867b-5416-4c39-aaf9-0427063a1a1c","type":"message","text":"Will do that and many thanks, Dhairya.","user":"U01977X150R","ts":"1616995295.063800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PbO1j","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Will do that and many thanks, Dhairya."}]}]}],"thread_ts":"1616991525.063200","parent_user_id":"U01977X150R"}]