[{"client_msg_id":"0dd6f0a7-93bb-4323-b3c8-76d1adeec5ab","type":"message","text":"Suppose I’m using FileTrees.jl (or Dagger, if you like) to read and process multiple xml files in multiple directories. Is it better to use multithreading (which I take to be `cpus-per-task` in SLURM) or multiprocessing (which I take to be  the `nodes=??` setting in SLURM)?","user":"US8V7JSKB","ts":"1616461788.005300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"wzo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Suppose I’m using FileTrees.jl (or Dagger, if you like) to read and process multiple xml files in multiple directories. Is it better to use multithreading (which I take to be "},{"type":"text","text":"cpus-per-task","style":{"code":true}},{"type":"text","text":" in SLURM) or multiprocessing (which I take to be  the "},{"type":"text","text":"nodes=??","style":{"code":true}},{"type":"text","text":" setting in SLURM)?"}]}]}],"thread_ts":"1616461788.005300","reply_count":15,"reply_users_count":4,"latest_reply":"1617193906.020300","reply_users":["U6A0PD8CR","US8V7JSKB","U68P09RFZ","U7C8KRZKL"],"is_locked":false,"subscribed":false},{"client_msg_id":"28c7fb55-5e04-4a72-affc-edd2a50fa61a","type":"message","text":"Increase `cpus-per-task` first, and then `nodes`. *But* don't launch Julia with multiple threads, because Distributed isn't yet thread-safe, so bad things will happen. Instead do multiprocessing, with multiple Julia processes per node.","user":"U6A0PD8CR","ts":"1616466248.005400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"tuh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Increase "},{"type":"text","text":"cpus-per-task","style":{"code":true}},{"type":"text","text":" first, and then "},{"type":"text","text":"nodes","style":{"code":true}},{"type":"text","text":". "},{"type":"text","text":"But","style":{"bold":true}},{"type":"text","text":" don't launch Julia with multiple threads, because Distributed isn't yet thread-safe, so bad things will happen. Instead do multiprocessing, with multiple Julia processes per node."}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"3960a98f-2e29-44cd-a8eb-a3c43a807adc","type":"message","text":"When you say “don’t launch Julia with multiple threads”, is that just another way of saying, “don’t use multithreading; only use multiprocessing instead (for now)“?","user":"US8V7JSKB","ts":"1616466821.005600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"lf/H","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"When you say “don’t launch Julia with multiple threads”, is that just another way of saying, “don’t use multithreading; only use multiprocessing instead (for now)“?"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"4ae7009f-a4bf-4e6a-bdb4-95e79e12f928","type":"message","text":"Yep","user":"U6A0PD8CR","ts":"1616466834.005800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"c6pN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yep"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"95169420-e088-48c8-8385-0159f3dfecb3","type":"message","text":"It's unfortunate","user":"U6A0PD8CR","ts":"1616466850.006000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GrBtQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It's unfortunate"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"778fdf4a-6df7-4b18-8854-ca868257e522","type":"message","text":"Ah I see thanks so much! One more quick question: would running, say, 5 processes on a node in SLURM correspond to setting ntasks to 5 and nodes = 1? That’s what you had in mind, right? (Since you seem to know SLURM)","user":"US8V7JSKB","ts":"1616466963.006200","team":"T68168MUP","edited":{"user":"US8V7JSKB","ts":"1616466976.000000"},"blocks":[{"type":"rich_text","block_id":"QAlu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah I see thanks so much! One more quick question: would running, say, 5 processes on a node in SLURM correspond to setting ntasks to 5 and nodes = 1? That’s what you had in mind, right? (Since you seem to know SLURM)"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"06153271-6999-4c82-b3b9-f7d844c703f5","type":"message","text":"I don't actually know slurm well enough to answer that","user":"U6A0PD8CR","ts":"1616466988.006500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"je9N9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I don't actually know slurm well enough to answer that"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"39fceec5-0d25-443f-9d6d-6d5097e57a9e","type":"message","text":"np I can just ask the cluster ppl at my university. Thank you so much anw! :slightly_smiling_face:","user":"US8V7JSKB","ts":"1616467009.006700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"b2UR","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"np I can just ask the cluster ppl at my university. Thank you so much anw! "},{"type":"emoji","name":"slightly_smiling_face"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB","reactions":[{"name":"+1","users":["U6A0PD8CR"],"count":1}]},{"client_msg_id":"ab56624d-f0cd-476b-9cee-531d11c89f1b","type":"message","text":"Btw, if you're feeling adventurous, you could build a branch of Julia that makes Distributed thread-safe and see if multithreading works for you: <https://github.com/JuliaLang/julia/pull/38405>","user":"U6A0PD8CR","ts":"1616507888.007200","team":"T68168MUP","edited":{"user":"U6A0PD8CR","ts":"1616507898.000000"},"blocks":[{"type":"rich_text","block_id":"cyGio","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Btw, if you're feeling adventurous, you could build a branch of Julia that makes Distributed thread-safe and see if multithreading works for you: "},{"type":"link","url":"https://github.com/JuliaLang/julia/pull/38405"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB","reactions":[{"name":"+1","users":["US8V7JSKB"],"count":1}]},{"client_msg_id":"321106d9-1bb5-4137-a1c3-85b0357e8f1f","type":"message","text":"I typically use slurm tasks = julia processes, cpus_per_task = threads","user":"U68P09RFZ","ts":"1616513910.007500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"o5Eb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I typically use slurm tasks = julia processes, cpus_per_task = threads"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"073c7723-f562-4cd3-867f-c8127a3caf3f","type":"message","text":"but i don't know if it really matters?","user":"U68P09RFZ","ts":"1616513923.007700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"lC8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but i don't know if it really matters?"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"f73fb13b-a5fc-407b-b166-0600cdb65aa2","type":"message","text":"(that makes it easier to use with MPI)","user":"U68P09RFZ","ts":"1616513934.007900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VWm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"(that makes it easier to use with MPI)"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"1b2916d9-4705-4aa1-b0ee-3df357e3a92a","type":"message","text":"Thanks Simon!!","user":"US8V7JSKB","ts":"1616529518.009200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8K3p","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks Simon!!"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"b787343e-3b31-479c-90df-8b5888ebe9d1","type":"message","text":"I (did) do that too, but a recent analysis seems to show pretty clearly that the multithreaded code we're using is much slower than using multiple processes (and MPI) even on a single node - much to my surprise. There's no locking in my code, so it's a bit of a mystery. Does `Threads.@threads` introduce locking for you under the hood?","user":"U7C8KRZKL","ts":"1616767302.012000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Hoo4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I (did) do that too, but a recent analysis seems to show pretty clearly that the multithreaded code we're using is much slower than using multiple processes (and MPI) even on a single node - much to my surprise. There's no locking in my code, so it's a bit of a mystery. Does "},{"type":"text","text":"Threads.@threads","style":{"code":true}},{"type":"text","text":" introduce locking for you under the hood?"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"e672ee30-f788-4ba5-aa7e-ac26740f4290","type":"message","text":"There is locking if you do I/O","user":"U6A0PD8CR","ts":"1617021147.018000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9rZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"There is locking if you do I/O"}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"},{"client_msg_id":"e4ab786c-4e2f-4e15-9b82-7dd56dae277b","type":"message","text":"Hmm, no i/o inside the threads. I need to find time to dig into it more.","user":"U7C8KRZKL","ts":"1617193906.020300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ggq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm, no i/o inside the threads. I need to find time to dig into it more."}]}]}],"thread_ts":"1616461788.005300","parent_user_id":"US8V7JSKB"}]