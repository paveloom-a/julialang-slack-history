[{"client_msg_id":"f292845c-8ed0-417e-bd9d-cc949d87dc52","type":"message","text":"Hi everyone,\nI have a question for my neural ODE which is :\n```\nfunction dudt2(u,p,t)\n  FastChain(\n        (u,p) -&gt; ifelse(t &lt;= tc, c_int , 0) .- u,\n            FastDense(1, 2, tanh),\n        FastDense(2, 1))\nend\n\n\nfunction neural_ode_f(u,p,t)\n  FastChain((u,p) -&gt; ifelse(t &lt;= tc,c_int , 0) .- u,\n        FastDense(1, 2, tanh),\n        FastDense(2, 1))(u,p)\nend\n\npinit = initial_params(dudt2(u0,p_start,tbegin))\nprob = ODEProblem(neural_ode_f, u0, tspan, pinit)```\n\nDo you think that it understand the parameters p to learn ? Like this ODE \n```\nfunction odeTK(du, u, p,t)\n    if t &lt;= tc\n        du[1] = p[1]*c_int - p[2]u[1]\n    else t &gt; tc\n        du[1] = -p[2]*(u[1])\n    end\nend```\nAnd I’m not sure that it understand the if condition, because the result as the same when I only use\n\n```\nfunction dudt2(u,p,t)\n  FastChain(\n        (u,p) -&gt; c_int .- u,\n            FastDense(1, 2, tanh),\n        FastDense(2, 1))\nend\n\n\nfunction neural_ode_f(u,p,t)\n  FastChain((u,p) -&gt; c_int .- u,\n        FastDense(1, 2, tanh),\n        FastDense(2, 1))(u,p)\nend\n\npinit = initial_params(dudt2(u0,p_start,tbegin))\nprob = ODEProblem(neural_ode_f, u0, tspan, pinit)```\nThank you for your help :smile:","user":"U01NRTNRCDV","ts":"1615201820.003600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"KI2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hi everyone,\nI have a question for my neural ODE which is :\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"\nfunction dudt2(u,p,t)\n  FastChain(\n        (u,p) -> ifelse(t <= tc, c_int , 0) .- u,\n            FastDense(1, 2, tanh),\n        FastDense(2, 1))\nend\n\n\nfunction neural_ode_f(u,p,t)\n  FastChain((u,p) -> ifelse(t <= tc,c_int , 0) .- u,\n        FastDense(1, 2, tanh),\n        FastDense(2, 1))(u,p)\nend\n\npinit = initial_params(dudt2(u0,p_start,tbegin))\nprob = ODEProblem(neural_ode_f, u0, tspan, pinit)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"\n\nDo you think that it understand the parameters p to learn ? Like this ODE \n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"\nfunction odeTK(du, u, p,t)\n    if t <= tc\n        du[1] = p[1]*c_int - p[2]u[1]\n    else t > tc\n        du[1] = -p[2]*(u[1])\n    end\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"\nAnd I’m not sure that it understand the if condition, because the result as the same when I only use\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"\nfunction dudt2(u,p,t)\n  FastChain(\n        (u,p) -> c_int .- u,\n            FastDense(1, 2, tanh),\n        FastDense(2, 1))\nend\n\n\nfunction neural_ode_f(u,p,t)\n  FastChain((u,p) -> c_int .- u,\n        FastDense(1, 2, tanh),\n        FastDense(2, 1))(u,p)\nend\n\npinit = initial_params(dudt2(u0,p_start,tbegin))\nprob = ODEProblem(neural_ode_f, u0, tspan, pinit)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Thank you for your help "},{"type":"emoji","name":"smile"}]}]}],"thread_ts":"1615201820.003600","reply_count":16,"reply_users_count":5,"latest_reply":"1615275170.011900","reply_users":["UNG2XJJP3","U01NRTNRCDV","UDFRYRTBL","U6P4UPP9D","USFR23ZHQ"],"subscribed":false},{"client_msg_id":"e69fd889-ddad-48fd-85d1-807da1d3075c","type":"message","text":"Does your loss get decreased? The ifelse func is just a deterministic pre-conditioning and no NN parameters get trained there. I see no reason why it doesn’t understand.","user":"UNG2XJJP3","ts":"1615202403.003700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Swlss","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Does your loss get decreased? The ifelse func is just a deterministic pre-conditioning and no NN parameters get trained there. I see no reason why it doesn’t understand."}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"ae49c2e7-868f-4671-ad5f-7b773f1a9e77","type":"message","text":"Yes, it get decreased, but it stagnates at one after 300 epochs","user":"U01NRTNRCDV","ts":"1615209568.004300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"HXg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes, it get decreased, but it stagnates at one after 300 epochs"}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"type":"message","text":"It's my result :","files":[{"id":"F01R73NSMNU","created":1615209584,"timestamp":1615209584,"name":"image.png","title":"image.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"U01NRTNRCDV","editable":false,"size":32049,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01R73NSMNU/image.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01R73NSMNU/download/image.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01R73NSMNU-ee76afbc99/image_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01R73NSMNU-ee76afbc99/image_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01R73NSMNU-ee76afbc99/image_360.png","thumb_360_w":360,"thumb_360_h":240,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01R73NSMNU-ee76afbc99/image_480.png","thumb_480_w":480,"thumb_480_h":320,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01R73NSMNU-ee76afbc99/image_160.png","original_w":654,"original_h":436,"thumb_tiny":"AwAgADDSHXrS4pO/aj8aAD60tHPrSY96ABs4+XrSDOeaXmgfWgA6HpS0nQ9KM+xoAWikz7GjPsaAFoxSZ9jS59qAP//Z","permalink":"https://julialang.slack.com/files/U01NRTNRCDV/F01R73NSMNU/image.png","permalink_public":"https://slack-files.com/T68168MUP-F01R73NSMNU-4e2fac9724","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"s/Ymq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It's my result :"}]}]}],"user":"U01NRTNRCDV","display_as_bot":false,"ts":"1615209587.004500","thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"bede6ac3-de4c-4f36-b2e6-17140063cbbd","type":"message","text":"after 900 epochs\nI tried to change my NN architecture, but the result was still the same","user":"U01NRTNRCDV","ts":"1615209693.004900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ej49","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"after 900 epochs\nI tried to change my NN architecture, but the result was still the same"}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"00615bcf-8db3-4e02-b56b-514f5b6ceb65","type":"message","text":"Hmm, maybe it gets stuck in a local minimum. Try fitting over fewer time steps first, and then gradually increase.","user":"UDFRYRTBL","ts":"1615218138.005200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"E9u","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm, maybe it gets stuck in a local minimum. Try fitting over fewer time steps first, and then gradually increase."}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"aef752da-5da8-4de6-8346-eb6897f80af4","type":"message","text":"So you think it's the architecture of my network that is not adapted to my data?","user":"U01NRTNRCDV","ts":"1615219405.005400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"20u","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So you think it's the architecture of my network that is not adapted to my data?"}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"4676b070-282f-43f2-bb9e-d47bd5369ad9","type":"message","text":"It could happen. I’m not sure about your data and your c_int. Have you tested the FastChain without initial condition, does it converge?","user":"UNG2XJJP3","ts":"1615220895.005600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Qf4P","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It could happen. I’m not sure about your data and your c_int. Have you tested the FastChain without initial condition, does it converge?"}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"acb1dde0-d6ee-4fd6-97e6-5279565e4f58","type":"message","text":"No I didn't do that,...\n when you talk about the initial condition, did you mean u0 or pinit?","user":"U01NRTNRCDV","ts":"1615221215.005800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"11Fbm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"No I didn't do that,...\n when you talk about the initial condition, did you mean u0 or pinit?"}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"e25c4951-b4a7-419e-9041-9a831c3a8b7e","type":"message","text":"I mean your function of NN input, sth. like `(u,p) -&gt; c_int .- u`","user":"UNG2XJJP3","ts":"1615221271.006000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"E9H","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I mean your function of NN input, sth. like "},{"type":"text","text":"(u,p) -> c_int .- u","style":{"code":true}}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"7289012b-ea70-41ce-ba28-c2de372a7385","type":"message","text":"Ah! yes I tried, I have the same results as the previous picture.","user":"U01NRTNRCDV","ts":"1615221603.006200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cI+CG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah! yes I tried, I have the same results as the previous picture."}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"20b2065f-d027-4244-aabc-999d2c6dbee1","type":"message","text":"the loss converge, but never below 1","user":"U01NRTNRCDV","ts":"1615221675.006400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RUFd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the loss converge, but never below 1"}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"82aa9375-61e2-4e73-a888-6591762c41f7","type":"message","text":"So that’s clear: it’s the issue wrt data or training process, not your ifelse script.","user":"UNG2XJJP3","ts":"1615221791.006600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5hB1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So that’s clear: it’s the issue wrt data or training process, not your ifelse script."}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"9e78efb4-997a-4ac8-8ea1-258f56e4b8de","type":"message","text":"I guess you could refer here <https://diffeqflux.sciml.ai/dev/examples/local_minima/#>, and try adding more neurons.","user":"UNG2XJJP3","ts":"1615221855.006800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"49I","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I guess you could refer here "},{"type":"link","url":"https://diffeqflux.sciml.ai/dev/examples/local_minima/#"},{"type":"text","text":", and try adding more neurons."}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"a9549df5-1ead-4aa3-9e7c-62d1f440d3b9","type":"message","text":"Thank you, I will try this and I come back to you ! :slightly_smiling_face:","user":"U01NRTNRCDV","ts":"1615222059.007000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vajT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thank you, I will try this and I come back to you ! "},{"type":"emoji","name":"slightly_smiling_face"}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"6031e510-064e-467f-9c75-626bc6b1bccf","type":"message","text":"You can precondition the NN to a variety of reasonable shapes before the actual training to see which initial condition converges to the best minimum, like a multistart method.","user":"U6P4UPP9D","ts":"1615222686.007200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GPbVq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"You can precondition the NN to a variety of reasonable shapes before the actual training to see which initial condition converges to the best minimum, like a multistart method."}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"c64bd2f7-ade0-4c39-8aa4-c0219a48832b","type":"message","text":"Is this a one-dimensional problem? If so, I think I know what's wrong. The neural ODE can only model functions that are invertable, but yours is not. It finds the \"closest\" function but cannot find a better fit (no matter the number of neurons). Simply put: the data you are trying to fit to is not in the class of functions the neural ODE can model. Fortunately, you can use augmented neural ODEs to get around this, but the augmented dimensions does not have any physical interpretation, which may or may not be important to you","user":"USFR23ZHQ","ts":"1615275170.011900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cu0e","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is this a one-dimensional problem? If so, I think I know what's wrong. The neural ODE can only model functions that are invertable, but yours is not. It finds the \"closest\" function but cannot find a better fit (no matter the number of neurons). Simply put: the data you are trying to fit to is not in the class of functions the neural ODE can model. Fortunately, you can use augmented neural ODEs to get around this, but the augmented dimensions does not have any physical interpretation, which may or may not be important to you"}]}]}],"thread_ts":"1615201820.003600","parent_user_id":"U01NRTNRCDV"}]