[{"type":"message","text":"Question regarding Zygote.jl.  Any help is appreciated.\n\nHow do we handle sparse data when calculating the gradients? I get the following error:","files":[{"id":"F01RT1AB3GA","created":1616117418,"timestamp":1616117418,"name":"image.png","title":"image.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"U0158N77PFT","editable":false,"size":44225,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01RT1AB3GA/image.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01RT1AB3GA/download/image.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01RT1AB3GA-bfd395b484/image_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01RT1AB3GA-bfd395b484/image_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01RT1AB3GA-bfd395b484/image_360.png","thumb_360_w":360,"thumb_360_h":55,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01RT1AB3GA-bfd395b484/image_480.png","thumb_480_w":480,"thumb_480_h":74,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01RT1AB3GA-bfd395b484/image_160.png","thumb_720":"https://files.slack.com/files-tmb/T68168MUP-F01RT1AB3GA-bfd395b484/image_720.png","thumb_720_w":720,"thumb_720_h":111,"thumb_800":"https://files.slack.com/files-tmb/T68168MUP-F01RT1AB3GA-bfd395b484/image_800.png","thumb_800_w":800,"thumb_800_h":123,"thumb_960":"https://files.slack.com/files-tmb/T68168MUP-F01RT1AB3GA-bfd395b484/image_960.png","thumb_960_w":960,"thumb_960_h":148,"thumb_1024":"https://files.slack.com/files-tmb/T68168MUP-F01RT1AB3GA-bfd395b484/image_1024.png","thumb_1024_w":1024,"thumb_1024_h":158,"original_w":1091,"original_h":168,"thumb_tiny":"AwAHADCrkYpOKSimAvHr+lB20lFABx70ce9JRQB//9k=","permalink":"https://julialang.slack.com/files/U0158N77PFT/F01RT1AB3GA/image.png","permalink_public":"https://slack-files.com/T68168MUP-F01RT1AB3GA-67a083f35b","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"NMm/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Question regarding Zygote.jl.  Any help is appreciated.\n\nHow do we handle sparse data when calculating the gradients? I get the following error:"}]}]}],"user":"U0158N77PFT","display_as_bot":false,"ts":"1616117422.010200","edited":{"user":"U0158N77PFT","ts":"1616117456.000000"},"thread_ts":"1616117422.010200","reply_count":15,"reply_users_count":3,"latest_reply":"1616172419.015200","reply_users":["U01SFUPBJ9E","UH24GRBLL","U0158N77PFT"],"subscribed":false},{"client_msg_id":"23b7ce17-97e5-44c4-bb7c-836c3f9fa32d","type":"message","text":"Looks like the output of your function is a 1x1 vector (e.g. [0.0]). Can you make it a scalar instead? (e.g. 0.0)","user":"U01SFUPBJ9E","ts":"1616119423.010700","team":"T68168MUP","edited":{"user":"U01SFUPBJ9E","ts":"1616119641.000000"},"blocks":[{"type":"rich_text","block_id":"=5J","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Looks like the output of your function is a 1x1 vector (e.g. [0.0]). Can you make it a scalar instead? (e.g. 0.0)"}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT"},{"client_msg_id":"5ab1faa6-2ae7-4f00-9d40-730d0b6867d6","type":"message","text":"For example, the following won't work (using Zygote's gradient) because the output is a Vector:\n```gradient(b -&gt; [b], 0.0)```\nBut the following will work because the output is a scalar:\n```gradient(b -&gt; b, 0.0)```","user":"U01SFUPBJ9E","ts":"1616119576.010900","team":"T68168MUP","edited":{"user":"U01SFUPBJ9E","ts":"1616119888.000000"},"blocks":[{"type":"rich_text","block_id":"8NQIi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"For example, the following won't work (using Zygote's gradient) because the output is a Vector:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"gradient(b -> [b], 0.0)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"\nBut the following will work because the output is a scalar:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"gradient(b -> b, 0.0)"}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT","reactions":[{"name":"+1","users":["U0158N77PFT"],"count":1}]},{"client_msg_id":"824ab509-b54c-4a32-b8b9-6856961b1b94","type":"message","text":"Not sure why you think this is related to sparsity?","user":"UH24GRBLL","ts":"1616142696.011400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"WJ7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Not sure why you think this is related to sparsity?"}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT","reactions":[{"name":"+1","users":["U0158N77PFT"],"count":1}]},{"type":"message","text":"Thank you both for the feedback/questions - it led me to go back and retrace my steps.\n\nI have code that uses Zygote.jl to find the first row (81 terms) in an 6,561 element complex valued matrix. Long story, but I'm attempting to recover a unitary operator based on a set of complex valued input/output column vectors. Anyway, for this first effort I have dense data and everything went according to plan.\n\nFor the next experiment, I wanted to use sparse complex valued data to see how well I could recover the 6,561 element complex valued matrix. Another problem with this sparse data is that on average it's also orders of magnitude smaller than the previous data set. So I added SparseArrays.jl to clean the data up a bit (i.e., make values &lt; 1e-5 equal zero), but then when I went to run the code I got the error I posted previously.\n\nSo I went back to my old working code with the non-sparse data and got the same error (see below). Anyway, I removed SparseArrays.jl and all is well.\n\nThank you again for the comment and feedback!\n\nI did find what I believe to be a bug though between Zygote.jl and SparseArrays.jl -- or it could just be an emergent property of my crappy Julia proficiency.","files":[{"id":"F01RVMAS9DH","created":1616168077,"timestamp":1616168077,"name":"image.png","title":"image.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"U0158N77PFT","editable":false,"size":44935,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01RVMAS9DH/image.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01RVMAS9DH/download/image.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01RVMAS9DH-9737bd14d0/image_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01RVMAS9DH-9737bd14d0/image_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01RVMAS9DH-9737bd14d0/image_360.png","thumb_360_w":360,"thumb_360_h":49,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01RVMAS9DH-9737bd14d0/image_480.png","thumb_480_w":480,"thumb_480_h":65,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01RVMAS9DH-9737bd14d0/image_160.png","thumb_720":"https://files.slack.com/files-tmb/T68168MUP-F01RVMAS9DH-9737bd14d0/image_720.png","thumb_720_w":720,"thumb_720_h":97,"thumb_800":"https://files.slack.com/files-tmb/T68168MUP-F01RVMAS9DH-9737bd14d0/image_800.png","thumb_800_w":800,"thumb_800_h":108,"thumb_960":"https://files.slack.com/files-tmb/T68168MUP-F01RVMAS9DH-9737bd14d0/image_960.png","thumb_960_w":960,"thumb_960_h":130,"thumb_1024":"https://files.slack.com/files-tmb/T68168MUP-F01RVMAS9DH-9737bd14d0/image_1024.png","thumb_1024_w":1024,"thumb_1024_h":138,"original_w":1088,"original_h":147,"thumb_tiny":"AwAGADCr2oxRS9qYCYFBAFLTW6UAJkelHHvSUUAf/9k=","permalink":"https://julialang.slack.com/files/U0158N77PFT/F01RVMAS9DH/image.png","permalink_public":"https://slack-files.com/T68168MUP-F01RVMAS9DH-433c00d2d0","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"s4o","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thank you both for the feedback/questions - it led me to go back and retrace my steps.\n\nI have code that uses Zygote.jl to find the first row (81 terms) in an 6,561 element complex valued matrix. Long story, but I'm attempting to recover a unitary operator based on a set of complex valued input/output column vectors. Anyway, for this first effort I have dense data and everything went according to plan.\n\nFor the next experiment, I wanted to use sparse complex valued data to see how well I could recover the 6,561 element complex valued matrix. Another problem with this sparse data is that on average it's also orders of magnitude smaller than the previous data set. So I added SparseArrays.jl to clean the data up a bit (i.e., make values < 1e-5 equal zero), but then when I went to run the code I got the error I posted previously.\n\nSo I went back to my old working code with the non-sparse data and got the same error (see below). Anyway, I removed SparseArrays.jl and all is well.\n\nThank you again for the comment and feedback!\n\nI did find what I believe to be a bug though between Zygote.jl and SparseArrays.jl -- or it could just be an emergent property of my crappy Julia proficiency."}]}]}],"user":"U0158N77PFT","display_as_bot":false,"ts":"1616168143.011800","edited":{"user":"U0158N77PFT","ts":"1616168318.000000"},"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT","reactions":[{"name":"+1","users":["U01SFUPBJ9E"],"count":1}]},{"client_msg_id":"b95244c1-0c73-47c8-8015-be82fbebf233","type":"message","text":"<@U01SFUPBJ9E> - Still want to use SparseArrays.jl though. In line with your last comment, I have the following line of code:\n\n```grads = Zygote.gradient(m -&gt; loss(m, X[:, idx], Y[idx]), model)[1][]```\nWhere I'm iterating through 820 columns of X which are mapped to each element in Y to find the 81 terms of the previously mentioned complex matrix.\n\nHow could I convert `Y[idx]` to a scalar using your thoughts above?\n\nThanks again for any help.","user":"U0158N77PFT","ts":"1616171422.013000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"dpIL","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U01SFUPBJ9E"},{"type":"text","text":" - Still want to use SparseArrays.jl though. In line with your last comment, I have the following line of code:\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"grads = Zygote.gradient(m -> loss(m, X[:, idx], Y[idx]), model)[1][]"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"\nWhere I'm iterating through 820 columns of X which are mapped to each element in Y to find the 81 terms of the previously mentioned complex matrix.\n\nHow could I convert "},{"type":"text","text":"Y[idx]","style":{"code":true}},{"type":"text","text":" to a scalar using your thoughts above?\n\nThanks again for any help."}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT"},{"client_msg_id":"91865f13-bde1-4a0b-8654-d71999fb6e26","type":"message","text":"If you're still getting that second error posted above, I think the problem may be with your loss function return value rather than `Y[idx]`. Could you try something like this?\n```grads = Zygote.gradient(m -&gt; loss(m, X[:,idx], Y[idx])[1], model)[1]```\nThe first `[1]` should take the scalar out of the array returned by the anonymous function. The second `[1]` extracts the gradient from the tuple returned by `Zygote.gradient`.","user":"U01SFUPBJ9E","ts":"1616171630.013200","team":"T68168MUP","edited":{"user":"U01SFUPBJ9E","ts":"1616171656.000000"},"blocks":[{"type":"rich_text","block_id":"uili","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If you're still getting that second error posted above, I think the problem may be with your loss function return value rather than "},{"type":"text","text":"Y[idx]","style":{"code":true}},{"type":"text","text":". Could you try something like this?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"grads = Zygote.gradient(m -> loss(m, X[:,idx], Y[idx])[1], model)[1]"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"The first "},{"type":"text","text":"[1]","style":{"code":true}},{"type":"text","text":" should take the scalar out of the array returned by the anonymous function. The second "},{"type":"text","text":"[1]","style":{"code":true}},{"type":"text","text":" extracts the gradient from the tuple returned by "},{"type":"text","text":"Zygote.gradient","style":{"code":true}},{"type":"text","text":"."}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT"},{"client_msg_id":"64627322-ef51-4a4c-beeb-24dda99e4f08","type":"message","text":"Thank you for the quick reply. I tried it. Getting the same error. What if I extract the scalar from the vector and then take the gradient?","user":"U0158N77PFT","ts":"1616171758.013500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3/eC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thank you for the quick reply. I tried it. Getting the same error. What if I extract the scalar from the vector and then take the gradient?"}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT"},{"client_msg_id":"705de01a-3670-4761-9130-91e22825d936","type":"message","text":"not very elegant like your solutio","user":"U0158N77PFT","ts":"1616171777.013700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jy3fc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"not very elegant like your solutio"}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT"},{"client_msg_id":"3dc037dc-1f1f-4b3b-98b2-86fc5695f13d","type":"message","text":"n","user":"U0158N77PFT","ts":"1616171779.013900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YXLDe","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"n"}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT"},{"client_msg_id":"e17d733f-3c94-478e-aacd-e54a7fd5d92a","type":"message","text":"That could work--it's hard for me to tell without seeing a minimum working example haha. But I think that's going the right direction--the anonymous function you pass into the `gradient` function needs to return a scalar to the best of my knowledge. Maybe someone with deeper knowledge of Zygote could comment though.","user":"U01SFUPBJ9E","ts":"1616171984.014100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"x5b","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That could work--it's hard for me to tell without seeing a minimum working example haha. But I think that's going the right direction--the anonymous function you pass into the "},{"type":"text","text":"gradient","style":{"code":true}},{"type":"text","text":" function needs to return a scalar to the best of my knowledge. Maybe someone with deeper knowledge of Zygote could comment though."}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT"},{"client_msg_id":"495d9a6e-4846-4446-8961-4a182eaa5a57","type":"message","text":"Understood. Thanks again!","user":"U0158N77PFT","ts":"1616172052.014300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"eO1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Understood. Thanks again!"}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT","reactions":[{"name":"+1","users":["U01SFUPBJ9E"],"count":1}]},{"client_msg_id":"d22e5a8e-040e-4f15-b312-6d5ecfacd917","type":"message","text":"Yes, whatever you pass to `gradient` has to return a scalar, doesn't matter if whatever you put in is sparse or not","user":"UH24GRBLL","ts":"1616172275.014600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"V+UkI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes, whatever you pass to "},{"type":"text","text":"gradient","style":{"code":true}},{"type":"text","text":" has to return a scalar, doesn't matter if whatever you put in is sparse or not"}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT"},{"client_msg_id":"40018c2d-ecdd-4fb7-bb0f-473ba1df61bf","type":"message","text":"&gt; This will work equally well if the arguments are arrays, structs, or any other Julia type, but the function should return a scalar (like a loss or objective ll, if you're doing optimisation / ML).\nSee <https://fluxml.ai/Zygote.jl/dev/#Taking-Gradients-1>","user":"UH24GRBLL","ts":"1616172304.014800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"l=ww1","elements":[{"type":"rich_text_quote","elements":[{"type":"text","text":"This will work equally well if the arguments are arrays, structs, or any other Julia type, but the function should return a scalar (like a loss or objective ll, if you're doing optimisation / ML)."}]},{"type":"rich_text_section","elements":[{"type":"text","text":"\nSee "},{"type":"link","url":"https://fluxml.ai/Zygote.jl/dev/#Taking-Gradients-1"}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT"},{"client_msg_id":"1580fb1b-9057-482d-9ed8-853bd058021d","type":"message","text":"what does your `loss` function look like?","user":"UH24GRBLL","ts":"1616172398.015000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"67q","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"what does your "},{"type":"text","text":"loss","style":{"code":true}},{"type":"text","text":" function look like?"}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT"},{"client_msg_id":"1cd7596d-4bef-4f60-8afd-8a22739ee22e","type":"message","text":"what shape are `X` and `Y`?","user":"UH24GRBLL","ts":"1616172419.015200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"tap","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"what shape are "},{"type":"text","text":"X","style":{"code":true}},{"type":"text","text":" and "},{"type":"text","text":"Y","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1616117422.010200","parent_user_id":"U0158N77PFT"}]