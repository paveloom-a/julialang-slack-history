[{"client_msg_id":"acb186dc-1365-4c17-834a-8ca2fe6e8c09","type":"message","text":"Hi, I'm trying to use Neural ODE with DiFEqFlux. My equation is :\n```function true_ode(du,u,p,t)\n    true_A, true_B = p\n    if t &lt; tc\n        du[1] =true_A*0.041 - true_B*u[1]\n    else\n         du[1] = - true_B*u[1]\n    end\nend```\nAnd I want to put her in the neural network :\n```dudt = FastChain((u,p) -&gt; true_ode(u),\n        FastDense(1, 50, tanh),\n        FastDense(50, 1))```\nDo you think it's possible in spite the \"if\" temporal condition ?","user":"U01NRTNRCDV","ts":"1614269275.030400","team":"T68168MUP","edited":{"user":"U01NRTNRCDV","ts":"1614269321.000000"},"blocks":[{"type":"rich_text","block_id":"Nopxw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hi, I'm trying to use Neural ODE with DiFEqFlux. My equation is :\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function true_ode(du,u,p,t)\n    true_A, true_B = p\n    if t < tc\n        du[1] =true_A*0.041 - true_B*u[1]\n    else\n         du[1] = - true_B*u[1]\n    end\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"And I want to put her in the neural network :\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"dudt = FastChain((u,p) -> true_ode(u),\n        FastDense(1, 50, tanh),\n        FastDense(50, 1))"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Do you think it's possible in spite the \"if\" temporal condition ?"}]}]}],"thread_ts":"1614269275.030400","reply_count":17,"reply_users_count":5,"latest_reply":"1614351001.039600","reply_users":["U6A0PD8CR","U01NRTNRCDV","U6QF223TN","U69BL50BF","UUTHG4LLQ"],"subscribed":false},{"client_msg_id":"2597bf5f-3eb5-470d-812b-455a59dba1a7","type":"message","text":"`du[1] = ifelse(t &lt; tc, true_A*0.041 - true_B*u[1], - true_B*u[1])`","user":"U6A0PD8CR","ts":"1614275558.030800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TeO6W","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"du[1] = ifelse(t < tc, true_A*0.041 - true_B*u[1], - true_B*u[1])","style":{"code":true}}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV","reactions":[{"name":"thumbsup_all","users":["UUTHG4LLQ"],"count":1}]},{"client_msg_id":"ce3ed776-9836-42af-af67-1544dd800c47","type":"message","text":"With `ifelse`, both branches are executed, and the condition determines which of those results gets used","user":"U6A0PD8CR","ts":"1614275582.031000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"spo+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"With "},{"type":"text","text":"ifelse","style":{"code":true}},{"type":"text","text":", both branches are executed, and the condition determines which of those results gets used"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"59824c59-7e77-4794-bf56-663b36a664ce","type":"message","text":"You could probably also pull out the `true_B*u[1]` from the `ifelse`, since it's done regardless.","user":"U6A0PD8CR","ts":"1614275601.031200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"eeDC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"You could probably also pull out the "},{"type":"text","text":"true_B*u[1]","style":{"code":true}},{"type":"text","text":" from the "},{"type":"text","text":"ifelse","style":{"code":true}},{"type":"text","text":", since it's done regardless."}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"14ce619e-60f2-4d46-b571-ee3fd9a7a350","type":"message","text":"Thank you for your response. The neural network compiles but when I want to start training I get an error:\" UndefVarError: t not defined\".\nHow can I tell him that t is the time series of my data?","user":"U01NRTNRCDV","ts":"1614329810.036400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"61OwT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thank you for your response. The neural network compiles but when I want to start training I get an error:\" UndefVarError: t not defined\".\nHow can I tell him that t is the time series of my data?"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"4fbada87-a968-4357-9732-af5de5700edf","type":"message","text":"Does it say `t not defined` or `tc`?","user":"U6QF223TN","ts":"1614330833.036600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1bq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Does it say "},{"type":"text","text":"t not defined","style":{"code":true}},{"type":"text","text":" or "},{"type":"text","text":"tc","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"5e2c7159-6753-4219-b19f-7f5f502f856b","type":"message","text":"It's `t`","user":"U01NRTNRCDV","ts":"1614332930.036800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Mfp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It's "},{"type":"text","text":"t","style":{"code":true}}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"0b326468-cf04-4b8b-9896-158ac55bbdc9","type":"message","text":"```dudt = FastChain((u,p) -&gt; true_ode(u),\n        FastDense(1, 50, tanh),\n        FastDense(50, 1))```","user":"U69BL50BF","ts":"1614335879.037100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/oeV","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"dudt = FastChain((u,p) -> true_ode(u),\n        FastDense(1, 50, tanh),\n        FastDense(50, 1))"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"d1479384-72a6-449c-82d5-d990287fa82d","type":"message","text":"that's the part that makes no sense","user":"U69BL50BF","ts":"1614335883.037300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7ktiE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that's the part that makes no sense"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"55a4a131-be34-4e7d-83d3-4e5927ca9d01","type":"message","text":"you don't want to use the helper layer since you're violating its assumptions","user":"U69BL50BF","ts":"1614335913.037500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"s5PD0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you don't want to use the helper layer since you're violating its assumptions"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"86468da6-36da-4266-8e87-b0bc9831b6fd","type":"message","text":"instead see <https://diffeqflux.sciml.ai/dev/examples/neural_ode_sciml/#Usage-without-the-layer-1>","user":"U69BL50BF","ts":"1614335915.037700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"isa1q","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"instead see "},{"type":"link","url":"https://diffeqflux.sciml.ai/dev/examples/neural_ode_sciml/#Usage-without-the-layer-1"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"77e8bf41-a4c8-498e-838a-88b225b9e427","type":"message","text":"just directly define the ODE have your part and then the few fast denses","user":"U69BL50BF","ts":"1614335934.037900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"b3VO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"just directly define the ODE have your part and then the few fast denses"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"9bc2a246-a632-4233-aa27-7cd4b055c2c6","type":"message","text":"I do the same that <https://diffeqflux.sciml.ai/dev/examples/neural_ode_sciml/#Usage-without-the-layer-1>\n\nSo I have\n```dudt2 = FastChain((u,p) -&gt; ifelse(t &lt; tc, 0.041 , 0) - u,\n        FastDense(1, 50, tanh),\n        FastDense(50, 1))\n\nneural_ode_f(u,p,t) = dudt2(u,p)\npinit = initial_params(dudt2)\nprob = ODEProblem(neural_ode_f, u0, tspan, pinit)```\nand when I do :\n```result_neuralode = DiffEqFlux.sciml_train(loss_neuralode, pinit,\n                                          ADAM(0.05), cb = callback, maxiters = 300)```","user":"U01NRTNRCDV","ts":"1614345259.038300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YV+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I do the same that "},{"type":"link","url":"https://diffeqflux.sciml.ai/dev/examples/neural_ode_sciml/#Usage-without-the-layer-1"},{"type":"text","text":"\n\nSo I have\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"dudt2 = FastChain((u,p) -> ifelse(t < tc, 0.041 , 0) - u,\n        FastDense(1, 50, tanh),\n        FastDense(50, 1))\n\nneural_ode_f(u,p,t) = dudt2(u,p)\npinit = initial_params(dudt2)\nprob = ODEProblem(neural_ode_f, u0, tspan, pinit)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"and when I do :\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"result_neuralode = DiffEqFlux.sciml_train(loss_neuralode, pinit,\n                                          ADAM(0.05), cb = callback, maxiters = 300)"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"395c5275-e6a0-4def-97ea-fcb97f1935f0","type":"message","text":"I have an error `t not defined`","user":"U01NRTNRCDV","ts":"1614345326.038500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"N2JX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I have an error "},{"type":"text","text":"t not defined","style":{"code":true}}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"9cbb5ff0-8579-41e1-b4cf-a932d55e6630","type":"message","text":"no...","user":"U69BL50BF","ts":"1614345358.038700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PD7z","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"no..."}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"d68ae8ef-5e37-4238-968d-a5565c746500","type":"message","text":"```function neural_ode_f(u,p,t)\n  FastChain((u,p) -&gt; ifelse(t &lt; tc, 0.041 , 0) - u,\n        FastDense(1, 50, tanh),\n        FastDense(50, 1))\nend```","user":"U69BL50BF","ts":"1614345377.038900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"EGp57","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function neural_ode_f(u,p,t)\n  FastChain((u,p) -> ifelse(t < tc, 0.041 , 0) - u,\n        FastDense(1, 50, tanh),\n        FastDense(50, 1))\nend"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV","reactions":[{"name":"point_up::skin-tone-4","users":["U6QF223TN"],"count":1}]},{"client_msg_id":"5c7001e9-4987-4043-a012-4dc3f9a1d823","type":"message","text":"fine. but then, while this is working properly\n```neural_ode_f(u,p,t) = dudt2(u,p)```\nwriting as follow\n```function neural_ode_f(u,p,t)\n    FastChain((u, p) -&gt; u.^3,\n    FastDense(2, 50, tanh),\n    FastDense(50, 2))\nend```\nreturn a conversion error as\n```ERROR: MethodError: Cannot `convert` an object of type FastChain{Tuple{var\"#162#163\",FastDense{typeof(tanh),DiffEqFlux.var\"#initial_params#73\"{Array{Float32,1}}},FastDense{typeof(identity),DiffEqFlux.var\"#initial_params#73\"{Array{Float32,1}}}}} to an object of type Array{Float32,1}```","user":"UUTHG4LLQ","ts":"1614349937.039400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oT2R","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"fine. but then, while this is working properly\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"neural_ode_f(u,p,t) = dudt2(u,p)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"writing as follow\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function neural_ode_f(u,p,t)\n    FastChain((u, p) -> u.^3,\n    FastDense(2, 50, tanh),\n    FastDense(50, 2))\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"return a conversion error as\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"ERROR: MethodError: Cannot `convert` an object of type FastChain{Tuple{var\"#162#163\",FastDense{typeof(tanh),DiffEqFlux.var\"#initial_params#73\"{Array{Float32,1}}},FastDense{typeof(identity),DiffEqFlux.var\"#initial_params#73\"{Array{Float32,1}}}}} to an object of type Array{Float32,1}"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"},{"client_msg_id":"d259189f-48c0-4beb-992e-da2c3bd1e170","type":"message","text":"ok this formulation is working, but I don't know why and if it's fine\n```function neural_ode_f(u,p,t)\n    FastChain((u, p) -&gt; u.^3 .*t,\n    FastDense(2, 50, tanh),\n    FastDense(50, 2))(u,p)\nend```","user":"UUTHG4LLQ","ts":"1614351001.039600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"o7LzD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ok this formulation is working, but I don't know why and if it's fine\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function neural_ode_f(u,p,t)\n    FastChain((u, p) -> u.^3 .*t,\n    FastDense(2, 50, tanh),\n    FastDense(50, 2))(u,p)\nend"}]}]}],"thread_ts":"1614269275.030400","parent_user_id":"U01NRTNRCDV"}]