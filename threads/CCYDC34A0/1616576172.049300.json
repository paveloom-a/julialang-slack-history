[{"type":"message","text":"Apologies if this is a basic question - I am trying do do bayesian inference on a DE (with NUTS) and I am running into a problem that sometimes the sampling appears to get \"stuck\" while at other times the sampling seems to behave as expected. I've attached two screen shots at a small number of iterations showing this - The only thing I changed when running was the number of iterations. Are there any simple issues that could be the cause of this? I assume it's a modelling issue :disappointed:","files":[{"id":"F01SMF5HQ65","created":1616575876,"timestamp":1616575876,"name":"image.png","title":"image.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"U01C1H3GLLU","editable":false,"size":45278,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01SMF5HQ65/image.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01SMF5HQ65/download/image.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01SMF5HQ65-2e16f1c962/image_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01SMF5HQ65-2e16f1c962/image_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01SMF5HQ65-2e16f1c962/image_360.png","thumb_360_w":360,"thumb_360_h":91,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01SMF5HQ65-2e16f1c962/image_480.png","thumb_480_w":480,"thumb_480_h":122,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01SMF5HQ65-2e16f1c962/image_160.png","thumb_720":"https://files.slack.com/files-tmb/T68168MUP-F01SMF5HQ65-2e16f1c962/image_720.png","thumb_720_w":720,"thumb_720_h":182,"thumb_800":"https://files.slack.com/files-tmb/T68168MUP-F01SMF5HQ65-2e16f1c962/image_800.png","thumb_800_w":800,"thumb_800_h":203,"thumb_960":"https://files.slack.com/files-tmb/T68168MUP-F01SMF5HQ65-2e16f1c962/image_960.png","thumb_960_w":960,"thumb_960_h":243,"original_w":1019,"original_h":258,"thumb_tiny":"AwAMADDSBoyKXFFACZoFFGKAFopPxpfxoA//2Q==","permalink":"https://julialang.slack.com/files/U01C1H3GLLU/F01SMF5HQ65/image.png","permalink_public":"https://slack-files.com/T68168MUP-F01SMF5HQ65-d7d5b9c51f","is_starred":false,"has_rich_preview":false},{"id":"F01SYLNL08Y","created":1616575890,"timestamp":1616575890,"name":"image.png","title":"image.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"U01C1H3GLLU","editable":false,"size":35024,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01SYLNL08Y/image.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01SYLNL08Y/download/image.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01SYLNL08Y-5f7663b8db/image_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01SYLNL08Y-5f7663b8db/image_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01SYLNL08Y-5f7663b8db/image_360.png","thumb_360_w":360,"thumb_360_h":91,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01SYLNL08Y-5f7663b8db/image_480.png","thumb_480_w":480,"thumb_480_h":122,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01SYLNL08Y-5f7663b8db/image_160.png","thumb_720":"https://files.slack.com/files-tmb/T68168MUP-F01SYLNL08Y-5f7663b8db/image_720.png","thumb_720_w":720,"thumb_720_h":182,"thumb_800":"https://files.slack.com/files-tmb/T68168MUP-F01SYLNL08Y-5f7663b8db/image_800.png","thumb_800_w":800,"thumb_800_h":203,"thumb_960":"https://files.slack.com/files-tmb/T68168MUP-F01SYLNL08Y-5f7663b8db/image_960.png","thumb_960_w":960,"thumb_960_h":243,"original_w":1019,"original_h":258,"thumb_tiny":"AwAMADDRJ5p1GKMUAFJnmlpD0oAWik/GgdetAH//2Q==","permalink":"https://julialang.slack.com/files/U01C1H3GLLU/F01SYLNL08Y/image.png","permalink_public":"https://slack-files.com/T68168MUP-F01SYLNL08Y-1c818c7c96","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"CUWm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Apologies if this is a basic question - I am trying do do bayesian inference on a DE (with NUTS) and I am running into a problem that sometimes the sampling appears to get \"stuck\" while at other times the sampling seems to behave as expected. I've attached two screen shots at a small number of iterations showing this - The only thing I changed when running was the number of iterations. Are there any simple issues that could be the cause of this? I assume it's a modelling issue "},{"type":"emoji","name":"disappointed"}]}]}],"user":"U01C1H3GLLU","ts":"1616576172.049300","thread_ts":"1616576172.049300","reply_count":11,"reply_users_count":4,"latest_reply":"1616670418.079900","reply_users":["U01C2AJ9F63","UHDQQ4GN6","U01C1H3GLLU","U6QF223TN"],"is_locked":false,"subscribed":false},{"client_msg_id":"b9caa3f5-c041-42be-9622-591dca6df5d6","type":"message","text":"Hmm, the first thing I notice is that the scales vary. The scale in the second image is much much smaller. It's essentially as if zoomed in a lot. I would try to run multiple chains as well when debugging these kind of issues, because it allows for better diagnosing of whether chains actually do get stuck, or whether it is just a product of random initialization. But regardless, I agree the second image does look a bit peculiar.","user":"U01C2AJ9F63","ts":"1616577320.054800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/8Nba","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm, the first thing I notice is that the scales vary. The scale in the second image is much much smaller. It's essentially as if zoomed in a lot. I would try to run multiple chains as well when debugging these kind of issues, because it allows for better diagnosing of whether chains actually do get stuck, or whether it is just a product of random initialization. But regardless, I agree the second image does look a bit peculiar."}]}]}],"thread_ts":"1616576172.049300","parent_user_id":"U01C1H3GLLU","reactions":[{"name":"+1","users":["U01C1H3GLLU"],"count":1}]},{"client_msg_id":"7b7665a2-7392-4782-986f-38177018ef08","type":"message","text":"While all MCMC methods need a warm-up phase before they start returning good samples, NUTS also uses that phase to tune step size and metric (relative scale of all variables), which drastically improves sampling quality. Depending on your model, you probably need at least 500 warm-up steps before collecting any samples. Since the number of samples you're showing is low, I'm guessing the number of warm-up steps taken was low too? With NUTS and HMC, you also want to look at the `numerical_error` parameter. What you want to see is all 0s. If any are 1, then that means either tuning went poorly, or there's problem with the model that is causing the log probability to have high curvature, which breaks most MCMC samplers.","user":"UHDQQ4GN6","ts":"1616577328.055000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Wj6E","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"While all MCMC methods need a warm-up phase before they start returning good samples, NUTS also uses that phase to tune step size and metric (relative scale of all variables), which drastically improves sampling quality. Depending on your model, you probably need at least 500 warm-up steps before collecting any samples. Since the number of samples you're showing is low, I'm guessing the number of warm-up steps taken was low too? With NUTS and HMC, you also want to look at the "},{"type":"text","text":"numerical_error","style":{"code":true}},{"type":"text","text":" parameter. What you want to see is all 0s. If any are 1, then that means either tuning went poorly, or there's problem with the model that is causing the log probability to have high curvature, which breaks most MCMC samplers."}]}]}],"thread_ts":"1616576172.049300","parent_user_id":"U01C1H3GLLU","reactions":[{"name":"+1","users":["U01C1H3GLLU"],"count":1}]},{"client_msg_id":"7ba07927-3c22-4e3b-8491-795510b93e5a","type":"message","text":"Thank you :slightly_smiling_face:\nthe `numerical_error` seems to be 0s. How can you check the number of warm up steps? I don't see it in the internals of the chain","user":"U01C1H3GLLU","ts":"1616579481.058800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rfwO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thank you "},{"type":"emoji","name":"slightly_smiling_face"},{"type":"text","text":"\nthe "},{"type":"text","text":"numerical_error","style":{"code":true}},{"type":"text","text":" seems to be 0s. How can you check the number of warm up steps? I don't see it in the internals of the chain"}]}]}],"thread_ts":"1616576172.049300","parent_user_id":"U01C1H3GLLU"},{"client_msg_id":"a52da447-5ec4-462d-b96a-88dcd5faed4f","type":"message","text":"You mentioned scale of variables - does NUTS generally prefer for variables to be scaled? I've made mine lie between 0 &amp; 1","user":"U01C1H3GLLU","ts":"1616579658.059100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Qjv9C","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"You mentioned scale of variables - does NUTS generally prefer for variables to be scaled? I've made mine lie between 0 & 1"}]}]}],"thread_ts":"1616576172.049300","parent_user_id":"U01C1H3GLLU"},{"client_msg_id":"6f7c262e-03f5-4e9b-9bec-85f0ced7aad3","type":"message","text":"Sampling in general usually works better when variables are normalized, so it sounds like that wouldn't be the issue here.\n\nThis code snippet hopefully helps with setting the warmup step size.\n```sample(rng, model, NUTS(nwarmup, 0.8), MCMCThreads(), nwarmup + nsamples, nchains)```\nNote that `sample` expects to be passed the total number of steps (warmup + samples), and you pass the number of warmup steps to `NUTS`.","user":"UHDQQ4GN6","ts":"1616579863.059300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"IZOPk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Sampling in general usually works better when variables are normalized, so it sounds like that wouldn't be the issue here.\n\nThis code snippet hopefully helps with setting the warmup step size.\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"sample(rng, model, NUTS(nwarmup, 0.8), MCMCThreads(), nwarmup + nsamples, nchains)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Note that "},{"type":"text","text":"sample","style":{"code":true}},{"type":"text","text":" expects to be passed the total number of steps (warmup + samples), and you pass the number of warmup steps to "},{"type":"text","text":"NUTS","style":{"code":true}},{"type":"text","text":"."}]}]}],"thread_ts":"1616576172.049300","parent_user_id":"U01C1H3GLLU"},{"client_msg_id":"29f7f2d6-74b2-4d48-87b2-00869963ae18","type":"message","text":"Great, thanks for clarifying!","user":"U01C1H3GLLU","ts":"1616580219.061800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MLxN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Great, thanks for clarifying!"}]}]}],"thread_ts":"1616576172.049300","parent_user_id":"U01C1H3GLLU"},{"client_msg_id":"2c36a024-1ec0-46d8-b174-a17dfc85693b","type":"message","text":"Can you check the initial epsilon value you are getting in these different runs? ref: <https://github.com/TuringLang/AdvancedHMC.jl/issues/216>","user":"U6QF223TN","ts":"1616584884.064200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8VNO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Can you check the initial epsilon value you are getting in these different runs? ref: "},{"type":"link","url":"https://github.com/TuringLang/AdvancedHMC.jl/issues/216"}]}]}],"thread_ts":"1616576172.049300","parent_user_id":"U01C1H3GLLU"},{"client_msg_id":"f9b412b9-e9d9-4360-b94d-b80b27f1de3b","type":"message","text":"The initial step size is 0.00625 for both. Prior to this there are a few warnings - \"the current proposal will be rejected due to numerical errors. \"","user":"U01C1H3GLLU","ts":"1616588971.064400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"l65qN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The initial step size is 0.00625 for both. Prior to this there are a few warnings - \"the current proposal will be rejected due to numerical errors. \""}]}]}],"thread_ts":"1616576172.049300","parent_user_id":"U01C1H3GLLU"},{"client_msg_id":"85c120c7-e830-4892-916e-157ac2817a3e","type":"message","text":"Regarding me mention the scale, I guess ignore that, I don't think it is necessarily relevant. Regardless, I do believe it is also related to the initial random initialization. That is why for debugging and checking whether chains work as expected, it is better to use MCMCThreads to run multiple chains in parallel, this allows you to see more easily if it happens to all 4 chains, and also immediately allows you to check other things like whether chains converge and explore the same spaces or not.","user":"U01C2AJ9F63","ts":"1616595897.065100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"b2SB9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Regarding me mention the scale, I guess ignore that, I don't think it is necessarily relevant. Regardless, I do believe it is also related to the initial random initialization. That is why for debugging and checking whether chains work as expected, it is better to use MCMCThreads to run multiple chains in parallel, this allows you to see more easily if it happens to all 4 chains, and also immediately allows you to check other things like whether chains converge and explore the same spaces or not."}]}]}],"thread_ts":"1616576172.049300","parent_user_id":"U01C1H3GLLU"},{"client_msg_id":"02bdfcab-d358-4c7a-be8e-4435ce337600","type":"message","text":"thanks <@U01C2AJ9F63> I'll try this going forward.","user":"U01C1H3GLLU","ts":"1616599990.065800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8+aQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"thanks "},{"type":"user","user_id":"U01C2AJ9F63"},{"type":"text","text":" I'll try this going forward."}]}]}],"thread_ts":"1616576172.049300","parent_user_id":"U01C1H3GLLU"},{"type":"message","text":"With Seth's comments I was able to avoid the issue. And then multiple chains reveal converging to different places , haha","files":[{"id":"F01SKRP6Q4U","created":1616670415,"timestamp":1616670415,"name":"image.png","title":"image.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"U01C1H3GLLU","editable":false,"size":23148,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01SKRP6Q4U/image.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01SKRP6Q4U/download/image.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01SKRP6Q4U-7926e53992/image_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01SKRP6Q4U-7926e53992/image_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01SKRP6Q4U-7926e53992/image_360.png","thumb_360_w":360,"thumb_360_h":192,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01SKRP6Q4U-7926e53992/image_480.png","thumb_480_w":480,"thumb_480_h":256,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01SKRP6Q4U-7926e53992/image_160.png","original_w":666,"original_h":355,"thumb_tiny":"AwAZADDSzwaWk9frS9qADtQOO+aKKACignFFADemfrSg8Up6UUAICKMilFFACZyaAecUtHegD//Z","permalink":"https://julialang.slack.com/files/U01C1H3GLLU/F01SKRP6Q4U/image.png","permalink_public":"https://slack-files.com/T68168MUP-F01SKRP6Q4U-e4bd462818","is_starred":false,"has_rich_preview":false}],"upload":false,"blocks":[{"type":"rich_text","block_id":"FQzh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"With Seth's comments I was able to avoid the issue. And then multiple chains reveal converging to different places , haha"}]}]}],"user":"U01C1H3GLLU","display_as_bot":false,"ts":"1616670418.079900","thread_ts":"1616576172.049300","parent_user_id":"U01C1H3GLLU"}]