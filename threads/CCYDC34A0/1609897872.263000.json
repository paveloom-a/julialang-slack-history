[{"client_msg_id":"3bece1e4-479b-4bc1-b865-de80141eb35a","type":"message","text":"This is a simpler version of my question above. Why does the code below fail to sample with HMC\n```using Turing\n\nB = [5141181, 3795214, 2739591, 1782803, 1262850,  822732,  551119, 353990,  220015,  132850,   76394,   42184,   21126,    9761, 4016,    1318,     409,      83,      11,       3]\n\n\nfunction MM_theory(a)\n    w = zeros(Float64, 10)\n    for i in 1:10\n        w[i] = B[i] - a\n    end\n    return w\nend\n\nfunction run_mcmc(Nstep)\n\n    @model function MM_model(MM)\n        a ~ Uniform()\n        MM ~ MvNormal(MM_theory(a), ones(10))\n    end\n\n    chn = sample(MM_model(ones(10)), HMC(0.1, 5), Nstep)\n\nend```\nwhen I run `run_mcmc(1000)` ?","user":"UPK2KJ95Y","ts":"1609897872.263000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Poerw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This is a simpler version of my question above. Why does the code below fail to sample with HMC\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using Turing\n\nB = [5141181, 3795214, 2739591, 1782803, 1262850,  822732,  551119, 353990,  220015,  132850,   76394,   42184,   21126,    9761, 4016,    1318,     409,      83,      11,       3]\n\n\nfunction MM_theory(a)\n    w = zeros(Float64, 10)\n    for i in 1:10\n        w[i] = B[i] - a\n    end\n    return w\nend\n\nfunction run_mcmc(Nstep)\n\n    @model function MM_model(MM)\n        a ~ Uniform()\n        MM ~ MvNormal(MM_theory(a), ones(10))\n    end\n\n    chn = sample(MM_model(ones(10)), HMC(0.1, 5), Nstep)\n\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"when I run "},{"type":"text","text":"run_mcmc(1000)","style":{"code":true}},{"type":"text","text":" ?"}]}]}],"thread_ts":"1609897872.263000","reply_count":3,"reply_users_count":2,"latest_reply":"1609899021.263500","reply_users":["UHDQQ4GN6","UPK2KJ95Y"],"subscribed":false},{"client_msg_id":"4fa9b1d8-05d2-4b2c-a5ae-de82e0bc5058","type":"message","text":"I'm going to guess it's this line: `w = zeros(Float64, 10)`. HMC needs gradients, which for most AD's are computed using type-overloading. Changing the line to `w = zeros(Base.promote_eltype(B,a), 10)` should resolve that. Zygote should be able to handle the `Float64` type constraint, but it can't handle mutation. With Zygote, you'd want to do something like `w = view(B, 1:10) .- a`.","user":"UHDQQ4GN6","ts":"1609898400.263100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"CsYj","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm going to guess it's this line: "},{"type":"text","text":"w = zeros(Float64, 10)","style":{"code":true}},{"type":"text","text":". HMC needs gradients, which for most AD's are computed using type-overloading. Changing the line to "},{"type":"text","text":"w = zeros(Base.promote_eltype(B,a), 10)","style":{"code":true}},{"type":"text","text":" should resolve that. Zygote should be able to handle the "},{"type":"text","text":"Float64","style":{"code":true}},{"type":"text","text":" type constraint, but it can't handle mutation. With Zygote, you'd want to do something like "},{"type":"text","text":"w = view(B, 1:10) .- a","style":{"code":true}},{"type":"text","text":"."}]}]}],"thread_ts":"1609897872.263000","parent_user_id":"UPK2KJ95Y"},{"client_msg_id":"f9c0d493-0a65-4b9b-b32c-5520d1a14c20","type":"message","text":"Sorry, to be clear, gradients are computed using automatic differentation (AD). Zygote is one of the compatible AD engine. There are others (see Turing docs).","user":"UHDQQ4GN6","ts":"1609898435.263300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ksx","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Sorry, to be clear, gradients are computed using automatic differentation (AD). Zygote is one of the compatible AD engine. There are others (see Turing docs)."}]}]}],"thread_ts":"1609897872.263000","parent_user_id":"UPK2KJ95Y"},{"client_msg_id":"647f4fb4-79b8-4271-abfa-74e6129116a5","type":"message","text":"Thanks, that worked.","user":"UPK2KJ95Y","ts":"1609899021.263500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7mo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks, that worked."}]}]}],"thread_ts":"1609897872.263000","parent_user_id":"UPK2KJ95Y"}]