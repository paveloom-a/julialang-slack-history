[{"client_msg_id":"f3f9b73a-b611-4558-8694-7e7bec869a71","type":"message","text":"I'm trying to debug my Turing model:\n```@model function gdemo(datasets)\n    σ₀ ~ Gamma(1.0, 1/0.02) # μm^2\n    logκ ~ Normal(log(2000), 2) # NoUnits\n    cm ~ TruncatedNormal(2.35, 1.5, 0.0, Inf) # NoUnits\n    e0 ~ Gamma(1.0, 1/0.2) # Gy\n    logsf_sigma ~ Gamma(1.0, 1/0.2)\n    density = 1u\"g/cm^3\"\n    dlogs = map(d -&gt; d.log_sfs, datasets)\n\n    for (i, dataset) in enumerate(datasets)\n        doses = dataset.doses\n\n        cur_beta = e2beta(dataset.E)\n        cur_zeff = zeff(dataset.Z, cur_beta)\n        zkb = cur_zeff^2/(cur_beta^2 * exp(logκ))\n        p_ion_kill = (1.0 - exp(-zkb))^cm\n        σ = σ₀ * p_ion_kill\n\n        alet = glet(cur_beta, dataset.Z)\n        log_ion_kill = σ .* uconvert.(Ref(NoUnits), -density .* doses ./ alet .* 1.0u\"μm^2\")\n        \n        doses_Gy = uconvert.(Ref(NoUnits), doses ./ 1.0u\"Gy\")\n\n        log_gamma_kill = log.(1.0 .- (1.0 .- exp.(- (1.0 .- p_ion_kill) .* doses_Gy ./ e0)).^cm)\n        logsfs_mu = log_ion_kill + log_gamma_kill\n\n        dlogs[i] ~ MvNormal(logsfs_mu, logsf_sigma)\n    end\nend```\nIt seems to not fit to my data at all, that is posteriors for the first five variables in this model look more or less like priors. Yet `ess` and `rhat` in chain statistics look great. Is there any obvious error?","user":"U9AHT3YM7","ts":"1616600346.068100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"buE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm trying to debug my Turing model:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"@model function gdemo(datasets)\n    σ₀ ~ Gamma(1.0, 1/0.02) # μm^2\n    logκ ~ Normal(log(2000), 2) # NoUnits\n    cm ~ TruncatedNormal(2.35, 1.5, 0.0, Inf) # NoUnits\n    e0 ~ Gamma(1.0, 1/0.2) # Gy\n    logsf_sigma ~ Gamma(1.0, 1/0.2)\n    density = 1u\"g/cm^3\"\n    dlogs = map(d -> d.log_sfs, datasets)\n\n    for (i, dataset) in enumerate(datasets)\n        doses = dataset.doses\n\n        cur_beta = e2beta(dataset.E)\n        cur_zeff = zeff(dataset.Z, cur_beta)\n        zkb = cur_zeff^2/(cur_beta^2 * exp(logκ))\n        p_ion_kill = (1.0 - exp(-zkb))^cm\n        σ = σ₀ * p_ion_kill\n\n        alet = glet(cur_beta, dataset.Z)\n        log_ion_kill = σ .* uconvert.(Ref(NoUnits), -density .* doses ./ alet .* 1.0u\"μm^2\")\n        \n        doses_Gy = uconvert.(Ref(NoUnits), doses ./ 1.0u\"Gy\")\n\n        log_gamma_kill = log.(1.0 .- (1.0 .- exp.(- (1.0 .- p_ion_kill) .* doses_Gy ./ e0)).^cm)\n        logsfs_mu = log_ion_kill + log_gamma_kill\n\n        dlogs[i] ~ MvNormal(logsfs_mu, logsf_sigma)\n    end\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"It seems to not fit to my data at all, that is posteriors for the first five variables in this model look more or less like priors. Yet "},{"type":"text","text":"ess","style":{"code":true}},{"type":"text","text":" and "},{"type":"text","text":"rhat","style":{"code":true}},{"type":"text","text":" in chain statistics look great. Is there any obvious error?"}]}]}],"thread_ts":"1616600346.068100","reply_count":12,"reply_users_count":2,"latest_reply":"1616770227.095400","reply_users":["UC0SY9JFP","U9AHT3YM7"],"is_locked":false,"subscribed":false},{"client_msg_id":"0f3d29c0-19e8-46c9-8b36-8a0dfcdcbf28","type":"message","text":"Turing determines what to condition on based on the function arguments. So you need to have `dlogs` to be the function argument. Currently Turing will sample `dlogs` from the prior and not condition on anything.","user":"UC0SY9JFP","ts":"1616600610.068200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8R6Ue","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Turing determines what to condition on based on the function arguments. So you need to have "},{"type":"text","text":"dlogs","style":{"code":true}},{"type":"text","text":" to be the function argument. Currently Turing will sample "},{"type":"text","text":"dlogs","style":{"code":true}},{"type":"text","text":" from the prior and not condition on anything."}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7"},{"client_msg_id":"9e8f1289-eb96-4c86-be9c-ca38a618c654","type":"message","text":"Basically, do this `dlogs = map(d -&gt; d.log_sfs, datasets)` outside the Turing model, change the function signature and pass `gdemo(dlogs, datasets)`.","user":"UC0SY9JFP","ts":"1616600712.068400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7sX7r","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Basically, do this "},{"type":"text","text":"dlogs = map(d -> d.log_sfs, datasets)","style":{"code":true}},{"type":"text","text":" outside the Turing model, change the function signature and pass "},{"type":"text","text":"gdemo(dlogs, datasets)","style":{"code":true}},{"type":"text","text":"."}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7"},{"client_msg_id":"95917827-0691-4844-b02c-687f09e2d7b2","type":"message","text":"oh, thanks!","user":"U9AHT3YM7","ts":"1616600769.068600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4Slh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh, thanks!"}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7"},{"client_msg_id":"f731f156-76ed-4dbb-be7f-e24b7b5aaf1e","type":"message","text":"hm, after making this change log evidence decreased from 0 to about -200 to -1000 (depending on the dataset) but that's all","user":"U9AHT3YM7","ts":"1616601354.068800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"V6L","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hm, after making this change log evidence decreased from 0 to about -200 to -1000 (depending on the dataset) but that's all"}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7"},{"client_msg_id":"e58a85e7-09de-4c1b-8d87-04adb08291f9","type":"message","text":"posteriors look more or less the same","user":"U9AHT3YM7","ts":"1616601368.069000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ODbl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"posteriors look more or less the same"}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7","reactions":[{"name":"face_with_raised_eyebrow","users":["UC0SY9JFP"],"count":1}]},{"client_msg_id":"9d359222-2862-4a49-9d9b-2c4fd24d1607","type":"message","text":"Do you have some MWE that you can share?","user":"UC0SY9JFP","ts":"1616601737.069300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"67n","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Do you have some MWE that you can share?"}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7"},{"client_msg_id":"8c28541b-8726-478c-bce5-b941430c2684","type":"message","text":"I have a meeting now, I'll try making one later","user":"U9AHT3YM7","ts":"1616601751.069500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"lez","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I have a meeting now, I'll try making one later"}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7"},{"client_msg_id":"03f30087-aa90-4e92-9d01-7e025b7e0855","type":"message","text":"Here you go: <https://gist.github.com/mateuszbaran/727296f36e6948f96e2c2d8e1ab5a937>","user":"U9AHT3YM7","ts":"1616606713.069700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"J51l","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Here you go: "},{"type":"link","url":"https://gist.github.com/mateuszbaran/727296f36e6948f96e2c2d8e1ab5a937"}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7"},{"client_msg_id":"b3363d7b-fc0d-4295-8dbc-147d41860186","type":"message","text":":slightly_smiling_face:","user":"U9AHT3YM7","ts":"1616606717.069900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YCI","elements":[{"type":"rich_text_section","elements":[{"type":"emoji","name":"slightly_smiling_face"}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7"},{"client_msg_id":"ddb1dde9-3498-4d05-b901-ce29e822449b","type":"message","text":"I tried with NUTS sampler today and it somewhat converges but quite poorly for σ₀ (which still has quite high ESS and rhat very close to 1). Why did the IS sampler perform so poorly?","user":"U9AHT3YM7","ts":"1616690857.086800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cjxD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I tried with NUTS sampler today and it somewhat converges but quite poorly for σ₀ (which still has quite high ESS and rhat very close to 1). Why did the IS sampler perform so poorly?"}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7"},{"client_msg_id":"3eae2676-3ab3-4e5f-85df-beb5369f7120","type":"message","text":"Importance sampling requires that the proposal distribution is close to the target distribution to work well. In Turing we use the prior as the proposal distribution (if I remember correctly), which can be a bad choice in certain cases. I think <@UHDNY2YMA> experimented with learning the proposal distribution formulated through a normalising flow but learning flows is quite difficult so that this didn’t end up in the code base.","user":"UC0SY9JFP","ts":"1616759164.094500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pos","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Importance sampling requires that the proposal distribution is close to the target distribution to work well. In Turing we use the prior as the proposal distribution (if I remember correctly), which can be a bad choice in certain cases. I think "},{"type":"user","user_id":"UHDNY2YMA"},{"type":"text","text":" experimented with learning the proposal distribution formulated through a normalising flow but learning flows is quite difficult so that this didn’t end up in the code base."}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7"},{"client_msg_id":"6453afa4-ac7c-415d-b967-92ac69ef1a3f","type":"message","text":"Thanks for a tip :slightly_smiling_face: . I'll keep experimenting with different samplers and priors but unfortunately one of them needs to be very weakly informative.","user":"U9AHT3YM7","ts":"1616770227.095400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+n0=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks for a tip "},{"type":"emoji","name":"slightly_smiling_face"},{"type":"text","text":" . I'll keep experimenting with different samplers and priors but unfortunately one of them needs to be very weakly informative."}]}]}],"thread_ts":"1616600346.068100","parent_user_id":"U9AHT3YM7"}]