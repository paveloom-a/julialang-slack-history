[{"client_msg_id":"10689df6-3fbe-476c-b414-34fdae06757c","type":"message","text":"Ok, as someone noticed, the problem I posted above was actually trivial. Thanks. The problem I actually want to solve is\n```res[i, j] = (A[:, i]-A[:,j])' * Sigma * (A[:, i] - A[:, j])```\nI refactored this into\n```using BenchmarkTools\nusing LinearAlgebra\n\nfunction differences!(res, A, Σ)\n    D, M = size(A)\n    Temp = similar(A)\n    Temp2 = similar(A)\n    Temp3 = similar(A)\n    for i=1:M\n        Temp .= A[:, i] .- A\n        mul!(Temp2, Σ, A[:, i] .- A)\n        Temp3 .= Temp .* Temp2\n        sum!(res[:, i]', Temp3)\n    end\n    res\nend\n\nD = 500\nM = 300\n\nbench1 = @benchmark differences!(res, A, Σ) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    Σ = rand(D, D);\n)```\nand am getting\n```julia&gt; bench1\nBenchmarkTools.Trial: \n  memory estimate:  349.89 MiB\n  allocs estimate:  1506\n  --------------\n  minimum time:     416.358 ms (1.70% GC)\n  median time:      429.999 ms (1.66% GC)\n  mean time:        443.107 ms (4.95% GC)\n  maximum time:     598.346 ms (31.10% GC)\n  --------------\n  samples:          12\n  evals/sample:     1```\n","user":"U7PD3M3L5","ts":"1617982181.166500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Mjxh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ok, as someone noticed, the problem I posted above was actually trivial. Thanks. The problem I actually want to solve is\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"res[i, j] = (A[:, i]-A[:,j])' * Sigma * (A[:, i] - A[:, j])"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"I refactored this into\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using BenchmarkTools\nusing LinearAlgebra\n\nfunction differences!(res, A, Σ)\n    D, M = size(A)\n    Temp = similar(A)\n    Temp2 = similar(A)\n    Temp3 = similar(A)\n    for i=1:M\n        Temp .= A[:, i] .- A\n        mul!(Temp2, Σ, A[:, i] .- A)\n        Temp3 .= Temp .* Temp2\n        sum!(res[:, i]', Temp3)\n    end\n    res\nend\n\nD = 500\nM = 300\n\nbench1 = @benchmark differences!(res, A, Σ) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    Σ = rand(D, D);\n)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"and am getting\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> bench1\nBenchmarkTools.Trial: \n  memory estimate:  349.89 MiB\n  allocs estimate:  1506\n  --------------\n  minimum time:     416.358 ms (1.70% GC)\n  median time:      429.999 ms (1.66% GC)\n  mean time:        443.107 ms (4.95% GC)\n  maximum time:     598.346 ms (31.10% GC)\n  --------------\n  samples:          12\n  evals/sample:     1"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1617982181.166500","reply_count":7,"reply_users_count":3,"latest_reply":"1618028017.180900","reply_users":["UH24GRBLL","U7PD3M3L5","U011V2YN59N"],"is_locked":false,"subscribed":false},{"client_msg_id":"4d8a6b70-4e80-49f6-af09-94359ae9e087","type":"message","text":"`Temp .= A[:, i] .- A` &lt;-- this allocates","user":"UH24GRBLL","ts":"1617982305.167300","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1617982311.000000"},"blocks":[{"type":"rich_text","block_id":"alMwu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Temp .= A[:, i] .- A","style":{"code":true}},{"type":"text","text":" <-- this allocates"}]}]}],"thread_ts":"1617982181.166500","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"35bdffbc-4457-40f3-a88f-0621f41e63f2","type":"message","text":"`Temp .= (@view A[:, i]) .- A` &lt;--- this should not","user":"UH24GRBLL","ts":"1617982333.167600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"P2zF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Temp .= (@view A[:, i]) .- A","style":{"code":true}},{"type":"text","text":" <--- this should not"}]}]}],"thread_ts":"1617982181.166500","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"2e20b527-fa96-49e7-aec4-0b3b5cd0b987","type":"message","text":"Ok, I'll try that too, thanks :slightly_smiling_face:","user":"U7PD3M3L5","ts":"1617982383.168200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"eJw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ok, I'll try that too, thanks "},{"type":"emoji","name":"slightly_smiling_face"}]}]}],"thread_ts":"1617982181.166500","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"48f05154-0f6a-4a60-941e-2238fdc2ea8d","type":"message","text":"if you have a CUDA capable GPU you get pretty significant speedups even including copying to and from the GPU\n```using BenchmarkTools\nusing LinearAlgebra\nusing CUDA\nfunction differences!(res_cpu, A_cpu, Σ_cpu)\n    res = cu(res_cpu)\n    A = cu(A_cpu)\n    Σ = cu(Σ_cpu)\n    \n    D, M = size(A)\n    Temp = similar(A)\n    Temp2 = similar(A)\n    Temp3 = similar(A)\n    for i=1:M\n        Temp .= A[:, i] .- A\n        mul!(Temp2, Σ, A[:, i] .- A)\n        Temp3 .= Temp .* Temp2\n        sum!(res[:, i]', Temp3)\n    end\n    Array(res)\nend\n\nD = 500\nM = 300\n\nbench1 = @benchmark differences!(res, A, Σ) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    Σ = rand(D, D);\n)```","user":"U011V2YN59N","ts":"1618027213.180300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Wb2ef","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if you have a CUDA capable GPU you get pretty significant speedups even including copying to and from the GPU\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using BenchmarkTools\nusing LinearAlgebra\nusing CUDA\nfunction differences!(res_cpu, A_cpu, Σ_cpu)\n    res = cu(res_cpu)\n    A = cu(A_cpu)\n    Σ = cu(Σ_cpu)\n    \n    D, M = size(A)\n    Temp = similar(A)\n    Temp2 = similar(A)\n    Temp3 = similar(A)\n    for i=1:M\n        Temp .= A[:, i] .- A\n        mul!(Temp2, Σ, A[:, i] .- A)\n        Temp3 .= Temp .* Temp2\n        sum!(res[:, i]', Temp3)\n    end\n    Array(res)\nend\n\nD = 500\nM = 300\n\nbench1 = @benchmark differences!(res, A, Σ) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    Σ = rand(D, D);\n)"}]}]}],"thread_ts":"1617982181.166500","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"d0f612a9-cdc5-44a9-9a7f-065c449c5813","type":"message","text":"```julia&gt; include(\"scratch.jl\")\nBenchmarkTools.Trial: \n  memory estimate:  2.49 MiB\n  allocs estimate:  89082\n  --------------\n  minimum time:     23.536 ms (0.00% GC)\n  median time:      24.314 ms (0.00% GC)\n  mean time:        25.087 ms (1.38% GC)\n  maximum time:     34.001 ms (9.56% GC)\n  --------------\n  samples:          189\n  evals/sample:     1```","user":"U011V2YN59N","ts":"1618027677.180500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"LQF","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> include(\"scratch.jl\")\nBenchmarkTools.Trial: \n  memory estimate:  2.49 MiB\n  allocs estimate:  89082\n  --------------\n  minimum time:     23.536 ms (0.00% GC)\n  median time:      24.314 ms (0.00% GC)\n  mean time:        25.087 ms (1.38% GC)\n  maximum time:     34.001 ms (9.56% GC)\n  --------------\n  samples:          189\n  evals/sample:     1"}]}]}],"thread_ts":"1617982181.166500","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"ea6d7abf-9ed0-4e99-938b-8830525bd5b6","type":"message","text":"also you appear to compute `A[:, i] .- A` twice","user":"U011V2YN59N","ts":"1618027998.180700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"K1rif","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"also you appear to compute "},{"type":"text","text":"A[:, i] .- A","style":{"code":true}},{"type":"text","text":" twice"}]}]}],"thread_ts":"1617982181.166500","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"24430cad-eafb-4705-994e-b91cc5105158","type":"message","text":"`mul!(Temp2, Σ, A[:, i] .- A)` could just be `mul!(Temp2, Σ, Temp)`","user":"U011V2YN59N","ts":"1618028017.180900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2h82q","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"mul!(Temp2, Σ, A[:, i] .- A)","style":{"code":true}},{"type":"text","text":" could just be "},{"type":"text","text":"mul!(Temp2, Σ, Temp)","style":{"code":true}}]}]}],"thread_ts":"1617982181.166500","parent_user_id":"U7PD3M3L5"}]