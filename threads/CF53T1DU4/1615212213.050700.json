[{"client_msg_id":"6603f50a-416b-4553-a5c4-5325513394d8","type":"message","text":"I would greatly appreciate if someone experienced with threading design commented in <https://github.com/JuliaData/DataFrames.jl/pull/2647> what conditions we should use in DataFrames.jl to turn-on using multi-threading (I can do it by trial and error, but maybe there are some concrete recommendations about conditions when one can expect to get speedup from using `Threads.@threads` - essentially the question is what is the cost of setting up and handling task switching). Thank you! CC <@U67431ELR>","user":"U8JAMQGQY","ts":"1615212213.050700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"syM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I would greatly appreciate if someone experienced with threading design commented in "},{"type":"link","url":"https://github.com/JuliaData/DataFrames.jl/pull/2647"},{"type":"text","text":" what conditions we should use in DataFrames.jl to turn-on using multi-threading (I can do it by trial and error, but maybe there are some concrete recommendations about conditions when one can expect to get speedup from using "},{"type":"text","text":"Threads.@threads","style":{"code":true}},{"type":"text","text":" - essentially the question is what is the cost of setting up and handling task switching). Thank you! CC "},{"type":"user","user_id":"U67431ELR"}]}]}],"thread_ts":"1615212213.050700","reply_count":5,"reply_users_count":2,"latest_reply":"1615213067.051600","reply_users":["U67431ELR","U8JAMQGQY"],"subscribed":false},{"client_msg_id":"f2fa6353-31af-4135-b0dc-0f31fd5555c9","type":"message","text":"The specific difficulty there is that the overhead is not just that of spawning threads as in most cases: it's that we have to allocate a temporary array to store partial results for each thread, and then reduce per-thread arrays into a single array. So adding threads can be significantly slower unless there are many rows and few groups.","user":"U67431ELR","ts":"1615212675.050800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7Zw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The specific difficulty there is that the overhead is not just that of spawning threads as in most cases: it's that we have to allocate a temporary array to store partial results for each thread, and then reduce per-thread arrays into a single array. So adding threads can be significantly slower unless there are many rows and few groups."}]}]}],"thread_ts":"1615212213.050700","parent_user_id":"U8JAMQGQY"},{"client_msg_id":"cea0ba4c-0791-41c5-8cb1-3bddfa55a7e1","type":"message","text":"This is a follow up question I wanted to avoid to start with :slightly_smiling_face:. The more complex PR <@U67431ELR> is referencing to is <https://github.com/JuliaData/DataFrames.jl/pull/2491>.","user":"U8JAMQGQY","ts":"1615212770.051000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4ye","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This is a follow up question I wanted to avoid to start with "},{"type":"emoji","name":"slightly_smiling_face"},{"type":"text","text":". The more complex PR "},{"type":"user","user_id":"U67431ELR"},{"type":"text","text":" is referencing to is "},{"type":"link","url":"https://github.com/JuliaData/DataFrames.jl/pull/2491"},{"type":"text","text":"."}]}]}],"thread_ts":"1615212213.050700","parent_user_id":"U8JAMQGQY"},{"client_msg_id":"feaa0417-21d6-493a-b652-3ea206d922b4","type":"message","text":"Unfortunately I don't think we can avoid it. This case is significantly more tricky that usual patterns where the overhead is constant. :slightly_smiling_face:","user":"U67431ELR","ts":"1615212883.051200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PsF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Unfortunately I don't think we can avoid it. This case is significantly more tricky that usual patterns where the overhead is constant. "},{"type":"emoji","name":"slightly_smiling_face"}]}]}],"thread_ts":"1615212213.050700","parent_user_id":"U8JAMQGQY"},{"client_msg_id":"a50a4be0-2314-4165-b8f3-a597563403ad","type":"message","text":"Indeed","user":"U8JAMQGQY","ts":"1615212930.051400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"wRH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Indeed"}]}]}],"thread_ts":"1615212213.050700","parent_user_id":"U8JAMQGQY"},{"client_msg_id":"14290e95-789e-4c35-91e5-1c3cfb17c8c1","type":"message","text":"Sorry I was indeed referring to #2491, which is more complex than #<https://github.com/JuliaData/DataFrames.jl/pull/2647|2647 >which <@U8JAMQGQY> was referring to<https://github.com/JuliaData/DataFrames.jl/pull/2647|.>","user":"U67431ELR","ts":"1615213067.051600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"S0+D","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Sorry I was indeed referring to #2491, which is more complex than #"},{"type":"link","url":"https://github.com/JuliaData/DataFrames.jl/pull/2647","text":"2647 "},{"type":"text","text":"which ","style":{"unlink":true}},{"type":"user","user_id":"U8JAMQGQY"},{"type":"text","text":" was referring to","style":{"unlink":true}},{"type":"link","url":"https://github.com/JuliaData/DataFrames.jl/pull/2647","text":"."}]}]}],"thread_ts":"1615212213.050700","parent_user_id":"U8JAMQGQY"}]