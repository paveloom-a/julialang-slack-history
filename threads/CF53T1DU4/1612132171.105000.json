[{"client_msg_id":"6a288d03-023b-4e31-8b2d-de0f66aa27e3","type":"message","text":"Can anyone make the vectorized and inplace version (bottom) of the top function faster?\n```function Base.rand(rng::AbstractRNG, s::ZWDist)\n    return ifelse(Base.rand(rng) &lt; s.α, 0, Base.rand(rng,s.base_dist))\nend\n\nfunction Random.rand!(rng::AbstractRNG, s::ZWDist, l::T) where T&lt;:AbstractVector\n    Random.rand!(rng,l)\n    l[l .&lt; s.α] .= 0\n    Random.rand!(rng,s.base_dist,@view l[l .&gt;= s.α])\n    return nothing\nend```","user":"U011V2YN59N","ts":"1612132171.105000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zNl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Can anyone make the vectorized and inplace version (bottom) of the top function faster?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function Base.rand(rng::AbstractRNG, s::ZWDist)\n    return ifelse(Base.rand(rng) < s.α, 0, Base.rand(rng,s.base_dist))\nend\n\nfunction Random.rand!(rng::AbstractRNG, s::ZWDist, l::T) where T<:AbstractVector\n    Random.rand!(rng,l)\n    l[l .< s.α] .= 0\n    Random.rand!(rng,s.base_dist,@view l[l .>= s.α])\n    return nothing\nend"}]}]}],"thread_ts":"1612132171.105000","reply_count":126,"reply_users_count":2,"latest_reply":"1612164953.131800","reply_users":["U011V2YN59N","UH24GRBLL"],"subscribed":false},{"client_msg_id":"c0ea0b91-b080-4f33-b8bf-521d8899525d","type":"message","text":"Distribution definition:\n```struct ZWDist{BaseDistType,T} &lt;: Sampleable{Univariate,Discrete}\n    α::T\n    base_dist::BaseDistType\nend```\nif a uniform random number is less than α, return 0, otherwise return a sample from base_dist","user":"U011V2YN59N","ts":"1612132245.105100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=aY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Distribution definition:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"struct ZWDist{BaseDistType,T} <: Sampleable{Univariate,Discrete}\n    α::T\n    base_dist::BaseDistType\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"if a uniform random number is less than α, return 0, otherwise return a sample from base_dist"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"40667a20-6dc4-48f5-91b5-8eac46362628","type":"message","text":"don't create masks for broadcasting if you'll index with them","user":"UH24GRBLL","ts":"1612132336.105300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kFs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"don't create masks for broadcasting if you'll index with them"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"0637c151-6a0f-4795-8990-7b091ce3fc76","type":"message","text":"you'll probably also want to use `zero(eltype(l))`","user":"UH24GRBLL","ts":"1612132362.105500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"HuLde","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you'll probably also want to use "},{"type":"text","text":"zero(eltype(l))","style":{"code":true}}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"0bc9e2ab-290f-483a-a207-82564942f76b","type":"message","text":"what's `BaseDistType`?","user":"UH24GRBLL","ts":"1612132390.105700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cQp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"what's "},{"type":"text","text":"BaseDistType","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"477b891a-15e6-4496-8285-54282592c983","type":"message","text":"good point","user":"U011V2YN59N","ts":"1612132430.105900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"c=bJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"good point"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"4753b23b-f42c-4cce-93dc-6eac1efc678a","type":"message","text":"some Discrete univariate distribution from Distributions.jl","user":"U011V2YN59N","ts":"1612132452.106100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vftbS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"some Discrete univariate distribution from Distributions.jl"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"20e32aa2-91f7-4957-89c2-1923c14cb488","type":"message","text":"the question is if it is `abstract` or not","user":"UH24GRBLL","ts":"1612132465.106300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YCb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the question is if it is "},{"type":"text","text":"abstract","style":{"code":true}},{"type":"text","text":" or not"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"4a194d5f-1e5f-4209-8a8c-3e59daa05a16","type":"message","text":"no","user":"U011V2YN59N","ts":"1612132525.106500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Na2Oz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"no"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"6ef13796-024b-4820-a684-74c459d618b7","type":"message","text":"```julia&gt; d\nZWDist{Distributions.Poisson{Float64}, Float64}(0.5, Distributions.Poisson{Float64}(λ=1.0))\n\njulia&gt; isabstracttype(typeof(d.base_dist))\nfalse```","user":"U011V2YN59N","ts":"1612132786.107100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8SNM","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> d\nZWDist{Distributions.Poisson{Float64}, Float64}(0.5, Distributions.Poisson{Float64}(λ=1.0))\n\njulia> isabstracttype(typeof(d.base_dist))\nfalse"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"43aa6ca9-8958-40b6-b456-f4d143f09775","type":"message","text":"ah, you used it as a typevar, it's not a type!","user":"UH24GRBLL","ts":"1612132916.107300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+Qv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ah, you used it as a typevar, it's not a type!"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"511c64f1-7a50-4e8c-92f1-90c2b7e47c6b","type":"message","text":"I see","user":"UH24GRBLL","ts":"1612132917.107500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9RQZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I see"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"83159ef8-3341-46f6-b15e-246914446398","type":"message","text":"ah yes, I see what you meant now","user":"U011V2YN59N","ts":"1612133006.107700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+/i","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ah yes, I see what you meant now"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"5addf15e-edf6-4e6a-b3b7-f40c657180f7","type":"message","text":"why is using masks when broadcasting like that bad? I thought it might be faster to compute only the samples we need, especially for large \\alpha","user":"U011V2YN59N","ts":"1612133050.107900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nvs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"why is using masks when broadcasting like that bad? I thought it might be faster to compute only the samples we need, especially for large \\alpha"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"5943f260-209a-4966-8f30-d13e74c32538","type":"message","text":"it allocates the mask","user":"UH24GRBLL","ts":"1612133063.108100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XqLu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it allocates the mask"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"28501a83-f85b-4de6-a22f-7a27283a8921","type":"message","text":"do I read this correctly that it recurses into `rand!`?","user":"UH24GRBLL","ts":"1612133080.108300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"EKWb5","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"do I read this correctly that it recurses into "},{"type":"text","text":"rand!","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"e449c797-2105-4cd6-a86c-0cbc808667c5","type":"message","text":"you'll iterate over all those views a bunch more often than necessary","user":"UH24GRBLL","ts":"1612133106.108500","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1612133109.000000"},"blocks":[{"type":"rich_text","block_id":"Jrmq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you'll iterate over all those views a bunch more often than necessary"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"e81cb74c-8f9d-4f31-8632-64870877775b","type":"message","text":"no it doesn't, since `base_dist` is not a `ZWDist`","user":"U011V2YN59N","ts":"1612133110.108800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yxxo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"no it doesn't, since "},{"type":"text","text":"base_dist","style":{"code":true}},{"type":"text","text":" is not a "},{"type":"text","text":"ZWDist","style":{"code":true}}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"bf36e00d-5336-4d16-a802-364d4102c01c","type":"message","text":"it samples from the base_dist","user":"U011V2YN59N","ts":"1612133116.109000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DZJRd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it samples from the base_dist"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"a3595cfd-50c1-4cfb-aa41-a29f5f1ec988","type":"message","text":"right","user":"UH24GRBLL","ts":"1612133123.109200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"dSaAx","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"right"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"f89e45c9-0dff-4826-9339-6e71fbf6d37c","type":"message","text":"yeah I'd just write the loop explicitly here and not try to vectorize at all","user":"UH24GRBLL","ts":"1612133182.109400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vvKh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah I'd just write the loop explicitly here and not try to vectorize at all"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"3a32b141-9182-4b98-9fa2-2240a9a49aec","type":"message","text":"the `&gt;= s.a` is basically some random draw whether it's true or not, right?","user":"UH24GRBLL","ts":"1612133198.109600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"NGNJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the "},{"type":"text","text":">= s.a","style":{"code":true}},{"type":"text","text":" is basically some random draw whether it's true or not, right?"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"af8f8c45-2d52-43f0-a12d-3d4a0a78c13c","type":"message","text":"so without placing the data in a consecutive block of memory, you're not getting SIMD anyway","user":"UH24GRBLL","ts":"1612133223.109800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"r6N","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so without placing the data in a consecutive block of memory, you're not getting SIMD anyway"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"308c70c1-a4c0-4980-9182-66127170405c","type":"message","text":"so it'd probably be faster to just iterate once","user":"UH24GRBLL","ts":"1612133235.110000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nyq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so it'd probably be faster to just iterate once"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"e4795370-01a2-4185-b270-f41757d7763b","type":"message","text":"oh good call, sometimes I forget that I can just write loops","user":"U011V2YN59N","ts":"1612133280.110200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/Fx/o","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh good call, sometimes I forget that I can just write loops"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"2efd8fa9-ab3e-43a5-9e96-48688ce3c07f","type":"message","text":"I'll give that a try thanks!","user":"U011V2YN59N","ts":"1612133287.110400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"heVcq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'll give that a try thanks!"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"769f02df-2171-4210-ae4c-da92cc26d439","type":"message","text":"you can do a trick here:\n\n```for i in eachindex(l)\n    l[i] = (l[i] &gt;= s.a) * rand(rng, s.base_dist)\nend```","user":"UH24GRBLL","ts":"1612133331.110600","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1612133354.000000"},"blocks":[{"type":"rich_text","block_id":"utv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you can do a trick here:\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"for i in eachindex(l)\n    l[i] = (l[i] >= s.a) * rand(rng, s.base_dist)\nend"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"3cde9e25-2def-4b11-bd95-327c5f56c92e","type":"message","text":"depending on how large `l` is, you may be able to unroll this manually","user":"UH24GRBLL","ts":"1612133391.110900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Au00","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"depending on how large "},{"type":"text","text":"l","style":{"code":true}},{"type":"text","text":" is, you may be able to unroll this manually"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"84103990-f911-4b49-b0c1-e2d271e8a94c","type":"message","text":"but this avoids branches :)","user":"UH24GRBLL","ts":"1612133403.111100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ROI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but this avoids branches :)"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"10137d34-84f6-4147-b51d-683555bea3ec","type":"message","text":"`l` needs to be filled first though, so it would be\n```for i in eachindex(l)\n    l[i] = (rand(rng) &gt;= s.a) * rand(rng, s.base_dist)\nend```","user":"U011V2YN59N","ts":"1612133421.111300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8xOm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"l","style":{"code":true}},{"type":"text","text":" needs to be filled first though, so it would be\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"for i in eachindex(l)\n    l[i] = (rand(rng) >= s.a) * rand(rng, s.base_dist)\nend"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"53f8808c-fb37-40dd-acd4-8e938d4a9d71","type":"message","text":"oh yeah, I didn't think about the filling at all","user":"UH24GRBLL","ts":"1612133458.111500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nfcg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh yeah, I didn't think about the filling at all"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"6f5a94dc-ab61-44ff-961d-5cef66e4012a","type":"message","text":"i'm surprised that multiplying by a boolean bit doesn't cause type issues","user":"U011V2YN59N","ts":"1612133466.111700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Cah","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"i'm surprised that multiplying by a boolean bit doesn't cause type issues"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"938a8225-4cd4-4721-9e86-6d96605c4272","type":"message","text":"boolean are numbers","user":"UH24GRBLL","ts":"1612133476.111900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"m87/S","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"boolean are numbers"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"ca784efc-bf25-4406-bcb3-6a2be1973e32","type":"message","text":"right","user":"U011V2YN59N","ts":"1612133496.112100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4mE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"right"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"845b4b94-58a7-47ad-beed-89a4cd619817","type":"message","text":"does it automatically cast to `zero(eltype(l))` ?","user":"U011V2YN59N","ts":"1612133517.112300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"u/p","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"does it automatically cast to "},{"type":"text","text":"zero(eltype(l))","style":{"code":true}},{"type":"text","text":" ?"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"92947fcd-4154-4fd8-bdf7-a57c50b5de5d","type":"message","text":"it should promote, yeah","user":"UH24GRBLL","ts":"1612133526.112500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Yr3HX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it should promote, yeah"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"49478271-3e46-41e7-8910-70a676456d05","type":"message","text":"nice, thanks!","user":"U011V2YN59N","ts":"1612133541.112700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8zs8+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"nice, thanks!"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"8267b24a-d6b7-4aac-b449-ba7144c14124","type":"message","text":"give it a try before thanking me :joy:","user":"UH24GRBLL","ts":"1612133577.112900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"J4O3P","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"give it a try before thanking me "},{"type":"emoji","name":"joy"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"6be91f27-4e92-457b-98fd-2f3b5d71678c","type":"message","text":"I may have missed something that's detrimental","user":"UH24GRBLL","ts":"1612133590.113100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"N4b7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I may have missed something that's detrimental"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"90dc9595-5821-4fb8-8535-1ec256806e90","type":"message","text":"yeah.. it does not allocate, but it is 20 times slower","user":"U011V2YN59N","ts":"1612133629.113300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hQ6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah.. it does not allocate, but it is 20 times slower"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"b87f9927-99a9-4b27-89e3-800f5740899f","type":"message","text":"```julia&gt; @btime rand!(r,d,l)\n  20.222 μs (0 allocations: 0 bytes)\n\njulia&gt; @btime rand!(r,d,l)\n  1.172 μs (6 allocations: 1.21 KiB)```","user":"U011V2YN59N","ts":"1612133635.113500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"S5eJ","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @btime rand!(r,d,l)\n  20.222 μs (0 allocations: 0 bytes)\n\njulia> @btime rand!(r,d,l)\n  1.172 μs (6 allocations: 1.21 KiB)"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"044f03f3-81f8-408a-b82a-30849038e6c2","type":"message","text":"hm, missing SIMD probably","user":"UH24GRBLL","ts":"1612133645.113700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"V7LCv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hm, missing SIMD probably"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"190386a3-db90-40b4-838e-06f9f475d2ad","type":"message","text":"for a 100-element vector","user":"U011V2YN59N","ts":"1612133650.113900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Bgh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"for a 100-element vector"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"336f336c-5843-4c04-bbc0-1b19a9d664a6","type":"message","text":"adding `@simd` doesn't help though","user":"U011V2YN59N","ts":"1612133697.114100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jonWJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"adding "},{"type":"text","text":"@simd","style":{"code":true}},{"type":"text","text":" doesn't help though"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"b5aa6dac-fab2-48fc-9eef-50fadb179bc2","type":"message","text":"ok, then how about\n```rand!(rng, l)\nl .= (l .&gt;= s.a) .* rand(rng, s.base_dist, length(l))```","user":"UH24GRBLL","ts":"1612133712.114300","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1612133744.000000"},"blocks":[{"type":"rich_text","block_id":"zZ+e+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ok, then how about\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"rand!(rng, l)\nl .= (l .>= s.a) .* rand(rng, s.base_dist, length(l))"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"80d01939-377a-402b-80b5-7bca56632bd0","type":"message","text":"may allocate, but only loops twice","user":"UH24GRBLL","ts":"1612133721.114500","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1612133780.000000"},"blocks":[{"type":"rich_text","block_id":"Hghv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"may allocate, but only loops twice"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"a5fe7c66-dd80-45c4-b2c3-909e12a9ccc5","type":"message","text":"your original version looped basically three times - first for the `rand!`, then for the `.= 0`, then for the `.&gt;= s.a`","user":"UH24GRBLL","ts":"1612133807.115000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+=FZf","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"your original version looped basically three times - first for the "},{"type":"text","text":"rand!","style":{"code":true}},{"type":"text","text":", then for the "},{"type":"text","text":".= 0","style":{"code":true}},{"type":"text","text":", then for the "},{"type":"text","text":".>= s.a","style":{"code":true}}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"829c807a-62ee-4f0a-aee5-21b3844ce7f1","type":"message","text":"slower\n```julia&gt; @btime rand!(r,d,l)\n  1.468 μs (1 allocation: 896 bytes)\n100-element Vector{Float64}:```","user":"U011V2YN59N","ts":"1612133817.115200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"grj","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"slower\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @btime rand!(r,d,l)\n  1.468 μs (1 allocation: 896 bytes)\n100-element Vector{Float64}:"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"bfd7dce6-ed25-40bf-8cba-721859cf4b40","type":"message","text":"yes but fewer calls to `rand(`","user":"U011V2YN59N","ts":"1612133824.115400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Adr","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yes but fewer calls to "},{"type":"text","text":"rand(","style":{"code":true}}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"6fdf1f5c-8c09-47b8-98be-36b5eae1e7f0","type":"message","text":"is that the biggest vector you'll ever put in?","user":"UH24GRBLL","ts":"1612133848.115600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oRdn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"is that the biggest vector you'll ever put in?"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"c18deef0-c4c9-478a-b26a-066c60e3965e","type":"message","text":"or what is the purpose of this function","user":"UH24GRBLL","ts":"1612133865.115800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"aLO81","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"or what is the purpose of this function"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"d9135f72-ce00-44dd-9b6c-2d0fe5e2c9f5","type":"message","text":"nope","user":"U011V2YN59N","ts":"1612133873.116000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rWaac","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"nope"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"4aad4adb-4c5b-45fe-a3c3-472b9dd77643","type":"message","text":"ah yours is faster for 1000 elements","user":"U011V2YN59N","ts":"1612133879.116200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TI7AE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ah yours is faster for 1000 elements"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"40864ed6-b640-42ae-ac9f-7cbc91393794","type":"message","text":"^^","user":"UH24GRBLL","ts":"1612133883.116400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VMjqk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"^^"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"f699c300-6e76-4fca-b767-fad42b261a99","type":"message","text":"what about the non-allocating version?","user":"UH24GRBLL","ts":"1612133893.116600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"X1/Pn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"what about the non-allocating version?"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"4f3d6896-799b-4084-b318-671cdd368cfc","type":"message","text":"it's about 30% faster for 1000","user":"U011V2YN59N","ts":"1612133919.116800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GZ1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's about 30% faster for 1000"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"35503e03-58ac-489c-9822-63f4180551c0","type":"message","text":"um I will test","user":"U011V2YN59N","ts":"1612133921.117000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ps3/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"um I will test"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"a6c007ce-ebe1-46d8-8489-d2a9ef97413f","type":"message","text":"It's important to look at different sizes, to gauge how different implementations scale as you increase the input size :)","user":"UH24GRBLL","ts":"1612133960.117200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"BVJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It's important to look at different sizes, to gauge how different implementations scale as you increase the input size :)"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"c9b73c12-a4f4-49de-a33d-37eb5a3d967b","type":"message","text":"yes indeed, good point","user":"U011V2YN59N","ts":"1612133985.117400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cOe","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yes indeed, good point"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"54cf0b90-80f5-41b1-889e-c8df733a7971","type":"message","text":"nah the non allocating one is still hella slow for 1000","user":"U011V2YN59N","ts":"1612133992.117600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2UY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"nah the non allocating one is still hella slow for 1000"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"00b256c0-55f0-4ae1-b509-3299a1dd0d2b","type":"message","text":"```\njulia&gt; @btime rand!(r,d,l)\n  9.481 μs (8 allocations: 16.91 KiB)\n\n\njulia&gt; @btime rand!(r,d,l)\n  197.299 μs (0 allocations: 0 bytes)```","user":"U011V2YN59N","ts":"1612134005.117800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"f+0s","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"\njulia> @btime rand!(r,d,l)\n  9.481 μs (8 allocations: 16.91 KiB)\n\n\njulia> @btime rand!(r,d,l)\n  197.299 μs (0 allocations: 0 bytes)"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"63bf5191-eca1-4bb3-b090-f63fbd520a6e","type":"message","text":"it's weird imo","user":"U011V2YN59N","ts":"1612134011.118000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+yQiD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's weird imo"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"84baeeb4-5da4-47cb-b5ba-82925ebcbd91","type":"message","text":"hm, gotta be the repeated calls to `rand` instead of the batch call","user":"UH24GRBLL","ts":"1612134013.118200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7/R","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hm, gotta be the repeated calls to "},{"type":"text","text":"rand","style":{"code":true}},{"type":"text","text":" instead of the batch call"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"de2a3d90-af73-40eb-b124-7a3a6d0998ea","type":"message","text":"batch calls to `rand` are almost always faster if you need a lot of rng data","user":"UH24GRBLL","ts":"1612134045.118400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"g=R","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"batch calls to "},{"type":"text","text":"rand","style":{"code":true}},{"type":"text","text":" are almost always faster if you need a lot of rng data"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"a4499f28-50c3-4dbf-95ff-e757fde2eff5","type":"message","text":"indeed","user":"U011V2YN59N","ts":"1612134084.118600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oUp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"indeed"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"6a6d5fd7-0157-4719-86c1-d68f7dd81ae2","type":"message","text":"can you try the loop version, but with the `rand(rng, s.base_dist, length(l)` outside of the loop in a tmp variable which you also index with `i`?","user":"UH24GRBLL","ts":"1612134100.118800","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1612134103.000000"},"blocks":[{"type":"rich_text","block_id":"uAW0t","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"can you try the loop version, but with the "},{"type":"text","text":"rand(rng, s.base_dist, length(l)","style":{"code":true}},{"type":"text","text":" outside of the loop in a tmp variable which you also index with "},{"type":"text","text":"i","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"3a0a4e72-9abe-45c7-88c6-c15ba74f5416","type":"message","text":"also, `@inbounds` on the loop","user":"UH24GRBLL","ts":"1612134110.119100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ZQtv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"also, "},{"type":"text","text":"@inbounds","style":{"code":true}},{"type":"text","text":" on the loop"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"fc9a44be-6a18-4e13-a43f-96b43cec853a","type":"message","text":"suree gimme a sec","user":"U011V2YN59N","ts":"1612134114.119300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"wTwL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"suree gimme a sec"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"a8bca3b7-50e2-4cff-9bba-6320174a9d19","type":"message","text":"and `@simd`?","user":"U011V2YN59N","ts":"1612134119.119500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"AqFN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and "},{"type":"text","text":"@simd","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"e45c5920-44f9-4720-a53e-d47a12ceaf35","type":"message","text":"let's try without","user":"UH24GRBLL","ts":"1612134130.119700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"N5pDi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"let's try without"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"4dcb7b53-b04f-45b8-862a-5151408ff728","type":"message","text":"still slow","user":"U011V2YN59N","ts":"1612134218.119900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ANm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"still slow"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"aec83ba6-e156-4df5-9a51-74832068293b","type":"message","text":"hm","user":"UH24GRBLL","ts":"1612134223.120100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Pt9t","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hm"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"b4bb6ec0-f996-44c0-8a79-9cb0fda3e8a3","type":"message","text":"```\n\nfunction Random.rand!(rng::AbstractRNG, s::ZWDist, l::T) where T&lt;:AbstractVector\n    rand!(rng, s.base_dist,l)\n    @inbounds for i in eachindex(l)\n        l[i] = (l[i] &gt;= s.α) *rand(rng, s.base_dist)\n    end\nend\n\njulia&gt; @btime rand!(r,d,l)\n  209.265 μs (0 allocations: 0 bytes)```","user":"U011V2YN59N","ts":"1612134228.120300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"EOCD","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"\n\nfunction Random.rand!(rng::AbstractRNG, s::ZWDist, l::T) where T<:AbstractVector\n    rand!(rng, s.base_dist,l)\n    @inbounds for i in eachindex(l)\n        l[i] = (l[i] >= s.α) *rand(rng, s.base_dist)\n    end\nend\n\njulia> @btime rand!(r,d,l)\n  209.265 μs (0 allocations: 0 bytes)"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"c2d057a4-35ce-445e-b2d1-78f8b136fb71","type":"message","text":"I suspect that the poisson distribution has a really fast batch sampler","user":"U011V2YN59N","ts":"1612134239.120500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"G6yM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I suspect that the poisson distribution has a really fast batch sampler"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"08e39666-0867-49ce-bd7f-f1874c314fde","type":"message","text":"oooh no that's not what I meant, sorry!","user":"UH24GRBLL","ts":"1612134249.120700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"c/ul","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oooh no that's not what I meant, sorry!"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"82dc6ca4-9e39-45b1-afb4-82ae1e8d6aa5","type":"message","text":"what did you mean?","user":"U011V2YN59N","ts":"1612134291.120900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"q1B","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"what did you mean?"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"bfe38598-ba62-4973-8fa6-563994a7bc46","type":"message","text":"```function Random.rand!(rng::AbstractRNG, s::ZWDist, l::T) where T&lt;:AbstractVector\n\nrand!(rng, l)\ntmp = rand(rng, s.base_dist, length(l))\n@inbounds for i in eachindex(l)\n l[i] = (l[i] &gt;= s.a) * tmp[i]\nend\nnothing\nend```","user":"UH24GRBLL","ts":"1612134297.121100","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1612134338.000000"},"blocks":[{"type":"rich_text","block_id":"lV1M","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function Random.rand!(rng::AbstractRNG, s::ZWDist, l::T) where T<:AbstractVector\n\nrand!(rng, l)\ntmp = rand(rng, s.base_dist, length(l))\n@inbounds for i in eachindex(l)\n l[i] = (l[i] >= s.a) * tmp[i]\nend\nnothing\nend"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"43c724ec-f18e-4cba-9fe8-4c4d09c93193","type":"message","text":"this should be equivalent to the fast broadcasting version we had earlier","user":"UH24GRBLL","ts":"1612134308.121300","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1612134317.000000"},"blocks":[{"type":"rich_text","block_id":"ahmk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"this should be equivalent to the fast broadcasting version we had earlier"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"ee83f77c-f530-49b2-97a0-e856a0c77af8","type":"message","text":"yep they are the same","user":"U011V2YN59N","ts":"1612134428.121700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GLu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yep they are the same"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"72132b40-06be-4c3e-aa6e-446d827df51c","type":"message","text":"ok nice","user":"UH24GRBLL","ts":"1612134467.121900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"KxPPN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ok nice"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"97428035-8311-43eb-86a1-be75ae95543a","type":"message","text":"you may be able to just throw `@threads` on there","user":"UH24GRBLL","ts":"1612134482.122100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+U7v","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you may be able to just throw "},{"type":"text","text":"@threads","style":{"code":true}},{"type":"text","text":" on there"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"4950aa28-97b5-42fd-9e8c-819060bfdb6e","type":"message","text":"wait sorry, the initial one I had is actually still faster, I mixed them up","user":"U011V2YN59N","ts":"1612134485.122300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Q2wMb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"wait sorry, the initial one I had is actually still faster, I mixed them up"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"60ca1dee-7a36-4771-9763-6da8facee9ae","type":"message","text":"which one? for which size?","user":"UH24GRBLL","ts":"1612134498.122500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"lbZHz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"which one? for which size?"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"4e4d16ee-bde8-4f06-b33e-ad582ff6f32d","type":"message","text":"```function Random.rand!(rng::AbstractRNG, s::ZWDist, l::T) where T&lt;:AbstractVector\n    Random.rand!(rng,l)\n    l[l .&lt; s.α] .= 0\n    Random.rand!(rng,s.base_dist,@view l[l .&gt;= s.α])\n    return nothing\nend```","user":"U011V2YN59N","ts":"1612134519.122700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"AJA","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function Random.rand!(rng::AbstractRNG, s::ZWDist, l::T) where T<:AbstractVector\n    Random.rand!(rng,l)\n    l[l .< s.α] .= 0\n    Random.rand!(rng,s.base_dist,@view l[l .>= s.α])\n    return nothing\nend"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"5a01da3a-33e0-4538-8c8b-cff0ce6396b4","type":"message","text":"for 1000","user":"U011V2YN59N","ts":"1612134523.122900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/fGjz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"for 1000"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"f50ec0e2-c5c0-4f9f-a210-08b42e48c3c8","type":"message","text":"this code is part of a threaded simulation already so it will be threaded at a higher level","user":"U011V2YN59N","ts":"1612134551.123100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oZ9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"this code is part of a threaded simulation already so it will be threaded at a higher level"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"bd12e302-d804-4ec4-8b57-a4a4f7e015c2","type":"message","text":"I see","user":"UH24GRBLL","ts":"1612134557.123300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pldjn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I see"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"35d8c8ea-c975-4674-97db-78ff3fd8b748","type":"message","text":"yeah, just not branching at all seems to be a big benefit","user":"UH24GRBLL","ts":"1612134622.123500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VvL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah, just not branching at all seems to be a big benefit"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"cee9f7bf-791b-4d31-b229-c5dc92755fb6","type":"message","text":"another approach:\n\n```rand!(rng, l)\nmask = l .&lt; s.a\nfill!(@view l[mask], zero(eltype(l)))\nmask .= .!mask\nrand!(rng, s.base_dist, @view l[mask])```","user":"UH24GRBLL","ts":"1612134721.123700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"CqT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"another approach:\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"rand!(rng, l)\nmask = l .< s.a\nfill!(@view l[mask], zero(eltype(l)))\nmask .= .!mask\nrand!(rng, s.base_dist, @view l[mask])"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"edcc9c2b-f144-4c12-95ab-adafca756189","type":"message","text":"reusing the memory of the mask at the cost of iterating over it","user":"UH24GRBLL","ts":"1612134734.123900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"q2t","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"reusing the memory of the mask at the cost of iterating over it"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"9672b6dc-030e-4af7-b4b2-ec73e0854c65","type":"message","text":"here they are in a pastable format if you want to try","user":"U011V2YN59N","ts":"1612134812.124100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TRJol","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"here they are in a pastable format if you want to try"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"72def596-6ac2-4119-8647-df5bca70ff52","type":"message","text":"```using Distributions\nusing Random\nstruct ZWDist{BaseDistType,T} &lt;: Sampleable{Univariate,Discrete}\n    α::T\n    base_dist::BaseDistType\nend\n\nfunction r2!(rng::AbstractRNG, s::ZWDist, l::T) where T&lt;:AbstractVector\n    rand!(rng, l)\n    l .= (l .&gt;= s.α) .* rand(rng, s.base_dist, length(l))\nend\nfunction r1!(rng::AbstractRNG, s::ZWDist, l::T) where T&lt;:AbstractVector\n    Random.rand!(rng,l)\n    l[l .&lt; s.α] .= 0\n    Random.rand!(rng,s.base_dist,@view l[l .&gt;= s.α])\n    return nothing\nend\nfunction r3!(rng::AbstractRNG, s::ZWDist, l::T) where T&lt;:AbstractVector\n    rand!(rng, l)\n    tmp = rand(rng, s.base_dist, length(l))\n    @inbounds for i in eachindex(l)\n     l[i] = (l[i] &gt;= s.α) * tmp[i]\n    end\n    nothing\nend\nusing BenchmarkTools\nl = zeros(1000)\nr = Xoroshiro128Plus(1)\ns = ZWDist(0.5,Poisson())\n@btime r1!(r,s,l)\n@btime r2!(r,s,l)\n\n@btime r3!(r,s,l)```","user":"U011V2YN59N","ts":"1612134825.124300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"L=FY","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using Distributions\nusing Random\nstruct ZWDist{BaseDistType,T} <: Sampleable{Univariate,Discrete}\n    α::T\n    base_dist::BaseDistType\nend\n\nfunction r2!(rng::AbstractRNG, s::ZWDist, l::T) where T<:AbstractVector\n    rand!(rng, l)\n    l .= (l .>= s.α) .* rand(rng, s.base_dist, length(l))\nend\nfunction r1!(rng::AbstractRNG, s::ZWDist, l::T) where T<:AbstractVector\n    Random.rand!(rng,l)\n    l[l .< s.α] .= 0\n    Random.rand!(rng,s.base_dist,@view l[l .>= s.α])\n    return nothing\nend\nfunction r3!(rng::AbstractRNG, s::ZWDist, l::T) where T<:AbstractVector\n    rand!(rng, l)\n    tmp = rand(rng, s.base_dist, length(l))\n    @inbounds for i in eachindex(l)\n     l[i] = (l[i] >= s.α) * tmp[i]\n    end\n    nothing\nend\nusing BenchmarkTools\nl = zeros(1000)\nr = Xoroshiro128Plus(1)\ns = ZWDist(0.5,Poisson())\n@btime r1!(r,s,l)\n@btime r2!(r,s,l)\n\n@btime r3!(r,s,l)"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"a57575ba-7e68-4034-8b86-1de6830ff20d","type":"message","text":"that one doesn't compile","user":"U011V2YN59N","ts":"1612134900.124500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TbXz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that one doesn't compile"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"2472833c-054a-49dc-b01f-e9bb58a1af63","type":"message","text":"```julia&gt; function r4!(rng::AbstractRNG, s::ZWDist, l::T) where T&lt;:AbstractVector\n           rand!(rng, l)\n           mask = l .&lt; s.a\n           fill!(@view l[mask], zero(eltype(l)))\n           mask .= .!mask\n           rand!(rng, s.base_dist, @view l[mask])\n       end\nERROR: LoadError: ArgumentError: Invalid use of @view macro: argument must be a reference expression A[...].\nStacktrace:\n [1] @view(::LineNumberNode, ::Module, ::Any) at ./views.jl:123\nin expression starting at REPL[38]:4```","user":"U011V2YN59N","ts":"1612134901.124700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"OyO","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> function r4!(rng::AbstractRNG, s::ZWDist, l::T) where T<:AbstractVector\n           rand!(rng, l)\n           mask = l .< s.a\n           fill!(@view l[mask], zero(eltype(l)))\n           mask .= .!mask\n           rand!(rng, s.base_dist, @view l[mask])\n       end\nERROR: LoadError: ArgumentError: Invalid use of @view macro: argument must be a reference expression A[...].\nStacktrace:\n [1] @view(::LineNumberNode, ::Module, ::Any) at ./views.jl:123\nin expression starting at REPL[38]:4"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"e85d3ad0-d974-44c0-9036-554af021c95e","type":"message","text":"ok I fixed it","user":"U011V2YN59N","ts":"1612134974.124900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qiw2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ok I fixed it"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"0b184a35-a8b0-4521-bf2d-ce935cb5989a","type":"message","text":"```julia&gt; @views function r4!(rng::AbstractRNG, s::ZWDist, l::T) where T&lt;:AbstractVector\n           rand!(rng, l)\n           mask = l .&lt; s.α\n           fill!( l[mask], zero(eltype(l)))\n           mask .= .!mask\n           rand!(rng, s.base_dist, l[mask])\n       end\nr4! (generic function with 1 method)\n\njulia&gt; @btime r4!(r,s,l)\n 8.930 μs (6 allocations: 12.53 KiB)```\n","user":"U011V2YN59N","ts":"1612134987.125100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MY5","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @views function r4!(rng::AbstractRNG, s::ZWDist, l::T) where T<:AbstractVector\n           rand!(rng, l)\n           mask = l .< s.α\n           fill!( l[mask], zero(eltype(l)))\n           mask .= .!mask\n           rand!(rng, s.base_dist, l[mask])\n       end\nr4! (generic function with 1 method)\n\njulia> @btime r4!(r,s,l)\n 8.930 μs (6 allocations: 12.53 KiB)"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"8cd21d01-5f01-4082-92a6-27e8efdb2b97","type":"message","text":"we appear to have a winner!!","user":"U011V2YN59N","ts":"1612134993.125300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XSj","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"we appear to have a winner!!"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"9fddf308-6595-4a80-9e73-791d7c87d26f","type":"message","text":"for a 1k vec, but that is a good upper bound for my vec sizes","user":"U011V2YN59N","ts":"1612135044.125500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"z1oJu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"for a 1k vec, but that is a good upper bound for my vec sizes"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"5e56576e-b009-46e4-96d3-0cc99fe75241","type":"message","text":"```julia&gt; @btime r1!(r,s,l);\n  9.530 μs (8 allocations: 16.91 KiB)\n\njulia&gt; @btime r2!(r,s,l);\n  14.090 μs (1 allocation: 7.94 KiB)\n\njulia&gt; @btime r3!(r,s,l);\n  14.310 μs (1 allocation: 7.94 KiB)\n\njulia&gt; @btime r4!(r,s,l);\n  8.920 μs (6 allocations: 12.53 KiB)```","user":"U011V2YN59N","ts":"1612135098.125700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"tGh","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @btime r1!(r,s,l);\n  9.530 μs (8 allocations: 16.91 KiB)\n\njulia> @btime r2!(r,s,l);\n  14.090 μs (1 allocation: 7.94 KiB)\n\njulia> @btime r3!(r,s,l);\n  14.310 μs (1 allocation: 7.94 KiB)\n\njulia> @btime r4!(r,s,l);\n  8.920 μs (6 allocations: 12.53 KiB)"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"93f1aefa-4c16-46a6-bcb2-2245f6583541","type":"message","text":"probably also depends on the choice of the `a` parameter","user":"U011V2YN59N","ts":"1612135113.125900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0q/Rl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"probably also depends on the choice of the "},{"type":"text","text":"a","style":{"code":true}},{"type":"text","text":" parameter"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"1f3f61b7-0d2d-4bf1-a14d-385b8470346c","type":"message","text":"indeed\n```julia&gt; s = ZWDist(0.1,Poisson())\nZWDist{Poisson{Float64},Float64}(0.1, Poisson{Float64}(λ=1.0))\n\njulia&gt; @btime r1!(r,s,l);\n\n  14.910 μs (8 allocations: 16.88 KiB)\n\njulia&gt; @btime r2!(r,s,l);\n  13.919 μs (1 allocation: 7.94 KiB)\n\njulia&gt; @btime r3!(r,s,l);\n  14.240 μs (1 allocation: 7.94 KiB)\n\njulia&gt; @btime r4!(r,s,l);\n  14.470 μs (6 allocations: 12.50 KiB)```","user":"U011V2YN59N","ts":"1612135163.126100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"g6Qow","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"indeed\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> s = ZWDist(0.1,Poisson())\nZWDist{Poisson{Float64},Float64}(0.1, Poisson{Float64}(λ=1.0))\n\njulia> @btime r1!(r,s,l);\n\n  14.910 μs (8 allocations: 16.88 KiB)\n\njulia> @btime r2!(r,s,l);\n  13.919 μs (1 allocation: 7.94 KiB)\n\njulia> @btime r3!(r,s,l);\n  14.240 μs (1 allocation: 7.94 KiB)\n\njulia> @btime r4!(r,s,l);\n  14.470 μs (6 allocations: 12.50 KiB)"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"5b077a16-bb5b-4fa5-b596-39379f3b7023","type":"message","text":"the `a` parameter will probably mostly interact with the branch predictor","user":"UH24GRBLL","ts":"1612135212.126300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9oNCJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the "},{"type":"text","text":"a","style":{"code":true}},{"type":"text","text":" parameter will probably mostly interact with the branch predictor"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"af8d053e-1db6-4216-9963-f7d675507c9d","type":"message","text":"`a` is usually `&gt;0.5` so your solution is the fastest, and the one I will use","user":"U011V2YN59N","ts":"1612135363.126500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"dI7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"a","style":{"code":true}},{"type":"text","text":" is usually "},{"type":"text","text":">0.5","style":{"code":true}},{"type":"text","text":" so your solution is the fastest, and the one I will use"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"83896b75-2189-4b9c-accd-c33b5f4c3a7e","type":"message","text":"thanks, this was fun ^_^","user":"U011V2YN59N","ts":"1612135376.126700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Q+xIU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"thanks, this was fun ^_^"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"01706539-acea-47f2-bf7c-bf8d5ae102b0","type":"message","text":"you're welcome!","user":"UH24GRBLL","ts":"1612135399.126900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6maYK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you're welcome!"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"c7f775ee-9fb5-46bb-8a18-e48956058b70","type":"message","text":"the `Xoroshiro128Plus` is not exported from anything you gave me :thinking_face:","user":"UH24GRBLL","ts":"1612135599.127100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"M+5P0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the "},{"type":"text","text":"Xoroshiro128Plus","style":{"code":true}},{"type":"text","text":" is not exported from anything you gave me "},{"type":"emoji","name":"thinking_face"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"8c173089-068a-47bf-ab60-6a56e4877592","type":"message","text":"```function test()\n    r = Xoroshiro128Plus(1)\n    s = ZWDist(0.5,Poisson())\n    res = Matrix{Float64}(undef, 4, 5)\n    for (i,size) in enumerate([10, 100, 1000, 10_000, 100_000])\n        l = zeros(size)\n        res[1,i] = mean(@benchmark r1!(r,s,l)) |&gt; time\n        res[2,i] = mean(@benchmark r2!(r,s,l)) |&gt; time\n        res[3,i] = mean(@benchmark r3!(r,s,l)) |&gt; time\n        res[4,i] = mean(@benchmark r4!(r,s,l)) |&gt; time\n    end\n\n    res\nend```","user":"UH24GRBLL","ts":"1612135609.127300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"T4zu","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function test()\n    r = Xoroshiro128Plus(1)\n    s = ZWDist(0.5,Poisson())\n    res = Matrix{Float64}(undef, 4, 5)\n    for (i,size) in enumerate([10, 100, 1000, 10_000, 100_000])\n        l = zeros(size)\n        res[1,i] = mean(@benchmark r1!(r,s,l)) |> time\n        res[2,i] = mean(@benchmark r2!(r,s,l)) |> time\n        res[3,i] = mean(@benchmark r3!(r,s,l)) |> time\n        res[4,i] = mean(@benchmark r4!(r,s,l)) |> time\n    end\n\n    res\nend"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"0bffe082-87c6-4098-8748-c69a3f1e1751","type":"message","text":"oh! sorry should add that","user":"U011V2YN59N","ts":"1612135622.127500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"js57","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh! sorry should add that"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"e39ba899-1f1a-415a-88c8-fdbb7821ab7c","type":"message","text":"but here's a `test` function for sizes 10 through 100.000","user":"UH24GRBLL","ts":"1612135624.127700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XiE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but here's a "},{"type":"text","text":"test","style":{"code":true}},{"type":"text","text":" function for sizes 10 through 100.000"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"620df7dc-fe1e-476a-809c-f65cbd81a710","type":"message","text":"you'll get the result times as a matrix","user":"UH24GRBLL","ts":"1612135638.127900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fWhDg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you'll get the result times as a matrix"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"6330d8ba-4152-4617-a9f5-b8c40fba6b9b","type":"message","text":"`using RandomNumbers.Xorshifts`","user":"U011V2YN59N","ts":"1612135642.128100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"bqUr","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"using RandomNumbers.Xorshifts","style":{"code":true}}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"ad5e7c7f-5c27-457c-a865-258ddbeb1dd8","type":"message","text":"makes it easier to see/plot the scaling","user":"UH24GRBLL","ts":"1612135659.128300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kA2S2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"makes it easier to see/plot the scaling"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"d452af14-2aca-47a0-a100-18f04c861136","type":"message","text":"for sure, thanks!","user":"U011V2YN59N","ts":"1612135682.128500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oJxK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"for sure, thanks!"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"6b475694-859c-4ca3-b62a-5e699e9dc747","type":"message","text":"ok, on my machine `r2` seems to be the fastest, with `r4` a close contender","user":"UH24GRBLL","ts":"1612136500.128700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2X/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ok, on my machine "},{"type":"text","text":"r2","style":{"code":true}},{"type":"text","text":" seems to be the fastest, with "},{"type":"text","text":"r4","style":{"code":true}},{"type":"text","text":" a close contender"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"3611f113-fdf1-4a98-b2ce-1b14c5449c2a","type":"message","text":"which makes sense, since `r2` only has to iterate once","user":"UH24GRBLL","ts":"1612136524.128900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MPG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"which makes sense, since "},{"type":"text","text":"r2","style":{"code":true}},{"type":"text","text":" only has to iterate once"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"45cb57ad-5f4d-4d8f-839c-738ac9f09cc7","type":"message","text":"oh well, glad I could help!","user":"UH24GRBLL","ts":"1612136581.129100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5t9fs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh well, glad I could help!"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"d296e6c0-b627-4cea-b468-11bc98e1d3cd","type":"message","text":"hm, what is your `versioninfo()`  ?","user":"U011V2YN59N","ts":"1612137095.129300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ZFA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hm, what is your "},{"type":"text","text":"versioninfo()","style":{"code":true}},{"type":"text","text":"  ?"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"4471f1a9-d0b1-483c-95e7-43da66563fc7","type":"message","text":"the output of my `test()` agrees with your results","user":"U011V2YN59N","ts":"1612137179.129500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"18vA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the output of my "},{"type":"text","text":"test()","style":{"code":true}},{"type":"text","text":" agrees with your results"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"c342529f-e1d4-43dc-bd8f-f8c5315d2dc2","type":"message","text":"```julia&gt; test()\n4×5 Matrix{Float64}:\n 17076.2  17117.8  16304.5  16283.2  16338.6\n 16073.3  14930.7  15169.4  14925.2  15954.9\n 15976.3  15184.0  15424.4  15969.2  15341.1\n 16314.7  15594.7  15524.9  16406.6  15594.4```","user":"U011V2YN59N","ts":"1612137183.129700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"an4GE","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> test()\n4×5 Matrix{Float64}:\n 17076.2  17117.8  16304.5  16283.2  16338.6\n 16073.3  14930.7  15169.4  14925.2  15954.9\n 15976.3  15184.0  15424.4  15969.2  15341.1\n 16314.7  15594.7  15524.9  16406.6  15594.4"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"58809bce-b598-4d8c-b17a-d8b524ace86e","type":"message","text":"but not\n```julia&gt; @btime r1!(r,s,l);\n\n  9.060 μs (8 allocations: 16.91 KiB)\n\njulia&gt; @btime r2!(r,s,l);\n  13.550 μs (1 allocation: 7.94 KiB)\n\njulia&gt; @btime r3!(r,s,l);\n  14.400 μs (1 allocation: 7.94 KiB)\n\njulia&gt; @btime r4!(r,s,l);\n  8.860 μs (5 allocations: 12.48 KiB)```","user":"U011V2YN59N","ts":"1612137195.129900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"lmS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but not\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @btime r1!(r,s,l);\n\n  9.060 μs (8 allocations: 16.91 KiB)\n\njulia> @btime r2!(r,s,l);\n  13.550 μs (1 allocation: 7.94 KiB)\n\njulia> @btime r3!(r,s,l);\n  14.400 μs (1 allocation: 7.94 KiB)\n\njulia> @btime r4!(r,s,l);\n  8.860 μs (5 allocations: 12.48 KiB)"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"f6259bed-9707-47b1-8aab-61ba3a53440f","type":"message","text":"so I must be doing something weird, or I am reading the results wrong","user":"U011V2YN59N","ts":"1612137208.130100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"icE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so I must be doing something weird, or I am reading the results wrong"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"d9904a09-e058-42d1-abfb-b01dbf2913bd","type":"message","text":"ah you gotta reset the seed for each iteration so you are testing the same thing apparently","user":"U011V2YN59N","ts":"1612138505.130300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FzF0/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ah you gotta reset the seed for each iteration so you are testing the same thing apparently"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"178800b0-6667-42e2-9068-91105c5dc8f6","type":"message","text":"```julia&gt; function test()\n\n           s = ZWDist(0.5,Poisson())\n           res = Matrix{Float64}(undef, 4, 5)\n           for (i,size) in enumerate([10, 100, 1000, 10_000, 100_000])\n               l = zeros(size)\n               r = Xoroshiro128Plus(1)\n               res[1,i] = mean(@benchmark r1!(r,s,l)) |&gt; time\n               r = Xoroshiro128Plus(1)\n               res[2,i] = mean(@benchmark r2!(r,s,l)) |&gt; time\n               r = Xoroshiro128Plus(1)\n               res[3,i] = mean(@benchmark r3!(r,s,l)) |&gt; time\n               r = Xoroshiro128Plus(1)\n               res[4,i] = mean(@benchmark r4!(r,s,l)) |&gt; time\n           end\n           res\n       end\ntest (generic function with 1 method)\n\njulia&gt; test()\n4×5 Matrix{Float64}:\n 11683.7  11120.6  11162.9  11210.4  11128.6\n 16195.6  15269.1  15199.9  15102.6  15071.9\n 16400.1  15455.4  15729.6  15290.2  15305.7\n 10814.5  10274.6  10249.7  10270.5  10179.3```","user":"U011V2YN59N","ts":"1612138511.130500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"h6ZY","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> function test()\n\n           s = ZWDist(0.5,Poisson())\n           res = Matrix{Float64}(undef, 4, 5)\n           for (i,size) in enumerate([10, 100, 1000, 10_000, 100_000])\n               l = zeros(size)\n               r = Xoroshiro128Plus(1)\n               res[1,i] = mean(@benchmark r1!(r,s,l)) |> time\n               r = Xoroshiro128Plus(1)\n               res[2,i] = mean(@benchmark r2!(r,s,l)) |> time\n               r = Xoroshiro128Plus(1)\n               res[3,i] = mean(@benchmark r3!(r,s,l)) |> time\n               r = Xoroshiro128Plus(1)\n               res[4,i] = mean(@benchmark r4!(r,s,l)) |> time\n           end\n           res\n       end\ntest (generic function with 1 method)\n\njulia> test()\n4×5 Matrix{Float64}:\n 11683.7  11120.6  11162.9  11210.4  11128.6\n 16195.6  15269.1  15199.9  15102.6  15071.9\n 16400.1  15455.4  15729.6  15290.2  15305.7\n 10814.5  10274.6  10249.7  10270.5  10179.3"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"1b678b5a-47fc-4ffb-8a9c-7635e79c35e4","type":"message","text":"I am shocked that it affects the results so much","user":"U011V2YN59N","ts":"1612138517.130700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"lr0kL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I am shocked that it affects the results so much"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"031a2eab-a1db-422f-88aa-07f3269809b5","type":"message","text":"oh that is true!","user":"UH24GRBLL","ts":"1612163620.131400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"H6Mm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh that is true!"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"67fdcad1-7947-4bc3-9eef-55bb3acbb16d","type":"message","text":"I'm on the 1.6 beta","user":"UH24GRBLL","ts":"1612164646.131600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Jt=g","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm on the 1.6 beta"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N"},{"client_msg_id":"337ab80e-1d7c-4a2c-bc2e-b2fb89bd8a50","type":"message","text":"I'm not surprised that the RNG affects things - this benchmark basically tests how well your PC can predict the branches, so different RNG will have a big influence","user":"UH24GRBLL","ts":"1612164953.131800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"k01U","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm not surprised that the RNG affects things - this benchmark basically tests how well your PC can predict the branches, so different RNG will have a big influence"}]}]}],"thread_ts":"1612132171.105000","parent_user_id":"U011V2YN59N","reactions":[{"name":"+1","users":["U011V2YN59N"],"count":1}]}]