[{"client_msg_id":"ccceea81-4779-4a24-a30a-c2431eb65cd5","type":"message","text":"Saw <https://discourse.julialang.org/t/optimizing-linear-algebra-code/58797/2|this> discourse post about optimizing a linear algebra computation. They are correct in that preallocating doesn't improve the speed much at all (by 0.2% or something). Why is that?","user":"U011V2YN59N","ts":"1617854377.146800","team":"T68168MUP","edited":{"user":"U011V2YN59N","ts":"1617854663.000000"},"blocks":[{"type":"rich_text","block_id":"ZW2K","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Saw "},{"type":"link","url":"https://discourse.julialang.org/t/optimizing-linear-algebra-code/58797/2","text":"this"},{"type":"text","text":" discourse post about optimizing a linear algebra computation. They are correct in that preallocating doesn't improve the speed much at all (by 0.2% or something). Why is that?"}]}]}],"thread_ts":"1617854377.146800","reply_count":6,"reply_users_count":2,"latest_reply":"1617975617.152400","reply_users":["UD0NS8PDF","U011V2YN59N"],"is_locked":false,"subscribed":false},{"client_msg_id":"26BF7F3C-AB5A-4BED-9F8F-51A028902F03","type":"message","text":"Didn’t look closely, but there are big matrices... and allocation ought to grow as a lower power than operations. Could time `similar(output)` to compare. Or maybe zero(output) is more fair.","user":"UD0NS8PDF","ts":"1617854894.149800","team":"T68168MUP","edited":{"user":"UD0NS8PDF","ts":"1617855571.000000"},"blocks":[{"type":"rich_text","block_id":"tAa","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Didn’t look closely, but there are big matrices... and allocation ought to grow as a lower power than operations. Could time "},{"type":"text","text":"similar(output)","style":{"code":true}},{"type":"text","text":" to compare. Or maybe zero(output) is more fair."}]}]}],"thread_ts":"1617854377.146800","parent_user_id":"U011V2YN59N"},{"client_msg_id":"0c3ebdb5-c4e9-4ff5-912b-f056430a01bc","type":"message","text":"```julia&gt; include(\"scratch.jl\")\n  52.390 ms (5 allocations: 1.02 MiB) #initial implementation\n  52.160 ms (2 allocations: 96 bytes) #preallocated\n  91.945 ns (2 allocations: 1.00 MiB) #similar(out)```\nyeah that is what I was thinking, but your explanation is clearer, I will mention that to them. Thanks!","user":"U011V2YN59N","ts":"1617855367.150000","team":"T68168MUP","edited":{"user":"U011V2YN59N","ts":"1617855375.000000"},"blocks":[{"type":"rich_text","block_id":"Poo","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> include(\"scratch.jl\")\n  52.390 ms (5 allocations: 1.02 MiB) #initial implementation\n  52.160 ms (2 allocations: 96 bytes) #preallocated\n  91.945 ns (2 allocations: 1.00 MiB) #similar(out)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"yeah that is what I was thinking, but your explanation is clearer, I will mention that to them. Thanks!"}]}]}],"thread_ts":"1617854377.146800","parent_user_id":"U011V2YN59N"},{"client_msg_id":"84303d01-c946-421e-983a-a702136229e7","type":"message","text":"Maybe you feel like checking my numbers, but I think this works out to 10 Gflops, while the claimed Matlab time gives 2.5 Tflops. The first sounds low, the second way high?\n\nMy version:\n```mat = randn(ComplexF64, 1000, 256^2);\nzed = randn(ComplexF64, 256, 256);\nv = randn(ComplexF64, 1000);\n\nAfwd(zed, mat) = mat * vec(zed)  # returns a 1000 vector\n# 8 * 1000 * 256 * 256 float ops\n\n# Aadj(v, mat) = reshape(mat' * v, 256, 256) # matrix\nAadj1(v, mat) = mat' * v  # skip the reshape\n# 8 * 1000 * 256^2 float ops\n\nboth(zed, mat) = Aadj1(Afwd(zed, mat), mat)\n\n@btime both($zed, $mat);  # 56.935 ms\n# me: 2 * 8 * 1000 * 256 * 256 / 56.935e-3 = 18.4e9 flops\n# peakflops() is 1.008e11 for me, 20x higher, gemm not gemv```","user":"UD0NS8PDF","ts":"1617943411.151400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fv+bc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Maybe you feel like checking my numbers, but I think this works out to 10 Gflops, while the claimed Matlab time gives 2.5 Tflops. The first sounds low, the second way high?\n\nMy version:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"mat = randn(ComplexF64, 1000, 256^2);\nzed = randn(ComplexF64, 256, 256);\nv = randn(ComplexF64, 1000);\n\nAfwd(zed, mat) = mat * vec(zed)  # returns a 1000 vector\n# 8 * 1000 * 256 * 256 float ops\n\n# Aadj(v, mat) = reshape(mat' * v, 256, 256) # matrix\nAadj1(v, mat) = mat' * v  # skip the reshape\n# 8 * 1000 * 256^2 float ops\n\nboth(zed, mat) = Aadj1(Afwd(zed, mat), mat)\n\n@btime both($zed, $mat);  # 56.935 ms\n# me: 2 * 8 * 1000 * 256 * 256 / 56.935e-3 = 18.4e9 flops\n# peakflops() is 1.008e11 for me, 20x higher, gemm not gemv"}]}]}],"thread_ts":"1617854377.146800","parent_user_id":"U011V2YN59N"},{"client_msg_id":"37b448a0-040a-49ad-9fb3-f6c2da4c0baa","type":"message","text":"Looks right to me. I though complex multiplication was 6 flops apiece actually, but that makes your estimate lower.\n\nI suspect something is wrong with their matlab timings in some way.  I don't think they posted matlab code.","user":"U011V2YN59N","ts":"1617975067.152000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Qb5b","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Looks right to me. I though complex multiplication was 6 flops apiece actually, but that makes your estimate lower.\n\nI suspect something is wrong with their matlab timings in some way.  I don't think they posted matlab code."}]}]}],"thread_ts":"1617854377.146800","parent_user_id":"U011V2YN59N"},{"client_msg_id":"a13fb4be-ab7e-496e-8b88-565883f992be","type":"message","text":"Also TIL about `peakflops`","user":"U011V2YN59N","ts":"1617975159.152200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3dj","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Also TIL about "},{"type":"text","text":"peakflops","style":{"code":true}}]}]}],"thread_ts":"1617854377.146800","parent_user_id":"U011V2YN59N"},{"client_msg_id":"de598949-b85b-4357-8884-ea879e3ccd91","type":"message","text":"Yes I wrote 6 too, after counting on my fingers, and then did some googling and some people said 8… not sure","user":"UD0NS8PDF","ts":"1617975617.152400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"u=uER","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes I wrote 6 too, after counting on my fingers, and then did some googling and some people said 8… not sure"}]}]}],"thread_ts":"1617854377.146800","parent_user_id":"U011V2YN59N"}]