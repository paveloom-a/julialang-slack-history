[{"client_msg_id":"e6b257d3-cf7e-4737-b274-9511bd567a2b","type":"message","text":"I need to numerically integrate a slightly complicated function many times, so I'm trying to find a fast way to do it. I don't necessarily need super high precision (ideally beyond 1e-5 but I could make do with less)\n\nI'm currently trying the following with `FastGaussQuadrature` . Might anyone have a suggestion for how to improve performance?\n```function fastgq(f, a, b)\n    nodes, weights = gausslegendre( 10000 );\n    \n    x = 0.5*((b .- a).*nodes .+ (b.+a))\n    \n    out = 0.5*(b.-a)*dot( weights, f.(x) )\n    \n    return(out)\nend```","user":"U91Q3595Y","ts":"1613615785.248800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+0fn9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I need to numerically integrate a slightly complicated function many times, so I'm trying to find a fast way to do it. I don't necessarily need super high precision (ideally beyond 1e-5 but I could make do with less)\n\nI'm currently trying the following with "},{"type":"text","text":"FastGaussQuadrature","style":{"code":true}},{"type":"text","text":" . Might anyone have a suggestion for how to improve performance?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function fastgq(f, a, b)\n    nodes, weights = gausslegendre( 10000 );\n    \n    x = 0.5*((b .- a).*nodes .+ (b.+a))\n    \n    out = 0.5*(b.-a)*dot( weights, f.(x) )\n    \n    return(out)\nend"}]}]}],"thread_ts":"1613615785.248800","reply_count":25,"reply_users_count":5,"latest_reply":"1613669821.255300","reply_users":["U0179G7FG4F","U91Q3595Y","U6C82JCSK","U67D54KS8","UAUPJLBQX"],"subscribed":false},{"client_msg_id":"d50031eb-9538-48ce-9629-987b2d8c912e","type":"message","text":"I think you might want `fastgq(f::F, a, b) where F&lt;:Function` since function types aren't automatically specialized on.","user":"U0179G7FG4F","ts":"1613616291.248900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/XeN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think you might want "},{"type":"text","text":"fastgq(f::F, a, b) where F<:Function","style":{"code":true}},{"type":"text","text":" since function types aren't automatically specialized on."}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"662c3275-f821-4461-98d5-d4be3e360500","type":"message","text":"Do I need to declare `F&lt;:Function` somewhere?","user":"U91Q3595Y","ts":"1613616341.249100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"NbWG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Do I need to declare "},{"type":"text","text":"F<:Function","style":{"code":true}},{"type":"text","text":" somewhere?"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"8922e223-a050-47dc-bae5-a7f17ee7f986","type":"message","text":"(sorry for the naive question)","user":"U91Q3595Y","ts":"1613616357.249300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"i/qt","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"(sorry for the naive question)"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"265a3684-a359-44d6-9d27-e305aeee3ee0","type":"message","text":"would this work?\n```function fastgq(f::Function, a, b)\n    nodes, weights = gausslegendre( 10000 );\n    \n    x = 0.5*((b .- a).*nodes .+ (b.+a))\n    \n    out = 0.5*(b.-a)*dot( weights, f.(x) )\n    \n    return(out)\nend```","user":"U91Q3595Y","ts":"1613616455.249500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1Gwal","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"would this work?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function fastgq(f::Function, a, b)\n    nodes, weights = gausslegendre( 10000 );\n    \n    x = 0.5*((b .- a).*nodes .+ (b.+a))\n    \n    out = 0.5*(b.-a)*dot( weights, f.(x) )\n    \n    return(out)\nend"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"ae55b208-7f6b-438a-9751-6cc063d2c1e0","type":"message","text":"no, <https://docs.julialang.org/en/v1/manual/performance-tips/#Be-aware-of-when-Julia-avoids-specializing>","user":"U0179G7FG4F","ts":"1613616526.249700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9B=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"no, "},{"type":"link","url":"https://docs.julialang.org/en/v1/manual/performance-tips/#Be-aware-of-when-Julia-avoids-specializing"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"a67022a1-d764-487e-ae22-3d1c48270f24","type":"message","text":"Also, I think changing where you apply `f` will save you an allocation.\n\n```function fastgq(f::F, a, b) where {F}\n    nodes, weights = gausslegendre( 10000 );\n    fx = @. f(0.5*((b - a)*nodes + (b+a)))\n    out = 0.5.*(b.-a)*dot( weights, fx )\n    return(out)\nend```\n","user":"U0179G7FG4F","ts":"1613616696.249900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"CQli","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Also, I think changing where you apply "},{"type":"text","text":"f","style":{"code":true}},{"type":"text","text":" will save you an allocation.\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function fastgq(f::F, a, b) where {F}\n    nodes, weights = gausslegendre( 10000 );\n    fx = @. f(0.5*((b - a)*nodes + (b+a)))\n    out = 0.5.*(b.-a)*dot( weights, fx )\n    return(out)\nend"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y","reactions":[{"name":"pray","users":["U91Q3595Y"],"count":1}]},{"client_msg_id":"61079a38-9bab-4b58-98dc-eb461e7053a8","type":"message","text":"Thanks!","user":"U91Q3595Y","ts":"1613616845.250100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"bmWz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks!"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"e2dbf70e-45c2-4c57-8977-9362b73677e5","type":"message","text":"So you'd suggest something like the following?\n```h_func(h::H, num) where {H} = ntuple(h, div(num, 2))```\n","user":"U91Q3595Y","ts":"1613616854.250300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DUeXl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So you'd suggest something like the following?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"h_func(h::H, num) where {H} = ntuple(h, div(num, 2))"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"2348aa87-d993-4ddc-9a6d-90962a9965b9","type":"message","text":"if it's performance critical, yes. Specialization can be fairly important","user":"U0179G7FG4F","ts":"1613616936.250500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"KDmid","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if it's performance critical, yes. Specialization can be fairly important"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"25265a87-0922-4751-a80d-0ac4860a3ba2","type":"message","text":"You might want to also consider pre-allocating the nodes and weights arrays especially if you will be reusing them (unless you are already doing that, of course)","user":"U6C82JCSK","ts":"1613623865.250700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"h+U","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"You might want to also consider pre-allocating the nodes and weights arrays especially if you will be reusing them (unless you are already doing that, of course)"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y","reactions":[{"name":"pray","users":["U0179G7FG4F","UKG4WF8PJ","U91Q3595Y"],"count":3},{"name":"heavy_check_mark","users":["UAUPJLBQX"],"count":1}]},{"client_msg_id":"ee16f55d-f35c-4b01-b432-3d5a6039ed2f","type":"message","text":"&gt; I think you might want fastgq(f::F, a, b) where F&lt;:Function since function types aren't automatically specialized on.\nThat's only true if the function isn't called in the body, but this one is.","user":"U67D54KS8","ts":"1613631435.251300","team":"T68168MUP","edited":{"user":"U67D54KS8","ts":"1613631489.000000"},"blocks":[{"type":"rich_text","block_id":"9V2","elements":[{"type":"rich_text_quote","elements":[{"type":"text","text":"I think you might want fastgq(f::F, a, b) where F<:Function since function types aren't automatically specialized on."}]},{"type":"rich_text_section","elements":[{"type":"text","text":"That's only true if the function isn't called in the body, but this one is."}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"5818446a-085c-47c0-9537-9c923be6b1f1","type":"message","text":"It might be better to use some adaptive quadrature, e.g. <https://github.com/JuliaMath/QuadGK.jl>","user":"U67D54KS8","ts":"1613631475.251500","team":"T68168MUP","edited":{"user":"U67D54KS8","ts":"1613631539.000000"},"blocks":[{"type":"rich_text","block_id":"FQeC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It might be better to use some adaptive quadrature, e.g. "},{"type":"link","url":"https://github.com/JuliaMath/QuadGK.jl"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"08b735a4-2354-42ae-9235-127604c24e59","type":"message","text":"Is `f` being called in the body? Does broadcasting count?\n```julia&gt; Meta.@lower f.(x)\n:($(Expr(:thunk, CodeInfo(\n    @ none within `top-level scope'\n1 ─ %1 = Base.broadcasted(f, x)\n│   %2 = Base.materialize(%1)\n└──      return %2\n))))```","user":"UAUPJLBQX","ts":"1613631997.251900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"SaB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is "},{"type":"text","text":"f","style":{"code":true}},{"type":"text","text":" being called in the body? Does broadcasting count?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> Meta.@lower f.(x)\n:($(Expr(:thunk, CodeInfo(\n    @ none within `top-level scope'\n1 ─ %1 = Base.broadcasted(f, x)\n│   %2 = Base.materialize(%1)\n└──      return %2\n))))"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"eb5032bb-de02-44f3-8d01-066f803dd404","type":"message","text":"Maybe not, but the function is \"slightly complicated\" so it is unlikely that specialization will matter much anyway, and if it is called with broadcasting, the one time call to `Base.broadcasted` will be insignificant.","user":"U67D54KS8","ts":"1613638636.252400","team":"T68168MUP","edited":{"user":"U67D54KS8","ts":"1613638666.000000"},"blocks":[{"type":"rich_text","block_id":"b96X","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Maybe not, but the function is \"slightly complicated\" so it is unlikely that specialization will matter much anyway, and if it is called with broadcasting, the one time call to "},{"type":"text","text":"Base.broadcasted","style":{"code":true}},{"type":"text","text":" will be insignificant."}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"6b19c0b7-eac6-45c2-8187-980f0bfd34ab","type":"message","text":"Yes, it'd be insignificant compared to applying `f` on a vector of length `10_000`. Preallocating the nodes, and then also temporaries (or cutting them down, e.g. by replacing `dot` with a loop) would yield a bigger benefit.","user":"UAUPJLBQX","ts":"1613665629.252800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"SUHdI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes, it'd be insignificant compared to applying "},{"type":"text","text":"f","style":{"code":true}},{"type":"text","text":" on a vector of length "},{"type":"text","text":"10_000","style":{"code":true}},{"type":"text","text":". Preallocating the nodes, and then also temporaries (or cutting them down, e.g. by replacing "},{"type":"text","text":"dot","style":{"code":true}},{"type":"text","text":" with a loop) would yield a bigger benefit."}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"b6959adf-7e3e-46e8-9cbf-df613e78fe21","type":"message","text":"I still think looking at the actual integration algorithm is much much more important (assuming `f` is written with decent performance).","user":"U67D54KS8","ts":"1613665773.253000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6A=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I still think looking at the actual integration algorithm is much much more important (assuming "},{"type":"text","text":"f","style":{"code":true}},{"type":"text","text":" is written with decent performance)."}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y","reactions":[{"name":"thumbsup_all","users":["U0179G7FG4F","UAUPJLBQX"],"count":2}]},{"client_msg_id":"2fb4acb9-40fb-41ba-97cf-e8b53d50d732","type":"message","text":"Thanks for thinking about this, everyone. I'm a bit confused atm though. <@UAUPJLBQX> is a loop really faster than a vectorized operation? I'm used to thinking about it going the other way","user":"U91Q3595Y","ts":"1613667895.253300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vPo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks for thinking about this, everyone. I'm a bit confused atm though. "},{"type":"user","user_id":"UAUPJLBQX"},{"type":"text","text":" is a loop really faster than a vectorized operation? I'm used to thinking about it going the other way"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"8972dc81-3425-4337-972b-97667bc8ab83","type":"message","text":"Here's what I'm looking at atm\n```gnodes, gweights = gausslegendre( 10000 );\nfunction fastgq(f::F, a, b) where {F}\n    fx = @. f(0.5*((b - a)*gnodes .+ (b+a)))\n    out = 0.5.*(b.-a)*dot( gweights, fx )\n    return(out)\nend```","user":"U91Q3595Y","ts":"1613668189.253500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fpa","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Here's what I'm looking at atm\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"gnodes, gweights = gausslegendre( 10000 );\nfunction fastgq(f::F, a, b) where {F}\n    fx = @. f(0.5*((b - a)*gnodes .+ (b+a)))\n    out = 0.5.*(b.-a)*dot( gweights, fx )\n    return(out)\nend"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"4466f515-2740-4c0c-8606-d6b21fdedba1","type":"message","text":"I was surprised but quadgk is actually performing a lot faster. It seems like the main difference is that my `fastgq` function is making millions more allocations. But I'm not sure why it's doing that given that I'm preallocating the nodes and weights. Is there a good way to fix this?","user":"U91Q3595Y","ts":"1613668786.253700","team":"T68168MUP","edited":{"user":"U91Q3595Y","ts":"1613668807.000000"},"blocks":[{"type":"rich_text","block_id":"beH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I was surprised but quadgk is actually performing a lot faster. It seems like the main difference is that my "},{"type":"text","text":"fastgq","style":{"code":true}},{"type":"text","text":" function is making millions more allocations. But I'm not sure why it's doing that given that I'm preallocating the nodes and weights. Is there a good way to fix this?"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"42f625de-7cf9-4f11-adf5-8e0d42e8a344","type":"message","text":"I would do either\n```const gnodes, gweights = gausslegendre( 10000 );```\nOr maybe\n```const NODESWEIGHTS = Ref(gausslegendre( 10000 ));```\nso that you can swap them out with\n```NODESWEIGHTS[] = ausslegendre( 100 )```\nthen inside your function, you'd do\n```function fastgq(...)\n    gnones, gweights = NODESWEIGHTS[]\n    ...\nend```","user":"UAUPJLBQX","ts":"1613669638.254200","team":"T68168MUP","edited":{"user":"UAUPJLBQX","ts":"1613669677.000000"},"blocks":[{"type":"rich_text","block_id":"zSE6P","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I would do either\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"const gnodes, gweights = gausslegendre( 10000 );"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Or maybe\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"const NODESWEIGHTS = Ref(gausslegendre( 10000 ));"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"so that you can swap them out with\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"NODESWEIGHTS[] = ausslegendre( 100 )"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"then inside your function, you'd do\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function fastgq(...)\n    gnones, gweights = NODESWEIGHTS[]\n    ...\nend"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"d1d005ac-4a55-4ed0-977f-310ba0038920","type":"message","text":"interesting. I'll try that. Thanks!","user":"U91Q3595Y","ts":"1613669694.254500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kKv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"interesting. I'll try that. Thanks!"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"0ede3a12-11fd-4737-8ad1-24b2867bebec","type":"message","text":"as Kristoffer noted, I'd focus more on the integration algorithm","user":"UAUPJLBQX","ts":"1613669705.254700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hEq16","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"as Kristoffer noted, I'd focus more on the integration algorithm"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"2f194ed0-f371-4cba-bd9f-5c1d74d21ad4","type":"message","text":"In particular, do you need that many nodes and weights for accuracy?","user":"UAUPJLBQX","ts":"1613669721.254900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zh0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"In particular, do you need that many nodes and weights for accuracy?"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"5c603f75-f2c7-40d9-9527-7bcf75225f87","type":"message","text":"Right. I can do some tests. Would you also recommend replacing the `dot`?","user":"U91Q3595Y","ts":"1613669745.255100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"B5ul","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Right. I can do some tests. Would you also recommend replacing the "},{"type":"text","text":"dot","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"},{"client_msg_id":"3b76cead-94c2-4f11-aea2-04fa29245e85","type":"message","text":"If your function is reasonably smooth, Chebyshev often reaches almost the exact answer with 20 or less.\nObviously, using 20 instead of 10_000 is a good way to get a 500x speedup.","user":"UAUPJLBQX","ts":"1613669821.255300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"II1Gd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If your function is reasonably smooth, Chebyshev often reaches almost the exact answer with 20 or less.\nObviously, using 20 instead of 10_000 is a good way to get a 500x speedup."}]}]}],"thread_ts":"1613615785.248800","parent_user_id":"U91Q3595Y"}]