[{"client_msg_id":"5effe515-275e-45ef-90e7-55196ac40b59","type":"message","text":"Is there a clever way to get a loop with a conditional `break` to vectorize? If I convert it to a while loop, then it's slower.","user":"U011V2YN59N","ts":"1616774934.039300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RdRTQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is there a clever way to get a loop with a conditional "},{"type":"text","text":"break","style":{"code":true}},{"type":"text","text":" to vectorize? If I convert it to a while loop, then it's slower."}]}]}],"thread_ts":"1616774934.039300","reply_count":19,"reply_users_count":3,"latest_reply":"1616779676.043700","reply_users":["U6QGE7S86","U011V2YN59N","U67BJLYCS"],"is_locked":false,"subscribed":false},{"client_msg_id":"fe9d9a05-3dd2-4466-a936-fc8dafdda92e","type":"message","text":"Show the code!","user":"U6QGE7S86","ts":"1616774950.039400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=tTM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Show the code!"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"9ac94a40-e068-4716-9c48-87fe15e4a3e3","type":"message","text":"hah ok","user":"U011V2YN59N","ts":"1616774983.039600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PIBhi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hah ok"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"6fa87fc5-ff9c-4c5e-8c31-48b006198635","type":"message","text":"```    for k = 1:sample_list_length\n        if (contacts_sums != 0)\n            i_index = index_list_i[k]\n            j_index = index_list_j[k]    \n            contacts_sums +=  j_to_i_contacts[j_index] - i_to_j_contacts[i_index]\n\n            i_to_j_contacts[i_index] = sample_list_i[k]\n            j_to_i_contacts[j_index] = sample_list_j[k]    \n            contacts_sums += i_to_j_contacts[i_index] -  j_to_i_contacts[j_index]\n        else\n            break\n        end\n    end```","user":"U011V2YN59N","ts":"1616774984.039800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"IkKe","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"    for k = 1:sample_list_length\n        if (contacts_sums != 0)\n            i_index = index_list_i[k]\n            j_index = index_list_j[k]    \n            contacts_sums +=  j_to_i_contacts[j_index] - i_to_j_contacts[i_index]\n\n            i_to_j_contacts[i_index] = sample_list_i[k]\n            j_to_i_contacts[j_index] = sample_list_j[k]    \n            contacts_sums += i_to_j_contacts[i_index] -  j_to_i_contacts[j_index]\n        else\n            break\n        end\n    end"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"f40c85ac-dcb9-49b9-aec0-61485c4622f4","type":"message","text":"I think you missed a few lines at the beginning","user":"U6QGE7S86","ts":"1616775008.040000","team":"T68168MUP","edited":{"user":"U6QGE7S86","ts":"1616775017.000000"},"blocks":[{"type":"rich_text","block_id":"9iSt","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think you missed a few lines at the beginning"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"387ba859-5c8c-42ad-8263-8f7bc34a5e05","type":"message","text":"yeah this is part of much larger function","user":"U011V2YN59N","ts":"1616775059.040300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"bN/mW","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah this is part of much larger function"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"2cc50bd4-2b90-4859-8db7-ddef8faca66c","type":"message","text":"here\n```\nfunction generate_contact_vectors!(ij_dist,ji_dist,i_to_j_contacts, j_to_i_contacts)\n    rand!(RNG,ij_dist,i_to_j_contacts)\n    rand!(RNG,ji_dist,j_to_i_contacts)\n    l_i = length(i_to_j_contacts)\n    l_j = length(j_to_i_contacts)\n    contacts_sums = sum(i_to_j_contacts) - sum(j_to_i_contacts)\n    sample_list_length = max(l_i,l_j) #better heuristic for this based on stddev of dist?\n    index_list_i = sample(RNG,1:l_i,sample_list_length)\n    index_list_j = sample(RNG,1:l_j,sample_list_length)\n    sample_list_i = rand(RNG,ij_dist,sample_list_length)\n    sample_list_j = rand(RNG,ji_dist,sample_list_length)\n    for k = 1:sample_list_length\n        if (contacts_sums != 0)\n            i_index = index_list_i[k]\n            j_index = index_list_j[k]    \n            contacts_sums +=  j_to_i_contacts[j_index] - i_to_j_contacts[i_index]\n\n            i_to_j_contacts[i_index] = sample_list_i[k]\n            j_to_i_contacts[j_index] = sample_list_j[k]    \n            contacts_sums += i_to_j_contacts[i_index] -  j_to_i_contacts[j_index]\n        else\n            break\n        end\n    end\n    while contacts_sums != 0\n        i_index = sample(RNG,1:l_i)\n        j_index = sample(RNG,1:l_j)\n        contacts_sums +=  j_to_i_contacts[j_index] - i_to_j_contacts[i_index]\n        i_to_j_contacts[i_index] = rand(RNG,ij_dist)\n        j_to_i_contacts[j_index] = rand(RNG,ji_dist)\n        contacts_sums += i_to_j_contacts[i_index] -  j_to_i_contacts[j_index]\n    end\n    return nothing\nend```","user":"U011V2YN59N","ts":"1616775101.040500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xifh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"here\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"\nfunction generate_contact_vectors!(ij_dist,ji_dist,i_to_j_contacts, j_to_i_contacts)\n    rand!(RNG,ij_dist,i_to_j_contacts)\n    rand!(RNG,ji_dist,j_to_i_contacts)\n    l_i = length(i_to_j_contacts)\n    l_j = length(j_to_i_contacts)\n    contacts_sums = sum(i_to_j_contacts) - sum(j_to_i_contacts)\n    sample_list_length = max(l_i,l_j) #better heuristic for this based on stddev of dist?\n    index_list_i = sample(RNG,1:l_i,sample_list_length)\n    index_list_j = sample(RNG,1:l_j,sample_list_length)\n    sample_list_i = rand(RNG,ij_dist,sample_list_length)\n    sample_list_j = rand(RNG,ji_dist,sample_list_length)\n    for k = 1:sample_list_length\n        if (contacts_sums != 0)\n            i_index = index_list_i[k]\n            j_index = index_list_j[k]    \n            contacts_sums +=  j_to_i_contacts[j_index] - i_to_j_contacts[i_index]\n\n            i_to_j_contacts[i_index] = sample_list_i[k]\n            j_to_i_contacts[j_index] = sample_list_j[k]    \n            contacts_sums += i_to_j_contacts[i_index] -  j_to_i_contacts[j_index]\n        else\n            break\n        end\n    end\n    while contacts_sums != 0\n        i_index = sample(RNG,1:l_i)\n        j_index = sample(RNG,1:l_j)\n        contacts_sums +=  j_to_i_contacts[j_index] - i_to_j_contacts[i_index]\n        i_to_j_contacts[i_index] = rand(RNG,ij_dist)\n        j_to_i_contacts[j_index] = rand(RNG,ji_dist)\n        contacts_sums += i_to_j_contacts[i_index] -  j_to_i_contacts[j_index]\n    end\n    return nothing\nend"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"6139f203-1084-4a9e-a5d4-c8a6e91741fa","type":"message","text":"so if `contacts_sum` is not 0, you do sums, otherwise, just break out of the loop entirely?","user":"U6QGE7S86","ts":"1616775103.040700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0BAK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so if "},{"type":"text","text":"contacts_sum","style":{"code":true}},{"type":"text","text":" is not 0, you do sums, otherwise, just break out of the loop entirely?"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"5fab731e-ae1e-42f7-838a-56b225d65ec3","type":"message","text":"yes.","user":"U011V2YN59N","ts":"1616775113.040900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UtK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yes."}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"8ee0a07b-d654-41ee-9589-a2eaa51acc33","type":"message","text":"this function is resampling from `ij_dist` and `ji_dist` into `i_to_j_contacts` and `j_to_i_contacts` until the sums of these vectors are equal","user":"U011V2YN59N","ts":"1616775190.041100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"o0k1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"this function is resampling from "},{"type":"text","text":"ij_dist","style":{"code":true}},{"type":"text","text":" and "},{"type":"text","text":"ji_dist","style":{"code":true}},{"type":"text","text":" into `i_to_j_contacts` and `j_to_i_contacts` until the sums of these vectors are equal"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"194aa79a-5f52-4ff2-8793-4dc9ba97eb90","type":"message","text":"the object is to generate a bipartite graph with prescribed degree distributions `ij_dist` , `ji_dist`","user":"U011V2YN59N","ts":"1616775230.041300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"K4Ux","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the object is to generate a bipartite graph with prescribed degree distributions "},{"type":"text","text":"ij_dist","style":{"code":true}},{"type":"text","text":" , "},{"type":"text","text":"ji_dist","style":{"code":true}}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"d6ae0ef5-a08b-47d9-8f7b-f4d08c7e041c","type":"message","text":"as per the algorithm from Newman et al.","user":"U011V2YN59N","ts":"1616775261.041500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"J5vCD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"as per the algorithm from Newman et al."}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"type":"message","text":"","files":[{"id":"F01S4D60SJ3","created":1616775262,"timestamp":1616775262,"name":"image.png","title":"image.png","mimetype":"image/png","filetype":"png","pretty_type":"PNG","user":"U011V2YN59N","editable":false,"size":217687,"mode":"hosted","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01S4D60SJ3/image.png","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01S4D60SJ3/download/image.png","thumb_64":"https://files.slack.com/files-tmb/T68168MUP-F01S4D60SJ3-f7600c1fa1/image_64.png","thumb_80":"https://files.slack.com/files-tmb/T68168MUP-F01S4D60SJ3-f7600c1fa1/image_80.png","thumb_360":"https://files.slack.com/files-tmb/T68168MUP-F01S4D60SJ3-f7600c1fa1/image_360.png","thumb_360_w":360,"thumb_360_h":214,"thumb_480":"https://files.slack.com/files-tmb/T68168MUP-F01S4D60SJ3-f7600c1fa1/image_480.png","thumb_480_w":480,"thumb_480_h":285,"thumb_160":"https://files.slack.com/files-tmb/T68168MUP-F01S4D60SJ3-f7600c1fa1/image_160.png","original_w":510,"original_h":303,"thumb_tiny":"AwAcADC+XO4gHGPpSbzjO4fpSE4J+v8AnvR9D+v/ANegAJGeduPoKMjHRfyFGff/AD+dGe5P+fzoAXef7w/SlDncBkdfam57c/5/Glz8w5/z+dAAep60g696cUAY/wCFAUbf/rCgBuPY/wCfwo79DinbR+XsKVVXHQH8KAGYOPrSjkg89aftXOdoz9KNq5Hyjj2oA//Z","permalink":"https://julialang.slack.com/files/U011V2YN59N/F01S4D60SJ3/image.png","permalink_public":"https://slack-files.com/T68168MUP-F01S4D60SJ3-826f389d39","is_starred":false,"has_rich_preview":false}],"upload":false,"user":"U011V2YN59N","display_as_bot":false,"ts":"1616775265.041700","thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"2d3627d6-898a-4af3-8b66-6627def6bdde","type":"message","text":"Sampling in batches initially is _much_ faster, and then I go into the while loop if it has not achieved a zero sum by that point.","user":"U011V2YN59N","ts":"1616775340.042100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RfL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Sampling in batches initially is "},{"type":"text","text":"much","style":{"italic":true}},{"type":"text","text":" faster, and then I go into the while loop if it has not achieved a zero sum by that point."}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"808859f1-47ff-4bae-8daf-46955627aca0","type":"message","text":"Best way is to have an inner loop with a constant factor","user":"U67BJLYCS","ts":"1616775340.042300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3mozJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Best way is to have an inner loop with a constant factor"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"e9a4ae96-052d-4fc9-9ac1-b0609a94aeed","type":"message","text":"If you are okay with running a small number of iterations to many","user":"U67BJLYCS","ts":"1616775379.042500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=y2FT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If you are okay with running a small number of iterations to many"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"ad17027b-6444-4c8d-93a0-2e91a0c254ca","type":"message","text":"<@U67BJLYCS> could you elaborate?","user":"U011V2YN59N","ts":"1616775381.042700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QTgcj","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U67BJLYCS"},{"type":"text","text":" could you elaborate?"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"0e7272a2-968c-4740-b368-ae30bedc531c","type":"message","text":"Oh I see what you mean. I will try that.","user":"U011V2YN59N","ts":"1616775396.042900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xdZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Oh I see what you mean. I will try that."}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"f18b14e5-1ea0-4960-8181-45b5c60fc18c","type":"message","text":":+1:","user":"U67BJLYCS","ts":"1616775429.043100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ecAJc","elements":[{"type":"rich_text_section","elements":[{"type":"emoji","name":"+1"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"},{"client_msg_id":"d018db2e-aad3-48a9-b08c-eafca183fd23","type":"message","text":"here is a faster, and more readable, version:\n```function reindex!(k,csum,index_list_i,index_list_j,j_to_i_contacts,i_to_j_contacts,sample_list_i,sample_list_j)\n    i_index = index_list_i[k]\n    j_index = index_list_j[k]    \n    csum +=  j_to_i_contacts[j_index] - i_to_j_contacts[i_index]\n\n    i_to_j_contacts[i_index] = sample_list_i[k]\n    j_to_i_contacts[j_index] = sample_list_j[k]    \n    csum += i_to_j_contacts[i_index] -  j_to_i_contacts[j_index]\n\n    return csum\nend\n\nfunction generate_contact_vectors!(ij_dist,ji_dist,i_to_j_contacts, j_to_i_contacts)\n    rand!(RNG,ij_dist,i_to_j_contacts)\n    rand!(RNG,ji_dist,j_to_i_contacts)\n    l_i = length(i_to_j_contacts)\n    l_j = length(j_to_i_contacts)\n\n    csum = sum(i_to_j_contacts) - sum(j_to_i_contacts)\n\n    inner_iter = 10\n    index_list_i = sample(RNG,1:l_i,inner_iter)\n    index_list_j = sample(RNG,1:l_j,inner_iter)\n    sample_list_i = rand(RNG,ij_dist,inner_iter)\n    sample_list_j = rand(RNG,ji_dist,inner_iter)\n    while csum != 0\n        for i = 1:inner_iter\n            if csum != 0\n                csum = reindex!(i,csum,index_list_i,index_list_j,j_to_i_contacts,i_to_j_contacts,sample_list_i,sample_list_j)\n            end\n        end\n        index_list_i = sample!(RNG,1:l_i,index_list_i)\n        index_list_j = sample!(RNG,1:l_j,index_list_j)\n        sample_list_i = rand!(RNG,ij_dist,sample_list_i)\n        sample_list_j = rand!(RNG,ji_dist,sample_list_j)\n    end\n    return nothing\nend```\nsmaller batches helped.\n\nI just realized I am silly, since `reindex!` modifies the arrays, this cannot be vectorized without a lot of changes.  thanks for the help though!","user":"U011V2YN59N","ts":"1616779676.043700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"edqmH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"here is a faster, and more readable, version:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function reindex!(k,csum,index_list_i,index_list_j,j_to_i_contacts,i_to_j_contacts,sample_list_i,sample_list_j)\n    i_index = index_list_i[k]\n    j_index = index_list_j[k]    \n    csum +=  j_to_i_contacts[j_index] - i_to_j_contacts[i_index]\n\n    i_to_j_contacts[i_index] = sample_list_i[k]\n    j_to_i_contacts[j_index] = sample_list_j[k]    \n    csum += i_to_j_contacts[i_index] -  j_to_i_contacts[j_index]\n\n    return csum\nend\n\nfunction generate_contact_vectors!(ij_dist,ji_dist,i_to_j_contacts, j_to_i_contacts)\n    rand!(RNG,ij_dist,i_to_j_contacts)\n    rand!(RNG,ji_dist,j_to_i_contacts)\n    l_i = length(i_to_j_contacts)\n    l_j = length(j_to_i_contacts)\n\n    csum = sum(i_to_j_contacts) - sum(j_to_i_contacts)\n\n    inner_iter = 10\n    index_list_i = sample(RNG,1:l_i,inner_iter)\n    index_list_j = sample(RNG,1:l_j,inner_iter)\n    sample_list_i = rand(RNG,ij_dist,inner_iter)\n    sample_list_j = rand(RNG,ji_dist,inner_iter)\n    while csum != 0\n        for i = 1:inner_iter\n            if csum != 0\n                csum = reindex!(i,csum,index_list_i,index_list_j,j_to_i_contacts,i_to_j_contacts,sample_list_i,sample_list_j)\n            end\n        end\n        index_list_i = sample!(RNG,1:l_i,index_list_i)\n        index_list_j = sample!(RNG,1:l_j,index_list_j)\n        sample_list_i = rand!(RNG,ij_dist,sample_list_i)\n        sample_list_j = rand!(RNG,ji_dist,sample_list_j)\n    end\n    return nothing\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"smaller batches helped.\n\nI just realized I am silly, since "},{"type":"text","text":"reindex!","style":{"code":true}},{"type":"text","text":" modifies the arrays, this cannot be vectorized without a lot of changes.  thanks for the help though!"}]}]}],"thread_ts":"1616774934.039300","parent_user_id":"U011V2YN59N"}]