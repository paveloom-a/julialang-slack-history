[{"client_msg_id":"97903825-ad1c-445c-8aa6-20f2f4d7b852","type":"message","text":"Hey I have two matrices of dimensions `D, M` , where `M`  is relatively large (100-1000) and `D`  as large as possible. I want to calculate all the inner products of the columns, i.e.\n`res[i,j]=dot(A[:, i], B[:, j])` . These are the two approaches I have taken\n```using BenchmarkTools\n\nfunction pairwise_inner_products1!(res, A, B)\n    D, M = size(A)\n    Temp = similar(A)\n    for i=1:M\n        Temp .= A .* B\n        res[:, i] .= sum(Temp, dims=1)[:]\n    end\n    res\nend\n\nfunction pairwise_inner_products2!(res, A, B)\n    D, M = size(A)\n    for j=1:M\n        for i=1:M\n            for k=1:D\n                @inbounds res[i, j] += A[k, i] * B[k, j]\n            end\n        end\n    end\nend\n\nD = 500\nM = 300\n\nbench1 = @benchmark pairwise_inner_products1!(res, A, B) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    B = rand(D, M);\n)\n\nbench2 = @benchmark pairwise_inner_products2!(res, A, B) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    B = rand(D, M);\n)```\n","user":"U7PD3M3L5","ts":"1617980182.157300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/m4X","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hey I have two matrices of dimensions "},{"type":"text","text":"D, M","style":{"code":true}},{"type":"text","text":" , where "},{"type":"text","text":"M","style":{"code":true}},{"type":"text","text":"  is relatively large (100-1000) and "},{"type":"text","text":"D","style":{"code":true}},{"type":"text","text":"  as large as possible. I want to calculate all the inner products of the columns, i.e.\n"},{"type":"text","text":"res[i,j]=dot(A[:, i], B[:, j])","style":{"code":true}},{"type":"text","text":" . These are the two approaches I have taken\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using BenchmarkTools\n\nfunction pairwise_inner_products1!(res, A, B)\n    D, M = size(A)\n    Temp = similar(A)\n    for i=1:M\n        Temp .= A .* B\n        res[:, i] .= sum(Temp, dims=1)[:]\n    end\n    res\nend\n\nfunction pairwise_inner_products2!(res, A, B)\n    D, M = size(A)\n    for j=1:M\n        for i=1:M\n            for k=1:D\n                @inbounds res[i, j] += A[k, i] * B[k, j]\n            end\n        end\n    end\nend\n\nD = 500\nM = 300\n\nbench1 = @benchmark pairwise_inner_products1!(res, A, B) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    B = rand(D, M);\n)\n\nbench2 = @benchmark pairwise_inner_products2!(res, A, B) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    B = rand(D, M);\n)"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1617980182.157300","reply_count":45,"reply_users_count":4,"latest_reply":"1617983865.174800","reply_users":["UH24GRBLL","U7PD3M3L5","UMDEUKM29","UD0NS8PDF"],"is_locked":false,"subscribed":false},{"client_msg_id":"f80b455d-5ac8-4513-ba6d-83e799828f2d","type":"message","text":"`sum(Temp, dims=1)[:]` allocates twice","user":"UH24GRBLL","ts":"1617980394.157900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"86P","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"sum(Temp, dims=1)[:]","style":{"code":true}},{"type":"text","text":" allocates twice"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"cae2ec49-f560-4f03-b7d9-e31a9d5f18e6","type":"message","text":"check `?sum!`","user":"UH24GRBLL","ts":"1617980439.158100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/FPbL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"check "},{"type":"text","text":"?sum!","style":{"code":true}}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"ce1e1e2a-a7c8-4a43-bca0-f7dc97b7c03f","type":"message","text":"Ah yeah right, `sum!(res[:, i]', Temp)` gets the allocations down from `602`  to `301`  in the first benchmark, and gives another `1ms`  in the mean, so `16ms`  now","user":"U7PD3M3L5","ts":"1617980633.158300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7MfAG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah yeah right, "},{"type":"text","text":"sum!(res[:, i]', Temp)","style":{"code":true}},{"type":"text","text":" gets the allocations down from "},{"type":"text","text":"602","style":{"code":true}},{"type":"text","text":"  to "},{"type":"text","text":"301","style":{"code":true}},{"type":"text","text":"  in the first benchmark, and gives another "},{"type":"text","text":"1ms","style":{"code":true}},{"type":"text","text":"  in the mean, so "},{"type":"text","text":"16ms","style":{"code":true}},{"type":"text","text":"  now"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"78dc786f-c843-4ff1-94de-de6fbd8af5aa","type":"message","text":"um, `D'*M`?","user":"UMDEUKM29","ts":"1617980714.159000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ymyge","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"um, "},{"type":"text","text":"D'*M","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"9bcae20e-48db-42b5-a679-d3f3285a9fe8","type":"message","text":"Also, `pairwise_inner_products1!` gives different answers to 2, and to `A'*B`","user":"UD0NS8PDF","ts":"1617980869.159200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/h0X","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Also, "},{"type":"text","text":"pairwise_inner_products1!","style":{"code":true}},{"type":"text","text":" gives different answers to 2, and to "},{"type":"text","text":"A'*B","style":{"code":true}}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"4a4eef89-54a4-4c9f-99e9-990ce0c7ee30","type":"message","text":"use a view for the `res[:,i]` part, as that again allocates because of the slice","user":"UH24GRBLL","ts":"1617980912.159400","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1617980924.000000"},"blocks":[{"type":"rich_text","block_id":"vSAK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"use a view for the "},{"type":"text","text":"res[:,i]","style":{"code":true}},{"type":"text","text":" part, as that again allocates because of the slice"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"0ab2c065-031e-4496-a625-f5830a4925c2","type":"message","text":"slices on the right hand side of an `=` allocate a copy","user":"UH24GRBLL","ts":"1617980955.160500","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1617980959.000000"},"blocks":[{"type":"rich_text","block_id":"hL9o","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"slices on the right hand side of an "},{"type":"text","text":"=","style":{"code":true}},{"type":"text","text":" allocate a copy"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"1ceda753-b6b4-48c5-9c0d-5a0da645bdbe","type":"message","text":"pretty sure you'll get at least 10x improvement with `D'*M`","user":"UMDEUKM29","ts":"1617981022.161400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6Q4c","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"pretty sure you'll get at least 10x improvement with "},{"type":"text","text":"D'*M","style":{"code":true}}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"f79d456f-7bd6-482d-93df-4fcc05a87ea5","type":"message","text":"```julia&gt; @btime pairwise_inner_products1!($res, $A, $B);\n  18.177 ms (602 allocations: 2.61 MiB)\n\njulia&gt; @btime pairwise_inner_products2!($res, $A, $B);\n  39.456 ms (0 allocations: 0 bytes)\n\njulia&gt; @btime mul!($res, $A', $B);\n  917.916 μs (0 allocations: 0 bytes)```","user":"UD0NS8PDF","ts":"1617981065.161800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"f2gjY","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @btime pairwise_inner_products1!($res, $A, $B);\n  18.177 ms (602 allocations: 2.61 MiB)\n\njulia> @btime pairwise_inner_products2!($res, $A, $B);\n  39.456 ms (0 allocations: 0 bytes)\n\njulia> @btime mul!($res, $A', $B);\n  917.916 μs (0 allocations: 0 bytes)"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"f56172d5-d5c6-4c6e-846a-e0dd3b0722bb","type":"message","text":"a lol yeah of course it is `A' * B`  in this case. I simplified my problem to post it here and simplified it to much it seems","user":"U7PD3M3L5","ts":"1617981242.162600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vkxL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"a lol yeah of course it is "},{"type":"text","text":"A' * B","style":{"code":true}},{"type":"text","text":"  in this case. I simplified my problem to post it here and simplified it to much it seems"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"ee5d0e30-d65d-4662-8764-951d93c6a722","type":"message","text":"What I actually want to calculate is\n```res[i, j] = (A[:, i]-A[:,j])' * Sigma * (A[:, i] - A[:, j])```","user":"U7PD3M3L5","ts":"1617981366.162800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ql7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What I actually want to calculate is\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"res[i, j] = (A[:, i]-A[:,j])' * Sigma * (A[:, i] - A[:, j])"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"a54ead50-d6d2-4a49-bcbb-305a0fa43871","type":"message","text":"I'll try to write a sample function for that. Thanks","user":"U7PD3M3L5","ts":"1617981421.163000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=8Gh7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'll try to write a sample function for that. Thanks"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"90d65d2d-8d01-4a9f-b59a-eca7af5e6689","type":"message","text":"all those slices allocate. use `@views`","user":"UH24GRBLL","ts":"1617981485.163700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ddd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"all those slices allocate. use "},{"type":"text","text":"@views","style":{"code":true}}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"8adddbf2-b741-4db3-9c46-3c283afc6529","type":"message","text":"moreover, you can reuse the result of `A[:, i] - A[:, j]`, since `'` is a lazy transpose","user":"UH24GRBLL","ts":"1617981530.163900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Fo5","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"moreover, you can reuse the result of "},{"type":"text","text":"A[:, i] - A[:, j]","style":{"code":true}},{"type":"text","text":", since "},{"type":"text","text":"'","style":{"code":true}},{"type":"text","text":" is a lazy transpose"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"34dab635-f69e-4811-a177-8b8cbfe30271","type":"message","text":"```D = 500\nM = 300\nres = rand(M, M);\nA = rand(D, M);\nSigma = rand(D, D);\n\nfunction fun1!(res, A, Sigma)\n    @views for j in axes(res,2)\n        for i in axes(res,1)\n            res[i, j] = (A[:, i]-A[:,j])' * Sigma * (A[:, i] - A[:, j])\n        end\n    end\n    res\nend\n\nfunction fun2!(res, A, Sigma, col = A[:, 1]-A[:,1])\n    @views for j in axes(res,2)\n        for i in axes(res,1)\n            col .= A[:, i] .- A[:,j]\n            res[i, j] = col' * Sigma * col # this allocates\n            # res[i, j] = dot(col, Sigma, col) # probably slower\n        end\n    end\n    res\nend\n\nusing Tullio, LoopVectorization\n\nfun3!(res, A, Sigma) = @tullio res[i, j] = (A[x, i]-A[x,j])' * Sigma[x,y] * (A[y, i] - A[y, j])\n\nfunction fun4!(res, A, Sigma, tmp=similar(res, size(Sigma,1), size(A,2), size(A,2)))\n    @tullio tmp[x,i,j] = Sigma[x,y] * (A[y, i] - A[y, j])\n    @tullio res[i, j] = (A[x, i]-A[x,j])' * tmp[x,i,j]\nend\n\nusing TensorCast\n\nfunction fun5!(res, A, Sigma, tmp=similar(res, size(Sigma,1), size(A,2), size(A,2)))\n    SA = Sigma * A\n    @cast tmp[x,i,j] = SA[x,i] * SA[x,j]\n    @tullio res[i, j] = (A[x, i]-A[x,j])' * tmp[x,i,j]\nend\n\nfunction fun6!(res, A, Sigma, tmp=similar(res, size(Sigma,1), size(A,2), size(A,2)))\n    ASA = A' * Sigma * A\n    @cast res[i,j] = ASA[i,i] + ASA[j,j] - ASA[i,j] - ASA[j,i] \nend\n\nfun1!(res, A, Sigma) ≈ fun2!(res, A, Sigma) ≈ fun3!(res, A, Sigma) ≈ fun4!(res, A, Sigma)\n\n@btime fun1!($res, $A, $Sigma);\n@btime fun2!($res, $A, $Sigma);\n@btime fun3!($res, $A, $Sigma);\n@btime fun4!($res, $A, $Sigma);\n\ntmp = similar(res, size(Sigma,1), size(A,2), size(A,2));\n@btime fun4!($res, $A, $Sigma, $tmp);\n@btime fun5!($res, $A, $Sigma, $tmp);\n\n@btime fun6!($res, $A, $Sigma);```","user":"UD0NS8PDF","ts":"1617982004.164900","team":"T68168MUP","edited":{"user":"UD0NS8PDF","ts":"1617982786.000000"},"blocks":[{"type":"rich_text","block_id":"RgUz","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"D = 500\nM = 300\nres = rand(M, M);\nA = rand(D, M);\nSigma = rand(D, D);\n\nfunction fun1!(res, A, Sigma)\n    @views for j in axes(res,2)\n        for i in axes(res,1)\n            res[i, j] = (A[:, i]-A[:,j])' * Sigma * (A[:, i] - A[:, j])\n        end\n    end\n    res\nend\n\nfunction fun2!(res, A, Sigma, col = A[:, 1]-A[:,1])\n    @views for j in axes(res,2)\n        for i in axes(res,1)\n            col .= A[:, i] .- A[:,j]\n            res[i, j] = col' * Sigma * col # this allocates\n            # res[i, j] = dot(col, Sigma, col) # probably slower\n        end\n    end\n    res\nend\n\nusing Tullio, LoopVectorization\n\nfun3!(res, A, Sigma) = @tullio res[i, j] = (A[x, i]-A[x,j])' * Sigma[x,y] * (A[y, i] - A[y, j])\n\nfunction fun4!(res, A, Sigma, tmp=similar(res, size(Sigma,1), size(A,2), size(A,2)))\n    @tullio tmp[x,i,j] = Sigma[x,y] * (A[y, i] - A[y, j])\n    @tullio res[i, j] = (A[x, i]-A[x,j])' * tmp[x,i,j]\nend\n\nusing TensorCast\n\nfunction fun5!(res, A, Sigma, tmp=similar(res, size(Sigma,1), size(A,2), size(A,2)))\n    SA = Sigma * A\n    @cast tmp[x,i,j] = SA[x,i] * SA[x,j]\n    @tullio res[i, j] = (A[x, i]-A[x,j])' * tmp[x,i,j]\nend\n\nfunction fun6!(res, A, Sigma, tmp=similar(res, size(Sigma,1), size(A,2), size(A,2)))\n    ASA = A' * Sigma * A\n    @cast res[i,j] = ASA[i,i] + ASA[j,j] - ASA[i,j] - ASA[j,i] \nend\n\nfun1!(res, A, Sigma) ≈ fun2!(res, A, Sigma) ≈ fun3!(res, A, Sigma) ≈ fun4!(res, A, Sigma)\n\n@btime fun1!($res, $A, $Sigma);\n@btime fun2!($res, $A, $Sigma);\n@btime fun3!($res, $A, $Sigma);\n@btime fun4!($res, $A, $Sigma);\n\ntmp = similar(res, size(Sigma,1), size(A,2), size(A,2));\n@btime fun4!($res, $A, $Sigma, $tmp);\n@btime fun5!($res, $A, $Sigma, $tmp);\n\n@btime fun6!($res, $A, $Sigma);"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5","reactions":[{"name":"pray","users":["U7PD3M3L5"],"count":1}]},{"client_msg_id":"9a841022-13ca-4db6-b1b6-7dd6605dd604","type":"message","text":"ah, thank you. I'll benchmark that against my implementation on my pc","user":"U7PD3M3L5","ts":"1617982197.166600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"bdI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ah, thank you. I'll benchmark that against my implementation on my pc"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"8288a106-01a0-46c1-a506-ef8ea24c554f","type":"message","text":"mcabbot getting out the big guns :eyes:","user":"UH24GRBLL","ts":"1617982226.166900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Uj3W","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"mcabbot getting out the big guns "},{"type":"emoji","name":"eyes"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"71fbb35c-771a-4d37-b276-77240439107c","type":"message","text":"that can still be expressed in terms of A' Sigma A","user":"UMDEUKM29","ts":"1617982374.167800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jn9Rj","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that can still be expressed in terms of A' Sigma A"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5","reactions":[{"name":"pray","users":["U7PD3M3L5"],"count":1}]},{"client_msg_id":"96cc820a-e7f9-40d9-b55b-4f6b009eab5b","type":"message","text":"(expand the expression)","user":"UMDEUKM29","ts":"1617982379.168000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UTHN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"(expand the expression)"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"0f702da1-d998-46ad-8605-f7e588e6b7af","type":"message","text":"Ah yeah, somehow I thought I do not need every entry of `A' * Sigma * A` , but due to the cross terms I do","user":"U7PD3M3L5","ts":"1617982482.168500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"NDI8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah yeah, somehow I thought I do not need every entry of "},{"type":"text","text":"A' * Sigma * A","style":{"code":true}},{"type":"text","text":" , but due to the cross terms I do"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"8c4b9aba-6113-4c2c-ac09-ffc2a90914e0","type":"message","text":"Oh yea, I think that will be better. (Updated, `fun6!`)","user":"UD0NS8PDF","ts":"1617982487.168700","team":"T68168MUP","edited":{"user":"UD0NS8PDF","ts":"1617982871.000000"},"blocks":[{"type":"rich_text","block_id":"79fv6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Oh yea, I think that will be better. (Updated, "},{"type":"text","text":"fun6!","style":{"code":true}},{"type":"text","text":")"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5","reactions":[{"name":"white_check_mark","users":["U7PD3M3L5"],"count":1}]},{"client_msg_id":"5a94afe9-800f-41c3-9f11-365e456ecfb8","type":"message","text":"Ok yeah than that is probably the best implementation, thanks","user":"U7PD3M3L5","ts":"1617982497.168900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"w6y","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ok yeah than that is probably the best implementation, thanks"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"6ed42ca4-469e-4735-b6ab-8833ec994eff","type":"message","text":"the first rule of this kind of computations is to try to recognize a matrix multiplication. In fact when coding in matlab or python it's pretty much *the* rule, because it's essentially all you can do quickly","user":"UMDEUKM29","ts":"1617982616.169200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"WwKaz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the first rule of this kind of computations is to try to recognize a matrix multiplication. In fact when coding in matlab or python it's pretty much "},{"type":"text","text":"the","style":{"bold":true}},{"type":"text","text":" rule, because it's essentially all you can do quickly"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"6db8f70f-f3da-4633-b117-4c00736a32c3","type":"message","text":"yeah I was kind of blind here to not see that, thanks for hinting me to the obvious twice","user":"U7PD3M3L5","ts":"1617982836.169500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/EI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah I was kind of blind here to not see that, thanks for hinting me to the obvious twice"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"9b905a36-880d-4900-baa3-d6be5f77c3f5","type":"message","text":"sometimes one needs to take a step back","user":"U7PD3M3L5","ts":"1617982845.169700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"d0h","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"sometimes one needs to take a step back"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"7e03b969-dd21-40b4-9ac8-7ae4a60fe251","type":"message","text":"and bc of python/matlab: At least for me it feels the same in Julia. I am not a pro and do not know the low level optimizations ppl did in this thread. But when I implement something in Julia \"naively\" vs Matrix multiplication I also normally get great beneftis from the matrix multiplication","user":"U7PD3M3L5","ts":"1617982911.170000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Sdi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and bc of python/matlab: At least for me it feels the same in Julia. I am not a pro and do not know the low level optimizations ppl did in this thread. But when I implement something in Julia \"naively\" vs Matrix multiplication I also normally get great beneftis from the matrix multiplication"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"aee54406-c81f-45d9-9a8c-66a046a75056","type":"message","text":"oh absolutely, whenever you have something that reduces to a matrix multiplication it should be done through that. When you *don't* have something that looks naturally like a matrix operation however, a common technique in matlab/numpy is to try to make it look like a matrix operation anyway","user":"UMDEUKM29","ts":"1617983074.170200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6bH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh absolutely, whenever you have something that reduces to a matrix multiplication it should be done through that. When you "},{"type":"text","text":"don't","style":{"bold":true}},{"type":"text","text":" have something that looks naturally like a matrix operation however, a common technique in matlab/numpy is to try to make it look like a matrix operation anyway"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"0c2c0a58-8be3-411b-b153-8a4ccefff728","type":"message","text":"just to avoid loops","user":"UMDEUKM29","ts":"1617983094.170500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hdC4G","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"just to avoid loops"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"372dd5c6-653d-4bde-aa9a-698884fa58ed","type":"message","text":"<@UD0NS8PDF> yeah thats a crazy improvement on my pc, from 60ms for the fastest implementation otherwise to 2ms for the matrix multiplication","user":"U7PD3M3L5","ts":"1617983170.171100","team":"T68168MUP","edited":{"user":"U7PD3M3L5","ts":"1617983180.000000"},"blocks":[{"type":"rich_text","block_id":"zBp/","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UD0NS8PDF"},{"type":"text","text":" yeah thats a crazy improvement on my pc, from 60ms for the fastest implementation otherwise to 2ms for the matrix multiplication"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"7787973a-8fdf-480d-9bb8-effc38cf7597","type":"message","text":"It’s fun in Julia that you can sometimes find places where breaking the map-it-to-matmul rule of thumb really pays off. This isn’t one of them, I think all my doodles above are algorithmically stupid… need another coffee it seems.","user":"UD0NS8PDF","ts":"1617983179.171300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"tet","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It’s fun in Julia that you can sometimes find places where breaking the map-it-to-matmul rule of thumb really pays off. This isn’t one of them, I think all my doodles above are algorithmically stupid… need another coffee it seems."}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"d51069e0-66b6-430c-97ac-5078fd1fc083","type":"message","text":"eg to do something like `[max(i,j) for i=1:N, j=1:N]` you'd do something like `max(1:N * ones(N)', ones(N)*(1:N)')` or such craziness","user":"UMDEUKM29","ts":"1617983194.171600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DR1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"eg to do something like "},{"type":"text","text":"[max(i,j) for i=1:N, j=1:N]","style":{"code":true}},{"type":"text","text":" you'd do something like "},{"type":"text","text":"max(1:N * ones(N)', ones(N)*(1:N)')","style":{"code":true}},{"type":"text","text":" or such craziness"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"849b0284-c639-4013-a2c7-0dab3b936b5d","type":"message","text":"haha lol thats exactly how the matlab code by my prof looks","user":"U7PD3M3L5","ts":"1617983273.171800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fyV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"haha lol thats exactly how the matlab code by my prof looks"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"fd96963b-595a-43ab-a441-1233f43de95a","type":"message","text":"yes, and much worse!","user":"UD0NS8PDF","ts":"1617983287.172000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"wXaT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yes, and much worse!"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"5121466d-5ad7-4276-865d-161c3853f085","type":"message","text":"everywhere *ones or *ones' to take averages or to subtract a vector from a matrix","user":"U7PD3M3L5","ts":"1617983300.172200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gWm4p","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"everywhere *ones or *ones' to take averages or to subtract a vector from a matrix"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"f469c83c-9ef8-4cb4-b38d-ce88ffdf01d6","type":"message","text":"it was a kind of fun brain teaser, but my god I'm glad julia just obsoleted it","user":"UMDEUKM29","ts":"1617983327.172400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Kpe","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it was a kind of fun brain teaser, but my god I'm glad julia just obsoleted it"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"86211293-86a5-4492-b63b-22a4d753c8c8","type":"message","text":"but does it really obsolete it? Somehow at least in my experiments it does look as if doing matrix multiplications pays off a lot.\n\nAverages can be done by `sum`  instead of * ones and subtracting a vector can be done by `.- v`  instead of `- v * ones'` , but on other occasions it seems as if matrices are still the way to go?","user":"U7PD3M3L5","ts":"1617983442.172600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"A=aZc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but does it really obsolete it? Somehow at least in my experiments it does look as if doing matrix multiplications pays off a lot.\n\nAverages can be done by "},{"type":"text","text":"sum","style":{"code":true}},{"type":"text","text":"  instead of * ones and subtracting a vector can be done by "},{"type":"text","text":".- v","style":{"code":true}},{"type":"text","text":"  instead of "},{"type":"text","text":"- v * ones'","style":{"code":true}},{"type":"text","text":" , but on other occasions it seems as if matrices are still the way to go?"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"a94f9eb6-278f-4a1d-becb-dedd01def8ff","type":"message","text":"yeah sure but you don't have to be afraid of loops, when the problem calls for it","user":"UMDEUKM29","ts":"1617983496.172800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"lrhb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah sure but you don't have to be afraid of loops, when the problem calls for it"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"64af127a-6b5b-4440-937f-3050a915aaa7","type":"message","text":"the main point (for me at least) is that there's no erreonous `ones(N)'` anywhere just to make numpy happy","user":"UH24GRBLL","ts":"1617983571.173000","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1617983579.000000"},"blocks":[{"type":"rich_text","block_id":"GDDG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the main point (for me at least) is that there's no erreonous "},{"type":"text","text":"ones(N)'","style":{"code":true}},{"type":"text","text":" anywhere just to make numpy happy"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"c396cdb6-cb70-4451-9b75-d04e081f6cbb","type":"message","text":"makes it easier to focus on the matrices that actually hold data","user":"UH24GRBLL","ts":"1617983597.173300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VOB2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"makes it easier to focus on the matrices that actually hold data"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"2364ecde-6425-41e5-809a-af5f9eb8c3ac","type":"message","text":"Somewhat surprisingly the more Julian version of that is faster, is this just my computer?\n```julia&gt; max1(N) = [max(i,j) for i=1:N, j=1:N];\n\njulia&gt; max3(N) = max.(1:N, transpose(1:N));\n\njulia&gt; @btime max1(100);\n  3.448 μs (2 allocations: 78.20 KiB)\n\njulia&gt; @btime max3(100); # fixed!\n  2.069 μs (2 allocations: 78.20 KiB)```","user":"UD0NS8PDF","ts":"1617983597.173500","team":"T68168MUP","edited":{"user":"UD0NS8PDF","ts":"1617983653.000000"},"blocks":[{"type":"rich_text","block_id":"U4z","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Somewhat surprisingly the more Julian version of that is faster, is this just my computer?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> max1(N) = [max(i,j) for i=1:N, j=1:N];\n\njulia> max3(N) = max.(1:N, transpose(1:N));\n\njulia> @btime max1(100);\n  3.448 μs (2 allocations: 78.20 KiB)\n\njulia> @btime max3(100); # fixed!\n  2.069 μs (2 allocations: 78.20 KiB)"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"727b0ee2-45a4-4959-aadf-48df592ca82b","type":"message","text":"what's max2?","user":"UH24GRBLL","ts":"1617983633.173700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"aQrV=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"what's max2?"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"6119283a-aa72-46c5-924b-3160914a60df","type":"message","text":"probably constant prop","user":"UH24GRBLL","ts":"1617983662.174000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"SNHxD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"probably constant prop"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"6cef2654-e834-4f64-b8db-c57d47738c20","type":"message","text":"also, there's no array manifested for the range","user":"UH24GRBLL","ts":"1617983677.174200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"44tLX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"also, there's no array manifested for the range"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"fd3355b0-e945-482c-aa2e-304c83b9b81c","type":"message","text":"Right it’s nowhere near as crazy as the matlab one. But it does make one dense array.","user":"UD0NS8PDF","ts":"1617983743.174400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"WduP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Right it’s nowhere near as crazy as the matlab one. But it does make one dense array."}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"5e80fec3-fed9-48ef-8725-4c560a6984ec","type":"message","text":"I think comprehensions generally are not super performant","user":"UMDEUKM29","ts":"1617983865.174800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"uIr","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think comprehensions generally are not super performant"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"}]