[{"client_msg_id":"97903825-ad1c-445c-8aa6-20f2f4d7b852","type":"message","text":"Hey I have two matrices of dimensions `D, M` , where `M`  is relatively large (100-1000) and `D`  as large as possible. I want to calculate all the inner products of the columns, i.e.\n`res[i,j]=dot(A[:, i], B[:, j])` . These are the two approaches I have taken\n```using BenchmarkTools\n\nfunction pairwise_inner_products1!(res, A, B)\n    D, M = size(A)\n    Temp = similar(A)\n    for i=1:M\n        Temp .= A .* B\n        res[:, i] .= sum(Temp, dims=1)[:]\n    end\n    res\nend\n\nfunction pairwise_inner_products2!(res, A, B)\n    D, M = size(A)\n    for j=1:M\n        for i=1:M\n            for k=1:D\n                @inbounds res[i, j] += A[k, i] * B[k, j]\n            end\n        end\n    end\nend\n\nD = 500\nM = 300\n\nbench1 = @benchmark pairwise_inner_products1!(res, A, B) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    B = rand(D, M);\n)\n\nbench2 = @benchmark pairwise_inner_products2!(res, A, B) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    B = rand(D, M);\n)```\n","user":"U7PD3M3L5","ts":"1617980182.157300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/m4X","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hey I have two matrices of dimensions "},{"type":"text","text":"D, M","style":{"code":true}},{"type":"text","text":" , where "},{"type":"text","text":"M","style":{"code":true}},{"type":"text","text":"  is relatively large (100-1000) and "},{"type":"text","text":"D","style":{"code":true}},{"type":"text","text":"  as large as possible. I want to calculate all the inner products of the columns, i.e.\n"},{"type":"text","text":"res[i,j]=dot(A[:, i], B[:, j])","style":{"code":true}},{"type":"text","text":" . These are the two approaches I have taken\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using BenchmarkTools\n\nfunction pairwise_inner_products1!(res, A, B)\n    D, M = size(A)\n    Temp = similar(A)\n    for i=1:M\n        Temp .= A .* B\n        res[:, i] .= sum(Temp, dims=1)[:]\n    end\n    res\nend\n\nfunction pairwise_inner_products2!(res, A, B)\n    D, M = size(A)\n    for j=1:M\n        for i=1:M\n            for k=1:D\n                @inbounds res[i, j] += A[k, i] * B[k, j]\n            end\n        end\n    end\nend\n\nD = 500\nM = 300\n\nbench1 = @benchmark pairwise_inner_products1!(res, A, B) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    B = rand(D, M);\n)\n\nbench2 = @benchmark pairwise_inner_products2!(res, A, B) setup=(\n    res = rand(M, M);\n    A = rand(D, M);\n    B = rand(D, M);\n)"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1617980182.157300","reply_count":14,"reply_users_count":4,"latest_reply":"1617981530.163900","reply_users":["UH24GRBLL","U7PD3M3L5","UMDEUKM29","UD0NS8PDF"],"is_locked":false,"subscribed":false},{"client_msg_id":"f80b455d-5ac8-4513-ba6d-83e799828f2d","type":"message","text":"`sum(Temp, dims=1)[:]` allocates twice","user":"UH24GRBLL","ts":"1617980394.157900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"86P","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"sum(Temp, dims=1)[:]","style":{"code":true}},{"type":"text","text":" allocates twice"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"cae2ec49-f560-4f03-b7d9-e31a9d5f18e6","type":"message","text":"check `?sum!`","user":"UH24GRBLL","ts":"1617980439.158100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/FPbL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"check "},{"type":"text","text":"?sum!","style":{"code":true}}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"ce1e1e2a-a7c8-4a43-bca0-f7dc97b7c03f","type":"message","text":"Ah yeah right, `sum!(res[:, i]', Temp)` gets the allocations down from `602`  to `301`  in the first benchmark, and gives another `1ms`  in the mean, so `16ms`  now","user":"U7PD3M3L5","ts":"1617980633.158300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7MfAG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah yeah right, "},{"type":"text","text":"sum!(res[:, i]', Temp)","style":{"code":true}},{"type":"text","text":" gets the allocations down from "},{"type":"text","text":"602","style":{"code":true}},{"type":"text","text":"  to "},{"type":"text","text":"301","style":{"code":true}},{"type":"text","text":"  in the first benchmark, and gives another "},{"type":"text","text":"1ms","style":{"code":true}},{"type":"text","text":"  in the mean, so "},{"type":"text","text":"16ms","style":{"code":true}},{"type":"text","text":"  now"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"78dc786f-c843-4ff1-94de-de6fbd8af5aa","type":"message","text":"um, `D'*M`?","user":"UMDEUKM29","ts":"1617980714.159000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ymyge","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"um, "},{"type":"text","text":"D'*M","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"9bcae20e-48db-42b5-a679-d3f3285a9fe8","type":"message","text":"Also, `pairwise_inner_products1!` gives different answers to 2, and to `A'*B`","user":"UD0NS8PDF","ts":"1617980869.159200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/h0X","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Also, "},{"type":"text","text":"pairwise_inner_products1!","style":{"code":true}},{"type":"text","text":" gives different answers to 2, and to "},{"type":"text","text":"A'*B","style":{"code":true}}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"4a4eef89-54a4-4c9f-99e9-990ce0c7ee30","type":"message","text":"use a view for the `res[:,i]` part, as that again allocates because of the slice","user":"UH24GRBLL","ts":"1617980912.159400","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1617980924.000000"},"blocks":[{"type":"rich_text","block_id":"vSAK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"use a view for the "},{"type":"text","text":"res[:,i]","style":{"code":true}},{"type":"text","text":" part, as that again allocates because of the slice"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"0ab2c065-031e-4496-a625-f5830a4925c2","type":"message","text":"slices on the right hand side of an `=` allocate a copy","user":"UH24GRBLL","ts":"1617980955.160500","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1617980959.000000"},"blocks":[{"type":"rich_text","block_id":"hL9o","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"slices on the right hand side of an "},{"type":"text","text":"=","style":{"code":true}},{"type":"text","text":" allocate a copy"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"1ceda753-b6b4-48c5-9c0d-5a0da645bdbe","type":"message","text":"pretty sure you'll get at least 10x improvement with `D'*M`","user":"UMDEUKM29","ts":"1617981022.161400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6Q4c","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"pretty sure you'll get at least 10x improvement with "},{"type":"text","text":"D'*M","style":{"code":true}}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"f79d456f-7bd6-482d-93df-4fcc05a87ea5","type":"message","text":"```julia&gt; @btime pairwise_inner_products1!($res, $A, $B);\n  18.177 ms (602 allocations: 2.61 MiB)\n\njulia&gt; @btime pairwise_inner_products2!($res, $A, $B);\n  39.456 ms (0 allocations: 0 bytes)\n\njulia&gt; @btime mul!($res, $A', $B);\n  917.916 μs (0 allocations: 0 bytes)```","user":"UD0NS8PDF","ts":"1617981065.161800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"f2gjY","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @btime pairwise_inner_products1!($res, $A, $B);\n  18.177 ms (602 allocations: 2.61 MiB)\n\njulia> @btime pairwise_inner_products2!($res, $A, $B);\n  39.456 ms (0 allocations: 0 bytes)\n\njulia> @btime mul!($res, $A', $B);\n  917.916 μs (0 allocations: 0 bytes)"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"f56172d5-d5c6-4c6e-846a-e0dd3b0722bb","type":"message","text":"a lol yeah of course it is `A' * B`  in this case. I simplified my problem to post it here and simplified it to much it seems","user":"U7PD3M3L5","ts":"1617981242.162600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vkxL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"a lol yeah of course it is "},{"type":"text","text":"A' * B","style":{"code":true}},{"type":"text","text":"  in this case. I simplified my problem to post it here and simplified it to much it seems"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"ee5d0e30-d65d-4662-8764-951d93c6a722","type":"message","text":"What I actually want to calculate is\n```res[i, j] = (A[:, i]-A[:,j])' * Sigma * (A[:, i] - A[:, j])```","user":"U7PD3M3L5","ts":"1617981366.162800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ql7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What I actually want to calculate is\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"res[i, j] = (A[:, i]-A[:,j])' * Sigma * (A[:, i] - A[:, j])"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"a54ead50-d6d2-4a49-bcbb-305a0fa43871","type":"message","text":"I'll try to write a sample function for that. Thanks","user":"U7PD3M3L5","ts":"1617981421.163000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=8Gh7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'll try to write a sample function for that. Thanks"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"90d65d2d-8d01-4a9f-b59a-eca7af5e6689","type":"message","text":"all those slices allocate. use `@views`","user":"UH24GRBLL","ts":"1617981485.163700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ddd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"all those slices allocate. use "},{"type":"text","text":"@views","style":{"code":true}}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"},{"client_msg_id":"8adddbf2-b741-4db3-9c46-3c283afc6529","type":"message","text":"moreover, you can reuse the result of `A[:, i] - A[:, j]`, since `'` is a lazy transpose","user":"UH24GRBLL","ts":"1617981530.163900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Fo5","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"moreover, you can reuse the result of "},{"type":"text","text":"A[:, i] - A[:, j]","style":{"code":true}},{"type":"text","text":", since "},{"type":"text","text":"'","style":{"code":true}},{"type":"text","text":" is a lazy transpose"}]}]}],"thread_ts":"1617980182.157300","parent_user_id":"U7PD3M3L5"}]