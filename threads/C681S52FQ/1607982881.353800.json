[{"client_msg_id":"93950008-5b30-441c-aef2-bd62e193694a","type":"message","text":"Do we have something like Optim but supporting `CuArray`s? I have a problem where L-BFGS outperforms Flux optimizers, but I would like to move the model computation to the GPU. Transferring the data from GPU to CPU at every iteration seems expensive, but I couldn't find a GPU friendly quasi newton solver.","user":"U6BJ9E351","ts":"1607982881.353800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ypZBE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Do we have something like Optim but supporting "},{"type":"text","text":"CuArray","style":{"code":true}},{"type":"text","text":"s? I have a problem where L-BFGS outperforms Flux optimizers, but I would like to move the model computation to the GPU. Transferring the data from GPU to CPU at every iteration seems expensive, but I couldn't find a GPU friendly quasi newton solver."}]}]}],"thread_ts":"1607982881.353800","reply_count":30,"reply_users_count":3,"latest_reply":"1608044342.360600","reply_users":["U6CJRSR63","U6BJ9E351","U67G3QRJM"],"subscribed":false,"reactions":[{"name":"+1","users":["UN2U72Q3F"],"count":1}]},{"client_msg_id":"16e229a6-b7cd-4e5a-87a3-e7633eec524b","type":"message","text":"hm","user":"U6CJRSR63","ts":"1608029165.354400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fA/i","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hm"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"45be6b99-2a9e-4095-a8df-5bae26aa8c41","type":"message","text":"can you give me a small example?","user":"U6CJRSR63","ts":"1608029247.354600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oPF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"can you give me a small example?"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"ab0d2e49-887b-47c5-9767-3aa648acfa49","type":"message","text":"Here's a MWE:\n```julia&gt; using Optim, CUDA\n\njulia&gt; init = CUDA.rand(10, 10);\n\njulia&gt; function fg!(_, G, w)\n           res = sum(abs2, w)\n           if !isnothing(G)\n               @. G = 2w\n           end\n           return res\n       end\nfg! (generic function with 1 method)\n\njulia&gt; optimize(Optim.only_fg!(fg!), init)```","user":"U6BJ9E351","ts":"1608032204.354800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kTtP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Here's a MWE:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> using Optim, CUDA\n\njulia> init = CUDA.rand(10, 10);\n\njulia> function fg!(_, G, w)\n           res = sum(abs2, w)\n           if !isnothing(G)\n               @. G = 2w\n           end\n           return res\n       end\nfg! (generic function with 1 method)\n\njulia> optimize(Optim.only_fg!(fg!), init)"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"10917ec8-79e5-4119-88fb-d1e8bdd0f8f5","type":"message","text":"I was a bit imprecise, in that this works, but with the scalar operation warning, which means it's very slow:\n```┌ Warning: Performing scalar operations on GPU arrays: This is very slow, consider disallowing these operations with `allowscalar(false)`\n└ @ GPUArrays ~/.julia/packages/GPUArrays/jhRU7/src/host/indexing.jl:43```","user":"U6BJ9E351","ts":"1608032256.355000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PWq4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I was a bit imprecise, in that this works, but with the scalar operation warning, which means it's very slow:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"┌ Warning: Performing scalar operations on GPU arrays: This is very slow, consider disallowing these operations with `allowscalar(false)`\n└ @ GPUArrays ~/.julia/packages/GPUArrays/jhRU7/src/host/indexing.jl:43"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"898802e1-0f3a-4d5c-af83-1d97e3fc1402","type":"message","text":"robust way to test this is:\n```julia&gt; CUDA.allowscalar(false)\n\njulia&gt; optimize(Optim.only_fg!(fg!), init)\nERROR: scalar getindex is disallowed```","user":"U6BJ9E351","ts":"1608032292.355200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"H7N24","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"robust way to test this is:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> CUDA.allowscalar(false)\n\njulia> optimize(Optim.only_fg!(fg!), init)\nERROR: scalar getindex is disallowed"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"cada1390-dd14-4f51-aaa3-543e5e055e45","type":"message","text":"okay","user":"U6CJRSR63","ts":"1608032414.355400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yf4x","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"okay"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"8c769645-3663-4c4b-8372-41093bf0dad3","type":"message","text":"I confess I'm a bit confused though, because the LBFGS code looks CUDA friendly, using broadcast and matmul, but it looks like taking the norm from linear algebra is not supported","user":"U6BJ9E351","ts":"1608032516.355600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=nv54","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I confess I'm a bit confused though, because the LBFGS code looks CUDA friendly, using broadcast and matmul, but it looks like taking the norm from linear algebra is not supported"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"7c8f5ddc-c069-4a4e-b4c5-cd65dca2bc01","type":"message","text":"if it is easy to fix, would you be open to a PR to Optim to adjust the bits that do not work well with GPU arrays? Hopefully, it may be as simple as changing `norm2` with `sum(abs2, _)`","user":"U6BJ9E351","ts":"1608032626.355800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xPeSg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if it is easy to fix, would you be open to a PR to Optim to adjust the bits that do not work well with GPU arrays? Hopefully, it may be as simple as changing "},{"type":"text","text":"norm2","style":{"code":true}},{"type":"text","text":" with "},{"type":"text","text":"sum(abs2, _)","style":{"code":true}}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"e92a5df6-4281-4494-a7c2-543cb1fb4191","type":"message","text":"(and switching some for loops to broadcasting)","user":"U6BJ9E351","ts":"1608032668.356000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QtVZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"(and switching some for loops to broadcasting)"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"399e8af2-e8bd-4734-9759-7a04a0043928","type":"message","text":"I think that's close to what would be required for LBFGS but maybe not for others","user":"U6CJRSR63","ts":"1608033823.356200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"v1+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think that's close to what would be required for LBFGS but maybe not for others"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"352ee1c1-d49c-419f-96ac-ce2805498453","type":"message","text":"I made a few changes to NLsolve at some point to make it work, but you had to turn off some options because there were just some not very gpu-friendly things in there","user":"U6CJRSR63","ts":"1608033860.356400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DOjhK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I made a few changes to NLsolve at some point to make it work, but you had to turn off some options because there were just some not very gpu-friendly things in there"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"ae4dc0f5-7529-4fcd-bf97-40148ee955b8","type":"message","text":"Can you try to install NLSolvers and try\n```\nusing NLSolvers, CUDA\ninit = CUDA.rand(3);\nfunction f(x)\n    res = sum(abs2, x)\nend\nfunction g!(G, x)\n    if !isnothing(G)\n        @. G = 2x\n    end\n    G\nend\nfunction fg!(G, x)\n    g!(G, x)\n    return f(x), G\nend\nscalarobj = ScalarObjective(f=f,\n                            g=g!,\n                            fg=fg!)\noptprob = OptimizationProblem(scalarobj; inplace=true) # scalar input, so not inplace\nsolve(optprob, [1.0,2.0,3.0], LineSearch(LBFGS()), OptimizationOptions())```\n?","user":"U6CJRSR63","ts":"1608034002.356600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0FDTJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Can you try to install NLSolvers and try\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"\nusing NLSolvers, CUDA\ninit = CUDA.rand(3);\nfunction f(x)\n    res = sum(abs2, x)\nend\nfunction g!(G, x)\n    if !isnothing(G)\n        @. G = 2x\n    end\n    G\nend\nfunction fg!(G, x)\n    g!(G, x)\n    return f(x), G\nend\nscalarobj = ScalarObjective(f=f,\n                            g=g!,\n                            fg=fg!)\noptprob = OptimizationProblem(scalarobj; inplace=true) # scalar input, so not inplace\nsolve(optprob, [1.0,2.0,3.0], LineSearch(LBFGS()), OptimizationOptions())"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"?"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"d763d63a-51e0-41ce-b459-9336cc9aff7f","type":"message","text":"with allowscalar false","user":"U6CJRSR63","ts":"1608034012.356800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TAQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"with allowscalar false"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"5549d5f4-e9b0-455f-85d1-05a4392182c8","type":"message","text":"I'm having some gpu-issues here","user":"U6CJRSR63","ts":"1608034016.357000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9ab","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm having some gpu-issues here"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"ae46a3d9-c459-406d-b860-4a24775c184d","type":"message","text":"at least LBFGS was pretty easy to fix, just `norm(v, Inf) ---&gt; maximum(abs, v)` and `maxdiff(x, y) = mapreduce((a, b) -&gt; abs(a - b), max, x, y)`, I'll make a PR in a sec","user":"U6BJ9E351","ts":"1608034243.357200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"a3MLH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"at least LBFGS was pretty easy to fix, just "},{"type":"text","text":"norm(v, Inf) ---> maximum(abs, v)","style":{"code":true}},{"type":"text","text":" and "},{"type":"text","text":"maxdiff(x, y) = mapreduce((a, b) -> abs(a - b), max, x, y)","style":{"code":true}},{"type":"text","text":", I'll make a PR in a sec"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"b5cc907e-c742-401f-b312-f28bcb35009e","type":"message","text":":+1:","user":"U6CJRSR63","ts":"1608034260.357500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nvki","elements":[{"type":"rich_text_section","elements":[{"type":"emoji","name":"+1"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"09913d30-28bc-4259-ab8b-e8683fa20dcf","type":"message","text":"hah, NLSolvers works already, what's the difference between it and Optim?","user":"U6BJ9E351","ts":"1608034394.357700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"IjE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hah, NLSolvers works already, what's the difference between it and Optim?"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"22337107-c562-43c0-98cd-70a227872933","type":"message","text":"(tbh, I'm also unsure how LBFGS worked, it did seem to have some loops, but maybe it was internal cpu arrays that optim manages)","user":"U6BJ9E351","ts":"1608034422.357900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"HA4R7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"(tbh, I'm also unsure how LBFGS worked, it did seem to have some loops, but maybe it was internal cpu arrays that optim manages)"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"1ac3fabc-ea59-4a15-9a90-461302267b35","type":"message","text":"(thanks for the snippet btw, it's very useful until the gpu fix gets merged and released in optim!)","user":"U6BJ9E351","ts":"1608034850.358100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"E2d+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"(thanks for the snippet btw, it's very useful until the gpu fix gets merged and released in optim!)"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"198dad0e-8b09-45b5-9dca-754b06578635","type":"message","text":"So NLSolvers.jl worked?","user":"U6CJRSR63","ts":"1608037516.358400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"H7Y+m","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So NLSolvers.jl worked?"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"e5babec1-2116-4b05-8a8d-9807c69d605b","type":"message","text":"Good to know. I should add a test. Currently I'm having issues using CUDA/CuArrays though.","user":"U6CJRSR63","ts":"1608037571.358600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"49B7t","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Good to know. I should add a test. Currently I'm having issues using CUDA/CuArrays though."}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"229a826d-d944-4cc3-8b1b-ba0dc5f129de","type":"message","text":"NLSolvers.jl is the \"new code\" for Optim.jl. It also replaces NLsolve.jl, LineSearches.jl, NLSolversBase.jl and the optimization part of LsqFit.jl","user":"U6CJRSR63","ts":"1608037603.358800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PUE/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"NLSolvers.jl is the \"new code\" for Optim.jl. It also replaces NLsolve.jl, LineSearches.jl, NLSolversBase.jl and the optimization part of LsqFit.jl"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351","reactions":[{"name":"+1","users":["U67G3QRJM"],"count":1}]},{"client_msg_id":"b49aa245-1233-484f-8c78-7c498867adc5","type":"message","text":"Yes, NLSolvers worked, both L-BFGS and conjugate gradient! I'm not 100% sure how to test this on CI, but I think GPUArrays had a type to test for scalar getindex without having a GPU. Otherwise, maybe people over at <#C689Y34LE|gpu> know how to set things up for testing","user":"U6BJ9E351","ts":"1608040301.359100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Llq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes, NLSolvers worked, both L-BFGS and conjugate gradient! I'm not 100% sure how to test this on CI, but I think GPUArrays had a type to test for scalar getindex without having a GPU. Otherwise, maybe people over at "},{"type":"channel","channel_id":"C689Y34LE"},{"type":"text","text":" know how to set things up for testing"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"1edd1022-8ba9-409e-9830-48cad1299398","type":"message","text":"Maybe call it NonlinearSolvers.jl?","user":"U67G3QRJM","ts":"1608040352.359400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"EPp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Maybe call it NonlinearSolvers.jl?"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"d478290c-a5d9-420c-9b08-f7da7fc9b68b","type":"message","text":"Taken by SciML :slightly_smiling_face:","user":"U6CJRSR63","ts":"1608044088.359600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"w43b2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Taken by SciML "},{"type":"emoji","name":"slightly_smiling_face"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"2a0ce356-ea11-44e2-8be5-5ba90bffadc9","type":"message","text":"oh, no","user":"U6CJRSR63","ts":"1608044157.359800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+A6eb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh, no"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"a5de863a-a097-4f9b-84c4-1f9cf13e08c3","type":"message","text":"Theirs is NonlinearSolve","user":"U6CJRSR63","ts":"1608044162.360000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6whJe","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Theirs is NonlinearSolve"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"5e45f18e-d35f-44c2-97c7-136a41d06e63","type":"message","text":"CliMA seems like they have the same in a package, not sure if registered","user":"U6CJRSR63","ts":"1608044176.360200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rIa","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"CliMA seems like they have the same in a package, not sure if registered"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"30b2a238-3e6a-4dab-8576-237e9c71dd3d","type":"message","text":"Seems like it might be up for grabs","user":"U6CJRSR63","ts":"1608044251.360400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oDw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Seems like it might be up for grabs"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351"},{"client_msg_id":"c4e51fa2-712d-4c74-b450-a57c96461256","type":"message","text":"but most users are going to use Optim.jl","user":"U6CJRSR63","ts":"1608044342.360600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DPm/b","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but most users are going to use Optim.jl"}]}]}],"thread_ts":"1607982881.353800","parent_user_id":"U6BJ9E351","reactions":[{"name":"+1","users":["U67G3QRJM"],"count":1}]}]