[{"client_msg_id":"5c9e79a5-c951-44de-834b-c3bf3c3f071f","type":"message","text":"I've got some multithreaded code that continuously allocates and frees large matrices. The tasks never terminate, they just write their outputs to a channel that is consumed.\nIt appears that garbage collection never runs, and the process keeps on allocating until it gets OOM killed. If I stick a GC.gc() in the main loop, memory usage stays bounded.\nI'm going to try and produce an MWE, but it might be a bit tricky.\nNonetheless, has anyone seen behaviour like this? It is driving me a bit nuts.","user":"UCNPT22MQ","ts":"1610061964.283000","team":"T68168MUP","edited":{"user":"UCNPT22MQ","ts":"1610061977.000000"},"blocks":[{"type":"rich_text","block_id":"11n","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I've got some multithreaded code that continuously allocates and frees large matrices. The tasks never terminate, they just write their outputs to a channel that is consumed.\nIt appears that garbage collection never runs, and the process keeps on allocating until it gets OOM killed. If I stick a GC.gc() in the main loop, memory usage stays bounded.\nI'm going to try and produce an MWE, but it might be a bit tricky.\nNonetheless, has anyone seen behaviour like this? It is driving me a bit nuts."}]}]}],"thread_ts":"1610061964.283000","reply_count":4,"reply_users_count":3,"latest_reply":"1610075742.287000","reply_users":["U680THK2S","UCNPT22MQ","U8T0YV7QC"],"subscribed":false},{"client_msg_id":"bcd85547-0fb8-47f2-9eb7-039b92169f46","type":"message","text":"I believe I've seen that before but wasn't able to come up with an MWE for it, nor was I able to solve it without inserting explicit GC runs like you have","user":"U680THK2S","ts":"1610062190.283300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"27f9S","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I believe I've seen that before but wasn't able to come up with an MWE for it, nor was I able to solve it without inserting explicit GC runs like you have"}]}]}],"thread_ts":"1610061964.283000","parent_user_id":"UCNPT22MQ"},{"client_msg_id":"0ae51e68-c011-4ae0-abfe-2e987bda35aa","type":"message","text":"Thanks, that's good/bad to hear. Explicit GC seems to be required on every loop for the leak to stop, but that absolutely kills performance.","user":"UCNPT22MQ","ts":"1610062335.283500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Wn2Fi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks, that's good/bad to hear. Explicit GC seems to be required on every loop for the leak to stop, but that absolutely kills performance."}]}]}],"thread_ts":"1610061964.283000","parent_user_id":"UCNPT22MQ","reactions":[{"name":"heavy_check_mark","users":["U680THK2S"],"count":1}]},{"client_msg_id":"9EC01BF8-650B-4E49-8681-E4BBEACE6B78","type":"message","text":"I had a slightly different experience where GC did run automatically but it consumed majority of the time (like 80-90%). As far as I know, the current multithreading implementation does not work well when you allocate a lot. ","user":"U8T0YV7QC","ts":"1610070651.286800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7s9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I had a slightly different experience where GC did run automatically but it consumed majority of the time (like 80-90%). As far as I know, the current multithreading implementation does not work well when you allocate a lot. "}]}]}],"thread_ts":"1610061964.283000","parent_user_id":"UCNPT22MQ"},{"client_msg_id":"9751e376-d2ae-4035-a4e0-80285177dbe3","type":"message","text":"At what points is GC usually allowed to happen? Is there anything that would prevent those points from occuring? Any way I can encourage them, without necessarily forcing them?","user":"UCNPT22MQ","ts":"1610075742.287000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"liG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"At what points is GC usually allowed to happen? Is there anything that would prevent those points from occuring? Any way I can encourage them, without necessarily forcing them?"}]}]}],"thread_ts":"1610061964.283000","parent_user_id":"UCNPT22MQ"}]