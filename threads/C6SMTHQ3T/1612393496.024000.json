[{"client_msg_id":"FCA87329-566F-40A1-9336-DB65D80F442E","type":"message","text":"How does Julia’s profiler interact with having multiple threads? I assume the profiler is just showing time for the main thread, including time the main thread spends blocked? In my flame graph I see something separate from my computation called task_done_hook taking up a significant amount of time. Clearly it has something to do with the threaded task system, but what is it exactly?","user":"ULD19UCPK","ts":"1612393496.024000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Yi=Y","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"How does Julia’s profiler interact with having multiple threads? I assume the profiler is just showing time for the main thread, including time the main thread spends blocked? In my flame graph I see something separate from my computation called task_done_hook taking up a significant amount of time. Clearly it has something to do with the threaded task system, but what is it exactly?"}]}]}],"thread_ts":"1612393496.024000","reply_count":5,"reply_users_count":2,"latest_reply":"1612466226.039100","reply_users":["U6A0PD8CR","ULD19UCPK"],"subscribed":false},{"client_msg_id":"b98c000e-5138-46e6-ae31-15a5408a696a","type":"message","text":"My understanding of this is: When there is work available for non-main threads to run, they spin-sleep-spin waiting for work to become runnable, which manifests as calls to/execution within `task_done_hook`. As Valentin said, the profiler samples all threads, but it doesn't distinguish what ran where.","user":"U6A0PD8CR","ts":"1612445571.028100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hm1EC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"My understanding of this is: When there is work available for non-main threads to run, they spin-sleep-spin waiting for work to become runnable, which manifests as calls to/execution within "},{"type":"text","text":"task_done_hook","style":{"code":true}},{"type":"text","text":". As Valentin said, the profiler samples all threads, but it doesn't distinguish what ran where."}]}]}],"thread_ts":"1612393496.024000","parent_user_id":"ULD19UCPK"},{"type":"message","subtype":"thread_broadcast","text":"That’s kind of what I thought. I was profiling code using the old thread macro, Tullio, and ThreadsX and seeing a lot of time spent waiting in task_done_hook. The code using Tullio, for example, has 70% of traced samples in that function. I assume that means Tullio is splitting work up too finely between tasks. ","user":"ULD19UCPK","ts":"1612465816.033600","thread_ts":"1612393496.024000","root":{"client_msg_id":"FCA87329-566F-40A1-9336-DB65D80F442E","type":"message","text":"How does Julia’s profiler interact with having multiple threads? I assume the profiler is just showing time for the main thread, including time the main thread spends blocked? In my flame graph I see something separate from my computation called task_done_hook taking up a significant amount of time. Clearly it has something to do with the threaded task system, but what is it exactly?","user":"ULD19UCPK","ts":"1612393496.024000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Yi=Y","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"How does Julia’s profiler interact with having multiple threads? I assume the profiler is just showing time for the main thread, including time the main thread spends blocked? In my flame graph I see something separate from my computation called task_done_hook taking up a significant amount of time. Clearly it has something to do with the threaded task system, but what is it exactly?"}]}]}],"thread_ts":"1612393496.024000","reply_count":5,"reply_users_count":2,"latest_reply":"1612466226.039100","reply_users":["U6A0PD8CR","ULD19UCPK"],"subscribed":false},"blocks":[{"type":"rich_text","block_id":"kIC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That’s kind of what I thought. I was profiling code using the old thread macro, Tullio, and ThreadsX and seeing a lot of time spent waiting in task_done_hook. The code using Tullio, for example, has 70% of traced samples in that function. I assume that means Tullio is splitting work up too finely between tasks. "}]}]}],"client_msg_id":"23FC90B4-8623-47EF-80F3-6D39AD7897D1"},{"type":"message","subtype":"thread_broadcast","text":"Does the main thread sit waiting or does it also do work? In my (not at all comparable to Tullio) code using the threads macro I see roughly ~20-25% of my time in task_done_hook on my 4 core machine, which  would make sense if the main thread was waiting for the threaded code to end. ","user":"ULD19UCPK","ts":"1612466021.036700","thread_ts":"1612393496.024000","root":{"client_msg_id":"FCA87329-566F-40A1-9336-DB65D80F442E","type":"message","text":"How does Julia’s profiler interact with having multiple threads? I assume the profiler is just showing time for the main thread, including time the main thread spends blocked? In my flame graph I see something separate from my computation called task_done_hook taking up a significant amount of time. Clearly it has something to do with the threaded task system, but what is it exactly?","user":"ULD19UCPK","ts":"1612393496.024000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Yi=Y","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"How does Julia’s profiler interact with having multiple threads? I assume the profiler is just showing time for the main thread, including time the main thread spends blocked? In my flame graph I see something separate from my computation called task_done_hook taking up a significant amount of time. Clearly it has something to do with the threaded task system, but what is it exactly?"}]}]}],"thread_ts":"1612393496.024000","reply_count":5,"reply_users_count":2,"latest_reply":"1612466226.039100","reply_users":["U6A0PD8CR","ULD19UCPK"],"subscribed":false},"blocks":[{"type":"rich_text","block_id":"MYJBN","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Does the main thread sit waiting or does it also do work? In my (not at all comparable to Tullio) code using the threads macro I see roughly ~20-25% of my time in task_done_hook on my 4 core machine, which  would make sense if the main thread was waiting for the threaded code to end. "}]}]}],"client_msg_id":"F4D5E145-3F62-49AE-9575-3B28221BA6DE"},{"client_msg_id":"74bf939e-55da-4913-830f-eaf2bb4a520a","type":"message","text":"That's very possible","user":"U6A0PD8CR","ts":"1612466173.038500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Zxfl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That's very possible"}]}]}],"thread_ts":"1612393496.024000","parent_user_id":"ULD19UCPK"},{"client_msg_id":"DD27AC3F-1B82-4960-9644-A60808FC4948","type":"message","text":"Wait actually that’s not right. That profile has code intermingling Tullio, ThreadsX, and @threads. I’d still be interested to know if the main thread is doing work or not and how that would manifest in the profile. ","user":"ULD19UCPK","ts":"1612466226.039100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gRR","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Wait actually that’s not right. That profile has code intermingling Tullio, ThreadsX, and @threads. I’d still be interested to know if the main thread is doing work or not and how that would manifest in the profile. "}]}]}],"thread_ts":"1612393496.024000","parent_user_id":"ULD19UCPK"}]