[{"client_msg_id":"19cef7ec-aaf5-4d13-9515-ee8d89b8d38a","type":"message","text":"This is more of a curiosity, but I was wondering, how can Tullio.jl handle raise conditions when the LHS uses a nontrivial function of the indices? For example, I've noticed that one can do things like\n```@tullio C[i Ã· 2, k] += A[i, j] * B[j, k]```\nDoes Tullio have some smart way to multithread this, or does it just fall back to a sequential approach?","user":"U6BJ9E351","ts":"1613657824.027300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YOK1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This is more of a curiosity, but I was wondering, how can Tullio.jl handle raise conditions when the LHS uses a nontrivial function of the indices? For example, I've noticed that one can do things like\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"@tullio C[i Ã· 2, k] += A[i, j] * B[j, k]"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Does Tullio have some smart way to multithread this, or does it just fall back to a sequential approach?"}]}]}],"thread_ts":"1613657824.027300","reply_count":3,"reply_users_count":2,"latest_reply":"1613660141.027800","reply_users":["U6BJ9E351","UD0NS8PDF"],"subscribed":false},{"client_msg_id":"ac16844e-7ce7-47be-b20f-3e8819d1a728","type":"message","text":"I guess \"where\" the nontrivial expression is doesn't really matter, because even if the nontrivial expression is only on the RHS, then computing the `rrule` for differentiation will generate a call with the nontrivial expression on the LHS","user":"U6BJ9E351","ts":"1613658104.027400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Bnv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I guess \"where\" the nontrivial expression is doesn't really matter, because even if the nontrivial expression is only on the RHS, then computing the "},{"type":"text","text":"rrule","style":{"code":true}},{"type":"text","text":" for differentiation will generate a call with the nontrivial expression on the LHS"}]}]}],"thread_ts":"1613657824.027300","parent_user_id":"U6BJ9E351"},{"client_msg_id":"9bd26f70-4564-4bd6-87e0-d39ae29088a6","type":"message","text":"Oh I never thought to try this. It looks like it may not be safe, in fact. My check, perhaps not readableâ€¦\n```julia&gt; @macroexpand @tullio C[i Ã· 2, k] += A[i, j] * B[j, k] verbose=2 grad=false;\nâ”‚    quote\nâ”‚        local @inline(function ğ’œğ’¸ğ“‰!(::Type, â„›::AbstractArray{ğ’¯}, A, B, ğ’¶ğ“k, ğ’¶ğ“i, ğ’¶ğ“j, :recycle: = nothing, :skull: = true) where ğ’¯\nâ”‚                    @inbounds @fastmath(begin\nâ”‚                                for i = ğ’¶ğ“i\nâ”‚                                    for k = ğ’¶ğ“k\nâ”‚                                        ğ’œğ’¸ğ’¸ = â„›[i Ã· 2, k]\nâ”‚                                        for j = ğ’¶ğ“j\nâ”‚                                            ğ’œğ’¸ğ’¸ = ğ’œğ’¸ğ’¸ + A[i, j] * B[j, k]\nâ”‚                                        end\nâ”‚                                        â„›[i Ã· 2, k] = ğ’œğ’¸ğ’¸\nâ”‚                                    end\nâ”‚                                end\nâ”‚                            end)\nâ”‚                end)\nâ””    end\nâ”‚    quote\nâ”‚        local ğ’¶ğ“k = axes(C, 2)\nâ”‚        local ğ’¶ğ“j = axes(A, 2)\nâ”‚        local ğ’¶ğ“i = intersect(axes(C, 1) .* 2, axes(A, 1))\nâ”‚        begin\nâ”‚            (Tullio.threader)(ğ’œğ’¸ğ“‰!, (Tullio.storage_type)(C, A, B), C, tuple(A, B), tuple(ğ’¶ğ“k, ğ’¶ğ“i), tuple(ğ’¶ğ“j), +, 262144, true)\nâ”‚            C\nâ”‚        end\nâ””    end```\nThe NB part of this is that `threader(ğ’œğ’¸ğ“‰!, ..., C, (A,B), (ğ’¶ğ“k, ğ’¶ğ“i), (ğ’¶ğ“j,), +, ...)` groups `k` &amp; `i` as indices safe to thread over, and `j` not.","user":"UD0NS8PDF","ts":"1613660134.027600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0On2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Oh I never thought to try this. It looks like it may not be safe, in fact. My check, perhaps not readableâ€¦\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @macroexpand @tullio C[i Ã· 2, k] += A[i, j] * B[j, k] verbose=2 grad=false;\nâ”‚    quote\nâ”‚        local @inline(function ğ’œğ’¸ğ“‰!(::Type, â„›::AbstractArray{ğ’¯}, A, B, ğ’¶ğ“k, ğ’¶ğ“i, ğ’¶ğ“j, :recycle: = nothing, :skull: = true) where ğ’¯\nâ”‚                    @inbounds @fastmath(begin\nâ”‚                                for i = ğ’¶ğ“i\nâ”‚                                    for k = ğ’¶ğ“k\nâ”‚                                        ğ’œğ’¸ğ’¸ = â„›[i Ã· 2, k]\nâ”‚                                        for j = ğ’¶ğ“j\nâ”‚                                            ğ’œğ’¸ğ’¸ = ğ’œğ’¸ğ’¸ + A[i, j] * B[j, k]\nâ”‚                                        end\nâ”‚                                        â„›[i Ã· 2, k] = ğ’œğ’¸ğ’¸\nâ”‚                                    end\nâ”‚                                end\nâ”‚                            end)\nâ”‚                end)\nâ””    end\nâ”‚    quote\nâ”‚        local ğ’¶ğ“k = axes(C, 2)\nâ”‚        local ğ’¶ğ“j = axes(A, 2)\nâ”‚        local ğ’¶ğ“i = intersect(axes(C, 1) .* 2, axes(A, 1))\nâ”‚        begin\nâ”‚            (Tullio.threader)(ğ’œğ’¸ğ“‰!, (Tullio.storage_type)(C, A, B), C, tuple(A, B), tuple(ğ’¶ğ“k, ğ’¶ğ“i), tuple(ğ’¶ğ“j), +, 262144, true)\nâ”‚            C\nâ”‚        end\nâ””    end"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"The NB part of this is that "},{"type":"text","text":"threader(ğ’œğ’¸ğ“‰!, ..., C, (A,B), (ğ’¶ğ“k, ğ’¶ğ“i), (ğ’¶ğ“j,), +, ...)","style":{"code":true}},{"type":"text","text":" groups "},{"type":"text","text":"k","style":{"code":true}},{"type":"text","text":" & "},{"type":"text","text":"i","style":{"code":true}},{"type":"text","text":" as indices safe to thread over, and "},{"type":"text","text":"j","style":{"code":true}},{"type":"text","text":" not."}]}]}],"thread_ts":"1613657824.027300","parent_user_id":"U6BJ9E351"},{"client_msg_id":"d0570901-3cbb-4bc2-86c4-572dcbc1dc35","type":"message","text":"The goal is to be safe by default, though. For example `@tullio C[I[i], k] += A[i, j] * B[j, k];` sets flag `unsafeleft = [:i]` and as a result should only thread over `k`.","user":"UD0NS8PDF","ts":"1613660141.027800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"X7Fbz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The goal is to be safe by default, though. For example "},{"type":"text","text":"@tullio C[I[i], k] += A[i, j] * B[j, k];","style":{"code":true}},{"type":"text","text":" sets flag "},{"type":"text","text":"unsafeleft = [:i]","style":{"code":true}},{"type":"text","text":" and as a result should only thread over "},{"type":"text","text":"k","style":{"code":true}},{"type":"text","text":"."}]}]}],"thread_ts":"1613657824.027300","parent_user_id":"U6BJ9E351"}]