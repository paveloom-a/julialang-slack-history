[{"client_msg_id":"1ad09c58-5629-481f-b5a6-81bd238d18e8","type":"message","text":"The Quake 3 inverse square root performance hack works well in Julia :slightly_smiling_face:\nSeems not to be so useful on modern CPUs\n```julia&gt; function q3invsqrt(num::Float32)\n           i = 0x5f375a86 - (reinterpret(UInt32, num) &gt;&gt; 1)\n           y = reinterpret(Float32, i)\n           y * (1.5f0 - num * 0.5f0 * y * y)\n       end\nq3invsqrt (generic function with 1 method)\n\njulia&gt; @btime q3invsqrt(16f0)\n  5.600 ns (0 allocations: 0 bytes)\n0.24957703f0\n\njulia&gt; @btime 1/sqrt(16f0)\n  1.200 ns (0 allocations: 0 bytes)\n0.25f0```","user":"U6C8RR26P","ts":"1612719233.274500","team":"T68168MUP","edited":{"user":"U6C8RR26P","ts":"1612723247.000000"},"blocks":[{"type":"rich_text","block_id":"dSl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The Quake 3 inverse square root performance hack works well in Julia "},{"type":"emoji","name":"slightly_smiling_face"},{"type":"text","text":"\nSeems not to be so useful on modern CPUs\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> function q3invsqrt(num::Float32)\n           i = 0x5f375a86 - (reinterpret(UInt32, num) >> 1)\n           y = reinterpret(Float32, i)\n           y * (1.5f0 - num * 0.5f0 * y * y)\n       end\nq3invsqrt (generic function with 1 method)\n\njulia> @btime q3invsqrt(16f0)\n  5.600 ns (0 allocations: 0 bytes)\n0.24957703f0\n\njulia> @btime 1/sqrt(16f0)\n  1.200 ns (0 allocations: 0 bytes)\n0.25f0"}]}]}],"thread_ts":"1612719233.274500","reply_count":21,"reply_users_count":5,"latest_reply":"1612723830.282400","reply_users":["U0179G7FG4F","U6C8RR26P","U6N6VQE30","UMDEUKM29","U8D9768Q6"],"subscribed":false,"reactions":[{"name":"+1","users":["U011V2YN59N","UH8C4BGSU"],"count":2},{"name":"fast_parrot","users":["U019K6Q9N15"],"count":1}]},{"client_msg_id":"15f87055-366a-44e0-8a29-6349b28f0b7b","type":"message","text":"I would just write it\n```function q3invsqrt(num::Float32)\n           x = num * 0.5f0\n           y = reinterpret(Float32, 0x5f375a86 - (reinterpret(UInt32,num) &gt;&gt; 1))\n           y * (1.5f0 - x * y * y)\n       end```","user":"U0179G7FG4F","ts":"1612719445.274800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nOJf","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I would just write it\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function q3invsqrt(num::Float32)\n           x = num * 0.5f0\n           y = reinterpret(Float32, 0x5f375a86 - (reinterpret(UInt32,num) >> 1))\n           y * (1.5f0 - x * y * y)\n       end"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P","reactions":[{"name":"heart","users":["U6C8RR26P"],"count":1}]},{"client_msg_id":"dab1c018-594d-4e2d-9120-2883da3018fb","type":"message","text":"nice!","user":"U6C8RR26P","ts":"1612719604.275000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"OFvuE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"nice!"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"c2f3b4e0-b0da-444e-b8a4-c251e784ed0e","type":"message","text":"Julia is a surprisingly nice language for doing bit fiddling for how high level it is. These types of tricks are used extensively in `Base.Math` for basically all of the special functions.","user":"U0179G7FG4F","ts":"1612719894.275300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4nola","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Julia is a surprisingly nice language for doing bit fiddling for how high level it is. These types of tricks are used extensively in "},{"type":"text","text":"Base.Math","style":{"code":true}},{"type":"text","text":" for basically all of the special functions."}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"6ce411a9-c4b4-4f1a-9e83-cdf662b3de12","type":"message","text":"This is the best thing about Julia and the main reason a seasoned C hacker would consider a high level language. You get the convenience of Python without giving up all control.","user":"U6C8RR26P","ts":"1612720006.275500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MOG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This is the best thing about Julia and the main reason a seasoned C hacker would consider a high level language. You get the convenience of Python without giving up all control."}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"a3e3e6ee-0e0d-4731-912e-907aaa058a3b","type":"message","text":"What does Base.FastMath.sqrt_fast do?","user":"U6N6VQE30","ts":"1612720357.275800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Pvb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What does Base.FastMath.sqrt_fast do?"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"9b04cf5b-08f9-4718-968d-1c0d4006ed7a","type":"message","text":"yeah, it was my bad, turns out the built in sqrt is much faster. you can see it in the @code_native that it uses nice CPU features","user":"U6C8RR26P","ts":"1612720402.276000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Uiss","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah, it was my bad, turns out the built in sqrt is much faster. you can see it in the @code_native that it uses nice CPU features"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"13713384-5450-4be5-b3a0-78f07aed5240","type":"message","text":"```julia&gt; @code_native invsqrt(16f0)\n        .text\n; ┌ @ REPL[36]:1 within `invsqrt'\n        pushq   %rbp\n        movq    %rsp, %rbp\n        subq    $32, %rsp\n        vxorps  %xmm1, %xmm1, %xmm1\n; │┌ @ math.jl:582 within `sqrt'\n; ││┌ @ float.jl:370 within `&lt;'\n        vucomiss        %xmm0, %xmm1\n; ││└\n        ja      L46\n; │└\n; │┌ @ math.jl:583 within `sqrt'\n        vsqrtss %xmm0, %xmm0, %xmm0\n        movabsq $.rodata.cst4, %rax\n        vmovss  (%rax), %xmm1                   # xmm1 = mem[0],zero,zero,zero\n; │└\n; │┌ @ promotion.jl:324 within `/' @ float.jl:334\n        vdivss  %xmm0, %xmm1, %xmm0\n; │└\n        addq    $32, %rsp\n        popq    %rbp\n        retq\n; │┌ @ math.jl:582 within `sqrt'\nL46:\n        movabsq $throw_complex_domainerror, %rax\n        movl    $243760696, %ecx                # imm = 0xE877E38\n        vmovaps %xmm0, %xmm1\n        callq   *%rax\n        ud2\n        nopw    %cs:(%rax,%rax)\n        nop\n\njulia&gt; @code_native q3invsqrt(x)\n        .text\n; ┌ @ REPL[26]:1 within `q3invsqrt'\n        pushq   %rbp\n        movq    %rsp, %rbp\n; │ @ REPL[26]:2 within `q3invsqrt'\n; │┌ @ essentials.jl:422 within `reinterpret'\n        vmovd   %xmm0, %eax\n; │└\n; │┌ @ int.jl:462 within `&gt;&gt;' @ int.jl:456\n        shrl    %eax\n        movl    $1597463174, %ecx               # imm = 0x5F375A86\n; │└\n; │┌ @ int.jl:86 within `-'\n        subl    %eax, %ecx\n; │└\n; │ @ REPL[26]:3 within `q3invsqrt'\n; │┌ @ essentials.jl:422 within `reinterpret'\n        vmovd   %ecx, %xmm1\n        movabsq $.rodata.cst4, %rax\n; │└\n; │ @ REPL[26]:4 within `q3invsqrt'\n; │┌ @ operators.jl:560 within `*' @ float.jl:331\n        vmulss  (%rax), %xmm0, %xmm0\n        vmulss  %xmm1, %xmm0, %xmm0\n; ││ @ operators.jl:560 within `*'\n; ││┌ @ operators.jl:533 within `afoldl'\n; │││┌ @ float.jl:331 within `*'\n        vmulss  %xmm1, %xmm0, %xmm0\n        movabsq $1630886192, %rax               # imm = 0x61355930\n; │└└└\n; │┌ @ float.jl:328 within `-'\n        vaddss  (%rax), %xmm0, %xmm0\n; │└\n; │┌ @ float.jl:331 within `*'\n        vmulss  %xmm1, %xmm0, %xmm0\n; │└\n        popq    %rbp\n        retq\n        nop\n; └```","user":"U6C8RR26P","ts":"1612720421.276200","team":"T68168MUP","edited":{"user":"U6C8RR26P","ts":"1612720690.000000"},"blocks":[{"type":"rich_text","block_id":"Xj4","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @code_native invsqrt(16f0)\n        .text\n; ┌ @ REPL[36]:1 within `invsqrt'\n        pushq   %rbp\n        movq    %rsp, %rbp\n        subq    $32, %rsp\n        vxorps  %xmm1, %xmm1, %xmm1\n; │┌ @ math.jl:582 within `sqrt'\n; ││┌ @ float.jl:370 within `<'\n        vucomiss        %xmm0, %xmm1\n; ││└\n        ja      L46\n; │└\n; │┌ @ math.jl:583 within `sqrt'\n        vsqrtss %xmm0, %xmm0, %xmm0\n        movabsq $.rodata.cst4, %rax\n        vmovss  (%rax), %xmm1                   # xmm1 = mem[0],zero,zero,zero\n; │└\n; │┌ @ promotion.jl:324 within `/' @ float.jl:334\n        vdivss  %xmm0, %xmm1, %xmm0\n; │└\n        addq    $32, %rsp\n        popq    %rbp\n        retq\n; │┌ @ math.jl:582 within `sqrt'\nL46:\n        movabsq $throw_complex_domainerror, %rax\n        movl    $243760696, %ecx                # imm = 0xE877E38\n        vmovaps %xmm0, %xmm1\n        callq   *%rax\n        ud2\n        nopw    %cs:(%rax,%rax)\n        nop\n\njulia> @code_native q3invsqrt(x)\n        .text\n; ┌ @ REPL[26]:1 within `q3invsqrt'\n        pushq   %rbp\n        movq    %rsp, %rbp\n; │ @ REPL[26]:2 within `q3invsqrt'\n; │┌ @ essentials.jl:422 within `reinterpret'\n        vmovd   %xmm0, %eax\n; │└\n; │┌ @ int.jl:462 within `>>' @ int.jl:456\n        shrl    %eax\n        movl    $1597463174, %ecx               # imm = 0x5F375A86\n; │└\n; │┌ @ int.jl:86 within `-'\n        subl    %eax, %ecx\n; │└\n; │ @ REPL[26]:3 within `q3invsqrt'\n; │┌ @ essentials.jl:422 within `reinterpret'\n        vmovd   %ecx, %xmm1\n        movabsq $.rodata.cst4, %rax\n; │└\n; │ @ REPL[26]:4 within `q3invsqrt'\n; │┌ @ operators.jl:560 within `*' @ float.jl:331\n        vmulss  (%rax), %xmm0, %xmm0\n        vmulss  %xmm1, %xmm0, %xmm0\n; ││ @ operators.jl:560 within `*'\n; ││┌ @ operators.jl:533 within `afoldl'\n; │││┌ @ float.jl:331 within `*'\n        vmulss  %xmm1, %xmm0, %xmm0\n        movabsq $1630886192, %rax               # imm = 0x61355930\n; │└└└\n; │┌ @ float.jl:328 within `-'\n        vaddss  (%rax), %xmm0, %xmm0\n; │└\n; │┌ @ float.jl:331 within `*'\n        vmulss  %xmm1, %xmm0, %xmm0\n; │└\n        popq    %rbp\n        retq\n        nop\n; └"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"47072795-7b29-4ca4-b730-e2af701ebf81","type":"message","text":"`sqrt_fast` goes to `sqrt_llvm_fast(x)` which I think turns into custom cpu instructions (at least on x86)","user":"U0179G7FG4F","ts":"1612720500.276400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ejg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"sqrt_fast","style":{"code":true}},{"type":"text","text":" goes to "},{"type":"text","text":"sqrt_llvm_fast(x)","style":{"code":true}},{"type":"text","text":" which I think turns into custom cpu instructions (at least on x86)"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"d6039d6e-8bff-4ca2-a714-14600410add1","type":"message","text":"yeah, it uses the VSQRTSS AVX\n<https://developer.amd.com/wordpress/media/2012/10/26568_APM_v4.pdf>","user":"U6C8RR26P","ts":"1612720745.276700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gja","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah, it uses the VSQRTSS AVX\n"},{"type":"link","url":"https://developer.amd.com/wordpress/media/2012/10/26568_APM_v4.pdf"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"adc13418-ce98-44e7-b479-275538042bd1","type":"message","text":"why doesn't the standard sqrt call this too?","user":"UMDEUKM29","ts":"1612723094.276900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XJUu=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"why doesn't the standard sqrt call this too?"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"b23c8560-e333-4e3a-bade-64f54e66781b","type":"message","text":"Looks to me like it does","user":"U6C8RR26P","ts":"1612723178.277200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"m=DUI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Looks to me like it does"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"28f6a0eb-afd0-4469-bcdc-efd3ab55c47b","type":"message","text":"right, sorry I thought you only meant the `@fastmath` version","user":"UMDEUKM29","ts":"1612723250.278900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"eF8Oi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"right, sorry I thought you only meant the "},{"type":"text","text":"@fastmath","style":{"code":true}},{"type":"text","text":" version"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"a9636195-e1f0-4e9b-b515-d727bb48d9ad","type":"message","text":"I did because I didn't bother to look what the regular one goes to :slightly_smiling_face:","user":"U0179G7FG4F","ts":"1612723279.279100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vhY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I did because I didn't bother to look what the regular one goes to "},{"type":"emoji","name":"slightly_smiling_face"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"34bf765e-a0ed-4fa8-bdf0-3ac50185b37c","type":"message","text":"I'm gonna try this on some arm processors though.","user":"U6C8RR26P","ts":"1612723283.279300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"p7f","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm gonna try this on some arm processors though."}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"ba6ba126-27d4-4fbb-88c1-94a5843ba236","type":"message","text":"ooh the new `@code_native` highlighting in 1.6 is so nice!","user":"UMDEUKM29","ts":"1612723367.280200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"m=5rr","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ooh the new "},{"type":"text","text":"@code_native","style":{"code":true}},{"type":"text","text":" highlighting in 1.6 is so nice!"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P","reactions":[{"name":"rainbow","users":["UH24GRBLL","U6C8RR26P","U0179G7FG4F","UKG4WF8PJ"],"count":4},{"name":"rainbow_right","users":["UH24GRBLL","U0179G7FG4F","U6QGE7S86","UKG4WF8PJ"],"count":4}]},{"client_msg_id":"ae7f4242-7eb6-4375-a84c-53dc6d531e93","type":"message","text":"it's weird to me that sqrt has a dedicated hardware instruction but not exp, sin, cos, log","user":"UMDEUKM29","ts":"1612723646.281000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TZa","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's weird to me that sqrt has a dedicated hardware instruction but not exp, sin, cos, log"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"5b514b03-ca8d-44ca-b3d9-eb3ad6c74445","type":"message","text":"By the way <@U6C8RR26P> when you're benchmarking functions on immutables like `Float32`, you should wrap the inputs in `Ref`s so you don't accidentally include things like constant prop in the timings","user":"U8D9768Q6","ts":"1612723653.281200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pHA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"By the way "},{"type":"user","user_id":"U6C8RR26P"},{"type":"text","text":" when you're benchmarking functions on immutables like "},{"type":"text","text":"Float32","style":{"code":true}},{"type":"text","text":", you should wrap the inputs in "},{"type":"text","text":"Ref","style":{"code":true}},{"type":"text","text":"s so you don't accidentally include things like constant prop in the timings"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"0a07f48d-6ace-4371-8bdb-fb315c19f72b","type":"message","text":"```julia&gt; let x = Ref(16f0)\n           @btime q3invsqrt($x[])\n           @btime 1/sqrt($x[])\n       end\n  1.549 ns (0 allocations: 0 bytes)\n  1.809 ns (0 allocations: 0 bytes)\n0.25f0```","user":"U8D9768Q6","ts":"1612723666.281400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ki4cw","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> let x = Ref(16f0)\n           @btime q3invsqrt($x[])\n           @btime 1/sqrt($x[])\n       end\n  1.549 ns (0 allocations: 0 bytes)\n  1.809 ns (0 allocations: 0 bytes)\n0.25f0"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"d68f7cf3-5a0e-43e7-b039-de3b57d02454","type":"message","text":"Does anything change if you add a `@fastmath` to the second?","user":"U0179G7FG4F","ts":"1612723734.282000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yKwp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Does anything change if you add a "},{"type":"text","text":"@fastmath","style":{"code":true}},{"type":"text","text":" to the second?"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"0c4bdb75-c1d3-47e8-9239-d6dd2fbb1b47","type":"message","text":"```julia&gt; let x = Ref(16f0)\n           @btime q3invsqrt($x[])\n           @btime @fastmath 1/sqrt($x[])\n       end\n  1.599 ns (0 allocations: 0 bytes)\n  1.299 ns (0 allocations: 0 bytes)\n0.25f0```","user":"U8D9768Q6","ts":"1612723773.282200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2FIZ","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> let x = Ref(16f0)\n           @btime q3invsqrt($x[])\n           @btime @fastmath 1/sqrt($x[])\n       end\n  1.599 ns (0 allocations: 0 bytes)\n  1.299 ns (0 allocations: 0 bytes)\n0.25f0"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"},{"client_msg_id":"3ea363df-8e6f-4f7b-b7a2-d5396ef64190","type":"message","text":"Thanks!","user":"U6C8RR26P","ts":"1612723830.282400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ujb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks!"}]}]}],"thread_ts":"1612719233.274500","parent_user_id":"U6C8RR26P"}]