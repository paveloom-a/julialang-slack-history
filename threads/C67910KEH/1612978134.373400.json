[{"client_msg_id":"2779f9f6-513d-4f87-be6f-8a3c6ff4db8b","type":"message","text":"This is also surprising/somewhat evil, in the same vein as above:\n```g1() = Dict{Symbol, Vector{Float64}}(\n            :Z =&gt; [0.0, 0.0, 0.5],\n            :A =&gt; [0.5, 0.5, 0.5])\ng2() = Dict(:Z =&gt; [0.0, 0.0, 0.5],\n            :A =&gt; [0.5, 0.5, 0.5])\n\n@btime g1() # 254.061 ns (8 allocations: 896 bytes)\n@btime g2() # 233.819 ns (6 allocations: 832 bytes)```\nAdding the (correct) type annotation on the Dict leads to extra allocations :open_mouth:.\nThere's no difference if there's just one element in the Dict but for more than one element `g2` adds 2 allocations per new element, while `g1` just adds 1 allocation per element.","user":"UCE6XE42Z","ts":"1612978134.373400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gKpP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This is also surprising/somewhat evil, in the same vein as above:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"g1() = Dict{Symbol, Vector{Float64}}(\n            :Z => [0.0, 0.0, 0.5],\n            :A => [0.5, 0.5, 0.5])\ng2() = Dict(:Z => [0.0, 0.0, 0.5],\n            :A => [0.5, 0.5, 0.5])\n\n@btime g1() # 254.061 ns (8 allocations: 896 bytes)\n@btime g2() # 233.819 ns (6 allocations: 832 bytes)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Adding the (correct) type annotation on the Dict leads to extra allocations "},{"type":"emoji","name":"open_mouth"},{"type":"text","text":".\nThere's no difference if there's just one element in the Dict but for more than one element "},{"type":"text","text":"g2","style":{"code":true}},{"type":"text","text":" adds 2 allocations per new element, while "},{"type":"text","text":"g1","style":{"code":true}},{"type":"text","text":" just adds 1 allocation per element."}]}]}],"thread_ts":"1612978134.373400","reply_count":8,"reply_users_count":3,"latest_reply":"1612998885.379400","reply_users":["UDB26738Q","UCE6XE42Z","U68QW0PUZ"],"subscribed":false},{"client_msg_id":"f9d6920d-4854-4e91-85e9-adddf403e0c6","type":"message","text":"especially surprising since the latter calls the former:\n```Dict(ps::Pair{K,V}...) where {K,V} = Dict{K,V}(ps)```\n:confused:","user":"UDB26738Q","ts":"1612978291.373500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zODh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"especially surprising since the latter calls the former:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"Dict(ps::Pair{K,V}...) where {K,V} = Dict{K,V}(ps)"}]},{"type":"rich_text_section","elements":[{"type":"emoji","name":"confused"}]}]}],"thread_ts":"1612978134.373400","parent_user_id":"UCE6XE42Z"},{"client_msg_id":"9439fe0a-0b31-40b2-b1a2-867993873488","type":"message","text":":confused:","user":"UCE6XE42Z","ts":"1612978427.373700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+oe","elements":[{"type":"rich_text_section","elements":[{"type":"emoji","name":"confused"}]}]}],"thread_ts":"1612978134.373400","parent_user_id":"UCE6XE42Z"},{"client_msg_id":"d13bd48d-df87-4401-ad8d-259eab8bbb4d","type":"message","text":"ok, that might be an artifact of the benchamrk, somehow:\n```julia&gt; ps = (:Z =&gt; [0.0, 0.0, 0.5],\n                   :A =&gt; [0.5, 0.5, 0.5])\n(:Z =&gt; [0.0, 0.0, 0.5], :A =&gt; [0.5, 0.5, 0.5])\n\njulia&gt; g1(ps) = Dict{Symbol, Vector{Float64}}(ps)\ng1 (generic function with 2 methods)\n\njulia&gt; g2(ps) = Dict(ps)\ng2 (generic function with 2 methods)\n\njulia&gt; @btime g1($(Ref(ps))[]);\n  110.498 ns (4 allocations: 608 bytes)\n\njulia&gt; @btime g2($(Ref(ps))[]);\n  131.759 ns (4 allocations: 608 bytes)```\nthese times look more reasonable","user":"UDB26738Q","ts":"1612978766.373900","team":"T68168MUP","edited":{"user":"UDB26738Q","ts":"1612978778.000000"},"blocks":[{"type":"rich_text","block_id":"3nkg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ok, that might be an artifact of the benchamrk, somehow:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> ps = (:Z => [0.0, 0.0, 0.5],\n                   :A => [0.5, 0.5, 0.5])\n(:Z => [0.0, 0.0, 0.5], :A => [0.5, 0.5, 0.5])\n\njulia> g1(ps) = Dict{Symbol, Vector{Float64}}(ps)\ng1 (generic function with 2 methods)\n\njulia> g2(ps) = Dict(ps)\ng2 (generic function with 2 methods)\n\njulia> @btime g1($(Ref(ps))[]);\n  110.498 ns (4 allocations: 608 bytes)\n\njulia> @btime g2($(Ref(ps))[]);\n  131.759 ns (4 allocations: 608 bytes)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"these times look more reasonable"}]}]}],"thread_ts":"1612978134.373400","parent_user_id":"UCE6XE42Z"},{"client_msg_id":"9e3ef149-ccf0-464e-9f81-6bbbc5114fb5","type":"message","text":"That looks more reasonable, yeah; still strange though. Seems to be real for literals though?","user":"UCE6XE42Z","ts":"1612979394.374900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6gd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That looks more reasonable, yeah; still strange though. Seems to be real for literals though?"}]}]}],"thread_ts":"1612978134.373400","parent_user_id":"UCE6XE42Z"},{"client_msg_id":"848fd101-61c1-4521-ac7a-0179125661ea","type":"message","text":"it may be happening something weird with the benchmarks.  for example, I prevented constant propagation with the use of `Ref(...)[]`, that's often useful to make fair benchmarks","user":"UDB26738Q","ts":"1612979586.375100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GfXD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it may be happening something weird with the benchmarks.  for example, I prevented constant propagation with the use of "},{"type":"text","text":"Ref(...)[]","style":{"code":true}},{"type":"text","text":", that's often useful to make fair benchmarks"}]}]}],"thread_ts":"1612978134.373400","parent_user_id":"UCE6XE42Z"},{"client_msg_id":"c100bbdf-b519-4139-97b5-b021c1d30450","type":"message","text":"Having a day of surprises today... This one also just surprised me:\n```write(stdout, :a)   # a1\nwrite(stdout, :aa)  # aa2\nwrite(stdout, :aaa) # aaa3```\nWhat's with the extra numbers?","user":"UCE6XE42Z","ts":"1612990231.377600","team":"T68168MUP","edited":{"user":"UCE6XE42Z","ts":"1612990651.000000"},"blocks":[{"type":"rich_text","block_id":"Qwx3l","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Having a day of surprises today... This one also just surprised me:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"write(stdout, :a)   # a1\nwrite(stdout, :aa)  # aa2\nwrite(stdout, :aaa) # aaa3"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"What's with the extra numbers?"}]}]}],"thread_ts":"1612978134.373400","parent_user_id":"UCE6XE42Z"},{"client_msg_id":"c00bd717-ac02-45c1-b56c-83da119f05d3","type":"message","text":"`write` \"Returns the number of bytes written into the stream\" and you are writing to the same place that gets the returned value, so you see the byte count after the symbol.\nTo see this:\n```julia&gt; write(stdout, :aaa) |&gt; string\naaa\"3\"```\n","user":"U68QW0PUZ","ts":"1612998830.379200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rROmF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"write","style":{"code":true}},{"type":"text","text":" \"Returns the number of bytes written into the stream\" and you are writing to the same place that gets the returned value, so you see the byte count after the symbol.\nTo see this:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> write(stdout, :aaa) |> string\naaa\"3\""}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1612978134.373400","parent_user_id":"UCE6XE42Z","reactions":[{"name":"+1","users":["UDB26738Q"],"count":1}]},{"client_msg_id":"94771f2b-d331-4796-a783-37de288c5dd2","type":"message","text":"or\n```julia&gt; write(stdout, :aaa);\naaa\njulia&gt;```","user":"UDB26738Q","ts":"1612998885.379400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Fb1Ym","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"or\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> write(stdout, :aaa);\naaa\njulia>"}]}]}],"thread_ts":"1612978134.373400","parent_user_id":"UCE6XE42Z"}]