[{"client_msg_id":"838f8f47-f31f-41c0-9396-e2866805a835","type":"message","text":"can someone help me understand `Threads.Condition`? `Base.Condition` works exactly like I'd expect it to, given the docs, but I don't understand `Threads.Condition` at all.\n\nSee for example, the following\n```julia\nusing Base.Threads\nusing Base.Threads: @spawn, Condition\n\nfunction f(c::Condition)\n    wait(c)\n    println(\"hello f\")\nend\n\nfunction g()\n    c = Condition()\n    lock(c)\n    @spawn f(c)\n    println(\"hello g\")\n    notify(c)\n    unlock(c)\nend```\nThis only prints `\"hello g\"`.  There doesn't seem to be anything I can do to get the condition to stop blocking.","user":"U9VG1AYSG","ts":"1615056728.152100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Oqbhj","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"can someone help me understand "},{"type":"text","text":"Threads.Condition","style":{"code":true}},{"type":"text","text":"? "},{"type":"text","text":"Base.Condition","style":{"code":true}},{"type":"text","text":" works exactly like I'd expect it to, given the docs, but I don't understand "},{"type":"text","text":"Threads.Condition","style":{"code":true}},{"type":"text","text":" at all.\n\nSee for example, the following\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia\nusing Base.Threads\nusing Base.Threads: @spawn, Condition\n\nfunction f(c::Condition)\n    wait(c)\n    println(\"hello f\")\nend\n\nfunction g()\n    c = Condition()\n    lock(c)\n    @spawn f(c)\n    println(\"hello g\")\n    notify(c)\n    unlock(c)\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"This only prints "},{"type":"text","text":"\"hello g\"","style":{"code":true}},{"type":"text","text":".  There doesn't seem to be anything I can do to get the condition to stop blocking."}]}]}],"thread_ts":"1615056728.152100","reply_count":21,"reply_users_count":2,"latest_reply":"1615199702.217900","reply_users":["U01K809EUQ7","U9VG1AYSG"],"subscribed":false},{"client_msg_id":"8c4795db-bb58-40ae-b74f-ff8780232c09","type":"message","text":"```using Base.Threads\nusing Base.Threads: @spawn, Condition\n\nfunction f(c::Condition)\n    println(\"f1\")\n    lock(c)\n    println(\"f2\")\n    wait(c)\n    println(\"f3\")\n    unlock(c)\n    println(\"f4\")\nend\n\nfunction g()\n    c = Condition()\n    lock(c)\n    @spawn f(c)\n    println(\"g1\")\n    notify(c)\n    println(\"g2\")\n    unlock(c)\nend```\nprints\n```julia&gt; g()\ng1\ng2\nf1\n\njulia&gt; f2\njulia&gt;```\nSeems like notify is called before the thread begins?","user":"U01K809EUQ7","ts":"1615059542.153100","team":"T68168MUP","edited":{"user":"U01K809EUQ7","ts":"1615059577.000000"},"blocks":[{"type":"rich_text","block_id":"35uT","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using Base.Threads\nusing Base.Threads: @spawn, Condition\n\nfunction f(c::Condition)\n    println(\"f1\")\n    lock(c)\n    println(\"f2\")\n    wait(c)\n    println(\"f3\")\n    unlock(c)\n    println(\"f4\")\nend\n\nfunction g()\n    c = Condition()\n    lock(c)\n    @spawn f(c)\n    println(\"g1\")\n    notify(c)\n    println(\"g2\")\n    unlock(c)\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"prints\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> g()\ng1\ng2\nf1\n\njulia> f2\njulia>"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Seems like notify is called before the thread begins?"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"e2495ed6-244b-4403-a52c-258ffe604d25","type":"message","text":"it's still not unblocking on the wait, nothing I've tried seems to be able to do that...","user":"U9VG1AYSG","ts":"1615059689.153400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jWIoI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's still not unblocking on the wait, nothing I've tried seems to be able to do that..."}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"fea25f50-4b95-4043-be2f-8c2764a37e88","type":"message","text":"well, for one:","user":"U01K809EUQ7","ts":"1615059766.153900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ERa","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"well, for one:"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"87027f5b-2c4b-43a6-a014-89f614f41df3","type":"message","text":"\"Special note for `Threads.Condition`:\nThe caller must be holding the `lock` that owns `c` before calling this method. The calling task will be blocked until some other task wakes it, usually by calling `notify` on the same Condition object.\"","user":"U01K809EUQ7","ts":"1615059785.154100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=qk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"\"Special note for "},{"type":"text","text":"Threads.Condition","style":{"code":true}},{"type":"text","text":":\nThe caller must be holding the "},{"type":"text","text":"lock","style":{"code":true}},{"type":"text","text":" that owns "},{"type":"text","text":"c","style":{"code":true}},{"type":"text","text":" before calling this method. The calling task will be blocked until some other task wakes it, usually by calling "},{"type":"text","text":"notify","style":{"code":true}},{"type":"text","text":" on the same Condition object.\""}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"51675e32-96b5-4f6c-8d5f-9ee560efa8aa","type":"message","text":"so you need to lock() before calling wait()","user":"U01K809EUQ7","ts":"1615059795.154300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pVynu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so you need to lock() before calling wait()"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"10b99930-bb5d-4cd3-ab77-8bd9a2e277d4","type":"message","text":"I'm a bit confused by that, because `wait` is modifying the `Condition` is it?  Why does it need a lock there?\nbut regardless, it does not work\n```using Base.Threads\nusing Base.Threads: @spawn, Condition\n\nfunction f(c::Condition)\n    lock(c)\n    wait(c)\n    println(\"hello f\")\n    unlock(c)\nend\n\nfunction g()\n    c = Condition()\n    @spawn f(c)\n    lock(c)\n    notify(c)\n    unlock(c)\nend```","user":"U9VG1AYSG","ts":"1615059954.154700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cOhQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm a bit confused by that, because "},{"type":"text","text":"wait","style":{"code":true}},{"type":"text","text":" is modifying the "},{"type":"text","text":"Condition","style":{"code":true}},{"type":"text","text":" is it?  Why does it need a lock there?\nbut regardless, it does not work\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using Base.Threads\nusing Base.Threads: @spawn, Condition\n\nfunction f(c::Condition)\n    lock(c)\n    wait(c)\n    println(\"hello f\")\n    unlock(c)\nend\n\nfunction g()\n    c = Condition()\n    @spawn f(c)\n    lock(c)\n    notify(c)\n    unlock(c)\nend"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"8b9a4543-2e9e-4e04-b3ba-e3e2028262a8","type":"message","text":"the above still does not print","user":"U9VG1AYSG","ts":"1615059961.154900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"wft=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the above still does not print"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"e8207072-0d9e-49d5-bb99-2eeb6eb8f711","type":"message","text":"I guess I don't really even understand what the lock is doing here.  In the above code, isn't it blocking `g` from calling `notify` because `f` is holding the `lock`?","user":"U9VG1AYSG","ts":"1615060048.155100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RuC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I guess I don't really even understand what the lock is doing here.  In the above code, isn't it blocking "},{"type":"text","text":"g","style":{"code":true}},{"type":"text","text":" from calling "},{"type":"text","text":"notify","style":{"code":true}},{"type":"text","text":" because "},{"type":"text","text":"f","style":{"code":true}},{"type":"text","text":" is holding the "},{"type":"text","text":"lock","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"d327d606-684d-4e4b-b616-384f472af9c8","type":"message","text":"add sleep(2) after spawning the thread","user":"U01K809EUQ7","ts":"1615061172.155300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MfS0l","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"add sleep(2) after spawning the thread"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"22e89ef4-0cd2-44d2-9fb6-b33c13d1d9ff","type":"message","text":"it will work","user":"U01K809EUQ7","ts":"1615061175.155500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"230J7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it will work"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"1e295b39-0924-4a00-8b61-226d4159a8d9","type":"message","text":"otherwise you'll be calling notify before f locks &amp; waits","user":"U01K809EUQ7","ts":"1615061204.155700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=EE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"otherwise you'll be calling notify before f locks & waits"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"c9019c50-c6b4-49f1-bfb9-eb2de012c660","type":"message","text":"oh, I guess that kind of makes sense... why exactly does `f` have to lock?  (and that lock is of the condition itself, right?)  I guess it's because `wait` changes its state when it's done?","user":"U9VG1AYSG","ts":"1615061347.155900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"eECC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh, I guess that kind of makes sense... why exactly does "},{"type":"text","text":"f","style":{"code":true}},{"type":"text","text":" have to lock?  (and that lock is of the condition itself, right?)  I guess it's because "},{"type":"text","text":"wait","style":{"code":true}},{"type":"text","text":" changes its state when it's done?"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"3e769561-8e19-4519-94c2-d91bdeba9c88","type":"message","text":"f is not holding the lock because wait releases it while waiting","user":"U01K809EUQ7","ts":"1615061348.156100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yPYmy","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"f is not holding the lock because wait releases it while waiting"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"7bbb58ee-f043-4ec2-a7b3-37ba7ae1fec0","type":"message","text":"it's a little weird that `wait` doesn't handle the locking of the `COndition` for you, I thought that was the whole idea...","user":"U9VG1AYSG","ts":"1615061371.156300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Jc1vP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's a little weird that "},{"type":"text","text":"wait","style":{"code":true}},{"type":"text","text":" doesn't handle the locking of the "},{"type":"text","text":"COndition","style":{"code":true}},{"type":"text","text":" for you, I thought that was the whole idea..."}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"3f62f4ec-975a-4f8b-9bac-013b9715ea36","type":"message","text":"I'm afraid I'm even more confused now than I was before... if there is a wait inside the lock, and we also have a lock when notifying... how does it ever get unblocked, isn't this a deadlock condition?  Can you give an example?","user":"U9VG1AYSG","ts":"1615061579.156600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+mS8C","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm afraid I'm even more confused now than I was before... if there is a wait inside the lock, and we also have a lock when notifying... how does it ever get unblocked, isn't this a deadlock condition?  Can you give an example?"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"b8dbc07a-8a37-4f77-b863-8f4ccaa3eb18","type":"message","text":"see above, wait releases the lock while waiting","user":"U01K809EUQ7","ts":"1615061662.156800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"2zq=3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"see above, wait releases the lock while waiting"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"a72a172a-437c-4d18-8045-c0cdec19d3da","type":"message","text":"as for why you need to lock before calling wait or notify, I'm not sure, I'm looking into it","user":"U01K809EUQ7","ts":"1615061685.157000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"d7U","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"as for why you need to lock before calling wait or notify, I'm not sure, I'm looking into it"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"da0df93c-0e09-4cca-a549-0e669237c991","type":"message","text":"```using Base.Threads\nusing Base.Threads: @spawn, Condition\n\nfunction f(c::Condition)\n    lock(c)\n    wait(c)\n    println(\"wtf\")\n    unlock(c)\nend\n\nfunction g()\n    c = Condition()\n    @spawn f(c)\n    sleep(2)\n    println(\"trying to notify\")\n    lock(c)\n    notify(c)\n    unlock(c)\nend```\nthe above prints both lines and I don't understand why at all... shouldn't it block eternally on `lock(c)` inside `g` because `f` never releases the lock??","user":"U9VG1AYSG","ts":"1615061685.157200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Z1PjF","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using Base.Threads\nusing Base.Threads: @spawn, Condition\n\nfunction f(c::Condition)\n    lock(c)\n    wait(c)\n    println(\"wtf\")\n    unlock(c)\nend\n\nfunction g()\n    c = Condition()\n    @spawn f(c)\n    sleep(2)\n    println(\"trying to notify\")\n    lock(c)\n    notify(c)\n    unlock(c)\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"the above prints both lines and I don't understand why at all... shouldn't it block eternally on "},{"type":"text","text":"lock(c)","style":{"code":true}},{"type":"text","text":" inside "},{"type":"text","text":"g","style":{"code":true}},{"type":"text","text":" because "},{"type":"text","text":"f","style":{"code":true}},{"type":"text","text":" never releases the lock??"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"aecb9f79-a64f-4164-bff8-cf71581fa3d6","type":"message","text":"I'm incredibly confused... so if I try something analogous with `ReentrantLock` it does exactly what I expect... but then how come the above code doesn't block forever?  Does `c` have two different locks?  (the struct does, so I guess that's it?) but then how does it know which one to use when you call `lock`?","user":"U9VG1AYSG","ts":"1615061859.157400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/r4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm incredibly confused... so if I try something analogous with "},{"type":"text","text":"ReentrantLock","style":{"code":true}},{"type":"text","text":" it does exactly what I expect... but then how come the above code doesn't block forever?  Does "},{"type":"text","text":"c","style":{"code":true}},{"type":"text","text":" have two different locks?  (the struct does, so I guess that's it?) but then how does it know which one to use when you call "},{"type":"text","text":"lock","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"f1515d57-8a54-44f2-86c7-48fd7b8f0f6f","type":"message","text":"I don't think I understand the purpose of `Threads.Condition` at all... I thought the whole point of it was that you could `wait` on a new thread without worrying about locks, even if you had to lock it on the thread you are calling `notify` from.  Since it can't do this, I'm not really sure what it's doing.  What is the purpose of using `Condition` instead of `ReentrantLock`?","user":"U9VG1AYSG","ts":"1615062161.157600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UBMb4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I don't think I understand the purpose of "},{"type":"text","text":"Threads.Condition","style":{"code":true}},{"type":"text","text":" at all... I thought the whole point of it was that you could "},{"type":"text","text":"wait","style":{"code":true}},{"type":"text","text":" on a new thread without worrying about locks, even if you had to lock it on the thread you are calling "},{"type":"text","text":"notify","style":{"code":true}},{"type":"text","text":" from.  Since it can't do this, I'm not really sure what it's doing.  What is the purpose of using "},{"type":"text","text":"Condition","style":{"code":true}},{"type":"text","text":" instead of "},{"type":"text","text":"ReentrantLock","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"},{"client_msg_id":"bf62c2e5-51ca-4ad7-a6a5-6f8039f49b84","type":"message","text":"if you haven't gotten an answer to your question yet, maybe you should post on the channel again (that tick box at the bottom of the message \"Also send to <#C67910KEH|general>\"). I'm not really sure what the point of using `lock` myself in this case is either.","user":"U01K809EUQ7","ts":"1615199702.217900","team":"T68168MUP","edited":{"user":"U01K809EUQ7","ts":"1615199762.000000"},"blocks":[{"type":"rich_text","block_id":"Bg8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if you haven't gotten an answer to your question yet, maybe you should post on the channel again (that tick box at the bottom of the message \"Also send to "},{"type":"channel","channel_id":"C67910KEH"},{"type":"text","text":"\"). I'm not really sure what the point of using "},{"type":"text","text":"lock","style":{"code":true}},{"type":"text","text":" myself in this case is either."}]}]}],"thread_ts":"1615056728.152100","parent_user_id":"U9VG1AYSG"}]