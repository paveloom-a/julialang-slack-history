[{"client_msg_id":"9ff4212b-4019-4cec-85e7-3ddbbc5be4bb","type":"message","text":"When I call a constructor for one of my structs, it takes almost 3sec to return, even though the function(constructor itself does very little. Using the`@time` macro says it spends 99.9% on compilation. The only possible problem I can see is that the struct has a type-parameter which itself has alot of type-parameters...can that slow things down?","user":"U7624B5U7","ts":"1616590485.028300","team":"T68168MUP","edited":{"user":"U7624B5U7","ts":"1616590507.000000"},"blocks":[{"type":"rich_text","block_id":"ViOaq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"When I call a constructor for one of my structs, it takes almost 3sec to return, even though the function(constructor itself does very little. Using the"},{"type":"text","text":"@time","style":{"code":true}},{"type":"text","text":" macro says it spends 99.9% on compilation. The only possible problem I can see is that the struct has a type-parameter which itself has alot of type-parameters...can that slow things down?"}]}]}],"thread_ts":"1616590485.028300","reply_count":26,"reply_users_count":4,"latest_reply":"1616595012.042000","reply_users":["U01C3624SGJ","U7HAYKY9X","U7624B5U7","UH24GRBLL"],"is_locked":false,"subscribed":false},{"client_msg_id":"bb71e52d-6138-4d7f-b6d2-7ca02d942078","type":"message","text":"What happens when you call the constructor again?","user":"U01C3624SGJ","ts":"1616590576.028500","team":"T68168MUP","edited":{"user":"U01C3624SGJ","ts":"1616590582.000000"},"blocks":[{"type":"rich_text","block_id":"n1ZX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What happens when you call the constructor again?"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"4c8d6743-de7d-49e1-9994-39eb8a49ffb2","type":"message","text":"A lot of type parameters can slow things down.. but 3 seconds is a lot. How many parameters are \"a lot\"? 20? 200? 2000?","user":"U7HAYKY9X","ts":"1616590631.029000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PJ9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"A lot of type parameters can slow things down.. but 3 seconds is a lot. How many parameters are \"a lot\"? 20? 200? 2000?"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"8f0e1c33-658c-4f58-8bac-ef3e5477fad8","type":"message","text":"The main struct has 1 parameter, and that strict has ~7 parameters. Some of the other typeparameters has like 2-3 parameter","user":"U7624B5U7","ts":"1616590739.029400","team":"T68168MUP","edited":{"user":"U7624B5U7","ts":"1616590847.000000"},"blocks":[{"type":"rich_text","block_id":"kKE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The main struct has 1 parameter, and that strict has ~7 parameters. Some of the other typeparameters has like 2-3 parameter"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"12201af1-7521-49a7-83e6-afdfc00de3bd","type":"message","text":"When I call the constructor again, it also takes a long time...","user":"U7624B5U7","ts":"1616590794.029700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nGwcH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"When I call the constructor again, it also takes a long time..."}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"f41bc63f-9301-4bb7-9b19-2939ae05b348","type":"message","text":"That's not normal. And I think you can have several tens of parameters before it becomes slow","user":"U7HAYKY9X","ts":"1616590884.030000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qFJsX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That's not normal. And I think you can have several tens of parameters before it becomes slow"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"79e93f1d-c19f-47c2-808e-77b909d3d83c","type":"message","text":"that's not a lot of type parameters","user":"UH24GRBLL","ts":"1616591030.030200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jFL8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that's not a lot of type parameters"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"948d45d2-ea32-42d2-9763-130c42508964","type":"message","text":"can you share the example that's slow?","user":"UH24GRBLL","ts":"1616591040.030400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TkMda","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"can you share the example that's slow?"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"e1dd3972-9ec0-4db6-8457-1142c41ada40","type":"message","text":"```  1.754029 seconds (70.18 k allocations: 4.566 MiB, 100.10% compilation time)\n  1.481718 seconds (69.89 k allocations: 4.633 MiB, 99.93% compilation time)```\nFirst and second call.. 100.10% lol","user":"U7624B5U7","ts":"1616591082.030600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"v6ab8","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"  1.754029 seconds (70.18 k allocations: 4.566 MiB, 100.10% compilation time)\n  1.481718 seconds (69.89 k allocations: 4.633 MiB, 99.93% compilation time)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"First and second call.. 100.10% lol"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"8972ba85-de3e-4199-ac53-abf299710f47","type":"message","text":"```struct MyStruct{P&lt;:Shell} &lt;: Five.AbstractExternalForce\n    faceset::Vector{VertexInterfaceIndex}\n    prescribed_displacement::Function\n    components::Vector{Int}\n    shell::Base.RefValue{P}\n    penalty::Float64\nend\n\nfunction MyStruct(; \n    set, \n    func::Function,\n    comps::AbstractVector{Int}, \n    shell::Shell{dim_p,dim_s,T}, #has more typeparameters...\n    penalty::T\n    ) where {dim_p,dim_s,T}\n    \n    @assert( length(comps) == length(func(zero(Vec{dim_s,T}), 0.0)) )\n\n    return MyStruct{typeof(shell)}(collect(set), func, collect(comps), Base.RefValue(shell), penalty)\nend\n\n#call:\n@time begin\netf = MyStruct( \n    set = edgeset,\n    func = (x,t) -&gt; [0.0], \n    comps = [DIM],\n    shell = shell, \n    penalty = 1e8\n)\nend```","user":"U7624B5U7","ts":"1616591307.030800","team":"T68168MUP","edited":{"user":"U7624B5U7","ts":"1616591456.000000"},"blocks":[{"type":"rich_text","block_id":"JPQ","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"struct MyStruct{P<:Shell} <: Five.AbstractExternalForce\n    faceset::Vector{VertexInterfaceIndex}\n    prescribed_displacement::Function\n    components::Vector{Int}\n    shell::Base.RefValue{P}\n    penalty::Float64\nend\n\nfunction MyStruct(; \n    set, \n    func::Function,\n    comps::AbstractVector{Int}, \n    shell::Shell{dim_p,dim_s,T}, #has more typeparameters...\n    penalty::T\n    ) where {dim_p,dim_s,T}\n    \n    @assert( length(comps) == length(func(zero(Vec{dim_s,T}), 0.0)) )\n\n    return MyStruct{typeof(shell)}(collect(set), func, collect(comps), Base.RefValue(shell), penalty)\nend\n\n#call:\n@time begin\netf = MyStruct( \n    set = edgeset,\n    func = (x,t) -> [0.0], \n    comps = [DIM],\n    shell = shell, \n    penalty = 1e8\n)\nend"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"6f391ceb-6866-4579-9ce2-268588098c3a","type":"message","text":"I experimented with removing the RefValues, but that did not change anything","user":"U7624B5U7","ts":"1616591351.031000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4DC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I experimented with removing the RefValues, but that did not change anything"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"c52d3180-e18d-4f74-a00b-54e995494329","type":"message","text":"Hmm, if i remove the keyword arguments it becomes much better:\n`0.954794 seconds (11.01 k allocations: 792.492 KiB, 99.96% compilation time)`\n  `0.000036 seconds (26 allocations: 5.602 KiB)`","user":"U7624B5U7","ts":"1616591659.031900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ECwG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm, if i remove the keyword arguments it becomes much better:\n"},{"type":"text","text":"0.954794 seconds (11.01 k allocations: 792.492 KiB, 99.96% compilation time)","style":{"code":true}},{"type":"text","text":"\n"},{"type":"text","text":"  0.000036 seconds (26 allocations: 5.602 KiB)","style":{"code":true}}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"4b599928-f612-4ae6-9a47-119d8b49cbe7","type":"message","text":"But the first call to the constructor always take a lot of time, even if I dont restart the REPL...","user":"U7624B5U7","ts":"1616591739.032300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kL5v","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But the first call to the constructor always take a lot of time, even if I dont restart the REPL..."}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"4e8acafb-7d5f-4591-ba9b-35c160b57847","type":"message","text":"The first time is normal since it is compiling","user":"U01C3624SGJ","ts":"1616591824.032600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QXi8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The first time is normal since it is compiling"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"58e69d2d-74a5-4239-b4f0-3c56fe6feb34","type":"message","text":"are you re-running the script?","user":"UH24GRBLL","ts":"1616591832.032800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"p7UM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"are you re-running the script?"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"ab78ba39-98ce-414b-aea8-a92c34604939","type":"message","text":"<@U7HAYKY9X> was talking about a second `@time` in the same file","user":"UH24GRBLL","ts":"1616591856.033000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+Io","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U7HAYKY9X"},{"type":"text","text":" was talking about a second "},{"type":"text","text":"@time","style":{"code":true}},{"type":"text","text":" in the same file"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"8197a38b-23d8-42ce-a222-6abb89a8d959","type":"message","text":"I suspect this could be problem with how Julia handles keywords internally. Could you provide a minimal example that is copy-pastable?","user":"U7HAYKY9X","ts":"1616591983.033600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hgDL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I suspect this could be problem with how Julia handles keywords internally. Could you provide a minimal example that is copy-pastable?"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"6e856712-1335-47b0-b51f-b16809d8c093","type":"message","text":"Could it perhaps be that the anonymous function passed in is a new, unique type for every invokation, and that therefore causes it to recompile?\nIn any case, 1.5 second compilation is excessive. It's what you'd expect from compiling maybe 10,000 LOC.","user":"U7HAYKY9X","ts":"1616592217.034000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ic9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Could it perhaps be that the anonymous function passed in is a new, unique type for every invokation, and that therefore causes it to recompile?\nIn any case, 1.5 second compilation is excessive. It's what you'd expect from compiling maybe 10,000 LOC."}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"d269caf9-37b2-4f94-a9eb-6df8de29c79b","type":"message","text":"yeah, it seems to have been a combination of the Function and keywords.. I will try to make an MWE","user":"U7624B5U7","ts":"1616592798.035400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"74yE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah, it seems to have been a combination of the Function and keywords.. I will try to make an MWE"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"2fed98c8-a241-456f-bbae-688225623da3","type":"message","text":"Not as big affects here, but I think it still show the problem:\n\n```\n\nstruct MyStruct\n    set::Vector{Int}\n    func::Function\n    other::Vector{Int}\nend\n\nfunction MyStruct(; set::Vector{Int}, func::Function, other::Vector{Int})\n    return MyStruct(set, func, other)\nend\n\nfunction MyStruct2(set::Vector{Int}, func::Function, other::Vector{Int})\n    return MyStruct(set, func, other)\nend\n\n@time a1 = MyStruct(set = [1], func = (x)-&gt; [0.0], other = [1,2])\n@time a2 = MyStruct(set = [1], func = (x)-&gt; [0.0], other = [1,2])\n@time a3 = MyStruct2([1], (x)-&gt; [0.0], [1,2])\n@time a4 = MyStruct2([1], (x)-&gt; [0.0], [1,2])```\nResult\n```julia&gt; include(\"examples/test.jl\")\n  0.008310 seconds (12.41 k allocations: 864.262 KiB, 114.25% compilation time)\n  0.010905 seconds (11.39 k allocations: 788.387 KiB, 95.86% compilation time)\n  0.006331 seconds (1.38 k allocations: 98.742 KiB, 99.29% compilation time)\n  0.000042 seconds (28 allocations: 1.758 KiB)\nMyStruct([1], var\"#12#13\"(), [1, 2])\n\njulia&gt; include(\"examples/test.jl\")\n  0.017485 seconds (11.43 k allocations: 791.059 KiB, 96.30% compilation time)\n  0.020927 seconds (11.39 k allocations: 788.340 KiB, 95.41% compilation time)\n  0.008988 seconds (1.38 k allocations: 98.695 KiB, 99.34% compilation time)\n  0.000043 seconds (27 allocations: 1.711 KiB)\nMyStruct([1], var\"#21#22\"(), [1, 2])```","user":"U7624B5U7","ts":"1616593230.036200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1+P","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Not as big affects here, but I think it still show the problem:\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"\n\nstruct MyStruct\n    set::Vector{Int}\n    func::Function\n    other::Vector{Int}\nend\n\nfunction MyStruct(; set::Vector{Int}, func::Function, other::Vector{Int})\n    return MyStruct(set, func, other)\nend\n\nfunction MyStruct2(set::Vector{Int}, func::Function, other::Vector{Int})\n    return MyStruct(set, func, other)\nend\n\n@time a1 = MyStruct(set = [1], func = (x)-> [0.0], other = [1,2])\n@time a2 = MyStruct(set = [1], func = (x)-> [0.0], other = [1,2])\n@time a3 = MyStruct2([1], (x)-> [0.0], [1,2])\n@time a4 = MyStruct2([1], (x)-> [0.0], [1,2])"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Result\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> include(\"examples/test.jl\")\n  0.008310 seconds (12.41 k allocations: 864.262 KiB, 114.25% compilation time)\n  0.010905 seconds (11.39 k allocations: 788.387 KiB, 95.86% compilation time)\n  0.006331 seconds (1.38 k allocations: 98.742 KiB, 99.29% compilation time)\n  0.000042 seconds (28 allocations: 1.758 KiB)\nMyStruct([1], var\"#12#13\"(), [1, 2])\n\njulia> include(\"examples/test.jl\")\n  0.017485 seconds (11.43 k allocations: 791.059 KiB, 96.30% compilation time)\n  0.020927 seconds (11.39 k allocations: 788.340 KiB, 95.41% compilation time)\n  0.008988 seconds (1.38 k allocations: 98.695 KiB, 99.34% compilation time)\n  0.000043 seconds (27 allocations: 1.711 KiB)\nMyStruct([1], var\"#21#22\"(), [1, 2])"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"24e714c7-9e18-40ec-9399-8a78840a8afc","type":"message","text":"I dont know why why struct take 1sec though...","user":"U7624B5U7","ts":"1616593410.036400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XFIwA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I dont know why why struct take 1sec though..."}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"2bd6d80f-47f1-480b-8b41-20b7e9f6983e","type":"message","text":"Thank you. I'll make an issue, but I don't know if it's fixable","user":"U7HAYKY9X","ts":"1616593908.040500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rly","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thank you. I'll make an issue, but I don't know if it's fixable"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"38b275df-ec18-4250-86f1-33e0af8f74ef","type":"message","text":":+1:","user":"U7624B5U7","ts":"1616594068.040700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fiT","elements":[{"type":"rich_text_section","elements":[{"type":"emoji","name":"+1"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"ce14b770-4dd4-42a6-9b99-b06f18f20997","type":"message","text":"Okay, when looking a little closer, I think this might actually not be a bug","user":"U7HAYKY9X","ts":"1616594407.041400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"69/0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Okay, when looking a little closer, I think this might actually not be a bug"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"432f5827-1b5e-4191-b2a8-9c92926c0cff","type":"message","text":"The issue is that it's expected behaviour for functions to specialize on the types of their arguments","user":"U7HAYKY9X","ts":"1616594449.041600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4l1G","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The issue is that it's expected behaviour for functions to specialize on the types of their arguments"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"c9de90e5-274d-433a-9fd7-08016442b6c9","type":"message","text":"<https://github.com/JuliaLang/julia/issues/40167>","user":"U7HAYKY9X","ts":"1616594914.041800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"R1W","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://github.com/JuliaLang/julia/issues/40167"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"25529365-5aed-4445-8665-416850dfd3ba","type":"message","text":"To get around it for now, don't use keyword arguments for functions and types, unless you only use it with one function/type at each keyword position","user":"U7HAYKY9X","ts":"1616595012.042000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0xo1Z","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"To get around it for now, don't use keyword arguments for functions and types, unless you only use it with one function/type at each keyword position"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"}]