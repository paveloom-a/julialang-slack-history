[{"client_msg_id":"9ff4212b-4019-4cec-85e7-3ddbbc5be4bb","type":"message","text":"When I call a constructor for one of my structs, it takes almost 3sec to return, even though the function(constructor itself does very little. Using the`@time` macro says it spends 99.9% on compilation. The only possible problem I can see is that the struct has a type-parameter which itself has alot of type-parameters...can that slow things down?","user":"U7624B5U7","ts":"1616590485.028300","team":"T68168MUP","edited":{"user":"U7624B5U7","ts":"1616590507.000000"},"blocks":[{"type":"rich_text","block_id":"ViOaq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"When I call a constructor for one of my structs, it takes almost 3sec to return, even though the function(constructor itself does very little. Using the"},{"type":"text","text":"@time","style":{"code":true}},{"type":"text","text":" macro says it spends 99.9% on compilation. The only possible problem I can see is that the struct has a type-parameter which itself has alot of type-parameters...can that slow things down?"}]}]}],"thread_ts":"1616590485.028300","reply_count":18,"reply_users_count":4,"latest_reply":"1616592798.035400","reply_users":["U01C3624SGJ","U7HAYKY9X","U7624B5U7","UH24GRBLL"],"is_locked":false,"subscribed":false},{"client_msg_id":"bb71e52d-6138-4d7f-b6d2-7ca02d942078","type":"message","text":"What happens when you call the constructor again?","user":"U01C3624SGJ","ts":"1616590576.028500","team":"T68168MUP","edited":{"user":"U01C3624SGJ","ts":"1616590582.000000"},"blocks":[{"type":"rich_text","block_id":"n1ZX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What happens when you call the constructor again?"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"4c8d6743-de7d-49e1-9994-39eb8a49ffb2","type":"message","text":"A lot of type parameters can slow things down.. but 3 seconds is a lot. How many parameters are \"a lot\"? 20? 200? 2000?","user":"U7HAYKY9X","ts":"1616590631.029000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PJ9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"A lot of type parameters can slow things down.. but 3 seconds is a lot. How many parameters are \"a lot\"? 20? 200? 2000?"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"8f0e1c33-658c-4f58-8bac-ef3e5477fad8","type":"message","text":"The main struct has 1 parameter, and that strict has ~7 parameters. Some of the other typeparameters has like 2-3 parameter","user":"U7624B5U7","ts":"1616590739.029400","team":"T68168MUP","edited":{"user":"U7624B5U7","ts":"1616590847.000000"},"blocks":[{"type":"rich_text","block_id":"kKE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The main struct has 1 parameter, and that strict has ~7 parameters. Some of the other typeparameters has like 2-3 parameter"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"12201af1-7521-49a7-83e6-afdfc00de3bd","type":"message","text":"When I call the constructor again, it also takes a long time...","user":"U7624B5U7","ts":"1616590794.029700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nGwcH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"When I call the constructor again, it also takes a long time..."}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"f41bc63f-9301-4bb7-9b19-2939ae05b348","type":"message","text":"That's not normal. And I think you can have several tens of parameters before it becomes slow","user":"U7HAYKY9X","ts":"1616590884.030000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qFJsX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That's not normal. And I think you can have several tens of parameters before it becomes slow"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"79e93f1d-c19f-47c2-808e-77b909d3d83c","type":"message","text":"that's not a lot of type parameters","user":"UH24GRBLL","ts":"1616591030.030200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jFL8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that's not a lot of type parameters"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"948d45d2-ea32-42d2-9763-130c42508964","type":"message","text":"can you share the example that's slow?","user":"UH24GRBLL","ts":"1616591040.030400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TkMda","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"can you share the example that's slow?"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"e1dd3972-9ec0-4db6-8457-1142c41ada40","type":"message","text":"```  1.754029 seconds (70.18 k allocations: 4.566 MiB, 100.10% compilation time)\n  1.481718 seconds (69.89 k allocations: 4.633 MiB, 99.93% compilation time)```\nFirst and second call.. 100.10% lol","user":"U7624B5U7","ts":"1616591082.030600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"v6ab8","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"  1.754029 seconds (70.18 k allocations: 4.566 MiB, 100.10% compilation time)\n  1.481718 seconds (69.89 k allocations: 4.633 MiB, 99.93% compilation time)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"First and second call.. 100.10% lol"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"8972ba85-de3e-4199-ac53-abf299710f47","type":"message","text":"```struct MyStruct{P&lt;:Shell} &lt;: Five.AbstractExternalForce\n    faceset::Vector{VertexInterfaceIndex}\n    prescribed_displacement::Function\n    components::Vector{Int}\n    shell::Base.RefValue{P}\n    penalty::Float64\nend\n\nfunction MyStruct(; \n    set, \n    func::Function,\n    comps::AbstractVector{Int}, \n    shell::Shell{dim_p,dim_s,T}, #has more typeparameters...\n    penalty::T\n    ) where {dim_p,dim_s,T}\n    \n    @assert( length(comps) == length(func(zero(Vec{dim_s,T}), 0.0)) )\n\n    return MyStruct{typeof(shell)}(collect(set), func, collect(comps), Base.RefValue(shell), penalty)\nend\n\n#call:\n@time begin\netf = MyStruct( \n    set = edgeset,\n    func = (x,t) -&gt; [0.0], \n    comps = [DIM],\n    shell = shell, \n    penalty = 1e8\n)\nend```","user":"U7624B5U7","ts":"1616591307.030800","team":"T68168MUP","edited":{"user":"U7624B5U7","ts":"1616591456.000000"},"blocks":[{"type":"rich_text","block_id":"JPQ","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"struct MyStruct{P<:Shell} <: Five.AbstractExternalForce\n    faceset::Vector{VertexInterfaceIndex}\n    prescribed_displacement::Function\n    components::Vector{Int}\n    shell::Base.RefValue{P}\n    penalty::Float64\nend\n\nfunction MyStruct(; \n    set, \n    func::Function,\n    comps::AbstractVector{Int}, \n    shell::Shell{dim_p,dim_s,T}, #has more typeparameters...\n    penalty::T\n    ) where {dim_p,dim_s,T}\n    \n    @assert( length(comps) == length(func(zero(Vec{dim_s,T}), 0.0)) )\n\n    return MyStruct{typeof(shell)}(collect(set), func, collect(comps), Base.RefValue(shell), penalty)\nend\n\n#call:\n@time begin\netf = MyStruct( \n    set = edgeset,\n    func = (x,t) -> [0.0], \n    comps = [DIM],\n    shell = shell, \n    penalty = 1e8\n)\nend"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"6f391ceb-6866-4579-9ce2-268588098c3a","type":"message","text":"I experimented with removing the RefValues, but that did not change anything","user":"U7624B5U7","ts":"1616591351.031000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4DC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I experimented with removing the RefValues, but that did not change anything"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"c52d3180-e18d-4f74-a00b-54e995494329","type":"message","text":"Hmm, if i remove the keyword arguments it becomes much better:\n`0.954794 seconds (11.01 k allocations: 792.492 KiB, 99.96% compilation time)`\n  `0.000036 seconds (26 allocations: 5.602 KiB)`","user":"U7624B5U7","ts":"1616591659.031900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ECwG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm, if i remove the keyword arguments it becomes much better:\n"},{"type":"text","text":"0.954794 seconds (11.01 k allocations: 792.492 KiB, 99.96% compilation time)","style":{"code":true}},{"type":"text","text":"\n"},{"type":"text","text":"  0.000036 seconds (26 allocations: 5.602 KiB)","style":{"code":true}}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"4b599928-f612-4ae6-9a47-119d8b49cbe7","type":"message","text":"But the first call to the constructor always take a lot of time, even if I dont restart the REPL...","user":"U7624B5U7","ts":"1616591739.032300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kL5v","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But the first call to the constructor always take a lot of time, even if I dont restart the REPL..."}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"4e8acafb-7d5f-4591-ba9b-35c160b57847","type":"message","text":"The first time is normal since it is compiling","user":"U01C3624SGJ","ts":"1616591824.032600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QXi8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The first time is normal since it is compiling"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"58e69d2d-74a5-4239-b4f0-3c56fe6feb34","type":"message","text":"are you re-running the script?","user":"UH24GRBLL","ts":"1616591832.032800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"p7UM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"are you re-running the script?"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"ab78ba39-98ce-414b-aea8-a92c34604939","type":"message","text":"<@U7HAYKY9X> was talking about a second `@time` in the same file","user":"UH24GRBLL","ts":"1616591856.033000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+Io","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U7HAYKY9X"},{"type":"text","text":" was talking about a second "},{"type":"text","text":"@time","style":{"code":true}},{"type":"text","text":" in the same file"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"8197a38b-23d8-42ce-a222-6abb89a8d959","type":"message","text":"I suspect this could be problem with how Julia handles keywords internally. Could you provide a minimal example that is copy-pastable?","user":"U7HAYKY9X","ts":"1616591983.033600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hgDL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I suspect this could be problem with how Julia handles keywords internally. Could you provide a minimal example that is copy-pastable?"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"6e856712-1335-47b0-b51f-b16809d8c093","type":"message","text":"Could it perhaps be that the anonymous function passed in is a new, unique type for every invokation, and that therefore causes it to recompile?\nIn any case, 1.5 second compilation is excessive. It's what you'd expect from compiling maybe 10,000 LOC.","user":"U7HAYKY9X","ts":"1616592217.034000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ic9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Could it perhaps be that the anonymous function passed in is a new, unique type for every invokation, and that therefore causes it to recompile?\nIn any case, 1.5 second compilation is excessive. It's what you'd expect from compiling maybe 10,000 LOC."}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"},{"client_msg_id":"d269caf9-37b2-4f94-a9eb-6df8de29c79b","type":"message","text":"yeah, it seems to have been a combination of the Function and keywords.. I will try to make an MWE","user":"U7624B5U7","ts":"1616592798.035400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"74yE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah, it seems to have been a combination of the Function and keywords.. I will try to make an MWE"}]}]}],"thread_ts":"1616590485.028300","parent_user_id":"U7624B5U7"}]