[{"client_msg_id":"d8eb6159-9421-4840-8025-c760d057558d","type":"message","text":"PackageCompiler doesn't seem to precompile `@printf` calls from my module `X` when I do `create_sysimage(:X, ...)`.  I still see printf precompile calls when I run julia with `--trace-compile=stderr`. Is this a known issue or am I doing something wrong?","user":"U66N673NV","ts":"1617242959.173200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"sExqt","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"PackageCompiler doesn't seem to precompile "},{"type":"text","text":"@printf","style":{"code":true}},{"type":"text","text":" calls from my module "},{"type":"text","text":"X","style":{"code":true}},{"type":"text","text":" when I do "},{"type":"text","text":"create_sysimage(:X, ...)","style":{"code":true}},{"type":"text","text":".  I still see printf precompile calls when I run julia with "},{"type":"text","text":"--trace-compile=stderr","style":{"code":true}},{"type":"text","text":". Is this a known issue or am I doing something wrong?"}]}]}],"thread_ts":"1617242959.173200","reply_count":10,"reply_users_count":3,"latest_reply":"1617282083.192000","reply_users":["UAUPJLBQX","U66N673NV","U67D54KS8"],"is_locked":false,"subscribed":false},{"client_msg_id":"f7d35f06-d28b-4305-aff5-a241595d0946","type":"message","text":"Does the script you give PackageCompiler just lost your module, or does it also call the functions using `@printf`?","user":"UAUPJLBQX","ts":"1617243975.173300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Flh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Does the script you give PackageCompiler just lost your module, or does it also call the functions using "},{"type":"text","text":"@printf","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1617242959.173200","parent_user_id":"U66N673NV"},{"client_msg_id":"2e62ebf1-9fa8-4ca1-ab3a-3be037101aaa","type":"message","text":"It looks like the issue is related to <https://github.com/JuliaLang/PackageCompiler.jl/pull/354> and linked issues. `@printf` doesn't print to a TTY when creating the sysimage, so it needs to compile when called for real. <@U67D54KS8> was this issue resolved somehow?","user":"U66N673NV","ts":"1617244098.173500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+a3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It looks like the issue is related to "},{"type":"link","url":"https://github.com/JuliaLang/PackageCompiler.jl/pull/354"},{"type":"text","text":" and linked issues. "},{"type":"text","text":"@printf","style":{"code":true}},{"type":"text","text":" doesn't print to a TTY when creating the sysimage, so it needs to compile when called for real. "},{"type":"user","user_id":"U67D54KS8"},{"type":"text","text":" was this issue resolved somehow?"}]}]}],"thread_ts":"1617242959.173200","parent_user_id":"U66N673NV"},{"client_msg_id":"250023cd-1e0f-4da0-b208-6ac76371e684","type":"message","text":"<https://github.com/JuliaLang/PackageCompiler.jl/commit/929657b22f3350ff1ed631ceb27dc6a715ef9a37> might have fixed it as a side-effect.","user":"U67D54KS8","ts":"1617258112.176100","team":"T68168MUP","edited":{"user":"U67D54KS8","ts":"1617258126.000000"},"blocks":[{"type":"rich_text","block_id":"CunO","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://github.com/JuliaLang/PackageCompiler.jl/commit/929657b22f3350ff1ed631ceb27dc6a715ef9a37"},{"type":"text","text":" might have fixed it as a side-effect."}]}]}],"thread_ts":"1617242959.173200","parent_user_id":"U66N673NV"},{"client_msg_id":"2ad8cbf9-453f-4fef-98dd-79f4f1e5986b","type":"message","text":"I'll make a new release and you can try it out","user":"U67D54KS8","ts":"1617258244.176400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QoBFm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'll make a new release and you can try it out"}]}]}],"thread_ts":"1617242959.173200","parent_user_id":"U66N673NV"},{"client_msg_id":"873717f3-d9a8-419f-ae5c-0561e12a2299","type":"message","text":"Hmm, I tried this out but no luck. I'm still seeing lines like: `precompile(Tuple{typeof(Printf.format), Base.TTY, Printf.Format{Base.CodeUnits{UInt8, String}, Tuple{Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}}}, Float64, Float64, Vararg{Float64, N} where N})` for code that was already run in the precompile script","user":"U66N673NV","ts":"1617279856.190400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"L5P","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm, I tried this out but no luck. I'm still seeing lines like: "},{"type":"text","text":"precompile(Tuple{typeof(Printf.format), Base.TTY, Printf.Format{Base.CodeUnits{UInt8, String}, Tuple{Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}}}, Float64, Float64, Vararg{Float64, N} where N})","style":{"code":true}},{"type":"text","text":" for code that was already run in the precompile script"}]}]}],"thread_ts":"1617242959.173200","parent_user_id":"U66N673NV"},{"client_msg_id":"fd33a07f-e37f-47a6-9af1-7d4575189c39","type":"message","text":"If you take that line, copy paste it into a file and pass that file as a `precompile_statements_file=\"file.jl\"` kwarg to `create_sysimage` does it still happen? That would determine if the recording of the signature is the problem or the \"stickyness\" of running it.","user":"U67D54KS8","ts":"1617280085.191000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"X5OH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If you take that line, copy paste it into a file and pass that file as a "},{"type":"text","text":"precompile_statements_file=\"file.jl\"","style":{"code":true}},{"type":"text","text":" kwarg to "},{"type":"text","text":"create_sysimage","style":{"code":true}},{"type":"text","text":" does it still happen? That would determine if the recording of the signature is the problem or the \"stickyness\" of running it."}]}]}],"thread_ts":"1617242959.173200","parent_user_id":"U66N673NV"},{"client_msg_id":"dcfe7773-9d04-422d-b90e-2e688a4032ae","type":"message","text":"It still happens, unless I did something wrong.","user":"U66N673NV","ts":"1617280564.191400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vaC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It still happens, unless I did something wrong."}]}]}],"thread_ts":"1617242959.173200","parent_user_id":"U66N673NV"},{"client_msg_id":"8bd80904-de36-4ca9-9431-552d1f5b8968","type":"message","text":"Ah,\n\n```julia&gt; precompile(Tuple{typeof(Printf.format), Base.TTY, Printf.Format{Base.CodeUnits{UInt8, String}, Tuple{Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}}}, Float64, Float64, Vararg{Float64, N} where N})\nERROR: Base.CodePointError{UInt32}(0x67000000)\nStacktrace:\n [1] code_point_err(u::UInt32)\n   @ Base ./char.jl:86\n [2] Char(u::UInt32)\n   @ Base ./char.jl:160\n [3] top-level scope\n   @ REPL[3]:1```\nSo I think this is actually <https://github.com/JuliaLang/julia/issues/28808>","user":"U67D54KS8","ts":"1617281012.191600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"c21","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah,\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> precompile(Tuple{typeof(Printf.format), Base.TTY, Printf.Format{Base.CodeUnits{UInt8, String}, Tuple{Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}, Printf.Spec{Base.Val{Char(0x67000000)}}}}, Float64, Float64, Vararg{Float64, N} where N})\nERROR: Base.CodePointError{UInt32}(0x67000000)\nStacktrace:\n [1] code_point_err(u::UInt32)\n   @ Base ./char.jl:86\n [2] Char(u::UInt32)\n   @ Base ./char.jl:160\n [3] top-level scope\n   @ REPL[3]:1"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"\nSo I think this is actually "},{"type":"link","url":"https://github.com/JuliaLang/julia/issues/28808"}]}]}],"thread_ts":"1617242959.173200","parent_user_id":"U66N673NV"},{"client_msg_id":"b1d345f2-69bc-43b8-a65f-04ce44e18e02","type":"message","text":"<https://github.com/JuliaLang/julia/pull/32610> is WIP to fix this","user":"U67D54KS8","ts":"1617281150.191800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ls4","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://github.com/JuliaLang/julia/pull/32610"},{"type":"text","text":" is WIP to fix this"}]}]}],"thread_ts":"1617242959.173200","parent_user_id":"U66N673NV"},{"client_msg_id":"05fb789e-c3f4-48ba-903f-1be16e35c53f","type":"message","text":"Got it, thanks for the pointers!","user":"U66N673NV","ts":"1617282083.192000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"EFBw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Got it, thanks for the pointers!"}]}]}],"thread_ts":"1617242959.173200","parent_user_id":"U66N673NV"}]