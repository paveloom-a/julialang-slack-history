[{"client_msg_id":"5980c7ed-8447-4922-a871-f43d5c0d2832","type":"message","text":"Some thread-safety help please: I have the following function\n\n```function myfun(x_vec::Vector{MyType}, δ::Matrix{Float64}, buffer)\n\n    ∑x = 0.0\n\n    Threads.@threads for i ∈ 1:length(x_vec)\n        ∑x += sum(my_other_fun(x_vec[i], δ[i, :])[3])\n    end\n\n    return ∑x\nend```\nwhich works fine unthreaded but comes out incorrectly when I add `@threads`. Any ideas what might throw it off without seeing `my_other_fun`?","user":"U7JQGPGCQ","ts":"1608310177.450000","team":"T68168MUP","edited":{"user":"U7JQGPGCQ","ts":"1608310199.000000"},"blocks":[{"type":"rich_text","block_id":"vfvHk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Some thread-safety help please: I have the following function\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function myfun(x_vec::Vector{MyType}, δ::Matrix{Float64}, buffer)\n\n    ∑x = 0.0\n\n    Threads.@threads for i ∈ 1:length(x_vec)\n        ∑x += sum(my_other_fun(x_vec[i], δ[i, :])[3])\n    end\n\n    return ∑x\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"which works fine unthreaded but comes out incorrectly when I add "},{"type":"text","text":"@threads","style":{"code":true}},{"type":"text","text":". Any ideas what might throw it off without seeing "},{"type":"text","text":"my_other_fun","style":{"code":true}},{"type":"text","text":"?"}]}]}],"thread_ts":"1608310177.450000","reply_count":70,"reply_users_count":4,"latest_reply":"1608313549.467200","reply_users":["UH24GRBLL","U7JQGPGCQ","UDB26738Q","U01GRS159T8"],"subscribed":false},{"client_msg_id":"2a9f1515-c4e9-4c1b-91ca-d4935745ddbf","type":"message","text":"the accumulation is racy","user":"UH24GRBLL","ts":"1608310207.450200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XN19","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the accumulation is racy"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"7926a0c9-3d71-4837-a4ee-1d558dfa4012","type":"message","text":"you probably want an accumulator per thread (i.e. accumulate into an array indexed by `threadid()`)","user":"UH24GRBLL","ts":"1608310227.450400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3/2l6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you probably want an accumulator per thread (i.e. accumulate into an array indexed by "},{"type":"text","text":"threadid()","style":{"code":true}},{"type":"text","text":")"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"f0f886f1-f49a-4c2d-a818-96ae72c4e2a7","type":"message","text":"and then sum that array at the end again","user":"UH24GRBLL","ts":"1608310233.450600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1xK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and then sum that array at the end again"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"43442554-57e8-4ddf-90a9-8517923e324f","type":"message","text":"I assume you do not mean `lively, entertaining, and typically sexually titillating`","user":"U7JQGPGCQ","ts":"1608310248.450800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"r2AX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I assume you do not mean "},{"type":"text","text":"lively, entertaining, and typically sexually titillating","style":{"code":true}}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ","reactions":[{"name":"joy","users":["UD0NS8PDF"],"count":1}]},{"client_msg_id":"30f5d862-cad2-4259-ae96-93c9427df33f","type":"message","text":"no, I mean that access to `sigmax` depends on race conditions","user":"UH24GRBLL","ts":"1608310270.451200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0wPf","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"no, I mean that access to "},{"type":"text","text":"sigmax","style":{"code":true}},{"type":"text","text":" depends on race conditions"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"c2a6dc06-e90b-4b1e-9a8d-55b754a1a5d8","type":"message","text":"Haha yes sorry that was a bad joke","user":"U7JQGPGCQ","ts":"1608310281.451600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3r6Zd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Haha yes sorry that was a bad joke"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"aa2df36f-3d99-4b61-92e6-c71ee7cd30b8","type":"message","text":"but I do think such access is very lively :p","user":"UH24GRBLL","ts":"1608310292.451800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/+wm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but I do think such access is very lively :p"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"16d93f29-1a57-4637-9910-94cdfb188ddc","type":"message","text":"Turns out I don't understand race conditions - I thought this was a problem when things can be overwritten, but here I'm just adding to a single number, how can that go wrong?","user":"U7JQGPGCQ","ts":"1608310318.452000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"SqXC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Turns out I don't understand race conditions - I thought this was a problem when things can be overwritten, but here I'm just adding to a single number, how can that go wrong?"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"ba3285d5-2c73-4d90-94a1-8b4f4b21feca","type":"message","text":"```∑x = zeros(nthreads())\nThreads.@threads for i ∈ 1:length(x_vec)\n    ∑x[threadid()] += sum(my_other_fun(x_vec[i], δ[i, :])[3])\nend\nreturn sum(∑x)```","user":"UDB26738Q","ts":"1608310323.452200","team":"T68168MUP","edited":{"user":"UDB26738Q","ts":"1608310359.000000"},"blocks":[{"type":"rich_text","block_id":"cW6v","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"∑x = zeros(nthreads())\nThreads.@threads for i ∈ 1:length(x_vec)\n    ∑x[threadid()] += sum(my_other_fun(x_vec[i], δ[i, :])[3])\nend\nreturn sum(∑x)"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ","reactions":[{"name":"heavy_check_mark","users":["U7JQGPGCQ"],"count":1}]},{"client_msg_id":"fbf019a3-bc63-44a0-ad54-6f0f96531430","type":"message","text":"the number has to be loaded on all threads","user":"UH24GRBLL","ts":"1608310336.452600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RPr6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the number has to be loaded on all threads"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"2c525e17-4921-4269-8842-3e8c9ab844ae","type":"message","text":"if two threads simultaneously load the number, calculate the result, add it to their copy, and write it back, one is goingto overwrite the result of the other","user":"UH24GRBLL","ts":"1608310367.452900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vcgh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if two threads simultaneously load the number, calculate the result, add it to their copy, and write it back, one is goingto overwrite the result of the other"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"54864ebd-0413-4504-83cd-804cbd81a10c","type":"message","text":"if they both load their own copy (as they have different slots in the array), they don't overwrite each other","user":"UH24GRBLL","ts":"1608310399.453200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"sCB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if they both load their own copy (as they have different slots in the array), they don't overwrite each other"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"482926fa-37ec-478a-84d4-a5d155b618f9","type":"message","text":"Ah right, I didn't know that numbers get \"loaded\" onto separate threads","user":"U7JQGPGCQ","ts":"1608310407.453400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Iw3Jn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah right, I didn't know that numbers get \"loaded\" onto separate threads"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"cfcf4a32-6970-4a07-807e-854cafb11bea","type":"message","text":"and thanks Mose, that does the trick!","user":"U7JQGPGCQ","ts":"1608310428.453600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9Gl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and thanks Mose, that does the trick!"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"f6aaf416-d8e0-4780-b3ac-d01d4cb223b7","type":"message","text":"you might want to learn some more about how threads work, if that's the case","user":"UH24GRBLL","ts":"1608310431.453800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QnUP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you might want to learn some more about how threads work, if that's the case"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"39bcf0c0-8efd-4afa-b2d1-229c063d37f2","type":"message","text":"Yes, that's probably good advice","user":"U7JQGPGCQ","ts":"1608310471.454200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"y7OiX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes, that's probably good advice"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"08b8a362-19f6-4142-b93d-1451679a8eeb","type":"message","text":"I thought threads were shared memory (in contrast to my usual go-to multiprocess, `SharedArray` parallelism)","user":"U7JQGPGCQ","ts":"1608310505.454600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"LuoOs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I thought threads were shared memory (in contrast to my usual go-to multiprocess, "},{"type":"text","text":"SharedArray","style":{"code":true}},{"type":"text","text":" parallelism)"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"a51afe12-6250-4164-b533-8d905afff580","type":"message","text":"and that therefore these issues of separate copies of objects wouldn't arise","user":"U7JQGPGCQ","ts":"1608310524.454800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qbKEf","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and that therefore these issues of separate copies of objects wouldn't arise"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"ba20649e-9e9d-4bc1-9820-fa2a612e1a57","type":"message","text":"well, they do share memory, and that's precisely the problem","user":"UH24GRBLL","ts":"1608310529.455000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"lgJJ9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"well, they do share memory, and that's precisely the problem"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"242169e8-8147-45be-94b8-d2158fb9dae6","type":"message","text":"but clearly that was the wrong mental model","user":"U7JQGPGCQ","ts":"1608310529.455200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DBczk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but clearly that was the wrong mental model"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"1e6f6754-376f-4b63-9d05-1053d035fbe6","type":"message","text":"they do share memory, but different operations try to read/write the same memory","user":"UDB26738Q","ts":"1608310544.455400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"W25","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"they do share memory, but different operations try to read/write the same memory"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"47ffb762-93c3-4882-a936-94b484991874","type":"message","text":"it's just that concurrent actors that don't synchronize state before writing will overwrite each others results","user":"UH24GRBLL","ts":"1608310559.455600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"SVvD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's just that concurrent actors that don't synchronize state before writing will overwrite each others results"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"8576d559-fda5-4bdb-ae87-d07167eca471","type":"message","text":"btw my runtime went from 160ms to 190ms, and allocations went up by 50% with your solution Mose, but I suppose that's a small price to pay for getting correct results instead of random numbers :smile:","user":"U7JQGPGCQ","ts":"1608310598.455800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gyvP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"btw my runtime went from 160ms to 190ms, and allocations went up by 50% with your solution Mose, but I suppose that's a small price to pay for getting correct results instead of random numbers "},{"type":"emoji","name":"smile"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"b274554d-990a-471c-a430-98162678c6c7","type":"message","text":"and since synchronization is expensive, it's easier &amp; faster to give each thread their own little accumulator memory and sum that at the end in a single thread","user":"UH24GRBLL","ts":"1608310603.456000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5wqH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and since synchronization is expensive, it's easier & faster to give each thread their own little accumulator memory and sum that at the end in a single thread"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"4f9d5fbe-12f7-4c8e-a479-93a295e36b3d","type":"message","text":"makes sense, thanks for the explanation!","user":"U7JQGPGCQ","ts":"1608310618.456200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"C=N","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"makes sense, thanks for the explanation!"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"53049db7-c5e5-4c58-bd70-2e64836e8b56","type":"message","text":"well, threads have overhead, it's probably not worth it for things on the order of &lt;0.2 seconds :sweat_smile:","user":"UH24GRBLL","ts":"1608310630.456400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3nROb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"well, threads have overhead, it's probably not worth it for things on the order of <0.2 seconds "},{"type":"emoji","name":"sweat_smile"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"8cd84414-e814-4150-94ce-fe6189ce5d61","type":"message","text":"Well it's still a more than 50% speedup compared to serial (which is ~420ms), and I'll have to call this function a few thousands times so halving the runtime is no mean feat!","user":"U7JQGPGCQ","ts":"1608310683.456600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Zw9=q","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Well it's still a more than 50% speedup compared to serial (which is ~420ms), and I'll have to call this function a few thousands times so halving the runtime is no mean feat!"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"1b28c6cc-267e-42b5-9347-3e8b52368e5b","type":"message","text":"oh yeah, in that case it's worth it","user":"UH24GRBLL","ts":"1608310699.456800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"L7lz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh yeah, in that case it's worth it"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"dc580365-84fb-4e82-b862-39b9cb16dd2b","type":"message","text":"multithreading is usually one of the last things I look at, well after getting the most out of serial execution I can","user":"UH24GRBLL","ts":"1608310727.457200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ns13g","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"multithreading is usually one of the last things I look at, well after getting the most out of serial execution I can"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"04c9117c-ec51-4cbc-ad4e-2e86b4011845","type":"message","text":"so if your inner hot function allocates a lot - it probably won't benefit from multithreading as much as it could","user":"UH24GRBLL","ts":"1608310751.457400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"P9q","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so if your inner hot function allocates a lot - it probably won't benefit from multithreading as much as it could"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"197cb37f-87f6-41e7-964b-103c4d0f85cf","type":"message","text":"Yes I spent quite a bit of time with `@btime` already today to get the serial execution down","user":"U7JQGPGCQ","ts":"1608310764.457600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7DFNu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes I spent quite a bit of time with "},{"type":"text","text":"@btime","style":{"code":true}},{"type":"text","text":" already today to get the serial execution down"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"0e3eaacd-7be8-457c-a983-956fdabb94f6","type":"message","text":"Well actually now that you say it the allocations are still a bit of puzzle","user":"U7JQGPGCQ","ts":"1608310815.458000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/6oMc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Well actually now that you say it the allocations are still a bit of puzzle"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"73b6fb85-9f44-4f37-bd2b-84cdb67e1bb0","type":"message","text":"as the `@btime` output for `my_other_fun` is `4.414 μs (8 allocations: 7.02 KiB)`","user":"U7JQGPGCQ","ts":"1608310830.458200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"JM8Bj","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"as the "},{"type":"text","text":"@btime","style":{"code":true}},{"type":"text","text":" output for "},{"type":"text","text":"my_other_fun","style":{"code":true}},{"type":"text","text":" is "},{"type":"text","text":"4.414 μs (8 allocations: 7.02 KiB)","style":{"code":true}}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"f91e3d1f-585a-48f8-aa36-a6d290e9c10d","type":"message","text":"well then it's time to figure out where those 8 allocations are coming from ^^","user":"UH24GRBLL","ts":"1608310848.458400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"I0Oo4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"well then it's time to figure out where those 8 allocations are coming from ^^"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"a2fee805-6c6b-486c-85d4-4be5c29401be","type":"message","text":"and if you can avoid them and if avoiding them makes your code any faster","user":"UH24GRBLL","ts":"1608310877.458600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"y32Au","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and if you can avoid them and if avoiding them makes your code any faster"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"ed63d215-fcca-4760-a100-dd4651c16d9f","type":"message","text":"Is there something reliable for tracking down allocations at this point? I haven't tried for a long time but remember it used to be quite hard to assign allocations to any specific line of code","user":"U7JQGPGCQ","ts":"1608310930.458800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"11bjm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is there something reliable for tracking down allocations at this point? I haven't tried for a long time but remember it used to be quite hard to assign allocations to any specific line of code"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"77fd9506-8131-4b82-bf85-ecf8213699fe","type":"message","text":"BTW, <https://www.youtube.com/watch?v=7ENFeb-J75k> is a good introduction to multithreading and the problems that may arise","user":"UH24GRBLL","ts":"1608310932.459000","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1608310936.000000"},"blocks":[{"type":"rich_text","block_id":"ulmWv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"BTW, "},{"type":"link","url":"https://www.youtube.com/watch?v=7ENFeb-J75k"},{"type":"text","text":" is a good introduction to multithreading and the problems that may arise"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"fa28a35b-9181-41d2-8379-fe9bce282a80","type":"message","text":"Hmm, ProfileView.jl can show that I think","user":"UH24GRBLL","ts":"1608310948.459400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Mrje7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm, ProfileView.jl can show that I think"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"54944ef9-3ba4-4f9d-bf6f-2e088a2e7e3d","type":"message","text":"the way I usually do it is knowing what allocates and avoiding doing that, but that doesn't scale to other people I'm afraid :sweat_smile:","user":"UH24GRBLL","ts":"1608310987.459600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"mbdx","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the way I usually do it is knowing what allocates and avoiding doing that, but that doesn't scale to other people I'm afraid "},{"type":"emoji","name":"sweat_smile"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"d05a8aa5-ce53-4f5f-8ee3-2a61b0d0a45e","type":"message","text":"you can use track-allocations","user":"U01GRS159T8","ts":"1608311003.459800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"KYwzL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you can use track-allocations"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"e4cf4b5e-eb47-467b-8beb-050c4ba89df7","type":"message","text":"yes, that too","user":"UH24GRBLL","ts":"1608311011.460000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/hNRA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yes, that too"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"b0d693f0-be0d-411c-8194-a4bad54aa9d0","type":"message","text":"```and also put @time macros on suspect places```","user":"U01GRS159T8","ts":"1608311015.460400","team":"T68168MUP","edited":{"user":"U01GRS159T8","ts":"1608311074.000000"},"blocks":[{"type":"rich_text","block_id":"RjJ","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"and also put @time macros on suspect places"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"5a3571cc-9ae4-48d0-8cda-414512824713","type":"message","text":"surely you mean `@time` and `@allocated`","user":"UH24GRBLL","ts":"1608311047.460600","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1608311053.000000"},"blocks":[{"type":"rich_text","block_id":"2VgOu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"surely you mean "},{"type":"text","text":"@time","style":{"code":true}},{"type":"text","text":" and "},{"type":"text","text":"@allocated","style":{"code":true}}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"89ecb453-5459-453e-b9ed-dd7fd78093e1","type":"message","text":"Cool, will try that, and probably call into <#CF53T1DU4|performance-helpdesk> at some point","user":"U7JQGPGCQ","ts":"1608311050.460800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"dlDC","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Cool, will try that, and probably call into "},{"type":"channel","channel_id":"CF53T1DU4"},{"type":"text","text":" at some point"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"18116785-a112-452a-8cfa-84b1bb4c58b4","type":"message","text":"fcuking hell I hate trying to type macxros into slack","user":"U01GRS159T8","ts":"1608311084.461200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zgX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"fcuking hell I hate trying to type macxros into slack"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"ddaf453e-74c6-41be-a9eb-20cd11c2d8d3","type":"message","text":"inline code with ` is your friend :)","user":"UH24GRBLL","ts":"1608311106.461400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"SKsJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"inline code with ` is your friend :)"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"a373d1d1-f3c7-483c-b954-da8d4097051a","type":"message","text":"hm it looks like one allocation comes from this final line:\n```return payment, total_cf_vec, δ.*total_cf_vec```","user":"U7JQGPGCQ","ts":"1608311305.461700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"CBo/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hm it looks like one allocation comes from this final line:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"return payment, total_cf_vec, δ.*total_cf_vec"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"b18b206c-509c-41b9-a0dd-0557f7f2bdb0","type":"message","text":"the `δ.*total_cf_vec` allocates","user":"U7JQGPGCQ","ts":"1608311316.461900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gpV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the "},{"type":"text","text":"δ.*total_cf_vec","style":{"code":true}},{"type":"text","text":" allocates"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"acecc427-59ef-45be-944d-ec1f21d3501b","type":"message","text":"yep","user":"UH24GRBLL","ts":"1608311347.462100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"LjS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yep"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"51199b02-8821-416a-abf3-a327b31de8f2","type":"message","text":"the broadcast has to be manifested","user":"UH24GRBLL","ts":"1608311357.462300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+yw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the broadcast has to be manifested"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"e92b6c02-9aa3-4034-8dd0-805c2712e0dd","type":"message","text":"other things to look out for are `y = [ x for x in ... ]`","user":"UH24GRBLL","ts":"1608311379.462500","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1608311394.000000"},"blocks":[{"type":"rich_text","block_id":"oE6iQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"other things to look out for are "},{"type":"text","text":"y = [ x for x in ... ]","style":{"code":true}}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"21f65afb-7732-4382-9638-83cd90e92fbd","type":"message","text":"ha, I've managed to eliminate all but 1 allocation, but at the cost of increasing runtime by 30%","user":"U7JQGPGCQ","ts":"1608311940.462900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"dZbi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ha, I've managed to eliminate all but 1 allocation, but at the cost of increasing runtime by 30%"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"87111ec4-a0d2-49a1-b0d9-da1194ca29a6","type":"message","text":"well that's not good","user":"UH24GRBLL","ts":"1608312068.463100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hT7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"well that's not good"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"6bd389c9-7018-46bb-9d7e-ad224da8eff0","type":"message","text":"you wanted speeeeed :gotta-go-fast:","user":"UH24GRBLL","ts":"1608312072.463300","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1608312083.000000"},"blocks":[{"type":"rich_text","block_id":"w8E","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you wanted speeeeed "},{"type":"emoji","name":"gotta-go-fast"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"684e25ce-8d54-47e5-8d78-bccf96f3e01f","type":"message","text":"sometimes, allocating isn't bad because it can improve locality","user":"UH24GRBLL","ts":"1608312107.463600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zOMP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"sometimes, allocating isn't bad because it can improve locality"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"98e84d7f-31c6-43a5-a1fc-edf7dbcf699a","type":"message","text":"but most of the time, allocating costs more than it is worth, so preallocating and using buffers is the way to go","user":"UH24GRBLL","ts":"1608312135.463800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kE4LB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but most of the time, allocating costs more than it is worth, so preallocating and using buffers is the way to go"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"88ceefaf-a201-47f8-9a5b-bff2e5b2aa69","type":"message","text":"yes here it was the difference between:\n```ra = cumprod((1 .- pd) .* (1 .- pp))\n\n    @inbounds for t ∈ 1:ttm\n        # use ra[t] in the loop```\nand computing `ra = @views prod( (1 - pd[x])*(1-pp(x)) for x in 1:t)` in the loop for each `t`","user":"U7JQGPGCQ","ts":"1608312200.464000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kO=A","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yes here it was the difference between:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"ra = cumprod((1 .- pd) .* (1 .- pp))\n\n    @inbounds for t ∈ 1:ttm\n        # use ra[t] in the loop"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"and computing "},{"type":"text","text":"ra = @views prod( (1 - pd[x])*(1-pp(x)) for x in 1:t)","style":{"code":true}},{"type":"text","text":" in the loop for each "},{"type":"text","text":"t","style":{"code":true}}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"04ab1fce-a93c-4636-aac5-d5d1806bb587","type":"message","text":"seemed silly to me even before I tried it, but it did get rid of the allocations :smile:","user":"U7JQGPGCQ","ts":"1608312217.464200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4gv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"seemed silly to me even before I tried it, but it did get rid of the allocations "},{"type":"emoji","name":"smile"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"c1a2f675-0222-4ea4-93cd-d9956938da51","type":"message","text":"`cumprod` allocates, true","user":"UH24GRBLL","ts":"1608312786.464400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+BG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"cumprod","style":{"code":true}},{"type":"text","text":" allocates, true"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"6689f13d-92ac-45f9-8baa-8735f5115afa","type":"message","text":"but `cumprod!` doesn't","user":"UH24GRBLL","ts":"1608312792.464600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1grS5","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but "},{"type":"text","text":"cumprod!","style":{"code":true}},{"type":"text","text":" doesn't"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"8bcf1084-0666-43d9-9b9e-b2dfc6df1b95","type":"message","text":"so if you have some buffer prepared, you can keep the speed and keep the cumprod, I think","user":"UH24GRBLL","ts":"1608312829.464800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0EqPZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so if you have some buffer prepared, you can keep the speed and keep the cumprod, I think"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"7d3d9247-7594-45e7-8960-d341325f6de2","type":"message","text":"ah, that makes sense","user":"U7JQGPGCQ","ts":"1608313076.465000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"P4zFJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ah, that makes sense"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"12e9dee5-fb40-4ec5-ad56-1fe37a06dc14","type":"message","text":"on buffers though, I have a version of my inner function that uses `MVector` buffers, but I presume those would trigger race conditions as well?","user":"U7JQGPGCQ","ts":"1608313107.465600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4y5Ne","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"on buffers though, I have a version of my inner function that uses "},{"type":"text","text":"MVector","style":{"code":true}},{"type":"text","text":" buffers, but I presume those would trigger race conditions as well?"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"ef0d15c3-6fe0-49d3-a712-ff3fafe7f0f7","type":"message","text":"if they're shared between threads, yes","user":"UH24GRBLL","ts":"1608313138.465800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"29H","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if they're shared between threads, yes"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"916d276c-48d5-4d1c-9d4a-16ae97618c3d","type":"message","text":"any variable that's shared between threads can lead to data races","user":"UH24GRBLL","ts":"1608313168.466000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"AmzB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"any variable that's shared between threads can lead to data races"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"aa3eb032-3f3b-4088-b6c6-7ae2a3235079","type":"message","text":"so I should allocate `nthreads` buffers, and then pass `buffers[threadid()]` to my function?","user":"U7JQGPGCQ","ts":"1608313250.466200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"g1E9V","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so I should allocate "},{"type":"text","text":"nthreads","style":{"code":true}},{"type":"text","text":" buffers, and then pass "},{"type":"text","text":"buffers[threadid()]","style":{"code":true}},{"type":"text","text":" to my function?"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"d79c3d33-27e1-4b76-be5e-a782464dcebb","type":"message","text":"yeah, that's worth a try","user":"UH24GRBLL","ts":"1608313480.466600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Kdu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah, that's worth a try"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"4e328858-8c28-4a20-b149-af4b6d374ac0","type":"message","text":"trading speed for memory is often the case when going for the fastest possible solution","user":"UH24GRBLL","ts":"1608313499.466800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8n5=E","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"trading speed for memory is often the case when going for the fastest possible solution"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"6f8943f4-2e41-4ba1-8be6-63068af07c8d","type":"message","text":"in extreme cases you have a `Dict` mapping input arguments to function output","user":"UH24GRBLL","ts":"1608313524.467000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"P1u1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"in extreme cases you have a "},{"type":"text","text":"Dict","style":{"code":true}},{"type":"text","text":" mapping input arguments to function output"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"},{"client_msg_id":"0bc34703-46e2-48e4-89d3-b4be09efdb2b","type":"message","text":"horrible for memory consumption, blazingly fast for speed :man-shrugging: (if your Dict lookup is cheaper than the function, that is)","user":"UH24GRBLL","ts":"1608313549.467200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jN71G","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"horrible for memory consumption, blazingly fast for speed "},{"type":"emoji","name":"man-shrugging"},{"type":"text","text":" (if your Dict lookup is cheaper than the function, that is)"}]}]}],"thread_ts":"1608310177.450000","parent_user_id":"U7JQGPGCQ"}]