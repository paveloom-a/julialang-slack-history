[{"client_msg_id":"335c5ca6-f2ff-428f-8c08-a7da624044ac","type":"message","text":"Does anyone know why test1 can be type inferred in this example, but test2 can't?\n```test1(x) = [x[i] for i=1:3]\n\nfunction test2(x)\n    x = x\n    [x[i] for i=1:3]\nend\n\n@code_warntype test1(zeros(3))\n@code_warntype test2(zeros(3))```\n(This is a highly simplified version of some code that has a more useful assignment than x = x)","user":"UENUXK2MS","ts":"1610154648.132900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"eNKI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Does anyone know why test1 can be type inferred in this example, but test2 can't?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"test1(x) = [x[i] for i=1:3]\n\nfunction test2(x)\n    x = x\n    [x[i] for i=1:3]\nend\n\n@code_warntype test1(zeros(3))\n@code_warntype test2(zeros(3))"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"(This is a highly simplified version of some code that has a more useful assignment than x = x)"}]}]}],"thread_ts":"1610154648.132900","reply_count":18,"reply_users_count":4,"latest_reply":"1610156584.136700","reply_users":["UDB26738Q","UENUXK2MS","UD0NS8PDF","UM30MT6RF"],"subscribed":false},{"client_msg_id":"9be6c8c2-26a9-4551-818e-8dc0d7615b27","type":"message","text":"uh?\n```julia&gt; @code_warntype test1(zeros(3))\nVariables\n  #self#::Core.Const(test1)\n  x::Vector{Float64}\n  #5::var\"#5#6\"{Vector{Float64}}\n\nBody::Vector{Float64}\n1 ─ %1 = Main.:(var\"#5#6\")::Core.Const(var\"#5#6\")\n│   %2 = Core.typeof(x)::Core.Const(Vector{Float64})\n│   %3 = Core.apply_type(%1, %2)::Core.Const(var\"#5#6\"{Vector{Float64}})\n│        (#5 = %new(%3, x))\n│   %5 = #5::var\"#5#6\"{Vector{Float64}}\n│   %6 = (1:3)::Core.Const(1:3)\n│   %7 = Base.Generator(%5, %6)::Core.PartialStruct(Base.Generator{UnitRange{Int64}, var\"#5#6\"{Vector{Float64}}}, Any[var\"#5#6\"{Vector{Float64}}, Core.Const(1:3)])\n│   %8 = Base.collect(%7)::Vector{Float64}\n└──      return %8\n\njulia&gt; @code_warntype test2(zeros(3))\nVariables\n  #self#::Core.Const(test2)\n  x@_2::Vector{Float64}\n  #7::var\"#7#8\"{Vector{Float64}}\n  x@_4::Vector{Float64}\n\nBody::Vector{Float64}\n1 ─       (x@_4 = x@_2)\n│         (x@_4 = x@_4)\n│   %3  = Main.:(var\"#7#8\")::Core.Const(var\"#7#8\")\n│   %4  = Core.typeof(x@_4)::Core.Const(Vector{Float64})\n│   %5  = Core.apply_type(%3, %4)::Core.Const(var\"#7#8\"{Vector{Float64}})\n│         (#7 = %new(%5, x@_4))\n│   %7  = #7::var\"#7#8\"{Vector{Float64}}\n│   %8  = (1:3)::Core.Const(1:3)\n│   %9  = Base.Generator(%7, %8)::Core.PartialStruct(Base.Generator{UnitRange{Int64}, var\"#7#8\"{Vector{Float64}}}, Any[var\"#7#8\"{Vector{Float64}}, Core.Const(1:3)])\n│   %10 = Base.collect(%9)::Vector{Float64}\n└──       return %10```","user":"UDB26738Q","ts":"1610154717.133000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Axx","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"uh?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @code_warntype test1(zeros(3))\nVariables\n  #self#::Core.Const(test1)\n  x::Vector{Float64}\n  #5::var\"#5#6\"{Vector{Float64}}\n\nBody::Vector{Float64}\n1 ─ %1 = Main.:(var\"#5#6\")::Core.Const(var\"#5#6\")\n│   %2 = Core.typeof(x)::Core.Const(Vector{Float64})\n│   %3 = Core.apply_type(%1, %2)::Core.Const(var\"#5#6\"{Vector{Float64}})\n│        (#5 = %new(%3, x))\n│   %5 = #5::var\"#5#6\"{Vector{Float64}}\n│   %6 = (1:3)::Core.Const(1:3)\n│   %7 = Base.Generator(%5, %6)::Core.PartialStruct(Base.Generator{UnitRange{Int64}, var\"#5#6\"{Vector{Float64}}}, Any[var\"#5#6\"{Vector{Float64}}, Core.Const(1:3)])\n│   %8 = Base.collect(%7)::Vector{Float64}\n└──      return %8\n\njulia> @code_warntype test2(zeros(3))\nVariables\n  #self#::Core.Const(test2)\n  x@_2::Vector{Float64}\n  #7::var\"#7#8\"{Vector{Float64}}\n  x@_4::Vector{Float64}\n\nBody::Vector{Float64}\n1 ─       (x@_4 = x@_2)\n│         (x@_4 = x@_4)\n│   %3  = Main.:(var\"#7#8\")::Core.Const(var\"#7#8\")\n│   %4  = Core.typeof(x@_4)::Core.Const(Vector{Float64})\n│   %5  = Core.apply_type(%3, %4)::Core.Const(var\"#7#8\"{Vector{Float64}})\n│         (#7 = %new(%5, x@_4))\n│   %7  = #7::var\"#7#8\"{Vector{Float64}}\n│   %8  = (1:3)::Core.Const(1:3)\n│   %9  = Base.Generator(%7, %8)::Core.PartialStruct(Base.Generator{UnitRange{Int64}, var\"#7#8\"{Vector{Float64}}}, Any[var\"#7#8\"{Vector{Float64}}, Core.Const(1:3)])\n│   %10 = Base.collect(%9)::Vector{Float64}\n└──       return %10"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"a3340431-671e-4426-8837-06bc1f304568","type":"message","text":"Strange, I'm getting\n```Variables\n  #self#::Core.Compiler.Const(test1, false)\n  x::Array{Float64,1}\n  #1::var\"#1#2\"{Array{Float64,1}}\n\nBody::Array{Float64,1}\n1 ─ %1 = Main.:(var\"#1#2\")::Core.Compiler.Const(var\"#1#2\", false)\n│   %2 = Core.typeof(x)::Core.Compiler.Const(Array{Float64,1}, false)\n│   %3 = Core.apply_type(%1, %2)::Core.Compiler.Const(var\"#1#2\"{Array{Float64,1}}, false)\n│        (#1 = %new(%3, x))\n│   %5 = #1::var\"#1#2\"{Array{Float64,1}}\n│   %6 = (1:3)::Core.Compiler.Const(1:3, false)\n│   %7 = Base.Generator(%5, %6)::Core.Compiler.PartialStruct(Base.Generator{UnitRange{Int64},var\"#1#2\"{Array{Float64,1}}}, Any[var\"#1#2\"{Array{Float64,1}}, Core.Compiler.Const(1:3, false)])\n│   %8 = Base.collect(%7)::Array{Float64,1}\n└──      return %8\nVariables\n  #self#::Core.Compiler.Const(test2, false)\n  x@_2::Array{Float64,1}\n  #3::var\"#3#4\"\n  x@_4::Union{}\n  x@_5::Union{Array{Float64,1}, Core.Box}\n\nBody::Array{_A,1} where _A\n1 ─       (x@_5 = x@_2)\n│         (x@_5 = Core.Box(x@_5::Array{Float64,1}))\n│         Core.NewvarNode(:(#3))\n│   %4  = Core.isdefined(x@_5::Core.Box, :contents)::Bool\n└──       goto #3 if not %4\n2 ─       goto #4\n3 ─       Core.NewvarNode(:(x@_4))\n└──       x@_4\n4 ┄ %9  = Core.getfield(x@_5::Core.Box, :contents)::Any\n│         Core.setfield!(x@_5::Core.Box, :contents, %9)\n│         (#3 = %new(Main.:(var\"#3#4\"), x@_5::Core.Box))\n│   %12 = #3::var\"#3#4\"\n│   %13 = (1:3)::Core.Compiler.Const(1:3, false)\n│   %14 = Base.Generator(%12, %13)::Core.Compiler.PartialStruct(Base.Generator{UnitRange{Int64},var\"#3#4\"}, Any[var\"#3#4\", Core.Compiler.Const(1:3, false)])\n│   %15 = Base.collect(%14)::Array{_A,1} where _A\n└──       return %15```\non 1.5.3.","user":"UENUXK2MS","ts":"1610154767.133200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FbS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Strange, I'm getting\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"Variables\n  #self#::Core.Compiler.Const(test1, false)\n  x::Array{Float64,1}\n  #1::var\"#1#2\"{Array{Float64,1}}\n\nBody::Array{Float64,1}\n1 ─ %1 = Main.:(var\"#1#2\")::Core.Compiler.Const(var\"#1#2\", false)\n│   %2 = Core.typeof(x)::Core.Compiler.Const(Array{Float64,1}, false)\n│   %3 = Core.apply_type(%1, %2)::Core.Compiler.Const(var\"#1#2\"{Array{Float64,1}}, false)\n│        (#1 = %new(%3, x))\n│   %5 = #1::var\"#1#2\"{Array{Float64,1}}\n│   %6 = (1:3)::Core.Compiler.Const(1:3, false)\n│   %7 = Base.Generator(%5, %6)::Core.Compiler.PartialStruct(Base.Generator{UnitRange{Int64},var\"#1#2\"{Array{Float64,1}}}, Any[var\"#1#2\"{Array{Float64,1}}, Core.Compiler.Const(1:3, false)])\n│   %8 = Base.collect(%7)::Array{Float64,1}\n└──      return %8\nVariables\n  #self#::Core.Compiler.Const(test2, false)\n  x@_2::Array{Float64,1}\n  #3::var\"#3#4\"\n  x@_4::Union{}\n  x@_5::Union{Array{Float64,1}, Core.Box}\n\nBody::Array{_A,1} where _A\n1 ─       (x@_5 = x@_2)\n│         (x@_5 = Core.Box(x@_5::Array{Float64,1}))\n│         Core.NewvarNode(:(#3))\n│   %4  = Core.isdefined(x@_5::Core.Box, :contents)::Bool\n└──       goto #3 if not %4\n2 ─       goto #4\n3 ─       Core.NewvarNode(:(x@_4))\n└──       x@_4\n4 ┄ %9  = Core.getfield(x@_5::Core.Box, :contents)::Any\n│         Core.setfield!(x@_5::Core.Box, :contents, %9)\n│         (#3 = %new(Main.:(var\"#3#4\"), x@_5::Core.Box))\n│   %12 = #3::var\"#3#4\"\n│   %13 = (1:3)::Core.Compiler.Const(1:3, false)\n│   %14 = Base.Generator(%12, %13)::Core.Compiler.PartialStruct(Base.Generator{UnitRange{Int64},var\"#3#4\"}, Any[var\"#3#4\", Core.Compiler.Const(1:3, false)])\n│   %15 = Base.collect(%14)::Array{_A,1} where _A\n└──       return %15"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"on 1.5.3."}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"f53c40e1-9d75-4ebd-b2ac-27b0efbd7325","type":"message","text":"oh, I'm on v1.6","user":"UDB26738Q","ts":"1610154782.133400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Pjnm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"oh, I'm on v1.6"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"53cc8421-610b-4c60-9b96-dd62cd69e8e2","type":"message","text":"I guess it had been fixed already, but the `x = x` is a bit fishy","user":"UDB26738Q","ts":"1610154804.133600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Bf49P","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I guess it had been fixed already, but the "},{"type":"text","text":"x = x","style":{"code":true}},{"type":"text","text":" is a bit fishy"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"02a0c570-c3c1-407d-b3b0-06e525f94f00","type":"message","text":"Removing that fixes it on 1.5:\n```│   %15 = Base.collect(%14)::Array{_A,1} where _A\n└──       return %15\n\njulia&gt; VERSION\nv\"1.5.2\"\n\njulia&gt; function test3(x)\n           x3 = x\n           [x3[i] for i=1:3]\n       end\ntest3 (generic function with 1 method)\n\njulia&gt; @code_warntype test3(zeros(3))\nVariables\n  #self#::Core.Compiler.Const(test3, false)\n  x::Array{Float64,1}\n  #290::var\"#290#291\"{Array{Float64,1}}\n  x3::Array{Float64,1}\n\nBody::Array{Float64,1}```","user":"UD0NS8PDF","ts":"1610154829.133800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"s+2w","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Removing that fixes it on 1.5:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"│   %15 = Base.collect(%14)::Array{_A,1} where _A\n└──       return %15\n\njulia> VERSION\nv\"1.5.2\"\n\njulia> function test3(x)\n           x3 = x\n           [x3[i] for i=1:3]\n       end\ntest3 (generic function with 1 method)\n\njulia> @code_warntype test3(zeros(3))\nVariables\n  #self#::Core.Compiler.Const(test3, false)\n  x::Array{Float64,1}\n  #290::var\"#290#291\"{Array{Float64,1}}\n  x3::Array{Float64,1}\n\nBody::Array{Float64,1}"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS","reactions":[{"name":"+1","users":["UENUXK2MS"],"count":1}]},{"client_msg_id":"e95f7364-6844-4e85-ac16-32c703397751","type":"message","text":"Yeah, in the real code it gets assigned to a function of x","user":"UENUXK2MS","ts":"1610154847.134000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QnsGq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yeah, in the real code it gets assigned to a function of x"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"7f73a157-d813-4387-b8b7-298a2438a57e","type":"message","text":"Good to know this is fixed in 1.6! I'll switch versions","user":"UENUXK2MS","ts":"1610154871.134200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"102","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Good to know this is fixed in 1.6! I'll switch versions"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"7f05a5d4-98e3-49d2-be6d-960075fd9cfe","type":"message","text":"<@UD0NS8PDF> Yeah it's just strange that it was happening at all","user":"UENUXK2MS","ts":"1610154908.134500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"mTPf","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UD0NS8PDF"},{"type":"text","text":" Yeah it's just strange that it was happening at all"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"8133bbec-e172-4efa-949e-a056d3e53bc8","type":"message","text":"Yes I don’t know what the bug is (or was) but have met things like this, I think re-using the same name can create confusion.","user":"UD0NS8PDF","ts":"1610155401.134700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"k=A8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes I don’t know what the bug is (or was) but have met things like this, I think re-using the same name can create confusion."}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"ad7a0164-000f-410c-9cfb-feeffd2f8598","type":"message","text":"Looks like <https://github.com/JuliaLang/julia/issues/15276|https://github.com/JuliaLang/julia/issues/15276> might have been the cause of this, but seems like the compiler has gotten better at this in this particular instance.","user":"UM30MT6RF","ts":"1610155431.134900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Wsha","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Looks like "},{"type":"link","url":"https://github.com/JuliaLang/julia/issues/15276","text":"https://github.com/JuliaLang/julia/issues/15276"},{"type":"text","text":" might have been the cause of this, but seems like the compiler has gotten better at this in this particular instance."}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"629456ca-3c8c-41d5-bf87-215239359918","type":"message","text":"<@UM30MT6RF> Interesting thank you! Look like my complicated function still has a similar problem on 1.6, so I'll read through this and see if I can find a way around it","user":"UENUXK2MS","ts":"1610155650.135100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"a6v","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UM30MT6RF"},{"type":"text","text":" Interesting thank you! Look like my complicated function still has a similar problem on 1.6, so I'll read through this and see if I can find a way around it"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"305efd50-b5ff-4a7d-813f-acfa751870a9","type":"message","text":"any chance of just using a different variable?","user":"UDB26738Q","ts":"1610155691.135300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qa6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"any chance of just using a different variable?"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"3b036886-7248-4d9a-864a-43dfa2cd5db3","type":"message","text":"The easiest workaround is usually putting something like `let x=x; ... end` around the closure","user":"UM30MT6RF","ts":"1610155721.135500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"JDBBs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The easiest workaround is usually putting something like "},{"type":"text","text":"let x=x; ... end","style":{"code":true}},{"type":"text","text":" around the closure"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS","reactions":[{"name":"+1","users":["UENUXK2MS"],"count":1}]},{"client_msg_id":"6bac070b-f79e-48fa-917a-c7973f57dd58","type":"message","text":"<@UDB26738Q> In the real function there's a branch that decides whether to assign the variable to something else. I suppose It could be changed to something like `&lt;conditional&gt; ? x_new = f(x) : x_new = x`","user":"UENUXK2MS","ts":"1610155877.135700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"h+cmK","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UDB26738Q"},{"type":"text","text":" In the real function there's a branch that decides whether to assign the variable to something else. I suppose It could be changed to something like "},{"type":"text","text":"<conditional> ? x_new = f(x) : x_new = x","style":{"code":true}}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"a58b8229-c92b-47ce-92a2-9b84077c0901","type":"message","text":"At the moment it's just `&lt;conditional&gt; &amp;&amp; x = f(x)`  and then x is used later, so maybe that's the problem","user":"UENUXK2MS","ts":"1610155972.135900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GS94C","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"At the moment it's just "},{"type":"text","text":"<conditional> && x = f(x)","style":{"code":true}},{"type":"text","text":"  and then x is used later, so maybe that's the problem"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"ddec8a9b-f5c3-4bf4-89b5-9a0f53bb842b","type":"message","text":"Or `x_new = cond ? f(x) : x`","user":"UD0NS8PDF","ts":"1610155975.136100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"clRA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Or "},{"type":"text","text":"x_new = cond ? f(x) : x","style":{"code":true}}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS","reactions":[{"name":"+1","users":["UENUXK2MS"],"count":1}]},{"client_msg_id":"b44964e1-2c70-4217-8d87-cc58986cd022","type":"message","text":"Cool! Looks like `x = cond ? f(x) : x`  was able to fix it - didn't even need a new variable name!","user":"UENUXK2MS","ts":"1610156555.136500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Pl1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Cool! Looks like "},{"type":"text","text":"x = cond ? f(x) : x","style":{"code":true}},{"type":"text","text":"  was able to fix it - didn't even need a new variable name!"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"},{"client_msg_id":"6836acfa-57bf-46d6-a614-fb05662f8ce2","type":"message","text":"Thanks again for the help :)","user":"UENUXK2MS","ts":"1610156584.136700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Hd9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks again for the help :)"}]}]}],"thread_ts":"1610154648.132900","parent_user_id":"UENUXK2MS"}]