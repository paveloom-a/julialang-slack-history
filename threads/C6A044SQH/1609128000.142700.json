[{"client_msg_id":"e7448695-c4f1-4b92-9e74-b9735090ebfe","type":"message","text":"I have a weird problem with passing a callback function pointer (returned by `@cfunction`) to a shared library. The function pointer is passed to the library via a field of a structure.  I have added a test function to the shared library that calls the callback function stored in the structure.  I can `ccall` this test function from Julia and the Julia callback function gets called as expected without problems, but when it comes time for the library to call the same callback function it segfaults even though the callback function pointer has the same value as when called from the test function.  Any ideas on what could be going wrong or how to debug this?","user":"U01FKQQ7J0J","ts":"1609128000.142700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6kd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I have a weird problem with passing a callback function pointer (returned by "},{"type":"text","text":"@cfunction","style":{"code":true}},{"type":"text","text":") to a shared library. The function pointer is passed to the library via a field of a structure.  I have added a test function to the shared library that calls the callback function stored in the structure.  I can "},{"type":"text","text":"ccall","style":{"code":true}},{"type":"text","text":" this test function from Julia and the Julia callback function gets called as expected without problems, but when it comes time for the library to call the same callback function it segfaults even though the callback function pointer has the same value as when called from the test function.  Any ideas on what could be going wrong or how to debug this?"}]}]}],"thread_ts":"1609128000.142700","reply_count":5,"reply_users_count":1,"latest_reply":"1609136640.170200","reply_users":["U01FKQQ7J0J"],"subscribed":false},{"client_msg_id":"d796f6df-b43f-4350-b7bd-cdd3441db74d","type":"message","text":"FWIW, the shared library's callback mechanism works fine with a C client.","user":"U01FKQQ7J0J","ts":"1609128119.142800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cCT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"FWIW, the shared library's callback mechanism works fine with a C client."}]}]}],"thread_ts":"1609128000.142700","parent_user_id":"U01FKQQ7J0J"},{"client_msg_id":"0d913db0-624c-43d0-be0b-d79cb29b4510","type":"message","text":"I think the problem is related to the fact that the shared library calls the callback function from another thread.  If the Julia callback function calls `println(\"Hello\")`it segfaults in `jl_mutex_unlock()`.  If I change the Julia callback function to just call `ccall(:printf, Cint, (Cstring,), \"Hello\\n\")` then it works fine.","user":"U01FKQQ7J0J","ts":"1609133953.167100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9yhTY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think the problem is related to the fact that the shared library calls the callback function from another thread.  If the Julia callback function calls "},{"type":"text","text":"println(\"Hello\")","style":{"code":true}},{"type":"text","text":"it segfaults in "},{"type":"text","text":"jl_mutex_unlock()","style":{"code":true}},{"type":"text","text":".  If I change the Julia callback function to just call "},{"type":"text","text":"ccall(:printf, Cint, (Cstring,), \"Hello\\n\")","style":{"code":true}},{"type":"text","text":" then it works fine."}]}]}],"thread_ts":"1609128000.142700","parent_user_id":"U01FKQQ7J0J"},{"client_msg_id":"e7548829-ba64-4c4a-b0e1-4bab552be2c1","type":"message","text":"Here's the stack trace from gdb back to the shared library's `pre_dump_stream_callback()` function that calls the Julia callback function:\n```#0  0x00007ffff76c02ad in jl_mutex_unlock (lock=&lt;optimized out&gt;) at /buildworker/worker/package_linux64/build/src/locks.h:144\n#1  jl_lookup_generic_ (world=0, callsite=&lt;optimized out&gt;, nargs=&lt;optimized out&gt;, args=0x7fff9e3e72a0, F=0x7fffec3e5240 &lt;jl_system_image_data+36450176&gt;)\n    at /buildworker/worker/package_linux64/build/src/gf.c:2365\n#2  jl_apply_generic (F=0x7fffec3e5240 &lt;jl_system_image_data+36450176&gt;, args=0x7fff9e3e72a0, nargs=&lt;optimized out&gt;) at /buildworker/worker/package_linux64/build/src/gf.c:2394\n#3  0x00007fffe959a3c9 in japi1_println_56918 () at coreio.jl:4\n#4  0x00007fffcbcf0c6d in ?? ()\n#5  0x00007fffe6299e10 in ?? ()\n#6  0x00007fffcbcf1502 in ?? ()\n#7  0x0000000000006cac in ?? ()\n#8  0x00000000018e5d80 in ?? ()\n#9  0x00000000011b6e40 in ?? ()\n#10 0x00007fffbc9eb21a in pre_dump_stream_callback (stream=0x20a1530, status=cudaSuccess, data=0x1850a20) at <http://rawspec_gpu.cu:304|rawspec_gpu.cu:304>```","user":"U01FKQQ7J0J","ts":"1609134162.167300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"w2k0q","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Here's the stack trace from gdb back to the shared library's "},{"type":"text","text":"pre_dump_stream_callback()","style":{"code":true}},{"type":"text","text":" function that calls the Julia callback function:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"#0  0x00007ffff76c02ad in jl_mutex_unlock (lock=<optimized out>) at /buildworker/worker/package_linux64/build/src/locks.h:144\n#1  jl_lookup_generic_ (world=0, callsite=<optimized out>, nargs=<optimized out>, args=0x7fff9e3e72a0, F=0x7fffec3e5240 <jl_system_image_data+36450176>)\n    at /buildworker/worker/package_linux64/build/src/gf.c:2365\n#2  jl_apply_generic (F=0x7fffec3e5240 <jl_system_image_data+36450176>, args=0x7fff9e3e72a0, nargs=<optimized out>) at /buildworker/worker/package_linux64/build/src/gf.c:2394\n#3  0x00007fffe959a3c9 in japi1_println_56918 () at coreio.jl:4\n#4  0x00007fffcbcf0c6d in ?? ()\n#5  0x00007fffe6299e10 in ?? ()\n#6  0x00007fffcbcf1502 in ?? ()\n#7  0x0000000000006cac in ?? ()\n#8  0x00000000018e5d80 in ?? ()\n#9  0x00000000011b6e40 in ?? ()\n#10 0x00007fffbc9eb21a in pre_dump_stream_callback (stream=0x20a1530, status=cudaSuccess, data=0x1850a20) at rawspec_gpu.cu:304"}]}]}],"thread_ts":"1609128000.142700","parent_user_id":"U01FKQQ7J0J"},{"client_msg_id":"73b98555-3e9c-4e63-a10a-82015e8307bb","type":"message","text":"That was with the Julia callback function calling `println(\"hello from callback\")`.  I think it's crashing in the function lookup.  If I change the callback function to call `Core.println(\"hello from callback\")` it crashes in `jl_uv_puts()`:\n```#0  0x00007ffff76fae35 in jl_uv_puts (stream=&lt;optimized out&gt;, str=0x7fffe629a8c8 \"hello from callback\", n=19) at /buildworker/worker/package_linux64/build/src/jl_uv.c:533\n#1  0x00007fffcbcf087e in ?? ()\n#2  0x00007fff9e3e7300 in ?? ()\n#3  0x00007fffcbcf1132 in ?? ()\n#4  0x0000000000006cac in ?? ()\n#5  0x0000000001471240 in ?? ()\n#6  0x00000000018d7020 in ?? ()\n#7  0x00007fffbc9eb21a in pre_dump_stream_callback (stream=0x208c5f0, status=cudaSuccess, data=0xdf1570) at <http://rawspec_gpu.cu:304|rawspec_gpu.cu:304>```","user":"U01FKQQ7J0J","ts":"1609136298.170000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pA8j","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That was with the Julia callback function calling "},{"type":"text","text":"println(\"hello from callback\")","style":{"code":true}},{"type":"text","text":".  I think it's crashing in the function lookup.  If I change the callback function to call "},{"type":"text","text":"Core.println(\"hello from callback\")","style":{"code":true}},{"type":"text","text":" it crashes in "},{"type":"text","text":"jl_uv_puts()","style":{"code":true}},{"type":"text","text":":\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"#0  0x00007ffff76fae35 in jl_uv_puts (stream=<optimized out>, str=0x7fffe629a8c8 \"hello from callback\", n=19) at /buildworker/worker/package_linux64/build/src/jl_uv.c:533\n#1  0x00007fffcbcf087e in ?? ()\n#2  0x00007fff9e3e7300 in ?? ()\n#3  0x00007fffcbcf1132 in ?? ()\n#4  0x0000000000006cac in ?? ()\n#5  0x0000000001471240 in ?? ()\n#6  0x00000000018d7020 in ?? ()\n#7  0x00007fffbc9eb21a in pre_dump_stream_callback (stream=0x208c5f0, status=cudaSuccess, data=0xdf1570) at rawspec_gpu.cu:304"}]}]}],"thread_ts":"1609128000.142700","parent_user_id":"U01FKQQ7J0J"},{"client_msg_id":"f92d5601-f0ab-4891-825f-c715d3620e35","type":"message","text":"I think I need some way to get this thread hooked into the Julia thread synchronization system, but I don't know if there's a way to \"adopt\" a thread spawned by a shared library.","user":"U01FKQQ7J0J","ts":"1609136640.170200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FksTA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think I need some way to get this thread hooked into the Julia thread synchronization system, but I don't know if there's a way to \"adopt\" a thread spawned by a shared library."}]}]}],"thread_ts":"1609128000.142700","parent_user_id":"U01FKQQ7J0J"}]