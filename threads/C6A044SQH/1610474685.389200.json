[{"client_msg_id":"9429a464-e770-4888-9b24-4cadd0c057db","type":"message","text":"Let's say I have two mutable struct instances, and the first is a field of the second. When both objects are GC'd, does it run the finalizer of the second struct before the first, or it's undefined ?","user":"U013B3NSZGB","ts":"1610474685.389200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DyD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Let's say I have two mutable struct instances, and the first is a field of the second. When both objects are GC'd, does it run the finalizer of the second struct before the first, or it's undefined ?"}]}]}],"thread_ts":"1610474685.389200","reply_count":7,"reply_users_count":2,"latest_reply":"1610484687.415800","reply_users":["U019K6Q9N15","U013B3NSZGB"],"subscribed":false},{"client_msg_id":"d336a469-efbd-4568-ae23-41f77231c215","type":"message","text":"Can't answer off the top of my head, but if no-one gets back to you, would suggest adding custom finalizers and printing from them in order to test.","user":"U019K6Q9N15","ts":"1610477274.396300","team":"T68168MUP","edited":{"user":"U019K6Q9N15","ts":"1610477282.000000"},"blocks":[{"type":"rich_text","block_id":"kuW","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Can't answer off the top of my head, but if no-one gets back to you, would suggest adding custom finalizers and printing from them in order to test."}]}]}],"thread_ts":"1610474685.389200","parent_user_id":"U013B3NSZGB","reactions":[{"name":"+1","users":["U013B3NSZGB"],"count":1}]},{"client_msg_id":"63a267e9-4f3a-4ae8-9af7-8304fb0af4be","type":"message","text":"Experimented a bit, here what it yields:\n\n```mutable struct A end\nmutable struct B\n    a::A\nend\n\nprint_type(x) = ccall(:jl_safe_printf, Cvoid, (Cstring, Cstring), \"Finalizing %s.\", repr(x))\nprint_type(x::B) = ccall(:jl_safe_printf, Cvoid, (Cstring, Cstring), \"Finalizing %s.\", \"field a\")\n\nlet a = A(), b = B(a)\n    finalizer(print_type, a)\n    finalizer(print_type, b)\nend```\nThis gives:\n```julia&gt; GC.gc()\n\njulia&gt; GC.gc()\nFinalizing field a.Finalizing A().\njulia&gt; ```\nAnd if I swap the finalizer registrations (the two lines in the let block):\n```julia&gt; GC.gc()\nFinalizing field a.\njulia&gt; GC.gc()\nFinalizing A().\njulia&gt;```","user":"U013B3NSZGB","ts":"1610480358.397600","team":"T68168MUP","edited":{"user":"U013B3NSZGB","ts":"1610480534.000000"},"blocks":[{"type":"rich_text","block_id":"wA/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Experimented a bit, here what it yields:\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"mutable struct A end\nmutable struct B\n    a::A\nend\n\nprint_type(x) = ccall(:jl_safe_printf, Cvoid, (Cstring, Cstring), \"Finalizing %s.\", repr(x))\nprint_type(x::B) = ccall(:jl_safe_printf, Cvoid, (Cstring, Cstring), \"Finalizing %s.\", \"field a\")\n\nlet a = A(), b = B(a)\n    finalizer(print_type, a)\n    finalizer(print_type, b)\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"This gives:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> GC.gc()\n\njulia> GC.gc()\nFinalizing field a.Finalizing A().\njulia> "}]},{"type":"rich_text_section","elements":[{"type":"text","text":"And if I swap the finalizer registrations (the two lines in the let block):\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> GC.gc()\nFinalizing field a.\njulia> GC.gc()\nFinalizing A().\njulia>"}]}]}],"thread_ts":"1610474685.389200","parent_user_id":"U013B3NSZGB"},{"client_msg_id":"66f04489-7af3-470b-b348-4848202eb622","type":"message","text":"So, it seems like the field always gets finalized first _in this case_. Hopefully the behavior will be consistent in other cases.","user":"U013B3NSZGB","ts":"1610480449.397800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"0H9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So, it seems like the field always gets finalized first "},{"type":"text","text":"in this case","style":{"italic":true}},{"type":"text","text":". Hopefully the behavior will be consistent in other cases."}]}]}],"thread_ts":"1610474685.389200","parent_user_id":"U013B3NSZGB"},{"client_msg_id":"c46f2a2f-e9b4-4beb-99a4-347acba97b7b","type":"message","text":"Well, I forgot that the last statement gets stored in `ans`  in the REPL so the above test case is not representative (and it explains why I needed 2 `GC.gc()`:\n\n```let a = A(), b = B(a)\n    finalizer(print_type, a)\n    finalizer(print_type, b)\n    nothing\nend```\n=&gt; field gets finalized first\n```let a = A(), b = B(a)\n    finalizer(print_type, b)\n    finalizer(print_type, a)\n    nothing\nend```\n=&gt; field gets finalized last\n\nSo, it seems that whether one is used by the other does not matter, most likely finalizer registration is more important","user":"U013B3NSZGB","ts":"1610480897.401300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"tg=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Well, I forgot that the last statement gets stored in "},{"type":"text","text":"ans","style":{"code":true}},{"type":"text","text":"  in the REPL so the above test case is not representative (and it explains why I needed 2 "},{"type":"text","text":"GC.gc()","style":{"code":true}},{"type":"text","text":":\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"let a = A(), b = B(a)\n    finalizer(print_type, a)\n    finalizer(print_type, b)\n    nothing\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"=> field gets finalized first\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"let a = A(), b = B(a)\n    finalizer(print_type, b)\n    finalizer(print_type, a)\n    nothing\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"=> field gets finalized last\n\nSo, it seems that whether one is used by the other does not matter, most likely finalizer registration is more important"}]}]}],"thread_ts":"1610474685.389200","parent_user_id":"U013B3NSZGB","reactions":[{"name":"raised_hands","users":["U019K6Q9N15"],"count":1}]},{"client_msg_id":"30e73e60-be63-4e76-89da-c72dc9f6aa12","type":"message","text":"Actually, after deeper research on the Internet, there is absolutely no guarantee on finalizer order.","user":"U013B3NSZGB","ts":"1610483897.415300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"EpbHK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Actually, after deeper research on the Internet, there is absolutely no guarantee on finalizer order."}]}]}],"thread_ts":"1610474685.389200","parent_user_id":"U013B3NSZGB"},{"client_msg_id":"5f52815b-02b7-4560-9460-786b0f98817c","type":"message","text":"When two variables are \"dead\", you can't tell which one is going to have its finalizer called first","user":"U013B3NSZGB","ts":"1610483925.415500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"nQn3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"When two variables are \"dead\", you can't tell which one is going to have its finalizer called first"}]}]}],"thread_ts":"1610474685.389200","parent_user_id":"U013B3NSZGB"},{"type":"message","subtype":"thread_broadcast","text":"Bump for visibility; Cedric did some work and some research and TIL something about finalizers","user":"U019K6Q9N15","ts":"1610484687.415800","thread_ts":"1610474685.389200","root":{"client_msg_id":"9429a464-e770-4888-9b24-4cadd0c057db","type":"message","text":"Let's say I have two mutable struct instances, and the first is a field of the second. When both objects are GC'd, does it run the finalizer of the second struct before the first, or it's undefined ?","user":"U013B3NSZGB","ts":"1610474685.389200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DyD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Let's say I have two mutable struct instances, and the first is a field of the second. When both objects are GC'd, does it run the finalizer of the second struct before the first, or it's undefined ?"}]}]}],"thread_ts":"1610474685.389200","reply_count":7,"reply_users_count":2,"latest_reply":"1610484687.415800","reply_users":["U019K6Q9N15","U013B3NSZGB"],"subscribed":false},"blocks":[{"type":"rich_text","block_id":"Glbq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Bump for visibility; Cedric did some work and some research and TIL something about finalizers"}]}]}],"client_msg_id":"e80455f4-db8d-4bd3-9803-7518753a4d60","edited":{"user":"U019K6Q9N15","ts":"1610484703.000000"}}]