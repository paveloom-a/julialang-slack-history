[{"client_msg_id":"9c9fb942-f919-4ed6-8705-6240581a8d3b","type":"message","text":"Is there a macro or something that I could use to convert column-major indexing of julia into row-major indexing format? I need it because I am calling an underlying C library that uses row major indexing but my mind is very much used to thinking in column-major now. Basically I need something like\n```@reverse_indexing A[i, j, k]```\nshould transform into `A[k, j, i]`.\nIf not, how do I write such a macro? (I am not good with macros :sweat_smile:)","user":"U0190AJCYK0","ts":"1618163548.024200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"KnK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is there a macro or something that I could use to convert column-major indexing of julia into row-major indexing format? I need it because I am calling an underlying C library that uses row major indexing but my mind is very much used to thinking in column-major now. Basically I need something like\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"@reverse_indexing A[i, j, k]"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"should transform into "},{"type":"text","text":"A[k, j, i]","style":{"code":true}},{"type":"text","text":".\nIf not, how do I write such a macro? (I am not good with macros "},{"type":"emoji","name":"sweat_smile"},{"type":"text","text":")"}]}]}],"thread_ts":"1618163548.024200","reply_count":20,"reply_users_count":3,"latest_reply":"1618165417.029400","reply_users":["UAUPJLBQX","U8D9768Q6","U0190AJCYK0"],"is_locked":false,"subscribed":false},{"client_msg_id":"6d583332-58a5-4e91-b730-fe2e276cccdb","type":"message","text":"```julia&gt; macro reverse_indexing(ex)\n           Meta.isexpr(ex, :ref) || throw(ArgumentError(\"Expected a reference\"))\n           q = Expr(:ref, ex.args[1])\n           for i ∈ length(ex.args):-1:2\n               push!(q.args, ex.args[i])\n           end\n           esc(q)\n       end\n@reverse_indexing (macro with 1 method)\n\njulia&gt; @macroexpand @reverse_indexing A[i, j, k]\n:(A[k, j, i])```","user":"UAUPJLBQX","ts":"1618164138.024300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VkdZ","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> macro reverse_indexing(ex)\n           Meta.isexpr(ex, :ref) || throw(ArgumentError(\"Expected a reference\"))\n           q = Expr(:ref, ex.args[1])\n           for i ∈ length(ex.args):-1:2\n               push!(q.args, ex.args[i])\n           end\n           esc(q)\n       end\n@reverse_indexing (macro with 1 method)\n\njulia> @macroexpand @reverse_indexing A[i, j, k]\n:(A[k, j, i])"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0","reactions":[{"name":"fast_parrot","users":["U8D9768Q6","U0138UTB7A4"],"count":2}]},{"client_msg_id":"26ce19d3-bba6-421f-bad1-537363d0e476","type":"message","text":"Alternatively","user":"UAUPJLBQX","ts":"1618164202.024500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"KP6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Alternatively"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"7d36d4ad-3bd9-4754-870a-91b5ed9d470a","type":"message","text":"```Ap = PermutedDimsArray(A, (3,2,1));\nAp[i,j,k]```","user":"UAUPJLBQX","ts":"1618164229.024700","team":"T68168MUP","edited":{"user":"UAUPJLBQX","ts":"1618165298.000000"},"blocks":[{"type":"rich_text","block_id":"jSkA","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"Ap = PermutedDimsArray(A, (3,2,1));\nAp[i,j,k]"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0","reactions":[{"name":"open_mouth","users":["U0138UTB7A4","U0190AJCYK0"],"count":2}]},{"client_msg_id":"15e3932d-fa01-4c40-8fa9-d44b21939e1c","type":"message","text":"Beat me to it, Chris.","user":"U8D9768Q6","ts":"1618164246.025100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Dzq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Beat me to it, Chris."}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"4c6d0805-2981-42f8-87d0-624a35d2da04","type":"message","text":"```julia&gt; using MLStyle\n\njulia&gt; macro row_major(ex)\n           f = @λ begin\n               :($A[$(i...)]) =&gt; :($(f(A))[$reverse($(f.(i)))...])\n               ex::Expr =&gt; Expr(ex.head, f.(ex.args)...)\n               x =&gt; x\n           end\n           f(ex) |&gt; esc\n       end\n@row_major (macro with 1 method)\n\njulia&gt; A = rand(4,5,6);\n\njulia&gt; @row_major(A[1,2,3]) == A[3,2,1]\ntrue```","user":"U8D9768Q6","ts":"1618164250.025400","team":"T68168MUP","edited":{"user":"U8D9768Q6","ts":"1618164563.000000"},"blocks":[{"type":"rich_text","block_id":"4U93","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> using MLStyle\n\njulia> macro row_major(ex)\n           f = @λ begin\n               :($A[$(i...)]) => :($(f(A))[$reverse($(f.(i)))...])\n               ex::Expr => Expr(ex.head, f.(ex.args)...)\n               x => x\n           end\n           f(ex) |> esc\n       end\n@row_major (macro with 1 method)\n\njulia> A = rand(4,5,6);\n\njulia> @row_major(A[1,2,3]) == A[3,2,1]\ntrue"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0","reactions":[{"name":"slow_parrot","users":["U8D9768Q6"],"count":1}]},{"client_msg_id":"378c39e4-57da-41af-91a5-7b5ab6afecdd","type":"message","text":"One slight advantage of my macro is that it's recursive, so you can use it on a whole code block:\n```julia&gt; @row_major A[6, 5, 4] + A[1, 2, 3]\n1.0830898456808067\n\njulia&gt; A[4, 5, 6] + A[3, 2, 1]\n1.0830898456808067```","user":"U8D9768Q6","ts":"1618164431.026000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UWqM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"One slight advantage of my macro is that it's recursive, so you can use it on a whole code block:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @row_major A[6, 5, 4] + A[1, 2, 3]\n1.0830898456808067\n\njulia> A[4, 5, 6] + A[3, 2, 1]\n1.0830898456808067"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"a218814d-fd24-4f00-9f73-08406bd98cf2","type":"message","text":"Yeah, it'd take some more code (or a package like MLStyle or MacroTools) to walk an expression if you wanted to apply it to a code block.","user":"UAUPJLBQX","ts":"1618164490.026300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kXFW0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yeah, it'd take some more code (or a package like MLStyle or MacroTools) to walk an expression if you wanted to apply it to a code block."}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"042bb0dc-bf45-4d0e-bc1c-963551c75e03","type":"message","text":"```julia&gt; function reverse_index(ex)\n           q = Expr(:ref, ex.args[1])\n           for i ∈ length(ex.args):-1:2\n               push!(q.args, ex.args[i])\n           end\n           q\n       end\nreverse_index (generic function with 1 method)\n\njulia&gt; function reverse_indexing!(ex)\n           for i ∈ eachindex(ex.args)\n               _exa = ex.args[i]\n               _exa isa Expr || continue\n               exa::Expr = _exa\n               if exa.head === :ref\n                   ex.args[i] = reverse_index(exa)\n               else\n                   reverse_indexing!(exa)\n               end\n           end\n       end\nreverse_indexing! (generic function with 1 method)\n\njulia&gt; reverse_indexing(ex) = (q = copy(ex); reverse_indexing!(q); return q)\nreverse_indexing (generic function with 1 method)\n\njulia&gt; macro row_major(ex); esc(reverse_indexing(ex)); end\n@row_major (macro with 1 method)\n\njulia&gt; @macroexpand @row_major A[6, 5, 4] + A[1, 2, 3]\n:(A[4, 5, 6] + A[3, 2, 1])```","user":"UAUPJLBQX","ts":"1618164779.026600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yipU","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> function reverse_index(ex)\n           q = Expr(:ref, ex.args[1])\n           for i ∈ length(ex.args):-1:2\n               push!(q.args, ex.args[i])\n           end\n           q\n       end\nreverse_index (generic function with 1 method)\n\njulia> function reverse_indexing!(ex)\n           for i ∈ eachindex(ex.args)\n               _exa = ex.args[i]\n               _exa isa Expr || continue\n               exa::Expr = _exa\n               if exa.head === :ref\n                   ex.args[i] = reverse_index(exa)\n               else\n                   reverse_indexing!(exa)\n               end\n           end\n       end\nreverse_indexing! (generic function with 1 method)\n\njulia> reverse_indexing(ex) = (q = copy(ex); reverse_indexing!(q); return q)\nreverse_indexing (generic function with 1 method)\n\njulia> macro row_major(ex); esc(reverse_indexing(ex)); end\n@row_major (macro with 1 method)\n\njulia> @macroexpand @row_major A[6, 5, 4] + A[1, 2, 3]\n:(A[4, 5, 6] + A[3, 2, 1])"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"66fb7241-d6c0-47d4-ab57-ec208d5586bd","type":"message","text":"A major disadvantage of your `@row_major` compared to the above is that it is currrently allocating vectors","user":"UAUPJLBQX","ts":"1618164940.026800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"KCrL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"A major disadvantage of your "},{"type":"text","text":"@row_major","style":{"code":true}},{"type":"text","text":" compared to the above is that it is currrently allocating vectors"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"46fc3b78-1517-4663-bdb3-5f14a74901bc","type":"message","text":"```julia&gt; using MLStyle\n\njulia&gt; function rm_mlstyle(ex)\n           f = @λ begin\n               :($A[$(i...)]) =&gt; :($(f(A))[$reverse($(f.(i)))...])\n               ex::Expr =&gt; Expr(ex.head, f.(ex.args)...)\n               x =&gt; x\n           end\n           f(ex)\n       end\nrm_mlstyle (generic function with 1 method)\n\njulia&gt; rm_mlstyle(:(A[6,5,4] + A[1,2,3]))\n:(A[(reverse)([6, 5, 4])...] + A[(reverse)([1, 2, 3])...])```","user":"UAUPJLBQX","ts":"1618164950.027000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"loQY","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> using MLStyle\n\njulia> function rm_mlstyle(ex)\n           f = @λ begin\n               :($A[$(i...)]) => :($(f(A))[$reverse($(f.(i)))...])\n               ex::Expr => Expr(ex.head, f.(ex.args)...)\n               x => x\n           end\n           f(ex)\n       end\nrm_mlstyle (generic function with 1 method)\n\njulia> rm_mlstyle(:(A[6,5,4] + A[1,2,3]))\n:(A[(reverse)([6, 5, 4])...] + A[(reverse)([1, 2, 3])...])"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"88ef1cc2-4660-4fcd-8519-2dcb5173e895","type":"message","text":"A dump shows:\n```            1: Expr\n              head: Symbol call\n              args: Array{Any}((2,))\n                1: reverse (function of type typeof(reverse))\n                2: Array{Int64}((3,)) [1, 2, 3]```","user":"UAUPJLBQX","ts":"1618164969.027200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RYju","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"A dump shows:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"            1: Expr\n              head: Symbol call\n              args: Array{Any}((2,))\n                1: reverse (function of type typeof(reverse))\n                2: Array{Int64}((3,)) [1, 2, 3]"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"16a1cc99-6a0c-4e21-aebf-e0c84e2db60b","type":"message","text":"The macro itself is also around 20x slower to expand, aside from adding a dependency:","user":"UAUPJLBQX","ts":"1618165055.027400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"smZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The macro itself is also around 20x slower to expand, aside from adding a dependency:"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"e67929f9-cf70-4f9d-ba78-332e5869e8e7","type":"message","text":"```julia&gt; @benchmark reverse_indexing(:(A[6,5,4] + A[1,2,3]))\nBenchmarkTools.Trial:\n  memory estimate:  1.19 KiB\n  allocs estimate:  18\n  --------------\n  minimum time:     512.740 ns (0.00% GC)\n  median time:      542.804 ns (0.00% GC)\n  mean time:        729.307 ns (22.56% GC)\n  maximum time:     42.551 μs (97.74% GC)\n  --------------\n  samples:          10000\n  evals/sample:     196\n\njulia&gt; @benchmark rm_mlstyle(:(A[6,5,4] + A[1,2,3]))\nBenchmarkTools.Trial:\n  memory estimate:  6.41 KiB\n  allocs estimate:  119\n  --------------\n  minimum time:     9.901 μs (0.00% GC)\n  median time:      10.299 μs (0.00% GC)\n  mean time:        11.480 μs (7.09% GC)\n  maximum time:     8.224 ms (98.92% GC)\n  --------------\n  samples:          10000\n  evals/sample:     1```","user":"UAUPJLBQX","ts":"1618165056.027600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"J/TAH","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @benchmark reverse_indexing(:(A[6,5,4] + A[1,2,3]))\nBenchmarkTools.Trial:\n  memory estimate:  1.19 KiB\n  allocs estimate:  18\n  --------------\n  minimum time:     512.740 ns (0.00% GC)\n  median time:      542.804 ns (0.00% GC)\n  mean time:        729.307 ns (22.56% GC)\n  maximum time:     42.551 μs (97.74% GC)\n  --------------\n  samples:          10000\n  evals/sample:     196\n\njulia> @benchmark rm_mlstyle(:(A[6,5,4] + A[1,2,3]))\nBenchmarkTools.Trial:\n  memory estimate:  6.41 KiB\n  allocs estimate:  119\n  --------------\n  minimum time:     9.901 μs (0.00% GC)\n  median time:      10.299 μs (0.00% GC)\n  mean time:        11.480 μs (7.09% GC)\n  maximum time:     8.224 ms (98.92% GC)\n  --------------\n  samples:          10000\n  evals/sample:     1"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"e37b63d1-0322-4d6b-b972-d1ec000f9ced","type":"message","text":"Basically, why I always end up rolling my own.","user":"UAUPJLBQX","ts":"1618165067.027800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PJz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Basically, why I always end up rolling my own."}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"0b3ff015-2c98-4f9d-87b4-c3a96120de79","type":"message","text":"Wow.. that was quick! So many solutions :smile:","user":"U0190AJCYK0","ts":"1618165221.028100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UEXR","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Wow.. that was quick! So many solutions "},{"type":"emoji","name":"smile"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"e5f43c6b-4150-4153-8124-91ff45daaaf0","type":"message","text":"```julia&gt; A = rand(7,7,7);\n\njulia&gt; macro row_major(ex); esc(reverse_indexing(ex)); end\n@row_major (macro with 1 method)\n\njulia&gt; macro row_major_mlstyle(ex); esc(rm_mlstyle(ex)); end\n@row_major_mlstyle (macro with 1 method)\n\njulia&gt; @btime $A[4,5,6] + $A[3,2,1]\n  2.252 ns (0 allocations: 0 bytes)\n0.9243098717119442\n\njulia&gt; @btime @row_major $A[6,5,4] + $A[1,2,3]\n  2.253 ns (0 allocations: 0 bytes)\n0.9243098717119442\n\njulia&gt; @btime @row_major_mlstyle $A[6,5,4] + $A[1,2,3]\n  235.028 ns (7 allocations: 304 bytes)\n0.9243098717119442```","user":"UAUPJLBQX","ts":"1618165228.028300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"iE3","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> A = rand(7,7,7);\n\njulia> macro row_major(ex); esc(reverse_indexing(ex)); end\n@row_major (macro with 1 method)\n\njulia> macro row_major_mlstyle(ex); esc(rm_mlstyle(ex)); end\n@row_major_mlstyle (macro with 1 method)\n\njulia> @btime $A[4,5,6] + $A[3,2,1]\n  2.252 ns (0 allocations: 0 bytes)\n0.9243098717119442\n\njulia> @btime @row_major $A[6,5,4] + $A[1,2,3]\n  2.253 ns (0 allocations: 0 bytes)\n0.9243098717119442\n\njulia> @btime @row_major_mlstyle $A[6,5,4] + $A[1,2,3]\n  235.028 ns (7 allocations: 304 bytes)\n0.9243098717119442"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"c0fead50-c972-4266-aa14-f604510f4899","type":"message","text":"```Ap = PermutedDimsArrays(A, (3,2,1));\nAp[i,j,k]```\nThis seems pretty good actually. Even better than a macro.. :flushed:","user":"U0190AJCYK0","ts":"1618165238.028500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"06ICx","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"Ap = PermutedDimsArrays(A, (3,2,1));\nAp[i,j,k]"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"This seems pretty good actually. Even better than a macro.. "},{"type":"emoji","name":"flushed"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"58423adf-1795-43ea-81c6-613041588d5d","type":"message","text":"Yeah, `PermutedDimsArrray` (shouldn't have the `s` at the end) can give you row major arrays, or whatever order you want.","user":"UAUPJLBQX","ts":"1618165268.028700","team":"T68168MUP","edited":{"user":"UAUPJLBQX","ts":"1618165280.000000"},"blocks":[{"type":"rich_text","block_id":"GEb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yeah, "},{"type":"text","text":"PermutedDimsArrray","style":{"code":true}},{"type":"text","text":" (shouldn't have the "},{"type":"text","text":"s","style":{"code":true}},{"type":"text","text":" at the end) can give you row major arrays, or whatever order you want."}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0","reactions":[{"name":"heavy_check_mark","users":["U0190AJCYK0"],"count":1}]},{"client_msg_id":"1369e697-e974-4edf-9fbe-c6b7034a87ed","type":"message","text":"Thanks a lot <@UAUPJLBQX> and <@U8D9768Q6> for your help! :smile:","user":"U0190AJCYK0","ts":"1618165307.029200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+Q5Pw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks a lot "},{"type":"user","user_id":"UAUPJLBQX"},{"type":"text","text":" and "},{"type":"user","user_id":"U8D9768Q6"},{"type":"text","text":" for your help! "},{"type":"emoji","name":"smile"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0"},{"client_msg_id":"a4b8dec8-2d8c-47b5-84b4-98b7a10d7b53","type":"message","text":"Oh, whoops that was just bad parentheses placement on my part:\n```julia&gt; macro row_major(ex)\n           f = @λ begin\n               :($A[$(i...)]) =&gt; :($(f(A))[$(reverse(f.(i))...)])\n               ex::Expr =&gt; Expr(ex.head, f.(ex.args)...)\n               x =&gt; x\n           end\n           f(ex) |&gt; esc\n       end\n@row_major (macro with 1 method)\n\njulia&gt; @btime @row_major $A[6,5,4] + $A[1,2,3]\n  2.129 ns (0 allocations: 0 bytes)\n1.0830898456808067```","user":"U8D9768Q6","ts":"1618165417.029400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"diBc6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Oh, whoops that was just bad parentheses placement on my part:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> macro row_major(ex)\n           f = @λ begin\n               :($A[$(i...)]) => :($(f(A))[$(reverse(f.(i))...)])\n               ex::Expr => Expr(ex.head, f.(ex.args)...)\n               x => x\n           end\n           f(ex) |> esc\n       end\n@row_major (macro with 1 method)\n\njulia> @btime @row_major $A[6,5,4] + $A[1,2,3]\n  2.129 ns (0 allocations: 0 bytes)\n1.0830898456808067"}]}]}],"thread_ts":"1618163548.024200","parent_user_id":"U0190AJCYK0","reactions":[{"name":"+1","users":["UAUPJLBQX"],"count":1}]}]