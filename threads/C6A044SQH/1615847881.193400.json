[{"client_msg_id":"15a8cb7c-a583-4fa3-a8dd-83263b2df747","type":"message","text":"Hi All,\nCan someone please help me here. I am trying to use @distributed loop to assign values to one array. However, with multiple workers, the code is running slower and using much more allocations.\n\nThanks\n\nHere is the code.\n\n```using BenchmarkTools, Distributed\naddprocs(4)\n@everywhere using SharedArrays\n\nprintln( \"nWorkers: \", nworkers() )\nprintln( \"nThreads: \", Threads.nthreads() )\n\nfunction calc_loop( nk::Int, x::SharedArray)\n    for n=1:nk\n        for i=1:size(x)[1]\n            for j=1:size(x)[2]\n                for k=1:size(x)[3]\n                    x[i,j,k] = 1.0\n                end\n            end\n        end      \n    end\n    return x\nend\n\nfunction calc_loop_parallel( nk::Int, x::SharedArray)\n    for n=1:nk\n        @sync @distributed  for i=1:size(x)[1]\n            for j=1:size(x)[2]\n                for k=1:size(x)[3]\n                    x[i,j,k] = 1.0\n                end\n            end\n        end \n    end\n    return x\nend\n\n\nN = 100\na = SharedArray{Float32,3}(N, N, N)\n\nfor i=1:4\n    @time calc_loop( 2, a)\n    println( \"Sum: \", sum(a) )\n    @time calc_loop_parallel( 10, a)\n    println( \"Sum (parallel): \", sum(a) )\n\n    println(\"----------------\")\nend```","user":"U01H3MBQDDF","ts":"1615847881.193400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ixwi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hi All,\nCan someone please help me here. I am trying to use @distributed loop to assign values to one array. However, with multiple workers, the code is running slower and using much more allocations.\n\nThanks\n\nHere is the code.\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using BenchmarkTools, Distributed\naddprocs(4)\n@everywhere using SharedArrays\n\nprintln( \"nWorkers: \", nworkers() )\nprintln( \"nThreads: \", Threads.nthreads() )\n\nfunction calc_loop( nk::Int, x::SharedArray)\n    for n=1:nk\n        for i=1:size(x)[1]\n            for j=1:size(x)[2]\n                for k=1:size(x)[3]\n                    x[i,j,k] = 1.0\n                end\n            end\n        end      \n    end\n    return x\nend\n\nfunction calc_loop_parallel( nk::Int, x::SharedArray)\n    for n=1:nk\n        @sync @distributed  for i=1:size(x)[1]\n            for j=1:size(x)[2]\n                for k=1:size(x)[3]\n                    x[i,j,k] = 1.0\n                end\n            end\n        end \n    end\n    return x\nend\n\n\nN = 100\na = SharedArray{Float32,3}(N, N, N)\n\nfor i=1:4\n    @time calc_loop( 2, a)\n    println( \"Sum: \", sum(a) )\n    @time calc_loop_parallel( 10, a)\n    println( \"Sum (parallel): \", sum(a) )\n\n    println(\"----------------\")\nend"}]}]}],"thread_ts":"1615847881.193400","reply_count":9,"reply_users_count":3,"latest_reply":"1615854569.199600","reply_users":["B01J9QZ4SP8","U012XER8K4M","U01H3MBQDDF"],"subscribed":false},{"type":"message","subtype":"bot_message","text":"Can we cross post this publicly to <https://discourse.julialang.org|Discourse> for further visibility? React with :bridge: on the message above to approve. <https://github.com/JuliaCommunity/SlackBridge/blob/main/README.md#faq|More info here>","ts":"1615847882.193500","username":"HelpDeskBot","bot_id":"B01J9QZ4SP8","thread_ts":"1615847881.193400","parent_user_id":"U01H3MBQDDF"},{"client_msg_id":"41b6d001-81fc-4e88-a78b-8cd5de4839c4","type":"message","text":"memset'ing isn't really a very CPU intensive task to start with, I would expect it to be mostly memory bandwidth bound if anything.","user":"U012XER8K4M","ts":"1615848557.195800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"MdC6q","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"memset'ing isn't really a very CPU intensive task to start with, I would expect it to be mostly memory bandwidth bound if anything."}]}]}],"thread_ts":"1615847881.193400","parent_user_id":"U01H3MBQDDF"},{"client_msg_id":"ad45e722-2b25-4da1-ac65-9d8bb4d347b2","type":"message","text":"You are probably also pezzimising your code a lot by the loop order you have, though your example seems small enough to fit in cache anyway","user":"U012XER8K4M","ts":"1615848624.196200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QhsVc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"You are probably also pezzimising your code a lot by the loop order you have, though your example seems small enough to fit in cache anyway"}]}]}],"thread_ts":"1615847881.193400","parent_user_id":"U01H3MBQDDF"},{"client_msg_id":"e05a7b42-d407-449e-ae28-0e8f112c1bbb","type":"message","text":"I tried bumping up your size N=1000 and I huge benefit to switching i and k around","user":"U012XER8K4M","ts":"1615848657.196400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YJw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I tried bumping up your size N=1000 and I huge benefit to switching i and k around"}]}]}],"thread_ts":"1615847881.193400","parent_user_id":"U01H3MBQDDF"},{"client_msg_id":"913426ec-6fd8-42ca-bca3-78f238c85dfd","type":"message","text":"Actually, my goal is use N&gt;2000. Does that mean more allocation is happening because of column-wise memory allocation? Pardon me to not use right language for hardware related words.","user":"U01H3MBQDDF","ts":"1615849380.196600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"aViPB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Actually, my goal is use N>2000. Does that mean more allocation is happening because of column-wise memory allocation? Pardon me to not use right language for hardware related words."}]}]}],"thread_ts":"1615847881.193400","parent_user_id":"U01H3MBQDDF"},{"client_msg_id":"a6935fe4-5e29-4d82-bae1-1762a09e8252","type":"message","text":"No i don't think it affects number of allocations, but you are killing the cache locality if you write in a \"bad\" order like this. Allocations aren't the only thing that can make your code slow. This is irrespective of distributed arrays or not.\nI'm not very familiar with SharedArrays and Distributed in Julia, so I can't give specific recommendations there.","user":"U012XER8K4M","ts":"1615850430.196800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"K6y21","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"No i don't think it affects number of allocations, but you are killing the cache locality if you write in a \"bad\" order like this. Allocations aren't the only thing that can make your code slow. This is irrespective of distributed arrays or not.\nI'm not very familiar with SharedArrays and Distributed in Julia, so I can't give specific recommendations there."}]}]}],"thread_ts":"1615847881.193400","parent_user_id":"U01H3MBQDDF"},{"client_msg_id":"e84a08ad-645c-4278-b95a-e7644962640d","type":"message","text":"But I would suspect not a whole lot can be gained from a setindex parallelization; it's just not enough CPU work.","user":"U012XER8K4M","ts":"1615850464.197000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"IHx9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But I would suspect not a whole lot can be gained from a setindex parallelization; it's just not enough CPU work."}]}]}],"thread_ts":"1615847881.193400","parent_user_id":"U01H3MBQDDF"},{"client_msg_id":"f912dd2f-a3df-4fab-bcf7-b1c33d56f024","type":"message","text":"unless you need i j k indexing for something particular, best just to leave it to julia to pick what it likest best;\n```function calc_loop( nk::Int, x::SharedArray)\n    for n=1:nk\n        for i = eachindex(x)\n            x[i] = 1.0\n        end      \n    end\n    return x\nend\n\nfunction calc_loop_parallel( nk::Int, x::SharedArray)\n    for n=1:nk\n        @sync @distributed for i = eachindex(x)\n            x[i] = 1.0\n        end \n    end\n    return x\nend```\n","user":"U012XER8K4M","ts":"1615850553.197200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Yrc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"unless you need i j k indexing for something particular, best just to leave it to julia to pick what it likest best;\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function calc_loop( nk::Int, x::SharedArray)\n    for n=1:nk\n        for i = eachindex(x)\n            x[i] = 1.0\n        end      \n    end\n    return x\nend\n\nfunction calc_loop_parallel( nk::Int, x::SharedArray)\n    for n=1:nk\n        @sync @distributed for i = eachindex(x)\n            x[i] = 1.0\n        end \n    end\n    return x\nend"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1615847881.193400","parent_user_id":"U01H3MBQDDF"},{"client_msg_id":"9a87d2b7-1c50-483d-8fc3-f6d912f30cb3","type":"message","text":"Alright, thanks for the help.","user":"U01H3MBQDDF","ts":"1615854569.199600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Wjco","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Alright, thanks for the help."}]}]}],"thread_ts":"1615847881.193400","parent_user_id":"U01H3MBQDDF"}]