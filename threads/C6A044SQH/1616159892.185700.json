[{"client_msg_id":"41cb8297-48f6-4862-8373-250815b1fbb5","type":"message","text":"Is filtering a tuple unavoidably type unstable? E.g:\n```using InteractiveUtils\n\na = (1,2,3,4,5)\nb = (2,3)\n\nfunction my_filter(a,b)\n  c = filter(!in(b), a)\nend\n\n@code_warntype my_filter(a, b)```\nResults in:\n```Variables\n  #self#::Core.Const(my_filter)\n  a::NTuple{5, Int64}\n  b::Tuple{Int64, Int64}\n  c::**RED**Tuple{Vararg{Int64, N} where N}**RED**\n\nBody::**RED**Tuple{Vararg{Int64, N} where N}**RED**\n1 ─ %1 = (in)(b)::Base.Fix2{typeof(in), Tuple{Int64, Int64}}\n│   %2 = !%1::Base.var\"#76#77\"{Base.Fix2{typeof(in), Tuple{Int64, Int64}}}\n│   %3 = Main.filter(%2, a)**RED**::Tuple{Vararg{Int64, N} where N}**RED**\n│        (c = %3)\n└──      return %3```","user":"UEA5FBCRH","ts":"1616159892.185700","team":"T68168MUP","edited":{"user":"UEA5FBCRH","ts":"1616159915.000000"},"blocks":[{"type":"rich_text","block_id":"05L","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is filtering a tuple unavoidably type unstable? E.g:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using InteractiveUtils\n\na = (1,2,3,4,5)\nb = (2,3)\n\nfunction my_filter(a,b)\n  c = filter(!in(b), a)\nend\n\n@code_warntype my_filter(a, b)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Results in:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"Variables\n  #self#::Core.Const(my_filter)\n  a::NTuple{5, Int64}\n  b::Tuple{Int64, Int64}\n  c::**RED**Tuple{Vararg{Int64, N} where N}**RED**\n\nBody::**RED**Tuple{Vararg{Int64, N} where N}**RED**\n1 ─ %1 = (in)(b)::Base.Fix2{typeof(in), Tuple{Int64, Int64}}\n│   %2 = !%1::Base.var\"#76#77\"{Base.Fix2{typeof(in), Tuple{Int64, Int64}}}\n│   %3 = Main.filter(%2, a)**RED**::Tuple{Vararg{Int64, N} where N}**RED**\n│        (c = %3)\n└──      return %3"}]}]}],"thread_ts":"1616159892.185700","reply_count":47,"reply_users_count":6,"latest_reply":"1616170267.213200","reply_users":["B01J9QZ4SP8","UEA5FBCRH","U7HAYKY9X","U6N6VQE30","U6QPTG69E","U01PLQWQXPV"],"subscribed":false},{"type":"message","subtype":"bot_message","text":"Can we cross post this publicly to <https://discourse.julialang.org|Discourse> for further visibility? React with :bridge: on the message above to approve. <https://github.com/JuliaCommunity/SlackBridge/blob/main/README.md#faq|More info here>","ts":"1616159893.185800","username":"HelpDeskBot","bot_id":"B01J9QZ4SP8","thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"0e9cdd0e-5a48-468a-97d7-21bf1f632d4b","type":"message","text":"Which actually makes sense if it is. So my follow-up question would be, is there a way to get around this fact? My goal is performance.","user":"UEA5FBCRH","ts":"1616159972.186100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Q+lU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Which actually makes sense if it is. So my follow-up question would be, is there a way to get around this fact? My goal is performance."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"265505b2-b858-430d-9bac-d9779878882c","type":"message","text":"It is, yes. To get around it, you can perhaps \"pad\" the output tuple with sentinel values","user":"U7HAYKY9X","ts":"1616160009.186300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"IYpW","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It is, yes. To get around it, you can perhaps \"pad\" the output tuple with sentinel values"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"94d5fbae-2593-4256-8e91-f478759d7afc","type":"message","text":"Never heard of sentinel values. Are they like \"missing\" values? Could you maybe show me a small example that uses sentinel values?","user":"UEA5FBCRH","ts":"1616160067.186500","team":"T68168MUP","edited":{"user":"UEA5FBCRH","ts":"1616160108.000000"},"blocks":[{"type":"rich_text","block_id":"3Pc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Never heard of sentinel values. Are they like \"missing\" values? Could you maybe show me a small example that uses sentinel values?"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"dd613229-c11f-4594-a990-02f2a5675043","type":"message","text":"It just means a value with a special meaning to you. For example 0 could be a special value, if you know you wno't otherwise get zeroes","user":"U7HAYKY9X","ts":"1616160114.186800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cFE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It just means a value with a special meaning to you. For example 0 could be a special value, if you know you wno't otherwise get zeroes"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"73b5bdd8-8a87-4d29-b7b8-b159e11ca972","type":"message","text":"AAhh ok. I get it. Thanks <@U7HAYKY9X>","user":"UEA5FBCRH","ts":"1616160133.187000","team":"T68168MUP","edited":{"user":"UEA5FBCRH","ts":"1616160149.000000"},"blocks":[{"type":"rich_text","block_id":"1P2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"AAhh ok. I get it. Thanks "},{"type":"user","user_id":"U7HAYKY9X"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH","reactions":[{"name":"+1","users":["U7HAYKY9X"],"count":1}]},{"client_msg_id":"d0119a15-8750-40d5-940e-7ab3df4822d8","type":"message","text":"Might be really hard to get it to be type stable in practice, though","user":"U7HAYKY9X","ts":"1616160165.187400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Wgj","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Might be really hard to get it to be type stable in practice, though"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"839d6593-d97d-4743-91ae-f3f52646c68c","type":"message","text":"it can be stable if you lift the values to Val's","user":"U6N6VQE30","ts":"1616160278.187800","team":"T68168MUP","edited":{"user":"U6N6VQE30","ts":"1616160283.000000"},"blocks":[{"type":"rich_text","block_id":"m==","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it can be stable if you lift the values to Val's"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"c9d7771a-1725-4c8b-93db-a12ecca9af44","type":"message","text":"but maybe better to just use a temporary vector","user":"U6N6VQE30","ts":"1616160307.188100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cX4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but maybe better to just use a temporary vector"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"0c417515-f7a4-4141-bfbe-cd32ce39d68e","type":"message","text":"I tried lifting the values to Val's, but the return type is still type unstable:\n```function my_filter2(::Val{a},::Val{b})\n  c = filter(!in(b), a)\nend\n@code_warntype my_filter2(Val(a), Val(b))```\nHow can I fix this? I'm just exploring and benchmarking to see it helps or not.","user":"UEA5FBCRH","ts":"1616160809.189400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"G4Gn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I tried lifting the values to Val's, but the return type is still type unstable:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function my_filter2(::Val{a},::Val{b})\n  c = filter(!in(b), a)\nend\n@code_warntype my_filter2(Val(a), Val(b))"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"How can I fix this? I'm just exploring and benchmarking to see it helps or not."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"c6fa6641-226a-45ad-be74-adeccb47b657","type":"message","text":"Unbelievably, this is actually efficient\n```using Setfield\n\nfunction foo(f, v::T, x::NTuple{N, T}) where {N, T}\n    res = x\n    j = 0\n    @inbounds for i in 1:N\n        res = @set res[i] = v\n        if f(x[i])\n            j += 1\n            res = @set res[j] = x[i]\n        end\n    end\n    res\nend   ```\nupdate: even better :)","user":"U7HAYKY9X","ts":"1616160815.189600","team":"T68168MUP","edited":{"user":"U7HAYKY9X","ts":"1616161141.000000"},"blocks":[{"type":"rich_text","block_id":"sHr","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Unbelievably, this is actually efficient\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using Setfield\n\nfunction foo(f, v::T, x::NTuple{N, T}) where {N, T}\n    res = x\n    j = 0\n    @inbounds for i in 1:N\n        res = @set res[i] = v\n        if f(x[i])\n            j += 1\n            res = @set res[j] = x[i]\n        end\n    end\n    res\nend   "}]},{"type":"rich_text_section","elements":[{"type":"text","text":"update: even better :)"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"83cce46a-9db6-464e-994d-bc55c98dd8f2","type":"message","text":"ohh wow.. it is super efficient.","user":"UEA5FBCRH","ts":"1616161084.190000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7BE8q","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ohh wow.. it is super efficient."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"f0aa528c-6a03-486b-8366-bfe8c55883de","type":"message","text":"I have to see if the rest of my application can cope with these sentinel values.","user":"UEA5FBCRH","ts":"1616161121.190200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gBTuL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I have to see if the rest of my application can cope with these sentinel values."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"475c6175-2282-4ea7-b275-79afdffbfde2","type":"message","text":"What is `v` in the example?","user":"UEA5FBCRH","ts":"1616161407.190500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"11M","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What is "},{"type":"text","text":"v","style":{"code":true}},{"type":"text","text":" in the example?"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"a7e1a630-ac7e-4de0-a4aa-550c37cbf3ad","type":"message","text":"I'm not familiar with the Setfield package. I'm going to read about it.","user":"UEA5FBCRH","ts":"1616161468.190700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"fNtxS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm not familiar with the Setfield package. I'm going to read about it."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"ec0eeffa-3e15-4db7-a86c-85e05d03a79e","type":"message","text":"`v` is the sentinel value","user":"U7HAYKY9X","ts":"1616161521.190900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PKb1f","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"v","style":{"code":true}},{"type":"text","text":" is the sentinel value"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"4f2a2860-7508-488f-af61-e8bc2fcd61ab","type":"message","text":"AAhh ok.","user":"UEA5FBCRH","ts":"1616161529.191100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+YET","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"AAhh ok."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"87dc2517-776f-47b8-ade4-0b2e4939bb70","type":"message","text":"please don't publish this code :sweat_smile:, julia will be a laughing stock for the outside world","user":"U6N6VQE30","ts":"1616161588.191300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RWwl","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"please don't publish this code "},{"type":"emoji","name":"sweat_smile"},{"type":"text","text":", julia will be a laughing stock for the outside world"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"d85ea94a-728c-4f0a-9009-8ff5618fd8c0","type":"message","text":"It's ok. I'll just publish the benchmark results :yum:.. and then it will be a trigger of awe to the outside world","user":"UEA5FBCRH","ts":"1616161628.191500","team":"T68168MUP","edited":{"user":"UEA5FBCRH","ts":"1616161701.000000"},"blocks":[{"type":"rich_text","block_id":"ORBbZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It's ok. I'll just publish the benchmark results "},{"type":"emoji","name":"yum"},{"type":"text","text":".. and then it will be a trigger of awe to the outside world"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"4b3d5407-dbc9-4ff3-a520-6914fdad7ee2","type":"message","text":"It's bad? :sweat_smile:","user":"U7HAYKY9X","ts":"1616161701.191900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1bs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It's bad? "},{"type":"emoji","name":"sweat_smile"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"380c510b-c435-4fc3-80ef-d5c3faa868e1","type":"message","text":"but wait.. how do I invoke that last example? this gives me an error:\n```@btime foo(in, 0, x)```","user":"UEA5FBCRH","ts":"1616161748.192200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Upm6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but wait.. how do I invoke that last example? this gives me an error:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"@btime foo(in, 0, x)"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"03f013be-732f-4cc3-bcb6-a1a166a9ca5e","type":"message","text":"It's a one-argument function","user":"U7HAYKY9X","ts":"1616161774.192400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"x4U","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It's a one-argument function"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"5953d180-4aeb-4348-aaa0-36bb160c7daa","type":"message","text":"ahh ok..","user":"UEA5FBCRH","ts":"1616161784.192600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"cPp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ahh ok.."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"9b890245-394d-4e57-bae9-a900cfd91507","type":"message","text":"well, my issues: it's close to indecipherable; it doesn't do the exact same thing, cause now the rest of the code has to special-case sentinel values.","user":"U6N6VQE30","ts":"1616161921.192800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qbTFM","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"well, my issues: it's close to indecipherable; it doesn't do the exact same thing, cause now the rest of the code has to special-case sentinel values."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"d83f14f8-213d-4551-8b25-4965189f2308","type":"message","text":"that's true.. i have no idea how this works..","user":"UEA5FBCRH","ts":"1616161969.193000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/5+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that's true.. i have no idea how this works.."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"94ff6695-1f3e-4a22-8995-b9810f0024ba","type":"message","text":"And normally I would just stay with the readable version, but the performance gain is huge.. so now I have to understand how this works.","user":"UEA5FBCRH","ts":"1616162045.193200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"H/M1W","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"And normally I would just stay with the readable version, but the performance gain is huge.. so now I have to understand how this works."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"5b21d349-e480-4b8b-ac56-dba0e9fa7b15","type":"message","text":"Well, normally, if you have a variable-length data type, it should be a vector, not a tuple. Perhaps you were paying an unresonable cost from having type unstable code before?","user":"U7HAYKY9X","ts":"1616162113.193400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"tpSy","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Well, normally, if you have a variable-length data type, it should be a vector, not a tuple. Perhaps you were paying an unresonable cost from having type unstable code before?"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"9173c531-03c2-4206-b6d0-51f96c08b19c","type":"message","text":"you'd have to show how you actually use it before we can even know what is known compile-time and what runtime values are","user":"U6N6VQE30","ts":"1616162176.193700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6/s","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you'd have to show how you actually use it before we can even know what is known compile-time and what runtime values are"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"32e5ee0b-bb3a-46e0-8aae-8e1d703d30d0","type":"message","text":"jakob's code tries to do everything on the stack, subject to the limitations of julia's immutable stack variables","user":"U6N6VQE30","ts":"1616162220.193900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"14hs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"jakob's code tries to do everything on the stack, subject to the limitations of julia's immutable stack variables"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"c585dbd7-d46b-4bfa-890a-a96950725fb8","type":"message","text":"(also, it turns out my code is really slow if you have non-power of two lengths like 31, because it compiles to a crazy inefficient SIMD loop, much slower than just allocating a new vector, so you should probably just do that :shame: )","user":"U7HAYKY9X","ts":"1616162294.194100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4sjcW","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"(also, it turns out my code is really slow if you have non-power of two lengths like 31, because it compiles to a crazy inefficient SIMD loop, much slower than just allocating a new vector, so you should probably just do that "},{"type":"emoji","name":"shame"},{"type":"text","text":" )"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"493255e9-9a8e-499c-a6a1-f0373aa11bb4","type":"message","text":"Hmm.. I see. What I think is happening with my code is that parts of it work better with tuples, and other parts work better with vectors. Overall, I got better results with Tuples. But this is a small portion of my code where Vectors would be better.","user":"UEA5FBCRH","ts":"1616162295.194300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1jQ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm.. I see. What I think is happening with my code is that parts of it work better with tuples, and other parts work better with vectors. Overall, I got better results with Tuples. But this is a small portion of my code where Vectors would be better."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"aa4cf388-f175-4139-b94f-988bcb813c2c","type":"message","text":"Can I share the function where I'm using this with you guys? Maybe you can help me with ideas of how to improve it.","user":"UEA5FBCRH","ts":"1616162423.194500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Yx2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Can I share the function where I'm using this with you guys? Maybe you can help me with ideas of how to improve it."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH","reactions":[{"name":"+1","users":["U6N6VQE30"],"count":1}]},{"client_msg_id":"a53c3e73-299f-4140-9ec2-72f96e383bda","type":"message","text":"I have a `Factor` type in my code which holds an N-dimensional array. Moreover, the factor has a `vars` field that acts as *names* for each dimension. One of the performance critical functions in my code is one where I sum out one or more dimensions. And this is the one I'm trying to optimize. This was my initial implementation:\n```using BenchmarkTools, InteractiveUtils\n\nstruct Factor{T, N}\n  vars::NTuple{N,Int64}\n  vals::Array{T}\nend\n\ngetdims(::Factor{T,N}) where{T,N} = N\n\nfunction marginalize(A::Factor{T,N} where N, V::Vector{Int64}) where T \n  dims = indexin(V, collect(A.vars)) # map vars to dims\n  r_size = ntuple(d-&gt;d in dims ? 1 : size(A.vals,d), getdims(A)) # assign 1 to summed out dims\n  ret_vars = filter(!in(V), A.vars)\n  r_vals = similar(A.vals, r_size)\n  ret_vals = sum!(r_vals, A.vals) |&gt; x -&gt; dropdims(x, dims=Tuple(dims))\n  Factor{T,length(ret_vars)}(ret_vars, ret_vals)\nend\n\ninput = 1:8 |&gt; x -&gt; reshape(x, 2,2,2) |&gt; float |&gt; collect\ndims = [1,2]\n\nA_vars = (1,2,3)\nA_card = size(input)\n\nA = Factor{Float64,length(A_card)}(A_vars, input)\n@btime marginalize($A, dims)\n@code_warntype marginalize(A, dims)```\n","user":"UEA5FBCRH","ts":"1616162655.194800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"R1oH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I have a "},{"type":"text","text":"Factor","style":{"code":true}},{"type":"text","text":" type in my code which holds an N-dimensional array. Moreover, the factor has a "},{"type":"text","text":"vars","style":{"code":true}},{"type":"text","text":" field that acts as "},{"type":"text","text":"names","style":{"bold":true}},{"type":"text","text":" for each dimension. One of the performance critical functions in my code is one where I sum out one or more dimensions. And this is the one I'm trying to optimize. This was my initial implementation:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using BenchmarkTools, InteractiveUtils\n\nstruct Factor{T, N}\n  vars::NTuple{N,Int64}\n  vals::Array{T}\nend\n\ngetdims(::Factor{T,N}) where{T,N} = N\n\nfunction marginalize(A::Factor{T,N} where N, V::Vector{Int64}) where T \n  dims = indexin(V, collect(A.vars)) # map vars to dims\n  r_size = ntuple(d->d in dims ? 1 : size(A.vals,d), getdims(A)) # assign 1 to summed out dims\n  ret_vars = filter(!in(V), A.vars)\n  r_vals = similar(A.vals, r_size)\n  ret_vals = sum!(r_vals, A.vals) |> x -> dropdims(x, dims=Tuple(dims))\n  Factor{T,length(ret_vars)}(ret_vars, ret_vals)\nend\n\ninput = 1:8 |> x -> reshape(x, 2,2,2) |> float |> collect\ndims = [1,2]\n\nA_vars = (1,2,3)\nA_card = size(input)\n\nA = Factor{Float64,length(A_card)}(A_vars, input)\n@btime marginalize($A, dims)\n@code_warntype marginalize(A, dims)"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"3a4df988-614e-4cd3-ac7c-8847d63fab7e","type":"message","text":"I have made a few improvements. One is that I'm using the barrier trick to separate the summing part from the rest of the function. The other one is that I replaced the first line of the function since the `collect` in there was allocating memory and slowing down my function.","user":"UEA5FBCRH","ts":"1616162770.195000","team":"T68168MUP","edited":{"user":"UEA5FBCRH","ts":"1616162809.000000"},"blocks":[{"type":"rich_text","block_id":"V13","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I have made a few improvements. One is that I'm using the barrier trick to separate the summing part from the rest of the function. The other one is that I replaced the first line of the function since the "},{"type":"text","text":"collect","style":{"code":true}},{"type":"text","text":" in there was allocating memory and slowing down my function."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"07aac44d-76bd-4ee0-b326-1e3dd3488a92","type":"message","text":"You certainly need to annotate the vals field as `Array{T, N}`","user":"U7HAYKY9X","ts":"1616162809.195300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/Uj9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"You certainly need to annotate the vals field as "},{"type":"text","text":"Array{T, N}","style":{"code":true}}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"fc64adc5-cf8a-4879-860a-f1cfbfbc1bcd","type":"message","text":"I actually did that, and my code slowed down.","user":"UEA5FBCRH","ts":"1616162844.195500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"eZib","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I actually did that, and my code slowed down."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH","reactions":[{"name":"question","users":["U7HAYKY9X"],"count":1},{"name":"thinking_face","users":["U7HAYKY9X"],"count":1}]},{"client_msg_id":"4e3fdc6e-f7b6-4230-b97c-f657a92ee245","type":"message","text":"Ah, because the code is type unstable.","user":"U7HAYKY9X","ts":"1616162927.195900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1g1TR","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah, because the code is type unstable."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"03b844cc-920e-4fdc-8ddf-24e8ecc3c436","type":"message","text":"Yes.","user":"UEA5FBCRH","ts":"1616162937.196100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Q9v","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"e076dbab-0875-43ac-88d3-0ae2c21d2656","type":"message","text":"So here is my approach to fight the instability:","user":"UEA5FBCRH","ts":"1616162948.196300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4GBK","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So here is my approach to fight the instability:"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"86d250b9-86e3-4346-85ba-a243137052aa","type":"message","text":"```mutable struct FactorK{T, N}\n  vars::NTuple{N,Int64}\n  vals::Array{T}\nend\n\nfunction barrier(r_vals,ret_vars,Avals,dims)\n  ret_vals = sum!(r_vals, Avals) |&gt; x -&gt; dropdims(x, dims=Tuple(dims))\n  FactorK{eltype(Avals),length(ret_vars)}(ret_vars, ret_vals)\nend\n\nfunction my_indexin(x,y)\n  indxs = Vector{eltype(x)}(undef, length(x))\n  curr = 1\n  for xval in x \n    for (j, yval) in pairs(y)\n      if yval == xval\n        indxs[curr] = j\n        curr += 1\n        break\n      end\n    end\n  end\n  indxs\nend\n\nfunction factor_marginalization(A::FactorK{T}, vars::NTuple{N,Int64}) where {T,N}\n  dims = my_indexin(vars, A.vars) # map vars to dims\n  r_size = ntuple(d-&gt;d in dims ? 1 : size(A.vals,d), length(A.vars)) # assign 1 to summed out dims\n  ret_vars = filter(!in(vars), A.vars)\n  r_vals = similar(A.vals, r_size)\n  barrier(r_vals, ret_vars, A.vals,dims)\nend```","user":"UEA5FBCRH","ts":"1616162971.196500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"C5rgA","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"mutable struct FactorK{T, N}\n  vars::NTuple{N,Int64}\n  vals::Array{T}\nend\n\nfunction barrier(r_vals,ret_vars,Avals,dims)\n  ret_vals = sum!(r_vals, Avals) |> x -> dropdims(x, dims=Tuple(dims))\n  FactorK{eltype(Avals),length(ret_vars)}(ret_vars, ret_vals)\nend\n\nfunction my_indexin(x,y)\n  indxs = Vector{eltype(x)}(undef, length(x))\n  curr = 1\n  for xval in x \n    for (j, yval) in pairs(y)\n      if yval == xval\n        indxs[curr] = j\n        curr += 1\n        break\n      end\n    end\n  end\n  indxs\nend\n\nfunction factor_marginalization(A::FactorK{T}, vars::NTuple{N,Int64}) where {T,N}\n  dims = my_indexin(vars, A.vars) # map vars to dims\n  r_size = ntuple(d->d in dims ? 1 : size(A.vals,d), length(A.vars)) # assign 1 to summed out dims\n  ret_vars = filter(!in(vars), A.vars)\n  r_vals = similar(A.vals, r_size)\n  barrier(r_vals, ret_vars, A.vals,dims)\nend"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"2ad02d15-fee6-4e0f-b8cc-500bc929c08f","type":"message","text":"But still, it is type unstable because of the `filter` function. This is why I was asking for an alternative to see if I can make the whole thing type stable.","user":"UEA5FBCRH","ts":"1616163072.196700","team":"T68168MUP","edited":{"user":"UEA5FBCRH","ts":"1616164807.000000"},"blocks":[{"type":"rich_text","block_id":"dNxrH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But still, it is type unstable because of the "},{"type":"text","text":"filter","style":{"code":true}},{"type":"text","text":" function. This is why I was asking for an alternative to see if I can make the whole thing type stable."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"346e2f8a-7501-4236-9879-0b7cfba01540","type":"message","text":"The first version takes arounw 1.1us to run while the second one takes 700ns. So there is an improvemnt.","user":"UEA5FBCRH","ts":"1616163122.197000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"U02g","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The first version takes arounw 1.1us to run while the second one takes 700ns. So there is an improvemnt."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"3f0bb53d-c148-4d4a-890b-107b136b3f08","type":"message","text":"But I'm sure I'm far away from an optimal version since I'm just getting started with trying to write Julia performant code. I'm enjoying the process though :smiley:","user":"UEA5FBCRH","ts":"1616163242.197200","team":"T68168MUP","edited":{"user":"UEA5FBCRH","ts":"1616163259.000000"},"blocks":[{"type":"rich_text","block_id":"Em+6W","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But I'm sure I'm far away from an optimal version since I'm just getting started with trying to write Julia performant code. I'm enjoying the process though "},{"type":"emoji","name":"smiley"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"c275d95e-3c46-44b2-b9c2-b61737d21265","type":"message","text":"coming back to the sentinel value idea, on julia master, you can also call `replace` on tuples, e.g. the following uses `0` as the sentinel:\n```function my_filter2(a,b)\n    c = replace(a) do x\n        if x in b\n            0\n        else\n            x\n        end\n    end\nend```","user":"U6QPTG69E","ts":"1616164847.200300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"iloO1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"coming back to the sentinel value idea, on julia master, you can also call "},{"type":"text","text":"replace","style":{"code":true}},{"type":"text","text":" on tuples, e.g. the following uses "},{"type":"text","text":"0","style":{"code":true}},{"type":"text","text":" as the sentinel:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function my_filter2(a,b)\n    c = replace(a) do x\n        if x in b\n            0\n        else\n            x\n        end\n    end\nend"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"d136a57c-049a-4365-a407-96f971447350","type":"message","text":"or `map` also works on older Julia","user":"U6QPTG69E","ts":"1616164929.200500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"KVS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"or "},{"type":"text","text":"map","style":{"code":true}},{"type":"text","text":" also works on older Julia"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"148655c8-bb7f-4614-871c-6fddcccd0221","type":"message","text":"Just something I am not completely following here.\n\nThe type instability is just on the size of the tuple, which is totally expected since well... there's no way a-priori to determine the size of the output, that's why you are filtering in the first place.\n\nUnless you want these sentinel values to be present in the filtered-out tuple [turning it into a map instead of a filter], such that it has the same size as the input tuple, you will always incur in type instability (which is ultimately just not knowing how long your filtered tuple is going to be)","user":"U01PLQWQXPV","ts":"1616168665.205200","team":"T68168MUP","edited":{"user":"U01PLQWQXPV","ts":"1616170862.000000"},"blocks":[{"type":"rich_text","block_id":"fl3W","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Just something I am not completely following here.\n\nThe type instability is just on the size of the tuple, which is totally expected since well... there's no way a-priori to determine the size of the output, that's why you are filtering in the first place.\n\nUnless you want these sentinel values to be present in the filtered-out tuple [turning it into a map instead of a filter], such that it has the same size as the input tuple, you will always incur in type instability (which is ultimately just not knowing how long your filtered tuple is going to be)"}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"},{"client_msg_id":"8a7f25f3-bdb8-4052-96e6-d0955dbbea39","type":"message","text":"I have to say I can't really understand what your code but I can see that\n\n`length(A_card)` should be replaced by `ndims(input)`\n\nand that\n\nturning a filter into a map will give you tuple-size stability\n`map(x -&gt; x ∉ V ? x : 666, A.vars)` but at what cost? How are you getting rid of `666` values now?\n\nAt first glance your code seems to be more complicated than it has to be. I could be very wrong, but if I am not, you are trying to prematurely optimise something that still has to be worked on.\n\nExample: Why are you allocating `r_vals` inside the function for immediately after calling `sum!` on it? Might as well call `sum` and forget about unnecessary preallocations.","user":"U01PLQWQXPV","ts":"1616170267.213200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XttA/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I have to say I can't really understand what your code but I can see that\n\n"},{"type":"text","text":"length(A_card)","style":{"code":true}},{"type":"text","text":" should be replaced by "},{"type":"text","text":"ndims(input)","style":{"code":true}},{"type":"text","text":"\n\nand that\n\nturning a filter into a map will give you tuple-size stability\n"},{"type":"text","text":"map(x -> x ∉ V ? x : 666, A.vars)","style":{"code":true}},{"type":"text","text":" but at what cost? How are you getting rid of "},{"type":"text","text":"666","style":{"code":true}},{"type":"text","text":" values now?\n\nAt first glance your code seems to be more complicated than it has to be. I could be very wrong, but if I am not, you are trying to prematurely optimise something that still has to be worked on.\n\nExample: Why are you allocating "},{"type":"text","text":"r_vals","style":{"code":true}},{"type":"text","text":" inside the function for immediately after calling "},{"type":"text","text":"sum!","style":{"code":true}},{"type":"text","text":" on it? Might as well call "},{"type":"text","text":"sum","style":{"code":true}},{"type":"text","text":" and forget about unnecessary preallocations."}]}]}],"thread_ts":"1616159892.185700","parent_user_id":"UEA5FBCRH"}]