[{"client_msg_id":"ffd5a202-98d9-4dce-ac5a-03a8018dd304","type":"message","text":"hi all. I wanted to understand the scaling performance of multithreading. Say I have a function which calculate the root of a function repeatedly:\n```using Base.Threads, Roots, BenchmarkTools\n\nnthreads()\n# 16\n\nfunction singlethread()\n    for i in 1:100000\n        find_zero(x -&gt; x^3 - x^2, 5.0)\n    end\nend\n\n@btime singlethread()\n# 411.331 ms (2200000 allocations: 210.57 MiB)\n\nfunction multithreads()\n    @threads for i in 1:100000\n        find_zero(x -&gt; x^3 - x^2, 5.0)\n    end\nend\n@btime multithreads()\n# 68.632 ms (2200081 allocations: 210.58 MiB)```\nSo even though I’m using 16 threads, the scaling is only 5 times. Is this a normal behavior? If so, any chance I can improve the scaling like switching to `@spawn` or multiprocessing?","user":"USTUBS9ED","ts":"1609879006.326400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Astbo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"hi all. I wanted to understand the scaling performance of multithreading. Say I have a function which calculate the root of a function repeatedly:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using Base.Threads, Roots, BenchmarkTools\n\nnthreads()\n# 16\n\nfunction singlethread()\n    for i in 1:100000\n        find_zero(x -> x^3 - x^2, 5.0)\n    end\nend\n\n@btime singlethread()\n# 411.331 ms (2200000 allocations: 210.57 MiB)\n\nfunction multithreads()\n    @threads for i in 1:100000\n        find_zero(x -> x^3 - x^2, 5.0)\n    end\nend\n@btime multithreads()\n# 68.632 ms (2200081 allocations: 210.58 MiB)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"So even though I’m using 16 threads, the scaling is only 5 times. Is this a normal behavior? If so, any chance I can improve the scaling like switching to "},{"type":"text","text":"@spawn","style":{"code":true}},{"type":"text","text":" or multiprocessing?"}]}]}],"thread_ts":"1609879006.326400","reply_count":23,"reply_users_count":4,"latest_reply":"1609881544.332500","reply_users":["USTUBS9ED","UH8A351DJ","U0179G7FG4F","U7HAYKY9X"],"subscribed":false},{"client_msg_id":"c6346f38-dc44-46dc-92e9-aa27c72e13ec","type":"message","text":"actually as I checked in htop, the peak of CPU usage is also only 800%. Any chance I can utilize more?","user":"USTUBS9ED","ts":"1609879162.326600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"bKYa","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"actually as I checked in htop, the peak of CPU usage is also only 800%. Any chance I can utilize more?"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"faad7b65-0087-432f-aa47-ef18076811b5","type":"message","text":"what CPU do you have?","user":"UH8A351DJ","ts":"1609879298.326800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"bzo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"what CPU do you have?"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"b917d9d9-88e0-4414-aec8-bb9b460465e4","type":"message","text":"this sounds like you probably have an 8 core cpu, so hyperthreading probably just can't help much. This is pretty typical. Also 5x speedup for 8 cores is pretty good, you may be able to do better, but you are likely to get better performance increases by focusing on the scalar part of your algorithm","user":"U0179G7FG4F","ts":"1609879362.327000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"UJJ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"this sounds like you probably have an 8 core cpu, so hyperthreading probably just can't help much. This is pretty typical. Also 5x speedup for 8 cores is pretty good, you may be able to do better, but you are likely to get better performance increases by focusing on the scalar part of your algorithm"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"21738311-dbc8-47a1-8b50-e9867cd6c853","type":"message","text":"let’s see. I’m on a server with 80 processors. Each of them is a Intel(R) Xeon(R) CPU E7-8891 v2 @ 3.20GHz","user":"USTUBS9ED","ts":"1609879407.327200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"t732","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"let’s see. I’m on a server with 80 processors. Each of them is a Intel(R) Xeon(R) CPU E7-8891 v2 @ 3.20GHz"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"49c5508e-d2c5-4010-bf3b-4ef95576581d","type":"message","text":"it seems it has 10 cores","user":"USTUBS9ED","ts":"1609879414.327400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"z=qg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it seems it has 10 cores"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"d808a2d5-0525-410e-8917-1c95d862d3fb","type":"message","text":"can you run with 20 threads? That should max out 1 cpu","user":"U0179G7FG4F","ts":"1609879458.327600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"r3=Xu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"can you run with 20 threads? That should max out 1 cpu"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"71d89633-a931-488d-9f39-feb41af884a9","type":"message","text":"thanks for the suggestion. Let’s see","user":"USTUBS9ED","ts":"1609879506.327800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TiY","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"thanks for the suggestion. Let’s see"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"7125c119-604a-470f-aae2-6d5224218c85","type":"message","text":"wait a server with 80 CPUs? what motherboard support 80 CPUs?","user":"UH8A351DJ","ts":"1609879583.328000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Njn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"wait a server with 80 CPUs? what motherboard support 80 CPUs?"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"669b9629-b9bc-41bc-be72-22063221d72d","type":"message","text":"I’ve no idea but the last processor from /proc/cpuinfo labels it as the processor 79","user":"USTUBS9ED","ts":"1609879647.328200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"w5XB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I’ve no idea but the last processor from /proc/cpuinfo labels it as the processor 79"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"b362616f-522c-43d9-a81b-d0a2c1bb24e5","type":"message","text":"ok what does the first 10 lines of `lscpu` say?","user":"UH8A351DJ","ts":"1609879679.328400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"XJdm","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ok what does the first 10 lines of "},{"type":"text","text":"lscpu","style":{"code":true}},{"type":"text","text":" say?"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"9fab9fe5-56d2-4b5a-a21e-139fb205c4be","type":"message","text":"79 means you have 80 threads, so my guess is you have some 2-CPU motherboard each CPU has 40 threads","user":"UH8A351DJ","ts":"1609879749.329000","team":"T68168MUP","edited":{"user":"UH8A351DJ","ts":"1609879781.000000"},"blocks":[{"type":"rich_text","block_id":"KDXz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"79 means you have 80 threads, so my guess is you have some 2-CPU motherboard each CPU has 40 threads"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"4ac3cb9f-69e2-479f-9b74-5458f53baa76","type":"message","text":"but that won't agree with `CPU E7-8891 v2` since that only has 10 CPU (20 threads)","user":"UH8A351DJ","ts":"1609879769.329200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=j/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but that won't agree with "},{"type":"text","text":"CPU E7-8891 v2","style":{"code":true}},{"type":"text","text":" since that only has 10 CPU (20 threads)"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"5316a68a-fc22-43e4-b1fe-eb7a59f70820","type":"message","text":"Architecture:          x86_64\nCPU op-mode(s):        32-bit, 64-bit\nByte Order:            Little Endian\nCPU(s):                80\nOn-line CPU(s) list:   0-79\nThread(s) per core:    2\nCore(s) per socket:    10\nSocket(s):             4\nNUMA node(s):          4\nVendor ID:             GenuineIntel\nCPU family:            6\nModel:                 62\nModel name:            Intel(R) Xeon(R) CPU E7-8891 v2 @ 3.20GHz\nStepping:              7\nCPU MHz:               2810.546\nCPU max MHz:           3700.0000\nCPU min MHz:           1200.0000\nBogoMIPS:              6399.92\nVirtualization:        VT-x\nL1d cache:             32K\nL1i cache:             32K\nL2 cache:              256K\nL3 cache:              38400K\nNUMA node0 CPU(s):     0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76\nNUMA node1 CPU(s):     1,5,9,13,17,21,25,29,33,37,41,45,49,53,57,61,65,69,73,77\nNUMA node2 CPU(s):     2,6,10,14,18,22,26,30,34,38,42,46,50,54,58,62,66,70,74,78\nNUMA node3 CPU(s):     3,7,11,15,19,23,27,31,35,39,43,47,51,55,59,63,67,71,75,79","user":"USTUBS9ED","ts":"1609879780.329400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"tqD0","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Architecture:          x86_64\nCPU op-mode(s):        32-bit, 64-bit\nByte Order:            Little Endian\nCPU(s):                80\nOn-line CPU(s) list:   0-79\nThread(s) per core:    2\nCore(s) per socket:    10\nSocket(s):             4\nNUMA node(s):          4\nVendor ID:             GenuineIntel\nCPU family:            6\nModel:                 62\nModel name:            Intel(R) Xeon(R) CPU E7-8891 v2 @ 3.20GHz\nStepping:              7\nCPU MHz:               2810.546\nCPU max MHz:           3700.0000\nCPU min MHz:           1200.0000\nBogoMIPS:              6399.92\nVirtualization:        VT-x\nL1d cache:             32K\nL1i cache:             32K\nL2 cache:              256K\nL3 cache:              38400K\nNUMA node0 CPU(s):     0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76\nNUMA node1 CPU(s):     1,5,9,13,17,21,25,29,33,37,41,45,49,53,57,61,65,69,73,77\nNUMA node2 CPU(s):     2,6,10,14,18,22,26,30,34,38,42,46,50,54,58,62,66,70,74,78\nNUMA node3 CPU(s):     3,7,11,15,19,23,27,31,35,39,43,47,51,55,59,63,67,71,75,79"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"1479cbe6-5900-4c44-9b29-d7d8f8d07add","type":"message","text":"ah ok, so you have 4 `CPU E7-8891 v2`","user":"UH8A351DJ","ts":"1609879795.329700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hDKT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ah ok, so you have 4 "},{"type":"text","text":"CPU E7-8891 v2","style":{"code":true}}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"c08a47ca-3855-4f08-ad0d-815faed4cd3d","type":"message","text":"```Thread(s) per core:    2\nCore(s) per socket:    10```\n4 cpu * 2 * 10 = 80; to not spill into a second CPU, I recommend threads = 10","user":"UH8A351DJ","ts":"1609879811.329900","team":"T68168MUP","edited":{"user":"UH8A351DJ","ts":"1609879837.000000"},"blocks":[{"type":"rich_text","block_id":"ECp+p","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"Thread(s) per core:    2\nCore(s) per socket:    10"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"4 cpu * 2 * 10 = 80; to not spill into a second CPU, I recommend threads = 10"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"ad928927-b520-410a-a35b-0076253247f9","type":"message","text":"I see. I’ve no idea of architecture and different usage of cpu is really confusing to me 🥲","user":"USTUBS9ED","ts":"1609879858.330200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Jezk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I see. I’ve no idea of architecture and different usage of cpu is really confusing to me 🥲"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"98c35d1f-c9cf-4f80-9c19-7f053231e135","type":"message","text":"thanks!","user":"USTUBS9ED","ts":"1609879860.330400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3JCg","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"thanks!"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"95f674b8-566b-4659-be70-280aef8d8d91","type":"message","text":"I think what is happening is that there is some overhead when spawning a new Task object. Since each \"task\" is only 4 microseconds, this overhead becomes significant. That *could* be it, but I'd need to benchmark to be sure","user":"U7HAYKY9X","ts":"1609880900.331100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GsDi","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think what is happening is that there is some overhead when spawning a new Task object. Since each \"task\" is only 4 microseconds, this overhead becomes significant. That "},{"type":"text","text":"could","style":{"bold":true}},{"type":"text","text":" be it, but I'd need to benchmark to be sure"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"6e5f3a38-0fb2-45d0-a045-055ec15793c1","type":"message","text":"I thought  `@threads` is static so there is as many tasks as the number of threads?","user":"USTUBS9ED","ts":"1609881019.331300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9cR","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I thought  "},{"type":"text","text":"@threads","style":{"code":true}},{"type":"text","text":" is static so there is as many tasks as the number of threads?"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"2c48feb8-a612-48bc-a69a-0a50ca4acc2e","type":"message","text":"Right, you are right. But there is still some overhead regarding the management of which task takes what","user":"U7HAYKY9X","ts":"1609881147.331500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vrU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Right, you are right. But there is still some overhead regarding the management of which task takes what"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"e6a3a8e9-cef1-4523-92ea-36deb096bb04","type":"message","text":"yeah. Now I use 10 threads, and the scaling is 6-7x, which sounds fair to me","user":"USTUBS9ED","ts":"1609881213.331700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"LkHV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah. Now I use 10 threads, and the scaling is 6-7x, which sounds fair to me"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"1c8c0c01-c898-4153-9133-e25317e9a6ff","type":"message","text":"1 more thing to check is if all 10 threads are on the same NUMA node, this concerns cache sharing etc.\n\nEdit:\nI think by default 1 process only has affinity to 1 NUMA node anyway so you're probably good by not going beyond 10 threads","user":"UH8A351DJ","ts":"1609881250.331900","team":"T68168MUP","edited":{"user":"UH8A351DJ","ts":"1609881403.000000"},"blocks":[{"type":"rich_text","block_id":"8P+nc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"1 more thing to check is if all 10 threads are on the same NUMA node, this concerns cache sharing etc.\n\nEdit:\nI think by default 1 process only has affinity to 1 NUMA node anyway so you're probably good by not going beyond 10 threads"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"},{"client_msg_id":"396503be-a3a8-4b97-85b9-530f401e6fd0","type":"message","text":"I can access to the computing node equipped with 2x Intel® Xeon® Processor E5-2690 v4,  28 cores 56 threads in total. In this case what’s the best threading option? multithreading over 28 cores, or should I consider other parallel methods since two cores are used now?","user":"USTUBS9ED","ts":"1609881544.332500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"L2El","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I can access to the computing node equipped with 2x Intel® Xeon® Processor E5-2690 v4,  28 cores 56 threads in total. In this case what’s the best threading option? multithreading over 28 cores, or should I consider other parallel methods since two cores are used now?"}]}]}],"thread_ts":"1609879006.326400","parent_user_id":"USTUBS9ED"}]