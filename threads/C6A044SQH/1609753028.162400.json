[{"client_msg_id":"653b50b4-0719-4de6-8c2d-bf6010684c57","type":"message","text":"Are there cases in which broadcasting results in more allocations compared to explicitly writing the `for` loop?","user":"U01G1P8A46S","ts":"1609753028.162400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"n7R6k","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Are there cases in which broadcasting results in more allocations compared to explicitly writing the "},{"type":"text","text":"for","style":{"code":true}},{"type":"text","text":" loop?"}]}]}],"thread_ts":"1609753028.162400","reply_count":17,"reply_users_count":3,"latest_reply":"1609755960.166200","reply_users":["UD0NS8PDF","U01G1P8A46S","UH24GRBLL"],"subscribed":false},{"client_msg_id":"3f9f0c60-2cda-4156-a859-c62afc076f59","type":"message","text":"yes.","user":"UD0NS8PDF","ts":"1609753052.162500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yXA","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yes."}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"5df49199-9f4a-45c6-8b98-93d87d74a7cc","type":"message","text":"Any particular reason why? I thought broadcasting would write the same `for` loop under the hood","user":"U01G1P8A46S","ts":"1609753116.162700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Zx2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Any particular reason why? I thought broadcasting would write the same "},{"type":"text","text":"for","style":{"code":true}},{"type":"text","text":" loop under the hood"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"8034324b-8430-4aa1-beee-33c5ac60412d","type":"message","text":"the broadcast has to manifest the result at some point, if it doesn't end in a `.=`","user":"UH24GRBLL","ts":"1609753132.162900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"4hr","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the broadcast has to manifest the result at some point, if it doesn't end in a "},{"type":"text","text":".=","style":{"code":true}}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"2b91b9f0-1084-4e43-8737-983ef602c36a","type":"message","text":"and manifesting allocates","user":"UH24GRBLL","ts":"1609753161.163200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DmlKF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"and manifesting allocates"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"09441e65-e76f-4aae-a819-53208c7507a2","type":"message","text":"The obvious example is something like `sum(x .&gt; 0)`, where there is no need to allocate the result of broadcasting.","user":"UD0NS8PDF","ts":"1609753186.163400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"sSH2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The obvious example is something like "},{"type":"text","text":"sum(x .> 0)","style":{"code":true}},{"type":"text","text":", where there is no need to allocate the result of broadcasting."}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"50be8b91-df52-4cc8-898a-8d0ffb3d5c55","type":"message","text":"yep","user":"UH24GRBLL","ts":"1609753224.163600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"n4J45","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yep"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"f571cca9-23b0-4481-ac78-829bbbfd821e","type":"message","text":"the result of the broadcast has to be manifested before `sum` can work with it","user":"UH24GRBLL","ts":"1609753239.163800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"K7Pn9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the result of the broadcast has to be manifested before "},{"type":"text","text":"sum","style":{"code":true}},{"type":"text","text":" can work with it"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"e3094f12-1d81-4f16-87c7-8b6419a5360e","type":"message","text":"an equivalent and nonallocating alternative would be `sum(&gt;(0), x)` or `count(&gt;(0), x)`, which is conceptually closer to what's done anyway","user":"UH24GRBLL","ts":"1609753259.164000","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1609753290.000000"},"blocks":[{"type":"rich_text","block_id":"YmX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"an equivalent and nonallocating alternative would be "},{"type":"text","text":"sum(>(0), x)","style":{"code":true}},{"type":"text","text":" or "},{"type":"text","text":"count(>(0), x)","style":{"code":true}},{"type":"text","text":", which is conceptually closer to what's done anyway"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"ca350a06-b768-41d1-b990-9c3b3ae40d17","type":"message","text":"I see. Would you be able to help trace the bottleneck in allocations if I provide a `TimerOutputs.jl` table? I'm somewhat new to this","user":"U01G1P8A46S","ts":"1609753336.164300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+yH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I see. Would you be able to help trace the bottleneck in allocations if I provide a "},{"type":"text","text":"TimerOutputs.jl","style":{"code":true}},{"type":"text","text":" table? I'm somewhat new to this"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"252ec45f-40a5-4b71-b3d9-474c75d001b1","type":"message","text":"depends on how large that code of yours is","user":"UH24GRBLL","ts":"1609753546.164500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pKYHx","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"depends on how large that code of yours is"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"3b54e827-d0e1-4ded-8bbd-94da51a5154d","type":"message","text":"but a good starting point is from the performance tips in the manual (<https://docs.julialang.org/en/v1/manual/performance-tips/>)","user":"UH24GRBLL","ts":"1609753599.164700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"uVmH9","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but a good starting point is from the performance tips in the manual ("},{"type":"link","url":"https://docs.julialang.org/en/v1/manual/performance-tips/"},{"type":"text","text":")"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"858fbc87-88ea-4da2-802b-3fae7aa092ff","type":"message","text":"I believe it's pretty large, but I've traced most of the bottleneck using the table. I'm just unsure where the allocations are taking place within this trace; it seems to be in the matrix construction","user":"U01G1P8A46S","ts":"1609753786.164900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"GKbc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I believe it's pretty large, but I've traced most of the bottleneck using the table. I'm just unsure where the allocations are taking place within this trace; it seems to be in the matrix construction"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"95fe26a4-e976-4708-bd98-c9510b16f91a","type":"message","text":"I've pasted it here: <https://pastebin.com/fskxAfaY>","user":"U01G1P8A46S","ts":"1609753844.165100","team":"T68168MUP","attachments":[{"service_name":"Pastebin","title":"0.551514 seconds (5.66 M allocations: 149.453 MiB, 11.40% gc time) ───────── - Pastebin.com","title_link":"https://pastebin.com/fskxAfaY","text":"<http://Pastebin.com|Pastebin.com> is the number one paste tool since 2002. Pastebin is a website where you can store text online for a set period of time.","fallback":"Pastebin: 0.551514 seconds (5.66 M allocations: 149.453 MiB, 11.40% gc time) ───────── - Pastebin.com","from_url":"https://pastebin.com/fskxAfaY","service_icon":"https://pastebin.com/favicon.ico","id":1,"original_url":"https://pastebin.com/fskxAfaY"}],"blocks":[{"type":"rich_text","block_id":"hrO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I've pasted it here: "},{"type":"link","url":"https://pastebin.com/fskxAfaY"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"962555be-df18-45cb-9205-b201ee2684c5","type":"message","text":"I have no idea how to relate that table to the code base, as I don't know the code","user":"UH24GRBLL","ts":"1609753961.165400","team":"T68168MUP","edited":{"user":"UH24GRBLL","ts":"1609753967.000000"},"blocks":[{"type":"rich_text","block_id":"rl2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I have no idea how to relate that table to the code base, as I don't know the code"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"b1954be7-be9d-435a-9b0a-760a1b893dce","type":"message","text":"the vast majority of your allocations seem to be from `Matrix Construction`, so I'd suggest looking through that code and checking the performance tips for what might allocate","user":"UH24GRBLL","ts":"1609754136.165700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ij+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the vast majority of your allocations seem to be from "},{"type":"text","text":"Matrix Construction","style":{"code":true}},{"type":"text","text":", so I'd suggest looking through that code and checking the performance tips for what might allocate"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"},{"client_msg_id":"3975e0df-7c27-4fa7-b841-346244e6442f","type":"message","text":"Unfortunately I won't be able to share the code without taking up lots of your time in explaining the structure. I'll see what I can do about reducing allocations in the matrix construction as you suggested. Thanks for your time, explanations, and suggestions!","user":"U01G1P8A46S","ts":"1609754345.165900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PNe","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Unfortunately I won't be able to share the code without taking up lots of your time in explaining the structure. I'll see what I can do about reducing allocations in the matrix construction as you suggested. Thanks for your time, explanations, and suggestions!"}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S","reactions":[{"name":"+1","users":["UH24GRBLL"],"count":1}]},{"client_msg_id":"f6f8ba41-213f-4075-a533-57d56271c2ce","type":"message","text":"Interesting, I thought `.+` would be overloaded when using `StaticArrays.jl`, but it's not. Switching to `+` with them speeds it up.","user":"U01G1P8A46S","ts":"1609755960.166200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=tnq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Interesting, I thought "},{"type":"text","text":".+","style":{"code":true}},{"type":"text","text":" would be overloaded when using "},{"type":"text","text":"StaticArrays.jl","style":{"code":true}},{"type":"text","text":", but it's not. Switching to "},{"type":"text","text":"+","style":{"code":true}},{"type":"text","text":" with them speeds it up."}]}]}],"thread_ts":"1609753028.162400","parent_user_id":"U01G1P8A46S"}]