[{"client_msg_id":"af5fbca0-2f93-4515-9f0d-26d7c8fa7b8f","type":"message","text":"I've managed to get two threads play ping-pong with each other, but tasks don't want to play. Why?\n\n```function pingpong_threads(n = 10)\n    l = ReentrantLock()\n    msg = \"pong\"\n    Threads.@spawn begin\n        i = 0\n        while i &lt; n\n            Base.@lock l begin\n                if msg !== \"ping\"\n                    sleep(0.5)\n                    msg = \"ping\"\n                    println(\"$msg\")\n                    i += 1\n                end\n            end\n        end\n    end\n    Threads.@spawn begin\n        i = 0\n        while i &lt; n\n            Base.@lock l begin\n                if msg !== \"pong\"\n                    sleep(0.5)\n                    msg = \"pong\"\n                    println(\"$msg\")\n                    i += 1\n                end\n            end\n        end\n    end\nend\n\nfunction pingpong_tasks(n = 10)\n    l = ReentrantLock()\n    msg = \"pong\"\n    @async begin\n        i = 0 \n        while i &lt; n\n            Base.@lock l begin\n                if msg !== \"ping\"\n                    sleep(0.5)\n                    msg = \"ping\"\n                    println(\"$msg\")\n                    i += 1\n                end\n            end\n        end\n    end\n    @async begin\n        i = 0\n        while i &lt; n\n            Base.@lock l begin\n                if msg !== \"pong\"\n                    sleep(0.5)\n                    msg = \"pong\"\n                    println(\"$msg\")\n                    i += 1\n                end\n            end\n        end\n    end\nend```","user":"UB2QSHWPN","ts":"1612897712.396900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gmfs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I've managed to get two threads play ping-pong with each other, but tasks don't want to play. Why?\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function pingpong_threads(n = 10)\n    l = ReentrantLock()\n    msg = \"pong\"\n    Threads.@spawn begin\n        i = 0\n        while i < n\n            Base.@lock l begin\n                if msg !== \"ping\"\n                    sleep(0.5)\n                    msg = \"ping\"\n                    println(\"$msg\")\n                    i += 1\n                end\n            end\n        end\n    end\n    Threads.@spawn begin\n        i = 0\n        while i < n\n            Base.@lock l begin\n                if msg !== \"pong\"\n                    sleep(0.5)\n                    msg = \"pong\"\n                    println(\"$msg\")\n                    i += 1\n                end\n            end\n        end\n    end\nend\n\nfunction pingpong_tasks(n = 10)\n    l = ReentrantLock()\n    msg = \"pong\"\n    @async begin\n        i = 0 \n        while i < n\n            Base.@lock l begin\n                if msg !== \"ping\"\n                    sleep(0.5)\n                    msg = \"ping\"\n                    println(\"$msg\")\n                    i += 1\n                end\n            end\n        end\n    end\n    @async begin\n        i = 0\n        while i < n\n            Base.@lock l begin\n                if msg !== \"pong\"\n                    sleep(0.5)\n                    msg = \"pong\"\n                    println(\"$msg\")\n                    i += 1\n                end\n            end\n        end\n    end\nend"}]}]}],"thread_ts":"1612897712.396900","reply_count":17,"reply_users_count":3,"latest_reply":"1612899406.400400","reply_users":["B01J9QZ4SP8","UH24GRBLL","UB2QSHWPN"],"subscribed":false},{"type":"message","subtype":"bot_message","text":"Can we cross post this publicly to <https://discourse.julialang.org|Discourse> for further visibility? React with :bridge: on the message above to approve. <https://github.com/JuliaCommunity/SlackBridge/blob/main/README.md#faq|More info here>","ts":"1612897714.397000","username":"HelpDeskBot","bot_id":"B01J9QZ4SP8","thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"bb491014-fd31-45dd-ae04-8bcb0818fcbd","type":"message","text":"because tasks run concurrently, not necessarily in parallel","user":"UH24GRBLL","ts":"1612897841.397200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"lUc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"because tasks run concurrently, not necessarily in parallel"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"7a52ea26-6b68-452b-83cf-01f01618e2a1","type":"message","text":"So, how should I change that function for two tasks?","user":"UB2QSHWPN","ts":"1612897867.397400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"M5K","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"So, how should I change that function for two tasks?"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"86561959-c993-4666-a14f-ae714484101e","type":"message","text":"make sure both tasks run on independent threads and communicate via channels","user":"UH24GRBLL","ts":"1612897901.397600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"lop","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"make sure both tasks run on independent threads and communicate via channels"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"f627f1fd-9ac2-4f7f-b46e-5608cf49c6e1","type":"message","text":"you should do the same in the thread based version anyway - redefining variables is not a good idea","user":"UH24GRBLL","ts":"1612897941.397800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"THs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you should do the same in the thread based version anyway - redefining variables is not a good idea"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"e62b5f43-35fa-4ab5-86b8-b1ec12963546","type":"message","text":"I can use Ref then. And why independent threads is important here? What if I want to switch tasks in one thread?","user":"UB2QSHWPN","ts":"1612898070.398000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ReI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I can use Ref then. And why independent threads is important here? What if I want to switch tasks in one thread?"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"0ac7589e-103a-4ebe-9066-73ab1546dfbe","type":"message","text":"you could get unlucky with the scheduler and starve the other task, deadlocking yourself on accident","user":"UH24GRBLL","ts":"1612898142.398200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"g8QuB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you could get unlucky with the scheduler and starve the other task, deadlocking yourself on accident"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"66ddf309-4acd-4257-afee-3ec0ca77f8f1","type":"message","text":"the lock doesn't do anything on a single thread since only one part of the code can run","user":"UH24GRBLL","ts":"1612898177.398400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rbEz","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the lock doesn't do anything on a single thread since only one part of the code can run"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"7881ffd1-e4b9-4759-b34b-27213dc4afae","type":"message","text":"so on the task version, you acquire the lock, do your first iteration (during which you sleep and the second task tries to acquire the lock but fails), unlock, and immediately do your second iteration, acquiring the lock again","user":"UH24GRBLL","ts":"1612898244.398800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zCSyX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"so on the task version, you acquire the lock, do your first iteration (during which you sleep and the second task tries to acquire the lock but fails), unlock, and immediately do your second iteration, acquiring the lock again"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"2d35141b-f1bb-4cbe-b394-293fc7d0b86b","type":"message","text":"that's the difference between concurrency (tasks) and parallelism (threads) - in concurrency, tasks may appear to run at the same time, but are allowed to run one after another (or interleaved) without actually running at the same time. in parallelism, code literally does run at the same time.","user":"UH24GRBLL","ts":"1612898354.399000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3xWkE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"that's the difference between concurrency (tasks) and parallelism (threads) - in concurrency, tasks may appear to run at the same time, but are allowed to run one after another (or interleaved) without actually running at the same time. in parallelism, code literally does run at the same time."}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"35ce0dde-5ab1-4d4e-a6d8-cbd475f2b778","type":"message","text":"Ok, thanks for explanation, but without locks it doesn't work either:\n```function pingpong_tasks(n = 10)\n    msg = Ref(\"pong\")\n    @async begin\n        i = 0\n        while i &lt; n\n            if msg[] !== \"ping\"\n                sleep(0.5)\n                msg[] = \"ping\"\n                println(\"$(msg[])\")\n                i += 1\n            end\n        end\n    end\n    @async begin\n        i = 0\n        while i &lt; n\n            if msg[] !== \"pong\"\n                sleep(0.5)\n                msg[] = \"pong\"\n                println(\"$(msg[])\")\n                i += 1\n            end\n        end\n    end\nend```","user":"UB2QSHWPN","ts":"1612898412.399200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+Pur","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ok, thanks for explanation, but without locks it doesn't work either:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function pingpong_tasks(n = 10)\n    msg = Ref(\"pong\")\n    @async begin\n        i = 0\n        while i < n\n            if msg[] !== \"ping\"\n                sleep(0.5)\n                msg[] = \"ping\"\n                println(\"$(msg[])\")\n                i += 1\n            end\n        end\n    end\n    @async begin\n        i = 0\n        while i < n\n            if msg[] !== \"pong\"\n                sleep(0.5)\n                msg[] = \"pong\"\n                println(\"$(msg[])\")\n                i += 1\n            end\n        end\n    end\nend"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"b247bd98-f04f-4558-b8c2-bd647237965d","type":"message","text":"I expect that it would switch to another task if there is an empty cycle.","user":"UB2QSHWPN","ts":"1612898520.399400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"zoa","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I expect that it would switch to another task if there is an empty cycle."}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"bbc82a40-20bd-4767-a0a3-2629262d0556","type":"message","text":"why would it switch?","user":"UH24GRBLL","ts":"1612898824.399600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/AZF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"why would it switch?"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"b87fbe15-e2ac-4f83-841b-130271aabf1d","type":"message","text":"it's valid to continue running","user":"UH24GRBLL","ts":"1612898843.399800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"RsOL","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's valid to continue running"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"7d920ecd-33fa-4ffb-8e3c-eaf2bd67089e","type":"message","text":"you probably want to insert `yield()`","user":"UH24GRBLL","ts":"1612898850.400000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hrX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"you probably want to insert "},{"type":"text","text":"yield()","style":{"code":true}}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN","reactions":[{"name":"heavy_check_mark","users":["UB2QSHWPN"],"count":1}]},{"client_msg_id":"2ee5e044-8b2a-4c93-b0d1-170aaed508e9","type":"message","text":"if you `sleep` after the increment it should also work","user":"UH24GRBLL","ts":"1612898896.400200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"qyn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if you "},{"type":"text","text":"sleep","style":{"code":true}},{"type":"text","text":" after the increment it should also work"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"},{"client_msg_id":"f430248e-de68-49c0-95a7-174531f6625d","type":"message","text":"Thanks, now tasks play with each other. But why `sleep` also calls `yield()` ? Are there another functions that can call it either? Like reading from an empty IO?","user":"UB2QSHWPN","ts":"1612899406.400400","team":"T68168MUP","edited":{"user":"UB2QSHWPN","ts":"1612899613.000000"},"blocks":[{"type":"rich_text","block_id":"snrQW","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks, now tasks play with each other. But why "},{"type":"text","text":"sleep","style":{"code":true}},{"type":"text","text":" also calls "},{"type":"text","text":"yield()","style":{"code":true}},{"type":"text","text":" ? Are there another functions that can call it either? Like reading from an empty IO?"}]}]}],"thread_ts":"1612897712.396900","parent_user_id":"UB2QSHWPN"}]