[{"client_msg_id":"205bf469-265d-4207-8abf-1db4bd4c3ff9","type":"message","text":"Can someone tell me why `Float32` is (much) slower than `Float64` here?\n```julia&gt; function f(x::AbstractVector{T}) where T\n           m = length(x)\n           V = Matrix{T}(undef, m, m)\n           for j = 1:m\n               V[j,1] = one(T)\n           end\n           for i= 2:m\n               for j = 1:m\n                   V[j,i] = x[j] * V[j,i-1]\n               end\n           end\n           return V\n       end\nf (generic function with 1 method)\n\njulia&gt; using BenchmarkTools\n\njulia&gt; x = rand(Float64, 100);\n\njulia&gt; y = rand(Float32, 100);\n\njulia&gt; @btime f($x);\n  5.656 μs (2 allocations: 78.20 KiB)\n\njulia&gt; @btime f($y);\n  21.023 μs (2 allocations: 39.14 KiB)```","user":"U881D0W2C","ts":"1614721539.231700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hdwn3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Can someone tell me why "},{"type":"text","text":"Float32","style":{"code":true}},{"type":"text","text":" is (much) slower than "},{"type":"text","text":"Float64","style":{"code":true}},{"type":"text","text":" here?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> function f(x::AbstractVector{T}) where T\n           m = length(x)\n           V = Matrix{T}(undef, m, m)\n           for j = 1:m\n               V[j,1] = one(T)\n           end\n           for i= 2:m\n               for j = 1:m\n                   V[j,i] = x[j] * V[j,i-1]\n               end\n           end\n           return V\n       end\nf (generic function with 1 method)\n\njulia> using BenchmarkTools\n\njulia> x = rand(Float64, 100);\n\njulia> y = rand(Float32, 100);\n\njulia> @btime f($x);\n  5.656 μs (2 allocations: 78.20 KiB)\n\njulia> @btime f($y);\n  21.023 μs (2 allocations: 39.14 KiB)"}]}]}],"thread_ts":"1614721539.231700","reply_count":15,"reply_users_count":5,"latest_reply":"1614728885.242400","reply_users":["B01J9QZ4SP8","U7HAYKY9X","U881D0W2C","USU9FRPEU","UAUPJLBQX"],"subscribed":false},{"type":"message","subtype":"bot_message","text":"Can we cross post this publicly to <https://discourse.julialang.org|Discourse> for further visibility? React with :bridge: on the message above to approve. <https://github.com/JuliaCommunity/SlackBridge/blob/main/README.md#faq|More info here>","ts":"1614721541.231800","username":"HelpDeskBot","bot_id":"B01J9QZ4SP8","thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"24930d2b-8e67-429e-9b51-59c3b8381216","type":"message","text":"It's probably due to cache alignment effects - the CPU cache fetches memory most effectively from addresses that are aligned with the cache line boundraries.","user":"U7HAYKY9X","ts":"1614722022.232000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jFTfb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"It's probably due to cache alignment effects - the CPU cache fetches memory most effectively from addresses that are aligned with the cache line boundraries."}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"f2912632-e8fd-452b-a03d-e9de12bea476","type":"message","text":"What I also noted is that on a different machine, adding `@inbounds` annotations makes the `Float32` part faster than `Float64`. On my machine it doesn’t. (Without `@inbounds` the `Float32` case is slower on both machines).","user":"U881D0W2C","ts":"1614722874.235800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"QQs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"What I also noted is that on a different machine, adding "},{"type":"text","text":"@inbounds","style":{"code":true}},{"type":"text","text":" annotations makes the "},{"type":"text","text":"Float32","style":{"code":true}},{"type":"text","text":" part faster than "},{"type":"text","text":"Float64","style":{"code":true}},{"type":"text","text":". On my machine it doesn’t. (Without "},{"type":"text","text":"@inbounds","style":{"code":true}},{"type":"text","text":" the "},{"type":"text","text":"Float32","style":{"code":true}},{"type":"text","text":" case is slower on both machines)."}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"82a77110-dcfb-4caa-82c5-bb20608e2f87","type":"message","text":"Yeah, SIMD interacts interestingly with cache alignment, because of the larger loads (and the unrolling)","user":"U7HAYKY9X","ts":"1614722968.236000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pap","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yeah, SIMD interacts interestingly with cache alignment, because of the larger loads (and the unrolling)"}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"65f463dd-464e-4606-9c41-50c603c3af62","type":"message","text":"Check the benchmarks here - how large a difference the precise vector lengths make: <https://chriselrod.github.io/LoopVectorization.jl/latest/examples/matrix_vector_ops/#Matrix-Vector-Operations>","user":"U7HAYKY9X","ts":"1614723133.236200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TYh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Check the benchmarks here - how large a difference the precise vector lengths make: "},{"type":"link","url":"https://chriselrod.github.io/LoopVectorization.jl/latest/examples/matrix_vector_ops/#Matrix-Vector-Operations"}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C","reactions":[{"name":"+1","users":["U881D0W2C","UAUPJLBQX"],"count":2}]},{"client_msg_id":"bb69cb04-c7ee-464a-9565-568f0f429b58","type":"message","text":"I suspect part of the issue here is you are underflowing `Float32`:\n\n```julia&gt; x = rand(Float64, 100) .+ 1;\n\njulia&gt; y = rand(Float32, 100) .+ 1;\n\njulia&gt; @btime f($x);\n  7.325 μs (2 allocations: 78.20 KiB)\n\njulia&gt; @btime f($y);\n  9.400 μs (2 allocations: 39.14 KiB)```","user":"USU9FRPEU","ts":"1614727907.239000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"kuAO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I suspect part of the issue here is you are underflowing "},{"type":"text","text":"Float32","style":{"code":true}},{"type":"text","text":":\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> x = rand(Float64, 100) .+ 1;\n\njulia> y = rand(Float32, 100) .+ 1;\n\njulia> @btime f($x);\n  7.325 μs (2 allocations: 78.20 KiB)\n\njulia> @btime f($y);\n  9.400 μs (2 allocations: 39.14 KiB)"}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"e6b6d453-2196-4f42-be1b-c5fb3d255962","type":"message","text":"If you make all the numbers greater than one, the difference is much smaller.","user":"USU9FRPEU","ts":"1614727923.239400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"q/Sj","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If you make all the numbers greater than one, the difference is much smaller."}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"d2a99580-a951-48fd-8694-87d7b60130c0","type":"message","text":"Maybe this is even clearer:\n```julia&gt; y = rand(Float32, 100);\n\njulia&gt; x = rand(Float64, 100);\n\njulia&gt; y = Float32.(x);\n\njulia&gt; @btime f($x);\n  7.133 μs (2 allocations: 78.20 KiB)\n\njulia&gt; @btime f($x .+ 1);\n  7.300 μs (3 allocations: 79.08 KiB)\n\njulia&gt; @btime f($y);\n  27.599 μs (2 allocations: 39.14 KiB)\n\njulia&gt; @btime f($y .+ 1);\n  9.399 μs (3 allocations: 39.63 KiB)```","user":"USU9FRPEU","ts":"1614728090.240800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=6QN8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Maybe this is even clearer:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> y = rand(Float32, 100);\n\njulia> x = rand(Float64, 100);\n\njulia> y = Float32.(x);\n\njulia> @btime f($x);\n  7.133 μs (2 allocations: 78.20 KiB)\n\njulia> @btime f($x .+ 1);\n  7.300 μs (3 allocations: 79.08 KiB)\n\njulia> @btime f($y);\n  27.599 μs (2 allocations: 39.14 KiB)\n\njulia> @btime f($y .+ 1);\n  9.399 μs (3 allocations: 39.63 KiB)"}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C","reactions":[{"name":"+1","users":["UAUPJLBQX"],"count":1}]},{"client_msg_id":"c71a62ab-39dc-4147-aad7-24891bb5a8b2","type":"message","text":"```julia&gt; sum(f(x) .== 0)\n0\n\njulia&gt; sum(f(y) .== 0)\n1583```","user":"USU9FRPEU","ts":"1614728151.241000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9NnO","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> sum(f(x) .== 0)\n0\n\njulia> sum(f(y) .== 0)\n1583"}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"085726eb-e5e7-4dd9-81af-108b7892514a","type":"message","text":"```function f(x::AbstractVector{T}, n = length(x) ) where T\n                  m = length(x)\n                  V = Matrix{T}(undef, m, n)\n                  for j = 1:m\n                      V[j,1] = one(T)\n                  end\n                  for i= 2:n\n                      for j = 1:m\n                          V[j,i] = x[j] * V[j,i-1]\n                      end\n                  end\n                  return V\n              end   \n\njulia&gt; @btime f(x, 30);\n  4.600 μs (2 allocations: 23.52 KiB)\n\njulia&gt; @btime f(y, 30);\n  5.117 μs (1 allocation: 11.88 KiB)\n\njulia&gt; @btime f(x, 50);\n  7.767 μs (2 allocations: 39.14 KiB)\n\njulia&gt; @btime f(y, 50);\n  12.199 μs (2 allocations: 19.64 KiB)\n\njulia&gt; @btime f(x, 80);\n  12.300 μs (2 allocations: 62.58 KiB)\n\njulia&gt; @btime f(y, 80);\n  25.999 μs (2 allocations: 31.33 KiB)```\n","user":"USU9FRPEU","ts":"1614728394.241200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YymzR","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function f(x::AbstractVector{T}, n = length(x) ) where T\n                  m = length(x)\n                  V = Matrix{T}(undef, m, n)\n                  for j = 1:m\n                      V[j,1] = one(T)\n                  end\n                  for i= 2:n\n                      for j = 1:m\n                          V[j,i] = x[j] * V[j,i-1]\n                      end\n                  end\n                  return V\n              end   \n\njulia> @btime f(x, 30);\n  4.600 μs (2 allocations: 23.52 KiB)\n\njulia> @btime f(y, 30);\n  5.117 μs (1 allocation: 11.88 KiB)\n\njulia> @btime f(x, 50);\n  7.767 μs (2 allocations: 39.14 KiB)\n\njulia> @btime f(y, 50);\n  12.199 μs (2 allocations: 19.64 KiB)\n\njulia> @btime f(x, 80);\n  12.300 μs (2 allocations: 62.58 KiB)\n\njulia> @btime f(y, 80);\n  25.999 μs (2 allocations: 31.33 KiB)"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"d7a8508c-d973-4f5b-b353-d1b0a0d8caa7","type":"message","text":"Try `set_zero_subnormals(true)`","user":"UAUPJLBQX","ts":"1614728522.241500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"G=1mI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Try "},{"type":"text","text":"set_zero_subnormals(true)","style":{"code":true}}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"c2b37677-c4c0-47e4-b4ba-5733d66da750","type":"message","text":"Re: alignment, with 100x100 and 256-bit vectors, `Float64` would be perfectly aligned, while only every other column of `V` will be aligned with `Float32`, so if you did SIMD the cartesian loops, you'd be at one of the peaks for `Float64` but not for `Float32` in that matrix_vector_ops link.","user":"UAUPJLBQX","ts":"1614728635.241800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"k4h","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Re: alignment, with 100x100 and 256-bit vectors, "},{"type":"text","text":"Float64","style":{"code":true}},{"type":"text","text":" would be perfectly aligned, while only every other column of "},{"type":"text","text":"V","style":{"code":true}},{"type":"text","text":" will be aligned with "},{"type":"text","text":"Float32","style":{"code":true}},{"type":"text","text":", so if you did SIMD the cartesian loops, you'd be at one of the peaks for "},{"type":"text","text":"Float64","style":{"code":true}},{"type":"text","text":" but not for "},{"type":"text","text":"Float32","style":{"code":true}},{"type":"text","text":" in that matrix_vector_ops link."}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"aa3cc145-cfd0-4451-b881-139f990a152b","type":"message","text":"(But that would only be a problem with `@inbounds`)","user":"UAUPJLBQX","ts":"1614728702.242000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5XmT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"(But that would only be a problem with "},{"type":"text","text":"@inbounds","style":{"code":true}},{"type":"text","text":")"}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"460d7dc0-d58d-4985-a258-57efff777e00","type":"message","text":"```julia&gt; @btime f(x);\n  20.599 μs (2 allocations: 78.20 KiB)\n\njulia&gt; @btime f(y);\n  20.199 μs (2 allocations: 39.14 KiB)\n\njulia&gt; set_zero_subnormals(false)\ntrue\n\njulia&gt; @btime f(x);\n  20.500 μs (2 allocations: 78.20 KiB)\n\njulia&gt; @btime f(y);\n  38.700 μs (2 allocations: 39.14 KiB)```\n","user":"USU9FRPEU","ts":"1614728850.242200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7XEP","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @btime f(x);\n  20.599 μs (2 allocations: 78.20 KiB)\n\njulia> @btime f(y);\n  20.199 μs (2 allocations: 39.14 KiB)\n\njulia> set_zero_subnormals(false)\ntrue\n\njulia> @btime f(x);\n  20.500 μs (2 allocations: 78.20 KiB)\n\njulia> @btime f(y);\n  38.700 μs (2 allocations: 39.14 KiB)"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C"},{"client_msg_id":"cf95b7fe-0e76-4fd6-bb7d-c8f1a2ec95a8","type":"message","text":"I learn something new every time you chime in, Chris. Thanks!","user":"USU9FRPEU","ts":"1614728885.242400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"=BVrd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I learn something new every time you chime in, Chris. Thanks!"}]}]}],"thread_ts":"1614721539.231700","parent_user_id":"U881D0W2C","reactions":[{"name":"+1","users":["UAUPJLBQX","U881D0W2C"],"count":2}]}]