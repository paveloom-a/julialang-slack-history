[{"client_msg_id":"128d2141-37f0-492e-98a1-89a911a4afdb","type":"message","text":"Does anyone know why random number generator with fixed seeds are so slow?\n```julia&gt; e = zeros(Float32, 100000, 100);\n\njulia&gt; e2 = cu(e);\n\njulia&gt; seed = rand(UInt64);\n\njulia&gt; @btime Random.seed!(seed);\n  10.654 μs (2 allocations: 112 bytes)\n\njulia&gt; @btime CUDA.seed!(seed);\n  6.114 ms (18 allocations: 51.84 KiB)```\nLike that a 1000x factor slower","user":"U010WA4SZK5","ts":"1611843143.077500","team":"T68168MUP","edited":{"user":"U010WA4SZK5","ts":"1611843881.000000"},"blocks":[{"type":"rich_text","block_id":"VUw35","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Does anyone know why random number generator with fixed seeds are so slow?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> e = zeros(Float32, 100000, 100);\n\njulia> e2 = cu(e);\n\njulia> seed = rand(UInt64);\n\njulia> @btime Random.seed!(seed);\n  10.654 μs (2 allocations: 112 bytes)\n\njulia> @btime CUDA.seed!(seed);\n  6.114 ms (18 allocations: 51.84 KiB)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Like that a 1000x factor slower"}]}]}],"thread_ts":"1611843143.077500","reply_count":13,"reply_users_count":2,"latest_reply":"1611850836.084800","reply_users":["U68A3ASP9","U010WA4SZK5"],"subscribed":false},{"client_msg_id":"d536a2bf-c8dc-4de5-b542-3a71eb42b2d3","type":"message","text":"it's going to (re)set some state on the gpu, over PCI-E, so I expect it to be orders of magnitude slower","user":"U68A3ASP9","ts":"1611843633.078800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"W8C","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"it's going to (re)set some state on the gpu, over PCI-E, so I expect it to be orders of magnitude slower"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"d30ef86c-aa1d-4f1d-ac01-20d7fa8821fc","type":"message","text":"6ms is a lot though, but if it's due to the CURAND library itself there's probably not much we can do about it","user":"U68A3ASP9","ts":"1611843647.079100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"75n","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"6ms is a lot though, but if it's due to the CURAND library itself there's probably not much we can do about it"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"ca3543ea-13ff-47d8-af12-20261bdf68f7","type":"message","text":"Hum ok, not great, quite the blocker for my application I’ll have to think abut it. Thanks","user":"U010WA4SZK5","ts":"1611843973.080400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5A8f","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hum ok, not great, quite the blocker for my application I’ll have to think abut it. Thanks"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"a72f21d0-774b-4e26-a450-92318217cdb6","type":"message","text":"what are you trying to accomplish?","user":"U68A3ASP9","ts":"1611844453.080600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7TO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"what are you trying to accomplish?"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"019a27fd-d1c9-4719-aba8-5b1e90799a4a","type":"message","text":"maybe re-setting the offset would be sufficient for you?","user":"U68A3ASP9","ts":"1611844467.080800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"trMn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"maybe re-setting the offset would be sufficient for you?"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"bdaec07d-c42b-4e49-bcce-7a43e7a7d358","type":"message","text":"re-setting the offset leads to same kind of performance, I am basically trying to do\n• draw rand!(e)\n• Do other stuff\n• Need to redraw exact same e\nAnd it’s large random array and have a lot of it so I don’t want to keep them in memory","user":"U010WA4SZK5","ts":"1611844542.081000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"G53","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"re-setting the offset leads to same kind of performance, I am basically trying to do\n"}]},{"type":"rich_text_list","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"draw rand!(e)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Do other stuff"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Need to redraw exact same e"}]}],"style":"bullet","indent":0},{"type":"rich_text_section","elements":[{"type":"text","text":"And it’s large random array and have a lot of it so I don’t want to keep them in memory"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"5e50cca6-4f44-4f29-9d12-e1f043b990e4","type":"message","text":"I'm not seeing that here locally","user":"U68A3ASP9","ts":"1611844789.081300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"HxMZo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm not seeing that here locally"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"3d78aa0b-2ebb-4f87-8288-ff6a6e920522","type":"message","text":"FWIW, it's 1ms not 6 here:\n```julia&gt; @benchmark Random.seed!($(CURAND.default_rng()), 0)\nBenchmarkTools.Trial: \n  memory estimate:  0 bytes\n  allocs estimate:  0\n  --------------\n  minimum time:     1.337 ms (0.00% GC)\n  median time:      1.597 ms (0.00% GC)\n  mean time:        1.602 ms (0.00% GC)\n  maximum time:     9.786 ms (0.00% GC)\n  --------------\n  samples:          3120\n  evals/sample:     1```\njust setting the offset or seed only takes a couple of ns. the cost comes from the update seed method","user":"U68A3ASP9","ts":"1611844819.081900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VH4","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"FWIW, it's 1ms not 6 here:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @benchmark Random.seed!($(CURAND.default_rng()), 0)\nBenchmarkTools.Trial: \n  memory estimate:  0 bytes\n  allocs estimate:  0\n  --------------\n  minimum time:     1.337 ms (0.00% GC)\n  median time:      1.597 ms (0.00% GC)\n  mean time:        1.602 ms (0.00% GC)\n  maximum time:     9.786 ms (0.00% GC)\n  --------------\n  samples:          3120\n  evals/sample:     1"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"\njust setting the offset or seed only takes a couple of ns. the cost comes from the update seed method"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"9a62d5ae-e154-4ec4-b9e8-393e5a76806a","type":"message","text":"```julia&gt; @benchmark CURAND.curandGenerateSeeds($(CURAND.default_rng()))\nBenchmarkTools.Trial: \n  memory estimate:  0 bytes\n  allocs estimate:  0\n  --------------\n  minimum time:     1.339 ms (0.00% GC)\n  median time:      1.605 ms (0.00% GC)\n  mean time:        1.635 ms (0.00% GC)\n  maximum time:     8.096 ms (0.00% GC)\n  --------------\n  samples:          3056\n  evals/sample:     1```","user":"U68A3ASP9","ts":"1611844826.082300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"azrzN","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> @benchmark CURAND.curandGenerateSeeds($(CURAND.default_rng()))\nBenchmarkTools.Trial: \n  memory estimate:  0 bytes\n  allocs estimate:  0\n  --------------\n  minimum time:     1.339 ms (0.00% GC)\n  median time:      1.605 ms (0.00% GC)\n  mean time:        1.635 ms (0.00% GC)\n  maximum time:     8.096 ms (0.00% GC)\n  --------------\n  samples:          3056\n  evals/sample:     1"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"9af615d5-c83f-4d1a-a1c5-f0edaea3d835","type":"message","text":"as per the docs you can avoid that call, but then it'll just be included in the first call to the generator","user":"U68A3ASP9","ts":"1611844838.082600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"6REF","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"as per the docs you can avoid that call, but then it'll just be included in the first call to the generator"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"7bd1c8ef-fc08-471e-b5bb-efa57835ab4c","type":"message","text":"&gt; Generate the starting state of the generator. This function is automatically called by generation functions such as curandGenerate() and curandGenerateUniform(). It can be called manually for performance testing reasons to separate timings for starting state generation and random number generation. ","user":"U68A3ASP9","ts":"1611844851.083100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"W=mKT","elements":[{"type":"rich_text_quote","elements":[{"type":"text","text":"Generate the starting state of the generator. This function is automatically called by generation functions such as curandGenerate() and curandGenerateUniform(). It can be called manually for performance testing reasons to separate timings for starting state generation and random number generation. "}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"a6bfabe6-3a76-4013-85f0-307cf210da71","type":"message","text":"&gt; . the cost comes from the update seed method\nWell yeah `CURAND.curandSetGeneratorOffset(` and `CURAND.curandSetGeneratorOffset` are some ns so are fine it’s the call to `CURAND.curandGenerateNormal` that is super slow after resetting the seed.\n&gt; FWIW, it’s 1ms not 6 here:\nMy local GPU is pretty crappy so makes sense, still order of ms which isn’t great","user":"U010WA4SZK5","ts":"1611845121.083700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Q37","elements":[{"type":"rich_text_quote","elements":[{"type":"text","text":". the cost comes from the update seed method"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Well yeah "},{"type":"text","text":"CURAND.curandSetGeneratorOffset(","style":{"code":true}},{"type":"text","text":" and "},{"type":"text","text":"CURAND.curandSetGeneratorOffset","style":{"code":true}},{"type":"text","text":" are some ns so are fine it’s the call to "},{"type":"text","text":"CURAND.curandGenerateNormal","style":{"code":true}},{"type":"text","text":" that is super slow after resetting the seed.\n"}]},{"type":"rich_text_quote","elements":[{"type":"text","text":"FWIW, it’s 1ms not 6 here:"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"My local GPU is pretty crappy so makes sense, still order of ms which isn’t great"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"},{"client_msg_id":"e7016243-08ed-41e5-a777-8ae73ec2a801","type":"message","text":"Looks like `GPUArrays` has way better performance\n```julia&gt; grng = GPUArrays.default_rng(CuArray);\njulia&gt; seed = rand(UInt64);\njulia&gt; @btime begin Random.seed!($grng, $seed); Random.randn!($grng, $A); end\n  142.201 μs (31 allocations: 52.30 KiB)```","user":"U010WA4SZK5","ts":"1611850836.084800","team":"T68168MUP","edited":{"user":"U010WA4SZK5","ts":"1611850863.000000"},"blocks":[{"type":"rich_text","block_id":"33MH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Looks like "},{"type":"text","text":"GPUArrays","style":{"code":true}},{"type":"text","text":" has way better performance\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> grng = GPUArrays.default_rng(CuArray);\njulia> seed = rand(UInt64);\njulia> @btime begin Random.seed!($grng, $seed); Random.randn!($grng, $A); end\n  142.201 μs (31 allocations: 52.30 KiB)"}]}]}],"thread_ts":"1611843143.077500","parent_user_id":"U010WA4SZK5"}]