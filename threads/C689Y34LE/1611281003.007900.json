[{"client_msg_id":"4c23d68d-5e60-48a9-823e-01aa23e78c68","type":"message","text":"I ran into a weird error while using <#C7T968HRU|diffeq-bridged> and CUDA\nTL;DR: sometimes solvers using ForwardDiff Duals error out when combined with CUDA. This doesn't happen for `Dense` with tanh nor `GRUCell`, it does however happen for `LSTMCell` and a custom layer that mimics the LSTM.\nImportantly it doesn't happen when evaluated on CPU\nMWE\n```using CUDA, Flux, OrdinaryDiffEq, DiffEqSensitivity, Random\nCUDA.allowscalar(false)\n\nRandom.seed!(0)\ntspan = Float32.((0, 100))\nbasic_tgrad(u,p,t) = zero(u)\n\nnhidden = 4\nnin = 2\nnn = Flux.LSTMCell(nin,nhidden) |&gt; gpu\np, re = Flux.destructure(nn)\n\nU = randn(2*nhidden) |&gt; cu\nwrap(u) = (u[1:nhidden],u[nhidden+1:2nhidden])\nunwrap(u) = cat(u[1]...,dims=1)\ndudt_(u,p,t) = re(p)(wrap(u), CUDA.zeros(nin) ) |&gt; unwrap\nff = ODEFunction{false}(dudt_,tgrad=basic_tgrad)\nprob = ODEProblem{false}(ff,U,tspan,p)\nsolve(prob,Rosenbrock23();sense=InterpolatingAdjoint(autojacvec=ZygoteVJP()))```\nError message:\n```ERROR: MethodError: no method matching unsafe_convert(::Type{Float64}, ::ForwardDiff.Dual{Nothing,Float64,8})```\nEnvironment info:\nFlux 0.11.2\nCUDA 2.4.0\nNNlib 0.7.12","user":"UPM0H43C7","ts":"1611281003.007900","team":"T68168MUP","edited":{"user":"UPM0H43C7","ts":"1611281216.000000"},"blocks":[{"type":"rich_text","block_id":"F0m5i","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I ran into a weird error while using "},{"type":"channel","channel_id":"C7T968HRU"},{"type":"text","text":" and CUDA\nTL;DR: sometimes solvers using ForwardDiff Duals error out when combined with CUDA. This doesn't happen for "},{"type":"text","text":"Dense","style":{"code":true}},{"type":"text","text":" with tanh nor "},{"type":"text","text":"GRUCell","style":{"code":true}},{"type":"text","text":", it does however happen for "},{"type":"text","text":"LSTMCell","style":{"code":true}},{"type":"text","text":" and a custom layer that mimics the LSTM.\nImportantly it doesn't happen when evaluated on CPU\nMWE\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using CUDA, Flux, OrdinaryDiffEq, DiffEqSensitivity, Random\nCUDA.allowscalar(false)\n\nRandom.seed!(0)\ntspan = Float32.((0, 100))\nbasic_tgrad(u,p,t) = zero(u)\n\nnhidden = 4\nnin = 2\nnn = Flux.LSTMCell(nin,nhidden) |> gpu\np, re = Flux.destructure(nn)\n\nU = randn(2*nhidden) |> cu\nwrap(u) = (u[1:nhidden],u[nhidden+1:2nhidden])\nunwrap(u) = cat(u[1]...,dims=1)\ndudt_(u,p,t) = re(p)(wrap(u), CUDA.zeros(nin) ) |> unwrap\nff = ODEFunction{false}(dudt_,tgrad=basic_tgrad)\nprob = ODEProblem{false}(ff,U,tspan,p)\nsolve(prob,Rosenbrock23();sense=InterpolatingAdjoint(autojacvec=ZygoteVJP()))"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Error message:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"ERROR: MethodError: no method matching unsafe_convert(::Type{Float64}, ::ForwardDiff.Dual{Nothing,Float64,8})"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Environment info:\nFlux 0.11.2\nCUDA 2.4.0\nNNlib 0.7.12"}]}]}],"thread_ts":"1611281003.007900","reply_count":8,"reply_users_count":4,"latest_reply":"1611317979.010800","reply_users":["UPM0H43C7","U67BJLYCS","U69BL50BF","UC4QQPG4A"],"subscribed":false},{"client_msg_id":"f3abd8b2-4b69-4c18-95c8-cb14ac62377a","type":"message","text":"Stack trace <https://gist.github.com/PiotrSokol/0432aa4862590a5e9ae55e4e9f67e0f7>","user":"UPM0H43C7","ts":"1611281217.008100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ck=ne","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Stack trace "},{"type":"link","url":"https://gist.github.com/PiotrSokol/0432aa4862590a5e9ae55e4e9f67e0f7"}]}]}],"thread_ts":"1611281003.007900","parent_user_id":"UPM0H43C7"},{"client_msg_id":"d05603b3-4c4a-4a01-81d2-587e0793e62b","type":"message","text":"Someone is trying to ForwardDiff through CUDNN","user":"U67BJLYCS","ts":"1611285215.008300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"sSFsI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Someone is trying to ForwardDiff through CUDNN"}]}]}],"thread_ts":"1611281003.007900","parent_user_id":"UPM0H43C7"},{"client_msg_id":"c1d61d9b-72f7-46af-8727-2675230a73c2","type":"message","text":"<@U69BL50BF>","user":"U67BJLYCS","ts":"1611285239.008500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"EKmY2","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U69BL50BF"}]}]}],"thread_ts":"1611281003.007900","parent_user_id":"UPM0H43C7"},{"client_msg_id":"0e29d3f3-6fe4-4732-9ea3-027779af57d0","type":"message","text":"Yes I mentioned that.","user":"U69BL50BF","ts":"1611286421.008700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"5py","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes I mentioned that."}]}]}],"thread_ts":"1611281003.007900","parent_user_id":"UPM0H43C7"},{"client_msg_id":"e4edddc1-208c-4a09-8d2e-6ea356c5dbc6","type":"message","text":"Nothing we can do on the GPU side, I believe.","user":"U67BJLYCS","ts":"1611287744.008900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"ve47","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Nothing we can do on the GPU side, I believe."}]}]}],"thread_ts":"1611281003.007900","parent_user_id":"UPM0H43C7"},{"client_msg_id":"ccb08dfb-4aa6-46d8-8d29-efa78a0ebb5d","type":"message","text":"Yup","user":"U69BL50BF","ts":"1611289661.009100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YmQk","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yup"}]}]}],"thread_ts":"1611281003.007900","parent_user_id":"UPM0H43C7"},{"client_msg_id":"05b4fb4b-8bc7-40b2-ac6f-a3f256c8758a","type":"message","text":"We forward some GPU kernels to ForwardDiff, if we can get a more reduced mwe I could take a look","user":"UC4QQPG4A","ts":"1611299064.009300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gvN2","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"We forward some GPU kernels to ForwardDiff, if we can get a more reduced mwe I could take a look"}]}]}],"thread_ts":"1611281003.007900","parent_user_id":"UPM0H43C7"},{"client_msg_id":"91049072-c29e-4628-8687-2309e835ac0c","type":"message","text":"I'm in crunch mode rn, I'll try to remember to look at it in like 2 weeks","user":"UPM0H43C7","ts":"1611317979.010800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"9cH","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm in crunch mode rn, I'll try to remember to look at it in like 2 weeks"}]}]}],"thread_ts":"1611281003.007900","parent_user_id":"UPM0H43C7"}]