[{"client_msg_id":"4fc743e4-9ac1-4a17-86a2-586d0676a013","type":"message","text":"I just had an interesting bug. I wonder if it's a well-known pitfall. I had a CUDA kernel like this\n\n```function kernel(...)\n    acc = basecase(...)  # acc can be of different type for different thread\n    combine(acc, ...)    # uses sync_threads() in a loop\nend```\nand now I'm trying to make it work for the case where `acc` is a small `Union`.\n\nSince a method dispatch is a branch after everything is inlined, the above code tries to synchronize threads that are in different branches and hence deadlocks (or at least that's my theory for why it didn't work). It's obvious in hindsight but I had no idea when I was first writing the code. (<https://github.com/JuliaFolds/FoldsCUDA.jl/pull/49/commits/6fee3d172c68dc58b813f6b7e61a58470ace5b01#diff-d8ec7579b0bb38bbb8581baf2a6398e4b19d7859e670f009a6058a62a29b8ba4R198-R202>)\n\nAlso, this makes me wonder if union splitting can potentially introduce a deadlock, if the compiler is written for sequential programs in mind. (cc <@U67BJLYCS>)","user":"UC7AF7NSU","ts":"1615169106.116600","team":"T68168MUP","edited":{"user":"UC7AF7NSU","ts":"1615169488.000000"},"blocks":[{"type":"rich_text","block_id":"0eMeb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I just had an interesting bug. I wonder if it's a well-known pitfall. I had a CUDA kernel like this\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function kernel(...)\n    acc = basecase(...)  # acc can be of different type for different thread\n    combine(acc, ...)    # uses sync_threads() in a loop\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"\nand now I'm trying to make it work for the case where "},{"type":"text","text":"acc","style":{"code":true}},{"type":"text","text":" is a small "},{"type":"text","text":"Union","style":{"code":true}},{"type":"text","text":".\n\nSince a method dispatch is a branch after everything is inlined, the above code tries to synchronize threads that are in different branches and hence deadlocks (or at least that's my theory for why it didn't work). It's obvious in hindsight but I had no idea when I was first writing the code. ("},{"type":"link","url":"https://github.com/JuliaFolds/FoldsCUDA.jl/pull/49/commits/6fee3d172c68dc58b813f6b7e61a58470ace5b01#diff-d8ec7579b0bb38bbb8581baf2a6398e4b19d7859e670f009a6058a62a29b8ba4R198-R202"},{"type":"text","text":")\n\nAlso, this makes me wonder if union splitting can potentially introduce a deadlock, if the compiler is written for sequential programs in mind. (cc "},{"type":"user","user_id":"U67BJLYCS"},{"type":"text","text":")"}]}]}],"thread_ts":"1615169106.116600","reply_count":1,"reply_users_count":1,"latest_reply":"1615169623.116800","reply_users":["UC7AF7NSU"],"subscribed":false},{"client_msg_id":"b938578c-32e5-48c3-ada1-ac2c4957a44b","type":"message","text":"(x-post <https://julialang.zulipchat.com/#narrow/stream/225940-gpu/topic/CUDA.2Esync_threads.20and.20Union.20splitting/near/229237215>)","user":"UC7AF7NSU","ts":"1615169623.116800","team":"T68168MUP","attachments":[{"service_name":"Zulip","title":"JuliaLang","title_link":"https://julialang.zulipchat.com/#narrow/stream/225940-gpu/topic/CUDA.2Esync_threads.20and.20Union.20splitting/near/229237215","text":"This is the Zulip server for the Julia programming language community. We ask anyone joining to adhere to the Julia Code of Conduct. | To learn more about Julia, check out <https://julialang.org/>, or just come ask us here! | You can reach out to the admins of this Zulip by sending a direct message to @zulip-admins.","fallback":"Zulip: JuliaLang","thumb_url":"https://zulip-avatars.s3.amazonaws.com/7178/realm/icon.png?version=6","from_url":"https://julialang.zulipchat.com/#narrow/stream/225940-gpu/topic/CUDA.2Esync_threads.20and.20Union.20splitting/near/229237215","thumb_width":100,"thumb_height":100,"id":1,"original_url":"https://julialang.zulipchat.com/#narrow/stream/225940-gpu/topic/CUDA.2Esync_threads.20and.20Union.20splitting/near/229237215"}],"blocks":[{"type":"rich_text","block_id":"/=Xzq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"(x-post "},{"type":"link","url":"https://julialang.zulipchat.com/#narrow/stream/225940-gpu/topic/CUDA.2Esync_threads.20and.20Union.20splitting/near/229237215"},{"type":"text","text":")"}]}]}],"thread_ts":"1615169106.116600","parent_user_id":"UC7AF7NSU"}]