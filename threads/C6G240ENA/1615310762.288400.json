[{"client_msg_id":"05438f24-bfc7-454e-a51f-4b2324f70427","type":"message","text":"If I have something like\n\n```applychain(fs::Tuple, x, p) = applychain(Base.tail(fs), first(fs)(x,p[1:paramlength(first(fs))]), p[(paramlength(first(fs))+1):end])```\nIf I take its pullback (with Zygote) twice, I get:\n```ERROR: Mutating arrays is not supported\nStacktrace:\n [1] (::Zygote.var\"#376#377\")(::Nothing) at /home/guillaume/.julia/packages/Zygote/KpME9/src/lib/array.jl:61\n [2] (::Zygote.var\"#2271#back#378\"{Zygote.var\"#376#377\"})(::Nothing) at /home/guillaume/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59\n [3] materialize! at ./broadcast.jl:848 [inlined]\n [4] materialize! at ./broadcast.jl:845 [inlined]\n [5] materialize! at ./broadcast.jl:841 [inlined]\n [6] (::typeof(∂(materialize!)))(::Nothing) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [7] #364 at /home/guillaume/.julia/packages/Zygote/KpME9/src/lib/array.jl:42 [inlined]\n [8] (::typeof(∂(λ)))(::Nothing) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [9] #2225#back at /home/guillaume/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [10] (::typeof(∂(λ)))(::Nothing) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [11] applychain at /home/guillaume/.julia/packages/DiffEqFlux/lS4Sa/src/fast_layers.jl:20 [inlined]\n [12] (::typeof(∂(λ)))(::Tuple{Nothing,Nothing,CuArray{Float32,3},Nothing}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [13] FastChain at /home/guillaume/.julia/packages/DiffEqFlux/lS4Sa/src/fast_layers.jl:21 [inlined]\n [14] (::typeof(∂(λ)))(::Tuple{Nothing,CuArray{Float32,3},Nothing}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [15] #89 at ./REPL[52]:2 [inlined]\n [16] (::typeof(∂(λ)))(::Tuple{Nothing,CuArray{Float32,3}}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [17] #41 at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface.jl:40 [inlined]\n [18] (::typeof(∂(λ)))(::Tuple{CuArray{Float32,3}}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [19] ftest2 at ./REPL[52]:3 [inlined]\n [20] (::typeof(∂(ftest2)))(::CuArray{Float32,3}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [21] (::Zygote.var\"#41#42\"{typeof(∂(ftest2))})(::CuArray{Float32,3}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface.jl:40\n [22] top-level scope at REPL[54]:1```\nHow do you make things safe of  `ERROR: Mutating arrays is not supported` when differentiating twice ?","user":"UKJSNT1QR","ts":"1615310762.288400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Z3it","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If I have something like\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"applychain(fs::Tuple, x, p) = applychain(Base.tail(fs), first(fs)(x,p[1:paramlength(first(fs))]), p[(paramlength(first(fs))+1):end])"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"If I take its pullback (with Zygote) twice, I get:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"ERROR: Mutating arrays is not supported\nStacktrace:\n [1] (::Zygote.var\"#376#377\")(::Nothing) at /home/guillaume/.julia/packages/Zygote/KpME9/src/lib/array.jl:61\n [2] (::Zygote.var\"#2271#back#378\"{Zygote.var\"#376#377\"})(::Nothing) at /home/guillaume/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59\n [3] materialize! at ./broadcast.jl:848 [inlined]\n [4] materialize! at ./broadcast.jl:845 [inlined]\n [5] materialize! at ./broadcast.jl:841 [inlined]\n [6] (::typeof(∂(materialize!)))(::Nothing) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [7] #364 at /home/guillaume/.julia/packages/Zygote/KpME9/src/lib/array.jl:42 [inlined]\n [8] (::typeof(∂(λ)))(::Nothing) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [9] #2225#back at /home/guillaume/.julia/packages/ZygoteRules/OjfTt/src/adjoint.jl:59 [inlined]\n [10] (::typeof(∂(λ)))(::Nothing) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [11] applychain at /home/guillaume/.julia/packages/DiffEqFlux/lS4Sa/src/fast_layers.jl:20 [inlined]\n [12] (::typeof(∂(λ)))(::Tuple{Nothing,Nothing,CuArray{Float32,3},Nothing}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [13] FastChain at /home/guillaume/.julia/packages/DiffEqFlux/lS4Sa/src/fast_layers.jl:21 [inlined]\n [14] (::typeof(∂(λ)))(::Tuple{Nothing,CuArray{Float32,3},Nothing}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [15] #89 at ./REPL[52]:2 [inlined]\n [16] (::typeof(∂(λ)))(::Tuple{Nothing,CuArray{Float32,3}}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [17] #41 at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface.jl:40 [inlined]\n [18] (::typeof(∂(λ)))(::Tuple{CuArray{Float32,3}}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [19] ftest2 at ./REPL[52]:3 [inlined]\n [20] (::typeof(∂(ftest2)))(::CuArray{Float32,3}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface2.jl:0\n [21] (::Zygote.var\"#41#42\"{typeof(∂(ftest2))})(::CuArray{Float32,3}) at /home/guillaume/.julia/packages/Zygote/KpME9/src/compiler/interface.jl:40\n [22] top-level scope at REPL[54]:1"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"How do you make things safe of  "},{"type":"text","text":"ERROR: Mutating arrays is not supported","style":{"code":true}},{"type":"text","text":" when differentiating twice ?"}]}]}],"thread_ts":"1615310762.288400","reply_count":5,"reply_users_count":3,"latest_reply":"1615328567.289900","reply_users":["U6A936746","U6YRZ18GZ","UKJSNT1QR"],"subscribed":false},{"client_msg_id":"63ba02fe-fb87-4fb3-b22b-a7e489cf953b","type":"message","text":"<@U6YRZ18GZ> can probably speak on this.\nI think answer is : suffering:","user":"U6A936746","ts":"1615318845.288800","team":"T68168MUP","edited":{"user":"U6A936746","ts":"1615318870.000000"},"blocks":[{"type":"rich_text","block_id":"XY8GY","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U6YRZ18GZ"},{"type":"text","text":" can probably speak on this.\nI think answer is : suffering:"}]}]}],"thread_ts":"1615310762.288400","parent_user_id":"UKJSNT1QR"},{"client_msg_id":"0c80685b-7dd0-4cd5-8441-6762e965cd16","type":"message","text":"Are you differentiating through broadcasting?","user":"U6YRZ18GZ","ts":"1615318947.289100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TDX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Are you differentiating through broadcasting?"}]}]}],"thread_ts":"1615310762.288400","parent_user_id":"UKJSNT1QR"},{"client_msg_id":"c23fb6fc-417d-4b46-9f62-1f9edb62e839","type":"message","text":"I have not tried 2nd order on GPU (yet).","user":"U6YRZ18GZ","ts":"1615319000.289300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rtv2k","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I have not tried 2nd order on GPU (yet)."}]}]}],"thread_ts":"1615310762.288400","parent_user_id":"UKJSNT1QR"},{"client_msg_id":"47566c3f-7a93-4f89-802a-51a48b19fa36","type":"message","text":"OK, it is surely because of the broadcasting. Zygote will fail, because of `materialize!` uses mutation.","user":"U6YRZ18GZ","ts":"1615319100.289500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"IWI","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"OK, it is surely because of the broadcasting. Zygote will fail, because of "},{"type":"text","text":"materialize!","style":{"code":true}},{"type":"text","text":" uses mutation."}]}]}],"thread_ts":"1615310762.288400","parent_user_id":"UKJSNT1QR"},{"client_msg_id":"56c5bd17-bb83-4f7c-943c-485b55207feb","type":"message","text":"I'm not explicitly broadcasting anything I think, so the broadcast must be in the generated pullback.\n\nI just try to get the second derivative in p of FastChain((x,p) -&gt; p)","user":"UKJSNT1QR","ts":"1615328567.289900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"KP7RT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm not explicitly broadcasting anything I think, so the broadcast must be in the generated pullback.\n\nI just try to get the second derivative in p of FastChain((x,p) -> p)"}]}]}],"thread_ts":"1615310762.288400","parent_user_id":"UKJSNT1QR"}]