[{"client_msg_id":"a52fd37c-92c8-4590-976d-01aae850870d","type":"message","text":"Hi All,\n\nmay I ask someone to help me fixing the problem that matrix multiplication in gradient is not hitting BLAS?\n\nThis is my MWE\n```W = randn(Float32,64,64)\nX = randn(Float32,64,640000)\nProfile.clear()\n@profile gradient(W -&gt; sum(W * X), W)\nProfileSVG.save(\"/tmp/profile.svg\")```\nand I look at the output of the profiler to see, which functions are called. I think it is the same issue as this one\n<https://github.com/JuliaDiff/ChainRules.jl/issues/343>\nand it kills the performance of our Mill.jl, since it is all about GEMM.\nI use  ChainRules v0.7.54.\nThanks a lot for suggestions.\nTomas","user":"U6YRZ18GZ","ts":"1615640197.325800","team":"T68168MUP","edited":{"user":"U6YRZ18GZ","ts":"1615640447.000000"},"blocks":[{"type":"rich_text","block_id":"eJKEE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hi All,\n\nmay I ask someone to help me fixing the problem that matrix multiplication in gradient is not hitting BLAS?\n\nThis is my MWE\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"W = randn(Float32,64,64)\nX = randn(Float32,64,640000)\nProfile.clear()\n@profile gradient(W -> sum(W * X), W)\nProfileSVG.save(\"/tmp/profile.svg\")"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"and I look at the output of the profiler to see, which functions are called. I think it is the same issue as this one\n"},{"type":"link","url":"https://github.com/JuliaDiff/ChainRules.jl/issues/343"},{"type":"text","text":"\nand it kills the performance of our Mill.jl, since it is all about GEMM.\nI use  ChainRules v0.7.54.\nThanks a lot for suggestions.\nTomas"}]}]}],"thread_ts":"1615640197.325800","reply_count":3,"reply_users_count":2,"latest_reply":"1615641514.326500","reply_users":["U6A936746","U6YRZ18GZ"],"is_locked":false,"subscribed":false},{"client_msg_id":"1f8ec7a6-3970-4584-9bae-0491f5d2913d","type":"message","text":"Gross.\nThe fix is to make it type stable by pushing all the branches down to be inside the `InplaceableThunk` .","user":"U6A936746","ts":"1615641080.326100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"i1aS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Gross.\nThe fix is to make it type stable by pushing all the branches down to be inside the "},{"type":"text","text":"InplaceableThunk","style":{"code":true}},{"type":"text","text":" ."}]}]}],"thread_ts":"1615640197.325800","parent_user_id":"U6YRZ18GZ"},{"client_msg_id":"e4bb58f2-56f4-4761-a0b7-f98f1e954e8f","type":"message","text":"Though I am surprised you hit BLAS level ruled and not the rule for `*`","user":"U6A936746","ts":"1615641167.326300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pTXMW","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Though I am surprised you hit BLAS level ruled and not the rule for "},{"type":"text","text":"*","style":{"code":true}}]}]}],"thread_ts":"1615640197.325800","parent_user_id":"U6YRZ18GZ"},{"client_msg_id":"a3f83f13-b6d5-4490-bf39-a38f65ac1ffc","type":"message","text":"Hi Lyndon, thanks for quick answer. I have found the culprit. It is because gradient of `sum` is FillArray and not `Matrix` , therefore there is no need to hit GEMM","user":"U6YRZ18GZ","ts":"1615641514.326500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"gPdB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hi Lyndon, thanks for quick answer. I have found the culprit. It is because gradient of "},{"type":"text","text":"sum","style":{"code":true}},{"type":"text","text":" is FillArray and not "},{"type":"text","text":"Matrix","style":{"code":true}},{"type":"text","text":" , therefore there is no need to hit GEMM"}]}]}],"thread_ts":"1615640197.325800","parent_user_id":"U6YRZ18GZ"}]