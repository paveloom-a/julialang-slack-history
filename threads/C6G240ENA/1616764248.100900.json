[{"client_msg_id":"92dcbb76-7a28-43af-9099-125d6a84baca","type":"message","text":"I'm having trouble trying to preallocate a cache for the Jacobian using SparseDiffTools... MWE:\n```using SparseDiffTools, LinearAlgebra # SparseDiffTools v1.13.0\nnt, nb = 3, 4\njac = vcat((hcat((Diagonal(ones(nb)) for _ in 1:nt)...) for _ in 1:nt)...) # nt×nt blocks of diagonals\ncolors = matrix_colors(jac)\nx = ones(nt*nb)\njac2 = similar(jac)\n# works without ForwardColorJacCache:\nforwarddiff_color_jacobian!(jac2, (du,u)-&gt;mul!(du,jac,u), x, colorvec=colors, sparsity=jac)\n# does not work with ForwardColorJacCache:\njac_cache = ForwardColorJacCache((du,u)-&gt;mul!(du,jac,u), x, colorvec=colors, sparsity=jac)\nforwarddiff_color_jacobian!(jac2, (du,u)-&gt;mul!(du,jac,u), x, jac_cache)```","user":"UB197FRCL","ts":"1616764248.100900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yE6WO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm having trouble trying to preallocate a cache for the Jacobian using SparseDiffTools... MWE:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using SparseDiffTools, LinearAlgebra # SparseDiffTools v1.13.0\nnt, nb = 3, 4\njac = vcat((hcat((Diagonal(ones(nb)) for _ in 1:nt)...) for _ in 1:nt)...) # nt×nt blocks of diagonals\ncolors = matrix_colors(jac)\nx = ones(nt*nb)\njac2 = similar(jac)\n# works without ForwardColorJacCache:\nforwarddiff_color_jacobian!(jac2, (du,u)->mul!(du,jac,u), x, colorvec=colors, sparsity=jac)\n# does not work with ForwardColorJacCache:\njac_cache = ForwardColorJacCache((du,u)->mul!(du,jac,u), x, colorvec=colors, sparsity=jac)\nforwarddiff_color_jacobian!(jac2, (du,u)->mul!(du,jac,u), x, jac_cache)"}]}]}],"thread_ts":"1616764248.100900","reply_count":13,"reply_users_count":2,"latest_reply":"1616770445.105000","reply_users":["UB197FRCL","UGHS7LC64"],"is_locked":false,"subscribed":false},{"client_msg_id":"1e33e687-3ceb-44f8-91ef-f742c677ac52","type":"message","text":"This MWE just tries to use SparseDiffTools to get the Jacobian of a simple linear function  `f(x) = M * x` . It works without the preallocated cache, but I get a\n```ERROR: MethodError: no method matching Float64(::ForwardDiff.Dual{ForwardDiff.Tag{var\"#13#14\", Float64}, Float64, 3})```\n_with_ the cache","user":"UB197FRCL","ts":"1616764357.101000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yb5+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This MWE just tries to use SparseDiffTools to get the Jacobian of a simple linear function  "},{"type":"text","text":"f(x) = M * x","style":{"code":true}},{"type":"text","text":" . It works without the preallocated cache, but I get a\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"ERROR: MethodError: no method matching Float64(::ForwardDiff.Dual{ForwardDiff.Tag{var\"#13#14\", Float64}, Float64, 3})"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"with","style":{"italic":true}},{"type":"text","text":" the cache"}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"f9543373-d64e-4e83-93c6-6b8bbc6d09f4","type":"message","text":"I commented the code where it throws or where it works","user":"UB197FRCL","ts":"1616764381.101200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YNRX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I commented the code where it throws or where it works"}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"type":"message","text":"Full stack trace of the error","files":[{"id":"F01S3JJRE4F","created":1616764411,"timestamp":1616764411,"name":"Untitled.julia","title":"Untitled","mimetype":"text/plain","filetype":"julia","pretty_type":"Julia","user":"UB197FRCL","editable":true,"size":1922,"mode":"snippet","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01S3JJRE4F/Untitled.julia","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01S3JJRE4F/download/Untitled.julia","permalink":"https://julialang.slack.com/files/UB197FRCL/F01S3JJRE4F/Untitled.julia","permalink_public":"https://slack-files.com/T68168MUP-F01S3JJRE4F-daa0a9ba75","edit_link":"https://julialang.slack.com/files/UB197FRCL/F01S3JJRE4F/Untitled.julia/edit","preview":"julia> forwarddiff_color_jacobian!(jac2, (du,u)->mul!(du,jac,u), x, jac_cache)\nERROR: MethodError: no method matching Float64(::ForwardDiff.Dual{ForwardDiff.Tag{var\"#13#14\", Float64}, Float64, 3})\nClosest candidates are:\n  (::Type{T})(::Real, ::RoundingMode) where T<:AbstractFloat at rounding.jl:200\n  (::Type{T})(::T) where T<:Number at boot.jl:760","preview_highlight":"<div class=\"CodeMirror cm-s-default CodeMirrorServer\" oncopy=\"if(event.clipboardData){event.clipboardData.setData('text/plain',window.getSelection().toString().replace(/\\u200b/g,''));event.preventDefault();event.stopPropagation();}\">\n<div class=\"CodeMirror-code\">\n<div><pre><span class=\"cm-variable\">julia</span><span class=\"cm-operator\">&gt;</span> <span class=\"cm-builtin\">forwarddiff_color_jacobian!</span>(<span class=\"cm-variable\">jac2</span>, (<span class=\"cm-variable\">du</span>,<span class=\"cm-variable\">u</span>)<span class=\"cm-operator\">-&gt;</span><span class=\"cm-builtin\">mul!</span>(<span class=\"cm-variable\">du</span>,<span class=\"cm-variable\">jac</span>,<span class=\"cm-variable\">u</span>), <span class=\"cm-variable\">x</span>, <span class=\"cm-variable\">jac_cache</span>)</pre></div>\n<div><pre><span class=\"cm-variable\">ERROR</span><span class=\"cm-operator\">:</span> <span class=\"cm-variable\">MethodError</span><span class=\"cm-operator\">:</span> <span class=\"cm-variable\">no</span> <span class=\"cm-variable\">method</span> <span class=\"cm-variable\">matching</span> <span class=\"cm-builtin\">Float64</span>(<span class=\"cm-builtin\">::ForwardDiff.Dual{ForwardDiff.Tag</span><span class=\"cm-builtin\">{var&quot;#13#14&quot;, Float64</span><span class=\"cm-builtin\">}, Float64, 3</span><span class=\"cm-builtin\">}</span>)</pre></div>\n<div><pre><span class=\"cm-variable\">Closest</span> <span class=\"cm-variable\">candidates</span> <span class=\"cm-variable\">are</span><span class=\"cm-operator\">:</span></pre></div>\n<div><pre>  (<span class=\"cm-builtin\">::Type{T</span><span class=\"cm-builtin\">}</span>)(<span class=\"cm-builtin\">::Real</span>, <span class=\"cm-builtin\">::RoundingMode</span>) <span class=\"cm-keyword\">where</span> <span class=\"cm-variable\">T</span><span class=\"cm-operator\">&lt;:</span><span class=\"cm-variable\">AbstractFloat</span> <span class=\"cm-variable\">at</span> <span class=\"cm-variable\">rounding</span><span class=\"cm-operator\">.</span><span class=\"cm-variable\">jl</span><span class=\"cm-operator\">:</span><span class=\"cm-number\">200</span></pre></div>\n<div><pre>  (<span class=\"cm-builtin\">::Type{T</span><span class=\"cm-builtin\">}</span>)(<span class=\"cm-builtin\">::T</span>) <span class=\"cm-keyword\">where</span> <span class=\"cm-variable\">T</span><span class=\"cm-operator\">&lt;:</span><span class=\"cm-variable\">Number</span> <span class=\"cm-variable\">at</span> <span class=\"cm-variable\">boot</span><span class=\"cm-operator\">.</span><span class=\"cm-variable\">jl</span><span class=\"cm-operator\">:</span><span class=\"cm-number\">760</span></pre></div>\n</div>\n</div>\n","lines":30,"lines_more":25,"preview_is_truncated":true,"is_starred":false,"has_rich_preview":false}],"upload":true,"blocks":[{"type":"rich_text","block_id":"Jk9R3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Full stack trace of the error"}]}]}],"user":"UB197FRCL","display_as_bot":false,"ts":"1616764412.101400","client_msg_id":"bad67eea-e829-4a84-b37e-6ed795a547c4","thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"8dc67fd8-985c-4c6a-80c0-1020ae271d61","type":"message","text":"I'm guessing I'm doing it wrong with the cache, but after trying for too long without success, I'm turning to the pros (it's you, you beautiful peeps! :slightly_smiling_face:)","user":"UB197FRCL","ts":"1616764532.102000","team":"T68168MUP","edited":{"user":"UB197FRCL","ts":"1616764574.000000"},"blocks":[{"type":"rich_text","block_id":"pcjtO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm guessing I'm doing it wrong with the cache, but after trying for too long without success, I'm turning to the pros (it's you, you beautiful peeps! "},{"type":"emoji","name":"slightly_smiling_face"},{"type":"text","text":")"}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"ce57d27c-076a-410e-b96c-b3b59b6d4c92","type":"message","text":"I think if you pass `dx=ouput` (where `output` is a placeholder for the in-place function) to `ForwardColorJacCache` it will work.","user":"UGHS7LC64","ts":"1616765241.102400","team":"T68168MUP","edited":{"user":"UGHS7LC64","ts":"1616765250.000000"},"blocks":[{"type":"rich_text","block_id":"L+945","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think if you pass "},{"type":"text","text":"dx=ouput","style":{"code":true}},{"type":"text","text":" (where "},{"type":"text","text":"output","style":{"code":true}},{"type":"text","text":" is a placeholder for the in-place function) to "},{"type":"text","text":"ForwardColorJacCache","style":{"code":true}},{"type":"text","text":" it will work."}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"73a002e4-645e-45ca-b247-8700bdb3def8","type":"message","text":"Here's a working example based on your OP:\n```using SparseDiffTools, LinearAlgebra # SparseDiffTools v1.13.0\n\nnt, nb = 3, 4\njac = vcat((hcat((Diagonal(ones(nb)) for _ in 1:nt)...) for _ in 1:nt)...) # nt×nt blocks of diagonals\nf!(du,u) = mul!(du,jac,u)\n\nx = ones(nt*nb)\ndx = zeros(nt*nb)\nf!(dx,x)  # test\n\njac2 = similar(jac)\njac_cache = ForwardColorJacCache(f!, x, dx=dx, colorvec=matrix_colors(jac), sparsity=jac)\nforwarddiff_color_jacobian!(jac2, f!, x, jac_cache)```\n","user":"UGHS7LC64","ts":"1616765484.102900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FrK3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Here's a working example based on your OP:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using SparseDiffTools, LinearAlgebra # SparseDiffTools v1.13.0\n\nnt, nb = 3, 4\njac = vcat((hcat((Diagonal(ones(nb)) for _ in 1:nt)...) for _ in 1:nt)...) # nt×nt blocks of diagonals\nf!(du,u) = mul!(du,jac,u)\n\nx = ones(nt*nb)\ndx = zeros(nt*nb)\nf!(dx,x)  # test\n\njac2 = similar(jac)\njac_cache = ForwardColorJacCache(f!, x, dx=dx, colorvec=matrix_colors(jac), sparsity=jac)\nforwarddiff_color_jacobian!(jac2, f!, x, jac_cache)"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"937a7a80-0370-4c18-a175-f7b1ca0b0fe0","type":"message","text":"Oh no, I find that the error is thrown because of my use of an anonymous function, since this works without `dx` (from your MWE)\n```jac_cache = ForwardColorJacCache(f!, x, colorvec=matrix_colors(jac), sparsity=jac)\nforwarddiff_color_jacobian!(jac2, f!, x, jac_cache)```","user":"UB197FRCL","ts":"1616765698.103300","team":"T68168MUP","edited":{"user":"UB197FRCL","ts":"1616765707.000000"},"blocks":[{"type":"rich_text","block_id":"V7=HP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Oh no, I find that the error is thrown because of my use of an anonymous function, since this works without "},{"type":"text","text":"dx","style":{"code":true}},{"type":"text","text":" (from your MWE)\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"jac_cache = ForwardColorJacCache(f!, x, colorvec=matrix_colors(jac), sparsity=jac)\nforwarddiff_color_jacobian!(jac2, f!, x, jac_cache)"}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"6e83fc74-2476-4e84-8c16-2902850f650a","type":"message","text":"Or maybe I'm getting tired... I'm not sure anymore... :sweat_smile:","user":"UB197FRCL","ts":"1616765888.103600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"mCDMW","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Or maybe I'm getting tired... I'm not sure anymore... "},{"type":"emoji","name":"sweat_smile"}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"0293316e-3abe-40d0-8a26-997d341ba2b6","type":"message","text":"Oh, you are right. Sorry to have mislead you. The problem was the anonymous function somehow.","user":"UGHS7LC64","ts":"1616766628.103800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VQQV","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Oh, you are right. Sorry to have mislead you. The problem was the anonymous function somehow."}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL","reactions":[{"name":"+1","users":["UB197FRCL"],"count":1}]},{"client_msg_id":"159298f1-f58f-41c1-927f-64dc2c9ed62c","type":"message","text":"Mmm also, it seems I can't have a different `f!` in the `ForwardColorJacCache` and in the `forwarddiff_color_jacobian` call, which I know sounds odd, but I think I need it... Because I know early on the jacobian pattern and what memory I should need, I assume I should be able to use the cache. However, I don't know before hand the exact function `f!`...","user":"UB197FRCL","ts":"1616766820.104000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"s/yu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Mmm also, it seems I can't have a different "},{"type":"text","text":"f!","style":{"code":true}},{"type":"text","text":" in the "},{"type":"text","text":"ForwardColorJacCache","style":{"code":true}},{"type":"text","text":" and in the "},{"type":"text","text":"forwarddiff_color_jacobian","style":{"code":true}},{"type":"text","text":" call, which I know sounds odd, but I think I need it... Because I know early on the jacobian pattern and what memory I should need, I assume I should be able to use the cache. However, I don't know before hand the exact function "},{"type":"text","text":"f!","style":{"code":true}},{"type":"text","text":"..."}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"798a054d-12cc-4eab-a419-951df3fc73a5","type":"message","text":"<@U69BL50BF>, sorry to ping you, but I think you're in the best position to answer this or guide me towards someone else: TLDR: I want the Jacobian of a function `f!` and I want to build a `ForwardColorJacCache` for it with SparseDiffTools. However, I'd like to be able to use a different function, say `f2!` that is different (simpler) from the function `f!` but has the same Jacobian sparsity pattern. Is that possible? I feel like it should be but it currently throws :shrug:","user":"UB197FRCL","ts":"1616767141.104200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"s9R","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"U69BL50BF"},{"type":"text","text":", sorry to ping you, but I think you're in the best position to answer this or guide me towards someone else: TLDR: I want the Jacobian of a function "},{"type":"text","text":"f!","style":{"code":true}},{"type":"text","text":" and I want to build a "},{"type":"text","text":"ForwardColorJacCache","style":{"code":true}},{"type":"text","text":" for it with SparseDiffTools. However, I'd like to be able to use a different function, say "},{"type":"text","text":"f2!","style":{"code":true}},{"type":"text","text":" that is different (simpler) from the function "},{"type":"text","text":"f!","style":{"code":true}},{"type":"text","text":" but has the same Jacobian sparsity pattern. Is that possible? I feel like it should be but it currently throws "},{"type":"emoji","name":"shrug"}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"35c6cfe5-05b0-4e01-83e7-38b9ca391e59","type":"message","text":"(The reason I want to do that is that I don't know `f!` when I try to build the cache (but I know a simple function `f2!` that will have a jacobian of the same sparsity.)","user":"UB197FRCL","ts":"1616767220.104400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Q7YBu","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"(The reason I want to do that is that I don't know "},{"type":"text","text":"f!","style":{"code":true}},{"type":"text","text":" when I try to build the cache (but I know a simple function "},{"type":"text","text":"f2!","style":{"code":true}},{"type":"text","text":" that will have a jacobian of the same sparsity.)"}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"9d283c8d-ed36-4b23-b05f-1a24fabb61f4","type":"message","text":"Could you build a `ForwardColorJacCache` for each of the functions, and at the point in runtime where they are defined?","user":"UGHS7LC64","ts":"1616770445.105000","team":"T68168MUP","edited":{"user":"UGHS7LC64","ts":"1616770461.000000"},"blocks":[{"type":"rich_text","block_id":"uh8N","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Could you build a "},{"type":"text","text":"ForwardColorJacCache","style":{"code":true}},{"type":"text","text":" for each of the functions, and at the point in runtime where they are defined?"}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"}]