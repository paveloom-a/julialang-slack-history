[{"client_msg_id":"92dcbb76-7a28-43af-9099-125d6a84baca","type":"message","text":"I'm having trouble trying to preallocate a cache for the Jacobian using SparseDiffTools... MWE:\n```using SparseDiffTools, LinearAlgebra # SparseDiffTools v1.13.0\nnt, nb = 3, 4\njac = vcat((hcat((Diagonal(ones(nb)) for _ in 1:nt)...) for _ in 1:nt)...) # nt×nt blocks of diagonals\ncolors = matrix_colors(jac)\nx = ones(nt*nb)\njac2 = similar(jac)\n# works without ForwardColorJacCache:\nforwarddiff_color_jacobian!(jac2, (du,u)-&gt;mul!(du,jac,u), x, colorvec=colors, sparsity=jac)\n# does not work with ForwardColorJacCache:\njac_cache = ForwardColorJacCache((du,u)-&gt;mul!(du,jac,u), x, colorvec=colors, sparsity=jac)\nforwarddiff_color_jacobian!(jac2, (du,u)-&gt;mul!(du,jac,u), x, jac_cache)```","user":"UB197FRCL","ts":"1616764248.100900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yE6WO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm having trouble trying to preallocate a cache for the Jacobian using SparseDiffTools... MWE:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using SparseDiffTools, LinearAlgebra # SparseDiffTools v1.13.0\nnt, nb = 3, 4\njac = vcat((hcat((Diagonal(ones(nb)) for _ in 1:nt)...) for _ in 1:nt)...) # nt×nt blocks of diagonals\ncolors = matrix_colors(jac)\nx = ones(nt*nb)\njac2 = similar(jac)\n# works without ForwardColorJacCache:\nforwarddiff_color_jacobian!(jac2, (du,u)->mul!(du,jac,u), x, colorvec=colors, sparsity=jac)\n# does not work with ForwardColorJacCache:\njac_cache = ForwardColorJacCache((du,u)->mul!(du,jac,u), x, colorvec=colors, sparsity=jac)\nforwarddiff_color_jacobian!(jac2, (du,u)->mul!(du,jac,u), x, jac_cache)"}]}]}],"thread_ts":"1616764248.100900","reply_count":4,"reply_users_count":1,"latest_reply":"1616764532.102000","reply_users":["UB197FRCL"],"is_locked":false,"subscribed":false},{"client_msg_id":"1e33e687-3ceb-44f8-91ef-f742c677ac52","type":"message","text":"This MWE just tries to use SparseDiffTools to get the Jacobian of a simple linear function  `f(x) = M * x` . It works without the preallocated cache, but I get a\n```ERROR: MethodError: no method matching Float64(::ForwardDiff.Dual{ForwardDiff.Tag{var\"#13#14\", Float64}, Float64, 3})```\n_with_ the cache","user":"UB197FRCL","ts":"1616764357.101000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yb5+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"This MWE just tries to use SparseDiffTools to get the Jacobian of a simple linear function  "},{"type":"text","text":"f(x) = M * x","style":{"code":true}},{"type":"text","text":" . It works without the preallocated cache, but I get a\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"ERROR: MethodError: no method matching Float64(::ForwardDiff.Dual{ForwardDiff.Tag{var\"#13#14\", Float64}, Float64, 3})"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"with","style":{"italic":true}},{"type":"text","text":" the cache"}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"f9543373-d64e-4e83-93c6-6b8bbc6d09f4","type":"message","text":"I commented the code where it throws or where it works","user":"UB197FRCL","ts":"1616764381.101200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"YNRX","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I commented the code where it throws or where it works"}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"type":"message","text":"Full stack trace of the error","files":[{"id":"F01S3JJRE4F","created":1616764411,"timestamp":1616764411,"name":"Untitled.julia","title":"Untitled","mimetype":"text/plain","filetype":"julia","pretty_type":"Julia","user":"UB197FRCL","editable":true,"size":1922,"mode":"snippet","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01S3JJRE4F/Untitled.julia","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01S3JJRE4F/download/Untitled.julia","permalink":"https://julialang.slack.com/files/UB197FRCL/F01S3JJRE4F/Untitled.julia","permalink_public":"https://slack-files.com/T68168MUP-F01S3JJRE4F-daa0a9ba75","edit_link":"https://julialang.slack.com/files/UB197FRCL/F01S3JJRE4F/Untitled.julia/edit","preview":"julia> forwarddiff_color_jacobian!(jac2, (du,u)->mul!(du,jac,u), x, jac_cache)\nERROR: MethodError: no method matching Float64(::ForwardDiff.Dual{ForwardDiff.Tag{var\"#13#14\", Float64}, Float64, 3})\nClosest candidates are:\n  (::Type{T})(::Real, ::RoundingMode) where T<:AbstractFloat at rounding.jl:200\n  (::Type{T})(::T) where T<:Number at boot.jl:760","preview_highlight":"<div class=\"CodeMirror cm-s-default CodeMirrorServer\" oncopy=\"if(event.clipboardData){event.clipboardData.setData('text/plain',window.getSelection().toString().replace(/\\u200b/g,''));event.preventDefault();event.stopPropagation();}\">\n<div class=\"CodeMirror-code\">\n<div><pre><span class=\"cm-variable\">julia</span><span class=\"cm-operator\">&gt;</span> <span class=\"cm-builtin\">forwarddiff_color_jacobian!</span>(<span class=\"cm-variable\">jac2</span>, (<span class=\"cm-variable\">du</span>,<span class=\"cm-variable\">u</span>)<span class=\"cm-operator\">-&gt;</span><span class=\"cm-builtin\">mul!</span>(<span class=\"cm-variable\">du</span>,<span class=\"cm-variable\">jac</span>,<span class=\"cm-variable\">u</span>), <span class=\"cm-variable\">x</span>, <span class=\"cm-variable\">jac_cache</span>)</pre></div>\n<div><pre><span class=\"cm-variable\">ERROR</span><span class=\"cm-operator\">:</span> <span class=\"cm-variable\">MethodError</span><span class=\"cm-operator\">:</span> <span class=\"cm-variable\">no</span> <span class=\"cm-variable\">method</span> <span class=\"cm-variable\">matching</span> <span class=\"cm-builtin\">Float64</span>(<span class=\"cm-builtin\">::ForwardDiff.Dual{ForwardDiff.Tag</span><span class=\"cm-builtin\">{var&quot;#13#14&quot;, Float64</span><span class=\"cm-builtin\">}, Float64, 3</span><span class=\"cm-builtin\">}</span>)</pre></div>\n<div><pre><span class=\"cm-variable\">Closest</span> <span class=\"cm-variable\">candidates</span> <span class=\"cm-variable\">are</span><span class=\"cm-operator\">:</span></pre></div>\n<div><pre>  (<span class=\"cm-builtin\">::Type{T</span><span class=\"cm-builtin\">}</span>)(<span class=\"cm-builtin\">::Real</span>, <span class=\"cm-builtin\">::RoundingMode</span>) <span class=\"cm-keyword\">where</span> <span class=\"cm-variable\">T</span><span class=\"cm-operator\">&lt;:</span><span class=\"cm-variable\">AbstractFloat</span> <span class=\"cm-variable\">at</span> <span class=\"cm-variable\">rounding</span><span class=\"cm-operator\">.</span><span class=\"cm-variable\">jl</span><span class=\"cm-operator\">:</span><span class=\"cm-number\">200</span></pre></div>\n<div><pre>  (<span class=\"cm-builtin\">::Type{T</span><span class=\"cm-builtin\">}</span>)(<span class=\"cm-builtin\">::T</span>) <span class=\"cm-keyword\">where</span> <span class=\"cm-variable\">T</span><span class=\"cm-operator\">&lt;:</span><span class=\"cm-variable\">Number</span> <span class=\"cm-variable\">at</span> <span class=\"cm-variable\">boot</span><span class=\"cm-operator\">.</span><span class=\"cm-variable\">jl</span><span class=\"cm-operator\">:</span><span class=\"cm-number\">760</span></pre></div>\n</div>\n</div>\n","lines":30,"lines_more":25,"preview_is_truncated":true,"is_starred":false,"has_rich_preview":false}],"upload":true,"blocks":[{"type":"rich_text","block_id":"Jk9R3","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Full stack trace of the error"}]}]}],"user":"UB197FRCL","display_as_bot":false,"ts":"1616764412.101400","client_msg_id":"bad67eea-e829-4a84-b37e-6ed795a547c4","thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"},{"client_msg_id":"8dc67fd8-985c-4c6a-80c0-1020ae271d61","type":"message","text":"I'm guessing I'm doing it wrong with the cache, but after trying for too long without success, I'm turning to the pros (it's you, you beautiful peeps! :slightly_smiling_face:)","user":"UB197FRCL","ts":"1616764532.102000","team":"T68168MUP","edited":{"user":"UB197FRCL","ts":"1616764574.000000"},"blocks":[{"type":"rich_text","block_id":"pcjtO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm guessing I'm doing it wrong with the cache, but after trying for too long without success, I'm turning to the pros (it's you, you beautiful peeps! "},{"type":"emoji","name":"slightly_smiling_face"},{"type":"text","text":")"}]}]}],"thread_ts":"1616764248.100900","parent_user_id":"UB197FRCL"}]