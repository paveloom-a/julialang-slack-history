[{"client_msg_id":"c8349bcd-e99d-4437-899f-9b0dec407422","type":"message","text":"I've a problem with backpropagating with `Zygote` through a dynamic `OMEinsum` code:\n```function f(x::Array{&lt;:Real,N}) where N\n  code = EinCode((('i',), 'i'.+Tuple(0:N-1)), 'i'.+Tuple(1:N-1))\n  einsum(code, ([.1,.2,.3], x))\nend\ngradient(x -&gt; sum(f(x)), rand(3,3))```\nfails because mutating arrays is not supported. In contrast,\n```function g(x::Array{&lt;:Real,2})\n  einsum(EinCode((('i',), ('i','j')), ('j',)), ([.1,.2,.3], x))\nend\ngradient(x -&gt; sum(g(x)), rand(3,3))```\nworks. My question is: what custom `@adjoint` should I define in order to make the first version work? Or, perhaps, there is a better solution?","user":"ULDCM1P9P","ts":"1616775851.108500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"IPv","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I've a problem with backpropagating with "},{"type":"text","text":"Zygote","style":{"code":true}},{"type":"text","text":" through a dynamic "},{"type":"text","text":"OMEinsum","style":{"code":true}},{"type":"text","text":" code:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function f(x::Array{<:Real,N}) where N\n  code = EinCode((('i',), 'i'.+Tuple(0:N-1)), 'i'.+Tuple(1:N-1))\n  einsum(code, ([.1,.2,.3], x))\nend\ngradient(x -> sum(f(x)), rand(3,3))"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"fails because mutating arrays is not supported. In contrast,\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"function g(x::Array{<:Real,2})\n  einsum(EinCode((('i',), ('i','j')), ('j',)), ([.1,.2,.3], x))\nend\ngradient(x -> sum(g(x)), rand(3,3))"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"works. My question is: what custom "},{"type":"text","text":"@adjoint","style":{"code":true}},{"type":"text","text":" should I define in order to make the first version work? Or, perhaps, there is a better solution?"}]}]}],"thread_ts":"1616775851.108500","reply_count":5,"reply_users_count":3,"latest_reply":"1616795618.112700","reply_users":["UD0NS8PDF","ULDCM1P9P","UCD4Z3NJZ"],"is_locked":false,"subscribed":false},{"client_msg_id":"f6800ea2-67e3-4d0a-b8a1-2ab0d052ac51","type":"message","text":"Perhaps you just need `@nograd EinCode` or something? If the mutation is happening within the construction of `code` (but I haven’t tried)","user":"UD0NS8PDF","ts":"1616777549.109300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"STc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Perhaps you just need "},{"type":"text","text":"@nograd EinCode","style":{"code":true}},{"type":"text","text":" or something? If the mutation is happening within the construction of "},{"type":"text","text":"code","style":{"code":true}},{"type":"text","text":" (but I haven’t tried)"}]}]}],"thread_ts":"1616775851.108500","parent_user_id":"ULDCM1P9P"},{"client_msg_id":"5a94f468-0485-4740-84fc-dd4420d10f7c","type":"message","text":"I'm experimenting a bit with `Zygote.@nograd` but can't make it work, could you point me to some example code?","user":"ULDCM1P9P","ts":"1616778120.109600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8pjdd","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I'm experimenting a bit with "},{"type":"text","text":"Zygote.@nograd","style":{"code":true}},{"type":"text","text":" but can't make it work, could you point me to some example code?"}]}]}],"thread_ts":"1616775851.108500","parent_user_id":"ULDCM1P9P"},{"client_msg_id":"6722411b-fa03-4e22-bdfe-a689e1b9f8ef","type":"message","text":"OK, I think I figured it out. Alas, I'm still getting the same error :disappointed:.","user":"ULDCM1P9P","ts":"1616778373.109800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"/oZh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"OK, I think I figured it out. Alas, I'm still getting the same error "},{"type":"emoji","name":"disappointed"},{"type":"text","text":"."}]}]}],"thread_ts":"1616775851.108500","parent_user_id":"ULDCM1P9P"},{"client_msg_id":"5baf9ad1-6211-457e-bb80-065ddf742693","type":"message","text":"Now tried with a generated function:\n```@generated function gen(x::AbstractArray{R,N}) where {R,N}\n    code = EinCode((('i','j','k','l'), 'j' .+ Tuple(0:N-1)), ('i', ('i' .+ Tuple(4:N))...))\n    return :(einsum($code, ($(f.tensor), x)))\nend```\nIt works, but not if `f.tensor` is a CuArray :disappointed:.","user":"ULDCM1P9P","ts":"1616779255.110200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rz6Kq","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Now tried with a generated function:\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"@generated function gen(x::AbstractArray{R,N}) where {R,N}\n    code = EinCode((('i','j','k','l'), 'j' .+ Tuple(0:N-1)), ('i', ('i' .+ Tuple(4:N))...))\n    return :(einsum($code, ($(f.tensor), x)))\nend"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"It works, but not if "},{"type":"text","text":"f.tensor","style":{"code":true}},{"type":"text","text":" is a CuArray "},{"type":"emoji","name":"disappointed"},{"type":"text","text":"."}]}]}],"thread_ts":"1616775851.108500","parent_user_id":"ULDCM1P9P"},{"client_msg_id":"327cb5ab-a3a0-457d-bb75-ced4dbb1c98c","type":"message","text":"```julia&gt; function f(x::AbstractArray{&lt;:Real,N}) where N\n         code = Zygote.@ignore EinCode((('i',), 'i'.+Tuple(0:N-1)), 'i'.+Tuple(1:N-1))\n         einsum(code, (CUDA.CuArray([.1,.2,.3]), x))\n       end\nf (generic function with 2 methods)\n\njulia&gt; CUDA.allowscalar(false)\n\njulia&gt; gradient(x -&gt; sum(f(x)), CUDA.rand(3,3))\n(Float32[0.1 0.1 0.1; 0.2 0.2 0.2; 0.3 0.3 0.3],)```\nCan you try this code?","user":"UCD4Z3NJZ","ts":"1616795618.112700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"A0y","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"julia> function f(x::AbstractArray{<:Real,N}) where N\n         code = Zygote.@ignore EinCode((('i',), 'i'.+Tuple(0:N-1)), 'i'.+Tuple(1:N-1))\n         einsum(code, (CUDA.CuArray([.1,.2,.3]), x))\n       end\nf (generic function with 2 methods)\n\njulia> CUDA.allowscalar(false)\n\njulia> gradient(x -> sum(f(x)), CUDA.rand(3,3))\n(Float32[0.1 0.1 0.1; 0.2 0.2 0.2; 0.3 0.3 0.3],)"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Can you try this code?"}]}]}],"thread_ts":"1616775851.108500","parent_user_id":"ULDCM1P9P"}]