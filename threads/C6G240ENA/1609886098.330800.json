[{"type":"message","text":"Hi fellow ADlers. I'm trying to use Zygote and ran into the following issue with `@views`. On the CPU everything is fine, however, on the GPU I get wrong gradients with Zygote. BUT, only if the view has at least two identical indices. This is illustrated in this MWE where the second entry of the gradient will be right and the first entry wrong.\n\nBefore I put this on github, is this supposed to break?","files":[{"id":"F01HVGE2VL6","created":1609886097,"timestamp":1609886097,"name":"Untitled","title":"Untitled","mimetype":"text/plain","filetype":"julia","pretty_type":"Julia","user":"ULL3KSGBS","editable":true,"size":590,"mode":"snippet","is_external":false,"external_type":"","is_public":true,"public_url_shared":false,"display_as_bot":false,"username":"","url_private":"https://files.slack.com/files-pri/T68168MUP-F01HVGE2VL6/untitled","url_private_download":"https://files.slack.com/files-pri/T68168MUP-F01HVGE2VL6/download/untitled","permalink":"https://julialang.slack.com/files/ULL3KSGBS/F01HVGE2VL6/untitled","permalink_public":"https://slack-files.com/T68168MUP-F01HVGE2VL6-fbeac473f4","edit_link":"https://julialang.slack.com/files/ULL3KSGBS/F01HVGE2VL6/untitled/edit","preview":"using Zygote\nusing ForwardDiff\nusing Test\nusing LinearAlgebra\nusing CUDA","preview_highlight":"<div class=\"CodeMirror cm-s-default CodeMirrorServer\" oncopy=\"if(event.clipboardData){event.clipboardData.setData('text/plain',window.getSelection().toString().replace(/\\u200b/g,''));event.preventDefault();event.stopPropagation();}\">\n<div class=\"CodeMirror-code\">\n<div><pre><span class=\"cm-keyword\">using</span> <span class=\"cm-variable\">Zygote</span></pre></div>\n<div><pre><span class=\"cm-keyword\">using</span> <span class=\"cm-variable\">ForwardDiff</span></pre></div>\n<div><pre><span class=\"cm-keyword\">using</span> <span class=\"cm-variable\">Test</span></pre></div>\n<div><pre><span class=\"cm-keyword\">using</span> <span class=\"cm-variable\">LinearAlgebra</span></pre></div>\n<div><pre><span class=\"cm-keyword\">using</span> <span class=\"cm-variable\">CUDA</span></pre></div>\n</div>\n</div>\n","lines":28,"lines_more":23,"preview_is_truncated":false,"is_starred":false,"has_rich_preview":false}],"upload":true,"blocks":[{"type":"rich_text","block_id":"hpn","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hi fellow ADlers. I'm trying to use Zygote and ran into the following issue with "},{"type":"text","text":"@views","style":{"code":true}},{"type":"text","text":". On the CPU everything is fine, however, on the GPU I get wrong gradients with Zygote. BUT, only if the view has at least two identical indices. This is illustrated in this MWE where the second entry of the gradient will be right and the first entry wrong.\n\nBefore I put this on github, is this supposed to break?"}]}]}],"user":"ULL3KSGBS","display_as_bot":false,"ts":"1609886098.330800","edited":{"user":"ULL3KSGBS","ts":"1609886220.000000"},"client_msg_id":"dd47756e-eda8-48d8-80ab-0344ace43d6e","thread_ts":"1609886098.330800","reply_count":4,"reply_users_count":3,"latest_reply":"1609886945.332200","reply_users":["UM30MT6RF","UD0NS8PDF","ULL3KSGBS"],"subscribed":false},{"client_msg_id":"a98b0104-2fca-44c1-adfa-22af6f0c4c0a","type":"message","text":"Hmm, I think on the GPU broadcast might be parallelized, so Zygote's gradient definition could lead to race conditions: <https://github.com/FluxML/Zygote.jl/blob/2b17256e79b2eca9a6512207284219d279398fc9/src/lib/array.jl#L35|https://github.com/FluxML/Zygote.jl/blob/2b17256e79b2eca9a6512207284219d279398fc9/src/lib/array.jl#L35>","user":"UM30MT6RF","ts":"1609886596.331400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8C4SE","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Hmm, I think on the GPU broadcast might be parallelized, so Zygote's gradient definition could lead to race conditions: "},{"type":"link","url":"https://github.com/FluxML/Zygote.jl/blob/2b17256e79b2eca9a6512207284219d279398fc9/src/lib/array.jl#L35","text":"https://github.com/FluxML/Zygote.jl/blob/2b17256e79b2eca9a6512207284219d279398fc9/src/lib/array.jl#L35"}]}]}],"thread_ts":"1609886098.330800","parent_user_id":"ULL3KSGBS"},{"client_msg_id":"b7eabc17-2dde-4678-a90a-9b3b22514261","type":"message","text":"Might be a CUDA problem more so than a Zygote problem, since it probably shouldn't write to the same index from different threads","user":"UM30MT6RF","ts":"1609886695.331600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"8uj+7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Might be a CUDA problem more so than a Zygote problem, since it probably shouldn't write to the same index from different threads"}]}]}],"thread_ts":"1609886098.330800","parent_user_id":"ULL3KSGBS"},{"client_msg_id":"d81fc7fa-1a63-4726-a88f-d7847319e273","type":"message","text":"<https://github.com/FluxML/Zygote.jl/issues/821> might be the issue","user":"UD0NS8PDF","ts":"1609886818.332000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FZqS","elements":[{"type":"rich_text_section","elements":[{"type":"link","url":"https://github.com/FluxML/Zygote.jl/issues/821"},{"type":"text","text":" might be the issue"}]}]}],"thread_ts":"1609886098.330800","parent_user_id":"ULL3KSGBS","reactions":[{"name":"+1","users":["UM30MT6RF","ULL3KSGBS"],"count":2}]},{"client_msg_id":"a8b54b35-f9ba-482d-8386-d0883b2c3da9","type":"message","text":"Thanks for the link!","user":"ULL3KSGBS","ts":"1609886945.332200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"+TDh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks for the link!"}]}]}],"thread_ts":"1609886098.330800","parent_user_id":"ULL3KSGBS"}]