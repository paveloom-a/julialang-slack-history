[{"client_msg_id":"996cd9e0-bfc2-443a-83da-bf02b0d9c0c2","type":"message","text":"`getproperty` in `Zygote@0.6`: how much work has been put into optimising it? IIRC there was a bug fix between 0.5 and 0.6, which is great, but I’m now getting type-stability issues whenever I write `my_struct.a_field` . Are we confident that this is the price of correctness until we have some compiler upgrades, or is it worth me trying to figure out if there is the opportunity to improve our current implementation so that we can have type stability?","user":"U6PQP41C3","ts":"1614077815.058900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VdcBO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"getproperty","style":{"code":true}},{"type":"text","text":" in "},{"type":"text","text":"Zygote@0.6","style":{"code":true}},{"type":"text","text":": how much work has been put into optimising it? IIRC there was a bug fix between 0.5 and 0.6, which is great, but I’m now getting type-stability issues whenever I write "},{"type":"text","text":"my_struct.a_field","style":{"code":true}},{"type":"text","text":" . Are we confident that this is the price of correctness until we have some compiler upgrades, or is it worth me trying to figure out if there is the opportunity to improve our current implementation so that we can have type stability?"}]}]}],"thread_ts":"1614077815.058900","reply_count":10,"reply_users_count":3,"latest_reply":"1614108431.080800","reply_users":["U6A936746","UM30MT6RF","U6PQP41C3"],"subscribed":false},{"client_msg_id":"1a2653dd-c91b-4fb4-8304-43cab59cf29c","type":"message","text":"<@UM30MT6RF> ?","user":"U6A936746","ts":"1614077956.059000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"43D9","elements":[{"type":"rich_text_section","elements":[{"type":"user","user_id":"UM30MT6RF"},{"type":"text","text":" ?"}]}]}],"thread_ts":"1614077815.058900","parent_user_id":"U6PQP41C3"},{"client_msg_id":"c2803819-57a5-4c89-8ab1-1133f20838eb","type":"message","text":"If you have a concrete example, I can take a look whether we can perhaps inline more aggressively, but yes, it is expected that this might have gotten worse unfortunately.","user":"UM30MT6RF","ts":"1614078162.059200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rVl8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If you have a concrete example, I can take a look whether we can perhaps inline more aggressively, but yes, it is expected that this might have gotten worse unfortunately."}]}]}],"thread_ts":"1614077815.058900","parent_user_id":"U6PQP41C3"},{"client_msg_id":"12b247d8-6b96-478b-8f40-52ef6598b220","type":"message","text":"Alternatively, we could perhaps use a similar approach to Tricks.jl to figure out when instrumenting `literal_getproperty`, whether we need to recurse into the actual implementation of `getproperty` or not, but that seems potentially iffy","user":"UM30MT6RF","ts":"1614078315.059400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"l0pb","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Alternatively, we could perhaps use a similar approach to Tricks.jl to figure out when instrumenting "},{"type":"text","text":"literal_getproperty","style":{"code":true}},{"type":"text","text":", whether we need to recurse into the actual implementation of "},{"type":"text","text":"getproperty","style":{"code":true}},{"type":"text","text":" or not, but that seems potentially iffy"}]}]}],"thread_ts":"1614077815.058900","parent_user_id":"U6PQP41C3"},{"client_msg_id":"60963269-df33-487e-b59f-6e8ae33fae91","type":"message","text":"```struct Gaussian{Tm, TP}\n    m::Tm\n    P::TP\nend\n\njulia&gt; @code_warntype Zygote._pullback(Zygote.Context(), x -&gt; x.m, Gaussian(randn(3), randn(3, 3)))```","user":"U6PQP41C3","ts":"1614083025.061000","team":"T68168MUP","edited":{"user":"U6PQP41C3","ts":"1614083047.000000"},"blocks":[{"type":"rich_text","block_id":"i0d","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"struct Gaussian{Tm, TP}\n    m::Tm\n    P::TP\nend\n\njulia> @code_warntype Zygote._pullback(Zygote.Context(), x -> x.m, Gaussian(randn(3), randn(3, 3)))"}]}]}],"thread_ts":"1614077815.058900","parent_user_id":"U6PQP41C3"},{"client_msg_id":"c4904122-e5ba-403b-b724-b7ac190d006e","type":"message","text":"Here’s an example that breaks for me :slightly_smiling_face:","user":"U6PQP41C3","ts":"1614083069.061300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hmdk+","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Here’s an example that breaks for me "},{"type":"emoji","name":"slightly_smiling_face"}]}]}],"thread_ts":"1614077815.058900","parent_user_id":"U6PQP41C3"},{"client_msg_id":"b13798af-ab2e-4484-87c4-a9aec4f5a1bf","type":"message","text":"My initial experiments indicate that we will probably need some evil tricks to make this work reliably, but it should be possible","user":"UM30MT6RF","ts":"1614101118.062800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"h9WdP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"My initial experiments indicate that we will probably need some evil tricks to make this work reliably, but it should be possible"}]}]}],"thread_ts":"1614077815.058900","parent_user_id":"U6PQP41C3"},{"client_msg_id":"5cfc49e7-1fb9-4932-add2-4514b2a55f3f","type":"message","text":"That would be fantastic — I’ve had to go through my codebase replacing `A.b` with `Zygote.literal_getfield(A, Val(:b))` for the time being to upgrade to 0.6, and I would like to get rid of that :joy:","user":"U6PQP41C3","ts":"1614101316.063000","team":"T68168MUP","edited":{"user":"U6PQP41C3","ts":"1614101336.000000"},"blocks":[{"type":"rich_text","block_id":"ATn24","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"That would be fantastic — I’ve had to go through my codebase replacing "},{"type":"text","text":"A.b","style":{"code":true}},{"type":"text","text":" with "},{"type":"text","text":"Zygote.literal_getfield(A, Val(:b))","style":{"code":true}},{"type":"text","text":" for the time being to upgrade to 0.6, and I would like to get rid of that "},{"type":"emoji","name":"joy"}]}]}],"thread_ts":"1614077815.058900","parent_user_id":"U6PQP41C3"},{"client_msg_id":"21988e66-16d4-40e3-9fa9-bb8a317930f1","type":"message","text":"`getfield(a, :b)` should be equivalent to that, but it would of course still be good to get this fixed","user":"UM30MT6RF","ts":"1614101400.063300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"jlBpG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"getfield(a, :b)","style":{"code":true}},{"type":"text","text":" should be equivalent to that, but it would of course still be good to get this fixed"}]}]}],"thread_ts":"1614077815.058900","parent_user_id":"U6PQP41C3","reactions":[{"name":"+1","users":["U6PQP41C3"],"count":1}]},{"client_msg_id":"00b9b0a2-5ff0-41e2-8d88-c438b1f11a36","type":"message","text":"I still need to fix this up a bit, but does <https://github.com/simeonschaub/Zygote.jl/tree/sds/getprop> fix your problems? It's quite ugly though","user":"UM30MT6RF","ts":"1614104811.078200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Ixtqo","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I still need to fix this up a bit, but does "},{"type":"link","url":"https://github.com/simeonschaub/Zygote.jl/tree/sds/getprop"},{"type":"text","text":" fix your problems? It's quite ugly though"}]}]}],"thread_ts":"1614077815.058900","parent_user_id":"U6PQP41C3"},{"client_msg_id":"1e0d91b0-0d1b-4721-bcbd-2ac2527c9b5c","type":"message","text":"Seems to fix type inference :tada:","user":"U6PQP41C3","ts":"1614108431.080800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"yZLZ","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Seems to fix type inference "},{"type":"emoji","name":"tada"}]}]}],"thread_ts":"1614077815.058900","parent_user_id":"U6PQP41C3"}]