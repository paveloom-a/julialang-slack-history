[{"client_msg_id":"b1ded38a-5992-4d2f-a8d7-aa7e34f32308","type":"message","text":"I’ve managed to write code using `@scalar_rule` which (1) errors when calling `test_scalar`, (2) returns failed tests for `test_rrule`, but somehow (3) passes tests for `test_frule`. I have very high confidence the derivative is accurate, I just can’t seem to test it right. Can anyone see any glaring flaws in this-\n\n```# type annotated for clarity\n@scalar_rule(\n    compute_gn(u_n::Vector)::Vector,\n    compute_gn_jac(u_n::Vector)::Matrix\n)\ntest_scalar(compute_gn, [1, 0.4, 0.26]) # \"no method matching one(::Vector{Float64})\"\ntest_rrule(compute_gn, [1, 0.4, 0.26]) # test fails, derivatives don't match\ntest_frule(compute_gn, [1, 0.4, 0.26]) # test passes```","user":"UN97XTLCV","ts":"1615663587.330500","team":"T68168MUP","edited":{"user":"UN97XTLCV","ts":"1615663648.000000"},"blocks":[{"type":"rich_text","block_id":"+Tdp6","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I’ve managed to write code using "},{"type":"text","text":"@scalar_rule","style":{"code":true}},{"type":"text","text":" which (1) errors when calling "},{"type":"text","text":"test_scalar","style":{"code":true}},{"type":"text","text":", (2) returns failed tests for "},{"type":"text","text":"test_rrule","style":{"code":true}},{"type":"text","text":", but somehow (3) passes tests for "},{"type":"text","text":"test_frule","style":{"code":true}},{"type":"text","text":". I have very high confidence the derivative is accurate, I just can’t seem to test it right. Can anyone see any glaring flaws in this-\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"# type annotated for clarity\n@scalar_rule(\n    compute_gn(u_n::Vector)::Vector,\n    compute_gn_jac(u_n::Vector)::Matrix\n)\ntest_scalar(compute_gn, [1, 0.4, 0.26]) # \"no method matching one(::Vector{Float64})\"\ntest_rrule(compute_gn, [1, 0.4, 0.26]) # test fails, derivatives don't match\ntest_frule(compute_gn, [1, 0.4, 0.26]) # test passes"}]}]}],"thread_ts":"1615663587.330500","reply_count":14,"reply_users_count":3,"latest_reply":"1615665324.334800","reply_users":["U6A936746","UN97XTLCV","U6PQP41C3"],"subscribed":false},{"client_msg_id":"1a551774-0bf8-47da-a060-f0a619747142","type":"message","text":"Weird. How wrong is the derivative? (According to `test_rrule`)","user":"U6A936746","ts":"1615664464.331100","team":"T68168MUP","edited":{"user":"U6A936746","ts":"1615664481.000000"},"blocks":[{"type":"rich_text","block_id":"hfGIe","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Weird. How wrong is the derivative? (According to "},{"type":"text","text":"test_rrule","style":{"code":true}},{"type":"text","text":")"}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"},{"client_msg_id":"56005fe8-a2be-46cb-93c4-622b3fc7fe36","type":"message","text":"```returned = [1.9818445359249062, -2.0850865946297352, 0.051621029352414464]\nexpected = [4.544859199133909e-15, 0.21476076072527572, -0.4622970094649524]\nrtol = 1.0e-9, atol = 1.0e-9)```\n","user":"UN97XTLCV","ts":"1615664525.331400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"1Zb","elements":[{"type":"rich_text_preformatted","elements":[{"type":"text","text":"returned = [1.9818445359249062, -2.0850865946297352, 0.051621029352414464]\nexpected = [4.544859199133909e-15, 0.21476076072527572, -0.4622970094649524]\nrtol = 1.0e-9, atol = 1.0e-9)"}]},{"type":"rich_text_section","elements":[]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"},{"client_msg_id":"52189c71-8a45-4db9-b5a6-25772ae8435d","type":"message","text":"the jacobian here is actually completely independent of values of `u_n` , too, so it’s even more perplexing","user":"UN97XTLCV","ts":"1615664553.331600","team":"T68168MUP","edited":{"user":"UN97XTLCV","ts":"1615664566.000000"},"blocks":[{"type":"rich_text","block_id":"/3jB","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"the jacobian here is actually completely independent of values of "},{"type":"text","text":"u_n","style":{"code":true}},{"type":"text","text":" , too, so it’s even more perplexing"}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"},{"client_msg_id":"509217cd-93e1-430e-8449-a3416f4020c6","type":"message","text":"Wow that is very different","user":"U6A936746","ts":"1615664591.331900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"X/9b","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Wow that is very different"}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"},{"client_msg_id":"b8096647-9340-45ed-ac42-3f07ce29b48d","type":"message","text":"if you think it’d be more productive, I can get a MWE and open an issue","user":"UN97XTLCV","ts":"1615664645.332100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"dwG","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"if you think it’d be more productive, I can get a MWE and open an issue"}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"},{"client_msg_id":"bba7530b-99a9-4212-abec-f98961960dbb","type":"message","text":"Does the function have any non-differentable points or bits where the derivative changes a lot?","user":"U6A936746","ts":"1615664647.332300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"raPWO","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Does the function have any non-differentable points or bits where the derivative changes a lot?"}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"},{"client_msg_id":"da78dfda-1c8a-4ed9-b295-1aaf67faf2f4","type":"message","text":"not “non-differentiable” but `df/du0` (first column of jacobian) is all 0s by definition\n\ne.g. here’s the function and jacobian for the inputs above-\n```compute_gn([u0, u1, u2])\n3-element Vector{Num}:\n 1 - u1 - (1.5u2)\n      u1 + 2.0u2\n          -0.25u2\ncompute_gn_jac([u0, u1, u2])\n[0 -1  -1.5\n 0  1   2.0\n 0  0  -0.25]```","user":"UN97XTLCV","ts":"1615664681.332500","team":"T68168MUP","edited":{"user":"UN97XTLCV","ts":"1615664870.000000"},"blocks":[{"type":"rich_text","block_id":"/Qv2w","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"not “non-differentiable” but "},{"type":"text","text":"df/du0","style":{"code":true}},{"type":"text","text":" (first column of jacobian) is all 0s by definition\n\ne.g. here’s the function and jacobian for the inputs above-\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"compute_gn([u0, u1, u2])\n3-element Vector{Num}:\n 1 - u1 - (1.5u2)\n      u1 + 2.0u2\n          -0.25u2\ncompute_gn_jac([u0, u1, u2])\n[0 -1  -1.5\n 0  1   2.0\n 0  0  -0.25]"}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"},{"client_msg_id":"72eedfef-7804-4bed-9a97-5261cea8f8f6","type":"message","text":"I think using `@scalar_rule`  and `test_scalar` for a function not on scalars is probably not OK.\nThe math on that hasn't been thought about.","user":"U6A936746","ts":"1615664992.333100","team":"T68168MUP","edited":{"user":"U6A936746","ts":"1615666076.000000"},"blocks":[{"type":"rich_text","block_id":"PAp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think using "},{"type":"text","text":"@scalar_rule","style":{"code":true}},{"type":"text","text":"  and `test_scalar` for a function not on scalars is probably not OK.\nThe math on that hasn't been thought about."}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV","reactions":[{"name":"point_up","users":["U6PQP41C3","UDXST8ARK"],"count":2}]},{"client_msg_id":"d6ff86ae-fe8a-42f9-92d2-e2e572644c1f","type":"message","text":"I think write the frule/rrule directly.\nAnd use `Zero()` for the things that are always zero.","user":"U6A936746","ts":"1615665096.333500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"tt1","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think write the frule/rrule directly.\nAnd use "},{"type":"text","text":"Zero()","style":{"code":true}},{"type":"text","text":" for the things that are always zero."}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"},{"client_msg_id":"a58fe5fc-93f4-4bfa-b644-08f79c283c3d","type":"message","text":"Maybe not `Zero()` in this case, since it’s only a small matrix of `Real`s?","user":"U6PQP41C3","ts":"1615665152.333700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Y9f","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Maybe not "},{"type":"text","text":"Zero()","style":{"code":true}},{"type":"text","text":" in this case, since it’s only a small matrix of "},{"type":"text","text":"Real","style":{"code":true}},{"type":"text","text":"s?"}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"},{"client_msg_id":"6410e622-dc9e-47ef-9949-74a9beda57df","type":"message","text":"yeah, my benchmarking has showed ~60ns slowdown (30ns -&gt; 90ns) with Union{Float64, Zero} types (looks like cost of 1 allocation)","user":"UN97XTLCV","ts":"1615665224.333900","team":"T68168MUP","edited":{"user":"UN97XTLCV","ts":"1615665265.000000"},"blocks":[{"type":"rich_text","block_id":"h3NU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"yeah, my benchmarking has showed ~60ns slowdown (30ns -> 90ns) with Union{Float64, Zero} types (looks like cost of 1 allocation)"}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV","reactions":[{"name":"+1","users":["U6A936746"],"count":1}]},{"client_msg_id":"371ed1c7-66dd-41d6-ad15-3fbf7a392c64","type":"message","text":"Definitely makes sense to avoid `Zero` then.","user":"U6PQP41C3","ts":"1615665315.334400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"A=FAx","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Definitely makes sense to avoid "},{"type":"text","text":"Zero","style":{"code":true}},{"type":"text","text":" then."}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"},{"client_msg_id":"7b2ba706-ca0c-4456-9361-331b90909b35","type":"message","text":"`0` is just fine","user":"U6PQP41C3","ts":"1615665322.334600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FVU","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"0","style":{"code":true}},{"type":"text","text":" is just fine"}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"},{"client_msg_id":"4e55f99d-7787-4aaf-b4f9-6fd5368faff5","type":"message","text":":slightly_smiling_face:","user":"U6PQP41C3","ts":"1615665324.334800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"k=Pz9","elements":[{"type":"rich_text_section","elements":[{"type":"emoji","name":"slightly_smiling_face"}]}]}],"thread_ts":"1615663587.330500","parent_user_id":"UN97XTLCV"}]