[{"client_msg_id":"eaefb105-e413-49a0-a868-2a916a17fbae","type":"message","text":"Why does this not work?\n```using Flux, Zygote\nnn = Chain(Dense(1, 2), Dense(2, 1))\nf(x) = nn([x]) |&gt; sum\ndf(x) = gradient(f, x) |&gt; sum\nddf(x) = gradient(df, x) |&gt; sum```\n`f(1.0)` and `df(1.0)` work fine, but `ddf(1.0)` throws a `ERROR: Can't differentiate foreigncall expression`","user":"U017AJ68PFZ","ts":"1613741317.393000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"CmHP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Why does this not work?\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using Flux, Zygote\nnn = Chain(Dense(1, 2), Dense(2, 1))\nf(x) = nn([x]) |> sum\ndf(x) = gradient(f, x) |> sum\nddf(x) = gradient(df, x) |> sum"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"f(1.0)","style":{"code":true}},{"type":"text","text":" and "},{"type":"text","text":"df(1.0)","style":{"code":true}},{"type":"text","text":" work fine, but "},{"type":"text","text":"ddf(1.0)","style":{"code":true}},{"type":"text","text":" throws a "},{"type":"text","text":"ERROR: Can't differentiate foreigncall expression","style":{"code":true}}]}]}],"thread_ts":"1613741317.393000","reply_count":7,"reply_users_count":4,"latest_reply":"1614161721.083700","reply_users":["UD0NS8PDF","U017AJ68PFZ","U6YRZ18GZ","USBKT1275"],"subscribed":false},{"client_msg_id":"94dfa4b7-da70-4d96-9450-450aad9fa59f","type":"message","text":"Second derivatives using Zygote twice do sometimes work, but frequently hit functions it doesn’t understand. Zygote.hessian might do what you want, it takes the first derivative with Zygote, and the second with ForwardDiff.","user":"UD0NS8PDF","ts":"1613741707.393100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7=p","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Second derivatives using Zygote twice do sometimes work, but frequently hit functions it doesn’t understand. Zygote.hessian might do what you want, it takes the first derivative with Zygote, and the second with ForwardDiff."}]}]}],"thread_ts":"1613741317.393000","parent_user_id":"U017AJ68PFZ"},{"client_msg_id":"f1fcbcdc-c373-4b8c-b494-af47ca4da736","type":"message","text":"Thanks. Unfortunately that won’t work for my use case, as eventually the second derivative appears in a training loop where Zygote is used to take a derivative with respect to `nn` parameters. And so that’ll die.","user":"U017AJ68PFZ","ts":"1613741961.393700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"FbBaD","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Thanks. Unfortunately that won’t work for my use case, as eventually the second derivative appears in a training loop where Zygote is used to take a derivative with respect to "},{"type":"text","text":"nn","style":{"code":true}},{"type":"text","text":" parameters. And so that’ll die."}]}]}],"thread_ts":"1613741317.393000","parent_user_id":"U017AJ68PFZ"},{"client_msg_id":"36eb4869-6ad1-46b1-8612-4b7f877d5d3c","type":"message","text":"I use exactly this, but I had to implement few gradients manually due to reason <@UD0NS8PDF> mentioned","user":"U6YRZ18GZ","ts":"1613742118.393900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"oYne","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I use exactly this, but I had to implement few gradients manually due to reason "},{"type":"user","user_id":"UD0NS8PDF"},{"type":"text","text":" mentioned"}]}]}],"thread_ts":"1613741317.393000","parent_user_id":"U017AJ68PFZ"},{"client_msg_id":"19a28233-dc4f-4fbd-a08d-ddd517ed2c4f","type":"message","text":"I found a whole bunch of issues and discourse posts with people having similar trouble, but none which solved the problem fully. I might give a combination of `ForwardDiff` and `ReverseDiff` (for the `nn` training) a try instead of `Zygote`","user":"U017AJ68PFZ","ts":"1613742250.394100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"DIc","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I found a whole bunch of issues and discourse posts with people having similar trouble, but none which solved the problem fully. I might give a combination of "},{"type":"text","text":"ForwardDiff","style":{"code":true}},{"type":"text","text":" and "},{"type":"text","text":"ReverseDiff","style":{"code":true}},{"type":"text","text":" (for the "},{"type":"text","text":"nn","style":{"code":true}},{"type":"text","text":" training) a try instead of "},{"type":"text","text":"Zygote","style":{"code":true}}]}]}],"thread_ts":"1613741317.393000","parent_user_id":"U017AJ68PFZ"},{"client_msg_id":"dbe10e96-9b7d-4ca1-a4b2-c5681b1f0919","type":"message","text":"Is this reported as issue in Zygote, or should I report it? So it does not get lost in slack.","user":"USBKT1275","ts":"1614157597.081900","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"rBI1z","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Is this reported as issue in Zygote, or should I report it? So it does not get lost in slack."}]}]}],"thread_ts":"1613741317.393000","parent_user_id":"U017AJ68PFZ"},{"client_msg_id":"7569a8cf-6ce8-4a7a-823d-c7a16ec40573","type":"message","text":"There are variations of this as issues in Zygote repo already","user":"U017AJ68PFZ","ts":"1614160762.082100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"sKXS","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"There are variations of this as issues in Zygote repo already"}]}]}],"thread_ts":"1613741317.393000","parent_user_id":"U017AJ68PFZ"},{"client_msg_id":"C1066F8A-5BCA-4DDE-8FDF-88D8243EFC9D","type":"message","text":"If you can narrow it down to what operation is the problem, that might make a fix apparent","user":"UD0NS8PDF","ts":"1614161721.083700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"PFw/8","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If you can narrow it down to what operation is the problem, that might make a fix apparent"}]}]}],"thread_ts":"1613741317.393000","parent_user_id":"U017AJ68PFZ"}]