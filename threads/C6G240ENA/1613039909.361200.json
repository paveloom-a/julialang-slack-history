[{"client_msg_id":"9e63d85e-c3cb-46a4-9333-ee45024afe5f","type":"message","text":"I am looking to extend Zygote with ChainRulesCore, but I am a bit confused on how to add arguments and keyword arguments that modify the function, but for which the gradients do not have to be computed. Minimal example:\n```julia\njulia&gt; using Zygote, ChainRulesCore\njulia&gt; h(x, y; pow=2) = (2x + y^2)^pow\nh (generic function with 1 method)\n\njulia&gt; function rrule(::typeof(h), x, y; pow=2)\n           println(\"rrule\")\n           return h(x,y;pow), ȳ -&gt; (NO_FIELDS, 2pow * (2x+y^2)^(pow-1) * ȳ * [1.0, 2y])\n       end\nrrule (generic function with 751 methods)\n\njulia&gt; gradient(h, 1.0, 2.0)\nrrule\n([24.0, 96.0],)\n\njulia&gt; gradient((x,y)-&gt;h(x,y, pow=3), 1.0, 2.0)\nrrule\nERROR: BoundsError: attempt to access (nothing, nothing, nothing, [216.0, 864.0])\n  at index [5]\nStacktrace:\n [1] getindex at ./tuple.jl:24 [inlined]\n [2] gradindex(::Tuple{Nothing,Nothing,Nothing,Array{Float64,1}}, ::Int64) at /Users/michielstock/.julia/packages/Zygote/ggM8Z/src/compiler/reverse.jl:12\n [3] #52 at ./REPL[48]:1 [inlined]\n [4] (::typeof(∂(#52)))(::Float64) at /Users/michielstock/.julia/packages/Zygote/ggM8Z/src/compiler/interface2.jl:0\n [5] (::Zygote.var\"#41#42\"{typeof(∂(#52))})(::Float64) at /Users/michielstock/.julia/packages/Zygote/ggM8Z/src/compiler/interface.jl:40\n [6] gradient(::Function, ::Float64, ::Vararg{Float64,N} where N) at /Users/michielstock/.julia/packages/Zygote/ggM8Z/src/compiler/interface.jl:49\n [7] top-level scope at REPL[48]:1\n ```\nIs what I want to do fundamentally not supported or am I missing something?","user":"UC8MP6UN8","ts":"1613039909.361200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"xqKw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I am looking to extend Zygote with ChainRulesCore, but I am a bit confused on how to add arguments and keyword arguments that modify the function, but for which the gradients do not have to be computed. Minimal example:\n```julia\njulia> using Zygote, ChainRulesCore\njulia> h(x, y; pow=2) = (2x + y^2)^pow\nh (generic function with 1 method)\n\njulia> function rrule(::typeof(h), x, y; pow=2)\n           println(\"rrule\")\n           return h(x,y;pow), ȳ -> (NO_FIELDS, 2pow * (2x+y^2)^(pow-1) * ȳ * [1.0, 2y])\n       end\nrrule (generic function with 751 methods)\n\njulia> gradient(h, 1.0, 2.0)\nrrule\n([24.0, 96.0],)\n\njulia> gradient((x,y)->h(x,y, pow=3), 1.0, 2.0)\nrrule\nERROR: BoundsError: attempt to access (nothing, nothing, nothing, [216.0, 864.0])\n  at index [5]\nStacktrace:\n [1] getindex at ./tuple.jl:24 [inlined]\n [2] gradindex(::Tuple{Nothing,Nothing,Nothing,Array{Float64,1}}, ::Int64) at /Users/michielstock/.julia/packages/Zygote/ggM8Z/src/compiler/reverse.jl:12\n [3] #52 at ./REPL[48]:1 [inlined]\n [4] (::typeof(∂(#52)))(::Float64) at /Users/michielstock/.julia/packages/Zygote/ggM8Z/src/compiler/interface2.jl:0\n [5] (::Zygote.var\"#41#42\"{typeof(∂(#52))})(::Float64) at /Users/michielstock/.julia/packages/Zygote/ggM8Z/src/compiler/interface.jl:40\n [6] gradient(::Function, ::Float64, ::Vararg{Float64,N} where N) at /Users/michielstock/.julia/packages/Zygote/ggM8Z/src/compiler/interface.jl:49\n [7] top-level scope at REPL[48]:1\n ```\nIs what I want to do fundamentally not supported or am I missing something?"}]}]}],"thread_ts":"1613039909.361200","reply_count":19,"reply_users_count":3,"latest_reply":"1613047972.365100","reply_users":["U6A936746","UD0NS8PDF","UC8MP6UN8"],"subscribed":false,"reactions":[{"name":"slack","users":["UD0NS8PDF"],"count":1}]},{"client_msg_id":"1cbbb8b2-4273-4a2e-870f-1a6d54ec2c1d","type":"message","text":"Keyword args never get gradients.\nFor nonKwargs return either `Zero()` or `DoesNotExist()` depending on if the term doesn't effect the computed output (`Zero()`) or if it doesn't make sense to perturb it, e.g it is an index, or it's a string","user":"U6A936746","ts":"1613040247.361300","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"w4wR","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Keyword args never get gradients.\nFor nonKwargs return either "},{"type":"text","text":"Zero()","style":{"code":true}},{"type":"text","text":" or "},{"type":"text","text":"DoesNotExist()","style":{"code":true}},{"type":"text","text":" depending on if the term doesn't effect the computed output ("},{"type":"text","text":"Zero()","style":{"code":true}},{"type":"text","text":") or if it doesn't make sense to perturb it, e.g it is an index, or it's a string"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"4cfeaef6-bb06-43b0-99ba-4e99fef8446d","type":"message","text":"If I’m reading this correctly, `(NO_FIELDS, 2pow * (2x+y^2)^(pow-1) * ȳ * [1.0, 2y])` only has the gradient for h and x, but needs a 3rd element for y.","user":"UD0NS8PDF","ts":"1613040290.361500","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"WU5","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"If I’m reading this correctly, "},{"type":"text","text":"(NO_FIELDS, 2pow * (2x+y^2)^(pow-1) * ȳ * [1.0, 2y])","style":{"code":true}},{"type":"text","text":" only has the gradient for h and x, but needs a 3rd element for y."}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"6042b84a-e4c3-4594-809e-babedf749a7b","type":"message","text":"Your pullback shouldn't accept kwargs","user":"U6A936746","ts":"1613040316.361800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7Mv5I","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Your pullback shouldn't accept kwargs"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"bbf8332e-6cef-4329-9492-19d24b2f80a2","type":"message","text":"But it doesn’t, it’s just `ȳ -&gt; (...)`","user":"UD0NS8PDF","ts":"1613040360.362000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Izj8K","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"But it doesn’t, it’s just "},{"type":"text","text":"ȳ -> (...)","style":{"code":true}}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"bd4a76b2-160b-483e-8e09-68541d618caf","type":"message","text":"Ah, I misread. Trying to read code on phone","user":"U6A936746","ts":"1613040379.362200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"vUiIT","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Ah, I misread. Trying to read code on phone"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"17844c95-1b05-4b77-a197-b7b7737f3ddc","type":"message","text":"Blame slack :slightly_smiling_face:","user":"UD0NS8PDF","ts":"1613040397.362400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"pAZP=","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Blame slack "},{"type":"emoji","name":"slightly_smiling_face"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"5d315d93-c51b-4b9c-ae52-e94f7e402e7e","type":"message","text":"I am actually not sure, how to parse this, ȳ is the same as the inputs?","user":"UC8MP6UN8","ts":"1613040438.362600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Fk/","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I am actually not sure, how to parse this, ȳ is the same as the inputs?"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"663a86a6-74fe-4e5f-818c-981b97b0a762","type":"message","text":"Normally `z = h(x,y; kw)` needs a pullback that is like `zbar -&gt; (hbar, xbar, ybar)`","user":"UD0NS8PDF","ts":"1613040488.362800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"3l27f","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Normally "},{"type":"text","text":"z = h(x,y; kw)","style":{"code":true}},{"type":"text","text":" needs a pullback that is like "},{"type":"text","text":"zbar -> (hbar, xbar, ybar)","style":{"code":true}}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"2b34632e-da3c-4250-9578-cabf208485da","type":"message","text":"ah ok","user":"UC8MP6UN8","ts":"1613040500.363000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"STRP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ah ok"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"c7306911-d28f-4f96-a172-b48138e9f821","type":"message","text":"but my function was of the form `f(x, y, pow)`, it would be impossible to state that `pow` should not be used as an input for differentiation?","user":"UC8MP6UN8","ts":"1613040550.363200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"TKOw","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"but my function was of the form "},{"type":"text","text":"f(x, y, pow)","style":{"code":true}},{"type":"text","text":", it would be impossible to state that "},{"type":"text","text":"pow","style":{"code":true}},{"type":"text","text":" should not be used as an input for differentiation?"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"f5e655a7-57c6-4f07-9aeb-6458e6ec6bd0","type":"message","text":"I am asking it for a more complex example","user":"UC8MP6UN8","ts":"1613040561.363400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"7tmP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I am asking it for a more complex example"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"d6ace8fa-088b-4c8f-8c87-bf240449fb29","type":"message","text":"The default is to regard keywords as being outside of AD, they are assumed to be options etc. not data. To treat a positional argument like that, you want to return some kind of zero for its `powbar` in the tuple.","user":"UD0NS8PDF","ts":"1613040697.363600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"C16","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"The default is to regard keywords as being outside of AD, they are assumed to be options etc. not data. To treat a positional argument like that, you want to return some kind of zero for its "},{"type":"text","text":"powbar","style":{"code":true}},{"type":"text","text":" in the tuple."}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"3591d7cc-87f0-41f9-a40a-197d80e36171","type":"message","text":"ah, ok, thanks!","user":"UC8MP6UN8","ts":"1613040731.363800","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"iNNXp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"ah, ok, thanks!"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"74998b71-a0c5-4c4c-b230-d80c58a3a911","type":"message","text":"Whether this should be `Zero()` or `DoesNotExist()`(?) I’d have to dig up or experiment","user":"UD0NS8PDF","ts":"1613040748.364000","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"wDlYP","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Whether this should be "},{"type":"text","text":"Zero()","style":{"code":true}},{"type":"text","text":" or "},{"type":"text","text":"DoesNotExist()","style":{"code":true}},{"type":"text","text":"(?) I’d have to dig up or experiment"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"62e31c7b-8048-4ee5-a40b-f23260aa9f50","type":"message","text":"I guess it would somewhat more sense to rewrite using keywords","user":"UC8MP6UN8","ts":"1613040785.364200","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"hJkh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I guess it would somewhat more sense to rewrite using keywords"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"fd801675-8d29-4b1c-a339-d23bd3438861","type":"message","text":"Both are fine, I think. If you wanted to treat keywords as data, then things would be harder, possibly impossible.","user":"UD0NS8PDF","ts":"1613040961.364400","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"exf","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Both are fine, I think. If you wanted to treat keywords as data, then things would be harder, possibly impossible."}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"0d5b5783-5016-4a08-bf96-de7d2dfd8804","type":"message","text":"I think we can make kwargs used as data, possibly without change to a y code.\nIt's just a bit of fiddly trick.\n\nBut so far, in the last 5 years of AD work in Julia, across many packages, it has never actually turned out to be a thing people wanted.\nIt surprises me, but it seems to be true","user":"U6A936746","ts":"1613045800.364600","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"Bhh","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"I think we can make kwargs used as data, possibly without change to a y code.\nIt's just a bit of fiddly trick.\n\nBut so far, in the last 5 years of AD work in Julia, across many packages, it has never actually turned out to be a thing people wanted.\nIt surprises me, but it seems to be true"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"94241dd0-5ca8-4bc0-b1b1-100d1f6cba24","type":"message","text":"Zero and DoesNotExist function identically. It's just a semantic clarity.\nAre you saying the gradient wrt this is zero, or that the idea of a gradient wrt this doesn't even make sense?\n\nIn practice you can happily use either. They both subtype `AbstractZero`","user":"U6A936746","ts":"1613045892.364800","team":"T68168MUP","edited":{"user":"U6A936746","ts":"1613045927.000000"},"blocks":[{"type":"rich_text","block_id":"oWuf7","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Zero and DoesNotExist function identically. It's just a semantic clarity.\nAre you saying the gradient wrt this is zero, or that the idea of a gradient wrt this doesn't even make sense?\n\nIn practice you can happily use either. They both subtype "},{"type":"text","text":"AbstractZero","style":{"code":true}}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"},{"client_msg_id":"5b88b957-4574-40e4-ab9f-7aabd6024109","type":"message","text":"Still strange quirks when it takes the gradient in VSC, but I can make it work as I want. Thanks for the help!","user":"UC8MP6UN8","ts":"1613047972.365100","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"VMbW","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Still strange quirks when it takes the gradient in VSC, but I can make it work as I want. Thanks for the help!"}]}]}],"thread_ts":"1613039909.361200","parent_user_id":"UC8MP6UN8"}]