[{"client_msg_id":"c4da6b82-e246-4a2f-bfa4-84070f9039df","type":"message","text":"Yes but I expected Zygote to pick my adjoint after a refresh but it doesn't\n\n```using NNlib, ChainRules, Zygote\n\nfunction ChainRules.rrule(\n    ::typeof(NNlib.batched_mul),\n    A::AbstractArray{S,3},\n    B::AbstractMatrix{S},\n    ) where S &lt;: NNlib.BlasFloat\n\n    function batched_mul_pullback(Δ)\n        return (\n            NO_FIELDS,\n            @thunk(batched_mul(Δ, permutedims(reshape(B, size(B)..., 1), (2, 1, 3)))),\n            @thunk(batched_mul(permutedims(A, (2, 1, 3)), Δ)),\n        )\n     end\n    batched_mul(A, reshape(B, size(B)..., 1)), batched_mul_pullback\nend\n\nZygote.refresh()\n\nW = rand(Float32, 1, 1, 2)\nx = rand(Float32, 1, 1) \n\ngz, back = Zygote.pullback(x -&gt; NNlib.batched_mul(W, x), x)\nback(gz)[1]```\nExpected: it uses my adjoint and works.\n\nWhat happens: it uses NNlib default adjoint and doesn't work.\n\nWas fixed here: <https://github.com/FluxML/NNlib.jl/issues/290>\n\nBut wondering why it didn't work when I monkey patched it myself","user":"UKJSNT1QR","ts":"1615541017.322900","team":"T68168MUP","edited":{"user":"UKJSNT1QR","ts":"1615541037.000000"},"blocks":[{"type":"rich_text","block_id":"+oSs","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"Yes but I expected Zygote to pick my adjoint after a refresh but it doesn't\n\n"}]},{"type":"rich_text_preformatted","elements":[{"type":"text","text":"using NNlib, ChainRules, Zygote\n\nfunction ChainRules.rrule(\n    ::typeof(NNlib.batched_mul),\n    A::AbstractArray{S,3},\n    B::AbstractMatrix{S},\n    ) where S <: NNlib.BlasFloat\n\n    function batched_mul_pullback(Δ)\n        return (\n            NO_FIELDS,\n            @thunk(batched_mul(Δ, permutedims(reshape(B, size(B)..., 1), (2, 1, 3)))),\n            @thunk(batched_mul(permutedims(A, (2, 1, 3)), Δ)),\n        )\n     end\n    batched_mul(A, reshape(B, size(B)..., 1)), batched_mul_pullback\nend\n\nZygote.refresh()\n\nW = rand(Float32, 1, 1, 2)\nx = rand(Float32, 1, 1) \n\ngz, back = Zygote.pullback(x -> NNlib.batched_mul(W, x), x)\nback(gz)[1]"}]},{"type":"rich_text_section","elements":[{"type":"text","text":"Expected: it uses my adjoint and works.\n\nWhat happens: it uses NNlib default adjoint and doesn't work.\n\nWas fixed here: "},{"type":"link","url":"https://github.com/FluxML/NNlib.jl/issues/290"},{"type":"text","text":"\n\nBut wondering why it didn't work when I monkey patched it myself"}]}]}],"thread_ts":"1615541017.322900","reply_count":1,"reply_users_count":1,"latest_reply":"1615575366.323700","reply_users":["U01HK5WRVJT"],"subscribed":false},{"client_msg_id":"c337b3dd-80d5-4978-a04a-6dfab00bbb95","type":"message","text":"In the past I had trouble with Zygote seeing my `ChainRulesCore.rrule` definitions because of _very_ slight differences in the function signatures,  eg. which type parameters were mentioned and possibly even to the keyword arguments being the same and with the same types, I can't remember. Maybe not relevant to your case, I just remember getting very confused by this.","user":"U01HK5WRVJT","ts":"1615575366.323700","team":"T68168MUP","blocks":[{"type":"rich_text","block_id":"NHOsp","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"In the past I had trouble with Zygote seeing my "},{"type":"text","text":"ChainRulesCore.rrule","style":{"code":true}},{"type":"text","text":" definitions because of "},{"type":"text","text":"very","style":{"italic":true}},{"type":"text","text":" slight differences in the function signatures,  eg. which type parameters were mentioned and possibly even to the keyword arguments being the same and with the same types, I can't remember. Maybe not relevant to your case, I just remember getting very confused by this."}]}]}],"thread_ts":"1615541017.322900","parent_user_id":"UKJSNT1QR"}]